#!/usr/bin/env bash
# Ultra-simple launcher for GitHub Copilot
# Usage: run-copilot [directory]
#   directory: Path to repository (defaults to current directory)

REPO_PATH="${1:-.}"
REPO_PATH=$(realpath "$REPO_PATH")
REPO_NAME=$(basename "$REPO_PATH")

# Convert Windows path to WSL if needed
if [[ "$REPO_PATH" =~ ^[A-Z]: ]]; then
    DRIVE=$(echo "$REPO_PATH" | cut -d: -f1 | tr '[:upper:]' '[:lower:]')
    REST=$(echo "$REPO_PATH" | cut -d: -f2 | tr '\\' '/')
    REPO_PATH="/mnt/${DRIVE}${REST}"
fi

echo "ðŸš€ Launching GitHub Copilot CLI..."
echo "ðŸ“ Repository: $REPO_PATH"

# Build docker arguments
DOCKER_ARGS=(
    "-it" "--rm"
    "--name" "copilot-${REPO_NAME}"
    "-e" "TZ=${TZ:-$(cat /etc/timezone 2>/dev/null || echo UTC)}"
    "-v" "${REPO_PATH}:/workspace"
    "-v" "${HOME}/.gitconfig:/home/agentuser/.gitconfig:ro"
    "-v" "${HOME}/.config/gh:/home/agentuser/.config/gh:ro"
    "-v" "${HOME}/.config/github-copilot:/home/agentuser/.config/github-copilot:ro"
)

# Add MCP secrets if they exist
if [ -f "${HOME}/.config/coding-agents/mcp-secrets.env" ]; then
    DOCKER_ARGS+=("-v" "${HOME}/.config/coding-agents/mcp-secrets.env:/home/agentuser/.mcp-secrets.env:ro")
fi

DOCKER_ARGS+=("-w" "/workspace" "--security-opt" "no-new-privileges:true" "coding-agents-copilot:local")

docker run "${DOCKER_ARGS[@]}"
