#!/usr/bin/env bash
# Quick launcher for GitHub Copilot from current directory
# Usage: run-copilot [directory] [--no-push]
#   directory: Path to repository (defaults to current directory)
#   --no-push: Skip auto-push on exit

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/../utils/common-functions.sh"

# Parse arguments
REPO_PATH="."
BRANCH=""
NAME=""
DOTNET_PREVIEW=""
NETWORK_PROXY="allow-all"
CPU="4"
MEMORY="8g"
GPU=""
SKIP_PUSH=false
USE_CURRENT_BRANCH=false
FORCE=false

while [[ $# -gt 0 ]]; do
    case $1 in
        -b|--branch)
            BRANCH="$2"
            shift 2
            ;;
        --name)
            NAME="$2"
            shift 2
            ;;
        --dotnet-preview)
            DOTNET_PREVIEW="$2"
            shift 2
            ;;
        --network-proxy)
            NETWORK_PROXY="$2"
            shift 2
            ;;
        --cpu)
            CPU="$2"
            shift 2
            ;;
        --memory)
            MEMORY="$2"
            shift 2
            ;;
        --gpu)
            GPU="$2"
            shift 2
            ;;
        --no-push)
            SKIP_PUSH=true
            shift
            ;;
        --use-current-branch)
            USE_CURRENT_BRANCH=true
            shift
            ;;
        -y|--force)
            FORCE=true
            shift
            ;;
        -h|--help)
            echo "Usage: run-copilot [directory] [OPTIONS]"
            echo ""
            echo "Launch GitHub Copilot CLI in an ephemeral container."
            echo ""
            echo "Arguments:"
            echo "  directory              Path to repository (default: current directory)"
            echo ""
            echo "Options:"
            echo "  -b, --branch BRANCH    Branch name (creates <agent>/<branch>)"
            echo "  --name NAME            Custom container name"
            echo "  --dotnet-preview CH    Install .NET preview SDK (e.g., 11.0)"
            echo "  --network-proxy MODE   Network: allow-all, restricted, squid (default: allow-all)"
            echo "  --cpu NUM              CPU limit (default: 4)"
            echo "  --memory SIZE          Memory limit (default: 8g)"
            echo "  --gpu SPEC             GPU specification (e.g., 'all' or 'device=0')"
            echo "  --no-push              Skip auto-push to git remote on exit"
            echo "  --use-current-branch   Use current branch (no isolation)"
            echo "  -y, --force            Replace existing branch without prompt"
            echo "  -h, --help             Show this help"
            echo ""
            echo "Examples:"
            echo "  run-copilot                        # Launch in current directory"
            echo "  run-copilot ~/my-repo              # Launch in specific directory"
            echo "  run-copilot -b feature             # Create copilot/feature branch"
            echo "  run-copilot --name my-session      # Custom container name"
            echo "  run-copilot --network-proxy squid  # Use monitored proxy"
            echo "  run-copilot --cpu 8 --memory 16g   # Custom resources"
            exit 0
            ;;
        *)
            REPO_PATH="$1"
            shift
            ;;
    esac
done

# Check Docker
check_docker_running || exit 1

# Get container runtime (docker or podman)
CONTAINER_CMD=$(get_container_runtime)

# Resolve path
REPO_PATH=$(realpath "$REPO_PATH")

# Verify it's a git repository
if [ ! -d "$REPO_PATH/.git" ]; then
    echo "‚ùå Error: $REPO_PATH is not a git repository"
    echo "   Run from within a git repository or provide a path to one"
    exit 1
fi

REPO_NAME=$(get_repo_name "$REPO_PATH")
BRANCH=$(get_current_branch "$REPO_PATH")
CONTAINER_NAME="copilot-${REPO_NAME}-${BRANCH}"
TZ_VALUE="${TZ:-$(cat /etc/timezone 2>/dev/null || echo UTC)}"

# Convert to WSL path if needed
REPO_PATH=$(convert_to_wsl_path "$REPO_PATH")

# Pull latest image
pull_and_tag_image "copilot"

echo "üöÄ Launching GitHub Copilot CLI..."
echo "üìÅ Repository: $REPO_NAME"
echo "üåø Branch: $BRANCH"
echo "üè∑Ô∏è  Container: $CONTAINER_NAME"
echo ""

# Build docker arguments
DOCKER_ARGS=(
    "run" "-d"
    "--rm"
    "--name" "$CONTAINER_NAME"
    "-e" "TZ=$TZ_VALUE"
    "-e" "AGENT_SESSION_MODE=supervised"
    "-e" "AGENT_SESSION_NAME=agent"
    "-v" "${REPO_PATH}:/workspace"
    "-v" "${HOME}/.gitconfig:/home/agentuser/.gitconfig:ro"
    "-v" "${HOME}/.config/gh:/home/agentuser/.config/gh:ro"
    "-v" "${HOME}/.config/github-copilot:/home/agentuser/.config/github-copilot:ro"
    "--label" "coding-agents.type=agent"
    "--label" "coding-agents.agent=copilot"
    "--label" "coding-agents.repo=$REPO_NAME"
    "--label" "coding-agents.branch=$BRANCH"
)

if $SKIP_PUSH; then
    DOCKER_ARGS+=("-e" "AUTO_PUSH_ON_SHUTDOWN=false")
fi

# Add MCP secrets if they exist
if [ -f "${HOME}/.config/coding-agents/mcp-secrets.env" ]; then
    DOCKER_ARGS+=("-v" "${HOME}/.config/coding-agents/mcp-secrets.env:/home/agentuser/.mcp-secrets.env:ro")
fi

DOCKER_ARGS+=(
    "-w" "/workspace"
    "--security-opt" "no-new-privileges:true"
    "--cpus=$CPU"
    "--memory=$MEMORY"
)

# Add GPU if specified
if [ -n "$GPU" ]; then
    DOCKER_ARGS+=("--gpus=$GPU")
fi

DOCKER_ARGS+=("coding-agents-copilot:local")

if ! CONTAINER_ID=$($CONTAINER_CMD "${DOCKER_ARGS[@]}"); then
    echo "‚ùå Failed to start GitHub Copilot container"
    exit 1
fi

echo "üîó Connecting to Copilot session (detach with Ctrl+B then D)..."
$CONTAINER_CMD exec -it "$CONTAINER_NAME" agent-session attach
ATTACH_STATUS=$?
if [ $ATTACH_STATUS -ne 0 ]; then
    if $CONTAINER_CMD ps --filter "name=^${CONTAINER_NAME}$" --format "{{.Names}}" | grep -q "^${CONTAINER_NAME}$"; then
        echo "‚ö†Ô∏è  Unable to attach to session. Use $SCRIPT_DIR/connect-agent --name $CONTAINER_NAME once the container is ready."
    else
        echo "‚ùå Copilot session exited before it was ready."
    fi
    exit $ATTACH_STATUS
fi

if $CONTAINER_CMD ps --filter "name=^${CONTAINER_NAME}$" --format "{{.Names}}" | grep -q "^${CONTAINER_NAME}$"; then
    echo ""
    echo "‚ÑπÔ∏è  Session detached but container is still running."
    echo "   Reconnect: $SCRIPT_DIR/connect-agent --name $CONTAINER_NAME"
    echo "   Stop later: docker stop $CONTAINER_NAME"
else
    echo ""
    echo "‚úÖ Copilot session complete. Container stopped."
fi
