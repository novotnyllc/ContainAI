#!/usr/bin/env bash
# Quick launcher for GitHub Copilot from current directory
# Usage: run-copilot [directory] [--no-push]
#   directory: Path to repository (defaults to current directory)
#   --no-push: Skip auto-push on exit

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/../utils/common-functions.sh"

# Parse arguments
REPO_PATH="."
SKIP_PUSH=false

while [[ $# -gt 0 ]]; do
    case $1 in
        --no-push)
            SKIP_PUSH=true
            shift
            ;;
        -h|--help)
            echo "Usage: run-copilot [directory] [--no-push]"
            echo ""
            echo "Launch GitHub Copilot CLI in an ephemeral container."
            echo ""
            echo "Arguments:"
            echo "  directory    Path to repository (default: current directory)"
            echo ""
            echo "Options:"
            echo "  --no-push    Skip auto-push to local remote on exit"
            echo "  -h, --help   Show this help"
            echo ""
            echo "Examples:"
            echo "  run-copilot              # Launch in current directory"
            echo "  run-copilot ~/my-repo    # Launch in specific directory"
            echo "  run-copilot --no-push    # Skip auto-push on exit"
            exit 0
            ;;
        *)
            REPO_PATH="$1"
            shift
            ;;
    esac
done

# Check Docker
check_docker_running || exit 1

# Get container runtime (docker or podman)
CONTAINER_CMD=$(get_container_runtime)

# Resolve path
REPO_PATH=$(realpath "$REPO_PATH")

# Verify it's a git repository
if [ ! -d "$REPO_PATH/.git" ]; then
    echo "âŒ Error: $REPO_PATH is not a git repository"
    echo "   Run from within a git repository or provide a path to one"
    exit 1
fi

REPO_NAME=$(get_repo_name "$REPO_PATH")
BRANCH=$(get_current_branch "$REPO_PATH")
CONTAINER_NAME="copilot-${REPO_NAME}-${BRANCH}"

# Convert to WSL path if needed
REPO_PATH=$(convert_to_wsl_path "$REPO_PATH")

# Pull latest image
pull_and_tag_image "copilot"

echo "ðŸš€ Launching GitHub Copilot CLI..."
echo "ðŸ“ Repository: $REPO_NAME"
echo "ðŸŒ¿ Branch: $BRANCH"
echo "ðŸ·ï¸  Container: $CONTAINER_NAME"
echo ""

# Setup cleanup trap for auto-push
cleanup() {
    if $CONTAINER_CMD ps --filter "name=^${CONTAINER_NAME}$" --format "{{.Names}}" 2>/dev/null | grep -q "^${CONTAINER_NAME}$"; then
        echo ""
        push_to_local "$CONTAINER_NAME" "$SKIP_PUSH"
    fi
}
trap cleanup EXIT INT TERM

# Build docker arguments
DOCKER_ARGS=(
    "-it" "--rm"
    "--name" "$CONTAINER_NAME"
    "-e" "TZ=${TZ:-$(cat /etc/timezone 2>/dev/null || echo UTC)}"
    "-v" "${REPO_PATH}:/workspace"
    "-v" "${HOME}/.gitconfig:/home/agentuser/.gitconfig:ro"
    "-v" "${HOME}/.config/gh:/home/agentuser/.config/gh:ro"
    "-v" "${HOME}/.config/github-copilot:/home/agentuser/.config/github-copilot:ro"
    "--label" "coding-agents.type=agent"
    "--label" "coding-agents.agent=copilot"
    "--label" "coding-agents.repo=$REPO_NAME"
    "--label" "coding-agents.branch=$BRANCH"
)

# Add MCP secrets if they exist
if [ -f "${HOME}/.config/coding-agents/mcp-secrets.env" ]; then
    DOCKER_ARGS+=("-v" "${HOME}/.config/coding-agents/mcp-secrets.env:/home/agentuser/.mcp-secrets.env:ro")
fi

DOCKER_ARGS+=(
    "-w" "/workspace"
    "--security-opt" "no-new-privileges:true"
    "coding-agents-copilot:local"
)

# Run container
$CONTAINER_CMD run "${DOCKER_ARGS[@]}"
