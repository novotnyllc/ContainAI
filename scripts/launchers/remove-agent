#!/usr/bin/env bash
# Remove agent container with optional auto-push

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/../utils/common-functions.sh"

# Parse arguments
CONTAINER_NAME=""
SKIP_PUSH=false

while [[ $# -gt 0 ]]; do
    case $1 in
        --no-push)
            SKIP_PUSH=true
            shift
            ;;
        -h|--help)
            echo "Usage: remove-agent <container-name> [--no-push]"
            echo ""
            echo "Remove an agent container and its associated resources."
            echo "Automatically pushes changes to local remote before removal."
            echo ""
            echo "Options:"
            echo "  --no-push    Skip git push before removal"
            echo "  -h, --help   Show this help"
            echo ""
            echo "Examples:"
            echo "  remove-agent copilot-myrepo-main"
            echo "  remove-agent codex-myapp-feature --no-push"
            exit 0
            ;;
        *)
            CONTAINER_NAME="$1"
            shift
            ;;
    esac
done

# Check arguments
if [ -z "$CONTAINER_NAME" ]; then
    echo "❌ Error: Container name required"
    echo ""
    echo "Usage: remove-agent <container-name> [--no-push]"
    echo ""
    echo "Available containers:"
    docker ps -a --filter "label=coding-agents.type=agent" --format "  • {{.Names}}" 2>/dev/null
    exit 1
fi

# Check Docker
check_docker_running || exit 1

# Remove container
remove_container_with_sidecars "$CONTAINER_NAME" "$SKIP_PUSH"
