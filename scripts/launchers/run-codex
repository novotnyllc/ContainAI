#!/usr/bin/env bash
# Ultra-simple launcher for OpenAI Codex
# Usage: run-codex [directory]
#   directory: Path to repository (defaults to current directory)

REPO_PATH="${1:-.}"
REPO_PATH=$(realpath "$REPO_PATH")
REPO_NAME=$(basename "$REPO_PATH")

# Convert Windows path to WSL if needed
if [[ "$REPO_PATH" =~ ^[A-Z]: ]]; then
    DRIVE=$(echo "$REPO_PATH" | cut -d: -f1 | tr '[:upper:]' '[:lower:]')
    REST=$(echo "$REPO_PATH" | cut -d: -f2 | tr '\\' '/')
    REPO_PATH="/mnt/${DRIVE}${REST}"
fi

echo "ðŸ“¦ Checking for image updates..."
docker pull --quiet ghcr.io/novotnyllc/coding-agents-codex:latest 2>/dev/null && \
    docker tag ghcr.io/novotnyllc/coding-agents-codex:latest coding-agents-codex:local || true

echo "ðŸš€ Launching OpenAI Codex..."
echo "ðŸ“ Repository: $REPO_PATH"

# Build docker arguments
DOCKER_ARGS=(
    "-it" "--rm"
    "--name" "codex-${REPO_NAME}"
    "-e" "TZ=${TZ:-$(cat /etc/timezone 2>/dev/null || echo UTC)}"
    "-v" "${REPO_PATH}:/workspace"
    "-v" "${HOME}/.gitconfig:/home/agentuser/.gitconfig:ro"
    "-v" "${HOME}/.config/gh:/home/agentuser/.config/gh:ro"
)

# Add Codex config if it exists
if [ -d "${HOME}/.config/codex" ]; then
    DOCKER_ARGS+=("-v" "${HOME}/.config/codex:/home/agentuser/.config/codex:ro")
fi

# Add MCP secrets if they exist
if [ -f "${HOME}/.config/coding-agents/mcp-secrets.env" ]; then
    DOCKER_ARGS+=("-v" "${HOME}/.config/coding-agents/mcp-secrets.env:/home/agentuser/.mcp-secrets.env:ro")
fi

DOCKER_ARGS+=("-w" "/workspace" "--security-opt" "no-new-privileges:true" "coding-agents-codex:local")

docker run "${DOCKER_ARGS[@]}"
