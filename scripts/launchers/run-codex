#!/usr/bin/env bash
# Quick launcher for OpenAI Codex from current directory
# Usage: run-codex [directory] [--no-push]

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/../utils/common-functions.sh"

# Parse arguments
REPO_PATH="."
CPU="4"
MEMORY="8g"
GPU=""
SKIP_PUSH=false

while [[ $# -gt 0 ]]; do
    case $1 in
        --cpu)
            CPU="$2"
            shift 2
            ;;
        --memory)
            MEMORY="$2"
            shift 2
            ;;
        --gpu)
            GPU="$2"
            shift 2
            ;;
        --no-push)
            SKIP_PUSH=true
            shift
            ;;
        -h|--help)
            echo "Usage: run-codex [directory] [--no-push]"
            echo ""
            echo "Launch OpenAI Codex in an ephemeral container."
            echo ""
            echo "Arguments:"
            echo "  directory    Path to repository (default: current directory)"
            echo ""
            echo "Options:"
            echo "  --cpu NUM      CPU limit (default: 4)"
            echo "  --memory SIZE  Memory limit (default: 8g)"
            echo "  --gpu SPEC     GPU specification (e.g., 'all' or 'device=0')"
            echo "  --no-push      Skip auto-push to local remote on exit"
            echo "  -h, --help     Show this help"
            exit 0
            ;;
        *)
            REPO_PATH="$1"
            shift
            ;;
    esac
done

check_docker_running || exit 1
REPO_PATH=$(realpath "$REPO_PATH")

if [ ! -d "$REPO_PATH/.git" ]; then
    echo "âŒ Error: $REPO_PATH is not a git repository"
    exit 1
fi

REPO_NAME=$(get_repo_name "$REPO_PATH")
BRANCH=$(get_current_branch "$REPO_PATH")
CONTAINER_NAME="codex-${REPO_NAME}-${BRANCH}"
REPO_PATH=$(convert_to_wsl_path "$REPO_PATH")

pull_and_tag_image "codex"

echo "ðŸš€ Launching OpenAI Codex..."
echo "ðŸ“ Repository: $REPO_NAME"
echo "ðŸŒ¿ Branch: $BRANCH"
echo "ðŸ·ï¸  Container: $CONTAINER_NAME"
echo ""

cleanup() {
    if docker ps --filter "name=^${CONTAINER_NAME}$" --format "{{.Names}}" 2>/dev/null | grep -q "^${CONTAINER_NAME}$"; then
        echo ""
        push_to_local "$CONTAINER_NAME" "$SKIP_PUSH"
    fi
}
trap cleanup EXIT INT TERM

DOCKER_ARGS=(
    "-it" "--rm"
    "--name" "$CONTAINER_NAME"
    "-e" "TZ=${TZ:-$(cat /etc/timezone 2>/dev/null || echo UTC)}"
    "-v" "${REPO_PATH}:/workspace"
    "-v" "${HOME}/.gitconfig:/home/agentuser/.gitconfig:ro"
    "-v" "${HOME}/.config/gh:/home/agentuser/.config/gh:ro"
    "--label" "coding-agents.type=agent"
    "--label" "coding-agents.agent=codex"
    "--label" "coding-agents.repo=$REPO_NAME"
    "--label" "coding-agents.branch=$BRANCH"
)

if [ -d "${HOME}/.config/codex" ]; then
    DOCKER_ARGS+=("-v" "${HOME}/.config/codex:/home/agentuser/.config/codex:ro")
fi

if [ -f "${HOME}/.config/coding-agents/mcp-secrets.env" ]; then
    DOCKER_ARGS+=("-v" "${HOME}/.config/coding-agents/mcp-secrets.env:/home/agentuser/.mcp-secrets.env:ro")
fi

DOCKER_ARGS+=(
    "-w" "/workspace"
    "--security-opt" "no-new-privileges:true"
    "--cpus=$CPU"
    "--memory=$MEMORY"
)

# Add GPU if specified
if [ -n "$GPU" ]; then
    DOCKER_ARGS+=("--gpus=$GPU")
fi

DOCKER_ARGS+=("coding-agents-codex:local")

docker run "${DOCKER_ARGS[@]}"
