#!/usr/bin/env bash
# Quick launcher for OpenAI Codex from current directory
# Usage: run-codex [directory] [--no-push]

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/../utils/common-functions.sh"

REPO_ROOT="$(cd "$SCRIPT_DIR/../.." && pwd)"
maybe_check_launcher_updates "$REPO_ROOT" "run-codex"

# Parse arguments
REPO_PATH="."
BRANCH=""
NAME=""
DOTNET_PREVIEW=""
NETWORK_PROXY="allow-all"
CPU="4"
MEMORY="8g"
GPU=""
SKIP_PUSH=false
USE_CURRENT_BRANCH=false
FORCE=false

while [[ $# -gt 0 ]]; do
    case $1 in
        -b|--branch)
            BRANCH="$2"
            shift 2
            ;;
        --name)
            NAME="$2"
            shift 2
            ;;
        --dotnet-preview)
            DOTNET_PREVIEW="$2"
            shift 2
            ;;
        --network-proxy)
            NETWORK_PROXY="$2"
            shift 2
            ;;
        --cpu)
            CPU="$2"
            shift 2
            ;;
        --memory)
            MEMORY="$2"
            shift 2
            ;;
        --gpu)
            GPU="$2"
            shift 2
            ;;
        --no-push)
            SKIP_PUSH=true
            shift
            ;;
        --use-current-branch)
            USE_CURRENT_BRANCH=true
            shift
            ;;
        -y|--force)
            FORCE=true
            shift
            ;;
        -h|--help)
            echo "Usage: run-codex [directory] [OPTIONS]"
            echo ""
            echo "Launch OpenAI Codex in an ephemeral container."
            echo ""
            echo "Arguments:"
            echo "  directory              Path to repository (default: current directory)"
            echo ""
            echo "Options:"
            echo "  -b, --branch BRANCH    Branch name (creates <agent>/<branch>)"
            echo "  --name NAME            Custom container name"
            echo "  --dotnet-preview CH    Install .NET preview SDK (e.g., 11.0)"
            echo "  --network-proxy MODE   Network: allow-all, restricted, squid (default: allow-all)"
            echo "  --cpu NUM              CPU limit (default: 4)"
            echo "  --memory SIZE          Memory limit (default: 8g)"
            echo "  --gpu SPEC             GPU specification (e.g., 'all' or 'device=0')"
            echo "  --no-push              Skip auto-push to git remote on exit"
            echo "  --use-current-branch   Use current branch (no isolation)"
            echo "  -y, --force            Replace existing branch without prompt"
            echo "  -h, --help             Show this help"
            exit 0
            ;;
        *)
            REPO_PATH="$1"
            shift
            ;;
    esac
done

check_docker_running || exit 1
REPO_PATH=$(realpath "$REPO_PATH")

if [ ! -d "$REPO_PATH/.git" ]; then
    echo "‚ùå Error: $REPO_PATH is not a git repository"
    exit 1
fi

REPO_NAME=$(get_repo_name "$REPO_PATH")
BRANCH=$(get_current_branch "$REPO_PATH")
CONTAINER_NAME="codex-${REPO_NAME}-${BRANCH}"
TZ_VALUE="${TZ:-$(cat /etc/timezone 2>/dev/null || echo UTC)}"
REPO_PATH=$(convert_to_wsl_path "$REPO_PATH")

pull_and_tag_image "codex"

echo "üöÄ Launching OpenAI Codex..."
echo "üìÅ Repository: $REPO_NAME"
echo "üåø Branch: $BRANCH"
echo "üè∑Ô∏è  Container: $CONTAINER_NAME"
echo ""

DOCKER_ARGS=(
    "run" "-d" "--rm"
    "--name" "$CONTAINER_NAME"
    "-e" "TZ=$TZ_VALUE"
    "-e" "AGENT_SESSION_MODE=supervised"
    "-e" "AGENT_SESSION_NAME=agent"
    "-v" "${REPO_PATH}:/workspace"
    "-v" "${HOME}/.gitconfig:/home/agentuser/.gitconfig:ro"
    "-v" "${HOME}/.config/gh:/home/agentuser/.config/gh:ro"
    "--label" "coding-agents.type=agent"
    "--label" "coding-agents.agent=codex"
    "--label" "coding-agents.repo=$REPO_NAME"
    "--label" "coding-agents.branch=$BRANCH"
)

if $SKIP_PUSH; then
    DOCKER_ARGS+=("-e" "AUTO_PUSH_ON_SHUTDOWN=false")
fi

if [ -d "${HOME}/.config/codex" ]; then
    DOCKER_ARGS+=("-v" "${HOME}/.config/codex:/home/agentuser/.config/codex:ro")
fi

if [ -f "${HOME}/.config/coding-agents/mcp-secrets.env" ]; then
    DOCKER_ARGS+=("-v" "${HOME}/.config/coding-agents/mcp-secrets.env:/home/agentuser/.mcp-secrets.env:ro")
fi

DOCKER_ARGS+=(
    "-w" "/workspace"
    "--security-opt" "no-new-privileges:true"
    "--cpus=$CPU"
    "--memory=$MEMORY"
)

# Add GPU if specified
if [ -n "$GPU" ]; then
    DOCKER_ARGS+=("--gpus=$GPU")
fi

DOCKER_ARGS+=("coding-agents-codex:local")

if ! CONTAINER_ID=$(docker "${DOCKER_ARGS[@]}"); then
    echo "‚ùå Failed to start Codex container"
    exit 1
fi

echo "üîó Connecting to Codex session (detach with Ctrl+B then D)..."
docker exec -it "$CONTAINER_NAME" agent-session attach
ATTACH_STATUS=$?
if [ $ATTACH_STATUS -ne 0 ]; then
    if docker ps --filter "name=^${CONTAINER_NAME}$" --format "{{.Names}}" | grep -q "^${CONTAINER_NAME}$"; then
        echo "‚ö†Ô∏è  Unable to attach to session. Use $SCRIPT_DIR/connect-agent --name $CONTAINER_NAME once the container is ready."
    else
        echo "‚ùå Codex session exited before it was ready."
    fi
    exit $ATTACH_STATUS
fi

if docker ps --filter "name=^${CONTAINER_NAME}$" --format "{{.Names}}" | grep -q "^${CONTAINER_NAME}$"; then
    echo ""
    echo "‚ÑπÔ∏è  Session detached but container is still running."
    echo "   Reconnect: $SCRIPT_DIR/connect-agent --name $CONTAINER_NAME"
    echo "   Stop later: docker stop $CONTAINER_NAME"
else
    echo ""
    echo "‚úÖ Codex session complete. Container stopped."
fi
