#!/usr/bin/env bash
# Launch a coding agent in an isolated container with its own git workspace
# The container runs persistently for VS Code Remote connection

set -e

# Source shared functions
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/../utils/common-functions.sh"

# Default values
SOURCE="."
BRANCH=""
AGENT="copilot"
NAME=""
DOTNET_PREVIEW=""
NETWORK_PROXY="allow-all"
NO_PUSH=false

# Parse arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        -b|--branch)
            BRANCH="$2"
            shift 2
            ;;
        --agent)
            AGENT="$2"
            shift 2
            ;;
        --name)
            NAME="$2"
            shift 2
            ;;
        --dotnet-preview)
            DOTNET_PREVIEW="$2"
            shift 2
            ;;
        --network-proxy)
            NETWORK_PROXY="$2"
            shift 2
            ;;
        --no-push)
            NO_PUSH=true
            shift
            ;;
        -h|--help)
            echo "Usage: launch-agent [SOURCE] [OPTIONS]"
            echo ""
            echo "SOURCE can be:"
            echo "  ‚Ä¢ Local path to a git repository (default: current directory)"
            echo "  ‚Ä¢ Git URL (https://...)"
            echo ""
            echo "Options:"
            echo "  -b, --branch BRANCH         Branch name (creates <agent>/<branch>)"
            echo "  --agent AGENT               Agent type: copilot, codex, claude (default: copilot)"
            echo "  --name NAME                 Custom container name"
            echo "  --dotnet-preview CHANNEL    Install .NET preview SDK (e.g., 9.0)"
            echo "  --network-proxy MODE        Network proxy: allow-all, restricted, squid (default: allow-all)"
            echo "  --no-push                   Disable auto-push on container shutdown"
            echo "  -h, --help                  Show this help"
            echo ""
            echo "Examples:"
            echo "  launch-agent                           # Current directory"
            echo "  launch-agent . -b feature-auth         # Current dir, custom branch"
            echo "  launch-agent https://github.com/user/repo --agent copilot"
            echo "  launch-agent /path/to/repo --name my-workspace"
            exit 0
            ;;
        *)
            SOURCE="$1"
            shift
            ;;
    esac
done

# Validate network proxy option
case "$NETWORK_PROXY" in
    allow-all|none|restricted|squid) ;;
    *)
        echo "‚ùå Error: Invalid --network-proxy value '$NETWORK_PROXY'"
        exit 1
        ;;
esac

# Treat 'none' as alias for allow-all
[ "$NETWORK_PROXY" = "none" ] && NETWORK_PROXY="allow-all"

# Check Docker
check_docker_running || exit 1

# Determine if source is URL or local path
if [[ "$SOURCE" =~ ^https?:// ]]; then
    IS_URL=true
    SOURCE_TYPE="url"
    REPO_NAME=$(basename "$SOURCE" .git)
    GIT_URL="$SOURCE"
    ORIGIN_URL="$GIT_URL"
    WSL_PATH=""
else
    IS_URL=false
    SOURCE_TYPE="local"
    SOURCE=$(realpath "$SOURCE")
    
    # Check if git repository
    if [ ! -d "$SOURCE/.git" ]; then
        echo "‚ùå Error: $SOURCE is not a git repository"
        exit 1
    fi
    
    REPO_NAME=$(basename "$SOURCE")
    cd "$SOURCE"
    ORIGIN_URL=$(git remote get-url origin 2>/dev/null || echo "")
    cd - > /dev/null
    WSL_PATH=$(convert_to_wsl_path "$SOURCE")
    GIT_URL=""
fi

# Restricted network cannot clone URLs
if [ "$NETWORK_PROXY" = "restricted" ] && [ "$SOURCE_TYPE" = "url" ]; then
    echo "‚ùå Restricted network mode cannot clone from a URL. Provide a local path or use --network-proxy allow-all."
    exit 1
fi

# Determine branch name first
if [ -z "$BRANCH" ]; then
    if [ "$SOURCE_TYPE" = "local" ]; then
        cd "$SOURCE"
        CURRENT_BRANCH=$(git branch --show-current 2>/dev/null || echo "")
        cd - > /dev/null
        BRANCH="${CURRENT_BRANCH:-main}"
    else
        BRANCH="main"
    fi
fi

# Sanitize branch name for container naming
SAFE_BRANCH=$(echo "$BRANCH" | tr '/' '-' | tr '_' '-' | tr '[:upper:]' '[:lower:]')

# Determine container names
if [ -n "$NAME" ]; then
    CONTAINER_NAME="${AGENT}-${NAME}"
    WORKSPACE_NAME="$NAME"
else
    CONTAINER_NAME="${AGENT}-${REPO_NAME}-${SAFE_BRANCH}"
    WORKSPACE_NAME="$REPO_NAME"
fi

AGENT_BRANCH="${AGENT}/${BRANCH}"
PROXY_CONTAINER_NAME="${CONTAINER_NAME}-proxy"
PROXY_NETWORK_NAME="${CONTAINER_NAME}-net"
PROXY_IMAGE="coding-agents-proxy:local"

# Pull latest image
pull_and_tag_image "$AGENT"
IMAGE_NAME="coding-agents-${AGENT}:local"

# Get timezone
TZ_VALUE="${TZ:-$(cat /etc/timezone 2>/dev/null || echo UTC)}"

# Squid allowed domains
SQUID_ALLOWED_DOMAINS="*.github.com,*.githubcopilot.com,*.nuget.org,*.npmjs.org,*.pypi.org,*.python.org,*.microsoft.com,*.docker.io,registry-1.docker.io,api.githubcopilot.com,learn.microsoft.com,platform.uno,*.githubusercontent.com,*.azureedge.net"

# Determine network mode
NETWORK_MODE="bridge"
NETWORK_POLICY_ENV="allow-all"
USE_SQUID=false
PROXY_URL=""

case "$NETWORK_PROXY" in
    restricted)
        NETWORK_MODE="none"
        NETWORK_POLICY_ENV="restricted"
        ;;
    squid)
        NETWORK_MODE="$PROXY_NETWORK_NAME"
        NETWORK_POLICY_ENV="squid"
        USE_SQUID=true
        PROXY_URL="http://${PROXY_CONTAINER_NAME}:3128"
        ;;
    *)
        NETWORK_POLICY_ENV="allow-all"
        ;;
esac

echo "üöÄ Launching Coding Agent..."
echo "üéØ Agent: $AGENT"
echo "üìÅ Source: $SOURCE ($SOURCE_TYPE)"
echo "üåø Branch: $AGENT_BRANCH"
echo "üè∑Ô∏è  Container: $CONTAINER_NAME"
echo "üê≥ Image: $IMAGE_NAME"
echo "üåê Network policy: $NETWORK_POLICY_ENV"
echo ""

# Check if container already exists
if container_exists "$CONTAINER_NAME"; then
    echo "üì¶ Container '$CONTAINER_NAME' already exists"
    STATE=$(get_container_status "$CONTAINER_NAME")
    
    # Handle existing proxy if squid mode
    if [ "$USE_SQUID" = true ]; then
        EXISTING_PROXY=$(docker inspect -f '{{ index .Config.Labels "coding-agents.proxy-container" }}' "$CONTAINER_NAME" 2>/dev/null || echo "$PROXY_CONTAINER_NAME")
        EXISTING_NETWORK=$(docker inspect -f '{{ index .Config.Labels "coding-agents.proxy-network" }}' "$CONTAINER_NAME" 2>/dev/null || echo "$PROXY_NETWORK_NAME")
        PROXY_CONTAINER_NAME="$EXISTING_PROXY"
        PROXY_NETWORK_NAME="$EXISTING_NETWORK"
        ensure_squid_proxy "$PROXY_NETWORK_NAME" "$PROXY_CONTAINER_NAME" "$PROXY_IMAGE" "$CONTAINER_NAME" "$SQUID_ALLOWED_DOMAINS"
    fi
    
    if [ "$STATE" = "running" ]; then
        echo "‚úÖ Container is already running"
        echo "   Connect via: docker exec -it $CONTAINER_NAME bash"
        echo "   Or use VS Code Dev Containers extension"
        exit 0
    else
        echo "‚ñ∂Ô∏è  Starting existing container..."
        docker start "$CONTAINER_NAME"
        echo "‚úÖ Container started"
        exit 0
    fi
fi

# Setup squid proxy if needed
if [ "$USE_SQUID" = true ]; then
    ensure_squid_proxy "$PROXY_NETWORK_NAME" "$PROXY_CONTAINER_NAME" "$PROXY_IMAGE" "$CONTAINER_NAME" "$SQUID_ALLOWED_DOMAINS"
fi

# Build docker arguments
AUTO_PUSH_VALUE=$([ "$NO_PUSH" = true ] && echo "false" || echo "true")

DOCKER_ARGS=(
    "run" "-d"
    "--name" "$CONTAINER_NAME"
    "--hostname" "$CONTAINER_NAME"
    "-e" "TZ=$TZ_VALUE"
    "-e" "SOURCE_TYPE=$SOURCE_TYPE"
    "-e" "REPO_NAME=$WORKSPACE_NAME"
    "-e" "AGENT_BRANCH=$AGENT_BRANCH"
    "-e" "NETWORK_POLICY=$NETWORK_POLICY_ENV"
    "-e" "AUTO_PUSH_ON_SHUTDOWN=$AUTO_PUSH_VALUE"
    "--label" "coding-agents.type=agent"
    "--label" "coding-agents.agent=$AGENT"
    "--label" "coding-agents.repo=$REPO_NAME"
    "--label" "coding-agents.branch=$BRANCH"
    "--label" "coding-agents.network-policy=$NETWORK_POLICY_ENV"
    "-v" "${HOME}/.gitconfig:/home/agentuser/.gitconfig:ro"
    "-v" "${HOME}/.config/gh:/home/agentuser/.config/gh:ro"
    "-v" "${HOME}/.config/github-copilot:/home/agentuser/.config/github-copilot:ro"
)

# Add source-specific vars
if [ "$SOURCE_TYPE" = "url" ]; then
    DOCKER_ARGS+=("-e" "GIT_URL=$GIT_URL")
else
    DOCKER_ARGS+=("-e" "LOCAL_REPO_PATH=$WSL_PATH")
    DOCKER_ARGS+=("-v" "${WSL_PATH}:/tmp/source-repo:ro")
fi

[ -n "$ORIGIN_URL" ] && DOCKER_ARGS+=("-e" "ORIGIN_URL=$ORIGIN_URL")
[ -n "$DOTNET_PREVIEW" ] && DOCKER_ARGS+=("-e" "DOTNET_PREVIEW_CHANNEL=$DOTNET_PREVIEW")

# Add proxy environment if squid
if [ "$USE_SQUID" = true ]; then
    DOCKER_ARGS+=(
        "-e" "HTTP_PROXY=$PROXY_URL"
        "-e" "HTTPS_PROXY=$PROXY_URL"
        "-e" "http_proxy=$PROXY_URL"
        "-e" "https_proxy=$PROXY_URL"
        "-e" "NO_PROXY=localhost,127.0.0.1,.internal,::1"
        "-e" "no_proxy=localhost,127.0.0.1,.internal,::1"
        "--label" "coding-agents.proxy-container=$PROXY_CONTAINER_NAME"
        "--label" "coding-agents.proxy-network=$PROXY_NETWORK_NAME"
        "--label" "coding-agents.proxy-image=$PROXY_IMAGE"
    )
fi

# Add optional agent configs
[ -d "${HOME}/.config/codex" ] && DOCKER_ARGS+=("-v" "${HOME}/.config/codex:/home/agentuser/.config/codex:ro")
[ -d "${HOME}/.config/claude" ] && DOCKER_ARGS+=("-v" "${HOME}/.config/claude:/home/agentuser/.config/claude:ro")
[ -f "${HOME}/.config/coding-agents/mcp-secrets.env" ] && DOCKER_ARGS+=("-v" "${HOME}/.config/coding-agents/mcp-secrets.env:/home/agentuser/.mcp-secrets.env:ro")

# Final args
DOCKER_ARGS+=(
    "-w" "/workspace"
    "--network" "$NETWORK_MODE"
    "--security-opt" "no-new-privileges:true"
    "--cpus=4"
    "--memory=8g"
    "$IMAGE_NAME"
    "sleep" "infinity"
)

# Create container
echo "üì¶ Creating container..."
CONTAINER_ID=$(docker "${DOCKER_ARGS[@]}")

if [ $? -ne 0 ]; then
    echo "‚ùå Failed to create container"
    [ "$USE_SQUID" = true ] && docker rm -f "$PROXY_CONTAINER_NAME" >/dev/null 2>&1
    [ "$USE_SQUID" = true ] && docker network rm "$PROXY_NETWORK_NAME" >/dev/null 2>&1
    exit 1
fi

# Setup repository inside container
echo "üì• Setting up repository..."
SETUP_SCRIPT=$(generate_repo_setup_script "$SOURCE_TYPE" "$GIT_URL" "$WSL_PATH" "$ORIGIN_URL" "$AGENT_BRANCH")
echo "$SETUP_SCRIPT" | docker exec -i "$CONTAINER_NAME" bash

if [ $? -ne 0 ]; then
    echo "‚ùå Failed to setup repository"
    docker rm -f "$CONTAINER_NAME"
    exit 1
fi

echo ""
echo "‚úÖ Container '$CONTAINER_NAME' is ready!"
echo ""
echo "Connect via:"
echo "  ‚Ä¢ VS Code: Attach to running container '$CONTAINER_NAME'"
echo "  ‚Ä¢ Terminal: docker exec -it $CONTAINER_NAME bash"
echo ""
echo "Repository: /workspace"
echo "Branch: $AGENT_BRANCH"
