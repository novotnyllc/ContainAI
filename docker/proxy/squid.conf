# Minimal Squid proxy configuration for ContainAI
# Allows outbound HTTP/HTTPS traffic while keeping full request logs and MITM inspection

# Bind to IPv4 only to avoid IPv6 issues in containers
http_port 0.0.0.0:3128 ssl-bump cert=/etc/squid/mitm/ca.crt key=/etc/squid/mitm/ca.key generate-host-certificates=on dynamic_cert_mem_cache_size=32MB
sslcrtd_program /usr/lib/squid/security_file_certgen -s /var/spool/squid/ssl_db -M 16MB
sslcrtd_children 5 startup=1 idle=1
acl step1 at_step SslBump1
ssl_bump peek step1
ssl_bump bump all

# Basic ACLs
acl SSL_ports port 443
acl Safe_ports port 80 443 21 70 210 280 488 591 777 1025-65535
acl CONNECT method CONNECT
acl linklocal_metadata dst 169.254.0.0/16
acl private_networks dst 10.0.0.0/8 172.16.0.0/12 192.168.0.0/16
# Allowed domains from file (populated by entrypoint.sh)
acl allowed_domains dstdomain "/etc/squid/allowed-domains.txt"

# Payload size limits
request_body_max_size 10 MB
reply_body_max_size 100 MB

# Access rules - allow only configured domains
http_access allow localhost
http_access deny !Safe_ports
http_access deny CONNECT !SSL_ports
http_access deny linklocal_metadata
http_access allow allowed_domains
http_access deny private_networks
include /etc/squid/agent-headers.conf
include /etc/squid/helper-acls.conf
http_access deny all

# Logging (streamed to container stdout/stderr) with agent/session/helper identity
# TODO: Fix custom header logging syntax for Squid 5
# logformat containai %ts.%03tu %6tr %>a %un %>{X-CA-Agent}h %>{X-CA-Session}h %>{X-CA-Helper}h %Ss/%>Hs %<st %rm %ru limit=%err_code
logformat containai %ts.%03tu %6tr %>a %un %Ss/%>Hs %<st %rm %ru
access_log stdio:/var/log/squid/access.log containai
cache_log stdio:/var/log/squid/cache.log
cache_store_log stdio:/var/log/squid/store.log
buffered_logs off
logfile_rotate 1

# Disable on-disk caching (sidecar is for inspection, not caching)
cache deny all
cache_mem 64 MB
maximum_object_size 8 MB

# Misc hardening
via off
forwarded_for delete
request_header_access X-Forwarded-For deny all
request_header_access Via deny all
