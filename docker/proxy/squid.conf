# Minimal Squid proxy configuration for Coding Agents
# Allows outbound HTTP/HTTPS traffic while keeping full request logs

http_port 3128

# Basic ACLs
acl localnet src 0.0.0.0/0
acl SSL_ports port 443
acl Safe_ports port 80 443 21 70 210 280 488 591 777 1025-65535
acl CONNECT method CONNECT

# Allowed domains from file (populated by entrypoint.sh)
acl allowed_domains dstdomain "/etc/squid/allowed-domains.txt"

# Security: Block cloud metadata endpoints
acl metadata_endpoints dst 169.254.169.254
acl metadata_endpoints dst 169.254.0.0/16

# Security: Block private IP ranges
acl private_ips dst 10.0.0.0/8
acl private_ips dst 172.16.0.0/12
acl private_ips dst 192.168.0.0/16

# Access rules - security first, then allowed domains
http_access allow localhost
http_access deny metadata_endpoints
http_access deny private_ips
http_access deny !Safe_ports
http_access deny CONNECT !SSL_ports
http_access allow localnet allowed_domains
http_access deny all

# Logging (streamed to container stdout/stderr)
access_log stdio:/var/log/squid/access.log
cache_log stdio:/var/log/squid/cache.log
cache_store_log stdio:/var/log/squid/store.log
logfile_rotate 0

# Disable on-disk caching (sidecar is for inspection, not caching)
cache deny all
cache_mem 64 MB
maximum_object_size 8 MB

# Security: Rate limiting to prevent abuse
reply_body_max_size 100 MB
request_body_max_size 10 MB

# Misc hardening
via off
forwarded_for delete
dns_v4_first on
request_header_access X-Forwarded-For deny all
request_header_access Via deny all
