# Minimal Squid proxy configuration for ContainAI
# Allows outbound HTTP/HTTPS traffic while keeping full request logs

http_port 3128

# Basic ACLs
acl localnet src 0.0.0.0/0
acl SSL_ports port 443
acl Safe_ports port 80 443 21 70 210 280 488 591 777 1025-65535
acl CONNECT method CONNECT
acl linklocal_metadata dst 169.254.169.254/32 169.254.0.0/16
acl private_networks dst 10.0.0.0/8 172.16.0.0/12 192.168.0.0/16
# Allowed domains from file (populated by entrypoint.sh)
acl allowed_domains dstdomain "/etc/squid/allowed-domains.txt"

# Payload size limits
request_body_max_size 10 MB
reply_body_max_size 100 MB

# Access rules - allow only configured domains
http_access allow localhost
http_access deny !Safe_ports
http_access deny CONNECT !SSL_ports
http_access deny linklocal_metadata
http_access deny private_networks
include /etc/squid/agent-headers.conf
include /etc/squid/helper-acls.conf
http_access deny all

# Logging (streamed to container stdout/stderr) with agent/session/helper identity
logformat containai %ts.%03tu %6tr %>a %un %>{X-CA-Agent}>h %>{X-CA-Session}>h %>{X-CA-Helper}>h %Ss/%>Hs %<st %rm %ru limit=%err_code
access_log stdio:/var/log/squid/access.log containai
cache_log stdio:/var/log/squid/cache.log
cache_store_log stdio:/var/log/squid/store.log
logfile_rotate 0

# Disable on-disk caching (sidecar is for inspection, not caching)
cache deny all
cache_mem 64 MB
maximum_object_size 8 MB

# Misc hardening
via off
forwarded_for delete
dns_v4_first on
request_header_access X-Forwarded-For deny all
request_header_access Via deny all
