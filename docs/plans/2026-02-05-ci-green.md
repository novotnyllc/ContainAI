# CI Green + Log Visibility Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Make CI green by aligning tests with the new global `BASH_ENV`, improve CI watcher diagnostics, and expand macOS Lima log capture so failures are actionable.

**Architecture:** Keep the single multi-arch build pipeline in `build-push`, have tests consume those images, and ensure diagnostics (containai + Lima/Docker) are always captured. Update tests to reflect the global `BASH_ENV` model.

**Tech Stack:** GitHub Actions, bash scripts, Docker Buildx, Lima, shell test scripts.

## Public API / Interface Changes
- `scripts/ci-watch-docker.sh`: enhanced output and failure log capture (behavioral change for CLI output).
- No CLI flags or config schema changes.

---

### Task 1: Align Wrapper Tests With Global `BASH_ENV`

**Files:**
- Modify: `tests/integration/test-launch-wrappers.sh`

**Step 1: Run the existing test to confirm failure (RED)**

Run (requires test image available):
```bash
./tests/integration/test-launch-wrappers.sh
```
Expected: FAIL with BASH_ENV mismatch (expects `/home/agent/.bash_env` but now `/etc/containai/bash_env`).

**Step 2: Update test expectation (GREEN)**

Edit test 4 to expect `/etc/containai/bash_env` and update the pass/fail messaging accordingly.

**Step 3: Re-run test to verify it passes**

Run:
```bash
./tests/integration/test-launch-wrappers.sh
```
Expected: PASS.

**Step 4: Commit**

```bash
git add tests/integration/test-launch-wrappers.sh
git commit -m "test: align wrapper test with global BASH_ENV"
```

---

### Task 2: Improve CI Watcher to Capture Failure Logs Reliably

**Files:**
- Modify: `scripts/ci-watch-docker.sh`

**Step 1: Add status polling and failure log capture (RED)**

Behavioral test (manual):
- Run the script while a workflow is in progress and confirm it prints job status updates.
- On failure, confirm it prints failing job URLs and dumps job logs to stderr or a temp file.

**Step 2: Implement polling + log capture (GREEN)**

Implementation detail:
- Replace the current `gh run watch` block with polling `gh run view --json status,conclusion,jobs`.
- When a job completes with failure, call `gh run view <run_id> --log --job <job_id>` and print the tail (or store under `/tmp/containai-logs/ci-watch-<run_id>-<job>.log`).
- Exit non-zero on failure; zero on success.

**Step 3: Manual verification**

Run:
```bash
./scripts/ci-watch-docker.sh
```
Expected: prints the latest run id; during in-progress, prints job status summary each interval; on completion, exits 0/1 and emits failure logs.

**Step 4: Commit**

```bash
git add scripts/ci-watch-docker.sh
git commit -m "tools: improve ci watcher failure diagnostics"
```

---

### Task 3: Fix Sysbox SSH Test Key Permissions

**Files:**
- Modify: `tests/integration/test-startup-hooks.sh`

**Step 1: Reproduce failure (RED)**

CI evidence shows SSH publickey auth failed for the test user during startup hooks tests.

**Step 2: Fix .ssh permissions for the test user (GREEN)**

When writing the test user's authorized_keys, ensure:
- `chmod 700 "$ssh_home/.ssh"`
- `chmod 600 "$ssh_home/.ssh/authorized_keys"`

**Step 3: Commit**

```bash
git add tests/integration/test-startup-hooks.sh
git commit -m "test: fix ssh key permissions for sysbox ssh test"
```

---

### Task 4: Make Launch Wrapper Tests Independent of systemd

**Files:**
- Modify: `tests/integration/test-launch-wrappers.sh`

**Step 1: Update test container creation**

Override the image entrypoint so the test container does not require systemd:
- Add `--entrypoint /bin/bash`
- Use command `-lc 'tail -f /dev/null'`

**Step 2: Commit**

```bash
git add tests/integration/test-launch-wrappers.sh
git commit -m "test: run wrapper tests without systemd entrypoint"
```

---

### Task 5: Expand macOS Lima Log Capture + Harden Setup

**Files:**
- Modify: `.github/workflows/docker.yml`

**Step 1: Add Lima host-side log collection**

Add to the macOS "Collect Lima diagnostics" step:
- `~/.lima/<vm>/*.log` and `~/.lima/<vm>/serial*.log`
- `~/Library/Logs/Lima/*.log` if present

**Step 2: Ensure Lima readiness logs**

In the "Ensure Lima VM is ready" step, print:
- `limactl --version`
- `limactl list --json` (already listed but ensure JSON output for clarity)
- `ls -la ~/.lima/<vm>/sock/` for socket visibility

**Step 3: Add setup retry with clean VM on failure**

Wrap `cai setup --verbose` with a retry that force-deletes the VM if startup fails:
- `limactl delete -f containai-docker || true`
- `rm -rf ~/.lima/containai-docker`

**Step 4: Manual verification**

N/A locally. CI artifact `lima-logs-<runner>-<run_id>` should include the new files.

**Step 5: Commit**

```bash
git add .github/workflows/docker.yml
git commit -m "ci: expand macos lima diagnostics"
```

---

## Tests and Validation
- `./tests/integration/test-launch-wrappers.sh` (local if test image exists)
- CI: `Build and Push Docker Image` workflow should pass end-to-end

## Assumptions and Defaults
- Using existing single build pipeline (`build-push`) and test jobs pull built images.
- PRs from the same repo continue to push PR-tagged images for tests.
- Logs are captured via artifacts; no extra external log storage.
