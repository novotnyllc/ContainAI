# Launcher Workflows

Understand how `run-*` and `launch-agent` containers behave, how they are named, and which commands help you manage them.

## Container Naming Convention

All containers follow the pattern: `{agent}-{repo}-{branch}`

**Examples:**
- `copilot-myapp-main` - GitHub Copilot on myapp repository, main branch
- `codex-website-feature` - OpenAI Codex on website repository, feature branch
- `claude-api-develop` - Anthropic Claude on api repository, develop branch

**Why this naming?**
- **Easily identifiable:** See what's running at a glance with `docker ps`
- **No conflicts:** Multiple agents can work on the same repo/different branches
- **Management friendly:** Use `list-agents` to see all your agent containers
- **Labeled for filtering:** All containers have labels for agent, repo, and branch

**Container labels** (for filtering and automation):
```bash
containai.type=agent       # Identifies agent containers
containai.agent=copilot    # Which agent (copilot/codex/claude)
containai.repo=myapp       # Repository name
containai.branch=main      # Branch name
```

## Auto-Commit and Auto-Push Safety Features

All containers automatically commit and push uncommitted changes back to your local repository before shutting down. This ensures you never lose work even if a container is accidentally removed.

**How it works:**
1. When you exit a container (Ctrl+D, docker stop, remove-agent)
2. Container checks for uncommitted changes (staged or unstaged)
3. If changes exist, automatically commits them with a generated message
4. Pushes the commit to `local` remote (your host machine)
5. Container shuts down safely

**Example generated commit messages:**
```
feat: add user authentication with JWT tokens
fix: resolve null pointer exception in data loader
refactor: extract validation logic to separate class
chore: auto-commit (2 modified, 1 added)  # fallback if AI unavailable
```

The commit message is generated by asking the AI agent (GitHub Copilot) that was just running to analyze the changes and create a meaningful message. If the AI is unavailable, it falls back to a basic summary.

**Default behavior:** Auto-commit and auto-push are **enabled**

**Disable auto-commit (also disables auto-push):**
```bash
# For ephemeral launchers
AUTO_COMMIT_ON_SHUTDOWN=false run-copilot-dev
AUTO_COMMIT_ON_SHUTDOWN=false run-codex-dev

# PowerShell
$env:AUTO_COMMIT_ON_SHUTDOWN="false"; run-copilot-dev.ps1
```

**Disable only auto-push (keep auto-commit):**
```bash
# For ephemeral launchers
AUTO_PUSH_ON_SHUTDOWN=false run-copilot-dev
run-copilot-dev --no-push

# PowerShell
run-copilot-dev.ps1 -NoPush

# For persistent launchers
launch-agent-dev copilot --no-push
launch-agent-dev.ps1 copilot -NoPush

# When removing containers
remove-agent-dev copilot-myapp-main --no-push
```

**When to disable:**
- Testing/experimental work you don't want to keep
- Temporary containers you plan to discard
- When you prefer manual commit messages

**Safety notes:**
- Auto-commit stages ALL changes (tracked files, untracked files, deletions)
- Auto-push only works if `local` remote is configured (automatically done by launchers)
- Ephemeral containers (`run-*` scripts) auto-remove after exit, so auto-commit/push is critical
- Persistent containers (`launch-agent`) stay running until explicitly removed

## Launcher Scripts

There are two types of launcher scripts. **Start with `run-*` for most tasks.**

### 1. Ephemeral Launchers (`run-*`) - RECOMMENDED

Fast, temporary containers that auto-remove on exit. Perfect for quick tasks.

**Available scripts (channel-aware under `host/launchers/entrypoints`):**
- `run-copilot-dev` / `run-copilot-dev.ps1` (use `run-copilot` for prod bundles, `run-copilot-nightly` for nightly smoke)
- `run-codex-dev` / `run-codex-dev.ps1`
- `run-claude-dev` / `run-claude-dev.ps1`

**Usage pattern:**
```bash
# Navigate to your project
cd ~/my-project

# Launch agent (defaults to current directory)
run-copilot-dev
run-codex-dev
run-claude-dev

# PowerShell
run-copilot-dev.ps1
run-codex-dev.ps1
run-claude-dev.ps1
```

**Optional flags:**
- `--no-push` / `-NoPush` - Disable auto-push on exit
- `--help` / `-Help` - Show usage information
- `[directory]` - Specify directory (default: current directory)

**Behavior:**
- Pulls the image for your channel (e.g., `dev`) automatically
- Creates container named `{agent}-{repo}-{branch}`
- Auto-removes container on exit
- Auto-pushes changes to local remote before exit (unless --no-push)
- Keeps a background sync daemon running to fast-forward your host repo after every push (disable with `CONTAINAI_DISABLE_AUTO_SYNC=1`)
- Removes upstream git remotes so the container cannot reach your GitHub origin; publish from the host repo when you're ready
- Interactive shell, exit with Ctrl+D or detach via tmux (see below)

**Example:**
```bash
cd ~/my-project
run-copilot-dev              # Launch on current directory (use run-copilot in prod bundles)
run-codex --no-push      # Launch without auto-push
run-claude ~/other-proj  # Launch on specific directory
```

### 2. Persistent Launchers (`launch-agent`) - ADVANCED

For long-running tasks or when you need advanced features. Containers run in background and support branch management, network controls, and .NET preview installs.

**When to use launch-agent:**
- Multi-day/week development sessions
- Need to disconnect and reconnect to same workspace
- Working on multiple branches with different agents
- Require network monitoring or restrictions
- Installing custom SDKs (e.g., .NET preview)

**Most users should use `run-*` scripts instead.**

**Basic Usage:**

```bash
# Everyday use - just launch
launch-agent copilot
launch-agent codex

# Work on specific feature
launch-agent copilot --branch refactor-db
launch-agent claude --branch optimize-queries

# Clone and work on GitHub repo
launch-agent copilot https://github.com/user/repo
launch-agent copilot https://github.com/user/repo --branch add-tests
```

**Parameters:**

| Parameter | Description | Example |
|-----------|-------------|---------|
| Agent (required, first) | Agent type: `copilot`, `codex`, `claude` | `copilot`, `codex`, `claude` |
| Source (positional) | Local path or GitHub URL (default: current directory) | `.`, `/path/to/repo`, `https://github.com/user/repo` |
| `-b` or `--branch` | Feature branch name (becomes `<agent>/<branch>`) | `-b auth` creates `copilot/auth` |
| `-y` or `--force` | Auto-replace existing agent branch without prompting | `-y` or `--force` |
| `--no-push` | Disable auto-push on shutdown | `--no-push` |
| `--use-current-branch` | Work directly on current branch instead of creating agent branch | `--use-current-branch` |
| `--dotnet-preview` | Install .NET preview SDK | `--dotnet-preview 11.0` |
| `--network-proxy` | Network mode: `squid` (default), `restricted` | `--network-proxy restricted` |

**Branch Management:**

Agents work on isolated branches to keep their changes separate:

**Without `--branch` flag:**
- Creates unique session branch: `<agent>/session-1`, `<agent>/session-2`, etc.
- Useful for quick experiments or when you don't want to name a branch
- Example: `copilot/session-1`, `codex/session-2`

**With `--branch` flag:**
- Creates `<agent>/<branch>` from your current commit
- Example: `--branch feature-api` creates `copilot/feature-api`
- Example: `--branch refactor-auth` creates `claude/refactor-auth`

**Already on agent branch:**
- If current branch matches `<agent>/*` pattern, reuses it
- Example: Already on `copilot/session-1` → continues using it

**With `--use-current-branch`:**
- Works directly on whatever branch you're currently on
- No agent-specific branch created

When launching an agent, if its branch already exists:
1. **Prompt for replacement** (default: No)
   - Press `y` to replace the existing branch
   - Press `n` (or Enter) to abort
   - Use `-y` or `--force` flag to auto-replace without prompting

2. **Check for unmerged commits**
   - Lists commits not yet merged into the base branch
   - Shows up to 5 most recent unmerged commits

3. **Archive or delete**
   - **Has unmerged commits**: Archives to `<agent>/<branch>-archived-<timestamp>`
   - **No unmerged commits**: Safely deletes the branch
   - Prevents accidental work loss

When removing an agent container:
- Agent branches are automatically cleaned up
- Branches with unmerged commits are preserved (warning shown)
- Use `--keep-branch` flag to preserve the branch regardless

**Behavior:**
- Runs in background (detached mode)
- Persists until explicitly removed
- Auto-pushes changes on `docker stop` or `remove-agent` (unless --no-push)
- Connect with VS Code Dev Containers or `docker exec`

**Advanced Options:**

```bash
# Install .NET preview SDK
launch-agent copilot --dotnet-preview 9.0
launch-agent codex --dotnet-preview 10.0

# Network proxy modes
launch-agent copilot --network-proxy restricted   # No outbound network
launch-agent copilot --network-proxy squid        # Proxy with logging
```

See [docs/network-proxy.md](../network-proxy.md) for network configuration details.

## Multiple Agents, Same Repo

Launch multiple agents working on different features:

```bash
cd ~/my-project

# Launch different agents on different branches
launch-agent copilot --branch api-v2       # copilot-myproject-api-v2
launch-agent codex --branch database       # codex-myproject-database
launch-agent claude --branch frontend      # claude-myproject-frontend
```

Each agent gets:
- Own isolated workspace
- Own branch (`copilot/auth`, `codex/database`, `claude/ui`)
- Own container (`copilot-myproject-auth`, `codex-myproject-database`, `claude-myproject-ui`)

No conflicts!

## Detaching and Reconnecting

Every agent container now starts a managed tmux session so you can pause work without stopping the container—**this includes `run-*` containers**.

- **Detach:** Press `Ctrl+B`, then `D` while inside the agent session. The session (Copilot/Codex/Claude or a shell) keeps running in the background.
- **Reconnect (Bash):** `host/launchers/connect-agent --name <container>`
- **Reconnect (PowerShell):** `host\launchers\connect-agent.ps1 -Name <container>`
- If only one agent container is running, `connect-agent` automatically attaches to it. Otherwise, pass the container name (see `list-agents`).
- `run-*` launchers attach you to tmux immediately after the container starts. When you detach, the container keeps running until you exit the tmux session or remove the container, so you can hop back in with `connect-agent` just like persistent sessions.
- `launch-agent` containers also expose a ready-to-use shell session through `connect-agent`, making it easy to hop in and out without VS Code.
- When finished for good, stop the container (`docker stop <name>` or `remove-agent <name>`) so auto-commit/push can run and resources are freed.

## Managing Containers

### List Active Agent Containers

View all running agent containers with status information:

```bash
list-agents           # Bash
list-agents.ps1       # PowerShell
```

**Example output:**
```
Active Agent Containers:
NAME                      STATUS       AGENT      BRANCH
copilot-myapp-main        Up 2 hours   copilot    main
codex-myapp-feature       Up 1 hour    codex      feature
claude-website-develop    Up 30 min    claude     develop
```

**Features:**
- Filters by `containai.type=agent` label
- Shows container name, status, agent type, and branch
- Color-coded status (green=running, red=stopped)
- Empty list if no agent containers running

### Remove Agent Containers

Safely remove containers with automatic change preservation and branch cleanup:

```bash
# Remove with auto-push and branch cleanup (default)
remove-agent copilot-myapp-main
remove-agent.ps1 copilot-myapp-main

# Remove without auto-push
remove-agent copilot-myapp-main --no-push
remove-agent.ps1 copilot-myapp-main -NoPush

# Remove but keep the agent branch
remove-agent copilot-myapp-main --keep-branch
remove-agent.ps1 copilot-myapp-main -KeepBranch
```

**What it does:**
1. Checks for uncommitted changes
2. Pushes to local remote (unless --no-push)
3. Stops and removes the container
4. Removes proxy sidecar (if using squid mode)
5. Removes network (if empty and no other containers)
6. **Cleans up agent branch** (unless --keep-branch or has unmerged commits)

**Branch cleanup behavior:**
- **No unmerged commits**: Branch is safely deleted
- **Has unmerged commits**: Branch is preserved with a warning
- **--keep-branch flag**: Branch is always preserved
- Only affects local repositories (not remote URLs)

**Safety features:**
- Won't lose uncommitted work (auto-push default)
- Won't lose unmerged commits (preserved with warning)
- Cleans up all associated resources
- Reports what was removed

### Standard Docker Commands

You can also use standard Docker commands:

```bash
# List all containers (not just agents)
docker ps -a

# Stop a container (triggers auto-push trap)
docker stop copilot-myapp-main

# Remove a container (triggers auto-push trap if running)
docker rm -f copilot-myapp-main

# View logs
docker logs copilot-myapp-main

# Execute command in container
docker exec -it copilot-myapp-main bash
```

**Note:** Using `docker stop` or `docker rm -f` will trigger auto-push if the container is configured for it (default behavior).

### Manual Docker Management

```bash
docker ps              # Running
docker ps -a           # All (including stopped)

docker stop copilot-app
docker stop copilot-app-proxy    # When launched with --network-proxy squid

docker start copilot-app
# or
.\launch-agent.ps1     # Auto-detects and starts existing

docker rm -f copilot-app
docker rm -f copilot-app-proxy   # When launched with --network-proxy squid
docker network rm copilot-app-net  # Proxy network (only if no other containers attached)

# Logs
docker logs copilot-app
```

⚠️ **Warning:** Removing a container deletes its workspace. Push your changes first!
