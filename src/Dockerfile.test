# syntax=docker/dockerfile:1
# Docker Test Container for ContainAI
#
# This Dockerfile creates a lightweight testing environment for Docker-in-Docker
# verification. It is designed to run INSIDE a sysbox system container, so it
# does not need to install sysbox itself - the host already provides that
# isolation and DinD capability.
#
# Architecture:
#   Host (containai docker-ce + sysbox)
#     └── Test Container (this Dockerfile, runs with --runtime=sysbox-runc)
#           └── Inner Docker (uses runc - sysbox isolation comes from outer container)
#
# IMPORTANT: This container must be run with --runtime=sysbox-runc, NOT with
# --privileged. The sysbox runtime provides all necessary capabilities for DinD.
#
# Usage (from repo root):
#   docker build -t containai-test -f src/Dockerfile.test src/
#   docker --context containai-secure run --rm --runtime=sysbox-runc containai-test
#
# Note: Requires BuildKit (DOCKER_BUILDKIT=1 or Docker 23.0+)

FROM ubuntu:24.04

SHELL ["/bin/bash", "-o", "pipefail", "-c"]

# Prevent interactive prompts during package installation
ENV DEBIAN_FRONTEND=noninteractive \
    TZ=UTC \
    LANG=C.UTF-8 \
    LC_ALL=C.UTF-8

# Install base dependencies
RUN --mount=type=cache,target=/var/cache/apt,sharing=locked \
    --mount=type=cache,target=/var/lib/apt,sharing=locked \
    rm -f /etc/apt/apt.conf.d/docker-clean && \
    echo 'Binary::apt::APT::Keep-Downloaded-Packages "true";' > /etc/apt/apt.conf.d/keep-cache && \
    apt-get update && \
    apt-get install -y --no-install-recommends \
        ca-certificates \
        curl \
        gnupg \
        lsb-release \
        jq \
        iproute2 \
        iptables \
        kmod \
        procps \
        fuse

# Install Docker daemon only (no sysbox)
# Note: Sysbox is NOT installed here - the host's sysbox runtime provides
# DinD capability when this container runs with --runtime=sysbox-runc.
# Inner Docker uses runc (the standard runtime); the outer sysbox container
# provides all necessary isolation.
RUN curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg && \
    echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" > /etc/apt/sources.list.d/docker.list && \
    apt-get update && \
    apt-get install -y --no-install-recommends \
        docker-ce \
        docker-ce-cli \
        containerd.io

# Configure inner Docker daemon
# - Uses a separate socket to avoid conflicts with any host Docker
# - Uses runc (default runtime) - sysbox isolation comes from outer container
# - Storage-driver is omitted to let dockerd auto-select
COPY configs/daemon-test.json /etc/docker/daemon.json

# Set default Docker host to test socket
ENV DOCKER_HOST=unix:///var/run/docker-test.sock

# Copy startup and test scripts
COPY --chmod=0755 scripts/start-dockerd.sh /usr/local/bin/start-dockerd.sh
COPY --chmod=0755 scripts/test-dind.sh /usr/local/bin/test-dind.sh

# Clean up apt cache to reduce image size
RUN apt-get clean && \
    rm -rf /var/lib/apt/lists/*

WORKDIR /workspace

ENTRYPOINT ["/usr/local/bin/start-dockerd.sh"]
CMD ["/usr/local/bin/test-dind.sh"]
