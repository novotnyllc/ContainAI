# syntax=docker/dockerfile:1
# Docker Test Container for ContainAI with dockerd + Sysbox
#
# This Dockerfile creates a testing environment with its own dockerd and Sysbox
# runtime. Used for CI or development testing of ContainAI images directly
# inside a container.
#
# IMPORTANT: Uses /var/run/docker-test.sock to avoid conflicts with host Docker.
#
# Usage (from repo root):
#   docker build -t containai-test -f src/Dockerfile.test src/
#   docker run --privileged containai-test /usr/local/bin/test-dind.sh
#
# Note: Requires BuildKit (DOCKER_BUILDKIT=1 or Docker 23.0+)

FROM ubuntu:24.04

SHELL ["/bin/bash", "-o", "pipefail", "-c"]

# Prevent interactive prompts during package installation
ENV DEBIAN_FRONTEND=noninteractive \
    TZ=UTC \
    LANG=C.UTF-8 \
    LC_ALL=C.UTF-8

# Install base dependencies
RUN --mount=type=cache,target=/var/cache/apt,sharing=locked \
    --mount=type=cache,target=/var/lib/apt,sharing=locked \
    rm -f /etc/apt/apt.conf.d/docker-clean && \
    echo 'Binary::apt::APT::Keep-Downloaded-Packages "true";' > /etc/apt/apt.conf.d/keep-cache && \
    apt-get update && \
    apt-get install -y --no-install-recommends \
        ca-certificates \
        curl \
        gnupg \
        lsb-release \
        wget \
        jq \
        git \
        iproute2 \
        iptables \
        kmod \
        procps \
        fuse

# Install Docker daemon
RUN curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg && \
    echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" > /etc/apt/sources.list.d/docker.list && \
    apt-get update && \
    apt-get install -y --no-install-recommends \
        docker-ce \
        docker-ce-cli \
        containerd.io

# Install Sysbox
ARG SYSBOX_VERSION=0.6.7
RUN ARCH=$(dpkg --print-architecture) && \
    wget -q -O /tmp/sysbox.deb "https://downloads.nestybox.com/sysbox/releases/v${SYSBOX_VERSION}/sysbox-ce_${SYSBOX_VERSION}-0.linux_${ARCH}.deb" && \
    apt-get install -y /tmp/sysbox.deb && \
    rm /tmp/sysbox.deb

# Configure Docker with Sysbox runtime (NOT as default)
# Use a different socket to avoid conflicts with any host Docker
# Note: storage-driver is omitted to let dockerd auto-select (overlay2 may not work in nested environments)
COPY configs/daemon-test.json /etc/docker/daemon.json

# Set default Docker host to test socket
ENV DOCKER_HOST=unix:///var/run/docker-test.sock

# Copy startup and test scripts
COPY --chmod=0755 scripts/start-dockerd.sh /usr/local/bin/start-dockerd.sh
COPY --chmod=0755 scripts/test-dind.sh /usr/local/bin/test-dind.sh

# Clean up apt cache to reduce image size
RUN apt-get clean && \
    rm -rf /var/lib/apt/lists/*

WORKDIR /workspace

ENTRYPOINT ["/usr/local/bin/start-dockerd.sh"]
CMD ["bash"]
