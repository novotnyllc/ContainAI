<Project Sdk="Microsoft.NET.Sdk">

  <PropertyGroup>
    <OutputType>Exe</OutputType>
    <AssemblyName>cai</AssemblyName>
    <RootNamespace>ContainAI.Cli.Host</RootNamespace>
    <Description>ContainAI native CLI host</Description>
  </PropertyGroup>

  <PropertyGroup>
    <PublishAot>true</PublishAot>
    <OptimizationPreference>Speed</OptimizationPreference>
    <IlcOptimizationPreference>Speed</IlcOptimizationPreference>
    <InvariantGlobalization>true</InvariantGlobalization>
  </PropertyGroup>

  <PropertyGroup>
    <TrimMode>link</TrimMode>
    <EnableTrimAnalyzer>true</EnableTrimAnalyzer>
  </PropertyGroup>

  <ItemGroup>
    <ProjectReference Include="../ContainAI.Cli/ContainAI.Cli.csproj" />
    <ProjectReference Include="../AgentClientProtocol.Proxy/AgentClientProtocol.Proxy.csproj" />
  </ItemGroup>

  <ItemGroup>
    <PackageReference Include="Tomlyn" />
  </ItemGroup>

  <PropertyGroup>
    <ContainAIRepositoryRoot>$([System.IO.Path]::GetFullPath('$(MSBuildProjectDirectory)/../..'))</ContainAIRepositoryRoot>
    <ContainAIOutputDir Condition="'$(ContainAIOutputDir)'==''">$([System.IO.Path]::GetFullPath('$(ContainAIRepositoryRoot)/artifacts/cai-tarballs'))</ContainAIOutputDir>
    <ContainAIVersion Condition="'$(ContainAIVersion)'==''">$(Version)</ContainAIVersion>
    <ContainAIRuntimeIdentifiers Condition="'$(ContainAIRuntimeIdentifiers)'=='' and '$(RuntimeIdentifier)'!=''">$(RuntimeIdentifier)</ContainAIRuntimeIdentifiers>
  </PropertyGroup>

  <Target Name="BuildContainAITarballs" DependsOnTargets="_ValidateTarballInputs">
    <ItemGroup>
      <_ContainAIRids Include="$(ContainAIRuntimeIdentifiers)" />
    </ItemGroup>

    <MSBuild
      Projects="$(MSBuildProjectFullPath)"
      Targets="PackageContainAIRelease"
      Properties="Configuration=$(Configuration);RuntimeIdentifier=%(_ContainAIRids.Identity);ContainAIVersion=$(ContainAIVersion);ContainAIOutputDir=$(ContainAIOutputDir)" />
  </Target>

  <Target Name="_ValidateTarballInputs">
    <Error Condition="'$(ContainAIRuntimeIdentifiers)'==''" Text="ContainAIRuntimeIdentifiers must be set (for example: linux-x64;linux-arm64)." />
    <Error Condition="'$(ContainAIVersion)'==''" Text="ContainAIVersion must be set." />
  </Target>

  <Target Name="_ResolvePackageArch">
    <PropertyGroup>
      <ContainAIPackageArch Condition="'$(RuntimeIdentifier)'=='linux-x64'">linux-x64</ContainAIPackageArch>
      <ContainAIPackageArch Condition="'$(RuntimeIdentifier)'=='linux-arm64'">linux-arm64</ContainAIPackageArch>
      <ContainAIPackageArch Condition="'$(RuntimeIdentifier)'=='osx-x64'">macos-x64</ContainAIPackageArch>
      <ContainAIPackageArch Condition="'$(RuntimeIdentifier)'=='osx-arm64'">macos-arm64</ContainAIPackageArch>
    </PropertyGroup>

    <Error Condition="'$(RuntimeIdentifier)'==''" Text="RuntimeIdentifier is required for PackageContainAIRelease." />
    <Error Condition="'$(ContainAIPackageArch)'==''" Text="Unsupported RuntimeIdentifier '$(RuntimeIdentifier)'. Supported: linux-x64, linux-arm64, osx-x64, osx-arm64." />
  </Target>

  <Target Name="PackageContainAIRelease" DependsOnTargets="_ResolvePackageArch;Publish">
    <PropertyGroup>
      <ContainAIPackageName>containai-$(ContainAIVersion)-$(ContainAIPackageArch)</ContainAIPackageName>
      <ContainAIStagingRoot>$([System.IO.Path]::GetFullPath('$(IntermediateOutputPath)/package-staging'))</ContainAIStagingRoot>
      <ContainAIPackageDir>$(ContainAIStagingRoot)/$(ContainAIPackageName)</ContainAIPackageDir>
      <ContainAIPublishedBinaryPath>$(PublishDir)$(AssemblyName)$(ExecutableExtension)</ContainAIPublishedBinaryPath>
      <ContainAITarballPath>$(ContainAIOutputDir)/$(ContainAIPackageName).tar.gz</ContainAITarballPath>
    </PropertyGroup>

    <MakeDir Directories="$(ContainAIOutputDir)" />
    <RemoveDir Directories="$(ContainAIStagingRoot)" />
    <MakeDir Directories="$(ContainAIPackageDir);$(ContainAIPackageDir)/manifests;$(ContainAIPackageDir)/templates;$(ContainAIPackageDir)/container" />

    <ItemGroup>
      <_ManifestFiles Include="$(ContainAIRepositoryRoot)/src/manifests/*.toml" />
      <_TemplateFiles Include="$(ContainAIRepositoryRoot)/src/templates/**" Exclude="$(ContainAIRepositoryRoot)/src/templates/**/" />
      <_ContainerFiles Include="$(ContainAIRepositoryRoot)/src/container/**" Exclude="$(ContainAIRepositoryRoot)/src/container/**/" />
      <_RootFiles Include="$(ContainAIRepositoryRoot)/install.sh;$(ContainAIRepositoryRoot)/LICENSE" />
    </ItemGroup>

    <Error Condition="!Exists('$(ContainAIPublishedBinaryPath)')" Text="Published cai binary not found: $(ContainAIPublishedBinaryPath)" />

    <Copy SourceFiles="$(ContainAIPublishedBinaryPath)" DestinationFiles="$(ContainAIPackageDir)/cai" />
    <Copy SourceFiles="@(_ManifestFiles)" DestinationFiles="@(_ManifestFiles->'$(ContainAIPackageDir)/manifests/%(Filename)%(Extension)')" />
    <Copy SourceFiles="@(_TemplateFiles)" DestinationFiles="@(_TemplateFiles->'$(ContainAIPackageDir)/templates/%(RecursiveDir)%(Filename)%(Extension)')" />
    <Copy SourceFiles="@(_ContainerFiles)" DestinationFiles="@(_ContainerFiles->'$(ContainAIPackageDir)/container/%(RecursiveDir)%(Filename)%(Extension)')" />
    <Copy SourceFiles="@(_RootFiles)" DestinationFiles="@(_RootFiles->'$(ContainAIPackageDir)/%(Filename)%(Extension)')" />

    <Exec Condition="$([MSBuild]::IsOSPlatform('Linux')) Or $([MSBuild]::IsOSPlatform('OSX'))"
          Command="chmod +x &quot;$(ContainAIPackageDir)/cai&quot; &quot;$(ContainAIPackageDir)/install.sh&quot;" />

    <Error Condition="!Exists('$(ContainAIPackageDir)/container/Dockerfile.template-system')" Text="Missing required runtime file in package staging: container/Dockerfile.template-system" />

    <Exec Command="tar -czf &quot;$(ContainAITarballPath)&quot; -C &quot;$(ContainAIStagingRoot)&quot; &quot;$(ContainAIPackageName)&quot;" />

    <Message Importance="High" Text="Created release tarball: $(ContainAITarballPath)" />
  </Target>

</Project>
