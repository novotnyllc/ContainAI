# syntax=docker/dockerfile:1
# ContainAI Full Layer - AI Agents and CLI Tools
#
# Includes: Claude Code, Gemini CLI, Copilot, Codex, OpenCode, agent-browser, gh CLI
#
# Usage (from repo root, requires BuildKit):
#   ./src/build.sh --layer full
#
# The build script runs generators first to create src/container/generated/ files.
# Manual docker build requires running generators first:
#   ./src/scripts/gen-dockerfile-symlinks.sh src/sync-manifest.toml src/container/generated/symlinks.sh
#   ./src/scripts/gen-init-dirs.sh src/sync-manifest.toml src/container/generated/init-dirs.sh
#   ./src/scripts/gen-container-link-spec.sh src/sync-manifest.toml src/container/generated/link-spec.json
#   cp src/container/link-repair.sh src/container/generated/link-repair.sh
#   docker build -t containai/full -f src/container/Dockerfile.agents src/
#
# Requires containai/sdks:latest to be built first (or use ./src/build.sh for all layers)
#
# Note: Requires Docker BuildKit (Docker 23.0+ or DOCKER_BUILDKIT=1)

ARG SDKS_IMAGE=ghcr.io/novotnyllc/containai/sdks:latest
FROM ${SDKS_IMAGE}

SHELL ["/bin/bash", "-o", "pipefail", "-c"]

# =============================================================================
# GITHUB CLI
# =============================================================================
USER root

RUN --mount=type=cache,target=/var/cache/apt,sharing=locked \
    --mount=type=cache,target=/var/lib/apt,sharing=locked \
    # Add GitHub CLI GPG key and repository
    curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg \
        -o /usr/share/keyrings/githubcli-archive-keyring.gpg && \
    chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg && \
    echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" \
        > /etc/apt/sources.list.d/github-cli.list && \
    apt-get update && \
    apt-get install -y --no-install-recommends gh && \
    # Verify gh installed correctly
    gh --version

# =============================================================================
# AI AGENTS
# Installed as agent user for proper permissions
# =============================================================================
USER agent
WORKDIR /home/agent

# Create agent data directories for config/auth file symlinks
RUN mkdir -p \
    /home/agent/.claude \
    /home/agent/.copilot \
    /home/agent/.gemini \
    /home/agent/.codex \
    /home/agent/.continue \
    /home/agent/.cursor \
    /home/agent/.local/share/opencode

# Install Claude Code via official installer
RUN curl -fsSL https://claude.ai/install.sh | bash && \
    # Verify claude installed correctly
    /home/agent/.local/bin/claude --version

# Add Claude/local binaries to PATH via .bashrc.d (for interactive shells)
# AND via .profile (for SSH login shells - critical for cai shell to find claude)
# The SSH session runs as a login shell which sources ~/.profile but may not source
# .bashrc.d depending on shell interactivity state.
RUN printf '%s\n' \
    'export PATH="/home/agent/.local/bin:${PATH}"' \
    > /home/agent/.bashrc.d/01-oai-env-vars.sh && \
    # Add to .profile for login shell sessions (SSH via cai shell)
    # Check if already present to be idempotent
    if ! grep -qF '/home/agent/.local/bin' /home/agent/.profile 2>/dev/null; then \
        printf '\n%s\n' '# Add local binaries to PATH (for SSH login shells)' >> /home/agent/.profile && \
        printf '%s\n' 'export PATH="/home/agent/.local/bin:${PATH}"' >> /home/agent/.profile; \
    fi

ENV PATH="/home/agent/.local/bin:${PATH}"

# Install Gemini CLI, Codex, and agent-browser via bun
# Using --trust to allow postinstall scripts
RUN --mount=type=cache,target=/var/cache/apt,sharing=locked \
    --mount=type=cache,target=/var/lib/apt,sharing=locked \
    . /home/agent/.nvm/nvm.sh && \
    bun install -g --trust @google/gemini-cli @openai/codex playwright agent-browser skills @mariozechner/pi-coding-agent && agent-browser install --with-deps \
    # Verify installations
    gemini --version && \
    codex --version

# Install Copilot CLI via official installer
RUN curl -fsSL https://gh.io/copilot-install | bash && \
    # Verify copilot installed correctly
    copilot --version

# Install OpenCode via official installer
RUN curl -fsSL https://opencode.ai/install | bash && \
    ln -snf /home/agent/.opencode/bin/opencode /home/agent/.local/bin/opencode && \
    # Verify opencode installed correctly (opencode may not have --version)
    /home/agent/.local/bin/opencode --version

# Install Kimi CLI
RUN uv tool install --python 3.13 kimi-cli && \
    # Verify kimi installed correctly
    kimi --version

# =============================================================================
# AGENT CONFIGURATION SYMLINKS
# Symlink config files to /mnt/agent-data for persistence across container restarts
# Generated from sync-manifest.toml via src/scripts/gen-dockerfile-symlinks.sh
# =============================================================================

# Pre-symlink setup: move installer-created files to data volume location
RUN if [ -f /home/agent/.claude.json ]; then \
        mkdir -p /mnt/agent-data/claude && \
        mv /home/agent/.claude.json /mnt/agent-data/claude/claude.json; \
    fi && \
    # Clean OpenCode installer state (selective sync requires clean slate)
    rm -rf /home/agent/.config/opencode && \
    mkdir -p /home/agent/.config/opencode

# Ensure /mnt/agent-data exists and is owned by agent user
# The base image creates this, but we verify here as a safeguard since
# symlinks.sh runs as USER agent and needs to create subdirectories
USER root
RUN mkdir -p /mnt/agent-data && chown agent:agent /mnt/agent-data

# Run generated symlink script (created from sync-manifest.toml)
# Uses bash explicitly since symlinks.sh uses bash features for error logging
# Note: /tmp cleanup happens later as root (RUN rm -rf /tmp/*)
USER agent
COPY --chown=agent:agent container/generated/symlinks.sh /tmp/symlinks.sh
RUN bash /tmp/symlinks.sh

# =============================================================================
# POST-SYMLINK SETUP
# Special configuration that must happen after symlinks are created
# =============================================================================

# SSH directory permissions (symlinks created by generated script)
RUN chmod 700 /home/agent/.ssh

# Add bashrc hooks for imported aliases and volume bashrc.d scripts
# Note: Build-time .bashrc.d scripts (like 01-claude.sh) are already sourced via base layer
# This adds sourcing for user-imported scripts from the data volume
RUN { grep -qxF '[ -f ~/.bash_aliases_imported ] && . ~/.bash_aliases_imported' /home/agent/.bashrc \
      || { echo '# Source imported bash_aliases if exists'; echo '[ -f ~/.bash_aliases_imported ] && . ~/.bash_aliases_imported'; } >> /home/agent/.bashrc; } && \
    { grep -qxF 'if [ -d /mnt/agent-data/shell/bashrc.d ]; then for f in /mnt/agent-data/shell/bashrc.d/*.sh; do [ -r "$f" ] && . "$f"; done; fi' /home/agent/.bashrc \
      || { echo '# Source user scripts from data volume'; echo 'if [ -d /mnt/agent-data/shell/bashrc.d ]; then for f in /mnt/agent-data/shell/bashrc.d/*.sh; do [ -r "$f" ] && . "$f"; done; fi'; } >> /home/agent/.bashrc; }

# =============================================================================
# AGENT ALIASES
# Convenience aliases for running agents in autonomous mode
# =============================================================================
RUN printf '%s\n' \
    'alias claude="claude --dangerously-skip-permissions"' \
    'alias codex="codex --dangerously-bypass-approvals-and-sandbox"' \
    'alias copilot="copilot --yolo"' \
    'alias gemini="gemini --yolo"' \
    'alias kimi="kimi --yolo"' \
    'alias kimi-cli="kimi-cli --yolo"' \
    > /home/agent/.bash_aliases

# =============================================================================
# CONTAINAI-INIT SERVICE
# One-shot systemd service to prepare volume structure on first boot
# This handles the runtime setup that entrypoint.sh did in Docker sandbox mode
# =============================================================================
USER root

COPY container/containai-init.sh /usr/local/lib/containai/init.sh
COPY services/containai-init.service /etc/systemd/system/containai-init.service
RUN chmod +x /usr/local/lib/containai/init.sh && \
    # Enable the service via symlink (systemctl requires systemd as PID 1)
    mkdir -p /etc/systemd/system/multi-user.target.wants && \
    ln -sf /etc/systemd/system/containai-init.service /etc/systemd/system/multi-user.target.wants/containai-init.service

# =============================================================================
# LINK SPEC AND REPAIR TOOLS
# Generated from sync-manifest.toml for runtime link verification/repair
# =============================================================================
COPY container/generated/link-spec.json /usr/local/lib/containai/link-spec.json
COPY container/generated/link-repair.sh /usr/local/lib/containai/link-repair.sh
COPY container/generated/init-dirs.sh /usr/local/lib/containai/init-dirs.sh
RUN chmod +x /usr/local/lib/containai/link-repair.sh /usr/local/lib/containai/init-dirs.sh

# =============================================================================
# LINK WATCHER SERVICE
# Monitors for new imports and auto-repairs symlinks
# =============================================================================
COPY container/link-watcher.sh /usr/local/lib/containai/link-watcher.sh
COPY services/containai-link-watcher.service /etc/systemd/system/containai-link-watcher.service
RUN chmod +x /usr/local/lib/containai/link-watcher.sh && \
    ln -sf /etc/systemd/system/containai-link-watcher.service /etc/systemd/system/multi-user.target.wants/containai-link-watcher.service

# =============================================================================
# FINAL CONFIGURATION
# =============================================================================

# Clean up temporary files
RUN rm -rf /tmp/*

# Dynamic build args at end to avoid cache invalidation
ARG BUILD_DATE=unknown
ARG VCS_REF=unknown
ARG VERSION=unknown

LABEL org.opencontainers.image.title="ContainAI Full" \
      org.opencontainers.image.description="Complete AI agent sandbox with Claude, Gemini, Copilot, Codex, OpenCode, and gh CLI" \
      org.opencontainers.image.url="https://github.com/novotnyllc/containai" \
      org.opencontainers.image.source="https://github.com/novotnyllc/containai" \
      org.opencontainers.image.documentation="https://github.com/novotnyllc/containai#readme" \
      org.opencontainers.image.vendor="Claire Novotny LLC" \
      org.opencontainers.image.licenses="MIT" \
      org.opencontainers.image.version="${VERSION}" \
      org.opencontainers.image.created="${BUILD_DATE}" \
      org.opencontainers.image.revision="${VCS_REF}"

# Inherit entrypoint from base (systemd as PID 1)
# Volume setup is handled by containai-init.service on first boot
