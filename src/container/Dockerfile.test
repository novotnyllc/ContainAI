# syntax=docker/dockerfile:1
# Docker Test Container for ContainAI
#
# This Dockerfile creates a lightweight testing environment for Docker-in-Docker
# verification. It is designed to run INSIDE a sysbox system container, so it
# does not need to start sysbox services (sysbox-mgr/sysbox-fs) - the host
# already provides that coordination.
#
# Architecture:
#   Host (containai docker-ce + sysbox)
#     └── Test Container (this Dockerfile, runs with --runtime=sysbox-runc)
#           └── Inner Docker (uses sysbox-runc as default runtime)
#
# IMPORTANT: This container must be run with --runtime=sysbox-runc, NOT with
# --privileged. The sysbox runtime provides all necessary capabilities for DinD.
#
# Usage (from repo root):
#   docker build -t containai-test -f src/container/Dockerfile.test src/
#   docker --context containai-secure run --rm --runtime=sysbox-runc containai-test
#
# Note: Requires BuildKit (DOCKER_BUILDKIT=1 or Docker 23.0+)

FROM ubuntu:24.04

SHELL ["/bin/bash", "-o", "pipefail", "-c"]

# Prevent interactive prompts during package installation
ENV DEBIAN_FRONTEND=noninteractive \
    TZ=UTC \
    LANG=C.UTF-8 \
    LC_ALL=C.UTF-8

# Install base dependencies
RUN --mount=type=cache,target=/var/cache/apt,sharing=locked \
    --mount=type=cache,target=/var/lib/apt,sharing=locked \
    rm -f /etc/apt/apt.conf.d/docker-clean && \
    echo 'Binary::apt::APT::Keep-Downloaded-Packages "true";' > /etc/apt/apt.conf.d/keep-cache && \
    apt-get update && \
    apt-get install -y --no-install-recommends \
        ca-certificates \
        curl \
        gnupg \
        lsb-release \
        jq \
        iproute2 \
        iptables \
        kmod \
        procps \
        fuse

# Install Docker daemon
RUN curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg && \
    echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" > /etc/apt/sources.list.d/docker.list && \
    apt-get update && \
    apt-get install -y --no-install-recommends \
        docker-ce \
        docker-ce-cli \
        containerd.io

# Install Sysbox CE (for sysbox-runc binary only, services NOT started)
#
# DECISION: The spec has contradictory requirements:
#   1. "Sysbox installation removed" (host provides isolation)
#   2. "Inner Docker configured with sysbox-runc as default"
#
# Resolution: Install sysbox package to get the sysbox-runc BINARY, but do NOT
# start sysbox services (sysbox-mgr, sysbox-fs). The host's sysbox runtime
# provides coordination when this container runs with --runtime=sysbox-runc.
# This satisfies both requirements: no redundant services, but inner Docker
# can use sysbox-runc as default runtime.
ARG SYSBOX_VERSION=0.6.7
ARG SYSBOX_SHA256_AMD64=b7ac389e5a19592cadf16e0ca30e40919516128f6e1b7f99e1cb4ff64554172e
ARG SYSBOX_SHA256_ARM64=16d80123ba53058cf90f5a68686e297621ea97942602682e34b3352783908f91

RUN ARCH=$(dpkg --print-architecture) && \
    if [ "$ARCH" = "amd64" ]; then EXPECTED_SHA256="${SYSBOX_SHA256_AMD64}"; \
    elif [ "$ARCH" = "arm64" ]; then EXPECTED_SHA256="${SYSBOX_SHA256_ARM64}"; \
    else echo "Unsupported architecture: $ARCH" && exit 1; fi && \
    curl -fsSL -o /tmp/sysbox.deb "https://downloads.nestybox.com/sysbox/releases/v${SYSBOX_VERSION}/sysbox-ce_${SYSBOX_VERSION}-0.linux_${ARCH}.deb" && \
    echo "${EXPECTED_SHA256}  /tmp/sysbox.deb" | sha256sum -c - && \
    apt-get install -y /tmp/sysbox.deb && \
    rm /tmp/sysbox.deb

# Configure inner Docker daemon with sysbox-runc as default runtime
# - Uses a separate socket to avoid conflicts with any host Docker
# - Storage-driver is omitted to let dockerd auto-select
COPY configs/daemon-test.json /etc/docker/daemon.json

# Set default Docker host to test socket
ENV DOCKER_HOST=unix:///var/run/docker-test.sock

# Copy startup and test scripts
COPY --chmod=0755 scripts/start-dockerd.sh /usr/local/bin/start-dockerd.sh
COPY --chmod=0755 scripts/test-dind.sh /usr/local/bin/test-dind.sh

# Clean up apt cache to reduce image size
RUN apt-get clean && \
    rm -rf /var/lib/apt/lists/*

WORKDIR /workspace

ENTRYPOINT ["/usr/local/bin/start-dockerd.sh"]
CMD ["/usr/local/bin/test-dind.sh"]
