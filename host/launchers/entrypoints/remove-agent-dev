#!/usr/bin/env bash
# Remove agent container with optional auto-push

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
# shellcheck source=host/utils/common-functions.sh
source "$SCRIPT_DIR/../../utils/common-functions.sh"

# Parse arguments
CONTAINER_NAME=""
SKIP_PUSH=false
KEEP_BRANCH=false

while [[ $# -gt 0 ]]; do
    case $1 in
        --no-push)
            SKIP_PUSH=true
            shift
            ;;
        --keep-branch)
            KEEP_BRANCH=true
            shift
            ;;
        -h|--help)
            echo "Usage: remove-agent <container-name> [--no-push] [--keep-branch]"
            echo ""
            echo "Remove an agent container and its associated resources."
            echo "Automatically pushes changes to local remote before removal."
            echo "Agent branches are cleaned up unless they have unmerged commits."
            echo ""
            echo "Options:"
            echo "  --no-push      Skip git push before removal"
            echo "  --keep-branch  Keep the agent's branch in the host repository"
            echo "  -h, --help     Show this help"
            echo ""
            echo "Examples:"
            echo "  remove-agent copilot-myrepo-main"
            echo "  remove-agent codex-myapp-feature --no-push"
            echo "  remove-agent claude-myrepo-feature --keep-branch"
            exit 0
            ;;
        *)
            CONTAINER_NAME="$1"
            shift
            ;;
    esac
done

# Ensure container runtime is available before we proceed
check_docker_running || exit 1

# Check arguments
if [ -z "$CONTAINER_NAME" ]; then
    echo "❌ Error: Container name required"
    echo ""
    echo "Usage: remove-agent <container-name> [--no-push] [--keep-branch]"    
    echo ""
    echo "Available containers:"
    container_cli ps -a --filter "label=containai.type=agent" --format "  • {{.Names}}" 2>/dev/null
    exit 1
fi

# Remove container
remove_container_with_sidecars "$CONTAINER_NAME" "$SKIP_PUSH" "$KEEP_BRANCH"
