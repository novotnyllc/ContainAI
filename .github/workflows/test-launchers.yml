name: Test Launcher Scripts

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'host/launchers/**'
      - 'host/utils/**'
      - 'scripts/test/**'
      - 'docker/**'
      - '.github/workflows/test-launchers.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'host/launchers/**'
      - 'host/utils/**'
      - 'scripts/test/**'
      - 'docker/**'
      - '.github/workflows/test-launchers.yml'

env:
  TRIVY_VERSION: v0.53.0

jobs:
  # Quick unit tests
  unit-test-bash:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Docker
        run: |
          docker --version
          docker info
      
      - name: Setup Git
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Install socat
        run: sudo apt-get update && sudo apt-get install -y socat libseccomp-dev libcap-dev zlib1g-dev clang

      - name: Install host assets
        run: sudo ./scripts/setup-local-dev.sh

      - name: Install Trivy
        run: |
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sudo sh -s -- -b /usr/local/bin ${TRIVY_VERSION}
      
      - name: Make test script executable
        run: chmod +x scripts/test/test-launchers.sh
      
      - name: Run launcher tests (bash)
        run: ./scripts/test/test-launchers.sh
      
      - name: Cleanup test containers
        if: always()
        run: |
          docker ps -aq --filter "label=containai.test=true" | xargs -r docker rm -f || true

  unit-test-powershell-linux:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Docker
        run: |
          docker --version
          docker info

      - name: Setup Git
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Install socat
        run: sudo apt-get update && sudo apt-get install -y socat libseccomp-dev libcap-dev zlib1g-dev clang

      - name: Install host assets (sudo)
        run: sudo ./scripts/setup-local-dev.sh

      - name: Install Trivy
        run: |
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sudo sh -s -- -b /usr/local/bin ${TRIVY_VERSION}

      - name: Run launcher tests (PowerShell Linux)
        run: pwsh -NoLogo -File scripts/test/test-launchers.ps1

      - name: Cleanup test containers
        if: always()
        run: |
          docker ps -aq --filter "label=containai.test=true" | xargs -r docker rm -f || true

  unit-test-powershell:
    runs-on: windows-latest
    # Windows runners can't run Linux containers, so we only validate script syntax
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Validate PowerShell script syntax
        shell: pwsh
        run: |
          # Parse all PowerShell scripts to check for syntax errors
          $scripts = @(
            "scripts/test/test-launchers.ps1",
            "host/launchers/run-agent.ps1"
          )
          $hasErrors = $false
          foreach ($script in $scripts) {
            if (Test-Path $script) {
              $errors = $null
              [System.Management.Automation.Language.Parser]::ParseFile($script, [ref]$null, [ref]$errors) | Out-Null
              if ($errors.Count -gt 0) {
                Write-Error "Syntax errors in ${script}:"
                $errors | ForEach-Object { Write-Error $_.ToString() }
                $hasErrors = $true
              } else {
                Write-Host "âœ“ $script - syntax OK"
              }
            }
          }
          if ($hasErrors) { exit 1 }

  # Full integration tests (launchers mode - faster)
  integration-test-launchers:
    runs-on: ubuntu-latest
    steps:
      - name: Free up disk space
        run: |
          # Remove large preinstalled packages we don't need for building containers
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache/CodeQL
          sudo docker image prune -af
          df -h /

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Setup Git
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Install socat
        run: sudo apt-get update && sudo apt-get install -y socat libseccomp-dev libcap-dev zlib1g-dev clang

      - name: Install host assets (sudo)
        run: sudo ./scripts/setup-local-dev.sh

      - name: Install Trivy
        run: |
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sudo sh -s -- -b /usr/local/bin ${TRIVY_VERSION}
      
      - name: Build artifacts
        run: |
          ARCH=$(uname -m)
          if [ "$ARCH" = "x86_64" ]; then ARCH="amd64"; elif [ "$ARCH" = "aarch64" ]; then ARCH="arm64"; fi
          ./scripts/build/compile-binaries.sh "$ARCH" artifacts

      - name: Make integration test executable
        run: chmod +x scripts/test/integration-test.sh scripts/test/test-env.sh
      
      - name: Run integration tests (launchers mode)
        env:
          TEST_SKIP_REGISTRY_PUSH: "true"
        run: ./scripts/test/integration-test.sh --mode launchers
      
      - name: Cleanup test resources
        if: always()
        run: |
          docker ps -aq --filter "label=containai.test=true" | xargs -r docker rm -f || true
          docker network ls --filter "name=test-containai" --format "{{.Name}}" | xargs -r docker network rm || true

  # Full integration tests (full mode - on main branch only)
  integration-test-full:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Free up disk space
        run: |
          # Remove large preinstalled packages we don't need for building containers
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache/CodeQL
          sudo docker image prune -af
          df -h /

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Setup Git
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Install socat
        run: sudo apt-get update && sudo apt-get install -y socat libseccomp-dev libcap-dev zlib1g-dev clang

      - name: Install host assets
        run: sudo ./scripts/setup-local-dev.sh

      - name: Install Trivy
        run: |
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sudo sh -s -- -b /usr/local/bin ${TRIVY_VERSION}
      
      - name: Build artifacts
        run: |
          ARCH=$(uname -m)
          if [ "$ARCH" = "x86_64" ]; then ARCH="amd64"; elif [ "$ARCH" = "aarch64" ]; then ARCH="arm64"; fi
          ./scripts/build/compile-binaries.sh "$ARCH" artifacts

      - name: Make integration test executable
        run: chmod +x scripts/test/integration-test.sh scripts/test/test-env.sh
      
      - name: Run integration tests (full mode)
        run: ./scripts/test/integration-test.sh --mode full
      
      - name: Cleanup test resources
        if: always()
        run: |
          docker ps -aq --filter "label=containai.test=true" | xargs -r docker rm -f || true
          docker network ls --filter "name=test-containai" --format "{{.Name}}" | xargs -r docker network rm || true
          docker rm -f $(docker ps -aq --filter "ancestor=registry:2") 2>/dev/null || true
