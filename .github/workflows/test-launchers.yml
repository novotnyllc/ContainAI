name: Test Launcher Scripts

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'host/**'
      - 'scripts/**'
      - 'src/**'
      - 'docker/**'
      - '.github/workflows/test-launchers.yml'
      - '.github/actions/setup-build-env/**'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'host/**'
      - 'scripts/**'
      - 'src/**'
      - 'docker/**'
      - '.github/workflows/test-launchers.yml'
      - '.github/actions/setup-build-env/**'

jobs:
  static-analysis:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run ShellCheck
        uses: ludeeus/action-shellcheck@master
        with:
          scandir: './host ./scripts'
          severity: error

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11' # Matches python:3.11-slim used in run_python_tool

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pylint mypy types-requests types-PyYAML

      - name: Run Pylint
        run: |
          # Run pylint on all Python files (no disables)
          shopt -s globstar nullglob
          pylint **/*.py

  unit-test-dotnet:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          global-json-file: src/global.json

      - name: Restore dependencies
        run: dotnet restore src/ContainAI.slnx

      - name: Build
        run: dotnet build --no-restore src/ContainAI.slnx

      - name: Test
        run: dotnet test --no-build --verbosity normal src/ContainAI.slnx

  unit-test-rust:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup build environment
        uses: ./.github/actions/setup-build-env

      - name: Run Clippy (Agent Task Runner)
        run: |
          cd src/agent-task-runner
          cargo clippy -- -D warnings

      - name: Run Tests (Agent Task Runner)
        run: |
          cd src/agent-task-runner
          cargo test

      - name: Run Clippy (Audit Shim)
        run: |
          cd src/audit-shim
          cargo clippy -- -D warnings

      - name: Run Tests (Audit Shim)
        run: |
          cd src/audit-shim
          cargo test

  # Quick unit tests
  unit-test-bash:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Docker
        run: |
          docker --version
          docker info
      
      - name: Setup Git
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Setup build environment
        uses: ./.github/actions/setup-build-env

      - name: Install host assets
        run: sudo ./scripts/setup-local-dev.sh
      
      - name: Make test script executable
        run: chmod +x scripts/test/test-launchers.sh
      
      - name: Run launcher tests (bash)
        run: ./scripts/test/test-launchers.sh
      
      - name: Cleanup test containers
        if: always()
        run: |
          docker ps -aq --filter "label=containai.test=true" | xargs -r docker rm -f || true

  unit-test-powershell-linux:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Docker
        run: |
          docker --version
          docker info

      - name: Setup Git
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Setup build environment
        uses: ./.github/actions/setup-build-env

      - name: Install host assets
        run: sudo ./scripts/setup-local-dev.sh

      - name: Run launcher tests (PowerShell Linux)
        run: pwsh -NoLogo -File scripts/test/test-launchers.ps1

      - name: Cleanup test containers
        if: always()
        run: |
          docker ps -aq --filter "label=containai.test=true" | xargs -r docker rm -f || true

  unit-test-powershell:
    runs-on: windows-latest
    # Windows runners can't run Linux containers, so we only validate script syntax
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Validate PowerShell script syntax
        shell: pwsh
        run: |
          # Parse all PowerShell scripts to check for syntax errors
          $scripts = @(
            "scripts/test/test-launchers.ps1",
            "host/launchers/run-agent.ps1"
          )
          $hasErrors = $false
          foreach ($script in $scripts) {
            if (Test-Path $script) {
              $errors = $null
              [System.Management.Automation.Language.Parser]::ParseFile($script, [ref]$null, [ref]$errors) | Out-Null
              if ($errors.Count -gt 0) {
                Write-Error "Syntax errors in ${script}:"
                $errors | ForEach-Object { Write-Error $_.ToString() }
                $hasErrors = $true
              } else {
                Write-Host "âœ“ $script - syntax OK"
              }
            }
          }
          if ($hasErrors) { exit 1 }

  # Full integration tests (launchers mode - faster)
  integration-test-launchers:
    runs-on: ubuntu-latest
    steps:
      - name: Free up disk space
        run: |
          # Remove large preinstalled packages we don't need for building containers
          # Keep /usr/share/dotnet since we need .NET SDK for compilation
          sudo rm -rf /usr/local/lib/android /opt/ghc /opt/hostedtoolcache/CodeQL
          sudo docker image prune -af
          df -h /

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Setup Git
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Setup build environment
        uses: ./.github/actions/setup-build-env

      - name: Install host assets
        run: sudo ./scripts/setup-local-dev.sh

      - name: Make integration test executable
        run: chmod +x scripts/test/integration-test.sh scripts/test/test-env.sh
      
      - name: Run integration tests (launchers mode)
        env:
          TEST_SKIP_REGISTRY_PUSH: "true"
          TEST_ARTIFACTS_DIR: ${{ github.workspace }}/test-artifacts
        run: ./scripts/test/integration-test.sh --mode launchers
      
      - name: Upload test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-artifacts-launchers
          path: test-artifacts/
          if-no-files-found: ignore
      
      - name: Cleanup test resources
        if: always()
        run: |
          docker ps -aq --filter "label=containai.test=true" | xargs -r docker rm -f || true
          docker network ls --filter "name=test-containai" --format "{{.Name}}" | xargs -r docker network rm || true

  # Full integration tests (full mode - on main branch only)
  integration-test-full:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Free up disk space
        run: |
          # Remove large preinstalled packages we don't need for building containers
          # Keep /usr/share/dotnet since we need .NET SDK for compilation
          sudo rm -rf /usr/local/lib/android /opt/ghc /opt/hostedtoolcache/CodeQL
          sudo docker image prune -af
          df -h /

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Setup Git
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Setup build environment
        uses: ./.github/actions/setup-build-env

      - name: Install host assets
        run: sudo ./scripts/setup-local-dev.sh

      - name: Make integration test executable
        run: chmod +x scripts/test/integration-test.sh scripts/test/test-env.sh
      
      - name: Run integration tests (full mode)
        env:
          TEST_ARTIFACTS_DIR: ${{ github.workspace }}/test-artifacts
        run: ./scripts/test/integration-test.sh --mode full
      
      - name: Upload test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-artifacts-full
          path: test-artifacts/
          if-no-files-found: ignore
      
      - name: Cleanup test resources
        if: always()
        run: |
          docker ps -aq --filter "label=containai.test=true" | xargs -r docker rm -f || true
          docker network ls --filter "name=test-containai" --format "{{.Name}}" | xargs -r docker network rm || true
          docker rm -f $(docker ps -aq --filter "ancestor=registry:2") 2>/dev/null || true
