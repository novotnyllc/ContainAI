name: Create GitHub Release

on:
  push:
    branches:
      - 'rel/v*'

permissions:
  contents: write
  packages: read

jobs:
  # ============================================================================
  # Build Multi-arch Tarballs for Release
  # ============================================================================
  # Builds on ubuntu-24.04 for x64 to match supported platform baseline.
  # ============================================================================
  build-release-tarballs:
    runs-on: ${{ matrix.runner }}
    timeout-minutes: 30

    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: amd64
            runner: ubuntu-24.04
            tarball_target: linux-x64
            rid: linux-x64
          - arch: arm64
            runner: ubuntu-24.04-arm
            tarball_target: linux-arm64
            rid: linux-arm64
          - arch: macos-x64
            runner: macos-15-intel
            tarball_target: macos-x64
            rid: osx-x64
          - arch: macos-arm64
            runner: macos-26
            tarball_target: macos-arm64
            rid: osx-arm64

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up .NET
        uses: actions/setup-dotnet@v4
        with:
          global-json-file: global.json

      - name: Install and run NBGV
        id: nbgv
        run: |
          dotnet tool restore
          echo "SemVer2=$(dotnet nbgv get-version -v SemVer2)" >> "$GITHUB_OUTPUT"
          echo "NBGV_SemVer2=$(dotnet nbgv get-version -v SemVer2)" >> "$GITHUB_ENV"

      - name: Build release tarball
        run: |
          echo "============================================="
          echo "Creating tarball for ${{ matrix.tarball_target }}"
          echo "============================================="
          dotnet build ./src/cai/cai.csproj \
            -t:BuildContainAITarballs \
            -p:Configuration=Release \
            -p:ContainAIRuntimeIdentifiers="${{ matrix.rid }}" \
            -p:ContainAIVersion="$NBGV_SemVer2" \
            -p:ContainAIOutputDir=./artifacts \
            -warnaserror \
            -p:TrimmerSingleWarn=false

          ls -la ./artifacts/

      - name: Upload tarball artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-tarball-${{ matrix.arch }}
          path: ./artifacts/containai-*.tar.gz
          retention-days: 1
          if-no-files-found: error

  # ============================================================================
  # Create Release and Upload Assets
  # ============================================================================
  # Creates a GitHub Release from the rel/v* branch using NBGV version.
  # The release is created with a v-prefixed tag (e.g., v0.2.0).
  # ============================================================================
  release:
    needs: build-release-tarballs
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up .NET
        uses: actions/setup-dotnet@v4
        with:
          global-json-file: global.json

      - name: Get version from NBGV
        id: version
        run: |
          dotnet tool restore
          release_semver=$(dotnet nbgv get-version -v SemVer2)
          echo "version=$release_semver" >> "$GITHUB_OUTPUT"
          echo "tag=v$release_semver" >> "$GITHUB_OUTPUT"
          echo "Release version: $release_semver (tag: v$release_semver)"

      - name: Wait for Docker image
        id: wait_image
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          version="${{ steps.version.outputs.version }}"
          repo_name="$(printf '%s' "${GITHUB_REPOSITORY#*/}" | tr '[:upper:]' '[:lower:]')"

          echo "Waiting for Docker image with tag ${version}..."

          # Determine if owner is org or user
          owner_type=$(gh api "/repos/${GITHUB_REPOSITORY}" --jq '.owner.type' 2>/dev/null || echo "unknown")
          if [ "$owner_type" = "Organization" ]; then
            api_base="/orgs/${GITHUB_REPOSITORY_OWNER}"
          else
            api_base="/users/${GITHUB_REPOSITORY_OWNER}"
          fi

          max_attempts=60
          attempt=0

          while [ $attempt -lt $max_attempts ]; do
            # Check if the version tag exists in GHCR (with pagination)
            if gh api "${api_base}/packages/container/${repo_name}/versions" --paginate \
                --jq '.[].metadata.container.tags[]' 2>/dev/null | grep -Fxq "$version"; then
              echo "Docker image with tag ${version} is available"
              echo "found=true" >> "$GITHUB_OUTPUT"
              exit 0
            fi

            attempt=$((attempt + 1))
            echo "Attempt ${attempt}/${max_attempts}: Image not yet available, waiting 10s..."
            sleep 10
          done

          echo "::warning::Docker image not found after ${max_attempts} attempts (10 min). Continuing anyway."
          echo "found=false" >> "$GITHUB_OUTPUT"

      - name: Download amd64 tarball
        uses: actions/download-artifact@v4
        with:
          name: release-tarball-amd64
          path: ./release-assets

      - name: Download arm64 tarball
        uses: actions/download-artifact@v4
        with:
          name: release-tarball-arm64
          path: ./release-assets

      - name: Download macOS x64 tarball
        uses: actions/download-artifact@v4
        with:
          name: release-tarball-macos-x64
          path: ./release-assets

      - name: Download macOS arm64 tarball
        uses: actions/download-artifact@v4
        with:
          name: release-tarball-macos-arm64
          path: ./release-assets

      - name: Prepare install.sh for release
        run: |
          # Copy install.sh to release assets
          cp install.sh ./release-assets/install.sh
          chmod +x ./release-assets/install.sh

          # List all release assets
          echo "Release assets:"
          ls -la ./release-assets/

      - name: Check if release exists
        id: check_release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ steps.version.outputs.tag }}"
          if gh release view "$TAG" >/dev/null 2>&1; then
            echo "Release $TAG already exists"
            echo "exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Create GitHub Release
        if: steps.check_release.outputs.exists != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ steps.version.outputs.tag }}"

          gh release create "$TAG" \
            --title "ContainAI $TAG" \
            --generate-notes \
            --target "$GITHUB_SHA" \
            --latest \
            ./release-assets/*

      - name: Upload assets to existing release
        if: steps.check_release.outputs.exists == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ steps.version.outputs.tag }}"
          # Upload each asset (clobber if already exists)
          for asset in ./release-assets/*; do
            asset_name=$(basename "$asset")
            echo "Uploading: $asset_name"
            gh release upload "$TAG" "$asset" --clobber
          done
