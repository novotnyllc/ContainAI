name: Create GitHub Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write
  packages: read

jobs:
  # ============================================================================
  # Build Multi-arch Tarballs for Release
  # ============================================================================
  build-release-tarballs:
    runs-on: ${{ matrix.runner }}
    timeout-minutes: 20

    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: amd64
            runner: ubuntu-latest
            dotnet_rid: linux-x64
            tarball_arch: linux-x64
          - arch: arm64
            runner: ubuntu-24.04-arm
            dotnet_rid: linux-arm64
            tarball_arch: linux-arm64

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Verify tag exists
        run: |
          if ! git rev-parse -q --verify "refs/tags/${GITHUB_REF_NAME}" >/dev/null; then
            echo "::error::Tag ${GITHUB_REF_NAME} not found in repository"
            exit 1
          fi

      - name: Set up .NET
        uses: actions/setup-dotnet@v4
        with:
          global-json-file: global.json

      - name: Install and run NBGV
        id: nbgv
        run: |
          dotnet tool restore
          echo "SemVer2=$(dotnet nbgv get-version -v SemVer2)" >> "$GITHUB_OUTPUT"
          echo "NBGV_SemVer2=$(dotnet nbgv get-version -v SemVer2)" >> "$GITHUB_ENV"

      - name: Build AOT binary
        run: |
          echo "============================================="
          echo "Building acp-proxy for ${{ matrix.dotnet_rid }}"
          echo "============================================="
          dotnet publish src/acp-proxy \
            -r ${{ matrix.dotnet_rid }} \
            -c Release \
            --self-contained \
            -o src/acp-proxy/publish/${{ matrix.dotnet_rid }}

          ls -la src/acp-proxy/publish/${{ matrix.dotnet_rid }}/
          file src/acp-proxy/publish/${{ matrix.dotnet_rid }}/acp-proxy

      - name: Create release tarball
        run: |
          echo "============================================="
          echo "Creating tarball for ${{ matrix.tarball_arch }}"
          echo "============================================="
          ./scripts/package-release.sh \
            --arch ${{ matrix.tarball_arch }} \
            --version "$NBGV_SemVer2" \
            --output-dir ./artifacts

          ls -la ./artifacts/

      - name: Upload tarball artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-tarball-${{ matrix.arch }}
          path: ./artifacts/containai-*.tar.gz
          retention-days: 1
          if-no-files-found: error

  # ============================================================================
  # Create Release and Upload Assets
  # ============================================================================
  release:
    needs: build-release-tarballs
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Verify tag exists
        run: |
          if ! git rev-parse -q --verify "refs/tags/${GITHUB_REF_NAME}" >/dev/null; then
            echo "::error::Tag ${GITHUB_REF_NAME} not found in repository"
            exit 1
          fi

      - name: Wait for Docker image
        id: wait_image
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Extract version from tag (strip leading 'v')
          version="${GITHUB_REF_NAME#v}"
          repo_name="$(printf '%s' "${GITHUB_REPOSITORY#*/}" | tr '[:upper:]' '[:lower:]')"

          echo "Waiting for Docker image with tag ${version}..."

          # Determine if owner is org or user
          owner_type=$(gh api "/repos/${GITHUB_REPOSITORY}" --jq '.owner.type' 2>/dev/null || echo "unknown")
          if [ "$owner_type" = "Organization" ]; then
            api_base="/orgs/${GITHUB_REPOSITORY_OWNER}"
          else
            api_base="/users/${GITHUB_REPOSITORY_OWNER}"
          fi

          max_attempts=60
          attempt=0

          while [ $attempt -lt $max_attempts ]; do
            # Check if the version tag exists in GHCR (with pagination)
            if gh api "${api_base}/packages/container/${repo_name}/versions" --paginate \
                --jq '.[].metadata.container.tags[]' 2>/dev/null | grep -Fxq "$version"; then
              echo "Docker image with tag ${version} is available"
              echo "found=true" >> "$GITHUB_OUTPUT"
              exit 0
            fi

            attempt=$((attempt + 1))
            echo "Attempt ${attempt}/${max_attempts}: Image not yet available, waiting 10s..."
            sleep 10
          done

          echo "::error::Docker image not found after ${max_attempts} attempts (10 min)."
          echo "found=false" >> "$GITHUB_OUTPUT"
          exit 1

      - name: Download amd64 tarball
        uses: actions/download-artifact@v4
        with:
          name: release-tarball-amd64
          path: ./release-assets

      - name: Download arm64 tarball
        uses: actions/download-artifact@v4
        with:
          name: release-tarball-arm64
          path: ./release-assets

      - name: Prepare install.sh for release
        run: |
          # Copy install.sh to release assets
          cp install.sh ./release-assets/install.sh
          chmod +x ./release-assets/install.sh

          # List all release assets
          echo "Release assets:"
          ls -la ./release-assets/

      - name: Check if release exists
        id: check_release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if gh release view "$GITHUB_REF_NAME" >/dev/null 2>&1; then
            echo "Release $GITHUB_REF_NAME already exists"
            echo "exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Create GitHub Release
        if: steps.check_release.outputs.exists != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create "$GITHUB_REF_NAME" \
            --title "ContainAI ${GITHUB_REF_NAME}" \
            --generate-notes \
            --verify-tag \
            --latest \
            ./release-assets/*

      - name: Upload assets to existing release
        if: steps.check_release.outputs.exists == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Upload each asset (skip if already exists)
          for asset in ./release-assets/*; do
            asset_name=$(basename "$asset")
            echo "Uploading: $asset_name"
            gh release upload "$GITHUB_REF_NAME" "$asset" --clobber || true
          done
