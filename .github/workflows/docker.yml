name: Build and Push Docker Image

on:
  workflow_dispatch:
  push:
    branches:
      - main
    tags:
      - 'v*'
  pull_request:
    branches:
      - main
  schedule:
    - cron: '0 2 * * *'  # 2am UTC daily for nightly builds

concurrency:
  group: docker-${{ github.ref }}
  cancel-in-progress: true

env:
  REGISTRY: ghcr.io

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install shellcheck
        run: sudo apt-get update && sudo apt-get install -y shellcheck

      - name: Lint shell scripts with shellcheck
        run: |
          echo "Running shellcheck on shell scripts..."
          shellcheck -x src/*.sh src/lib/*.sh

      - name: Check manifest consistency
        run: ./scripts/check-manifest-consistency.sh

  build-push:
    needs: [lint, build-tarballs]
    if: github.event_name != 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Convert repository name to lowercase
        run: |
          echo "IMAGE_NAME=${GITHUB_REPOSITORY,,}" >> $GITHUB_ENV

      - name: Set version from build-tarballs
        run: |
          echo "NBGV_SemVer2=${{ needs.build-tarballs.outputs.version }}" >> "$GITHUB_ENV"

      - name: Download Linux amd64 tarball
        uses: actions/download-artifact@v4
        with:
          name: containai-tarball-amd64
          path: /tmp/tarball-amd64

      - name: Download Linux arm64 tarball
        uses: actions/download-artifact@v4
        with:
          name: containai-tarball-arm64
          path: /tmp/tarball-arm64

      - name: Stage ContainAI CLI tarballs
        run: |
          mkdir -p artifacts/cai-tarballs
          cp /tmp/tarball-amd64/containai-*.tar.gz artifacts/cai-tarballs/
          cp /tmp/tarball-arm64/containai-*.tar.gz artifacts/cai-tarballs/

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64,amd64

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Get build date
        id: date
        run: echo "value=$(date +%Y%m%d)" >> $GITHUB_OUTPUT

      - name: Determine build strategy
        id: build_strategy
        run: |
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "platforms=linux/amd64" >> $GITHUB_OUTPUT
            echo "push=false" >> $GITHUB_OUTPUT
            echo "load=true" >> $GITHUB_OUTPUT
            echo "image_prefix=containai" >> $GITHUB_OUTPUT
            echo "tag_suffix=pr-${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          else
            echo "platforms=linux/amd64,linux/arm64" >> $GITHUB_OUTPUT
            echo "push=true" >> $GITHUB_OUTPUT
            echo "load=false" >> $GITHUB_OUTPUT
            echo "image_prefix=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}" >> $GITHUB_OUTPUT
            # tag_suffix for layer images: latest for tags, nightly for main/schedule
            if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
              echo "tag_suffix=latest" >> $GITHUB_OUTPUT
            else
              # Main branch push OR scheduled run
              echo "tag_suffix=nightly" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Build and push base image
        if: github.event_name != 'pull_request'
        uses: docker/build-push-action@v6
        with:
          context: .
          file: src/container/Dockerfile.base
          platforms: ${{ steps.build_strategy.outputs.platforms }}
          push: ${{ steps.build_strategy.outputs.push }}
          load: ${{ steps.build_strategy.outputs.load }}
          tags: ${{ steps.build_strategy.outputs.image_prefix }}/base:${{ steps.build_strategy.outputs.tag_suffix }}
          build-args: |
            BUILD_DATE=${{ github.run_started_at }}
            VCS_REF=${{ github.sha }}
            VERSION=${{ env.NBGV_SemVer2 }}
          cache-from: type=gha,scope=base
          cache-to: type=gha,mode=max,scope=base

      - name: Build and push sdks image
        if: github.event_name != 'pull_request'
        uses: docker/build-push-action@v6
        with:
          context: .
          file: src/container/Dockerfile.sdks
          platforms: ${{ steps.build_strategy.outputs.platforms }}
          push: ${{ steps.build_strategy.outputs.push }}
          load: ${{ steps.build_strategy.outputs.load }}
          tags: ${{ steps.build_strategy.outputs.image_prefix }}/sdks:${{ steps.build_strategy.outputs.tag_suffix }}
          build-args: |
            BASE_IMAGE=${{ steps.build_strategy.outputs.image_prefix }}/base:${{ steps.build_strategy.outputs.tag_suffix }}
            BUILD_DATE=${{ github.run_started_at }}
            VCS_REF=${{ github.sha }}
            VERSION=${{ env.NBGV_SemVer2 }}
          cache-from: type=gha,scope=sdks
          cache-to: type=gha,mode=max,scope=sdks

      - name: Generate container files
        if: github.event_name != 'pull_request'
        run: |
          mkdir -p artifacts/container-generated
          ./src/scripts/gen-dockerfile-symlinks.sh src/manifests artifacts/container-generated/symlinks.sh
          ./src/scripts/gen-init-dirs.sh src/manifests artifacts/container-generated/init-dirs.sh
          ./src/scripts/gen-container-link-spec.sh src/manifests artifacts/container-generated/link-spec.json
          ./src/scripts/gen-agent-wrappers.sh src/manifests artifacts/container-generated/agent-wrappers.sh
          cp src/container/link-repair.sh artifacts/container-generated/link-repair.sh

      - name: Build and push full image
        if: github.event_name != 'pull_request'
        uses: docker/build-push-action@v6
        with:
          context: .
          file: src/container/Dockerfile.agents
          platforms: ${{ steps.build_strategy.outputs.platforms }}
          push: ${{ steps.build_strategy.outputs.push }}
          load: ${{ steps.build_strategy.outputs.load }}
          tags: ${{ steps.build_strategy.outputs.image_prefix }}/agents:${{ steps.build_strategy.outputs.tag_suffix }}
          build-args: |
            SDKS_IMAGE=${{ steps.build_strategy.outputs.image_prefix }}/sdks:${{ steps.build_strategy.outputs.tag_suffix }}
            BUILD_DATE=${{ github.run_started_at }}
            VCS_REF=${{ github.sha }}
            VERSION=${{ env.NBGV_SemVer2 }}
          cache-from: type=gha,scope=full-v2
          cache-to: type=gha,mode=max,scope=full-v2

      - name: Extract metadata (tags, labels)
        id: meta
        if: github.event_name != 'pull_request'
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            # latest ONLY for tagged releases
            type=raw,value=latest,enable=${{ startsWith(github.ref, 'refs/tags/v') }}
            # Semver for tags only
            type=semver,pattern={{version}},enable=${{ startsWith(github.ref, 'refs/tags/v') }}
            type=semver,pattern={{major}}.{{minor}},enable=${{ startsWith(github.ref, 'refs/tags/v') }}
            type=semver,pattern={{major}},enable=${{ startsWith(github.ref, 'refs/tags/v') && !startsWith(github.ref, 'refs/tags/v0.') }}
            # Nightly for main branch and schedule
            type=raw,value=nightly,enable=${{ github.ref == 'refs/heads/main' || github.event_name == 'schedule' }}
            type=raw,value=nightly-${{ steps.date.outputs.value }},enable=${{ github.ref == 'refs/heads/main' || github.event_name == 'schedule' }}
            # SHA for all builds
            type=sha,prefix=sha-

      - name: Build and push Docker image
        if: github.event_name != 'pull_request'
        uses: docker/build-push-action@v6
        with:
          context: .
          file: src/container/Dockerfile
          platforms: ${{ steps.build_strategy.outputs.platforms }}
          push: ${{ steps.build_strategy.outputs.push }}
          load: ${{ steps.build_strategy.outputs.load }}
          tags: ${{ steps.meta.outputs.tags }}
          build-args: |
            AGENTS_IMAGE=${{ steps.build_strategy.outputs.image_prefix }}/agents:${{ steps.build_strategy.outputs.tag_suffix }}
            BUILD_DATE=${{ github.run_started_at }}
            VCS_REF=${{ github.sha }}
            VERSION=${{ env.NBGV_SemVer2 }}
          cache-from: type=gha,scope=main
          cache-to: type=gha,mode=max,scope=main

  # ============================================================================
  # Build Test Images (per-arch) - shared across test jobs
  # ============================================================================
  build-images:
    needs: [lint, build-tarballs]
    runs-on: ${{ matrix.runner }}
    timeout-minutes: 30

    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: amd64
            runner: ubuntu-24.04
            platform: linux/amd64
          - arch: arm64
            runner: ubuntu-24.04-arm
            platform: linux/arm64

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set version from build-tarballs
        run: |
          echo "NBGV_SemVer2=${{ needs.build-tarballs.outputs.version }}" >> "$GITHUB_ENV"

      - name: Download CLI tarball (${{ matrix.arch }})
        uses: actions/download-artifact@v4
        with:
          name: containai-tarball-${{ matrix.arch }}
          path: /tmp/tarball

      - name: Stage ContainAI CLI tarball
        run: |
          mkdir -p artifacts/cai-tarballs
          cp /tmp/tarball/containai-*.tar.gz artifacts/cai-tarballs/

      - name: Build test images (${{ matrix.arch }})
        run: |
          echo "Building containai images for ${{ matrix.arch }}..."
          ./src/build.sh \
            --image-prefix containai \
            --version "$NBGV_SemVer2"

      - name: Save images to artifact
        run: |
          mkdir -p artifacts
          docker save \
            containai:latest \
            containai/base:latest \
            containai/sdks:latest \
            containai/agents:latest \
            -o artifacts/containai-images-${{ matrix.arch }}.tar
          gzip -f artifacts/containai-images-${{ matrix.arch }}.tar

      - name: Upload image artifact
        uses: actions/upload-artifact@v4
        with:
          name: containai-images-${{ matrix.arch }}
          path: artifacts/containai-images-${{ matrix.arch }}.tar.gz
          retention-days: 7
          if-no-files-found: error

  # ============================================================================
  # Build Multi-arch Tarballs
  # ============================================================================
  # Builds AOT .NET binaries for each architecture and creates release tarballs.
  # PR builds upload tarballs as artifacts for E2E testing.
  # Release builds are handled by the release workflow.
  # ============================================================================
  build-tarballs:
    needs: lint
    runs-on: ${{ matrix.runner }}
    timeout-minutes: 30
    outputs:
      version: ${{ steps.nbgv.outputs.SemVer2 }}

    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: amd64
            runner: ubuntu-24.04
            tarball_target: linux-x64
          - arch: arm64
            runner: ubuntu-24.04-arm
            tarball_target: linux-arm64
          - arch: macos-x64
            runner: macos-15-intel
            tarball_target: macos-x64
          - arch: macos-arm64
            runner: macos-26
            tarball_target: macos-arm64

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up .NET
        uses: actions/setup-dotnet@v4
        with:
          global-json-file: global.json

      - name: Install build dependencies
        run: ./scripts/install-build-dependencies.sh -y

      - name: Install and run NBGV
        id: nbgv
        run: |
          dotnet tool restore
          echo "SemVer2=$(dotnet nbgv get-version -v SemVer2)" >> "$GITHUB_OUTPUT"
          echo "NBGV_SemVer2=$(dotnet nbgv get-version -v SemVer2)" >> "$GITHUB_ENV"

      - name: Build release tarball
        run: |
          echo "============================================="
          echo "Creating tarball for ${{ matrix.tarball_target }}"
          echo "============================================="
          case "${{ matrix.tarball_target }}" in
            linux-x64) platform="linux/amd64" ;;
            linux-arm64) platform="linux/arm64" ;;
            macos-x64) platform="macos/amd64" ;;
            macos-arm64) platform="macos/arm64" ;;
            *) echo "ERROR: Unknown tarball target: ${{ matrix.tarball_target }}" >&2; exit 1 ;;
          esac
          if [[ "$(uname -s)" == "Darwin" ]]; then
            bash_cmd="$(brew --prefix)/bin/bash"
          else
            bash_cmd="bash"
          fi
          "$bash_cmd" ./src/scripts/build-cai-tarballs.sh \
            --platforms "$platform" \
            --version "$NBGV_SemVer2" \
            --output-dir ./artifacts

          ls -la ./artifacts/

      - name: Upload tarball artifact
        uses: actions/upload-artifact@v4
        with:
          name: containai-tarball-${{ matrix.arch }}
          path: ./artifacts/containai-*.tar.gz
          retention-days: 7
          if-no-files-found: error

  # ============================================================================
  # Import Tests
  # ============================================================================
  # Tiered test strategy:
  # - Host-side tests (manifest parsing, consistency) run in lint job above
  # - Integration tests run here after build, using the built image
  # - Full E2E tests (sysbox/systemd containers) require self-hosted runners
  #   with sysbox installed - see docs/testing.md for manual E2E testing
  #
  # Test execution on PRs:
  # - Depends on build-images job (per-arch)
  # - Uses image artifacts produced earlier (no local rebuild)
  # - Runs full test suite (standard Docker runtime, no sysbox required)
  #
  # Note: Image artifacts are produced in build-images and shared across jobs.
  # ============================================================================
  test:
    needs: build-images
    runs-on: ${{ matrix.runner }}
    timeout-minutes: 30

    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: amd64
            runner: ubuntu-24.04
            dotnet_rid: linux-x64
          - arch: arm64
            runner: ubuntu-24.04-arm
            dotnet_rid: linux-arm64

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up .NET
        uses: actions/setup-dotnet@v4
        with:
          global-json-file: global.json

      - name: Download image artifact (${{ matrix.arch }})
        uses: actions/download-artifact@v4
        with:
          name: containai-images-${{ matrix.arch }}
          path: /tmp/containai-images

      - name: Load test images
        run: |
          gunzip -c /tmp/containai-images/containai-images-${{ matrix.arch }}.tar.gz | docker load
          echo "Loaded images:"
          docker images

      - name: Run import integration tests
        run: |
          echo "============================================="
          echo "Running import integration tests (${{ matrix.arch }})"
          echo "============================================="
          export IMAGE_NAME="containai:latest"
          ./tests/integration/test-sync-integration.sh

      - name: Run manifest parsing unit tests
        run: |
          echo "============================================="
          echo "Running manifest parsing unit tests"
          echo "============================================="
          ./tests/unit/test-manifest-parsing.sh

      - name: Run launch wrapper tests
        run: |
          echo "============================================="
          echo "Running launch wrapper tests (${{ matrix.arch }})"
          echo "============================================="
          export IMAGE_NAME="containai:latest"
          ./tests/integration/test-launch-wrappers.sh

      - name: Run user manifest tests
        run: |
          echo "============================================="
          echo "Running user manifest tests (${{ matrix.arch }})"
          echo "============================================="
          export IMAGE_NAME="containai:latest"
          ./tests/integration/test-user-manifests.sh

      - name: Run .NET unit tests (if test projects exist)
        run: |
          echo "============================================="
          echo "Running .NET unit tests (${{ matrix.arch }})"
          echo "============================================="
          if find . -name '*Tests*.csproj' -o -name '*.Tests.csproj' | grep -q .; then
            dotnet test --configuration Release
          else
            echo "No test projects found, skipping dotnet test"
          fi

      - name: Build ACP Proxy (${{ matrix.arch }})
        run: |
          echo "============================================="
          echo "Building ACP proxy binary (${{ matrix.arch }})"
          echo "============================================="
          cd src/acp-proxy
          dotnet publish -r ${{ matrix.dotnet_rid }} -c Release --self-contained -o publish
          mkdir -p ../bin
          cp publish/acp-proxy ../bin/acp-proxy
          chmod +x ../bin/acp-proxy

      - name: Run ACP integration tests
        env:
          CAI_ACP_TEST_MODE: "1"
          CAI_ACP_DIRECT_SPAWN: "1"
        run: |
          echo "============================================="
          echo "Running ACP proxy integration tests (${{ matrix.arch }})"
          echo "============================================="
          chmod +x ./tests/integration/mock-acp-server
          ./tests/integration/test-acp-proxy.sh

      - name: Upload test logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-logs-${{ matrix.arch }}-${{ github.run_id }}
          path: |
            ~/.containai-test-*
          retention-days: 7
          if-no-files-found: ignore

  # ============================================================================
  # E2E Tests (Sysbox/DinD) - GitHub-hosted runners
  # ============================================================================
  # Attempts to run E2E tests on GitHub-hosted runners. Sysbox requires kernel
  # module loading which may not work due to virtualization constraints.
  # This job gracefully skips if sysbox installation fails.
  #
  # Install flow: Downloads tarball artifact from build-tarballs job, tests
  # install.sh --local --yes --no-setup to verify the tarball install path works.
  # ============================================================================
  e2e-test:
    needs: [build-images, build-tarballs]
    runs-on: ${{ matrix.runner }}
    timeout-minutes: 30

    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: amd64
            runner: ubuntu-24.04
          - arch: arm64
            runner: ubuntu-24.04-arm

    steps:
      # Always checkout repository - needed for build.sh and test scripts
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download tarball artifact
        uses: actions/download-artifact@v4
        with:
          name: containai-tarball-${{ matrix.arch }}
          path: /tmp/tarball

      - name: Extract and install from tarball
        run: |
          echo "============================================="
          echo "Installing from tarball artifact"
          echo "============================================="
          cd /tmp/tarball
          tar xzf containai-*.tar.gz
          cd containai-*/
          ./install.sh --local --yes --no-setup

      - name: Run cai setup
        env:
          CAI_YES: "1"
        run: |
          echo "============================================="
          echo "Running cai setup"
          echo "============================================="
          export PATH="$HOME/.local/bin:$PATH"
          cai setup --verbose

      - name: Smoke test acp-proxy binary
        run: |
          ACP_PROXY="$HOME/.local/share/containai/acp-proxy"
          if [[ -f "$ACP_PROXY" ]]; then
            echo "Testing acp-proxy binary..."
            if "$ACP_PROXY" --help >/dev/null 2>&1; then
              echo "acp-proxy binary works"
            else
              echo "::error::acp-proxy binary failed to run (may be glibc incompatibility)"
              exit 1
            fi
          else
            echo "::error::acp-proxy binary not found at $ACP_PROXY"
            exit 1
          fi

      - name: Check kernel version
        id: kernel
        run: |
          echo "============================================="
          echo "Kernel Information"
          echo "============================================="
          uname -a
          echo "KERNEL_VERSION=$(uname -r)" >> "$GITHUB_OUTPUT"

      - name: Download image artifact
        uses: actions/download-artifact@v4
        with:
          name: containai-images-${{ matrix.arch }}
          path: /tmp/containai-images

      - name: Load test images into containai-docker
        run: |
          gunzip -c /tmp/containai-images/containai-images-${{ matrix.arch }}.tar.gz | docker --context containai-docker load
          echo "Loaded images:"
          docker --context containai-docker images

      - name: Run E2E tests (DinD)
        env:
          CONTAINAI_TEST_IMAGE: containai/base:latest
        run: |
          echo "============================================="
          echo "Running Docker-in-Docker E2E tests"
          echo "============================================="
          ./tests/integration/test-dind.sh

      - name: Run startup hooks tests (Sysbox)
        env:
          CONTAINAI_TEST_IMAGE: containai/base:latest
        run: |
          echo "============================================="
          echo "Running startup hooks tests (requires Sysbox)"
          echo "============================================="
          ./tests/integration/test-startup-hooks.sh

      - name: Collect sysbox logs
        if: failure()
        run: |
          mkdir -p /tmp/sysbox-logs
          journalctl -u sysbox-mgr --no-pager > /tmp/sysbox-logs/sysbox-mgr.log 2>&1 || true
          journalctl -u sysbox-fs --no-pager > /tmp/sysbox-logs/sysbox-fs.log 2>&1 || true
          sudo cp -r /var/log/sysbox/ /tmp/sysbox-logs/ 2>/dev/null || true

      - name: Upload E2E test logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-logs-${{ matrix.arch }}-${{ github.run_id }}
          path: |
            ~/.containai-test-*
            /tmp/sysbox-logs/
          retention-days: 7
          if-no-files-found: ignore

  # ============================================================================
  # E2E Tests (macOS + Lima)
  # ============================================================================
  e2e-test-macos:
    needs: [lint, build-images, build-tarballs]
    runs-on: ${{ matrix.runner }}
    timeout-minutes: 60

    strategy:
      fail-fast: false
      matrix:
        include:
          - runner: macos-15-intel
            image_arch: amd64
            tarball_arch: macos-x64
            expected_uname: x86_64
          - runner: macos-26
            image_arch: arm64
            tarball_arch: macos-arm64
            expected_uname: arm64

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Verify runner architecture
        run: |
          machine="$(uname -m)"
          expected="${{ matrix.expected_uname }}"
          if [[ "$machine" != "$expected" ]]; then
            echo "::error::Runner arch mismatch. Expected $expected, got $machine"
            exit 1
          fi
          echo "IMAGE_ARCH=${{ matrix.image_arch }}" >> "$GITHUB_ENV"
          echo "TARBALL_ARCH=${{ matrix.tarball_arch }}" >> "$GITHUB_ENV"

      - name: Download tarball artifact
        uses: actions/download-artifact@v4
        with:
          name: containai-tarball-${{ env.TARBALL_ARCH }}
          path: /tmp/tarball

      - name: Extract and install from tarball
        run: |
          echo "============================================="
          echo "Installing from tarball artifact"
          echo "============================================="
          cd /tmp/tarball
          tar xzf containai-*.tar.gz
          cd containai-*/
          ./install.sh --local --yes --no-setup

      - name: Run cai setup (Lima + Sysbox)
        env:
          CAI_YES: "1"
        run: |
          echo "============================================="
          echo "Running cai setup"
          echo "============================================="
          export PATH="$HOME/.local/bin:$PATH"
          cai setup --verbose

      - name: Download image artifact
        uses: actions/download-artifact@v4
        with:
          name: containai-images-${{ env.IMAGE_ARCH }}
          path: /tmp/containai-images

      - name: Load images into Lima
        run: |
          gunzip -c /tmp/containai-images/containai-images-${IMAGE_ARCH}.tar.gz | docker --context containai-docker load
          docker --context containai-docker images | grep -E '^(containai|REPOSITORY)' || true

      - name: Run Secure Engine E2E tests (macOS)
        env:
          CONTAINAI_TEST_IMAGE: containai/base:latest
        run: |
          BASH_BIN="$(brew --prefix bash)/bin/bash"
          "$BASH_BIN" -lc './tests/integration/test-secure-engine.sh'
          "$BASH_BIN" -lc './tests/integration/test-dind.sh'
          "$BASH_BIN" -lc './tests/integration/test-dind-runc133.sh'
          "$BASH_BIN" -lc './tests/integration/test-network-blocking.sh'

  # ============================================================================
  # E2E Tests (Sysbox/DinD) - Self-hosted runners
  # ============================================================================
  # Runs E2E tests on self-hosted runners with sysbox pre-installed.
  # These runners provide reliable sysbox support without installation issues.
  #
  # Self-hosted runner requirements:
  # - Ubuntu with kernel 5.5+
  # - Sysbox pre-installed: https://github.com/nestybox/sysbox
  # - Docker configured with sysbox runtime
  # - Runner labels: self-hosted, linux, sysbox, <arch>
  #
  # This job only runs on the main repo (not forks) to avoid indefinite queuing
  # when no self-hosted runners are available. Forks can set the repo variable
  # ENABLE_SELF_HOSTED_E2E=true if they have configured self-hosted runners.
  #
  # Install flow: Downloads tarball artifact from build-tarballs job, tests
  # install.sh --local --yes --no-setup to verify the tarball install path works.
  # ============================================================================
  e2e-test-selfhosted:
    needs: [build-tarballs, build-images]
    # Only run on main repo or when explicitly enabled via repo variable
    # This prevents forks from hanging indefinitely waiting for self-hosted runners
    if: github.repository == 'novotnyllc/containai' || vars.ENABLE_SELF_HOSTED_E2E == 'true'
    runs-on: [self-hosted, linux, sysbox, '${{ matrix.arch }}']
    timeout-minutes: 30

    strategy:
      fail-fast: false
      matrix:
        arch: [amd64, arm64]

    steps:
      # Always checkout repository - needed for build.sh and test scripts
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Try to download tarball artifact (from Task 5's PR artifact upload)
      # This tests the install path; repo checkout above provides build/test scripts
      - name: Download tarball artifact
        uses: actions/download-artifact@v4
        with:
          name: containai-tarball-${{ matrix.arch }}
          path: /tmp/tarball

      - name: Extract and install from tarball
        run: |
          echo "============================================="
          echo "Installing from tarball artifact"
          echo "============================================="
          cd /tmp/tarball
          tar xzf containai-*.tar.gz
          cd containai-*/
          ./install.sh --local --yes --no-setup

      - name: Run cai setup
        env:
          CAI_YES: "1"
        run: |
          echo "============================================="
          echo "Running cai setup"
          echo "============================================="
          export PATH="$HOME/.local/bin:$PATH"
          cai setup --verbose

      - name: Smoke test acp-proxy binary
        run: |
          ACP_PROXY="$HOME/.local/share/containai/acp-proxy"
          if [[ -f "$ACP_PROXY" ]]; then
            echo "Testing acp-proxy binary..."
            if "$ACP_PROXY" --help >/dev/null 2>&1; then
              echo "acp-proxy binary works"
            else
              echo "::error::acp-proxy binary failed to run (may be glibc incompatibility)"
              exit 1
            fi
          else
            echo "::error::acp-proxy binary not found at $ACP_PROXY"
            exit 1
          fi

      - name: Download image artifact
        uses: actions/download-artifact@v4
        with:
          name: containai-images-${{ matrix.arch }}
          path: /tmp/containai-images

      - name: Load test images into containai-docker
        run: |
          gunzip -c /tmp/containai-images/containai-images-${{ matrix.arch }}.tar.gz | docker --context containai-docker load
          echo "Loaded images:"
          docker --context containai-docker images

      - name: Run E2E tests (DinD)
        env:
          CONTAINAI_TEST_IMAGE: containai/base:latest
        run: |
          echo "============================================="
          echo "Running Docker-in-Docker E2E tests (${{ matrix.arch }})"
          echo "============================================="
          ./tests/integration/test-dind.sh

      - name: Run startup hooks tests (Sysbox)
        env:
          CONTAINAI_TEST_IMAGE: containai/base:latest
        run: |
          echo "============================================="
          echo "Running startup hooks tests (${{ matrix.arch }})"
          echo "============================================="
          ./tests/integration/test-startup-hooks.sh

      - name: Collect logs on failure
        if: failure()
        run: |
          mkdir -p /tmp/sysbox-logs
          journalctl -u sysbox-mgr --no-pager -n 100 > /tmp/sysbox-logs/sysbox-mgr.log 2>&1 || true
          journalctl -u sysbox-fs --no-pager -n 100 > /tmp/sysbox-logs/sysbox-fs.log 2>&1 || true

      - name: Upload E2E test logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-logs-selfhosted-${{ matrix.arch }}-${{ github.run_id }}
          path: |
            ~/.containai-test-*
            /tmp/sysbox-logs/
          retention-days: 7
          if-no-files-found: ignore
