# ==============================================================================
# ContainAI Sysbox Build Workflow
# ==============================================================================
# Builds sysbox-ce deb packages from master branch with the openat2 fix for
# runc 1.3.3+ compatibility. Publishes to GitHub releases.
#
# Triggers:
#   - Manual dispatch (workflow_dispatch)
#   - Tag push matching 'sysbox-v*' pattern
#
# The built packages are published to GitHub releases with:
#   - DEB packages for amd64 and arm64
#   - SHA256 checksums for verification
#   - Release notes documenting the build
# ==============================================================================

name: Build Sysbox

on:
  workflow_dispatch:
    inputs:
      version_suffix:
        description: 'Version suffix (default: +containai.YYYYMMDD)'
        required: false
        type: string
      create_release:
        description: 'Create GitHub release'
        required: false
        type: boolean
        default: true

  push:
    tags:
      - 'sysbox-v*'

env:
  # Sysbox repository to build from
  SYSBOX_REPO: https://github.com/nestybox/sysbox.git
  SYSBOX_BRANCH: master

jobs:
  build:
    name: Build ${{ matrix.arch }}
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        arch: [amd64, arm64]

    steps:
      - name: Checkout ContainAI
        uses: actions/checkout@v4

      - name: Set up QEMU for cross-arch builds
        if: matrix.arch == 'arm64'
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - name: Set up build environment
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Determine version suffix
        id: version
        env:
          INPUT_SUFFIX: ${{ inputs.version_suffix }}
        run: |
          if [[ -n "$INPUT_SUFFIX" ]]; then
            suffix="$INPUT_SUFFIX"
          else
            suffix="+containai.$(date +%Y%m%d)"
          fi
          printf 'suffix=%s\n' "$suffix" >> "$GITHUB_OUTPUT"
          echo "Version suffix: $suffix"

      - name: Clone sysbox repository
        run: |
          echo "Cloning sysbox from ${{ env.SYSBOX_BRANCH }} branch..."
          git clone --recursive --depth 1 --branch ${{ env.SYSBOX_BRANCH }} \
            ${{ env.SYSBOX_REPO }} sysbox

      - name: Get sysbox version
        id: sysbox_version
        run: |
          version=$(cat sysbox/VERSION | tr -d '[:space:]')
          full_version="${version}${{ steps.version.outputs.suffix }}"
          echo "base_version=$version" >> $GITHUB_OUTPUT
          echo "full_version=$full_version" >> $GITHUB_OUTPUT
          echo "Sysbox base version: $version"
          echo "Full version: $full_version"

      - name: Verify openat2 fix is present
        run: |
          echo "Checking for openat2 fix in sysbox-fs..."
          # The fix was introduced in commit 1302a6f - verify it's an ancestor
          # Need to fetch enough history to check ancestry
          cd sysbox/sysbox-fs
          git fetch --unshallow 2>/dev/null || git fetch --depth=100 origin master 2>/dev/null || true

          FIX_COMMIT="1302a6f"
          if git merge-base --is-ancestor "$FIX_COMMIT" HEAD 2>/dev/null; then
            echo "openat2 fix verified: commit $FIX_COMMIT is ancestor of HEAD"
          else
            # Fallback: check for the specific syscall handler file that implements the fix
            if [[ -f "handler/implementations/openat2.go" ]]; then
              echo "openat2 fix verified: handler/implementations/openat2.go exists"
            else
              echo "::error::openat2 fix NOT found in sysbox-fs"
              echo "Could not verify commit $FIX_COMMIT ancestry or find openat2.go handler"
              echo "The whole purpose of this build is to include the openat2 fix."
              exit 1
            fi
          fi

      - name: Patch version
        run: |
          echo "${{ steps.sysbox_version.outputs.full_version }}" > sysbox/VERSION
          echo "Patched VERSION file:"
          cat sysbox/VERSION

      - name: Set up sysbox-pkgr
        run: |
          cd sysbox/sysbox-pkgr
          mkdir -p sources
          ln -sfn "$(pwd)/../" sources/sysbox

      - name: Build sysbox-ce deb package
        run: |
          set -o pipefail
          cd sysbox/sysbox-pkgr
          export EDITION=ce
          # Set target architecture for cross-compilation
          export TARGET_ARCH=${{ matrix.arch }}

          echo "Building sysbox-ce deb package for ${{ matrix.arch }}..."
          echo "Target architecture: $TARGET_ARCH"
          echo "This may take 15-30 minutes..."

          make -C deb generic EDITION=ce TARGET_ARCH=${{ matrix.arch }} 2>&1 | tee build.log

          echo "Build completed"

      - name: Locate built package
        id: package
        run: |
          deb_path=$(find sysbox/sysbox-pkgr/deb/build -name "sysbox-ce*.deb" -type f | head -1)
          if [[ -z "$deb_path" ]]; then
            echo "::error::Built deb package not found"
            find sysbox/sysbox-pkgr/deb/build -type f || true
            exit 1
          fi
          echo "Found package: $deb_path"
          echo "path=$deb_path" >> $GITHUB_OUTPUT

      - name: Prepare artifacts
        id: artifacts
        run: |
          mkdir -p dist

          version="${{ steps.sysbox_version.outputs.full_version }}"
          arch="${{ matrix.arch }}"
          final_name="sysbox-ce_${version}.linux_${arch}.deb"

          cp "${{ steps.package.outputs.path }}" "dist/${final_name}"

          cd dist
          sha256sum "${final_name}" > "${final_name}.sha256"

          echo "Artifacts:"
          ls -la
          echo ""
          echo "SHA256:"
          cat "${final_name}.sha256"

          echo "deb_name=${final_name}" >> $GITHUB_OUTPUT
          echo "checksum_name=${final_name}.sha256" >> $GITHUB_OUTPUT

      - name: Upload deb artifact
        uses: actions/upload-artifact@v4
        with:
          name: sysbox-ce-${{ matrix.arch }}
          path: |
            dist/*.deb
            dist/*.sha256
          retention-days: 30

  # ============================================================================
  # Test Jobs - Verify built packages work before release
  # ============================================================================
  test-amd64:
    name: Test amd64
    needs: build
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Download amd64 artifact
        uses: actions/download-artifact@v4
        with:
          name: sysbox-ce-amd64
          path: dist

      - name: Install sysbox deb
        run: |
          echo "Installing sysbox deb package..."
          ls -la dist/*.deb
          sudo apt-get update
          sudo DEBIAN_FRONTEND=noninteractive dpkg -i dist/sysbox-ce*.deb || true
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -f -y

      - name: Verify sysbox services
        run: |
          echo "Waiting for sysbox services to start..."
          # Wait up to 30s for services to become active
          for i in {1..15}; do
            if systemctl is-active --quiet sysbox-mgr && systemctl is-active --quiet sysbox-fs; then
              echo "Sysbox services are active"
              break
            fi
            echo "Waiting for services... ($i/15)"
            sleep 2
          done

          # Check final status
          if ! systemctl is-active --quiet sysbox-mgr || ! systemctl is-active --quiet sysbox-fs; then
            echo "::error::Sysbox services failed to start"
            echo "=== sysbox-mgr status ==="
            systemctl status sysbox-mgr --no-pager || true
            echo "=== sysbox-fs status ==="
            systemctl status sysbox-fs --no-pager || true
            echo "=== sysbox-mgr logs ==="
            journalctl -u sysbox-mgr --no-pager -n 50 || true
            echo "=== sysbox-fs logs ==="
            journalctl -u sysbox-fs --no-pager -n 50 || true
            exit 1
          fi

          echo "=== sysbox-runc version ==="
          sysbox-runc --version

          echo "=== Docker info ==="
          if ! docker info; then
            echo "::error::Docker daemon is not running or misconfigured"
            exit 1
          fi

          echo "=== Verifying sysbox-runc runtime is registered ==="
          if ! docker info --format '{{json .Runtimes}}' | grep -q sysbox-runc; then
            echo "::error::sysbox-runc runtime not registered with Docker"
            echo "Available runtimes:"
            docker info --format '{{json .Runtimes}}'
            exit 1
          fi
          echo "sysbox-runc runtime is available"

      - name: Run DinD smoke test
        run: |
          CONTAINER_NAME="test-dind-${{ github.run_id }}"

          echo "Starting sysbox container: $CONTAINER_NAME"
          docker run --runtime=sysbox-runc -d --name="$CONTAINER_NAME" \
            nestybox/ubuntu-focal-systemd-docker:latest

          # Wait for inner dockerd to be ready (up to 60s)
          echo "Waiting for inner dockerd to start..."
          for i in {1..30}; do
            if docker exec "$CONTAINER_NAME" docker info >/dev/null 2>&1; then
              echo "Inner dockerd is ready"
              break
            fi
            echo "Waiting for inner dockerd... ($i/30)"
            sleep 2
          done

          # Run nested hello-world
          echo "Running nested hello-world container..."
          if ! docker exec "$CONTAINER_NAME" docker run --rm hello-world; then
            echo "::error::Nested container test failed"
            echo "=== Container logs ==="
            docker logs "$CONTAINER_NAME" || true
            echo "=== Inner docker status ==="
            docker exec "$CONTAINER_NAME" systemctl status docker.service --no-pager || true
            echo "=== Inner docker logs ==="
            docker exec "$CONTAINER_NAME" journalctl -u docker.service --no-pager -n 30 || true
            # Cleanup before exit
            docker rm -f "$CONTAINER_NAME" || true
            exit 1
          fi

          echo "DinD smoke test passed!"

          # Cleanup
          echo "Cleaning up test container..."
          docker rm -f "$CONTAINER_NAME" || true

  test-arm64:
    name: Test arm64
    needs: build
    runs-on: ubuntu-24.04-arm
    timeout-minutes: 10

    steps:
      - name: Download arm64 artifact
        uses: actions/download-artifact@v4
        with:
          name: sysbox-ce-arm64
          path: dist

      - name: Install sysbox deb
        run: |
          echo "Installing sysbox deb package..."
          ls -la dist/*.deb
          sudo apt-get update
          sudo DEBIAN_FRONTEND=noninteractive dpkg -i dist/sysbox-ce*.deb || true
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -f -y

      - name: Verify sysbox services
        run: |
          echo "Waiting for sysbox services to start..."
          # Wait up to 30s for services to become active
          for i in {1..15}; do
            if systemctl is-active --quiet sysbox-mgr && systemctl is-active --quiet sysbox-fs; then
              echo "Sysbox services are active"
              break
            fi
            echo "Waiting for services... ($i/15)"
            sleep 2
          done

          # Check final status
          if ! systemctl is-active --quiet sysbox-mgr || ! systemctl is-active --quiet sysbox-fs; then
            echo "::error::Sysbox services failed to start"
            echo "=== sysbox-mgr status ==="
            systemctl status sysbox-mgr --no-pager || true
            echo "=== sysbox-fs status ==="
            systemctl status sysbox-fs --no-pager || true
            echo "=== sysbox-mgr logs ==="
            journalctl -u sysbox-mgr --no-pager -n 50 || true
            echo "=== sysbox-fs logs ==="
            journalctl -u sysbox-fs --no-pager -n 50 || true
            exit 1
          fi

          echo "=== sysbox-runc version ==="
          sysbox-runc --version

          echo "=== Docker info ==="
          if ! docker info; then
            echo "::error::Docker daemon is not running or misconfigured"
            exit 1
          fi

          echo "=== Verifying sysbox-runc runtime is registered ==="
          if ! docker info --format '{{json .Runtimes}}' | grep -q sysbox-runc; then
            echo "::error::sysbox-runc runtime not registered with Docker"
            echo "Available runtimes:"
            docker info --format '{{json .Runtimes}}'
            exit 1
          fi
          echo "sysbox-runc runtime is available"

      - name: Run DinD smoke test
        run: |
          CONTAINER_NAME="test-dind-${{ github.run_id }}"

          echo "Starting sysbox container: $CONTAINER_NAME"
          docker run --runtime=sysbox-runc -d --name="$CONTAINER_NAME" \
            nestybox/ubuntu-focal-systemd-docker:latest

          # Wait for inner dockerd to be ready (up to 60s)
          echo "Waiting for inner dockerd to start..."
          for i in {1..30}; do
            if docker exec "$CONTAINER_NAME" docker info >/dev/null 2>&1; then
              echo "Inner dockerd is ready"
              break
            fi
            echo "Waiting for inner dockerd... ($i/30)"
            sleep 2
          done

          # Run nested hello-world
          echo "Running nested hello-world container..."
          if ! docker exec "$CONTAINER_NAME" docker run --rm hello-world; then
            echo "::error::Nested container test failed"
            echo "=== Container logs ==="
            docker logs "$CONTAINER_NAME" || true
            echo "=== Inner docker status ==="
            docker exec "$CONTAINER_NAME" systemctl status docker.service --no-pager || true
            echo "=== Inner docker logs ==="
            docker exec "$CONTAINER_NAME" journalctl -u docker.service --no-pager -n 30 || true
            # Cleanup before exit
            docker rm -f "$CONTAINER_NAME" || true
            exit 1
          fi

          echo "DinD smoke test passed!"

          # Cleanup
          echo "Cleaning up test container..."
          docker rm -f "$CONTAINER_NAME" || true

  release:
    name: Create Release
    needs: [build, test-amd64, test-arm64]
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')) ||
      (github.event_name == 'workflow_dispatch' && inputs.create_release)
    permissions:
      contents: write

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release assets
        id: release_assets
        run: |
          mkdir -p release

          # Move all deb and checksum files to release directory
          find artifacts -name "*.deb" -exec mv {} release/ \;
          find artifacts -name "*.sha256" -exec mv {} release/ \;

          echo "Release assets:"
          ls -la release/

      - name: Determine release tag
        id: tag
        run: |
          if [[ "${{ github.event_name }}" == "push" ]]; then
            tag="${{ github.ref_name }}"
          else
            # For manual dispatch, include run_number to ensure uniqueness
            tag="sysbox-build-$(date +%Y%m%d)-${{ github.run_number }}"
          fi
          echo "tag=$tag" >> $GITHUB_OUTPUT
          echo "Release tag: $tag"

      - name: Generate release notes
        id: notes
        run: |
          cat > release_notes.md << 'EOF'
          ## ContainAI Sysbox Build

          Custom sysbox-ce build from master branch with the **openat2 fix** for runc 1.3.3+ compatibility.

          ### What's included

          This build includes the fix for the Docker-in-Docker compatibility issue with runc 1.3.3+:
          - sysbox-fs commit `1302a6f`: "Trap openat2 system call to allow access to sysbox-fs mounts under /proc and /sys"
          - Follow-up improvements and hardening commits

          The fix uses seccomp syscall interception to trap `openat2()` calls and strip problematic flags (`RESOLVE_NO_XDEV`, `RESOLVE_NO_MAGICLINKS`, `RESOLVE_NO_SYMLINKS`, `RESOLVE_BENEATH`) when accessing sysbox-fs mounts.

          ### Installation

          ```bash
          # Download the appropriate package for your architecture
          wget <deb-url>

          # Install (may need to fix dependencies)
          sudo dpkg -i sysbox-ce_*.deb
          sudo apt-get install -f -y

          # Verify installation
          sysbox-runc --version
          ```

          ### Checksums

          EOF

          echo '```' >> release_notes.md
          cat release/*.sha256 >> release_notes.md
          echo '```' >> release_notes.md

          cat >> release_notes.md << 'EOF'

          ### References

          - [sysbox#973](https://github.com/nestybox/sysbox/issues/973) - Docker 28.5.2 breaks DinD on Sysbox
          - [runc v1.3.3](https://github.com/opencontainers/runc/releases/tag/v1.3.3) - Release with security patches

          ---

          Built by ContainAI CI
          EOF

          echo "Release notes:"
          cat release_notes.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          name: Sysbox Build ${{ steps.tag.outputs.tag }}
          body_path: release_notes.md
          draft: false
          prerelease: true
          files: release/*
