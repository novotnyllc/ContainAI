# ==============================================================================
# ContainAI Sysbox Build Workflow
# ==============================================================================
# Builds sysbox-ce deb packages from master branch with the openat2 fix for
# runc 1.3.3+ compatibility. Publishes to GitHub releases.
#
# Triggers:
#   - Manual dispatch (workflow_dispatch)
#   - Tag push matching 'sysbox-v*' pattern
#
# The built packages are published to GitHub releases with:
#   - DEB packages for amd64 and arm64
#   - SHA256 checksums for verification
#   - Release notes documenting the build
# ==============================================================================

name: Build Sysbox

on:
  workflow_dispatch:
    inputs:
      version_suffix:
        description: 'Version suffix (default: +containai.YYYYMMDD)'
        required: false
        type: string
      create_release:
        description: 'Create GitHub release'
        required: false
        type: boolean
        default: true

  push:
    tags:
      - 'sysbox-v*'

env:
  # Sysbox repository to build from
  SYSBOX_REPO: https://github.com/nestybox/sysbox.git
  SYSBOX_BRANCH: master

jobs:
  # ============================================================================
  # Build Jobs - Native architecture builds (no QEMU cross-compilation)
  # ============================================================================
  build-amd64:
    name: Build amd64
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout ContainAI
        uses: actions/checkout@v4

      - name: Set up build environment
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Verify native architecture
        id: arch
        run: |
          TARGET_ARCH=$(dpkg --print-architecture)
          echo "target_arch=$TARGET_ARCH" >> "$GITHUB_OUTPUT"
          echo "Native architecture: $TARGET_ARCH"
          if [[ "$TARGET_ARCH" != "amd64" ]]; then
            echo "::error::Expected amd64 architecture but got $TARGET_ARCH"
            exit 1
          fi

      - name: Determine version suffix
        id: version
        env:
          INPUT_SUFFIX: ${{ inputs.version_suffix }}
        run: |
          if [[ -n "$INPUT_SUFFIX" ]]; then
            suffix="$INPUT_SUFFIX"
          else
            suffix="+containai.$(date +%Y%m%d)"
          fi
          printf 'suffix=%s\n' "$suffix" >> "$GITHUB_OUTPUT"
          echo "Version suffix: $suffix"

      - name: Clone sysbox repository
        run: |
          echo "Cloning sysbox from ${{ env.SYSBOX_BRANCH }} branch..."
          git clone --recursive --depth 1 --branch ${{ env.SYSBOX_BRANCH }} \
            ${{ env.SYSBOX_REPO }} sysbox

      - name: Get sysbox version
        id: sysbox_version
        run: |
          version=$(cat sysbox/VERSION | tr -d '[:space:]')
          full_version="${version}${{ steps.version.outputs.suffix }}"
          echo "base_version=$version" >> $GITHUB_OUTPUT
          echo "full_version=$full_version" >> $GITHUB_OUTPUT
          echo "Sysbox base version: $version"
          echo "Full version: $full_version"

      - name: Verify openat2 fix is present
        run: |
          echo "Checking for openat2 fix in sysbox-fs..."
          # The fix was introduced in commit 1302a6f - verify it's an ancestor
          # Need to fetch enough history to check ancestry
          cd sysbox/sysbox-fs
          git fetch --unshallow 2>/dev/null || git fetch --depth=100 origin master 2>/dev/null || true

          FIX_COMMIT="1302a6f"
          if git merge-base --is-ancestor "$FIX_COMMIT" HEAD 2>/dev/null; then
            echo "openat2 fix verified: commit $FIX_COMMIT is ancestor of HEAD"
          else
            # Fallback: check for the specific syscall handler file that implements the fix
            if [[ -f "handler/implementations/openat2.go" ]]; then
              echo "openat2 fix verified: handler/implementations/openat2.go exists"
            else
              echo "::error::openat2 fix NOT found in sysbox-fs"
              echo "Could not verify commit $FIX_COMMIT ancestry or find openat2.go handler"
              echo "The whole purpose of this build is to include the openat2 fix."
              exit 1
            fi
          fi

      - name: Patch version
        run: |
          echo "${{ steps.sysbox_version.outputs.full_version }}" > sysbox/VERSION
          echo "Patched VERSION file:"
          cat sysbox/VERSION

      - name: Set up sysbox-pkgr
        run: |
          cd sysbox/sysbox-pkgr
          mkdir -p sources
          ln -sfn "$(pwd)/../" sources/sysbox

      - name: Patch control files for fuse3 dependency
        run: |
          # sysbox-fs requires fusermount3 which is provided by fuse3
          # Use find to locate all control files (handles various template layouts)
          echo "Patching control files to add fuse3 dependency..."

          control_files=$(find sysbox/sysbox-pkgr/deb -name control -type f)
          if [[ -z "$control_files" ]]; then
            echo "::error::No control files found in sysbox/sysbox-pkgr/deb"
            exit 1
          fi

          patched_count=0
          already_present_count=0
          for f in $control_files; do
            echo "Checking $f..."

            # Skip if fuse3 already present and fuse already removed (idempotent)
            if grep -qE '^Depends:.*\bfuse3\b' "$f" && ! grep -qE '^Depends:.*\bfuse\b[^3]' "$f"; then
              echo "  fuse3 already present (fuse removed), skipping"
              already_present_count=$((already_present_count + 1))
              continue
            fi

            # Replace fuse with fuse3 in the Depends line (per spec: "instead of fuse")
            if grep -q '^Depends:' "$f"; then
              # First, replace 'fuse' with 'fuse3' (handles ", fuse," or ", fuse$" patterns)
              sed -i -E 's/(^Depends:.*)(,[[:space:]]*)fuse([[:space:]]*,|[[:space:]]*$)/\1\2fuse3\3/' "$f"

              # If fuse3 still not present (fuse wasn't in original), add it at beginning
              if ! grep -qE '^Depends:.*\bfuse3\b' "$f"; then
                sed -i 's/^Depends:/Depends: fuse3,/' "$f"
              fi

              # Verify the patch worked
              if grep -qE '^Depends:.*\bfuse3\b' "$f"; then
                echo "  fuse3 dependency set"
                grep '^Depends:' "$f"
                patched_count=$((patched_count + 1))
              else
                echo "::error::Failed to patch $f"
                exit 1
              fi
            fi
          done

          # Success if we patched at least one file OR fuse3 was already present
          if [[ "$patched_count" -eq 0 ]] && [[ "$already_present_count" -eq 0 ]]; then
            echo "::error::No control files were patched and none had fuse3"
            exit 1
          fi
          echo "Patched $patched_count control file(s), $already_present_count already had fuse3"

      - name: Build sysbox-ce deb package
        run: |
          set -o pipefail
          cd sysbox/sysbox-pkgr
          export EDITION=ce
          # Set target architecture explicitly from native arch
          export TARGET_ARCH=${{ steps.arch.outputs.target_arch }}

          echo "Building sysbox-ce deb package for amd64 (native)..."
          echo "Target architecture: $TARGET_ARCH"
          echo "This may take 15-30 minutes..."

          make -C deb generic EDITION=ce TARGET_ARCH=${{ steps.arch.outputs.target_arch }} 2>&1 | tee build.log

          echo "Build completed"

      - name: Locate built package
        id: package
        run: |
          deb_path=$(find sysbox/sysbox-pkgr/deb/build -name "sysbox-ce*.deb" -type f | head -1)
          if [[ -z "$deb_path" ]]; then
            echo "::error::Built deb package not found"
            find sysbox/sysbox-pkgr/deb/build -type f || true
            exit 1
          fi
          echo "Found package: $deb_path"
          echo "path=$deb_path" >> $GITHUB_OUTPUT

      - name: Prepare artifacts
        id: artifacts
        run: |
          mkdir -p dist

          version="${{ steps.sysbox_version.outputs.full_version }}"
          arch="${{ steps.arch.outputs.target_arch }}"
          final_name="sysbox-ce_${version}.linux_${arch}.deb"

          cp "${{ steps.package.outputs.path }}" "dist/${final_name}"

          cd dist
          sha256sum "${final_name}" > "${final_name}.sha256"

          echo "Artifacts:"
          ls -la
          echo ""
          echo "SHA256:"
          cat "${final_name}.sha256"

          echo "deb_name=${final_name}" >> $GITHUB_OUTPUT
          echo "checksum_name=${final_name}.sha256" >> $GITHUB_OUTPUT

      - name: Upload deb artifact
        uses: actions/upload-artifact@v4
        with:
          name: sysbox-ce-amd64
          path: |
            dist/*.deb
            dist/*.sha256
          retention-days: 30

  build-arm64:
    name: Build arm64
    runs-on: ubuntu-24.04-arm

    steps:
      - name: Checkout ContainAI
        uses: actions/checkout@v4

      - name: Set up build environment
        run: |
          # Install build dependencies - ubuntu-24.04-arm may have different defaults
          sudo apt-get update
          sudo apt-get install -y jq build-essential

      - name: Verify native architecture
        id: arch
        run: |
          TARGET_ARCH=$(dpkg --print-architecture)
          echo "target_arch=$TARGET_ARCH" >> "$GITHUB_OUTPUT"
          echo "Native architecture: $TARGET_ARCH"
          if [[ "$TARGET_ARCH" != "arm64" ]]; then
            echo "::error::Expected arm64 architecture but got $TARGET_ARCH"
            exit 1
          fi

      - name: Determine version suffix
        id: version
        env:
          INPUT_SUFFIX: ${{ inputs.version_suffix }}
        run: |
          if [[ -n "$INPUT_SUFFIX" ]]; then
            suffix="$INPUT_SUFFIX"
          else
            suffix="+containai.$(date +%Y%m%d)"
          fi
          printf 'suffix=%s\n' "$suffix" >> "$GITHUB_OUTPUT"
          echo "Version suffix: $suffix"

      - name: Clone sysbox repository
        run: |
          echo "Cloning sysbox from ${{ env.SYSBOX_BRANCH }} branch..."
          git clone --recursive --depth 1 --branch ${{ env.SYSBOX_BRANCH }} \
            ${{ env.SYSBOX_REPO }} sysbox

      - name: Get sysbox version
        id: sysbox_version
        run: |
          version=$(cat sysbox/VERSION | tr -d '[:space:]')
          full_version="${version}${{ steps.version.outputs.suffix }}"
          echo "base_version=$version" >> $GITHUB_OUTPUT
          echo "full_version=$full_version" >> $GITHUB_OUTPUT
          echo "Sysbox base version: $version"
          echo "Full version: $full_version"

      - name: Verify openat2 fix is present
        run: |
          echo "Checking for openat2 fix in sysbox-fs..."
          # The fix was introduced in commit 1302a6f - verify it's an ancestor
          # Need to fetch enough history to check ancestry
          cd sysbox/sysbox-fs
          git fetch --unshallow 2>/dev/null || git fetch --depth=100 origin master 2>/dev/null || true

          FIX_COMMIT="1302a6f"
          if git merge-base --is-ancestor "$FIX_COMMIT" HEAD 2>/dev/null; then
            echo "openat2 fix verified: commit $FIX_COMMIT is ancestor of HEAD"
          else
            # Fallback: check for the specific syscall handler file that implements the fix
            if [[ -f "handler/implementations/openat2.go" ]]; then
              echo "openat2 fix verified: handler/implementations/openat2.go exists"
            else
              echo "::error::openat2 fix NOT found in sysbox-fs"
              echo "Could not verify commit $FIX_COMMIT ancestry or find openat2.go handler"
              echo "The whole purpose of this build is to include the openat2 fix."
              exit 1
            fi
          fi

      - name: Patch version
        run: |
          echo "${{ steps.sysbox_version.outputs.full_version }}" > sysbox/VERSION
          echo "Patched VERSION file:"
          cat sysbox/VERSION

      - name: Set up sysbox-pkgr
        run: |
          cd sysbox/sysbox-pkgr
          mkdir -p sources
          ln -sfn "$(pwd)/../" sources/sysbox

      - name: Patch control files for fuse3 dependency
        run: |
          # sysbox-fs requires fusermount3 which is provided by fuse3
          # Use find to locate all control files (handles various template layouts)
          echo "Patching control files to add fuse3 dependency..."

          control_files=$(find sysbox/sysbox-pkgr/deb -name control -type f)
          if [[ -z "$control_files" ]]; then
            echo "::error::No control files found in sysbox/sysbox-pkgr/deb"
            exit 1
          fi

          patched_count=0
          already_present_count=0
          for f in $control_files; do
            echo "Checking $f..."

            # Skip if fuse3 already present and fuse already removed (idempotent)
            if grep -qE '^Depends:.*\bfuse3\b' "$f" && ! grep -qE '^Depends:.*\bfuse\b[^3]' "$f"; then
              echo "  fuse3 already present (fuse removed), skipping"
              already_present_count=$((already_present_count + 1))
              continue
            fi

            # Replace fuse with fuse3 in the Depends line (per spec: "instead of fuse")
            if grep -q '^Depends:' "$f"; then
              # First, replace 'fuse' with 'fuse3' (handles ", fuse," or ", fuse$" patterns)
              sed -i -E 's/(^Depends:.*)(,[[:space:]]*)fuse([[:space:]]*,|[[:space:]]*$)/\1\2fuse3\3/' "$f"

              # If fuse3 still not present (fuse wasn't in original), add it at beginning
              if ! grep -qE '^Depends:.*\bfuse3\b' "$f"; then
                sed -i 's/^Depends:/Depends: fuse3,/' "$f"
              fi

              # Verify the patch worked
              if grep -qE '^Depends:.*\bfuse3\b' "$f"; then
                echo "  fuse3 dependency set"
                grep '^Depends:' "$f"
                patched_count=$((patched_count + 1))
              else
                echo "::error::Failed to patch $f"
                exit 1
              fi
            fi
          done

          # Success if we patched at least one file OR fuse3 was already present
          if [[ "$patched_count" -eq 0 ]] && [[ "$already_present_count" -eq 0 ]]; then
            echo "::error::No control files were patched and none had fuse3"
            exit 1
          fi
          echo "Patched $patched_count control file(s), $already_present_count already had fuse3"

      - name: Build sysbox-ce deb package
        run: |
          set -o pipefail
          cd sysbox/sysbox-pkgr
          export EDITION=ce
          # Set target architecture explicitly from native arch
          export TARGET_ARCH=${{ steps.arch.outputs.target_arch }}

          echo "Building sysbox-ce deb package for arm64 (native)..."
          echo "Target architecture: $TARGET_ARCH"
          echo "This may take 15-30 minutes..."

          make -C deb generic EDITION=ce TARGET_ARCH=${{ steps.arch.outputs.target_arch }} 2>&1 | tee build.log

          echo "Build completed"

      - name: Locate built package
        id: package
        run: |
          deb_path=$(find sysbox/sysbox-pkgr/deb/build -name "sysbox-ce*.deb" -type f | head -1)
          if [[ -z "$deb_path" ]]; then
            echo "::error::Built deb package not found"
            find sysbox/sysbox-pkgr/deb/build -type f || true
            exit 1
          fi
          echo "Found package: $deb_path"
          echo "path=$deb_path" >> $GITHUB_OUTPUT

      - name: Prepare artifacts
        id: artifacts
        run: |
          mkdir -p dist

          version="${{ steps.sysbox_version.outputs.full_version }}"
          arch="${{ steps.arch.outputs.target_arch }}"
          final_name="sysbox-ce_${version}.linux_${arch}.deb"

          cp "${{ steps.package.outputs.path }}" "dist/${final_name}"

          cd dist
          sha256sum "${final_name}" > "${final_name}.sha256"

          echo "Artifacts:"
          ls -la
          echo ""
          echo "SHA256:"
          cat "${final_name}.sha256"

          echo "deb_name=${final_name}" >> $GITHUB_OUTPUT
          echo "checksum_name=${final_name}.sha256" >> $GITHUB_OUTPUT

      - name: Upload deb artifact
        uses: actions/upload-artifact@v4
        with:
          name: sysbox-ce-arm64
          path: |
            dist/*.deb
            dist/*.sha256
          retention-days: 30

  test-amd64:
    name: Test amd64
    needs: build-amd64
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Download amd64 artifact
        uses: actions/download-artifact@v4
        with:
          name: sysbox-ce-amd64
          path: dist

      - name: Validate fuse3 dependency in deb package
        run: |
          echo "Validating fuse3 dependency in built deb package..."
          deb_path=$(find dist -name "sysbox-ce*.deb" -type f | head -1)
          if [[ -z "$deb_path" ]]; then
            echo "::error::No deb package found in dist/"
            exit 1
          fi
          echo "Package: $deb_path"

          # Extract and check the Depends line specifically
          echo "Package dependencies:"
          depends_line=$(dpkg-deb -f "$deb_path" Depends)
          echo "Depends: $depends_line"

          # Verify fuse3 is in the Depends field (word boundary check)
          if echo "$depends_line" | grep -qE '\bfuse3\b'; then
            echo "fuse3 dependency found in package metadata"
          else
            echo "::error::fuse3 dependency NOT found in package Depends field"
            echo "Full package control info:"
            dpkg-deb -I "$deb_path"
            exit 1
          fi

      - name: Install sysbox deb
        run: |
          echo "Installing sysbox deb package..."
          ls -la dist/*.deb
          sudo apt-get update
          sudo DEBIAN_FRONTEND=noninteractive dpkg -i dist/sysbox-ce*.deb || true
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -f -y

      - name: Verify fuse3 installed and fusermount3 present
        run: |
          echo "Verifying fuse3 was installed as dependency..."

          # Check dpkg shows fuse3 as installed
          if dpkg -s fuse3 >/dev/null 2>&1; then
            echo "fuse3 package is installed:"
            dpkg -s fuse3 | grep -E '^(Package|Status|Version):'
          else
            echo "::error::fuse3 package is NOT installed"
            exit 1
          fi

          # Verify fusermount3 binary is present
          if command -v fusermount3 >/dev/null 2>&1; then
            echo "fusermount3 binary found: $(command -v fusermount3)"
            fusermount3 --version || true
          else
            echo "::error::fusermount3 binary NOT found"
            exit 1
          fi

          echo "fuse3 dependency verification passed"

      - name: Verify sysbox services
        run: |
          echo "Waiting for sysbox services to start..."
          # Wait up to 30s for services to become active
          for i in {1..15}; do
            if systemctl is-active --quiet sysbox-mgr && systemctl is-active --quiet sysbox-fs; then
              echo "Sysbox services are active"
              break
            fi
            echo "Waiting for services... ($i/15)"
            sleep 2
          done

          # Check final status
          if ! systemctl is-active --quiet sysbox-mgr || ! systemctl is-active --quiet sysbox-fs; then
            echo "::error::Sysbox services failed to start"
            echo "=== sysbox-mgr status ==="
            systemctl status sysbox-mgr --no-pager || true
            echo "=== sysbox-fs status ==="
            systemctl status sysbox-fs --no-pager || true
            echo "=== sysbox-mgr logs ==="
            journalctl -u sysbox-mgr --no-pager -n 50 || true
            echo "=== sysbox-fs logs ==="
            journalctl -u sysbox-fs --no-pager -n 50 || true
            exit 1
          fi

          echo "=== sysbox-runc version ==="
          sysbox-runc --version

          echo "=== Docker info ==="
          if ! docker info; then
            echo "::error::Docker daemon is not running or misconfigured"
            exit 1
          fi

          echo "=== Verifying sysbox-runc runtime is registered ==="
          if ! docker info --format '{{json .Runtimes}}' | grep -q sysbox-runc; then
            echo "::error::sysbox-runc runtime not registered with Docker"
            echo "Available runtimes:"
            docker info --format '{{json .Runtimes}}'
            exit 1
          fi
          echo "sysbox-runc runtime is available"

      - name: Run DinD smoke test
        run: |
          CONTAINER_NAME="test-dind-${{ github.run_id }}"

          echo "Starting sysbox container: $CONTAINER_NAME"
          docker run --runtime=sysbox-runc -d --name="$CONTAINER_NAME" \
            docker:dind

          # Wait for inner dockerd to be ready (up to 60s)
          echo "Waiting for inner dockerd to start..."
          for i in {1..30}; do
            if docker exec "$CONTAINER_NAME" docker info >/dev/null 2>&1; then
              echo "Inner dockerd is ready"
              break
            fi
            echo "Waiting for inner dockerd... ($i/30)"
            sleep 2
          done

          # Run nested hello-world
          echo "Running nested hello-world container..."
          if ! docker exec "$CONTAINER_NAME" docker run --rm hello-world; then
            echo "::error::Nested container test failed"
            echo "=== Container logs ==="
            docker logs "$CONTAINER_NAME" || true
            echo "=== Inner docker status ==="
            docker exec "$CONTAINER_NAME" systemctl status docker.service --no-pager || true
            echo "=== Inner docker logs ==="
            docker exec "$CONTAINER_NAME" journalctl -u docker.service --no-pager -n 30 || true
            # Cleanup before exit
            docker rm -f "$CONTAINER_NAME" || true
            exit 1
          fi

          echo "DinD smoke test passed!"

          # Cleanup
          echo "Cleaning up test container..."
          docker rm -f "$CONTAINER_NAME" || true

  test-arm64:
    name: Test arm64
    needs: build-arm64
    runs-on: ubuntu-24.04-arm
    timeout-minutes: 10

    steps:
      - name: Download arm64 artifact
        uses: actions/download-artifact@v4
        with:
          name: sysbox-ce-arm64
          path: dist

      - name: Validate fuse3 dependency in deb package
        run: |
          echo "Validating fuse3 dependency in built deb package..."
          deb_path=$(find dist -name "sysbox-ce*.deb" -type f | head -1)
          if [[ -z "$deb_path" ]]; then
            echo "::error::No deb package found in dist/"
            exit 1
          fi
          echo "Package: $deb_path"

          # Extract and check the Depends line specifically
          echo "Package dependencies:"
          depends_line=$(dpkg-deb -f "$deb_path" Depends)
          echo "Depends: $depends_line"

          # Verify fuse3 is in the Depends field (word boundary check)
          if echo "$depends_line" | grep -qE '\bfuse3\b'; then
            echo "fuse3 dependency found in package metadata"
          else
            echo "::error::fuse3 dependency NOT found in package Depends field"
            echo "Full package control info:"
            dpkg-deb -I "$deb_path"
            exit 1
          fi

      - name: Install sysbox deb
        run: |
          echo "Installing sysbox deb package..."
          ls -la dist/*.deb
          sudo apt-get update
          sudo DEBIAN_FRONTEND=noninteractive dpkg -i dist/sysbox-ce*.deb || true
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -f -y

      - name: Verify fuse3 installed and fusermount3 present
        run: |
          echo "Verifying fuse3 was installed as dependency..."

          # Check dpkg shows fuse3 as installed
          if dpkg -s fuse3 >/dev/null 2>&1; then
            echo "fuse3 package is installed:"
            dpkg -s fuse3 | grep -E '^(Package|Status|Version):'
          else
            echo "::error::fuse3 package is NOT installed"
            exit 1
          fi

          # Verify fusermount3 binary is present
          if command -v fusermount3 >/dev/null 2>&1; then
            echo "fusermount3 binary found: $(command -v fusermount3)"
            fusermount3 --version || true
          else
            echo "::error::fusermount3 binary NOT found"
            exit 1
          fi

          echo "fuse3 dependency verification passed"

      - name: Verify sysbox services
        run: |
          echo "Waiting for sysbox services to start..."
          # Wait up to 30s for services to become active
          for i in {1..15}; do
            if systemctl is-active --quiet sysbox-mgr && systemctl is-active --quiet sysbox-fs; then
              echo "Sysbox services are active"
              break
            fi
            echo "Waiting for services... ($i/15)"
            sleep 2
          done

          # Check final status
          if ! systemctl is-active --quiet sysbox-mgr || ! systemctl is-active --quiet sysbox-fs; then
            echo "::error::Sysbox services failed to start"
            echo "=== sysbox-mgr status ==="
            systemctl status sysbox-mgr --no-pager || true
            echo "=== sysbox-fs status ==="
            systemctl status sysbox-fs --no-pager || true
            echo "=== sysbox-mgr logs ==="
            journalctl -u sysbox-mgr --no-pager -n 50 || true
            echo "=== sysbox-fs logs ==="
            journalctl -u sysbox-fs --no-pager -n 50 || true
            exit 1
          fi

          echo "=== sysbox-runc version ==="
          sysbox-runc --version

          echo "=== Docker info ==="
          if ! docker info; then
            echo "::error::Docker daemon is not running or misconfigured"
            exit 1
          fi

          echo "=== Verifying sysbox-runc runtime is registered ==="
          if ! docker info --format '{{json .Runtimes}}' | grep -q sysbox-runc; then
            echo "::error::sysbox-runc runtime not registered with Docker"
            echo "Available runtimes:"
            docker info --format '{{json .Runtimes}}'
            exit 1
          fi
          echo "sysbox-runc runtime is available"

      - name: Run DinD smoke test
        run: |
          CONTAINER_NAME="test-dind-${{ github.run_id }}"

          echo "Starting sysbox container: $CONTAINER_NAME"
          docker run --runtime=sysbox-runc -d --name="$CONTAINER_NAME" \
           docker:dind

          # Wait for inner dockerd to be ready (up to 60s)
          echo "Waiting for inner dockerd to start..."
          for i in {1..30}; do
            if docker exec "$CONTAINER_NAME" docker info >/dev/null 2>&1; then
              echo "Inner dockerd is ready"
              break
            fi
            echo "Waiting for inner dockerd... ($i/30)"
            sleep 2
          done

          # Run nested hello-world
          echo "Running nested hello-world container..."
          if ! docker exec "$CONTAINER_NAME" docker run --rm hello-world; then
            echo "::error::Nested container test failed"
            echo "=== Container logs ==="
            docker logs "$CONTAINER_NAME" || true
            echo "=== Inner docker status ==="
            docker exec "$CONTAINER_NAME" systemctl status docker.service --no-pager || true
            echo "=== Inner docker logs ==="
            docker exec "$CONTAINER_NAME" journalctl -u docker.service --no-pager -n 30 || true
            # Cleanup before exit
            docker rm -f "$CONTAINER_NAME" || true
            exit 1
          fi

          echo "DinD smoke test passed!"

          # Cleanup
          echo "Cleaning up test container..."
          docker rm -f "$CONTAINER_NAME" || true

  release:
    name: Create Release
    needs: [build-amd64, build-arm64, test-amd64, test-arm64]
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')) ||
      (github.event_name == 'workflow_dispatch' && inputs.create_release)
    permissions:
      contents: write

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release assets
        id: release_assets
        run: |
          mkdir -p release

          # Move all deb and checksum files to release directory
          find artifacts -name "*.deb" -exec mv {} release/ \;
          find artifacts -name "*.sha256" -exec mv {} release/ \;

          echo "Release assets:"
          ls -la release/

      - name: Determine release tag
        id: tag
        run: |
          if [[ "${{ github.event_name }}" == "push" ]]; then
            tag="${{ github.ref_name }}"
          else
            # For manual dispatch, include run_number to ensure uniqueness
            tag="sysbox-build-$(date +%Y%m%d)-${{ github.run_number }}"
          fi
          echo "tag=$tag" >> $GITHUB_OUTPUT
          echo "Release tag: $tag"

      - name: Generate release notes
        id: notes
        run: |
          cat > release_notes.md << 'EOF'
          ## ContainAI Sysbox Build

          Custom sysbox-ce build from master branch with the **openat2 fix** for runc 1.3.3+ compatibility.

          ### What's included

          This build includes the fix for the Docker-in-Docker compatibility issue with runc 1.3.3+:
          - sysbox-fs commit `1302a6f`: "Trap openat2 system call to allow access to sysbox-fs mounts under /proc and /sys"
          - Follow-up improvements and hardening commits

          The fix uses seccomp syscall interception to trap `openat2()` calls and strip problematic flags (`RESOLVE_NO_XDEV`, `RESOLVE_NO_MAGICLINKS`, `RESOLVE_NO_SYMLINKS`, `RESOLVE_BENEATH`) when accessing sysbox-fs mounts.

          ### Installation

          ```bash
          # Download the appropriate package for your architecture
          wget <deb-url>

          # Install (may need to fix dependencies)
          sudo dpkg -i sysbox-ce_*.deb
          sudo apt-get install -f -y

          # Verify installation
          sysbox-runc --version
          ```

          ### Checksums

          EOF

          echo '```' >> release_notes.md
          cat release/*.sha256 >> release_notes.md
          echo '```' >> release_notes.md

          cat >> release_notes.md << 'EOF'

          ### References

          - [sysbox#973](https://github.com/nestybox/sysbox/issues/973) - Docker 28.5.2 breaks DinD on Sysbox
          - [runc v1.3.3](https://github.com/opencontainers/runc/releases/tag/v1.3.3) - Release with security patches

          ---

          Built by ContainAI CI
          EOF

          echo "Release notes:"
          cat release_notes.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          name: Sysbox Build ${{ steps.tag.outputs.tag }}
          body_path: release_notes.md
          draft: false
          prerelease: true
          files: release/*
