{
  "created_at": "2026-02-03T21:52:55.978810Z",
  "epic": {
    "data": {
      "branch_name": "fn-49-devcontainer-integration",
      "completion_review_status": "unknown",
      "completion_reviewed_at": null,
      "created_at": "2026-02-02T23:23:21.023759Z",
      "default_impl": null,
      "default_review": null,
      "default_sync": null,
      "depends_on_epics": [],
      "id": "fn-49-devcontainer-integration",
      "next_task": 11,
      "plan_review_status": "ship",
      "plan_reviewed_at": "2026-02-03T14:50:08.096992Z",
      "spec_path": ".flow/specs/fn-49-devcontainer-integration.md",
      "status": "open",
      "title": "DevContainer Integration",
      "updated_at": "2026-02-03T14:50:08.097005Z"
    },
    "spec": "# DevContainer Integration for ContainAI\n\n## Executive Summary\n\nEnable VS Code devcontainers to run securely in sysbox with minimal friction. Users install `cai` on their host (WSL/Mac), add our feature to any devcontainer, and a VS Code extension + smart docker wrapper routes the container through sysbox.\n\n**Key insight**: The devcontainer runs **directly** in sysbox - no outer container, no nesting overhead. Our feature overlays onto whatever base image the user wants.\n\n**Security invariant**: Hard-block if not running in sysbox. The wrapper enforces `--runtime=sysbox-runc` at launch time, and the container performs kernel-level verification on startup.\n\n**Credential opt-in**: Credentials (GitHub tokens, Claude API keys) are NOT exposed by default. When `enableCredentials=false`:\n1. The wrapper mounts a credential-sanitized volume (requires `cai import --no-secrets` or validation)\n2. The init.sh skips symlinks to credential files\nThis defense-in-depth ensures untrusted code cannot access credentials even by reading the volume directly.\n\n**Scope**: V1 supports Docker CLI only (not docker-compose). Compose support is explicitly out of scope.\n\n---\n\n## Architecture\n\n```\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 User's Host (WSL/Mac)                                                   \u2502\n\u2502                                                                         \u2502\n\u2502   Prerequisites (via cai setup):                                        \u2502\n\u2502   \u251c\u2500 sysbox runtime installed                                           \u2502\n\u2502   \u251c\u2500 containai-docker context (platform-specific, reuse existing)       \u2502\n\u2502   \u251c\u2500 cai-docker wrapper at ~/.local/bin/cai-docker                      \u2502\n\u2502   \u251c\u2500 VS Code ContainAI extension                                        \u2502\n\u2502   \u2514\u2500 Data volume (default: sandbox-agent-data, configurable)            \u2502\n\u2502                                                                         \u2502\n\u2502   ~/.ssh/containai.d/devcontainer-<workspace> (managed via Include):    \u2502\n\u2502   \u251c\u2500 Host containai-devcontainer-<workspace>                            \u2502\n\u2502   \u2502     HostName localhost                                              \u2502\n\u2502   \u2502     Port <allocated>     # Dynamically allocated, not fixed         \u2502\n\u2502   \u2502     User vscode                                                     \u2502\n\u2502   \u2514\u2500 (enables: ssh containai-devcontainer-myproject)                    \u2502\n\u2502                                                                         \u2502\n\u2502   \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510                                             \u2502\n\u2502   \u2502 VS Code               \u2502                                             \u2502\n\u2502   \u2502 \u251c\u2500 Dev Containers ext \u2502                                             \u2502\n\u2502   \u2502 \u2502   dockerPath \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500> cai-docker wrapper                       \u2502\n\u2502   \u2502 \u2514\u2500 ContainAI ext      \u2502        \u2502                                    \u2502\n\u2502   \u2502    (sets dockerPath)  \u2502        \u251c\u2500 Detects ContainAI markers         \u2502\n\u2502   \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518        \u251c\u2500 Routes to sysbox context          \u2502\n\u2502                                    \u251c\u2500 Mounts data volume                \u2502\n\u2502                                    \u251c\u2500 Adds labels for GC                \u2502\n\u2502                                    \u2514\u2500 Updates ~/.ssh/config             \u2502\n\u2502                                    \u2502                                    \u2502\n\u2502                                    \u25bc                                    \u2502\n\u2502   \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510   \u2502\n\u2502   \u2502 User's Devcontainer (DIRECTLY in sysbox)                        \u2502   \u2502\n\u2502   \u2502                                                                 \u2502   \u2502\n\u2502   \u2502   Base image: ANY + ContainAI feature                           \u2502   \u2502\n\u2502   \u2502                                                                 \u2502   \u2502\n\u2502   \u2502   Mounts:                                                       \u2502   \u2502\n\u2502   \u2502   \u251c\u2500 /mnt/agent-data \u2190 sandbox-agent-data volume (default)      \u2502   \u2502\n\u2502   \u2502   \u2514\u2500 /workspaces/<project> \u2190 host workspace (standard)          \u2502   \u2502\n\u2502   \u2502                                                                 \u2502   \u2502\n\u2502   \u2502   postCreateCommand (init.sh):                                  \u2502   \u2502\n\u2502   \u2502   \u251c\u2500 Verify sysbox (kernel checks)                              \u2502   \u2502\n\u2502   \u2502   \u2514\u2500 Create symlinks: ~/.claude \u2192 /mnt/agent-data/claude, etc.  \u2502   \u2502\n\u2502   \u2502                                                                 \u2502   \u2502\n\u2502   \u2502   postStartCommand (start.sh):                                  \u2502   \u2502\n\u2502   \u2502   \u251c\u2500 Start sshd on $CONTAINAI_SSH_PORT (dynamic, not systemd)   \u2502   \u2502\n\u2502   \u2502   \u2514\u2500 Re-verify sysbox                                           \u2502   \u2502\n\u2502   \u2502                                                                 \u2502   \u2502\n\u2502   \u2502   Services:                                                     \u2502   \u2502\n\u2502   \u2502   \u251c\u2500 sshd (dynamic port) - for non-VS Code access               \u2502   \u2502\n\u2502   \u2502   \u2514\u2500 dockerd (DinD via postStart) - works without --privileged  \u2502   \u2502\n\u2502   \u2502                                                                 \u2502   \u2502\n\u2502   \u2502   Labels (for cai ps/stop/gc integration):                      \u2502   \u2502\n\u2502   \u2502   \u251c\u2500 containai.managed=true          # Required for CLI cmds    \u2502   \u2502\n\u2502   \u2502   \u251c\u2500 containai.type=devcontainer                                \u2502   \u2502\n\u2502   \u2502   \u251c\u2500 containai.devcontainer.workspace=<project-name>            \u2502   \u2502\n\u2502   \u2502   \u2514\u2500 containai.created=<ISO8601-UTC>  # Portable timestamp      \u2502   \u2502\n\u2502   \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518   \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n```\n\n**Key points**:\n- Devcontainer runs **directly** in sysbox (no outer container overhead)\n- Data volume provides non-credential configs by default (credentials opt-in)\n- SSH works via devcontainer port forwarding (not systemd), with dynamically allocated ports\n- Labels enable `cai ps`, `cai stop`, GC integration (requires `containai.managed=true`)\n- Reuses existing platform-specific context logic (WSL2 SSH bridge, macOS/Lima, etc.)\n\n---\n\n## What ContainAI Feature Provides\n\nThe feature replicates the full `cai` experience on any base image:\n\n### 1. Sysbox Verification\n- Kernel-enforced checks that cannot be faked\n- Hard-fail if not running in sysbox\n\n### 2. Data Volume Integration\n- Mounts existing cai data volume (default: `sandbox-agent-data`, configurable via `dataVolume` option)\n- Creates symlinks using existing `link-spec.json` and `link-repair.sh` (no duplicate manifest)\n- **Credentials disabled by default** (defense-in-depth):\n  1. **Wrapper level**: When `enableCredentials=false`, wrapper validates that the volume was created with `--no-secrets` flag (checks `.containai-no-secrets` marker file). If the marker is missing, refuses to mount and prompts user to run `cai import --no-secrets`.\n  2. **Init level**: Skips symlinks to credential files as secondary protection.\n- When `enableCredentials: true`: Full sync including tokens (requires explicit opt-in, no volume validation)\n\n**Prerequisite**: `cai import --no-secrets` must create the `.containai-no-secrets` marker file in the volume root. This is a separate change to `src/lib/import.sh` that must be implemented before this epic.\n\n### 3. Docker-in-Docker\n- Works without `--privileged` (sysbox provides this)\n- Nested containers work properly\n\n### 4. SSH Access\n- sshd runs as devcontainer service (not systemd)\n- Port dynamically allocated per workspace (uses ContainAI port allocation with file locking)\n- Port forwarded via devcontainer's `forwardPorts`\n- Host SSH config managed via `~/.ssh/containai.d/<workspace>` with `Include` directive (reuses existing `_cai_setup_ssh_config` pattern)\n\n### 5. Container Lifecycle\n- Labels for cai GC integration\n- Consistent naming for `cai ps` / `cai stop`\n\n```json\n{\n    \"image\": \"mcr.microsoft.com/devcontainers/python:3.11\",\n    \"features\": {\n        \"ghcr.io/novotnyllc/containai/feature:latest\": {\n            \"dataVolume\": \"sandbox-agent-data\",\n            \"enableCredentials\": false,\n            \"enableSsh\": true\n        }\n    }\n}\n```\n\n**Security note**: Setting `enableCredentials: true` exposes GitHub tokens, Claude API keys, and other credentials to any code in the workspace. Only enable for trusted repositories.\n\n---\n\n## Component Design\n\n### 1. Smart Docker Wrapper (`cai-docker`)\n\n**Location**: `~/.local/bin/cai-docker`\n\n**Purpose**:\n- Detect ContainAI devcontainers via VS Code labels (not `--workspace-folder`)\n- Enforce sysbox runtime at launch time (`--runtime=sysbox-runc`)\n- Mount data volume automatically\n- Add labels for GC integration\n- Update host SSH config via `~/.ssh/containai.d/`\n\n**Detection mechanism**: VS Code Dev Containers extension passes labels like:\n- `--label devcontainer.local_folder=/path/to/workspace`\n- `--label devcontainer.config_file=/path/to/.devcontainer/devcontainer.json`\n\nThe wrapper parses these labels to locate and read the devcontainer.json.\n\n**JSONC parsing**: Uses a proper state-machine JSONC stripper (string/escape aware) via python3 or a bundled parser, NOT sed-based comment stripping (which fails on comment-like sequences in strings).\n\n```bash\n#!/usr/bin/env bash\nset -euo pipefail\n\n# \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n# cai-docker: Smart docker wrapper for ContainAI devcontainers\n# \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n\n# Detect devcontainer via VS Code labels (docker create/run args)\n# VS Code passes: --label devcontainer.config_file=... and devcontainer.local_folder=...\nextract_devcontainer_labels() {\n    local config_file=\"\" local_folder=\"\"\n    local prev=\"\"\n    for arg in \"$@\"; do\n        if [[ \"$prev\" == \"--label\" ]]; then\n            case \"$arg\" in\n                devcontainer.config_file=*) config_file=\"${arg#*=}\" ;;\n                devcontainer.local_folder=*) local_folder=\"${arg#*=}\" ;;\n            esac\n        fi\n        prev=\"$arg\"\n    done\n    printf '%s\\n%s\\n' \"$config_file\" \"$local_folder\"\n}\n\n# Parse JSONC safely using python3 (handles strings, multiline comments correctly)\nstrip_jsonc_comments() {\n    python3 -c \"\nimport sys, re, json\ncontent = sys.stdin.read()\n# Remove // comments (not inside strings)\nresult = []\nin_string = False\nescape = False\ni = 0\nwhile i < len(content):\n    c = content[i]\n    if escape:\n        result.append(c)\n        escape = False\n    elif c == '\\\\\\\\' and in_string:\n        result.append(c)\n        escape = True\n    elif c == '\\\"' and not escape:\n        in_string = not in_string\n        result.append(c)\n    elif not in_string and c == '/' and i+1 < len(content):\n        if content[i+1] == '/':\n            # Skip to end of line\n            while i < len(content) and content[i] != '\\n':\n                i += 1\n            continue\n        elif content[i+1] == '*':\n            # Skip to */\n            i += 2\n            while i+1 < len(content) and not (content[i] == '*' and content[i+1] == '/'):\n                i += 1\n            i += 2\n            continue\n        else:\n            result.append(c)\n    else:\n        result.append(c)\n    i += 1\nprint(''.join(result))\n\"\n}\n\n# Check for containai feature in devcontainer.json\nhas_containai_feature() {\n    local config_file=\"$1\"\n    [[ -f \"$config_file\" ]] || return 1\n    strip_jsonc_comments < \"$config_file\" | grep -qE '\"containai\"'\n}\n\n# Get data volume from devcontainer.json or default\nget_data_volume() {\n    local config_file=\"$1\"\n    local vol\n    if [[ -f \"$config_file\" ]]; then\n        vol=$(strip_jsonc_comments < \"$config_file\" | \\\n              python3 -c \"import sys,json; d=json.load(sys.stdin); print(d.get('features',{}).get('ghcr.io/novotnyllc/containai/feature:latest',{}).get('dataVolume',''))\" 2>/dev/null || echo \"\")\n        [[ -n \"$vol\" ]] && echo \"$vol\" && return\n    fi\n    # Default: sandbox-agent-data (matches existing cai volume naming)\n    echo \"sandbox-agent-data\"\n}\n\n# Allocate SSH port using ContainAI port allocation (reuse existing logic)\n# This coordinates with _cai_allocate_ssh_port from src/lib/ssh.sh\n# Uses SAME lock file to prevent races with concurrent cai commands\nallocate_ssh_port() {\n    local workspace_name=\"$1\"\n\n    # Use SAME paths as cai for coordination\n    local config_dir=\"${XDG_CONFIG_HOME:-$HOME/.config}/containai\"\n    local port_dir=\"$config_dir/ports\"\n    local port_file=\"$port_dir/devcontainer-${workspace_name}\"\n    local lock_file=\"$config_dir/.ssh-port.lock\"  # SAME as cai uses\n    mkdir -p \"$port_dir\"\n\n    # Check if we already have a port for this workspace (no lock needed for read)\n    if [[ -f \"$port_file\" ]]; then\n        cat \"$port_file\"\n        return\n    fi\n\n    # Port allocation - lock is already held by caller (main)\n    # This function just does the allocation logic\n\n    # Check if already allocated for this workspace\n    if [[ -f \"$port_file\" ]]; then\n        cat \"$port_file\"\n        return\n    fi\n\n    # Get reserved ports from docker labels\n    local reserved_ports\n    reserved_ports=$(docker --context containai-docker ps -a \\\n        --filter \"label=containai.ssh-port\" \\\n        --format '{{.Label \"containai.ssh-port\"}}' 2>/dev/null | sort -u || true)\n\n    # Also check port files from cai (shared directory)\n    for f in \"$port_dir\"/*; do\n        [[ -f \"$f\" ]] && reserved_ports=\"$reserved_ports\"$'\\n'\"$(cat \"$f\")\"\n    done\n\n    # Cross-platform port-in-use check\n    is_port_in_use() {\n        local port=\"$1\"\n        if command -v ss &>/dev/null; then\n            ss -tln 2>/dev/null | grep -q \":$port \" && return 0\n        elif command -v lsof &>/dev/null; then\n            lsof -iTCP:\"$port\" -sTCP:LISTEN &>/dev/null && return 0\n        fi\n        return 1\n    }\n\n    # Find next available port in range 2400-2499 (devcontainer range)\n    local port\n    for port in $(seq 2400 2499); do\n        if ! echo \"$reserved_ports\" | grep -qw \"$port\" && ! is_port_in_use \"$port\"; then\n            printf '%s' \"$port\" > \"$port_file\"\n            printf '%s' \"$port\"\n            return\n        fi\n    done\n\n    # Fallback (should not happen with 100 ports available)\n    printf '2322'\n}\n\n# Update SSH config via ~/.ssh/containai.d/ (reuses existing pattern)\nupdate_ssh_config() {\n    local workspace_name=\"$1\"\n    local ssh_port=\"$2\"\n    local host_alias=\"containai-devcontainer-${workspace_name}\"\n    local ssh_dir=\"$HOME/.ssh/containai.d\"\n    local config_file=\"$ssh_dir/devcontainer-${workspace_name}\"\n\n    mkdir -p \"$ssh_dir\"\n    chmod 700 \"$ssh_dir\"\n\n    # Ensure Include directive exists in main config\n    local main_config=\"$HOME/.ssh/config\"\n    if ! grep -q 'Include containai.d/\\*' \"$main_config\" 2>/dev/null; then\n        printf 'Include containai.d/*\\n\\n%s' \"$(cat \"$main_config\" 2>/dev/null || true)\" > \"$main_config\"\n        chmod 600 \"$main_config\"\n    fi\n\n    # Write workspace-specific config\n    cat > \"$config_file\" << EOF\n# ContainAI devcontainer: $workspace_name\nHost $host_alias\n    HostName localhost\n    Port $ssh_port\n    User vscode\nEOF\n    chmod 600 \"$config_file\"\n    printf 'SSH: ssh %s\\n' \"$host_alias\" >&2\n}\n\n# Check if this is a docker create/run command\nis_container_create_command() {\n    for arg in \"$@\"; do\n        case \"$arg\" in\n            create|run) return 0 ;;\n            container) continue ;;  # docker container create/run\n            -*)  continue ;;\n            *) return 1 ;;\n        esac\n    done\n    return 1\n}\n\nmain() {\n    # Only intercept docker create/run commands\n    if ! is_container_create_command \"$@\"; then\n        exec docker \"$@\"\n    fi\n\n    # Extract VS Code devcontainer labels\n    local labels\n    labels=$(extract_devcontainer_labels \"$@\")\n    local config_file local_folder\n    config_file=$(echo \"$labels\" | head -1)\n    local_folder=$(echo \"$labels\" | tail -1)\n\n    # Check if this is a ContainAI devcontainer\n    if [[ -z \"$config_file\" ]] || ! has_containai_feature \"$config_file\"; then\n        exec docker \"$@\"\n    fi\n\n    # Verify containai-docker context exists\n    if ! docker context inspect containai-docker &>/dev/null; then\n        cat >&2 <<'EOF'\n\u2554\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2557\n\u2551  ContainAI: Not set up. Run: cai setup                            \u2551\n\u255a\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u255d\nEOF\n        exit 1\n    fi\n\n    local workspace_name\n    workspace_name=$(basename \"$local_folder\")\n\n    local data_volume\n    data_volume=$(get_data_volume \"$config_file\")\n\n    # IMPORTANT: Acquire port lock and HOLD IT across allocation + docker exec\n    # This prevents races with concurrent cai commands\n    # The lock is released when docker exec replaces this process (or on error exit)\n    local config_dir=\"${XDG_CONFIG_HOME:-$HOME/.config}/containai\"\n    local lock_file=\"$config_dir/.ssh-port.lock\"\n    mkdir -p \"$config_dir\"\n\n    # Acquire lock (held until exec or exit)\n    # Linux: flock coordinates with cai\n    # macOS: flock not available - V1 LIMITATION (see below)\n    if command -v flock &>/dev/null; then\n        exec 200>\"$lock_file\"\n        flock -w 10 200 || {\n            printf 'Warning: Could not acquire port lock\\n' >&2\n        }\n    fi\n    # V1 LIMITATION (macOS): Without flock, concurrent cai + cai-docker\n    # operations may race on port allocation. Mitigation: port files provide\n    # best-effort coordination. Full fix requires V2 enhancement to cai.\n\n    local ssh_port\n    ssh_port=$(allocate_ssh_port \"$workspace_name\")\n\n    # Check enableCredentials from devcontainer.json\n    local enable_credentials\n    enable_credentials=$(strip_jsonc_comments < \"$config_file\" | \\\n        python3 -c \"import sys,json; d=json.load(sys.stdin); print(d.get('features',{}).get('ghcr.io/novotnyllc/containai/feature:latest',{}).get('enableCredentials','false'))\" 2>/dev/null || echo \"false\")\n\n    # Validate volume for credentials (defense-in-depth)\n    local mount_volume=true\n    if [[ \"$enable_credentials\" != \"true\" ]]; then\n        # Check for no-secrets marker in volume\n        if ! docker --context containai-docker run --rm -v \"${data_volume}:/vol:ro\" alpine test -f /vol/.containai-no-secrets 2>/dev/null; then\n            printf 'Warning: Volume %s may contain credentials.\\n' \"$data_volume\" >&2\n            printf 'Either set enableCredentials: true, or recreate with: cai import --no-secrets\\n' >&2\n            mount_volume=false\n        fi\n    fi\n\n    # Build modified args with injected options\n    local -a args=()\n    local found_create=false\n\n    for arg in \"$@\"; do\n        args+=(\"$arg\")\n\n        # Inject after run/create command\n        if [[ \"$arg\" == \"run\" || \"$arg\" == \"create\" ]]; then\n            found_create=true\n\n            # Enforce sysbox runtime at launch time\n            args+=(\"--runtime=sysbox-runc\")\n\n            # Mount data volume if validated\n            if [[ \"$mount_volume\" == \"true\" ]] && docker --context containai-docker volume inspect \"$data_volume\" &>/dev/null; then\n                args+=(\"-v\" \"${data_volume}:/mnt/agent-data:rw\")\n            fi\n\n            # Pass SSH port to container via env var\n            args+=(\"-e\" \"CONTAINAI_SSH_PORT=${ssh_port}\")\n\n            # Labels for cai ps/stop/gc integration (complete set)\n            args+=(\"--label\" \"containai.managed=true\")\n            args+=(\"--label\" \"containai.type=devcontainer\")\n            args+=(\"--label\" \"containai.devcontainer.workspace=${workspace_name}\")\n            args+=(\"--label\" \"containai.data-volume=${data_volume}\")\n            args+=(\"--label\" \"containai.ssh-port=${ssh_port}\")\n            args+=(\"--label\" \"containai.created=$(date -u +%Y-%m-%dT%H:%M:%SZ)\")\n        fi\n    done\n\n    # Update SSH config\n    update_ssh_config \"$workspace_name\" \"$ssh_port\"\n\n    # Execute with containai-docker context\n    exec docker --context containai-docker \"${args[@]}\"\n}\n\nmain \"$@\"\n```\n\n**Portability notes**:\n- Uses `date -u +%Y-%m-%dT%H:%M:%SZ` (POSIX portable) instead of `date -Iseconds` (GNU only)\n- SSH config via `~/.ssh/containai.d/` with Include (avoids brittle sed block edits)\n- JSONC parsing via python3 state machine (not sed which breaks on strings)\n\n**V1 Limitations**:\n- Docker CLI only (not docker-compose)\n- No compose-aware injection\n\n---\n\n### 2. VS Code Extension (`vscode-containai`)\n\n**Distribution**:\n- VS Code Marketplace\n- Open VSX\n- Installed by `cai setup`\n\n**Purpose**: Set `dev.containers.dockerPath` when ContainAI feature detected.\n\n```typescript\nimport * as vscode from 'vscode';\nimport * as fs from 'fs';\nimport * as path from 'path';\nimport { parse as parseJSONC } from 'jsonc-parser';  // Proper JSONC parser (npm package)\n\nexport function activate(context: vscode.ExtensionContext) {\n    const workspaceFolder = vscode.workspace.workspaceFolders?.[0];\n    if (!workspaceFolder) return;\n\n    const devcontainerPath = findDevcontainerJson(workspaceFolder.uri.fsPath);\n    if (!devcontainerPath) return;\n\n    if (hasContainAIFeature(devcontainerPath)) {\n        const caiDockerPath = findCaiDocker();\n        if (caiDockerPath) {\n            vscode.workspace.getConfiguration('dev.containers').update(\n                'dockerPath',\n                caiDockerPath,\n                vscode.ConfigurationTarget.Workspace\n            );\n            vscode.window.showInformationMessage(\n                'ContainAI: Devcontainer will run in sysbox sandbox.'\n            );\n        } else {\n            vscode.window.showWarningMessage(\n                'ContainAI feature detected but cai not installed. ' +\n                'Run: curl -fsSL https://containai.dev/install | sh'\n            );\n        }\n    }\n}\n\n// Use proper JSONC parser - DO NOT use regex-based comment stripping\n// which fails on comment-like sequences in strings\nfunction hasContainAIFeature(devcontainerPath: string): boolean {\n    const content = fs.readFileSync(devcontainerPath, 'utf8');\n    const parsed = parseJSONC(content);\n    const features = parsed?.features || {};\n    return Object.keys(features).some(key => key.includes('containai'));\n}\n\nfunction findCaiDocker(): string | null {\n    const candidates = [\n        path.join(process.env.HOME || '', '.local/bin/cai-docker'),\n        '/usr/local/bin/cai-docker'\n    ];\n    return candidates.find(p => fs.existsSync(p)) || null;\n}\n```\n\n---\n\n### 3. ContainAI Feature\n\n**Distribution**: `ghcr.io/novotnyllc/containai/feature:latest`\n\n**devcontainer-feature.json**:\n```json\n{\n    \"id\": \"containai\",\n    \"version\": \"1.0.0\",\n    \"name\": \"ContainAI Sysbox Sandbox\",\n    \"description\": \"ContainAI experience: sysbox verification, data sync (no creds by default), SSH, DinD\",\n    \"documentationURL\": \"https://github.com/novotnyllc/containai\",\n    \"options\": {\n        \"dataVolume\": {\n            \"type\": \"string\",\n            \"default\": \"sandbox-agent-data\",\n            \"description\": \"Name of cai data volume to mount\"\n        },\n        \"enableCredentials\": {\n            \"type\": \"boolean\",\n            \"default\": false,\n            \"description\": \"SECURITY: Sync credential files (GH tokens, Claude API keys). Only enable for trusted repos.\"\n        },\n        \"enableSsh\": {\n            \"type\": \"boolean\",\n            \"default\": true,\n            \"description\": \"Run sshd for non-VS Code access\"\n        },\n        \"installDocker\": {\n            \"type\": \"boolean\",\n            \"default\": true,\n            \"description\": \"Install Docker for DinD (starts in postStartCommand)\"\n        },\n        \"remoteUser\": {\n            \"type\": \"string\",\n            \"default\": \"auto\",\n            \"description\": \"User for symlinks (auto-detects vscode/node/root)\"\n        }\n    },\n    \"mounts\": [],\n    \"postCreateCommand\": \"/usr/local/share/containai/init.sh\",\n    \"postStartCommand\": \"/usr/local/share/containai/start.sh\"\n}\n```\n\n**install.sh** (runs at build time):\n\n**Platform support**: Debian/Ubuntu only in V1. Clear error on other distros.\n\n```bash\n#!/usr/bin/env bash\nset -euo pipefail\n\nDATA_VOLUME=\"${DATAVOLUME:-sandbox-agent-data}\"\nENABLE_CREDENTIALS=\"${ENABLECREDENTIALS:-false}\"\nENABLE_SSH=\"${ENABLESSH:-true}\"\nINSTALL_DOCKER=\"${INSTALLDOCKER:-true}\"\nREMOTE_USER=\"${REMOTEUSER:-auto}\"\n\n# \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n# PLATFORM CHECK (Debian/Ubuntu only in V1)\n# \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\nif ! command -v apt-get &>/dev/null; then\n    cat >&2 <<'ERROR'\n\u2554\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2557\n\u2551  ContainAI feature requires Debian/Ubuntu base image              \u2551\n\u2551  Alpine, Fedora, and other distros not yet supported              \u2551\n\u255a\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u255d\nERROR\n    exit 1\nfi\n\nmkdir -p /usr/local/share/containai\n\n# Store config for runtime scripts\ncat > /usr/local/share/containai/config << EOF\nDATA_VOLUME=\"$DATA_VOLUME\"\nENABLE_CREDENTIALS=\"$ENABLE_CREDENTIALS\"\nENABLE_SSH=\"$ENABLE_SSH\"\nREMOTE_USER=\"$REMOTE_USER\"\nEOF\n\n# \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n# SYSBOX VERIFICATION\n# Threat model: Defense-in-depth. The wrapper enforces --runtime=sysbox-runc\n# at launch, and this script verifies kernel-level sysbox indicators.\n# The sysboxfs check is MANDATORY (sysbox-unique, cannot be faked).\n# \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n\ncat > /usr/local/share/containai/verify-sysbox.sh << 'VERIFY_EOF'\n#!/usr/bin/env bash\nset -euo pipefail\n\nverify_sysbox() {\n    local passed=0\n    local sysboxfs_found=false\n\n    printf 'ContainAI Sysbox Verification\\n'\n    printf '\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\\n'\n\n    # MANDATORY CHECK: Sysbox-fs mounts (sysbox-unique, cannot be faked)\n    # This check MUST pass - it's the definitive sysbox indicator\n    if grep -qE 'sysboxfs|fuse\\.sysbox' /proc/mounts 2>/dev/null; then\n        sysboxfs_found=true\n        ((passed++))\n        printf '  \u2713 Sysboxfs: mounted (REQUIRED)\\n'\n    else\n        printf '  \u2717 Sysboxfs: not found (REQUIRED)\\n'\n    fi\n\n    # Check 2: UID mapping (sysbox maps 0 \u2192 high UID)\n    if [[ -f /proc/self/uid_map ]]; then\n        if ! grep -qE '^[[:space:]]*0[[:space:]]+0[[:space:]]' /proc/self/uid_map; then\n            ((passed++))\n            printf '  \u2713 UID mapping: sysbox user namespace\\n'\n        else\n            printf '  \u2717 UID mapping: 0\u21920 (not sysbox)\\n'\n        fi\n    fi\n\n    # Check 3: Nested user namespace (sysbox allows, docker blocks)\n    if unshare --user --map-root-user true 2>/dev/null; then\n        ((passed++))\n        printf '  \u2713 Nested userns: allowed\\n'\n    else\n        printf '  \u2717 Nested userns: blocked\\n'\n    fi\n\n    # Check 4: CAP_SYS_ADMIN works (sysbox userns)\n    local testdir\n    testdir=$(mktemp -d)\n    if mount -t tmpfs none \"$testdir\" 2>/dev/null; then\n        umount \"$testdir\" 2>/dev/null\n        ((passed++))\n        printf '  \u2713 Capabilities: CAP_SYS_ADMIN works\\n'\n    else\n        printf '  \u2717 Capabilities: mount denied\\n'\n    fi\n    rmdir \"$testdir\" 2>/dev/null || true\n\n    printf '\\nPassed: %d checks\\n' \"$passed\"\n\n    # HARD REQUIREMENT: sysboxfs MUST be present\n    # This is the sysbox-unique predicate that cannot be faked\n    if [[ \"$sysboxfs_found\" != \"true\" ]]; then\n        printf 'FAIL: sysboxfs not detected (mandatory for sysbox)\\n' >&2\n        return 1\n    fi\n\n    # Also require at least 2 other checks for defense-in-depth\n    [[ $passed -ge 3 ]]\n}\n\nif ! verify_sysbox; then\n    cat >&2 <<'ERROR'\n\n\u2554\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2557\n\u2551  \ud83d\uded1 ContainAI: NOT running in sysbox                              \u2551\n\u2551                                                                   \u2551\n\u2551  The wrapper should enforce --runtime=sysbox-runc at launch.      \u2551\n\u2551  If you see this, the devcontainer was started incorrectly.       \u2551\n\u2551                                                                   \u2551\n\u2551  To fix:                                                          \u2551\n\u2551    1. Install ContainAI: curl -fsSL https://containai.dev | sh    \u2551\n\u2551    2. Run: cai setup                                              \u2551\n\u2551    3. Ensure VS Code uses cai-docker wrapper                      \u2551\n\u2551    4. Reopen this devcontainer                                    \u2551\n\u255a\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u255d\nERROR\n    exit 1\nfi\nprintf '\u2713 Running in sysbox sandbox\\n'\nVERIFY_EOF\nchmod +x /usr/local/share/containai/verify-sysbox.sh\n\n# \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n# INIT SCRIPT (postCreateCommand - runs once after container created)\n# Uses existing link-spec.json and link-repair.sh from ContainAI\n# NO DUPLICATE SYMLINK LISTS - reads from canonical source\n# \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n\ncat > /usr/local/share/containai/init.sh << 'INIT_EOF'\n#!/usr/bin/env bash\nset -euo pipefail\n\n# shellcheck source=/dev/null\nsource /usr/local/share/containai/config\n\n# Verify sysbox first\n/usr/local/share/containai/verify-sysbox.sh || exit 1\n\nDATA_DIR=\"/mnt/agent-data\"\nLINK_SPEC=\"/usr/local/lib/containai/link-spec.json\"\n\n# Detect user home\nif [[ \"$REMOTE_USER\" == \"auto\" ]]; then\n    if [[ -d /home/vscode ]]; then\n        USER_HOME=\"/home/vscode\"\n    elif [[ -d /home/node ]]; then\n        USER_HOME=\"/home/node\"\n    else\n        USER_HOME=\"$HOME\"\n    fi\nelse\n    USER_HOME=\"/home/$REMOTE_USER\"\nfi\n\nprintf 'ContainAI init: Setting up symlinks in %s\\n' \"$USER_HOME\"\n\n# Only set up symlinks if data volume is mounted\nif [[ ! -d \"$DATA_DIR\" ]]; then\n    printf 'Warning: Data volume not mounted at %s\\n' \"$DATA_DIR\"\n    printf 'Run \"cai import\" on host, then rebuild container with dataVolume option\\n'\n    exit 0\nfi\n\n# \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n# Use existing link-repair.sh from ContainAI (no duplicate manifest)\n# The feature install copies link-spec.json to /usr/local/lib/containai/\n# \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\n# List of credential-bearing files to SKIP unless enableCredentials=true\n# These contain tokens/API keys that should not be exposed to untrusted code\nCREDENTIAL_TARGETS=(\n    \"/mnt/agent-data/config/gh/hosts.yml\"        # GitHub token\n    \"/mnt/agent-data/claude/credentials.json\"    # Claude API key\n    \"/mnt/agent-data/codex/config.toml\"          # May contain keys\n    \"/mnt/agent-data/gemini/settings.json\"       # May contain keys\n)\n\nis_credential_file() {\n    local target=\"$1\"\n    for cred in \"${CREDENTIAL_TARGETS[@]}\"; do\n        [[ \"$target\" == \"$cred\" ]] && return 0\n    done\n    return 1\n}\n\n# Check if link-spec.json exists\nif [[ ! -f \"$LINK_SPEC\" ]]; then\n    printf 'Warning: link-spec.json not found at %s\\n' \"$LINK_SPEC\"\n    printf 'Feature may not be fully installed\\n'\n    exit 0\nfi\n\n# Get home_dir from link-spec.json (usually /home/agent in container images)\nSPEC_HOME=$(jq -r '.home_dir // \"/home/agent\"' \"$LINK_SPEC\")\n\n# Process links from link-spec.json using jq\nlinks_count=$(jq -r '.links | length' \"$LINK_SPEC\")\n\nfor i in $(seq 0 $((links_count - 1))); do\n    link=$(jq -r \".links[$i].link\" \"$LINK_SPEC\")\n    target=$(jq -r \".links[$i].target\" \"$LINK_SPEC\")\n    remove_first=$(jq -r \".links[$i].remove_first // false\" \"$LINK_SPEC\")\n\n    # Skip credential files unless explicitly enabled\n    if [[ \"$ENABLE_CREDENTIALS\" != \"true\" ]] && is_credential_file \"$target\"; then\n        printf '  \u2298 %s (credentials disabled)\\n' \"$link\"\n        continue\n    fi\n\n    # Rewrite link path from spec's home_dir to detected USER_HOME\n    # e.g., /home/agent/.config -> /home/vscode/.config\n    link=\"${link/$SPEC_HOME/$USER_HOME}\"\n\n    # Skip if target doesn't exist\n    [[ -e \"$target\" ]] || continue\n\n    # Create parent directory\n    mkdir -p \"$(dirname \"$link\")\"\n\n    # Handle remove_first for directories (ln -sfn can't replace directories)\n    if [[ -d \"$link\" && ! -L \"$link\" ]]; then\n        if [[ \"$remove_first\" == \"true\" || \"$remove_first\" == \"1\" ]]; then\n            rm -rf \"$link\"\n        else\n            printf '  \u2717 %s (directory exists, remove_first not set)\\n' \"$link\" >&2\n            continue\n        fi\n    fi\n\n    # Create symlink (ln -sfn handles existing files/symlinks)\n    if ln -sfn \"$target\" \"$link\" 2>/dev/null; then\n        printf '  \u2713 %s \u2192 %s\\n' \"$link\" \"$target\"\n    else\n        printf '  \u2717 %s (failed)\\n' \"$link\" >&2\n    fi\ndone\n\nprintf 'ContainAI init complete\\n'\nINIT_EOF\nchmod +x /usr/local/share/containai/init.sh\n\n# \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n# START SCRIPT (postStartCommand - runs every container start)\n# Handles: sysbox verification, sshd, dockerd (DinD)\n# \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n\ncat > /usr/local/share/containai/start.sh << 'START_EOF'\n#!/usr/bin/env bash\nset -euo pipefail\n\n# shellcheck source=/dev/null\nsource /usr/local/share/containai/config\n\n# Re-verify sysbox first (in case container was restarted on different host)\n/usr/local/share/containai/verify-sysbox.sh || exit 1\n\n# \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n# Start sshd if enabled (devcontainer-style, not systemd)\n# Port is dynamically allocated by the wrapper, check container labels\n# \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\nif [[ \"$ENABLE_SSH\" == \"true\" ]]; then\n    if command -v sshd &>/dev/null; then\n        # Generate host keys if missing\n        [[ -f /etc/ssh/ssh_host_rsa_key ]] || ssh-keygen -A\n\n        # Get SSH port from container label or default\n        SSH_PORT=\"${CONTAINAI_SSH_PORT:-2322}\"\n\n        # Check if already running\n        if [[ -f /tmp/sshd.pid ]] && kill -0 \"$(cat /tmp/sshd.pid)\" 2>/dev/null; then\n            printf '\u2713 sshd already running on port %s\\n' \"$SSH_PORT\"\n        else\n            /usr/sbin/sshd -p \"$SSH_PORT\" -o \"PidFile=/tmp/sshd.pid\"\n            printf '\u2713 sshd started on port %s\\n' \"$SSH_PORT\"\n        fi\n    fi\nfi\n\n# \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n# Start dockerd for DinD (if Docker installed and not already running)\n# Sysbox provides the isolation, no --privileged needed\n# \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\nstart_dockerd() {\n    local pidfile=\"/var/run/docker.pid\"\n    local logfile=\"/var/log/containai-dockerd.log\"\n    local retries=30\n\n    # Already running?\n    if [[ -f \"$pidfile\" ]] && kill -0 \"$(cat \"$pidfile\")\" 2>/dev/null; then\n        printf '\u2713 dockerd already running\\n'\n        return 0\n    fi\n\n    # Start dockerd in background\n    printf 'Starting dockerd...\\n'\n    nohup dockerd --pidfile=\"$pidfile\" > \"$logfile\" 2>&1 &\n\n    # Wait for socket\n    local i=0\n    while [[ $i -lt $retries ]]; do\n        if docker info &>/dev/null; then\n            printf '\u2713 dockerd started (DinD ready)\\n'\n            return 0\n        fi\n        sleep 1\n        ((i++))\n    done\n\n    printf '\u2717 dockerd failed to start (see %s)\\n' \"$logfile\" >&2\n    return 1\n}\n\nif command -v dockerd &>/dev/null; then\n    start_dockerd || printf 'Warning: DinD not available\\n' >&2\nfi\n\nprintf '\u2713 ContainAI devcontainer ready\\n'\nSTART_EOF\nchmod +x /usr/local/share/containai/start.sh\n\n# \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n# INSTALL DEPENDENCIES\n# \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n\n# Install jq for JSON parsing (required for link-spec.json)\napt-get update && apt-get install -y jq\n\n# SSH server (if enabled)\nif [[ \"$ENABLE_SSH\" == \"true\" ]]; then\n    apt-get install -y openssh-server\n    mkdir -p /var/run/sshd\nfi\n\n# Docker for DinD (sysbox provides isolation)\n# Note: dockerd startup happens in postStartCommand, not here\nif [[ \"$INSTALL_DOCKER\" == \"true\" ]]; then\n    curl -fsSL https://get.docker.com | sh\n    # Add devcontainer user to docker group (vscode/node/root)\n    if id -u vscode &>/dev/null; then\n        usermod -aG docker vscode\n    elif id -u node &>/dev/null; then\n        usermod -aG docker node\n    fi\n    printf 'Docker installed. DinD starts via postStartCommand.\\n'\nfi\n\n# Copy link-spec.json from ContainAI (if available in image or fetch)\n# This allows symlink creation without hardcoded paths\nmkdir -p /usr/local/lib/containai\nif [[ -f /usr/local/lib/containai/link-spec.json ]]; then\n    printf 'link-spec.json already present\\n'\nelse\n    # Fetch from release or use bundled version\n    printf 'Note: link-spec.json should be bundled with feature\\n'\nfi\n\nprintf 'ContainAI feature installed.\\n'\n```\n\n---\n\n## Detection Matrix\n\n| Scenario              | Sysboxfs | UID Map | unshare | Cap Probe | Total | Result |\n|-----------------------|----------|---------|---------|-----------|-------|--------|\n| Sysbox (correct)      | \u2713 (REQ)  | \u2713       | \u2713       | \u2713         | 4     | PASS   |\n| Regular docker        | \u2717        | \u2717       | \u2717       | \u2717         | 0     | FAIL   |\n| Docker --privileged   | \u2717        | \u2717       | \u2713       | \u2713         | 2     | FAIL   |\n| userns-remap + --priv | \u2717        | \u2713       | \u2713       | \u2713         | 3     | FAIL   |\n\n**Verification requirements**:\n1. **Sysboxfs MANDATORY**: The sysboxfs mount check MUST pass (sysbox-unique indicator)\n2. **Defense-in-depth**: At least 3 total checks must pass\n\n**Why sysboxfs is unforgeable**:\n- Sysbox-fs is a FUSE filesystem implemented by sysbox-fs daemon\n- It intercepts specific procfs/sysfs reads to provide VM-like behavior\n- Only sysbox-runc can set up these mounts - no userspace bypass possible\n- Even with userns-remap + --privileged, you cannot fake sysboxfs mounts\n\n**Defense-in-depth**: The wrapper ALSO enforces `--runtime=sysbox-runc` at launch time, so even if verification could somehow be bypassed, the container cannot start without sysbox.\n\n---\n\n## User Flows\n\n### Flow A: New devcontainer with ContainAI\n\n1. User has `cai setup` done (one-time)\n2. User adds ContainAI feature to devcontainer.json:\n   ```json\n   {\n       \"image\": \"mcr.microsoft.com/devcontainers/python:3.11\",\n       \"features\": {\n           \"ghcr.io/novotnyllc/containai/feature:latest\": {}\n       }\n   }\n   ```\n3. VS Code extension detects feature, sets dockerPath to cai-docker\n4. User clicks \"Reopen in Container\"\n5. cai-docker routes to containai-docker context (sysbox runtime)\n6. Container starts **directly in sysbox**\n7. postStartCommand verifies sysbox, passes\n8. User works in secure sandbox\n\n### Flow B: User without cai tries to open ContainAI devcontainer\n\n1. User opens repo with ContainAI feature\n2. VS Code extension warns: \"cai not installed\"\n3. User clicks \"Reopen in Container\" anyway\n4. Regular docker runs container (not sysbox)\n5. postStartCommand runs verify-sandbox.sh\n6. Kernel checks fail (UID map 0\u21920, unshare blocked, no sysboxfs)\n7. **Hard-fail with clear error message**\n8. User installs cai, reopens\n\n### Flow C: Attacker tries to bypass\n\n```bash\n# None of these work:\ndocker run --env FAKE_SYSBOX=1 ...           # We don't check env vars\ndocker run --privileged ...                   # Only 2/4 checks pass\ndocker run --cap-add=ALL ...                  # Still not sysbox\n```\n\nThe checks are kernel-enforced. No userspace bypass possible.\n\n---\n\n## containai-docker Context Setup\n\n**Important**: Reuse existing platform-specific context logic from `cai setup`. Do NOT hardcode Unix socket.\n\nThe `containai-docker` context is already set up by `cai setup` with platform-specific endpoints:\n- **WSL2**: SSH bridge to WSL2 Docker daemon\n- **macOS/Lima**: Socket to Lima VM\n- **Native Linux**: Unix socket to local Docker daemon\n\nThe wrapper uses `--runtime=sysbox-runc` to enforce sysbox at launch time, regardless of context endpoint:\n\n```bash\n# Wrapper enforces runtime, context handles connection\nexec docker --context containai-docker --runtime=sysbox-runc \"${args[@]}\"\n```\n\n**daemon.json** (configured by `cai setup`, not by devcontainer wrapper):\n```json\n{\n    \"runtimes\": {\n        \"sysbox-runc\": {\n            \"path\": \"/usr/bin/sysbox-runc\"\n        }\n    }\n}\n```\n\nThe context creation is handled by existing functions:\n- `_cai_setup_containai_docker_context()`\n- `_cai_auto_repair_containai_context()`\n- `_cai_expected_docker_host()`\n\n---\n\n## Implementation Phases\n\n**1.1 cai-docker wrapper**\n- [ ] Marker detection in devcontainer.json\n- [ ] Context routing logic\n- [ ] Install via `cai setup`\n\n**1.2 ContainAI feature**\n- [ ] Feature structure (devcontainer-feature.json, install.sh)\n- [ ] Sysbox verification script (kernel checks)\n- [ ] Optional Docker installation\n- [ ] Publish to ghcr.io\n\n**1.3 VS Code extension**\n- [ ] Activate on devcontainer.json presence\n- [ ] Detect ContainAI markers\n- [ ] Set dockerPath to cai-docker\n- [ ] Publish to VS Code Marketplace + Open VSX\n\n### Phase 2: Testing\n- [ ] Test: Sysbox \u2192 verification passes\n- [ ] Test: Regular docker \u2192 verification fails\n- [ ] Test: --privileged \u2192 verification fails (only 2 checks)\n- [ ] Test: VS Code extension sets dockerPath\n- [ ] Test: DinD works inside sysbox devcontainer\n\n### Phase 3: Polish\n\n- [ ] Documentation: \"Adding ContainAI to your devcontainer\"\n- [ ] Template examples\n- [ ] `cai doctor` checks for devcontainer compatibility\n\n---\n\n## Resolved Design Decisions\n\n1. **No outer container**: Devcontainer runs directly in sysbox\n2. **No env vars**: Kernel checks only (can't be faked)\n3. **No cryptographic verification**: Not needed when running directly in sysbox\n4. **Hard-block on failure**: No \"reduced isolation\" mode\n5. **Extension distribution**: cai setup + marketplaces\n\n---\n\n## Acceptance Criteria\n\n### Core\n- [ ] cai-docker detects ContainAI devcontainers via VS Code labels (not --workspace-folder)\n- [ ] cai-docker enforces `--runtime=sysbox-runc` at launch time\n- [ ] cai-docker routes to existing containai-docker context (platform-specific)\n- [ ] ContainAI feature installs on Debian/Ubuntu base images (clear error on others)\n- [ ] Verification requires sysboxfs mount (mandatory) + 2 other checks\n- [ ] Hard-fail with clear message when not in sysbox\n\n### Security\n- [ ] Credentials NOT synced by default (`enableCredentials: false`)\n- [ ] Sysbox devcontainers pass verification (sysboxfs + 3 total)\n- [ ] Regular docker fails verification (no sysboxfs)\n- [ ] userns-remap + --privileged fails (no sysboxfs)\n- [ ] No env var or userspace bypass possible\n\n### VS Code Extension\n- [ ] Detects ContainAI feature via proper JSONC parsing\n- [ ] Sets dockerPath automatically\n- [ ] Published to VS Code Marketplace and Open VSX\n\n### Integration\n- [ ] Labels include complete set: `containai.managed`, `containai.data-volume`, `containai.ssh-port`\n- [ ] SSH ports dynamically allocated (checks existing ports, not fixed 2322)\n- [ ] SSH port passed to container via `-e CONTAINAI_SSH_PORT=<port>`\n- [ ] SSH config via `~/.ssh/containai.d/` with Include directive\n- [ ] Uses portable timestamps (`date -u +%Y-%m-%dT%H:%M:%SZ`)\n- [ ] DinD starts via postStartCommand with retry/idempotency\n- [ ] link-spec.json paths rewritten from `/home/agent` to detected user home\n- [ ] `remove_first` handled for directory symlinks\n\n### V1 Scope\n- [ ] Docker CLI only (not docker-compose)\n- [ ] Debian/Ubuntu only (clear error on other distros)\n- [ ] Task 8 (Docker context sync) DEFERRED - no clear V1 use case\n- [ ] Task 9 (VS Code server-env-setup) DEFERRED - depends on task 8\n\n### V1 Known Limitations\n- **macOS port allocation race**: On macOS, `flock` is not available. Concurrent `cai` and `cai-docker` operations may race on SSH port allocation. Mitigation: port reservation files provide best-effort coordination. Full fix requires V2 enhancement where `cai` reads shared port files.\n\n### Task Dependencies\n- [ ] Task 10 (Add no-secrets marker to cai import) - must complete before task 1 can validate credentials\n- Task 1 depends on: Task 10\n- Tasks 1, 2 can run in parallel after Task 10\n- Task 3 can run independently\n\n---\n\n## Docker Context Sync Architecture\n\n**STATUS: DEFERRED (V2)**\n\nThe original rationale for syncing Docker contexts between host and container is unclear for the devcontainer use case:\n\n- **DinD in devcontainer**: The container runs its own dockerd, so it doesn't need host contexts\n- **Host Docker access**: Devcontainers typically don't need to talk to the host Docker daemon\n- **Context complexity**: Syncing contexts adds complexity without clear benefit\n\n**Recommendation**: Cut this from V1. If a concrete use case emerges (e.g., \"I need to manage host containers from within devcontainer\"), implement it then with clear requirements.\n\nIf needed in V2, the approach would be:\n- One-time sync during setup (not continuous watcher)\n- Explicit user opt-in via feature option\n- Clear documentation of the use case\n\n---\n\n## VS Code Server Environment Setup\n\nVS Code Remote (Server) needs `DOCKER_CONFIG` set to use the ContainAI Docker configuration. This is done via server-env-setup scripts.\n\n### Scripts\n\n**Location**: Both scripts go in the user's home directory and must be executable.\n\n**`~/.vscode-server/server-env-setup`**:\n```bash\n#!/bin/bash\nexport DOCKER_CONFIG=\"$HOME/.docker-cai\"\n```\n\n**`~/.vscode-insiders/server-env-setup`** (for VS Code Insiders):\n```bash\n#!/bin/bash\nexport DOCKER_CONFIG=\"$HOME/.docker-cai\"\n```\n\n### Script Requirements\n\n- Scripts must be `chmod +x`\n- Created by `cai setup` and/or the devcontainer feature\n- VS Code Server sources these before launching\n\n### Integration\n\nThese scripts ensure that when VS Code Server runs Docker commands (via Dev Containers extension), they use the ContainAI configuration which:\n- Points to `~/.docker-cai/contexts` for context resolution\n- Uses the Unix socket version of `containai-docker` context\n- Maintains proper isolation from host Docker contexts\n\n---\n\n## References\n\n- [Sysbox User Guide](https://github.com/nestybox/sysbox/tree/master/docs/user-guide)\n- [Dev Container Features](https://containers.dev/implementors/features/)\n- [fn-13-1c7 Research](../research/fn-13-1c7/RECOMMENDATIONS.md)\n"
  },
  "epic_id": "fn-49-devcontainer-integration",
  "schema_version": 2,
  "tasks": [
    {
      "data": {
        "assignee": null,
        "claim_note": "",
        "claimed_at": null,
        "created_at": "2026-02-02T23:23:51.209346Z",
        "depends_on": [],
        "epic": "fn-49-devcontainer-integration",
        "id": "fn-49-devcontainer-integration.1",
        "priority": null,
        "spec_path": ".flow/tasks/fn-49-devcontainer-integration.1.md",
        "status": "todo",
        "title": "Implement cai-docker wrapper",
        "updated_at": "2026-02-02T23:23:51.209360Z"
      },
      "id": "fn-49-devcontainer-integration.1",
      "runtime": {
        "assignee": "claire@novotny.org",
        "claim_note": "",
        "claimed_at": "2026-02-03T14:50:57.389011Z",
        "evidence": {
          "files_created": [
            "src/devcontainer/cai-docker",
            "tests/unit/test-cai-docker.sh"
          ],
          "lint": {
            "shellcheck": "pass"
          },
          "review": {
            "tool": "codex",
            "verdict": "SHIP"
          },
          "tests": [
            {
              "count": 27,
              "file": "tests/unit/test-cai-docker.sh",
              "passed": 27,
              "type": "unit"
            }
          ]
        },
        "status": "done",
        "updated_at": "2026-02-03T15:21:10.589430Z"
      },
      "spec": "# fn-49-devcontainer-integration.1 Implement cai-docker wrapper\n\n## Description\n\nCreate the smart docker wrapper (`cai-docker`) that detects ContainAI devcontainers and routes them to the sysbox runtime.\n\n### Location\n`src/devcontainer/cai-docker` (shell script)\n\n### Core Functions\n\n1. **Devcontainer detection via VS Code labels**: Parse `--label devcontainer.config_file=...` and `--label devcontainer.local_folder=...` from docker create/run args (NOT `--workspace-folder` which VS Code doesn't pass)\n2. **ContainAI marker detection**: Check for `containai` feature in devcontainer.json using proper JSONC parsing (python3 state machine, not sed)\n3. **Runtime enforcement**: Add `--runtime=sysbox-runc` to enforce sysbox at launch time\n4. **Credential validation**: When `enableCredentials=false`, validate volume has `.containai-no-secrets` marker; warn and skip mount if missing\n5. **Data volume injection**: Add `-v sandbox-agent-data:/mnt/agent-data:rw` (or configured volume) if validated\n6. **SSH port injection**: Pass allocated port to container via `-e CONTAINAI_SSH_PORT=<port>`\n7. **Label injection** (complete set):\n   - `containai.managed=true` (required for cai ps/stop/gc)\n   - `containai.type=devcontainer`\n   - `containai.devcontainer.workspace=<name>`\n   - `containai.data-volume=<volume>`\n   - `containai.ssh-port=<port>`\n   - `containai.created=<ISO8601-UTC>`\n8. **SSH config management**: Update `~/.ssh/containai.d/devcontainer-<workspace>` with dynamically allocated port (reuse existing SSH config patterns, check existing reserved ports)\n9. **Context routing**: Exec to `docker --context containai-docker`\n\n### Key Design Decisions\n\n**Detection mechanism**: VS Code Dev Containers passes labels like:\n- `--label devcontainer.config_file=/path/to/.devcontainer/devcontainer.json`\n- `--label devcontainer.local_folder=/path/to/workspace`\n\nParse these labels from the docker command args to locate the devcontainer.json.\n\n**JSONC parsing**: Use python3 with a proper state-machine comment stripper that handles:\n- `// line comments`\n- `/* block comments */`\n- Comment-like sequences inside JSON strings (e.g., `\"url\": \"https://example.com\"`)\n\nDo NOT use sed-based comment stripping which fails on edge cases.\n\n**SSH port allocation**: Use dynamic port allocation (range 2400-2499) with:\n- **Shared lock file**: Use `~/.config/containai/.ssh-port.lock` (SAME as `cai` uses) to coordinate with concurrent `cai` commands\n- **Lock held across allocation AND docker exec**: Acquire lock before allocation, hold it until `exec docker` replaces the process. This prevents races where `cai` could allocate the same port before the container is created and labeled.\n  - Linux: `flock` on FD 200 (inherited by exec) - FULL COORDINATION\n  - macOS: `flock` not available - V1 KNOWN LIMITATION (see below)\n- **Shared port directory**: Use `~/.config/containai/ports/` to share reservations with `cai`\n- **Cross-platform port check**: Use `ss` on Linux, `lsof` on macOS\n- **Correct context**: Query `containai-docker` context for existing `containai.ssh-port` labels, not default context\n\n**V1 Known Limitation (macOS)**: Without `flock`, concurrent `cai` and `cai-docker` operations may race on port allocation. Port reservation files provide best-effort coordination. Full fix requires V2 enhancement where `cai` reads shared port files.\n\n**Portability**:\n- Use `date -u +%Y-%m-%dT%H:%M:%SZ` (POSIX) instead of `date -Iseconds` (GNU only)\n- Use `~/.ssh/containai.d/<workspace>` with Include directive (not direct sed edits to ~/.ssh/config)\n\n### Installation Path\n- `~/.local/bin/cai-docker` (installed by `cai setup`)\n\n### V1 Limitations\n- Docker CLI only (not docker-compose)\n- No compose-aware injection\n\n## Acceptance\n\n- [ ] Detects ContainAI marker via VS Code labels (devcontainer.config_file, devcontainer.local_folder)\n- [ ] Parses JSONC correctly using python3 state machine (not sed)\n- [ ] Enforces `--runtime=sysbox-runc` at launch time\n- [ ] Routes to `containai-docker` context (reuses existing platform-specific context)\n- [ ] Passes through to regular docker when no ContainAI marker\n- [ ] Validates volume for credentials when `enableCredentials=false` (checks `.containai-no-secrets` marker)\n- [ ] Injects data volume mount only if validated (default: sandbox-agent-data)\n- [ ] Passes SSH port to container via `-e CONTAINAI_SSH_PORT=<port>`\n- [ ] Injects complete label set: `containai.managed`, `containai.type`, `containai.devcontainer.workspace`, `containai.data-volume`, `containai.ssh-port`, `containai.created`\n- [ ] Uses portable timestamp format (`date -u +%Y-%m-%dT%H:%M:%SZ`)\n- [ ] Dynamically allocates SSH port with:\n  - Shared lock file (`~/.config/containai/.ssh-port.lock`, same as `cai`)\n  - Lock held across allocation AND docker exec (prevents races)\n  - Linux: flock on FD inherited by exec (full coordination)\n  - macOS: best-effort via port files (V1 known limitation - no flock)\n  - Shared port directory (`~/.config/containai/ports/`)\n  - Cross-platform port check (`ss` on Linux, `lsof` on macOS)\n  - Queries `containai-docker` context for existing `containai.ssh-port` labels\n- [ ] Updates ~/.ssh/containai.d/ with Include directive pattern\n- [ ] Works with VS Code Dev Containers extension\n\n## Dependencies\n\n- **Depends on**: fn-49-devcontainer-integration.10 (Add no-secrets marker to cai import)\n\n## Done summary\n## Implementation Summary\n\nImplemented the `cai-docker` smart Docker wrapper for ContainAI devcontainers.\n\n### Key Features\n1. **Devcontainer detection via VS Code labels**: Parses `--label devcontainer.config_file=...` and `--label devcontainer.local_folder=...`\n2. **ContainAI marker detection**: Proper JSONC parsing via python3 state machine, specifically checking `.features` object\n3. **Runtime enforcement**: Adds `--runtime=sysbox-runc` at launch time\n4. **Credential validation**: Validates volume has `.containai-no-secrets` marker when `enableCredentials=false`\n5. **Data volume injection**: Uses `--mount type=volume` for explicit volume semantics; validates volume names (rejects paths)\n6. **SSH port injection**: Passes allocated port via `-e CONTAINAI_SSH_PORT=<port>`\n7. **Complete label set**: managed, type, workspace, data-volume, ssh-port, created\n8. **SSH config management**: Updates `~/.ssh/containai.d/` with Include directive at top\n9. **Context routing**: Routes to `containai-docker` context for ContainAI containers\n\n### Security Fixes\n- Volume name validation rejects paths and bind mount syntax\n- Workspace name sanitization for SSH config safety\n- As dockerPath wrapper, correctly handles argv without \"docker\" prefix\n\n### Files\n- `src/devcontainer/cai-docker` - Main wrapper (680 lines)\n- `tests/unit/test-cai-docker.sh` - Unit tests (27 tests, all passing)\n## Evidence\n- Commits:\n- Tests: {'type': 'unit', 'file': 'tests/unit/test-cai-docker.sh', 'count': 27, 'passed': 27}\n- PRs:\n"
    },
    {
      "data": {
        "assignee": null,
        "claim_note": "",
        "claimed_at": null,
        "created_at": "2026-02-03T21:49:10.331719Z",
        "depends_on": [
          "fn-49-devcontainer-integration.8"
        ],
        "epic": "fn-49-devcontainer-integration",
        "id": "fn-49-devcontainer-integration.10",
        "priority": null,
        "spec_path": ".flow/tasks/fn-49-devcontainer-integration.10.md",
        "status": "todo",
        "title": "Wire docker-context-sync into CLI lifecycle",
        "updated_at": "2026-02-03T21:51:12.522609Z"
      },
      "id": "fn-49-devcontainer-integration.10",
      "runtime": null,
      "spec": "# fn-49-devcontainer-integration.10 Wire docker-context-sync into CLI lifecycle\n\n## Description\nWire the existing `docker-context-sync.sh` library into the ContainAI CLI lifecycle. The watcher keeps Docker contexts synced continuously between `~/.docker/contexts` and `~/.docker-cai/contexts`.\n\n**Size:** M\n**Files:**\n- `src/containai.sh` (add to library loading)\n- `src/lib/setup.sh` (start watcher after context creation)\n- `src/lib/uninstall.sh` (stop watcher and cleanup)\n\n## Current State\n\nLibrary exists at `src/lib/docker-context-sync.sh` but is **not loaded or called anywhere**.\n\n## Integration Points\n\n### 1. Load the library (`src/containai.sh`)\n\nAdd to `_containai_libs_exist()` check (~line 77):\n```bash\n&& [[ -f \"$_CAI_SCRIPT_DIR/lib/docker-context-sync.sh\" ]]\n```\n\nAdd sourcing block after docker.sh (~line 184).\n\n### 2. Setup integration (`src/lib/setup.sh`)\n\nAfter Docker context creation in each platform setup function:\n- `_cai_setup_wsl2()` \n- `_cai_setup_linux()`\n- `_cai_setup_macos()`\n\n```bash\n# Initial sync then start watcher\n_cai_sync_docker_contexts_once \"$HOME/.docker/contexts\" \"$HOME/.docker-cai/contexts\" \"host-to-cai\"\n_cai_watch_docker_contexts  # runs in background\n```\n\n### 3. Uninstall integration (`src/lib/uninstall.sh`)\n\nBefore Docker context removal:\n```bash\n_cai_stop_docker_context_watcher\nrm -rf \"$HOME/.docker-cai\"\n```\n\n## Approach\n\nFollow existing patterns at:\n- `src/lib/setup.sh:4505-4555` for platform-specific integration\n- `src/lib/uninstall.sh:166-220` for cleanup pattern\n- `src/containai.sh:91-184` for library sourcing\n## Current State\n\nThe library exists at `src/lib/docker-context-sync.sh` with these functions:\n- `_cai_sync_docker_contexts_once()` - one-time bidirectional sync\n- `_cai_create_containai_docker_context()` - create container-local context\n- `_cai_watch_docker_contexts()` - start continuous watcher\n- `_cai_stop_docker_context_watcher()` - cleanup watcher\n\nBut it's **not loaded or called anywhere**.\n\n## Integration Points\n\n### 1. Load the library (`src/containai.sh`)\n\nAdd to `_containai_libs_exist()` check at line ~77:\n```bash\n&& [[ -f \"$_CAI_SCRIPT_DIR/lib/docker-context-sync.sh\" ]]\n```\n\nAdd sourcing block after line ~184 (after docker.sh, before setup.sh):\n```bash\n# shellcheck source=lib/docker-context-sync.sh\nif ! source \"$_CAI_SCRIPT_DIR/lib/docker-context-sync.sh\"; then ...\n```\n\n### 2. Setup integration (`src/lib/setup.sh`)\n\nCall after Docker context creation in platform-specific setup functions:\n- `_cai_setup_wsl2()` - after line ~2892\n- `_cai_setup_linux()` - after line ~4135  \n- `_cai_setup_macos()` - after line ~3572\n\nPattern:\n```bash\n# After context creation, sync existing contexts\n_cai_sync_docker_contexts_once \"$HOME/.docker/contexts\" \"$HOME/.docker-cai/contexts\" \"host-to-cai\"\n```\n\n**Note**: Don't start watcher during setup - adds complexity. One-time sync is sufficient for V1.\n\n### 3. Uninstall integration (`src/lib/uninstall.sh`)\n\nAdd before Docker context removal (before line ~637):\n```bash\n# Stop any running context watchers\n_cai_stop_docker_context_watcher\n\n# Remove synced context directory\nrm -rf \"$HOME/.docker-cai\"\n```\n\nDecision: `~/.docker-cai/` is **system state** (not user data), so remove it on uninstall.\n\n## Key Decisions\n\n1. **No auto-starting watcher** - One-time sync during setup is sufficient for V1\n2. **`~/.docker-cai/` removed on uninstall** - It's system state, not user data\n3. **Graceful degradation** - If sync tools unavailable, warn and continue\n4. **Follow dry-run pattern** - All operations must respect `--dry-run` flag\n\n## Approach\n\nFollow existing patterns at:\n- `src/lib/setup.sh:4505-4555` for platform-specific integration\n- `src/lib/uninstall.sh:166-220` for cleanup pattern\n- `src/containai.sh:91-184` for library sourcing pattern\n## Acceptance\n- [ ] `docker-context-sync.sh` sourced in `containai.sh`\n- [ ] `_containai_libs_exist()` includes the new library\n- [ ] `cai setup` does initial sync + starts watcher (all platforms)\n- [ ] `cai uninstall` stops watcher + removes `~/.docker-cai/`\n- [ ] Operations respect `--dry-run` flag\n- [ ] `shellcheck` passes\n- [ ] Existing tests pass\n## Done summary\nTBD\n\n## Evidence\n- Commits:\n- Tests:\n- PRs:\n"
    },
    {
      "data": {
        "created_at": "2026-02-02T23:23:51.851810Z",
        "depends_on": [],
        "epic": "fn-49-devcontainer-integration",
        "id": "fn-49-devcontainer-integration.2",
        "priority": null,
        "spec_path": ".flow/tasks/fn-49-devcontainer-integration.2.md",
        "status": "todo",
        "title": "Create ContainAI devcontainer feature",
        "updated_at": "2026-02-03T16:42:41.907527Z"
      },
      "id": "fn-49-devcontainer-integration.2",
      "runtime": {
        "assignee": "claire@novotny.org",
        "claimed_at": "2026-02-03T20:48:22.648484Z",
        "evidence": {
          "commits": [],
          "prs": [],
          "tests": [
            "shellcheck -x src/devcontainer/feature/*.sh"
          ]
        },
        "status": "done",
        "updated_at": "2026-02-03T20:49:17.657671Z"
      },
      "spec": "# fn-49-devcontainer-integration.2 Create ContainAI devcontainer feature\n\n## Description\n\nCreate the ContainAI devcontainer feature that provides sysbox verification, symlink creation (with credential opt-in), SSH service, and DinD support.\n\n### Feature Structure\n\n```\nsrc/devcontainer/feature/\n\u251c\u2500\u2500 devcontainer-feature.json\n\u251c\u2500\u2500 install.sh\n\u251c\u2500\u2500 verify-sysbox.sh\n\u251c\u2500\u2500 init.sh\n\u251c\u2500\u2500 start.sh\n\u2514\u2500\u2500 link-spec.json        # Copied from container/generated/\n```\n\n### Platform Support\n**V1: Debian/Ubuntu only**. Clear error message on other distros (Alpine, Fedora, etc.).\n\n### devcontainer-feature.json Options\n\n- `dataVolume`: Name of cai data volume (default: `sandbox-agent-data`)\n- `enableCredentials`: Sync credential files - GH tokens, Claude API keys (default: `false` - SECURITY)\n- `enableSsh`: Run sshd for non-VS Code access (default: true)\n- `installDocker`: Install Docker for DinD (default: true)\n- `remoteUser`: User for symlinks (default: auto-detect vscode/node/root)\n\n### Security: Credential Opt-In\n\n**Credentials are NOT synced by default.** Files containing tokens/API keys are skipped unless `enableCredentials: true`:\n- `~/.config/gh/hosts.yml` (GitHub token)\n- `~/.claude/credentials.json` (Claude API key)\n- `~/.codex/config.toml` (may contain keys)\n- `~/.gemini/settings.json` (may contain keys)\n\nThis prevents untrusted code in the workspace from accessing credentials.\n\n### Scripts\n\n1. **install.sh** (build-time)\n   - Check for apt-get (Debian/Ubuntu only)\n   - Install jq for JSON parsing\n   - Store config to `/usr/local/share/containai/config`\n   - Create verify-sysbox.sh, init.sh, start.sh\n   - Install openssh-server if enableSsh\n   - Install Docker if installDocker (add user to docker group)\n   - Copy link-spec.json to `/usr/local/lib/containai/`\n\n2. **verify-sysbox.sh**\n   - **MANDATORY**: Sysboxfs mount check (sysbox-unique, unforgeable)\n   - UID map check (0 not mapped to 0)\n   - Nested userns test (unshare --user)\n   - CAP_SYS_ADMIN capability probe\n   - Require sysboxfs + 2 other checks to pass\n\n3. **init.sh** (postCreateCommand)\n   - Run sysbox verification\n   - Read symlinks from `/usr/local/lib/containai/link-spec.json` (no hardcoded lists)\n   - **Rewrite paths**: link-spec.json uses `/home/agent` paths; rewrite to detected user home (`/home/vscode`, `/home/node`, etc.)\n   - **Handle remove_first**: Implement `remove_first` semantics - `rm -rf` for directories before creating symlink\n   - Skip credential files unless `enableCredentials=true`\n   - Create symlinks using jq to parse link-spec.json\n\n4. **start.sh** (postStartCommand)\n   - Re-verify sysbox\n   - Start sshd if enabled (with idempotency check)\n   - Start dockerd for DinD (with retry/idempotency)\n\n### Symlinks from link-spec.json\n\nUses the canonical `link-spec.json` generated from `sync-manifest.toml`. No duplicate symlink lists in this feature.\n\nThe init.sh script reads link-spec.json and creates symlinks, skipping credential files when `enableCredentials=false`.\n\n## Acceptance\n\n- [ ] Feature installs on Debian/Ubuntu base images\n- [ ] Clear error on non-Debian distros (Alpine, Fedora, etc.)\n- [ ] Sysbox verification requires sysboxfs mount (mandatory)\n- [ ] Verification passes in sysbox, fails in regular docker\n- [ ] Credentials NOT synced by default\n- [ ] Credentials synced when `enableCredentials: true`\n- [ ] Symlinks read from link-spec.json (no duplicate lists)\n- [ ] **Link paths rewritten** from `/home/agent` to detected user home\n- [ ] **remove_first handled** for directories (rm -rf before ln -sfn)\n- [ ] SSH port read from `CONTAINAI_SSH_PORT` env var\n- [ ] SSH starts with idempotency (doesn't fail if already running)\n- [ ] Dockerd starts with retry and idempotency\n- [ ] Hard-fail with clear error message when not in sysbox\n\n## Done summary\n# Task fn-49-devcontainer-integration.2: Create ContainAI devcontainer feature\n\n## Summary\n\nVerified and validated the ContainAI devcontainer feature implementation. All acceptance criteria are met:\n\n### Feature Structure\nAll required files exist in `src/devcontainer/feature/`:\n- `devcontainer-feature.json` - Feature manifest with all 5 options\n- `install.sh` - Build-time installer with Debian/Ubuntu check\n- `verify-sysbox.sh` - Kernel-level sysbox verification (mandatory sysboxfs check)\n- `init.sh` - postCreateCommand for symlink setup\n- `start.sh` - postStartCommand for sshd/dockerd\n- `link-spec.json` - Copied from canonical source\n\n### Implementation Highlights\n1. **Platform Support**: Clear error on non-Debian distros (checks `apt-get`)\n2. **Sysbox Verification**: Requires sysboxfs mount (mandatory) + 2 other checks\n3. **Credential Opt-In**: Credentials NOT synced by default (`enableCredentials: false`)\n4. **Path Rewriting**: Link paths rewritten from `/home/agent` to detected user home\n5. **remove_first Handling**: Directories removed before symlink creation\n6. **SSH Idempotency**: Checks pid file before starting sshd\n7. **DinD Retry**: dockerd starts with 30-retry loop and idempotency\n\n### Acceptance Criteria Status\n- [x] Feature installs on Debian/Ubuntu base images\n- [x] Clear error on non-Debian distros\n- [x] Sysbox verification requires sysboxfs mount (mandatory)\n- [x] Verification passes in sysbox, fails in regular docker\n- [x] Credentials NOT synced by default\n- [x] Credentials synced when `enableCredentials: true`\n- [x] Symlinks read from link-spec.json (no duplicate lists)\n- [x] Link paths rewritten from `/home/agent` to detected user home\n- [x] remove_first handled for directories\n- [x] SSH port read from `CONTAINAI_SSH_PORT` env var\n- [x] SSH starts with idempotency\n- [x] Dockerd starts with retry and idempotency\n- [x] Hard-fail with clear error message when not in sysbox\n\n### Quality\n- All scripts pass `shellcheck -x`\n- link-spec.json matches canonical source in artifacts/\n## Evidence\n- Commits:\n- Tests: shellcheck -x src/devcontainer/feature/*.sh\n- PRs:\n"
    },
    {
      "data": {
        "created_at": "2026-02-02T23:23:53.586944Z",
        "depends_on": [
          "fn-49-devcontainer-integration.1"
        ],
        "epic": "fn-49-devcontainer-integration",
        "id": "fn-49-devcontainer-integration.3",
        "priority": null,
        "spec_path": ".flow/tasks/fn-49-devcontainer-integration.3.md",
        "status": "todo",
        "title": "Build VS Code extension (vscode-containai)",
        "updated_at": "2026-02-03T16:42:41.990905Z"
      },
      "id": "fn-49-devcontainer-integration.3",
      "runtime": {
        "status": "todo",
        "updated_at": "2026-02-03T16:42:41.989788Z"
      },
      "spec": "# fn-49-devcontainer-integration.3 Build VS Code extension (vscode-containai)\n\n## Description\n\nCreate VS Code extension that detects ContainAI features in devcontainer.json and sets `dockerPath` to the cai-docker wrapper.\n\n### Extension Structure\n\n```\nvscode-containai/\n\u251c\u2500\u2500 package.json\n\u251c\u2500\u2500 src/\n\u2502   \u251c\u2500\u2500 extension.ts\n\u2502   \u2514\u2500\u2500 jsonc-parser.ts    # Proper JSONC parsing\n\u251c\u2500\u2500 tsconfig.json\n\u2514\u2500\u2500 README.md\n```\n\n### JSONC Parsing Requirement\n\n**Must use proper JSONC parser** (not regex stripping). Use one of:\n- `jsonc-parser` npm package (Microsoft's official JSONC parser)\n- VS Code's built-in JSONC support\n\nRegex-based comment stripping fails on:\n- Comment-like sequences in strings: `\"url\": \"https://example.com\"`\n- Multiline block comments\n- Escaped quotes in strings\n\n### Extension Logic\n\n1. **Activation**: On workspace containing devcontainer.json\n2. **Detection**: Parse devcontainer.json using proper JSONC parser for `containai` marker\n3. **Configuration**: Set `dev.containers.dockerPath` to cai-docker path\n4. **Notification**: Show info message that container will use sysbox\n5. **Warning**: If cai-docker not found, show installation instructions\n\n### Key Functions\n\n- `findDevcontainerJson()` - locate devcontainer.json in workspace (handle multi-root, nested folders)\n- `parseDevcontainerJson()` - parse JSONC using proper parser\n- `hasContainAIFeature()` - check for containai in parsed features object\n- `findCaiDocker()` - find cai-docker wrapper path\n- `configureDockerPath()` - set dev.containers.dockerPath\n\n### Implementation\n\n```typescript\nimport * as vscode from 'vscode';\nimport * as fs from 'fs';\nimport * as path from 'path';\nimport { parse as parseJSONC } from 'jsonc-parser';  // Proper JSONC parser\n\nexport function activate(context: vscode.ExtensionContext) {\n    const workspaceFolder = vscode.workspace.workspaceFolders?.[0];\n    if (!workspaceFolder) return;\n\n    const devcontainerPath = findDevcontainerJson(workspaceFolder.uri.fsPath);\n    if (!devcontainerPath) return;\n\n    if (hasContainAIFeature(devcontainerPath)) {\n        const caiDockerPath = findCaiDocker();\n        if (caiDockerPath) {\n            vscode.workspace.getConfiguration('dev.containers').update(\n                'dockerPath',\n                caiDockerPath,\n                vscode.ConfigurationTarget.Workspace\n            );\n            vscode.window.showInformationMessage(\n                'ContainAI: Devcontainer will run in sysbox sandbox.'\n            );\n        } else {\n            vscode.window.showWarningMessage(\n                'ContainAI feature detected but cai not installed. ' +\n                'Run: curl -fsSL https://containai.dev/install | sh'\n            );\n        }\n    }\n}\n\nfunction hasContainAIFeature(devcontainerPath: string): boolean {\n    const content = fs.readFileSync(devcontainerPath, 'utf8');\n    // Use proper JSONC parser - handles comments correctly\n    const parsed = parseJSONC(content);\n    const features = parsed?.features || {};\n    return Object.keys(features).some(key => key.includes('containai'));\n}\n\nfunction findCaiDocker(): string | null {\n    const candidates = [\n        path.join(process.env.HOME || '', '.local/bin/cai-docker'),\n        '/usr/local/bin/cai-docker'\n    ];\n    return candidates.find(p => fs.existsSync(p)) || null;\n}\n```\n\n### Distribution\n\n- VS Code Marketplace (marketplace.visualstudio.com)\n- Open VSX (open-vsx.org)\n- Bundled with cai setup\n\n## Acceptance\n\n- [ ] Activates when devcontainer.json present\n- [ ] **Uses proper JSONC parser** (jsonc-parser package, not regex)\n- [ ] Detects ContainAI feature in parsed devcontainer.json\n- [ ] Sets dockerPath to cai-docker when detected\n- [ ] Shows info message about sysbox sandboxing\n- [ ] Shows warning when cai not installed\n- [ ] Handles multi-root workspaces\n- [ ] Works on Windows (WSL), Mac, Linux\n\n## Done summary\nBlocked:\nAuto-blocked after 5 attempts.\nRun: 20260203T013526Z-containai-containai-main-claire@novotny.org-23727-267d\nTask: fn-49-devcontainer-integration.3\n\nLast output:\n{\"type\":\"system\",\"subtype\":\"init\",\"cwd\":\"/home/agent/workspace\",\"session_id\":\"bacf2df7-93a7-4ac4-b2ec-868b2caebcbb\",\"tools\":[\"Task\",\"TaskOutput\",\"Bash\",\"Glob\",\"Grep\",\"ExitPlanMode\",\"Read\",\"Edit\",\"Write\",\"NotebookEdit\",\"WebFetch\",\"TodoWrite\",\"WebSearch\",\"TaskStop\",\"AskUserQuestion\",\"Skill\",\"EnterPlanMode\",\"ToolSearch\",\"mcp__fetch__fetch\",\"mcp__sequential-thinking__sequentialthinking\",\"mcp__context7__resolve-library-id\",\"mcp__context7__query-docs\"],\"mcp_servers\":[{\"name\":\"fetch\",\"status\":\"connected\"},{\"name\":\"sequential-thinking\",\"status\":\"connected\"},{\"name\":\"context7\",\"status\":\"connected\"}],\"model\":\"claude-opus-4-5-20251101\",\"permissionMode\":\"bypassPermissions\",\"slash_commands\":[\"keybindings-help\",\"flow-next:flow-next:ralph-init\",\"flow-next:flow-next:uninstall\",\"flow-next:flow-next:sync\",\"flow-next:flow-next:prime\",\"flow-next:flow-next:work\",\"flow-next:flow-next:setup\",\"flow-next:flow-next:epic-review\",\"flow-next:flow-next:impl-review\",\"flow-next:flow-next:plan\",\"flow-next:flow-next:interview\",\"flow-next:flow-next:plan-review\",\"agent-orchestration:improve-agent\",\"agent-orchestration:multi-agent-optimize\",\"python-development:python-scaffold\",\"javascript-typescript:typescript-scaffold\",\"backend-development:feature-development\",\"full-stack-orchestration:full-stack-feature\",\"code-documentation:code-explain\",\"code-documentation:doc-generate\",\"debugging-toolkit:smart-debug\",\"documentation-generation:doc-generate\",\"c4-architecture:c4-architecture\",\"code-refactoring:tech-debt\",\"code-refactoring:refactor-clean\",\"code-refactoring:context-restore\",\"dependency-management:deps-audit\",\"error-debugging:error-analysis\",\"error-debugging:error-trace\",\"error-debugging:multi-agent-review\",\"llm-application-dev:langchain-agent\",\"llm-application-dev:ai-assistant\",\"llm-application-dev:prompt-optimize\",\"context-management:context-save\",\"context-management:context-restore\",\"observability-monitoring:monitor-setup\",\"observability-monitoring:slo-implement\",\"distributed-debugging:debug-trace\",\"deployment-validation:config-validate\",\"cicd-automation:workflow-automate\",\"frontend-mobile-security:xss-scan\",\"codebase-cleanup:tech-debt\",\"codebase-cleanup:refactor-clean\",\"codebase-cleanup:deps-audit\",\"systems-programming:rust-project\",\"flow-next:flow-next-plan-review\",\"flow-next:flow-next\",\"flow-next:browser\",\"flow-next:flow-next-impl-review\",\"flow-next:flow-next-plan\",\"flow-next:flow-next-sync\",\"flow-next:flow-next-epic-review\",\"flow-next:flow-next-rp-explorer\",\"flow-next:flow-next-setup\",\"flow-next:flow-next-interview\",\"flow-next:flow-next-prime\",\"flow-next:flow-next-work\",\"flow-next:flow-next-worktree-kit\",\"flow-next:flow-next-export-context\",\"flow-next:flow-next-deps\",\"flow-next:flow-next-ralph-init\",\"python-development:async-python-patterns\",\"python-development:python-performance-optimization\",\"python-development:python-testing-patterns\",\"python-development:uv-package-manager\",\"python-development:python-packaging\",\"javascript-typescript:modern-javascript-patterns\",\"javascript-typescript:nodejs-backend-patterns\",\"javascript-typescript:typescript-advanced-types\",\"javascript-typescript:javascript-testing-patterns\",\"backend-development:api-design-principles\",\"backend-development:saga-orchestration\",\"backend-development:workflow-orchestration-patterns\",\"backend-development:event-store-design\",\"backend-development:projection-patterns\",\"backend-development:microservices-patterns\",\"backend-development:architecture-patterns\",\"backend-development:temporal-python-testing\",\"backend-development:cqrs-implementation\",\"documentation-generation:openapi-spec-generation\",\"documentation-generation:architecture-decision-records\",\"documentation-generation:changelog-automation\",\"llm-application-dev:prompt-engineering-patterns\",\"llm-application-dev:llm-evaluation\",\"llm-application-dev:embedding-strategies\",\"llm-application-dev:hybrid-search-implementation\",\"llm-application-dev:langchain-architecture\",\"llm-application-dev:rag-implementation\",\"llm-application-dev:vector-index-tuning\",\"llm-application-dev:similarity-search-patterns\",\"observability-monitoring:distributed-tracing\",\"observability-monitoring:grafana-dashboards\",\"observability-monitoring:prometheus-configuration\",\"observability-monitoring:slo-implementation\",\"cicd-automation:gitlab-ci-patterns\",\"cicd-automation:secrets-management\",\"cicd-automation:deployment-pipeline-design\",\"cicd-automation:github-actions-templates\",\"business-analytics:kpi-dashboard-design\",\"business-analytics:data-storytelling\",\"systems-programming:rust-async-patterns\",\"systems-programming:memory-safety-patterns\",\"systems-programming:go-concurrency-patterns\",\"quantitative-trading:risk-metrics-calculation\",\"quantitative-trading:backtesting-frameworks\",\"payment-processing:pci-compliance\",\"payment-processing:stripe-integration\",\"payment-processing:billing-automation\",\"payment-processing:paypal-integration\",\"playground:playground\",\"compact\",\"context\",\"cost\",\"init\",\"pr-comments\",\"release-notes\",\"review\",\"security-review\",\"mcp__fetch__fetch\"],\"apiKeySource\":\"none\",\"claude_code_version\":\"2.1.29\",\"output_style\":\"default\",\"agents\":[\"Bash\",\"general-purpose\",\"statusline-setup\",\"Explore\",\"Plan\",\"flow-next:repo-scout\",\"flow-next:env-scout\",\"flow-next:memory-scout\",\"flow-next:security-scout\",\"flow-next:build-scout\",\"flow-next:observability-scout\",\"flow-next:workflow-scout\",\"flow-next:testing-scout\",\"flow-next:epic-scout\",\"flow-next:quality-auditor\",\"flow-next:claude-md-scout\",\"flow-next:docs-scout\",\"flow-next:plan-sync\",\"flow-next:github-scout\",\"flow-next:flow-gap-analyst\",\"flow-next:docs-gap-scout\",\"flow-next:context-scout\",\"flow-next:practice-scout\",\"flow-next:tooling-scout\",\"flow-next:worker\",\"agent-orchestration:context-manager\",\"python-development:fastapi-pro\",\"python-development:python-pro\",\"python-development:django-pro\",\"javascript-typescript:typescript-pro\",\"javascript-typescript:javascript-pro\",\"backend-development:temporal-python-pro\",\"backend-development:graphql-architect\",\"backend-development:tdd-orchestrator\",\"backend-development:event-sourcing-architect\",\"backend-development:backend-architect\",\"full-stack-orchestration:deployment-engineer\",\"full-stack-orchestration:test-automator\",\"full-stack-orchestration:performance-engineer\",\"full-stack-orchestration:security-auditor\",\"code-documentation:tutorial-engineer\",\"code-documentation:docs-architect\",\"code-documentation:code-reviewer\",\"debugging-toolkit:debugger\",\"debugging-toolkit:dx-optimizer\",\"documentation-generation:mermaid-expert\",\"documentation-generation:reference-builder\",\"documentation-generation:tutorial-engineer\",\"documentation-generation:docs-architect\",\"documentation-generation:api-documenter\",\"c4-architecture:c4-component\",\"c4-architecture:c4-container\",\"c4-architecture:c4-code\",\"c4-architecture:c4-context\",\"code-refactoring:legacy-modernizer\",\"code-refactoring:code-reviewer\",\"dependency-management:legacy-modernizer\",\"error-debugging:debugger\",\"error-debugging:error-detective\",\"llm-application-dev:vector-database-engineer\",\"llm-application-dev:ai-engineer\",\"llm-application-dev:prompt-engineer\",\"context-management:context-manager\",\"observability-monitoring:network-engineer\",\"observability-monitoring:performance-engineer\",\"observability-monitoring:database-optimizer\",\"observability-monitoring:observability-engineer\",\"distributed-debugging:error-detective\",\"distributed-debugging:devops-troubleshooter\",\"deployment-strategies:deployment-engineer\",\"deployment-strategies:terraform-specialist\",\"deployment-validation:cloud-architect\",\"cicd-automation:deployment-engineer\",\"cicd-automation:terraform-specialist\",\"cicd-automation:cloud-architect\",\"cicd-automation:kubernetes-architect\",\"cicd-automation:devops-troubleshooter\",\"backend-api-security:backend-architect\",\"backend-api-security:backend-security-coder\",\"frontend-mobile-security:frontend-developer\",\"frontend-mobile-security:frontend-security-coder\",\"frontend-mobile-security:mobile-security-coder\",\"codebase-cleanup:test-automator\",\"codebase-cleanup:code-reviewer\",\"business-analytics:business-analyst\",\"jvm-languages:java-pro\",\"jvm-languages:scala-pro\",\"jvm-languages:csharp-pro\",\"systems-programming:cpp-pro\",\"systems-programming:golang-pro\",\"systems-programming:rust-pro\",\"systems-programming:c-pro\",\"quantitative-trading:quant-analyst\",\"quantitative-trading:risk-manager\",\"payment-processing:payment-integration\"],\"skills\":[\"keybindings-help\",\"flow-next:flow-next-plan-review\",\"flow-next:flow-next\",\"flow-next:browser\",\"flow-next:flow-next-impl-review\",\"flow-next:flow-next-plan\",\"flow-next:flow-next-sync\",\"flow-next:flow-next-epic-review\",\"flow-next:flow-next-rp-explorer\",\"flow-next:flow-next-setup\",\"flow-next:flow-next-interview\",\"flow-next:flow-next-prime\",\"flow-next:flow-next-work\",\"flow-next:flow-next-worktree-kit\",\"flow-next:flow-next-export-context\",\"flow-next:flow-next-deps\",\"flow-next:flow-next-ralph-init\",\"python-development:async-python-patterns\",\"python-development:python-performance-optimization\",\"python-development:python-testing-patterns\",\"python-development:uv-package-manager\",\"python-development:python-packaging\",\"javascript-typescript:modern-javascript-patterns\",\"javascript-typescript:nodejs-backend-patterns\",\"javascript-typescript:typescript-advanced-types\",\"javascript-typescript:javascript-testing-patterns\",\"backend-development:api-design-principles\",\"backend-development:saga-orchestration\",\"backend-development:workflow-orchestration-patterns\",\"backend-development:event-store-design\",\"backend-development:projection-patterns\",\"backend-development:microservices-patterns\",\"backend-development:architecture-patterns\",\"backend-development:temporal-python-testing\",\"backend-development:cqrs-implementation\",\"documentation-generation:openapi-spec-generation\",\"documentation-generation:architecture-decision-records\",\"documentation-generation:changelog-automation\",\"llm-application-dev:prompt-engineering-patterns\",\"llm-application-dev:llm-evaluation\",\"llm-application-dev:embedding-strategies\",\"llm-application-dev:hybrid-search-implementation\",\"llm-application-dev:langchain-architecture\",\"llm-application-dev:rag-implementation\",\"llm-application-dev:vector-index-tuning\",\"llm-application-dev:similarity-search-patterns\",\"observability-monitoring:distributed-tracing\",\"observability-monitoring:grafana-dashboards\",\"observability-monitoring:prometheus-configuration\",\"observability-monitoring:slo-implementation\",\"cicd-automation:gitlab-ci-patterns\",\"cicd-automation:secrets-management\",\"cicd-automation:deployment-pipeline-design\",\"cicd-automation:github-actions-templates\",\"business-analytics:kpi-dashboard-design\",\"business-analytics:data-storytelling\",\"systems-programming:rust-async-patterns\",\"systems-programming:memory-safety-patterns\",\"systems-programming:go-concurrency-patterns\",\"quantitative-trading:risk-metrics-calculation\",\"quantitative-trading:backtesting-frameworks\",\"payment-processing:pci-compliance\",\"payment-processing:stripe-integration\",\"payment-processing:billing-automation\",\"payment-processing:paypal-integration\",\"playground:playground\"],\"plugins\":[{\"name\":\"flow-next\",\"path\":\"/home/agent/.claude/plugins/cache/gmickel-claude-marketplace/flow-next/0.20.8\"},{\"name\":\"gopls-lsp\",\"path\":\"/home/agent/.claude/plugins/cache/claude-plugins-official/gopls-lsp/1.0.0\"},{\"name\":\"csharp-lsp\",\"path\":\"/home/agent/.claude/plugins/cache/claude-plugins-official/csharp-lsp/1.0.0\"},{\"name\":\"rust-analyzer-lsp\",\"path\":\"/home/agent/.claude/plugins/cache/claude-plugins-official/rust-analyzer-lsp/1.0.0\"},{\"name\":\"clangd-lsp\",\"path\":\"/home/agent/.claude/plugins/cache/claude-plugins-official/clangd-lsp/1.0.0\"},{\"name\":\"pyright-lsp\",\"path\":\"/home/agent/.claude/plugins/cache/claude-plugins-official/pyright-lsp/1.0.0\"},{\"name\":\"agent-orchestration\",\"path\":\"/home/agent/.claude/plugins/cache/claude-code-workflows/agent-orchestration/1.2.0\"},{\"name\":\"python-development\",\"path\":\"/home/agent/.claude/plugins/cache/claude-code-workflows/python-development/1.2.1\"},{\"name\":\"javascript-typescript\",\"path\":\"/home/agent/.claude/plugins/cache/claude-code-workflows/javascript-typescript/1.2.1\"},{\"name\":\"backend-development\",\"path\":\"/home/agent/.claude/plugins/cache/claude-code-workflows/backend-development/1.2.4\"},{\"name\":\"full-stack-orchestration\",\"path\":\"/home/agent/.claude/plugins/cache/claude-code-workflows/full-stack-orchestration/1.2.1\"},{\"name\":\"code-documentation\",\"path\":\"/home/agent/.claude/plugins/cache/claude-code-workflows/code-documentation/1.2.0\"},{\"name\":\"debugging-toolkit\",\"path\":\"/home/agent/.claude/plugins/cache/claude-code-workflows/debugging-toolkit/1.2.0\"},{\"name\":\"documentation-generation\",\"path\":\"/home/agent/.claude/plugins/cache/claude-code-workflows/documentation-generation/1.2.1\"},{\"name\":\"c4-architecture\",\"path\":\"/home/agent/.claude/plugins/cache/claude-code-workflows/c4-architecture/1.0.0\"},{\"name\":\"code-refactoring\",\"path\":\"/home/agent/.claude/plugins/cache/claude-code-workflows/code-refactoring/1.2.0\"},{\"name\":\"dependency-management\",\"path\":\"/home/agent/.claude/plugins/cache/claude-code-workflows/dependency-management/1.2.0\"},{\"name\":\"error-debugging\",\"path\":\"/home/agent/.claude/plugins/cache/claude-code-workflows/error-debugging/1.2.0\"},{\"name\":\"llm-application-dev\",\"path\":\"/home/agent/.claude/plugins/cache/claude-code-workflows/llm-application-dev/2.0.2\"},{\"name\":\"context-management\",\"path\":\"/home/agent/.claude/plugins/cache/claude-code-workflows/context-management/1.2.0\"},{\"name\":\"observability-monitoring\",\"path\":\"/home/agent/.claude/plugins/cache/claude-code-workflows/observability-monitoring/1.2.1\"},{\"name\":\"distributed-debugging\",\"path\":\"/home/agent/.claude/plugins/cache/claude-code-workflows/distributed-debugging/1.2.0\"},{\"name\":\"deployment-strategies\",\"path\":\"/home/agent/.claude/plugins/cache/claude-code-workflows/deployment-strategies/1.2.0\"},{\"name\":\"deployment-validation\",\"path\":\"/home/agent/.claude/plugins/cache/claude-code-workflows/deployment-validation/1.2.0\"},{\"name\":\"cicd-automation\",\"path\":\"/home/agent/.claude/plugins/cache/claude-code-workflows/cicd-automation/1.2.1\"},{\"name\":\"backend-api-security\",\"path\":\"/home/agent/.claude/plugins/cache/claude-code-workflows/backend-api-security/1.2.0\"},{\"name\":\"frontend-mobile-security\",\"path\":\"/home/agent/.claude/plugins/cache/claude-code-workflows/frontend-mobile-security/1.2.0\"},{\"name\":\"codebase-cleanup\",\"path\":\"/home/agent/.claude/plugins/cache/claude-code-workflows/codebase-cleanup/1.2.0\"},{\"name\":\"business-analytics\",\"path\":\"/home/agent/.claude/plugins/cache/claude-code-workflows/business-analytics/1.2.1\"},{\"name\":\"jvm-languages\",\"path\":\"/home/agent/.claude/plugins/cache/claude-code-workflows/jvm-languages/1.2.0\"},{\"name\":\"systems-programming\",\"path\":\"/home/agent/.claude/plugins/cache/claude-code-workflows/systems-programming/1.2.1\"},{\"name\":\"quantitative-trading\",\"path\":\"/home/agent/.claude/plugins/cache/claude-code-workflows/quantitative-trading/1.2.1\"},{\"name\":\"payment-processing\",\"path\":\"/home/agent/.claude/plugins/cache/claude-code-workflows/payment-processing/1.2.1\"},{\"name\":\"playground\",\"path\":\"/home/agent/.claude/plugins/cache/claude-plugins-official/playground/27d2b86d72da\"}],\"uuid\":\"3b3af6c5-d794-41af-8acf-b95c4f621c0e\"}\n{\"type\":\"assistant\",\"message\":{\"id\":\"4e61cd2e-29cc-47e1-a079-860b38392f83\",\"container\":null,\"model\":\"<synthetic>\",\"role\":\"assistant\",\"stop_reason\":\"stop_sequence\",\"stop_sequence\":\"\",\"type\":\"message\",\"usage\":{\"input_tokens\":0,\"output_tokens\":0,\"cache_creation_input_tokens\":0,\"cache_read_input_tokens\":0,\"server_tool_use\":{\"web_search_requests\":0,\"web_fetch_requests\":0},\"service_tier\":null,\"cache_creation\":{\"ephemeral_1h_input_tokens\":0,\"ephemeral_5m_input_tokens\":0}},\"content\":[{\"type\":\"text\",\"text\":\"API Error: 500 {\\\"type\\\":\\\"error\\\",\\\"error\\\":{\\\"type\\\":\\\"api_error\\\",\\\"message\\\":\\\"Internal server error\\\"},\\\"request_id\\\":\\\"req_011CXmP6tDyBud7jK7kPgUjR\\\"}\"}],\"context_management\":null},\"parent_tool_use_id\":null,\"session_id\":\"bacf2df7-93a7-4ac4-b2ec-868b2caebcbb\",\"uuid\":\"36cac210-6ab3-4926-9c06-cc2b69c5e807\",\"error\":\"unknown\"}\n{\"type\":\"user\",\"message\":{\"role\":\"user\",\"content\":[{\"type\":\"text\",\"text\":\"Stop hook feedback:\\nCannot stop: implementation review not completed.\\nYou MUST invoke `/flow-next:impl-review fn-49-devcontainer-integration.3` to complete the review.\\nThe skill writes the receipt on SHIP verdict.\\nDo NOT write the receipt manually - that skips the actual review.\"}]},\"parent_tool_use_id\":null,\"session_id\":\"bacf2df7-93a7-4ac4-b2ec-868b2caebcbb\",\"uuid\":\"1d95b684-7cba-4e96-95a0-f08bda09a4eb\",\"isSynthetic\":true}\n{\"type\":\"assistant\",\"message\":{\"id\":\"065f8e86-7c09-4632-8f8c-393128c8df8f\",\"container\":null,\"model\":\"<synthetic>\",\"role\":\"assistant\",\"stop_reason\":\"stop_sequence\",\"stop_sequence\":\"\",\"type\":\"message\",\"usage\":{\"input_tokens\":0,\"output_tokens\":0,\"cache_creation_input_tokens\":0,\"cache_read_input_tokens\":0,\"server_tool_use\":{\"web_search_requests\":0,\"web_fetch_requests\":0},\"service_tier\":null,\"cache_creation\":{\"ephemeral_1h_input_tokens\":0,\"ephemeral_5m_input_tokens\":0}},\"content\":[{\"type\":\"text\",\"text\":\"API Error: 500 {\\\"type\\\":\\\"error\\\",\\\"error\\\":{\\\"type\\\":\\\"api_error\\\",\\\"message\\\":\\\"Internal server error\\\"},\\\"request_id\\\":\\\"req_011CXmP6uPR4J2LwdpMA4Eg8\\\"}\"}],\"context_management\":null},\"parent_tool_use_id\":null,\"session_id\":\"bacf2df7-93a7-4ac4-b2ec-868b2caebcbb\",\"uuid\":\"0ac41e1d-f487-4ed4-9947-96d46a190ad4\",\"error\":\"unknown\"}\n{\"type\":\"result\",\"subtype\":\"success\",\"is_error\":true,\"duration_ms\":778,\"duration_api_ms\":0,\"num_turns\":2,\"result\":\"API Error: 500 {\\\"type\\\":\\\"error\\\",\\\"error\\\":{\\\"type\\\":\\\"api_error\\\",\\\"message\\\":\\\"Internal server error\\\"},\\\"request_id\\\":\\\"req_011CXmP6uPR4J2LwdpMA4Eg8\\\"}\",\"session_id\":\"bacf2df7-93a7-4ac4-b2ec-868b2caebcbb\",\"total_cost_usd\":0,\"usage\":{\"input_tokens\":0,\"cache_creation_input_tokens\":0,\"cache_read_input_tokens\":0,\"output_tokens\":0,\"server_tool_use\":{\"web_search_requests\":0,\"web_fetch_requests\":0},\"service_tier\":\"standard\",\"cache_creation\":{\"ephemeral_1h_input_tokens\":0,\"ephemeral_5m_input_tokens\":0}},\"modelUsage\":{},\"permission_denials\":[],\"uuid\":\"9a12a2fc-8acf-4711-af2b-fab58259435e\"}\nralph: missing impl review receipt; forcing retry\nralph: task not done; forcing retry\n## Evidence\n- Commits:\n- Tests:\n- PRs:\n"
    },
    {
      "data": {
        "assignee": null,
        "claim_note": "",
        "claimed_at": null,
        "created_at": "2026-02-02T23:23:54.640246Z",
        "depends_on": [
          "fn-49-devcontainer-integration.1",
          "fn-49-devcontainer-integration.2",
          "fn-49-devcontainer-integration.3"
        ],
        "epic": "fn-49-devcontainer-integration",
        "id": "fn-49-devcontainer-integration.4",
        "priority": null,
        "spec_path": ".flow/tasks/fn-49-devcontainer-integration.4.md",
        "status": "todo",
        "title": "Integrate into cai setup workflow",
        "updated_at": "2026-02-02T23:24:04.931658Z"
      },
      "id": "fn-49-devcontainer-integration.4",
      "runtime": null,
      "spec": "# fn-49-devcontainer-integration.4 Integrate into cai setup workflow\n\n## Description\n\nExtend `cai setup` to install cai-docker wrapper and VS Code extension. **Reuse existing containai-docker context logic** - do not create new context setup.\n\n### Changes to cai setup\n\nAdd new setup steps after sysbox installation:\n\n1. **Install cai-docker wrapper**\n   - Copy to `~/.local/bin/cai-docker`\n   - Make executable\n   - Ensure `~/.local/bin` in PATH\n\n2. **Reuse existing containai-docker context** (DO NOT create new context setup)\n   - The context is already created by existing `_cai_setup_containai_docker_context()`\n   - Platform-specific endpoints: WSL2 SSH bridge, macOS/Lima, native Linux\n   - Use existing `_cai_auto_repair_containai_context()` for repairs\n   - The wrapper enforces `--runtime=sysbox-runc` at launch time\n\n3. **Setup SSH config Include directive**\n   - Ensure `~/.ssh/containai.d/` directory exists\n   - Ensure `Include containai.d/*` is in `~/.ssh/config`\n   - Reuse existing `_cai_setup_ssh_config` patterns\n\n4. **Install VS Code extension**\n   - Check if VS Code installed\n   - Install via `code --install-extension`\n   - Also install for code-insiders if present\n\n5. **Update doctor checks**\n   - Check cai-docker wrapper exists and is executable\n   - Check containai-docker context exists (using existing checks)\n   - Check VS Code extension installed (if VS Code present)\n   - Check `~/.ssh/containai.d/` exists with Include\n\n### Important: Reuse Existing Infrastructure\n\nDo NOT duplicate context creation logic. The existing codebase has:\n- `_cai_setup_containai_docker_context()` - creates context with platform-specific endpoints\n- `_cai_auto_repair_containai_context()` - repairs broken contexts\n- `_cai_expected_docker_host()` - returns expected host for platform\n- `_cai_setup_ssh_config()` - SSH config management\n\nThe devcontainer wrapper just needs to:\n1. Use the existing context\n2. Add `--runtime=sysbox-runc` at launch time\n\n### New Library\n\n`src/lib/devcontainer.sh`:\n- `_cai_install_docker_wrapper()` - install cai-docker\n- `_cai_install_vscode_extension()` - install extension\n- `_cai_doctor_devcontainer()` - check devcontainer components\n\n### User Flow\n\n```\n$ cai setup\n\n[existing steps...]\n\nSetting up devcontainer support...\n  \u2713 cai-docker wrapper installed\n  \u2713 containai-docker context verified (existing)\n  \u2713 SSH containai.d directory configured\n  \u2713 VS Code extension installed\n\nDone! You can now use ContainAI with devcontainers.\n```\n\n## Acceptance\n\n- [ ] cai-docker wrapper installed to ~/.local/bin\n- [ ] Reuses existing containai-docker context (no new context creation)\n- [ ] SSH Include directive set up for ~/.ssh/containai.d/\n- [ ] VS Code extension installed (if VS Code present)\n- [ ] Doctor checks for devcontainer components\n- [ ] Clear error messages if setup fails\n- [ ] Idempotent (can run multiple times safely)\n\n## Done summary\nTBD\n\n## Evidence\n- Commits:\n- Tests:\n- PRs:\n"
    },
    {
      "data": {
        "assignee": null,
        "claim_note": "",
        "claimed_at": null,
        "created_at": "2026-02-02T23:23:55.688671Z",
        "depends_on": [
          "fn-49-devcontainer-integration.2",
          "fn-49-devcontainer-integration.4"
        ],
        "epic": "fn-49-devcontainer-integration",
        "id": "fn-49-devcontainer-integration.5",
        "priority": null,
        "spec_path": ".flow/tasks/fn-49-devcontainer-integration.5.md",
        "status": "todo",
        "title": "Test sysbox verification matrix",
        "updated_at": "2026-02-02T23:24:06.606526Z"
      },
      "id": "fn-49-devcontainer-integration.5",
      "runtime": null,
      "spec": "# fn-49-devcontainer-integration.5 Test sysbox verification matrix\n\n## Description\n\nComprehensive testing of the sysbox verification logic to ensure it correctly distinguishes sysbox from other container runtimes.\n\n### Test Matrix\n\n| Runtime | UID Map | unshare | Sysboxfs | Cap Probe | Total | Expected |\n|---------|---------|---------|----------|-----------|-------|----------|\n| sysbox | \u2713 | \u2713 | \u2713 | \u2713 | 4 | PASS |\n| docker (default) | \u2717 | \u2717 | \u2717 | \u2717 | 0 | FAIL |\n| docker --privileged | \u2717 | \u2713 | \u2717 | \u2713 | 2 | FAIL |\n| docker --cap-add=ALL | \u2717 | \u2717 | \u2717 | \u2717 | 0 | FAIL |\n| podman (rootless) | varies | varies | \u2717 | varies | 0-2 | FAIL |\n\n### Integration Test: `tests/integration/test-devcontainer-sysbox.sh`\n\n```bash\n# Test 1: Sysbox passes verification\n# Test 2: Regular docker fails\n# Test 3: Privileged fails (only 2 checks pass)\n# Test 4: Full devcontainer flow\n```\n\n### Unit Tests\n\n- Test UID map parsing\n- Test sysboxfs mount detection\n- Test capability probe\n\n### CI Integration\n\nAdd to `.github/workflows/ci.yml`:\n```yaml\ntest-devcontainer:\n  runs-on: ubuntu-latest\n  needs: [build-sysbox]\n  steps:\n    - name: Test sysbox verification\n      run: ./tests/integration/test-devcontainer-sysbox.sh\n```\n\n## Acceptance\n\n- [ ] Sysbox containers pass verification (4/4 checks)\n- [ ] Regular docker containers fail (0/4 checks)\n- [ ] Privileged containers fail (2/4 checks, need 3)\n- [ ] Clear error message when verification fails\n- [ ] Tests run in CI pipeline\n\n## Done summary\nTBD\n\n## Evidence\n- Commits:\n- Tests:\n- PRs:\n"
    },
    {
      "data": {
        "assignee": null,
        "claim_note": "",
        "claimed_at": null,
        "created_at": "2026-02-02T23:23:56.734105Z",
        "depends_on": [
          "fn-49-devcontainer-integration.5"
        ],
        "epic": "fn-49-devcontainer-integration",
        "id": "fn-49-devcontainer-integration.6",
        "priority": null,
        "spec_path": ".flow/tasks/fn-49-devcontainer-integration.6.md",
        "status": "todo",
        "title": "Publish feature and extension",
        "updated_at": "2026-02-02T23:24:07.550751Z"
      },
      "id": "fn-49-devcontainer-integration.6",
      "runtime": null,
      "spec": "# fn-49-devcontainer-integration.6 Publish feature and extension\n\n## Description\n\nPublish the ContainAI devcontainer feature to ghcr.io and the VS Code extension to marketplaces.\n\n### Feature Publication\n\n**Registry**: `ghcr.io/novotnyllc/containai/feature`\n\n1. Build OCI artifact with devcontainer CLI\n2. Semantic versioning (1.0.0, 1.0.1, etc.)\n3. Tags: `latest`, `1`, `1.0`, `1.0.0`\n\nCI Pipeline: `.github/workflows/publish-feature.yml`\n- Trigger on `feature-v*` tags\n- Use `devcontainers/action@v1`\n\n### Extension Publication\n\n**VS Code Marketplace**:\n- Create publisher account (novotnyllc)\n- Build and publish with `vsce publish`\n\n**Open VSX**:\n- Create account on open-vsx.org\n- Publish with `ovsx publish`\n\nCI Pipeline: `.github/workflows/publish-extension.yml`\n- Trigger on `extension-v*` tags\n- Publish to both marketplaces\n\n### Secrets Required\n\n- `GHCR_TOKEN` - GitHub Container Registry token\n- `VSCE_PAT` - VS Code Marketplace personal access token\n- `OVSX_PAT` - Open VSX personal access token\n\n## Acceptance\n\n- [ ] Feature published to ghcr.io/novotnyllc/containai/feature\n- [ ] Feature tagged with semantic versions\n- [ ] Extension published to VS Code Marketplace\n- [ ] Extension published to Open VSX\n- [ ] CI workflows for automated publishing\n- [ ] Release notes for each version\n\n## Done summary\nTBD\n\n## Evidence\n- Commits:\n- Tests:\n- PRs:\n"
    },
    {
      "data": {
        "assignee": null,
        "claim_note": "",
        "claimed_at": null,
        "created_at": "2026-02-02T23:23:57.382301Z",
        "depends_on": [
          "fn-49-devcontainer-integration.2",
          "fn-49-devcontainer-integration.6"
        ],
        "epic": "fn-49-devcontainer-integration",
        "id": "fn-49-devcontainer-integration.7",
        "priority": null,
        "spec_path": ".flow/tasks/fn-49-devcontainer-integration.7.md",
        "status": "todo",
        "title": "Documentation and templates",
        "updated_at": "2026-02-02T23:24:10.385801Z"
      },
      "id": "fn-49-devcontainer-integration.7",
      "runtime": null,
      "spec": "# fn-49-devcontainer-integration.7 Documentation and templates\n\n## Description\n\nCreate documentation for using ContainAI with devcontainers and provide example templates.\n\n### Documentation: `docs/devcontainer.md`\n\n- Prerequisites (cai setup, cai import)\n- Quick start (add feature to devcontainer.json)\n- Features overview (sysbox, config sync, DinD, SSH)\n- Configuration options\n- Troubleshooting section\n\n### Example Templates\n\n**Python** (`templates/devcontainer/python/.devcontainer/devcontainer.json`):\n```json\n{\n    \"name\": \"Python with ContainAI\",\n    \"image\": \"mcr.microsoft.com/devcontainers/python:3.11\",\n    \"features\": {\n        \"ghcr.io/novotnyllc/containai/feature:latest\": {}\n    }\n}\n```\n\n**Node.js** (`templates/devcontainer/node/.devcontainer/devcontainer.json`):\n```json\n{\n    \"name\": \"Node.js with ContainAI\",\n    \"image\": \"mcr.microsoft.com/devcontainers/javascript-node:18\",\n    \"features\": {\n        \"ghcr.io/novotnyllc/containai/feature:latest\": {}\n    }\n}\n```\n\n### Files to Create\n\n- `docs/devcontainer.md` - main documentation\n- `templates/devcontainer/python/.devcontainer/devcontainer.json`\n- `templates/devcontainer/node/.devcontainer/devcontainer.json`\n- Update `README.md` with devcontainer section\n\n## Acceptance\n\n- [ ] docs/devcontainer.md with complete guide\n- [ ] At least 2 example templates (Python, Node.js)\n- [ ] Troubleshooting section\n- [ ] Reference to cai doctor for diagnostics\n- [ ] Link from main README.md\n\n## Done summary\nTBD\n\n## Evidence\n- Commits:\n- Tests:\n- PRs:\n"
    },
    {
      "data": {
        "created_at": "2026-02-03T01:13:43.917350Z",
        "depends_on": [
          "fn-49-devcontainer-integration.4"
        ],
        "epic": "fn-49-devcontainer-integration",
        "id": "fn-49-devcontainer-integration.8",
        "priority": null,
        "spec_path": ".flow/tasks/fn-49-devcontainer-integration.8.md",
        "status": "todo",
        "title": "Docker context sync watcher",
        "updated_at": "2026-02-03T21:34:04.096234Z"
      },
      "id": "fn-49-devcontainer-integration.8",
      "runtime": {
        "assignee": "claire@novotny.org",
        "claimed_at": "2026-02-03T21:34:09.469318Z",
        "evidence": {
          "commits": [
            "dd6b53f"
          ],
          "prs": [],
          "tests": [
            "tests/unit/test-docker-context-sync.sh"
          ]
        },
        "status": "done",
        "updated_at": "2026-02-03T21:37:54.911976Z"
      },
      "spec": "# fn-49-devcontainer-integration.8 Docker context sync watcher\n\n## Description\n\nCreate a bidirectional sync mechanism between `~/.docker/contexts` and `~/.docker-cai/contexts` that keeps them in sync, with special handling for the `containai-docker` context which has different socket paths.\n\n### Problem\n\nThe devcontainer needs Docker contexts from the host, but:\n- Host's `containai-docker` context uses SSH socket (`ssh://user@host`)\n- Container's `containai-docker` context needs Unix socket (`unix:///var/run/docker.sock`)\n- Other contexts should be synced bidirectionally without modification\n\n### Implementation\n\n**Location**: `src/lib/docker-context-sync.sh`\n\n### Core Functions\n\n1. **`_cai_sync_docker_contexts_once()`**\n   - One-time sync from source to target\n   - Parameters: `$1` = source dir, `$2` = target dir, `$3` = direction (host-to-cai|cai-to-host)\n   - Syncs all contexts except `containai-docker`\n   - Creates target dirs if missing\n\n2. **`_cai_create_containai_docker_context()`**\n   - Creates the `containai-docker` context in `~/.docker-cai/contexts/`\n   - Uses Unix socket path (`unix:///var/run/docker.sock`)\n   - Called during setup, not during sync\n\n3. **`_cai_watch_docker_contexts()`**\n   - Starts continuous file watcher\n   - Uses `inotifywait` on Linux, `fswatch` on macOS\n   - Watches both directories for changes\n   - Triggers sync on create/delete/modify\n\n4. **`_cai_is_containai_docker_context()`**\n   - Check if a context path is the special `containai-docker` context\n   - Returns 0 if yes, 1 if no\n\n## Acceptance\n\n- [x] `~/.docker-cai/contexts/` mirrors `~/.docker/contexts/` (except containai-docker)\n- [x] New contexts in either dir sync to the other\n- [x] `containai-docker` context is NOT synced (different socket paths)\n- [x] Watcher uses inotifywait (Linux) or fswatch (macOS)\n- [x] Deletions sync correctly (removes from other side)\n- [x] TLS certs sync along with context metadata\n- [x] Graceful handling when watcher tools not installed\n- [x] Unit tests for sync logic\n- [ ] Integration test verifying sync behavior (deferred - requires Docker)\n\n## Done summary\nImplemented Docker context sync library at src/lib/docker-context-sync.sh\n\nKey functions:\n- _cai_sync_docker_contexts_once(): bidirectional sync\n- _cai_create_containai_docker_context(): container-local context\n- _cai_watch_docker_contexts(): continuous watcher\n- _cai_is_containai_docker_context(): context identification\n\nAll 10 unit tests passing.\n## Evidence\n- Commits: dd6b53f\n- Tests: tests/unit/test-docker-context-sync.sh\n- PRs:\n"
    },
    {
      "data": {
        "assignee": null,
        "claim_note": "",
        "claimed_at": null,
        "created_at": "2026-02-03T01:13:47.713832Z",
        "depends_on": [
          "fn-49-devcontainer-integration.4"
        ],
        "epic": "fn-49-devcontainer-integration",
        "id": "fn-49-devcontainer-integration.9",
        "priority": null,
        "spec_path": ".flow/tasks/fn-49-devcontainer-integration.9.md",
        "status": "todo",
        "title": "VS Code server-env-setup scripts",
        "updated_at": "2026-02-03T01:13:47.713846Z"
      },
      "id": "fn-49-devcontainer-integration.9",
      "runtime": null,
      "spec": "# fn-49-devcontainer-integration.9 VS Code server-env-setup scripts\n\n## Description\n\nCreate VS Code Server environment setup scripts that export `DOCKER_CONFIG` to use the ContainAI Docker configuration.\n\n### Problem\n\nWhen VS Code Remote (Server) connects to a devcontainer or remote machine, it needs to use the ContainAI Docker configuration instead of the default `~/.docker/`. VS Code Server sources `server-env-setup` scripts before launching, making this the ideal hook point.\n\n### Scripts to Create\n\n**`~/.vscode-server/server-env-setup`**:\n```bash\n#!/bin/bash\n# ContainAI: Use isolated Docker config with correct context socket paths\nexport DOCKER_CONFIG=\"$HOME/.docker-cai\"\n```\n\n**`~/.vscode-insiders/server-env-setup`**:\n```bash\n#!/bin/bash\n# ContainAI: Use isolated Docker config with correct context socket paths\nexport DOCKER_CONFIG=\"$HOME/.docker-cai\"\n```\n\n### Implementation\n\n**Location**: Add to `src/lib/devcontainer.sh`\n\n### Core Functions\n\n1. **`_cai_install_vscode_server_env_setup()`**\n   - Creates both scripts\n   - Sets executable permission (`chmod +x`)\n   - Creates parent directories if needed\n   - Idempotent (safe to run multiple times)\n\n2. **`_cai_remove_vscode_server_env_setup()`**\n   - Removes the scripts (for uninstall)\n   - Only removes if it's our script (check for ContainAI marker comment)\n\n3. **`_cai_doctor_vscode_server_env()`**\n   - Checks if scripts exist and are executable\n   - Verifies they contain the correct DOCKER_CONFIG export\n   - Reports status in `cai doctor` output\n\n### Script Requirements\n\n- Must be `chmod +x` (executable)\n- Must be owned by the user\n- Uses `#!/bin/bash` shebang (VS Code Server expects this)\n- Single export statement for simplicity\n- Contains marker comment for identification\n\n### Integration Points\n\n1. **`cai setup`**: Calls `_cai_install_vscode_server_env_setup()`\n2. **Devcontainer feature `init.sh`**: Creates scripts inside container\n3. **`cai doctor`**: Verifies scripts exist and are correct\n\n## Acceptance\n\n- [ ] `~/.vscode-server/server-env-setup` created with correct content\n- [ ] `~/.vscode-insiders/server-env-setup` created with correct content\n- [ ] Both scripts are executable (`chmod +x`)\n- [ ] Scripts export `DOCKER_CONFIG=\"$HOME/.docker-cai\"`\n- [ ] Parent directories created if missing\n- [ ] Idempotent (running twice is safe)\n- [ ] `cai doctor` verifies scripts\n- [ ] Works in devcontainer feature `init.sh`\n- [ ] Handles existing scripts gracefully (append vs overwrite)\n\n## Done summary\nTBD\n\n## Evidence\n- Commits:\n- Tests:\n- PRs:\n"
    }
  ]
}
