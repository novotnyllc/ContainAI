{
  "created_at": "2026-02-03T14:11:58.086799Z",
  "epic": {
    "data": {
      "branch_name": "fn-49-devcontainer-integration",
      "created_at": "2026-02-02T23:23:21.023759Z",
      "depends_on_epics": [],
      "id": "fn-49-devcontainer-integration",
      "next_task": 1,
      "plan_review_status": "unknown",
      "plan_reviewed_at": null,
      "spec_path": ".flow/specs/fn-49-devcontainer-integration.md",
      "status": "open",
      "title": "DevContainer Integration",
      "updated_at": "2026-02-02T23:23:21.023778Z"
    },
    "spec": "# DevContainer Integration for ContainAI\n\n## Executive Summary\n\nEnable VS Code devcontainers to run securely in sysbox with minimal friction. Users install `cai` on their host (WSL/Mac), add our feature to any devcontainer, and a VS Code extension + smart docker wrapper routes the container through sysbox.\n\n**Key insight**: The devcontainer runs **directly** in sysbox - no outer container, no nesting overhead. Our feature overlays onto whatever base image the user wants.\n\n**Security invariant**: Hard-block if not running in sysbox. Kernel-enforced checks cannot be faked.\n\n---\n\n## Architecture\n\n```\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 User's Host (WSL/Mac)                                                   \u2502\n\u2502                                                                         \u2502\n\u2502   Prerequisites (via cai setup):                                        \u2502\n\u2502   \u251c\u2500 sysbox runtime installed                                           \u2502\n\u2502   \u251c\u2500 containai-docker context (uses sysbox as default runtime)          \u2502\n\u2502   \u251c\u2500 cai-docker wrapper at ~/.local/bin/cai-docker                      \u2502\n\u2502   \u251c\u2500 VS Code ContainAI extension                                        \u2502\n\u2502   \u2514\u2500 Data volume created by 'cai import' (containai-data-<name>)        \u2502\n\u2502                                                                         \u2502\n\u2502   ~/.ssh/config (managed by cai-docker):                                \u2502\n\u2502   \u251c\u2500 Host containai-devcontainer-<workspace>                            \u2502\n\u2502   \u2502     HostName localhost                                              \u2502\n\u2502   \u2502     Port 2322                                                       \u2502\n\u2502   \u2502     User vscode                                                     \u2502\n\u2502   \u2514\u2500 (enables: ssh containai-devcontainer-myproject)                    \u2502\n\u2502                                                                         \u2502\n\u2502   \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510                                             \u2502\n\u2502   \u2502 VS Code               \u2502                                             \u2502\n\u2502   \u2502 \u251c\u2500 Dev Containers ext \u2502                                             \u2502\n\u2502   \u2502 \u2502   dockerPath \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500> cai-docker wrapper                       \u2502\n\u2502   \u2502 \u2514\u2500 ContainAI ext      \u2502        \u2502                                    \u2502\n\u2502   \u2502    (sets dockerPath)  \u2502        \u251c\u2500 Detects ContainAI markers         \u2502\n\u2502   \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518        \u251c\u2500 Routes to sysbox context          \u2502\n\u2502                                    \u251c\u2500 Mounts data volume                \u2502\n\u2502                                    \u251c\u2500 Adds labels for GC                \u2502\n\u2502                                    \u2514\u2500 Updates ~/.ssh/config             \u2502\n\u2502                                    \u2502                                    \u2502\n\u2502                                    \u25bc                                    \u2502\n\u2502   \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510   \u2502\n\u2502   \u2502 User's Devcontainer (DIRECTLY in sysbox)                        \u2502   \u2502\n\u2502   \u2502                                                                 \u2502   \u2502\n\u2502   \u2502   Base image: ANY + ContainAI feature                           \u2502   \u2502\n\u2502   \u2502                                                                 \u2502   \u2502\n\u2502   \u2502   Mounts:                                                       \u2502   \u2502\n\u2502   \u2502   \u251c\u2500 /mnt/agent-data \u2190 containai-data-<name> volume             \u2502   \u2502\n\u2502   \u2502   \u2514\u2500 /workspaces/<project> \u2190 host workspace (standard)          \u2502   \u2502\n\u2502   \u2502                                                                 \u2502   \u2502\n\u2502   \u2502   postCreateCommand (init.sh):                                  \u2502   \u2502\n\u2502   \u2502   \u251c\u2500 Verify sysbox (kernel checks)                              \u2502   \u2502\n\u2502   \u2502   \u2514\u2500 Create symlinks: ~/.claude \u2192 /mnt/agent-data/claude, etc.  \u2502   \u2502\n\u2502   \u2502                                                                 \u2502   \u2502\n\u2502   \u2502   postStartCommand (start.sh):                                  \u2502   \u2502\n\u2502   \u2502   \u251c\u2500 Start sshd on port 2322 (not systemd)                      \u2502   \u2502\n\u2502   \u2502   \u2514\u2500 Re-verify sysbox                                           \u2502   \u2502\n\u2502   \u2502                                                                 \u2502   \u2502\n\u2502   \u2502   Services:                                                     \u2502   \u2502\n\u2502   \u2502   \u251c\u2500 sshd (port 2322) - for non-VS Code access                  \u2502   \u2502\n\u2502   \u2502   \u2514\u2500 dockerd (DinD) - works without --privileged                \u2502   \u2502\n\u2502   \u2502                                                                 \u2502   \u2502\n\u2502   \u2502   Labels:                                                       \u2502   \u2502\n\u2502   \u2502   \u251c\u2500 containai.type=devcontainer                                \u2502   \u2502\n\u2502   \u2502   \u251c\u2500 containai.workspace=<project-name>                         \u2502   \u2502\n\u2502   \u2502   \u2514\u2500 containai.created=<timestamp>                              \u2502   \u2502\n\u2502   \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518   \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n```\n\n**Key points**:\n- Devcontainer runs **directly** in sysbox (no outer container overhead)\n- Data volume provides all synced configs (run `cai import` first)\n- SSH works via devcontainer port forwarding (not systemd)\n- Labels enable `cai ps`, `cai stop`, GC integration\n\n---\n\n## What ContainAI Feature Provides\n\nThe feature replicates the full `cai` experience on any base image:\n\n### 1. Sysbox Verification\n- Kernel-enforced checks that cannot be faked\n- Hard-fail if not running in sysbox\n\n### 2. Data Volume Integration\n- Mounts existing cai data volume (`containai-data-<name>`)\n- Creates symlinks from standard paths to volume (like `containai-init.sh`)\n- Synced configs: Claude, Git, GitHub CLI, shell, editors, agents, etc.\n\n### 3. Docker-in-Docker\n- Works without `--privileged` (sysbox provides this)\n- Nested containers work properly\n\n### 4. SSH Access\n- sshd runs as devcontainer service (not systemd)\n- Port forwarded via devcontainer's `forwardPorts`\n- Host SSH config entry added by cai-docker wrapper\n\n### 5. Container Lifecycle\n- Labels for cai GC integration\n- Consistent naming for `cai ps` / `cai stop`\n\n```json\n{\n    \"image\": \"mcr.microsoft.com/devcontainers/python:3.11\",\n    \"features\": {\n        \"ghcr.io/novotnyllc/containai/feature:latest\": {\n            \"dataVolume\": \"containai-data-myproject\",\n            \"enableSsh\": true,\n            \"sshPort\": 2322\n        }\n    }\n}\n```\n\n---\n\n## Component Design\n\n### 1. Smart Docker Wrapper (`cai-docker`)\n\n**Location**: `~/.local/bin/cai-docker`\n\n**Purpose**:\n- Detect ContainAI devcontainers\n- Route to sysbox context\n- Mount data volume automatically\n- Add labels for GC integration\n- Update host SSH config\n\n```bash\n#!/usr/bin/env bash\nset -euo pipefail\n\nCAI_SSH_CONFIG_MARKER=\"# ContainAI devcontainer managed\"\n\nfind_devcontainer_json() {\n    local workspace_dir=\"\"\n    while [[ $# -gt 0 ]]; do\n        case \"$1\" in\n            --workspace-folder=*) workspace_dir=\"${1#*=}\" ;;\n            --workspace-folder) workspace_dir=\"$2\"; shift ;;\n            *) ;;\n        esac\n        shift\n    done\n    [[ -z \"$workspace_dir\" ]] && return 1\n\n    for path in \\\n        \"$workspace_dir/.devcontainer/devcontainer.json\" \\\n        \"$workspace_dir/.devcontainer.json\" \\\n        \"$workspace_dir/.devcontainer/\"*/devcontainer.json\n    do\n        [[ -f \"$path\" ]] && echo \"$path\" && return 0\n    done\n    return 1\n}\n\nget_workspace_name() {\n    local workspace_dir=\"\"\n    while [[ $# -gt 0 ]]; do\n        case \"$1\" in\n            --workspace-folder=*) workspace_dir=\"${1#*=}\" ;;\n            --workspace-folder) workspace_dir=\"$2\"; shift ;;\n            *) ;;\n        esac\n        shift\n    done\n    basename \"$workspace_dir\"\n}\n\nis_containai_devcontainer() {\n    local config\n    config=$(find_devcontainer_json \"$@\") || return 1\n    sed 's|//.*$||; s|/\\*.*\\*/||g' \"$config\" | grep -qE 'containai'\n}\n\nget_data_volume_name() {\n    local workspace_name=\"$1\"\n    local config\n    config=$(find_devcontainer_json \"$@\") || echo \"\"\n\n    # Check if dataVolume is specified in feature options\n    if [[ -n \"$config\" ]]; then\n        local vol\n        vol=$(sed 's|//.*$||; s|/\\*.*\\*/||g' \"$config\" | \\\n              grep -oE '\"dataVolume\"\\s*:\\s*\"[^\"]+\"' | \\\n              sed 's/.*\"\\([^\"]*\\)\"$/\\1/' | head -1)\n        [[ -n \"$vol\" ]] && echo \"$vol\" && return\n    fi\n\n    # Default: containai-data-<workspace>\n    echo \"containai-data-${workspace_name}\"\n}\n\ncheck_containai_ready() {\n    if ! docker context inspect containai-docker &>/dev/null; then\n        cat >&2 <<'EOF'\n\u2554\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2557\n\u2551  ContainAI: Not set up. Run: cai setup                            \u2551\n\u255a\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u255d\nEOF\n        return 1\n    fi\n    return 0\n}\n\n# Add SSH config entry for this devcontainer\nupdate_ssh_config() {\n    local workspace_name=\"$1\"\n    local ssh_port=\"${2:-2322}\"\n    local host_alias=\"containai-devcontainer-${workspace_name}\"\n    local ssh_config=\"$HOME/.ssh/config\"\n\n    mkdir -p \"$HOME/.ssh\"\n    touch \"$ssh_config\"\n    chmod 600 \"$ssh_config\"\n\n    # Remove existing entry for this workspace\n    if grep -q \"Host $host_alias\" \"$ssh_config\" 2>/dev/null; then\n        # Remove the block (Host line through next Host or EOF)\n        sed -i.bak \"/Host $host_alias/,/^Host /{ /^Host $host_alias/d; /^Host /!d; }\" \"$ssh_config\"\n    fi\n\n    # Add new entry\n    cat >> \"$ssh_config\" << EOF\n\n$CAI_SSH_CONFIG_MARKER\nHost $host_alias\n    HostName localhost\n    Port $ssh_port\n    User vscode\n    StrictHostKeyChecking no\n    UserKnownHostsFile /dev/null\nEOF\n    echo \"SSH: ssh $host_alias\" >&2\n}\n\n# Check if image is a ContainAI image\nis_containai_image() {\n    local image=\"$1\"\n    [[ \"$image\" == *\"containai\"* ]] || [[ \"$image\" == \"ghcr.io/novotnyllc/containai\"* ]]\n}\n\n# Get user from devcontainer.json (remoteUser or containerUser)\nget_devcontainer_user() {\n    local config=\"$1\"\n    sed 's|//.*$||; s|/\\*.*\\*/||g' \"$config\" | \\\n        grep -oE '\"(remoteUser|containerUser)\"\\s*:\\s*\"[^\"]+\"' | \\\n        head -1 | sed 's/.*\"\\([^\"]*\\)\"$/\\1/'\n}\n\n# Inject volume mount, labels, and user into docker run/create commands\ninject_containai_args() {\n    local workspace_name=\"$1\"\n    local data_volume=\"$2\"\n    local config=\"$3\"\n    local image=\"$4\"\n    shift 4\n\n    local args=()\n    local found_run_or_create=false\n\n    for arg in \"$@\"; do\n        args+=(\"$arg\")\n\n        if [[ \"$arg\" == \"run\" || \"$arg\" == \"create\" ]]; then\n            found_run_or_create=true\n\n            # Inject data volume mount (if volume exists)\n            if docker --context containai-docker volume inspect \"$data_volume\" &>/dev/null; then\n                args+=(\"-v\" \"${data_volume}:/mnt/agent-data:rw\")\n            fi\n\n            # Inject labels for cai integration\n            args+=(\"--label\" \"containai.type=devcontainer\")\n            args+=(\"--label\" \"containai.workspace=${workspace_name}\")\n            args+=(\"--label\" \"containai.created=$(date -Iseconds)\")\n\n            # Inject -u agent for ContainAI images (unless user specified in devcontainer.json)\n            if is_containai_image \"$image\"; then\n                local specified_user\n                specified_user=$(get_devcontainer_user \"$config\")\n                if [[ -z \"$specified_user\" ]]; then\n                    args+=(\"-u\" \"agent\")\n                fi\n            fi\n        fi\n    done\n\n    printf '%s\\0' \"${args[@]}\"\n}\n\nmain() {\n    if is_containai_devcontainer \"$@\"; then\n        check_containai_ready || exit 1\n\n        local workspace_name\n        workspace_name=$(get_workspace_name \"$@\")\n\n        local data_volume\n        data_volume=$(get_data_volume_name \"$workspace_name\" \"$@\")\n\n        local config\n        config=$(find_devcontainer_json \"$@\")\n\n        local image\n        image=$(get_image_from_args \"$@\")\n\n        # Update SSH config\n        update_ssh_config \"$workspace_name\" 2322\n\n        # Inject mounts, labels, and user, then exec\n        local -a modified_args\n        while IFS= read -r -d '' arg; do\n            modified_args+=(\"$arg\")\n        done < <(inject_containai_args \"$workspace_name\" \"$data_volume\" \"$config\" \"$image\" \"$@\")\n\n        exec docker --context containai-docker \"${modified_args[@]}\"\n    else\n        exec docker \"$@\"\n    fi\n}\n\nmain \"$@\"\n```\n\n---\n\n### 2. VS Code Extension (`vscode-containai`)\n\n**Distribution**:\n- VS Code Marketplace\n- Open VSX\n- Installed by `cai setup`\n\n**Purpose**: Set `dev.containers.dockerPath` when ContainAI feature detected.\n\n```typescript\nimport * as vscode from 'vscode';\nimport * as fs from 'fs';\nimport * as path from 'path';\n\nexport function activate(context: vscode.ExtensionContext) {\n    const workspaceFolder = vscode.workspace.workspaceFolders?.[0];\n    if (!workspaceFolder) return;\n\n    const devcontainerPath = findDevcontainerJson(workspaceFolder.uri.fsPath);\n    if (!devcontainerPath) return;\n\n    if (hasContainAIMarkers(devcontainerPath)) {\n        const caiDockerPath = findCaiDocker();\n        if (caiDockerPath) {\n            vscode.workspace.getConfiguration('dev.containers').update(\n                'dockerPath',\n                caiDockerPath,\n                vscode.ConfigurationTarget.Workspace\n            );\n            vscode.window.showInformationMessage(\n                'ContainAI: Devcontainer will run in sysbox sandbox.'\n            );\n        } else {\n            vscode.window.showWarningMessage(\n                'ContainAI feature detected but cai not installed. ' +\n                'Run: curl -fsSL https://containai.dev/install | sh'\n            );\n        }\n    }\n}\n\nfunction hasContainAIMarkers(devcontainerPath: string): boolean {\n    const content = fs.readFileSync(devcontainerPath, 'utf8')\n        .replace(/\\/\\/.*$/gm, '')\n        .replace(/\\/\\*[\\s\\S]*?\\*\\//g, '');\n    return content.includes('containai');\n}\n\nfunction findCaiDocker(): string | null {\n    const candidates = [\n        path.join(process.env.HOME || '', '.local/bin/cai-docker'),\n        '/usr/local/bin/cai-docker'\n    ];\n    return candidates.find(p => fs.existsSync(p)) || null;\n}\n```\n\n---\n\n### 3. ContainAI Feature\n\n**Distribution**: `ghcr.io/novotnyllc/containai/feature:latest`\n\n**devcontainer-feature.json**:\n```json\n{\n    \"id\": \"containai\",\n    \"version\": \"1.0.0\",\n    \"name\": \"ContainAI Sysbox Sandbox\",\n    \"description\": \"Full ContainAI experience: sysbox, data sync, SSH, DinD\",\n    \"documentationURL\": \"https://github.com/novotnyllc/containai\",\n    \"options\": {\n        \"dataVolume\": {\n            \"type\": \"string\",\n            \"default\": \"\",\n            \"description\": \"Name of cai data volume to mount (e.g., containai-data-myproject)\"\n        },\n        \"enableSsh\": {\n            \"type\": \"boolean\",\n            \"default\": true,\n            \"description\": \"Run sshd for non-VS Code access\"\n        },\n        \"sshPort\": {\n            \"type\": \"string\",\n            \"default\": \"2322\",\n            \"description\": \"SSH port to expose (will be forwarded)\"\n        },\n        \"installDocker\": {\n            \"type\": \"boolean\",\n            \"default\": true,\n            \"description\": \"Install Docker for DinD\"\n        },\n        \"remoteUser\": {\n            \"type\": \"string\",\n            \"default\": \"auto\",\n            \"description\": \"User for symlinks (auto-detects vscode/node/root)\"\n        }\n    },\n    \"mounts\": [],\n    \"postCreateCommand\": \"/usr/local/share/containai/init.sh\",\n    \"postStartCommand\": \"/usr/local/share/containai/start.sh\"\n}\n```\n\n**install.sh** (runs at build time):\n```bash\n#!/usr/bin/env bash\nset -euo pipefail\n\nDATA_VOLUME=\"${DATAVOLUME:-}\"\nENABLE_SSH=\"${ENABLESSH:-true}\"\nSSH_PORT=\"${SSHPORT:-2322}\"\nINSTALL_DOCKER=\"${INSTALLDOCKER:-true}\"\nREMOTE_USER=\"${REMOTEUSER:-auto}\"\n\nmkdir -p /usr/local/share/containai\n\n# Store config for runtime scripts\ncat > /usr/local/share/containai/config << EOF\nDATA_VOLUME=\"$DATA_VOLUME\"\nENABLE_SSH=\"$ENABLE_SSH\"\nSSH_PORT=\"$SSH_PORT\"\nREMOTE_USER=\"$REMOTE_USER\"\nEOF\n\n# \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n# SYSBOX VERIFICATION (kernel-enforced, cannot be faked)\n# \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n\ncat > /usr/local/share/containai/verify-sysbox.sh << 'VERIFY_EOF'\n#!/usr/bin/env bash\nset -euo pipefail\n\nCHECKS_REQUIRED=3\n\nverify_sysbox() {\n    local passed=0\n\n    echo \"ContainAI Sysbox Verification\"\n    echo \"\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\"\n\n    # Check 1: UID mapping (sysbox maps 0 \u2192 high UID)\n    if [[ -f /proc/self/uid_map ]]; then\n        if ! grep -qE '^[[:space:]]*0[[:space:]]+0[[:space:]]' /proc/self/uid_map; then\n            ((passed++))\n            echo \"  \u2713 UID mapping: sysbox user namespace\"\n        else\n            echo \"  \u2717 UID mapping: 0\u21920 (not sysbox)\"\n        fi\n    fi\n\n    # Check 2: Nested user namespace (sysbox allows, docker blocks)\n    if unshare --user --map-root-user true 2>/dev/null; then\n        ((passed++))\n        echo \"  \u2713 Nested userns: allowed\"\n    else\n        echo \"  \u2717 Nested userns: blocked\"\n    fi\n\n    # Check 3: Sysbox-fs mounts\n    if grep -qE \"sysboxfs|fuse\\.sysbox\" /proc/mounts 2>/dev/null; then\n        ((passed++))\n        echo \"  \u2713 Sysboxfs: mounted\"\n    else\n        echo \"  \u2717 Sysboxfs: not found\"\n    fi\n\n    # Check 4: CAP_SYS_ADMIN works (sysbox userns)\n    local testdir=$(mktemp -d)\n    if mount -t tmpfs none \"$testdir\" 2>/dev/null; then\n        umount \"$testdir\" 2>/dev/null\n        ((passed++))\n        echo \"  \u2713 Capabilities: CAP_SYS_ADMIN works\"\n    else\n        echo \"  \u2717 Capabilities: mount denied\"\n    fi\n    rmdir \"$testdir\" 2>/dev/null || true\n\n    echo \"\"\n    echo \"Passed: $passed / $CHECKS_REQUIRED required\"\n    [[ $passed -ge $CHECKS_REQUIRED ]]\n}\n\nif ! verify_sysbox; then\n    cat >&2 <<'ERROR'\n\n\u2554\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2557\n\u2551  \ud83d\uded1 ContainAI: NOT running in sysbox                              \u2551\n\u2551                                                                   \u2551\n\u2551  To fix:                                                          \u2551\n\u2551    1. Install ContainAI: curl -fsSL https://containai.dev | sh    \u2551\n\u2551    2. Run: cai setup && cai import                                \u2551\n\u2551    3. Reopen this devcontainer                                    \u2551\n\u255a\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u255d\nERROR\n    exit 1\nfi\necho \"\u2713 Running in sysbox sandbox\"\nVERIFY_EOF\nchmod +x /usr/local/share/containai/verify-sysbox.sh\n\n# \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n# INIT SCRIPT (postCreateCommand - runs once after container created)\n# Mirrors containai-init.sh: creates symlinks from ~ to data volume\n# \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n\ncat > /usr/local/share/containai/init.sh << 'INIT_EOF'\n#!/usr/bin/env bash\nset -euo pipefail\n\nsource /usr/local/share/containai/config\n\n# Verify sysbox first\n/usr/local/share/containai/verify-sysbox.sh || exit 1\n\nDATA_DIR=\"/mnt/agent-data\"\n\n# Detect user home\nif [[ \"$REMOTE_USER\" == \"auto\" ]]; then\n    if [[ -d /home/vscode ]]; then\n        USER_HOME=\"/home/vscode\"\n    elif [[ -d /home/node ]]; then\n        USER_HOME=\"/home/node\"\n    else\n        USER_HOME=\"$HOME\"\n    fi\nelse\n    USER_HOME=\"/home/$REMOTE_USER\"\nfi\n\necho \"ContainAI init: Setting up symlinks in $USER_HOME\"\n\n# Only set up symlinks if data volume is mounted\nif [[ ! -d \"$DATA_DIR\" ]]; then\n    echo \"Warning: Data volume not mounted at $DATA_DIR\"\n    echo \"Run 'cai import' on host, then rebuild container with dataVolume option\"\n    exit 0\nfi\n\n# \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n# Symlink creation (mirrors sync-manifest.toml structure)\n# \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\ncreate_symlink() {\n    local target=\"$1\"  # Path in data volume (relative to $DATA_DIR)\n    local link=\"$2\"    # Path in user home (relative to $USER_HOME)\n\n    local full_target=\"$DATA_DIR/$target\"\n    local full_link=\"$USER_HOME/$link\"\n\n    # Skip if target doesn't exist in volume\n    [[ -e \"$full_target\" ]] || return 0\n\n    # Create parent directory\n    mkdir -p \"$(dirname \"$full_link\")\"\n\n    # Remove existing (file or dir) and create symlink\n    rm -rf \"$full_link\"\n    ln -sfn \"$full_target\" \"$full_link\"\n    echo \"  \u2713 $link \u2192 $target\"\n}\n\n# Claude Code\ncreate_symlink \"claude/claude.json\" \".claude.json\"\ncreate_symlink \"claude/credentials.json\" \".claude/.credentials.json\"\ncreate_symlink \"claude/settings.json\" \".claude/settings.json\"\ncreate_symlink \"claude/settings.local.json\" \".claude/settings.local.json\"\ncreate_symlink \"claude/plugins\" \".claude/plugins\"\ncreate_symlink \"claude/skills\" \".claude/skills\"\ncreate_symlink \"claude/commands\" \".claude/commands\"\ncreate_symlink \"claude/agents\" \".claude/agents\"\ncreate_symlink \"claude/hooks\" \".claude/hooks\"\ncreate_symlink \"claude/CLAUDE.md\" \".claude/CLAUDE.md\"\n\n# GitHub CLI\ncreate_symlink \"config/gh/hosts.yml\" \".config/gh/hosts.yml\"\ncreate_symlink \"config/gh/config.yml\" \".config/gh/config.yml\"\n\n# Git\ncreate_symlink \"git/gitconfig\" \".gitconfig\"\ncreate_symlink \"git/gitignore_global\" \".gitignore_global\"\n\n# Shell\ncreate_symlink \"shell/bash_aliases\" \".bash_aliases_imported\"\ncreate_symlink \"shell/zshrc\" \".zshrc\"\ncreate_symlink \"shell/inputrc\" \".inputrc\"\ncreate_symlink \"shell/oh-my-zsh-custom\" \".oh-my-zsh/custom\"\n\n# Editors\ncreate_symlink \"editors/vimrc\" \".vimrc\"\ncreate_symlink \"editors/vim\" \".vim\"\ncreate_symlink \"config/nvim\" \".config/nvim\"\n\n# Prompt\ncreate_symlink \"config/starship.toml\" \".config/starship.toml\"\n\n# tmux\ncreate_symlink \"config/tmux\" \".config/tmux\"\n\n# Other agents (optional - only if present in volume)\ncreate_symlink \"gemini/settings.json\" \".gemini/settings.json\"\ncreate_symlink \"codex/config.toml\" \".codex/config.toml\"\n\necho \"ContainAI init complete\"\nINIT_EOF\nchmod +x /usr/local/share/containai/init.sh\n\n# \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n# START SCRIPT (postStartCommand - runs every container start)\n# \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n\ncat > /usr/local/share/containai/start.sh << 'START_EOF'\n#!/usr/bin/env bash\nset -euo pipefail\n\nsource /usr/local/share/containai/config\n\n# Start sshd if enabled (devcontainer-style, not systemd)\nif [[ \"$ENABLE_SSH\" == \"true\" ]]; then\n    if command -v sshd &>/dev/null; then\n        # Generate host keys if missing\n        [[ -f /etc/ssh/ssh_host_rsa_key ]] || ssh-keygen -A\n\n        # Start sshd on configured port (non-privileged port for non-root)\n        /usr/sbin/sshd -p \"$SSH_PORT\" -o \"PidFile=/tmp/sshd.pid\"\n        echo \"\u2713 sshd started on port $SSH_PORT\"\n    fi\nfi\n\n# Re-verify sysbox (in case container was restarted on different host)\n/usr/local/share/containai/verify-sysbox.sh\nSTART_EOF\nchmod +x /usr/local/share/containai/start.sh\n\n# \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n# INSTALL DEPENDENCIES\n# \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n\n# SSH server (if enabled)\nif [[ \"$ENABLE_SSH\" == \"true\" ]]; then\n    apt-get update && apt-get install -y openssh-server\n    mkdir -p /var/run/sshd\nfi\n\n# Docker for DinD (sysbox provides isolation)\nif [[ \"$INSTALL_DOCKER\" == \"true\" ]]; then\n    curl -fsSL https://get.docker.com | sh\n    echo \"Docker installed. DinD works without --privileged in sysbox.\"\nfi\n\necho \"ContainAI feature installed.\"\n```\n\n---\n\n## Detection Matrix\n\n| Scenario            | UID Map | unshare | Sysboxfs | Cap Probe | Total | Result |\n|---------------------|---------|---------|----------|-----------|-------|--------|\n| Sysbox (correct)    | \u2713       | \u2713       | \u2713        | \u2713         | 4     | PASS   |\n| Regular docker      | \u2717       | \u2717      | \u2717        | \u2717         | 0     | FAIL   |\n| Docker --privileged | \u2717       | \u2713       | \u2717        | \u2713         | 2     | FAIL   |\n\n**Minimum required: 3 checks**\n\n**Why these can't be faked**:\n- UID mapping is kernel-enforced (you can't change /proc/self/uid_map)\n- unshare capability requires kernel permission\n- Sysboxfs mounts are kernel-level\n- CAP_SYS_ADMIN in userns is kernel-enforced\n\n---\n\n## User Flows\n\n### Flow A: New devcontainer with ContainAI\n\n1. User has `cai setup` done (one-time)\n2. User adds ContainAI feature to devcontainer.json:\n   ```json\n   {\n       \"image\": \"mcr.microsoft.com/devcontainers/python:3.11\",\n       \"features\": {\n           \"ghcr.io/novotnyllc/containai/feature:latest\": {}\n       }\n   }\n   ```\n3. VS Code extension detects feature, sets dockerPath to cai-docker\n4. User clicks \"Reopen in Container\"\n5. cai-docker routes to containai-docker context (sysbox runtime)\n6. Container starts **directly in sysbox**\n7. postStartCommand verifies sysbox, passes\n8. User works in secure sandbox\n\n### Flow B: User without cai tries to open ContainAI devcontainer\n\n1. User opens repo with ContainAI feature\n2. VS Code extension warns: \"cai not installed\"\n3. User clicks \"Reopen in Container\" anyway\n4. Regular docker runs container (not sysbox)\n5. postStartCommand runs verify-sandbox.sh\n6. Kernel checks fail (UID map 0\u21920, unshare blocked, no sysboxfs)\n7. **Hard-fail with clear error message**\n8. User installs cai, reopens\n\n### Flow C: Attacker tries to bypass\n\n```bash\n# None of these work:\ndocker run --env FAKE_SYSBOX=1 ...           # We don't check env vars\ndocker run --privileged ...                   # Only 2/4 checks pass\ndocker run --cap-add=ALL ...                  # Still not sysbox\n```\n\nThe checks are kernel-enforced. No userspace bypass possible.\n\n---\n\n## containai-docker Context Setup\n\nThe context is configured by `cai setup`:\n\n```bash\n# Create context that uses sysbox runtime\ndocker context create containai-docker \\\n    --docker \"host=unix:///var/run/docker.sock\"\n\n# Configure daemon to use sysbox for this context\n# (actual implementation depends on platform)\n```\n\n**daemon.json for containai context**:\n```json\n{\n    \"default-runtime\": \"sysbox-runc\",\n    \"runtimes\": {\n        \"sysbox-runc\": {\n            \"path\": \"/usr/bin/sysbox-runc\"\n        }\n    }\n}\n```\n\n---\n\n## Implementation Phases\n\n**1.1 cai-docker wrapper**\n- [ ] Marker detection in devcontainer.json\n- [ ] Context routing logic\n- [ ] Install via `cai setup`\n\n**1.2 ContainAI feature**\n- [ ] Feature structure (devcontainer-feature.json, install.sh)\n- [ ] Sysbox verification script (kernel checks)\n- [ ] Optional Docker installation\n- [ ] Publish to ghcr.io\n\n**1.3 VS Code extension**\n- [ ] Activate on devcontainer.json presence\n- [ ] Detect ContainAI markers\n- [ ] Set dockerPath to cai-docker\n- [ ] Publish to VS Code Marketplace + Open VSX\n\n### Phase 2: Testing\n- [ ] Test: Sysbox \u2192 verification passes\n- [ ] Test: Regular docker \u2192 verification fails\n- [ ] Test: --privileged \u2192 verification fails (only 2 checks)\n- [ ] Test: VS Code extension sets dockerPath\n- [ ] Test: DinD works inside sysbox devcontainer\n\n### Phase 3: Polish\n\n- [ ] Documentation: \"Adding ContainAI to your devcontainer\"\n- [ ] Template examples\n- [ ] `cai doctor` checks for devcontainer compatibility\n\n---\n\n## Resolved Design Decisions\n\n1. **No outer container**: Devcontainer runs directly in sysbox\n2. **No env vars**: Kernel checks only (can't be faked)\n3. **No cryptographic verification**: Not needed when running directly in sysbox\n4. **Hard-block on failure**: No \"reduced isolation\" mode\n5. **Extension distribution**: cai setup + marketplaces\n\n---\n\n## Acceptance Criteria\n\n### Core\n- [ ] cai-docker routes ContainAI devcontainers to sysbox context\n- [ ] ContainAI feature installs on any base image\n- [ ] Verification uses kernel-enforced checks only\n- [ ] Hard-fail with clear message when not in sysbox\n\n### VS Code Extension\n- [ ] Detects ContainAI feature\n- [ ] Sets dockerPath automatically\n- [ ] Published to VS Code Marketplace and Open VSX\n\n### Security\n- [ ] Sysbox devcontainers pass verification (4 checks)\n- [ ] Regular docker fails verification (0 checks)\n- [ ] --privileged fails verification (2 checks, need 3)\n- [ ] No env var or userspace bypass possible\n\n---\n\n## Docker Context Sync Architecture\n\nThe devcontainer needs access to the host's Docker contexts (for tools like Docker CLI), but with different socket paths. The host uses SSH-based context for `containai-docker`, while the container uses a local Unix socket.\n\n### Context Directory Structure\n\n```\n~/.docker/contexts/           # Host's contexts (SSH sockets)\n~/.docker-cai/contexts/       # ContainAI contexts (Unix sockets for container)\n```\n\n### Sync Rules\n\n1. **Host \u2192 Container direction** (`~/.docker/contexts` \u2192 `~/.docker-cai/contexts`):\n   - All contexts EXCEPT `containai-docker` are copied verbatim\n   - The `containai-docker` context gets a modified socket path (Unix instead of SSH)\n\n2. **Container \u2192 Host direction** (`~/.docker-cai/contexts` \u2192 `~/.docker/contexts`):\n   - New contexts created in the container are synced back\n   - `containai-docker` is excluded (different socket paths intentional)\n\n3. **containai-docker special handling**:\n   - Host version: SSH socket (`ssh://user@host`)\n   - Container version: Unix socket (`unix:///var/run/docker.sock`)\n\n### Sync Daemon\n\nA lightweight watcher process monitors both directories for changes:\n- Uses inotifywait (Linux) or fswatch (macOS) for efficiency\n- Handles creates, deletes, and modifications\n- Excludes `containai-docker` from bidirectional sync\n\n### Implementation\n\nLocation: `src/lib/docker-context-sync.sh`\n\nKey functions:\n- `_cai_sync_docker_contexts()` - one-time sync\n- `_cai_watch_docker_contexts()` - continuous watcher\n- `_cai_is_containai_docker_context()` - check if context is the special one\n\n---\n\n## VS Code Server Environment Setup\n\nVS Code Remote (Server) needs `DOCKER_CONFIG` set to use the ContainAI Docker configuration. This is done via server-env-setup scripts.\n\n### Scripts\n\n**Location**: Both scripts go in the user's home directory and must be executable.\n\n**`~/.vscode-server/server-env-setup`**:\n```bash\n#!/bin/bash\nexport DOCKER_CONFIG=\"$HOME/.docker-cai\"\n```\n\n**`~/.vscode-insiders/server-env-setup`** (for VS Code Insiders):\n```bash\n#!/bin/bash\nexport DOCKER_CONFIG=\"$HOME/.docker-cai\"\n```\n\n### Script Requirements\n\n- Scripts must be `chmod +x`\n- Created by `cai setup` and/or the devcontainer feature\n- VS Code Server sources these before launching\n\n### Integration\n\nThese scripts ensure that when VS Code Server runs Docker commands (via Dev Containers extension), they use the ContainAI configuration which:\n- Points to `~/.docker-cai/contexts` for context resolution\n- Uses the Unix socket version of `containai-docker` context\n- Maintains proper isolation from host Docker contexts\n\n---\n\n## References\n\n- [Sysbox User Guide](https://github.com/nestybox/sysbox/tree/master/docs/user-guide)\n- [Dev Container Features](https://containers.dev/implementors/features/)\n- [fn-13-1c7 Research](../research/fn-13-1c7/RECOMMENDATIONS.md)\n"
  },
  "epic_id": "fn-49-devcontainer-integration",
  "schema_version": 2,
  "tasks": [
    {
      "data": {
        "assignee": null,
        "claim_note": "",
        "claimed_at": null,
        "created_at": "2026-02-02T23:23:51.209346Z",
        "depends_on": [],
        "epic": "fn-49-devcontainer-integration",
        "id": "fn-49-devcontainer-integration.1",
        "priority": null,
        "spec_path": ".flow/tasks/fn-49-devcontainer-integration.1.md",
        "status": "todo",
        "title": "Implement cai-docker wrapper",
        "updated_at": "2026-02-02T23:23:51.209360Z"
      },
      "id": "fn-49-devcontainer-integration.1",
      "runtime": null,
      "spec": "# fn-49-devcontainer-integration.1 Implement cai-docker wrapper\n\n## Description\n\nCreate the smart docker wrapper (`cai-docker`) that detects ContainAI devcontainers and routes them to the sysbox runtime context.\n\n### Location\n`src/devcontainer/cai-docker` (shell script)\n\n### Core Functions\n\n1. **Devcontainer detection**: Parse `--workspace-folder` arg, find `devcontainer.json`\n2. **ContainAI marker detection**: Check for `containai` in feature references\n3. **Data volume injection**: Add `-v containai-data-<name>:/mnt/agent-data:rw` to run/create\n4. **Label injection**: Add `containai.type`, `containai.workspace`, `containai.created`\n5. **User injection**: Add `-u agent` for ContainAI images (unless devcontainer specifies user)\n6. **SSH config management**: Update `~/.ssh/config` with host alias for workspace\n7. **Context routing**: Exec to `docker --context containai-docker`\n\n### Key Functions\n\nSee epic spec for full implementation. Key elements:\n- `find_devcontainer_json()` - locate devcontainer.json\n- `is_containai_devcontainer()` - check for containai marker\n- `get_data_volume_name()` - extract or derive volume name\n- `inject_containai_args()` - insert volume mount, labels, and user flag\n- `update_ssh_config()` - manage SSH host entries\n- `is_containai_image()` - check if image is a ContainAI image\n- `get_devcontainer_user()` - extract remoteUser/containerUser from devcontainer.json\n\n### User Injection Logic\n\nWhen running a ContainAI image, inject `-u agent` unless the devcontainer specifies a different user:\n\n```bash\n# Check if devcontainer.json specifies a user\nget_devcontainer_user() {\n    local config=\"$1\"\n    # Check remoteUser first, then containerUser\n    local user\n    user=$(jq -r '.remoteUser // .containerUser // empty' \"$config\" 2>/dev/null)\n    echo \"$user\"\n}\n\n# Check if image is ContainAI\nis_containai_image() {\n    local image=\"$1\"\n    [[ \"$image\" == *\"containai\"* ]] || [[ \"$image\" == \"ghcr.io/novotnyllc/containai\"* ]]\n}\n\n# In inject_containai_args():\nif is_containai_image \"$image\"; then\n    local specified_user\n    specified_user=$(get_devcontainer_user \"$config\")\n    if [[ -z \"$specified_user\" ]]; then\n        args+=(\"-u\" \"agent\")\n    fi\nfi\n```\n\n**Precedence**:\n1. If `remoteUser` set in devcontainer.json \u2192 use that (no injection)\n2. If `containerUser` set in devcontainer.json \u2192 use that (no injection)\n3. If ContainAI image and no user specified \u2192 inject `-u agent`\n4. If not ContainAI image \u2192 no injection (let image default apply)\n\n### Installation Path\n- `~/.local/bin/cai-docker` (installed by `cai setup`)\n\n## Acceptance\n\n- [ ] Detects ContainAI marker in devcontainer.json (with/without JSONC comments)\n- [ ] Routes to `containai-docker` context when marker found\n- [ ] Passes through to regular docker when no marker\n- [ ] Injects data volume mount if volume exists\n- [ ] Adds containai labels for GC integration\n- [ ] Injects `-u agent` for ContainAI images when no user specified in devcontainer.json\n- [ ] Respects `remoteUser`/`containerUser` from devcontainer.json (no `-u` injection)\n- [ ] Updates ~/.ssh/config with workspace SSH alias\n- [ ] Works with VS Code Dev Containers extension\n\n## Done summary\nTBD\n\n## Evidence\n- Commits:\n- Tests:\n- PRs:\n"
    },
    {
      "data": {
        "assignee": null,
        "claim_note": "",
        "claimed_at": null,
        "created_at": "2026-02-02T23:23:51.851810Z",
        "depends_on": [],
        "epic": "fn-49-devcontainer-integration",
        "id": "fn-49-devcontainer-integration.2",
        "priority": null,
        "spec_path": ".flow/tasks/fn-49-devcontainer-integration.2.md",
        "status": "todo",
        "title": "Create ContainAI devcontainer feature",
        "updated_at": "2026-02-02T23:23:51.851823Z"
      },
      "id": "fn-49-devcontainer-integration.2",
      "runtime": null,
      "spec": "# fn-49-devcontainer-integration.2 Create ContainAI devcontainer feature\n\n## Description\n\nCreate the ContainAI devcontainer feature that provides sysbox verification, symlink creation, SSH service, and DinD support.\n\n### Feature Structure\n\n```\nsrc/devcontainer/feature/\n\u251c\u2500\u2500 devcontainer-feature.json\n\u251c\u2500\u2500 install.sh\n\u251c\u2500\u2500 verify-sysbox.sh\n\u251c\u2500\u2500 init.sh\n\u2514\u2500\u2500 start.sh\n```\n\n### devcontainer-feature.json Options\n\n- `dataVolume`: Name of cai data volume (default: auto-derived)\n- `enableSsh`: Run sshd for non-VS Code access (default: true)\n- `sshPort`: SSH port (default: 2322)\n- `installDocker`: Install Docker for DinD (default: true)\n- `remoteUser`: User for symlinks (default: auto-detect)\n\n### Scripts\n\n1. **install.sh** (build-time)\n   - Store config to `/usr/local/share/containai/config`\n   - Create verify-sysbox.sh, init.sh, start.sh\n   - Install openssh-server if enableSsh\n   - Install Docker if installDocker\n\n2. **verify-sysbox.sh**\n   - UID map check (0 not mapped to 0)\n   - Nested userns test (unshare --user)\n   - Sysboxfs mount check\n   - CAP_SYS_ADMIN capability probe\n   - Require 3+ checks to pass\n\n3. **init.sh** (postCreateCommand)\n   - Run sysbox verification\n   - Create symlinks from ~ to /mnt/agent-data (mirrors sync-manifest.toml)\n   - Symlinks: Claude, Git, GitHub CLI, shell, editors, etc.\n\n4. **start.sh** (postStartCommand)\n   - Start sshd if enabled\n   - Re-verify sysbox\n\n### Symlinks Created (based on sync-manifest.toml)\n\n- `~/.claude.json` \u2192 `/mnt/agent-data/claude/claude.json`\n- `~/.claude/credentials.json` \u2192 `/mnt/agent-data/claude/credentials.json`\n- `~/.gitconfig` \u2192 `/mnt/agent-data/git/gitconfig`\n- `~/.config/gh/hosts.yml` \u2192 `/mnt/agent-data/config/gh/hosts.yml`\n- (and more per manifest)\n\n## Acceptance\n\n- [ ] Feature installs on any base image (Debian/Ubuntu preferred)\n- [ ] Sysbox verification passes in sysbox, fails in regular docker\n- [ ] Symlinks created correctly when data volume mounted\n- [ ] SSH starts on configured port\n- [ ] Docker available for DinD when enabled\n- [ ] Hard-fail with clear error message when not in sysbox\n\n## Done summary\nTBD\n\n## Evidence\n- Commits:\n- Tests:\n- PRs:\n"
    },
    {
      "data": {
        "assignee": null,
        "claim_note": "",
        "claimed_at": null,
        "created_at": "2026-02-02T23:23:53.586944Z",
        "depends_on": [
          "fn-49-devcontainer-integration.1"
        ],
        "epic": "fn-49-devcontainer-integration",
        "id": "fn-49-devcontainer-integration.3",
        "priority": null,
        "spec_path": ".flow/tasks/fn-49-devcontainer-integration.3.md",
        "status": "todo",
        "title": "Build VS Code extension (vscode-containai)",
        "updated_at": "2026-02-02T23:24:03.121365Z"
      },
      "id": "fn-49-devcontainer-integration.3",
      "runtime": null,
      "spec": "# fn-49-devcontainer-integration.3 Build VS Code extension (vscode-containai)\n\n## Description\n\nCreate VS Code extension that detects ContainAI features in devcontainer.json and sets `dockerPath` to the cai-docker wrapper.\n\n### Extension Structure\n\n```\nvscode-containai/\n\u251c\u2500\u2500 package.json\n\u251c\u2500\u2500 src/\n\u2502   \u2514\u2500\u2500 extension.ts\n\u251c\u2500\u2500 tsconfig.json\n\u2514\u2500\u2500 README.md\n```\n\n### Extension Logic\n\n1. **Activation**: On workspace containing devcontainer.json\n2. **Detection**: Parse devcontainer.json for `containai` marker\n3. **Configuration**: Set `dev.containers.dockerPath` to cai-docker path\n4. **Notification**: Show info message that container will use sysbox\n5. **Warning**: If cai-docker not found, show installation instructions\n\n### Key Functions\n\n- `findDevcontainerJson()` - locate devcontainer.json in workspace\n- `hasContainAIMarkers()` - check for containai in feature references\n- `findCaiDocker()` - find cai-docker wrapper path\n- `configureDockerPath()` - set dev.containers.dockerPath\n\n### Distribution\n\n- VS Code Marketplace (marketplace.visualstudio.com)\n- Open VSX (open-vsx.org)\n- Bundled with cai setup\n\n## Acceptance\n\n- [ ] Activates when devcontainer.json present\n- [ ] Detects ContainAI feature in devcontainer.json\n- [ ] Sets dockerPath to cai-docker when detected\n- [ ] Shows info message about sysbox sandboxing\n- [ ] Shows warning when cai not installed\n- [ ] Works on Windows (WSL), Mac, Linux\n\n## Done summary\nTBD\n\n## Evidence\n- Commits:\n- Tests:\n- PRs:\n"
    },
    {
      "data": {
        "assignee": null,
        "claim_note": "",
        "claimed_at": null,
        "created_at": "2026-02-02T23:23:54.640246Z",
        "depends_on": [
          "fn-49-devcontainer-integration.1",
          "fn-49-devcontainer-integration.2",
          "fn-49-devcontainer-integration.3"
        ],
        "epic": "fn-49-devcontainer-integration",
        "id": "fn-49-devcontainer-integration.4",
        "priority": null,
        "spec_path": ".flow/tasks/fn-49-devcontainer-integration.4.md",
        "status": "todo",
        "title": "Integrate into cai setup workflow",
        "updated_at": "2026-02-02T23:24:04.931658Z"
      },
      "id": "fn-49-devcontainer-integration.4",
      "runtime": null,
      "spec": "# fn-49-devcontainer-integration.4 Integrate into cai setup workflow\n\n## Description\n\nExtend `cai setup` to install cai-docker wrapper and VS Code extension, and configure the containai-docker context.\n\n### Changes to cai setup\n\nAdd new setup steps after sysbox installation:\n\n1. **Install cai-docker wrapper**\n   - Copy to `~/.local/bin/cai-docker`\n   - Make executable\n   - Ensure `~/.local/bin` in PATH\n\n2. **Create containai-docker context** (if not exists)\n   - `docker context create containai-docker --docker \"host=unix:///var/run/docker.sock\"`\n   - Configure to use sysbox-runc as default runtime\n\n3. **Install VS Code extension**\n   - Check if VS Code installed\n   - Install via `code --install-extension`\n   - Also install for code-insiders if present\n\n4. **Update doctor checks**\n   - Check cai-docker wrapper exists and is executable\n   - Check containai-docker context exists\n   - Check VS Code extension installed (if VS Code present)\n\n### New Library\n\n`src/lib/devcontainer.sh`:\n- `_cai_install_docker_wrapper()` - install cai-docker\n- `_cai_setup_devcontainer_context()` - create/verify context\n- `_cai_install_vscode_extension()` - install extension\n- `_cai_doctor_devcontainer()` - check devcontainer components\n\n### User Flow\n\n```\n$ cai setup\n\n[existing steps...]\n\nSetting up devcontainer support...\n  \u2713 cai-docker wrapper installed\n  \u2713 containai-docker context created\n  \u2713 VS Code extension installed\n\nDone! You can now use ContainAI with devcontainers.\n```\n\n## Acceptance\n\n- [ ] cai-docker wrapper installed to ~/.local/bin\n- [ ] containai-docker context created with sysbox runtime\n- [ ] VS Code extension installed (if VS Code present)\n- [ ] Doctor checks for devcontainer components\n- [ ] Clear error messages if setup fails\n- [ ] Idempotent (can run multiple times safely)\n\n## Done summary\nTBD\n\n## Evidence\n- Commits:\n- Tests:\n- PRs:\n"
    },
    {
      "data": {
        "assignee": null,
        "claim_note": "",
        "claimed_at": null,
        "created_at": "2026-02-02T23:23:55.688671Z",
        "depends_on": [
          "fn-49-devcontainer-integration.2",
          "fn-49-devcontainer-integration.4"
        ],
        "epic": "fn-49-devcontainer-integration",
        "id": "fn-49-devcontainer-integration.5",
        "priority": null,
        "spec_path": ".flow/tasks/fn-49-devcontainer-integration.5.md",
        "status": "todo",
        "title": "Test sysbox verification matrix",
        "updated_at": "2026-02-02T23:24:06.606526Z"
      },
      "id": "fn-49-devcontainer-integration.5",
      "runtime": null,
      "spec": "# fn-49-devcontainer-integration.5 Test sysbox verification matrix\n\n## Description\n\nComprehensive testing of the sysbox verification logic to ensure it correctly distinguishes sysbox from other container runtimes.\n\n### Test Matrix\n\n| Runtime | UID Map | unshare | Sysboxfs | Cap Probe | Total | Expected |\n|---------|---------|---------|----------|-----------|-------|----------|\n| sysbox | \u2713 | \u2713 | \u2713 | \u2713 | 4 | PASS |\n| docker (default) | \u2717 | \u2717 | \u2717 | \u2717 | 0 | FAIL |\n| docker --privileged | \u2717 | \u2713 | \u2717 | \u2713 | 2 | FAIL |\n| docker --cap-add=ALL | \u2717 | \u2717 | \u2717 | \u2717 | 0 | FAIL |\n| podman (rootless) | varies | varies | \u2717 | varies | 0-2 | FAIL |\n\n### Integration Test: `tests/integration/test-devcontainer-sysbox.sh`\n\n```bash\n# Test 1: Sysbox passes verification\n# Test 2: Regular docker fails\n# Test 3: Privileged fails (only 2 checks pass)\n# Test 4: Full devcontainer flow\n```\n\n### Unit Tests\n\n- Test UID map parsing\n- Test sysboxfs mount detection\n- Test capability probe\n\n### CI Integration\n\nAdd to `.github/workflows/ci.yml`:\n```yaml\ntest-devcontainer:\n  runs-on: ubuntu-latest\n  needs: [build-sysbox]\n  steps:\n    - name: Test sysbox verification\n      run: ./tests/integration/test-devcontainer-sysbox.sh\n```\n\n## Acceptance\n\n- [ ] Sysbox containers pass verification (4/4 checks)\n- [ ] Regular docker containers fail (0/4 checks)\n- [ ] Privileged containers fail (2/4 checks, need 3)\n- [ ] Clear error message when verification fails\n- [ ] Tests run in CI pipeline\n\n## Done summary\nTBD\n\n## Evidence\n- Commits:\n- Tests:\n- PRs:\n"
    },
    {
      "data": {
        "assignee": null,
        "claim_note": "",
        "claimed_at": null,
        "created_at": "2026-02-02T23:23:56.734105Z",
        "depends_on": [
          "fn-49-devcontainer-integration.5"
        ],
        "epic": "fn-49-devcontainer-integration",
        "id": "fn-49-devcontainer-integration.6",
        "priority": null,
        "spec_path": ".flow/tasks/fn-49-devcontainer-integration.6.md",
        "status": "todo",
        "title": "Publish feature and extension",
        "updated_at": "2026-02-02T23:24:07.550751Z"
      },
      "id": "fn-49-devcontainer-integration.6",
      "runtime": null,
      "spec": "# fn-49-devcontainer-integration.6 Publish feature and extension\n\n## Description\n\nPublish the ContainAI devcontainer feature to ghcr.io and the VS Code extension to marketplaces.\n\n### Feature Publication\n\n**Registry**: `ghcr.io/novotnyllc/containai/feature`\n\n1. Build OCI artifact with devcontainer CLI\n2. Semantic versioning (1.0.0, 1.0.1, etc.)\n3. Tags: `latest`, `1`, `1.0`, `1.0.0`\n\nCI Pipeline: `.github/workflows/publish-feature.yml`\n- Trigger on `feature-v*` tags\n- Use `devcontainers/action@v1`\n\n### Extension Publication\n\n**VS Code Marketplace**:\n- Create publisher account (novotnyllc)\n- Build and publish with `vsce publish`\n\n**Open VSX**:\n- Create account on open-vsx.org\n- Publish with `ovsx publish`\n\nCI Pipeline: `.github/workflows/publish-extension.yml`\n- Trigger on `extension-v*` tags\n- Publish to both marketplaces\n\n### Secrets Required\n\n- `GHCR_TOKEN` - GitHub Container Registry token\n- `VSCE_PAT` - VS Code Marketplace personal access token\n- `OVSX_PAT` - Open VSX personal access token\n\n## Acceptance\n\n- [ ] Feature published to ghcr.io/novotnyllc/containai/feature\n- [ ] Feature tagged with semantic versions\n- [ ] Extension published to VS Code Marketplace\n- [ ] Extension published to Open VSX\n- [ ] CI workflows for automated publishing\n- [ ] Release notes for each version\n\n## Done summary\nTBD\n\n## Evidence\n- Commits:\n- Tests:\n- PRs:\n"
    },
    {
      "data": {
        "assignee": null,
        "claim_note": "",
        "claimed_at": null,
        "created_at": "2026-02-02T23:23:57.382301Z",
        "depends_on": [
          "fn-49-devcontainer-integration.2",
          "fn-49-devcontainer-integration.6"
        ],
        "epic": "fn-49-devcontainer-integration",
        "id": "fn-49-devcontainer-integration.7",
        "priority": null,
        "spec_path": ".flow/tasks/fn-49-devcontainer-integration.7.md",
        "status": "todo",
        "title": "Documentation and templates",
        "updated_at": "2026-02-02T23:24:10.385801Z"
      },
      "id": "fn-49-devcontainer-integration.7",
      "runtime": null,
      "spec": "# fn-49-devcontainer-integration.7 Documentation and templates\n\n## Description\n\nCreate documentation for using ContainAI with devcontainers and provide example templates.\n\n### Documentation: `docs/devcontainer.md`\n\n- Prerequisites (cai setup, cai import)\n- Quick start (add feature to devcontainer.json)\n- Features overview (sysbox, config sync, DinD, SSH)\n- Configuration options\n- Troubleshooting section\n\n### Example Templates\n\n**Python** (`templates/devcontainer/python/.devcontainer/devcontainer.json`):\n```json\n{\n    \"name\": \"Python with ContainAI\",\n    \"image\": \"mcr.microsoft.com/devcontainers/python:3.11\",\n    \"features\": {\n        \"ghcr.io/novotnyllc/containai/feature:latest\": {}\n    }\n}\n```\n\n**Node.js** (`templates/devcontainer/node/.devcontainer/devcontainer.json`):\n```json\n{\n    \"name\": \"Node.js with ContainAI\",\n    \"image\": \"mcr.microsoft.com/devcontainers/javascript-node:18\",\n    \"features\": {\n        \"ghcr.io/novotnyllc/containai/feature:latest\": {}\n    }\n}\n```\n\n### Files to Create\n\n- `docs/devcontainer.md` - main documentation\n- `templates/devcontainer/python/.devcontainer/devcontainer.json`\n- `templates/devcontainer/node/.devcontainer/devcontainer.json`\n- Update `README.md` with devcontainer section\n\n## Acceptance\n\n- [ ] docs/devcontainer.md with complete guide\n- [ ] At least 2 example templates (Python, Node.js)\n- [ ] Troubleshooting section\n- [ ] Reference to cai doctor for diagnostics\n- [ ] Link from main README.md\n\n## Done summary\nTBD\n\n## Evidence\n- Commits:\n- Tests:\n- PRs:\n"
    },
    {
      "data": {
        "assignee": null,
        "claim_note": "",
        "claimed_at": null,
        "created_at": "2026-02-03T01:13:43.917350Z",
        "depends_on": [
          "fn-49-devcontainer-integration.4"
        ],
        "epic": "fn-49-devcontainer-integration",
        "id": "fn-49-devcontainer-integration.8",
        "priority": null,
        "spec_path": ".flow/tasks/fn-49-devcontainer-integration.8.md",
        "status": "todo",
        "title": "Docker context sync watcher",
        "updated_at": "2026-02-03T01:13:43.917365Z"
      },
      "id": "fn-49-devcontainer-integration.8",
      "runtime": null,
      "spec": "# fn-49-devcontainer-integration.8 Docker context sync watcher\n\n## Description\n\nCreate a bidirectional sync mechanism between `~/.docker/contexts` and `~/.docker-cai/contexts` that keeps them in sync, with special handling for the `containai-docker` context which has different socket paths.\n\n### Problem\n\nThe devcontainer needs Docker contexts from the host, but:\n- Host's `containai-docker` context uses SSH socket (`ssh://user@host`)\n- Container's `containai-docker` context needs Unix socket (`unix:///var/run/docker.sock`)\n- Other contexts should be synced bidirectionally without modification\n\n### Implementation\n\n**Location**: `src/lib/docker-context-sync.sh`\n\n### Core Functions\n\n1. **`_cai_sync_docker_contexts_once()`**\n   - One-time sync from source to target\n   - Parameters: `$1` = source dir, `$2` = target dir, `$3` = direction (host-to-cai|cai-to-host)\n   - Syncs all contexts except `containai-docker`\n   - Creates target dirs if missing\n\n2. **`_cai_create_containai_docker_context()`**\n   - Creates the `containai-docker` context in `~/.docker-cai/contexts/`\n   - Uses Unix socket path (`unix:///var/run/docker.sock`)\n   - Called during setup, not during sync\n\n3. **`_cai_watch_docker_contexts()`**\n   - Starts continuous file watcher\n   - Uses `inotifywait` on Linux, `fswatch` on macOS\n   - Watches both directories for changes\n   - Triggers sync on create/delete/modify\n\n4. **`_cai_is_containai_docker_context()`**\n   - Check if a context path is the special `containai-docker` context\n   - Returns 0 if yes, 1 if no\n\n### Directory Structure\n\n```\n~/.docker/\n\u251c\u2500\u2500 config.json\n\u2514\u2500\u2500 contexts/\n    \u251c\u2500\u2500 meta/\n    \u2502   \u251c\u2500\u2500 <hash1>/meta.json   # context1\n    \u2502   \u251c\u2500\u2500 <hash2>/meta.json   # context2\n    \u2502   \u2514\u2500\u2500 <hashN>/meta.json   # containai-docker (SSH socket)\n    \u2514\u2500\u2500 tls/\n        \u2514\u2500\u2500 <hash>/...          # TLS certs if any\n\n~/.docker-cai/\n\u251c\u2500\u2500 config.json                  # Points to contexts/ here\n\u2514\u2500\u2500 contexts/\n    \u251c\u2500\u2500 meta/\n    \u2502   \u251c\u2500\u2500 <hash1>/meta.json   # context1 (copied from host)\n    \u2502   \u251c\u2500\u2500 <hash2>/meta.json   # context2 (copied from host)\n    \u2502   \u2514\u2500\u2500 <hashN>/meta.json   # containai-docker (Unix socket - DIFFERENT)\n    \u2514\u2500\u2500 tls/\n        \u2514\u2500\u2500 <hash>/...          # TLS certs if any\n```\n\n### Sync Logic\n\n```bash\n# Host \u2192 ContainAI direction\nfor context in ~/.docker/contexts/meta/*/; do\n    context_name=$(get_context_name \"$context\")\n    if [[ \"$context_name\" != \"containai-docker\" ]]; then\n        rsync -a \"$context\" ~/.docker-cai/contexts/meta/\n    fi\ndone\n\n# ContainAI \u2192 Host direction\nfor context in ~/.docker-cai/contexts/meta/*/; do\n    context_name=$(get_context_name \"$context\")\n    if [[ \"$context_name\" != \"containai-docker\" ]]; then\n        # Only sync if not already in host (new context created in container)\n        rsync -a --ignore-existing \"$context\" ~/.docker/contexts/meta/\n    fi\ndone\n```\n\n### Watcher Implementation\n\n```bash\n_cai_watch_docker_contexts() {\n    local host_dir=\"$HOME/.docker/contexts\"\n    local cai_dir=\"$HOME/.docker-cai/contexts\"\n\n    if command -v inotifywait &>/dev/null; then\n        # Linux: use inotifywait\n        inotifywait -m -r -e create,delete,modify \"$host_dir\" \"$cai_dir\" |\n        while read -r dir event file; do\n            _cai_handle_context_change \"$dir\" \"$event\" \"$file\"\n        done\n    elif command -v fswatch &>/dev/null; then\n        # macOS: use fswatch\n        fswatch -r \"$host_dir\" \"$cai_dir\" |\n        while read -r path; do\n            _cai_handle_context_change_path \"$path\"\n        done\n    else\n        _cai_warn \"No file watcher available (need inotifywait or fswatch)\"\n        return 1\n    fi\n}\n```\n\n### Integration Points\n\n1. **`cai setup`**: Creates initial `~/.docker-cai/` structure and `containai-docker` context\n2. **`cai start`**: Starts the context sync watcher in background\n3. **`cai stop`**: Stops the watcher\n4. **Devcontainer feature**: Uses `~/.docker-cai/` via `DOCKER_CONFIG`\n\n## Acceptance\n\n- [ ] `~/.docker-cai/contexts/` mirrors `~/.docker/contexts/` (except containai-docker)\n- [ ] New contexts in either dir sync to the other\n- [ ] `containai-docker` context is NOT synced (different socket paths)\n- [ ] Watcher uses inotifywait (Linux) or fswatch (macOS)\n- [ ] Deletions sync correctly (removes from other side)\n- [ ] TLS certs sync along with context metadata\n- [ ] Graceful handling when watcher tools not installed\n- [ ] Unit tests for sync logic\n- [ ] Integration test verifying sync behavior\n\n## Done summary\nTBD\n\n## Evidence\n- Commits:\n- Tests:\n- PRs:\n"
    },
    {
      "data": {
        "assignee": null,
        "claim_note": "",
        "claimed_at": null,
        "created_at": "2026-02-03T01:13:47.713832Z",
        "depends_on": [
          "fn-49-devcontainer-integration.4"
        ],
        "epic": "fn-49-devcontainer-integration",
        "id": "fn-49-devcontainer-integration.9",
        "priority": null,
        "spec_path": ".flow/tasks/fn-49-devcontainer-integration.9.md",
        "status": "todo",
        "title": "VS Code server-env-setup scripts",
        "updated_at": "2026-02-03T01:13:47.713846Z"
      },
      "id": "fn-49-devcontainer-integration.9",
      "runtime": null,
      "spec": "# fn-49-devcontainer-integration.9 VS Code server-env-setup scripts\n\n## Description\n\nCreate VS Code Server environment setup scripts that export `DOCKER_CONFIG` to use the ContainAI Docker configuration.\n\n### Problem\n\nWhen VS Code Remote (Server) connects to a devcontainer or remote machine, it needs to use the ContainAI Docker configuration instead of the default `~/.docker/`. VS Code Server sources `server-env-setup` scripts before launching, making this the ideal hook point.\n\n### Scripts to Create\n\n**`~/.vscode-server/server-env-setup`**:\n```bash\n#!/bin/bash\n# ContainAI: Use isolated Docker config with correct context socket paths\nexport DOCKER_CONFIG=\"$HOME/.docker-cai\"\n```\n\n**`~/.vscode-insiders/server-env-setup`**:\n```bash\n#!/bin/bash\n# ContainAI: Use isolated Docker config with correct context socket paths\nexport DOCKER_CONFIG=\"$HOME/.docker-cai\"\n```\n\n### Implementation\n\n**Location**: Add to `src/lib/devcontainer.sh`\n\n### Core Functions\n\n1. **`_cai_install_vscode_server_env_setup()`**\n   - Creates both scripts\n   - Sets executable permission (`chmod +x`)\n   - Creates parent directories if needed\n   - Idempotent (safe to run multiple times)\n\n2. **`_cai_remove_vscode_server_env_setup()`**\n   - Removes the scripts (for uninstall)\n   - Only removes if it's our script (check for ContainAI marker comment)\n\n3. **`_cai_doctor_vscode_server_env()`**\n   - Checks if scripts exist and are executable\n   - Verifies they contain the correct DOCKER_CONFIG export\n   - Reports status in `cai doctor` output\n\n### Script Requirements\n\n- Must be `chmod +x` (executable)\n- Must be owned by the user\n- Uses `#!/bin/bash` shebang (VS Code Server expects this)\n- Single export statement for simplicity\n- Contains marker comment for identification\n\n### Integration Points\n\n1. **`cai setup`**: Calls `_cai_install_vscode_server_env_setup()`\n2. **Devcontainer feature `init.sh`**: Creates scripts inside container\n3. **`cai doctor`**: Verifies scripts exist and are correct\n\n### Directory Creation\n\nBoth directories may not exist on fresh systems:\n```bash\nmkdir -p ~/.vscode-server\nmkdir -p ~/.vscode-insiders\n```\n\n### Edge Cases\n\n1. **Script already exists with different content**:\n   - Check if our marker comment is present\n   - If yes: overwrite (update)\n   - If no: append our export (preserve user's customizations)\n\n2. **VS Code Server not installed**:\n   - Still create scripts (they'll be ready when VS Code connects)\n   - No error, just informational message\n\n3. **Permissions issues**:\n   - Scripts must be in user's home directory\n   - Should work even if run as different user in container\n\n### Doctor Output\n\n```\nDevcontainer support:\n  \u2713 cai-docker wrapper installed\n  \u2713 containai-docker context exists\n  \u2713 Docker context sync configured\n  \u2713 VS Code server-env-setup scripts installed\n    - ~/.vscode-server/server-env-setup (executable)\n    - ~/.vscode-insiders/server-env-setup (executable)\n```\n\n## Acceptance\n\n- [ ] `~/.vscode-server/server-env-setup` created with correct content\n- [ ] `~/.vscode-insiders/server-env-setup` created with correct content\n- [ ] Both scripts are executable (`chmod +x`)\n- [ ] Scripts export `DOCKER_CONFIG=\"$HOME/.docker-cai\"`\n- [ ] Parent directories created if missing\n- [ ] Idempotent (running twice is safe)\n- [ ] `cai doctor` verifies scripts\n- [ ] Works in devcontainer feature `init.sh`\n- [ ] Handles existing scripts gracefully (append vs overwrite)\n\n## Done summary\nTBD\n\n## Evidence\n- Commits:\n- Tests:\n- PRs:\n"
    }
  ]
}
