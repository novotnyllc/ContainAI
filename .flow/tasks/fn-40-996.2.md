# fn-40-996.2 Integration Testing

## Description
Test the ACP proxy with multi-session support and MCP server passthrough.

## Acceptance
- [ ] Test: Proxy responds to `initialize` correctly
- [ ] Test: Single session works (session/new → session/prompt → response)
- [ ] Test: Multiple simultaneous sessions to different workspaces
- [ ] Test: Session routing by sessionId
- [ ] Test: MCP path translation (host path → container path)
- [ ] Test: Stdio MCP server works in container (if installed)
- [ ] Test: Session cleanup on session/end
- [ ] Tests run in CI

## Implementation Notes

### Test Structure
```
tests/integration/
├── test-acp-proxy.sh           # Main test runner
├── test-acp-sessions.sh        # Multi-session tests
└── helpers/
    ├── mock-acp-client.sh      # Simulates editor
    └── acp-utils.sh            # JSON-RPC helpers
```

### Initialize Test
```bash
test_initialize() {
    local response
    response=$(printf '{"jsonrpc":"2.0","id":"1","method":"initialize","params":{"protocolVersion":"2025-01-01"}}\n' | \
        timeout 10 cai --acp mock-agent 2>/dev/null | head -1)

    assert_contains "$response" '"protocolVersion"'
    assert_contains "$response" '"capabilities"'
}
```

### Single Session Test
```bash
test_single_session() {
    local workspace=$(mktemp -d)

    # Start proxy with coprocess
    coproc PROXY { cai --acp mock-agent; }

    # Initialize
    echo '{"jsonrpc":"2.0","id":"1","method":"initialize","params":{"protocolVersion":"2025-01-01"}}' >&${PROXY[1]}
    read -t 5 response <&${PROXY[0]}
    assert_contains "$response" '"protocolVersion"'

    # Create session
    echo "{\"jsonrpc\":\"2.0\",\"id\":\"2\",\"method\":\"session/new\",\"params\":{\"cwd\":\"$workspace\",\"mcpServers\":[]}}" >&${PROXY[1]}
    read -t 10 response <&${PROXY[0]}
    assert_contains "$response" '"sessionId"'

    local session_id=$(echo "$response" | jq -r '.result.sessionId')

    # Send prompt
    echo "{\"jsonrpc\":\"2.0\",\"id\":\"3\",\"method\":\"session/prompt\",\"params\":{\"sessionId\":\"$session_id\",\"message\":\"test\"}}" >&${PROXY[1]}

    # Should get response/updates
    read -t 10 response <&${PROXY[0]}
    # Verify we got something back

    # Cleanup
    kill $PROXY_PID 2>/dev/null
    docker rm -f $(docker ps -q --filter "label=containai.workspace=$workspace") 2>/dev/null
    rm -rf "$workspace"
}
```

### Multiple Sessions Test
```bash
test_multiple_sessions() {
    local ws1=$(mktemp -d)
    local ws2=$(mktemp -d)

    coproc PROXY { cai --acp mock-agent; }

    # Initialize
    echo '{"jsonrpc":"2.0","id":"1","method":"initialize",...}' >&${PROXY[1]}
    read -t 5 response <&${PROXY[0]}

    # Create session 1
    echo "{...\"cwd\":\"$ws1\"...}" >&${PROXY[1]}
    read -t 10 response <&${PROXY[0]}
    local s1=$(echo "$response" | jq -r '.result.sessionId')

    # Create session 2
    echo "{...\"cwd\":\"$ws2\"...}" >&${PROXY[1]}
    read -t 10 response <&${PROXY[0]}
    local s2=$(echo "$response" | jq -r '.result.sessionId')

    # Verify different containers
    local c1=$(docker ps -q --filter "label=containai.workspace=$ws1")
    local c2=$(docker ps -q --filter "label=containai.workspace=$ws2")
    assert_not_equal "$c1" "$c2"

    # Cleanup
    kill $PROXY_PID 2>/dev/null
    docker rm -f $c1 $c2 2>/dev/null
    rm -rf "$ws1" "$ws2"
}
```

### MCP Path Translation Test
```bash
test_mcp_path_translation() {
    local workspace="/home/testuser/project"

    # Mock the session/new with MCP servers containing host paths
    local mcp_config='[{"type":"stdio","name":"fs","command":"npx","args":["@mcp/fs","'$workspace'"]}]'

    # Verify path gets translated to container path
    # (This requires inspecting what gets sent to the agent)

    # The MCP args should become /home/agent/workspace instead of /home/testuser/project
}
```

### CI Integration
```yaml
# .github/workflows/test.yml
- name: Build ACP Proxy
  run: |
    cd src/acp-proxy
    dotnet publish -r linux-x64 -c Release -p:PublishAot=true

- name: ACP Integration Tests
  run: |
    ./tests/integration/test-acp-proxy.sh
    ./tests/integration/test-acp-sessions.sh
```

## Dependencies
- fn-40-996.1 (ACP Proxy)

## Done summary
TBD

## Evidence
- Commits:
- Tests:
- PRs:
