# fn-15-281.3 Add update check and bundle update functions to update.sh

## Description
Add rate-limited update check and bundle update functions to `src/lib/update.sh`. Includes container stop warning and service restart.

**Size:** M
**Files:** `src/lib/update.sh`

## Approach

### _cai_update_check()
1. **Platform guard:** Return early if:
   - Running on macOS (`[[ "$OSTYPE" == darwin* ]]`)
   - Bundle not installed (`! _cai_dockerd_bundle_installed`)
2. **Config discovery:** Use `_containai_find_config "$PWD"` with XDG fallback (`~/.config/containai/config.toml`)
   - Read `update.check_interval` via `parse-toml.py` wrapper
   - Default to "daily" on missing config or parse error
3. Honor `CAI_UPDATE_CHECK_INTERVAL` env override
4. **Rate-limit via mtime:** Check mtime of `~/.cache/containai/update-check`
   - Convert interval to seconds: hourly=3600, daily=86400, weekly=604800
   - Compare file mtime (epoch) to current time (epoch via `date +%s`)
   - If interval not elapsed → return immediately (no network)
5. If elapsed → check dockerd bundle version only:
   - Parse Docker index HTML for latest version
   - Compare to installed version from `/opt/containai/VERSION`
   - 5s connect timeout, non-blocking
6. If network fails → write "network_error" to state file, touch it (don't re-check immediately)
7. If dockerd update available → print yellow warning:
   - Include "Updating will stop running containers"
   - Include current and available version
8. Touch state file and write "ok" on success

**Scope:** Check dockerd bundle only. ContainAI updates are handled by existing git-based mechanism in version.sh.

**State file:** `~/.cache/containai/update-check`
- Create parent dirs with `mkdir -p`
- File content: "ok" or "network_error" or "parse_error"
- Mtime used for rate limiting

### _cai_update_dockerd_bundle()
1. Check latest version from Docker index
2. Compare to installed version from VERSION file
3. If newer:
   - Prompt: "Updating dockerd will stop running containers. Continue? [y/N]" (skip with --force)
   - Download to temp dir with `wget`
   - Extract, move `temp/docker/*` to `/opt/containai/docker/<new-version>/`
   - Update symlinks in `/opt/containai/bin/` using `ln -sfn`
   - Write new VERSION
   - `sudo systemctl restart containai-docker.service`
   - Cleanup: remove versions older than previous (keep current + previous only)

### Integration point
Call `_cai_update_dockerd_bundle` from `_cai_update_linux_wsl2()` after context/unit updates, before final success message. Order:
1. Existing context updates
2. Existing unit updates
3. **NEW: `_cai_update_dockerd_bundle "$force_flag"`**
4. Final success message

### Update expected unit content
Update `_cai_update_expected_unit_content()` to generate the same unit content as setup.sh:
- `ExecStart=/opt/containai/bin/dockerd --config-file=/etc/containai/docker/daemon.json`
- `Environment=PATH=/opt/containai/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin`

Or better: extract unit content generation to shared function and call from both places.

## Key context

- Use epoch seconds via `date +%s` for timestamp comparison (portable)
- Use file mtime for rate limiting (more reliable than parsing timestamps)
- State file in ~/.cache/containai/ avoids polluting config
- Warning format per spec: yellow, emphasize container restart for dockerd
- `ln -sfn` for atomic symlink update
- Docker tarballs extract to docker/ subdir, must move contents
- Platform guard prevents unnecessary network calls on macOS

## Acceptance
- [ ] `_cai_update_check` function added
- [ ] Skips on macOS (platform guard)
- [ ] Skips when bundle not installed
- [ ] Config discovery uses `_containai_find_config` with XDG fallback
- [ ] Defaults to "daily" on missing/parse error
- [ ] Reads check_interval from config.toml via parse-toml.py
- [ ] Honors CAI_UPDATE_CHECK_INTERVAL env var
- [ ] Rate-limits via file mtime at ~/.cache/containai/update-check
- [ ] Checks dockerd version via Docker index only (not ContainAI)
- [ ] Network failure doesn't block (touches state file)
- [ ] Yellow warning displayed when dockerd updates available
- [ ] **Dockerd warning includes "will stop running containers"**
- [ ] `_cai_update_dockerd_bundle` function added
- [ ] Called from `_cai_update_linux_wsl2()` after context/unit updates
- [ ] Prompts before updating (unless --force)
- [ ] Downloads to temp, extracts, moves docker/* contents
- [ ] Updates symlinks atomically with ln -sfn
- [ ] Restarts containai-docker.service after update
- [ ] Keeps only current + previous version
- [ ] Expected unit content matches setup.sh generated content
- [ ] shellcheck passes

## Done summary
Added rate-limited update check (_cai_update_check) and bundle upgrade (_cai_update_dockerd_bundle) functions to update.sh. The update check reads config, rate-limits via file mtime, queries Docker index for latest version, and prints yellow warning when updates available. The bundle update downloads, extracts, updates symlinks atomically, restarts service, and cleans up old versions. Integrated into _cai_update_linux_wsl2 flow after context/unit updates.
## Evidence
- Commits: d2a5fc232efb2ee92793f55dcb5d4071aebefa76
- Tests: shellcheck -x src/lib/update.sh
- PRs:
