# fn-15-281.3 Add update check and bundle update functions to update.sh

## Description
Add rate-limited update check and bundle update functions to `src/lib/update.sh`. Includes container stop warning and service restart.

**Size:** M
**Files:** `src/lib/update.sh`

## Approach

### _cai_update_check()
1. Read config with `_containai_parse_config()` from `config.sh:225-561`
2. Check `update.check_interval` (hourly/daily/weekly/never) - default daily
3. Honor `CAI_UPDATE_CHECK_INTERVAL` env override
4. Compare `update.last_checked` (RFC3339) against current time
5. If interval not elapsed → return immediately (no network)
6. If elapsed → check versions:
   - ContainAI: GitHub releases API with 5s timeout
   - Dockerd bundle: parse Docker index HTML
7. If network fails → set `update.last_result=network_error`, advance `last_checked`, return (don't block)
8. If updates available → print yellow warning using `_cai_warn` style
9. **For dockerd updates:** include "Updating will stop running containers"
10. Update `last_checked` and `last_result` in config

### _cai_update_dockerd_bundle()
1. Check latest version from Docker index
2. Compare to installed version from VERSION file
3. If newer:
   - Prompt: "Updating dockerd will stop running containers. Continue? [y/N]" (skip with --force)
   - Download to temp dir
   - Extract to `/opt/containai/docker/<new-version>/`
   - Update symlinks in `/opt/containai/bin/` using `ln -sfn`
   - Write new VERSION
   - `sudo systemctl restart containai-docker.service`
   - Cleanup: remove versions older than previous (keep current + previous only)

## Key context

- Use epoch seconds for timestamp comparison (portable)
- Use `date -Iseconds` for RFC3339 output (GNU date)
- Warning format per spec: yellow, emphasize security for dockerd
- `ln -sfn` for atomic symlink update
## Approach

### _cai_update_check()
1. Read config with `_containai_parse_config()` from `config.sh:225-561`
2. Check `update.check_interval` (hourly/daily/weekly/never) - default daily
3. Honor `CAI_UPDATE_CHECK_INTERVAL` env override
4. Compare `update.last_checked` (RFC3339) against current time
5. If interval not elapsed → return immediately (no network)
6. If elapsed → check versions:
   - ContainAI: GitHub releases API with 5s timeout
   - Dockerd bundle: parse Docker index HTML
7. If network fails → set `update.last_result=network_error`, advance `last_checked`, return (don't block)
8. If updates available → print yellow warning using `_cai_warn` style
9. Update `last_checked` and `last_result` in config

### _cai_update_dockerd_bundle()
1. Check latest version from Docker index
2. Compare to installed version from VERSION file
3. If newer → download, extract, replace bundle
4. Requires `--force` if containai-docker service is running

## Key context

- Use epoch seconds for timestamp comparison (portable)
- Use `date -Iseconds` for RFC3339 output (GNU date)
- Warning format per spec: yellow, emphasize security for dockerd
## Acceptance
- [ ] `_cai_update_check` function added
- [ ] Reads check_interval from config.toml
- [ ] Honors CAI_UPDATE_CHECK_INTERVAL env var
- [ ] Rate-limits by comparing last_checked timestamp
- [ ] Checks ContainAI version via GitHub API
- [ ] Checks dockerd version via Docker index
- [ ] Network failure doesn't block (advances timestamp)
- [ ] Yellow warning displayed when updates available
- [ ] **Dockerd warning includes "will stop running containers"**
- [ ] `_cai_update_dockerd_bundle` function added
- [ ] Prompts before updating (unless --force)
- [ ] Downloads to versioned directory
- [ ] Updates symlinks atomically with ln -sfn
- [ ] Restarts containai-docker.service after update
- [ ] Keeps only current + previous version
- [ ] shellcheck passes
## Done summary
TBD

## Evidence
- Commits:
- Tests:
- PRs:
