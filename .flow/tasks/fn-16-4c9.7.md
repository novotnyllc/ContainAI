# fn-16-4c9.7 Lima VM: only recreate when template changes

## Description

Currently `cai update` on macOS always deletes and recreates the Lima VM, which is destructive and slow. Implement hash-based change detection so the VM is only recreated when the Lima template actually changes.

**What to implement:**

1. **Portable hash computation** in `src/lib/setup.sh`:
   Reuse the portable pattern from `src/lib/container.sh:283`:
   ```bash
   _cai_lima_template_hash() {
       local template hash
       template=$(_cai_lima_template)

       # Portable SHA-256 (same pattern as _cai_hash_path)
       if command -v sha256sum >/dev/null 2>&1; then
           hash=$(printf '%s' "$template" | sha256sum | cut -c1-12)
       elif command -v shasum >/dev/null 2>&1; then
           hash=$(printf '%s' "$template" | shasum -a 256 | cut -c1-12)
       elif command -v openssl >/dev/null 2>&1; then
           hash=$(printf '%s' "$template" | openssl dgst -sha256 | awk '{print substr($NF,1,12)}')
       else
           _cai_error "No SHA-256 tool available"
           return 1
       fi

       printf '%s' "$hash"
   }
   ```

2. **Hash storage location**: `~/.config/containai/lima-template.hash`

3. **Save hash ONLY after VM creation/recreation** in `_cai_lima_create_vm()`:
   The hash must be saved only when the VM is actually created, not when setup completes without creating:
   ```bash
   # In _cai_lima_create_vm, after successful limactl create:
   mkdir -p ~/.config/containai
   _cai_lima_template_hash > ~/.config/containai/lima-template.hash
   ```

4. **Compare hash in update** in `src/lib/update.sh`:
   **Important:** Use `_cai_prompt_confirm()` helper, NOT raw `read -r`:
   ```bash
   _cai_update_macos() {
       local current_hash stored_hash hash_file
       hash_file="$HOME/.config/containai/lima-template.hash"
       current_hash=$(_cai_lima_template_hash)
       stored_hash=$(cat "$hash_file" 2>/dev/null || echo "")

       if [[ "$current_hash" == "$stored_hash" ]]; then
           # Same template - just update packages in VM
           _cai_info "Lima template unchanged, updating packages..."
           _cai_update_macos_packages
       else
           # Template changed - need to recreate
           _cai_warn "Lima template changed (was: ${stored_hash:-none}, now: $current_hash)"
           if ! _cai_prompt_confirm "Recreate Lima VM?" false; then
               _cai_info "Update cancelled"
               return 0
           fi
           # Delete and recreate VM...
       fi
   }
   ```

5. **Force recreate flag**: `--lima-recreate` bypasses hash check

6. **Update help text** in `src/lib/update.sh:78`:
   Change from "currently always recreates" to reflect new hash-based behavior.

**Decision table:**
| Current hash | Stored hash | Action |
|--------------|-------------|--------|
| abc123 | abc123 | apt update/upgrade only |
| abc123 | def456 | Prompt via _cai_prompt_confirm (auto if CAI_YES=1) |
| abc123 | (none) | Prompt via _cai_prompt_confirm (auto if CAI_YES=1) |
| (any) | (any) | Recreate (if --lima-recreate) |

**Files to modify:**
- `src/lib/setup.sh`: Add hash function, save hash in `_cai_lima_create_vm()`
- `src/lib/update.sh`: Add hash comparison, use `_cai_prompt_confirm()`, update help text
- `src/containai.sh`: Add --lima-recreate flag to update command

## Acceptance
- [ ] `_cai_lima_template_hash` uses portable SHA-256 (sha256sum/shasum/openssl)
- [ ] Hash saved ONLY in `_cai_lima_create_vm()` after actual creation
- [ ] Hash NOT saved if VM already exists and setup skips creation
- [ ] Hash saved to ~/.config/containai/lima-template.hash
- [ ] `cai update` compares current vs stored hash
- [ ] Same hash → runs apt update/upgrade in VM (no recreate)
- [ ] Different hash → uses `_cai_prompt_confirm()` for confirmation
- [ ] Missing hash file treated as "template changed"
- [ ] `--lima-recreate` flag forces VM recreation
- [ ] `CAI_YES=1` auto-confirms recreation via shared helper
- [ ] Hash is updated after successful recreation
- [ ] Help text at src/lib/update.sh:78 updated to reflect hash-based behavior

## Done summary
TBD

## Evidence
- Commits:
- Tests:
- PRs:
