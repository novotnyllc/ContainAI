# fn-18-g96.4 Add --template parameter with template building

## Description

Add `--template` parameter to `cai shell` and `cai run` that builds a custom image from a user-provided Dockerfile template.

**Parameter:** `--template <name>`

**Build process:**
1. Validate template exists via `_cai_get_template_path`
2. Validate Dockerfile FROM line uses ContainAI base (strict validation)
3. Get selected Docker context via `_cai_select_context`
4. Build image using the SAME context: `docker --context "$context" build ...`
5. Tag as `containai-template-{name}:latest`
6. Cache: rebuild only if Dockerfile mtime changed or `--rebuild-template` flag
7. Start container using the template image

**Valid base images (strict regex validation):**
- `containai:<tag>` - any tag (local image)
- `ghcr.io/novotnyllc/containai/agents:<tag>` - any tag (remote image)

Validation regex:
```bash
^FROM[[:space:]]+(containai:[a-zA-Z0-9._-]+|ghcr\.io/novotnyllc/containai/agents:[a-zA-Z0-9._-]+)
```

**CRITICAL: Build in correct Docker context**
Templates MUST be built using the context selected by `_cai_select_context`. This ensures the image exists where containers will run (e.g., Sysbox context).

**New function: _cai_build_template()**
```bash
_cai_build_template() {
    local template_name="$1"
    local context="${2:-}"
    local force_rebuild="${3:-false}"
    local dockerfile_path image_tag mtime_current mtime_cached

    dockerfile_path=$(_cai_get_template_path "$template_name") || return 1
    image_tag="containai-template-${template_name}:latest"

    # Validate FROM line with strict regex
    local from_line
    from_line=$(grep -m1 '^FROM ' "$dockerfile_path")
    local valid_pattern='^FROM[[:space:]]+(containai:[a-zA-Z0-9._-]+|ghcr\.io/novotnyllc/containai/agents:[a-zA-Z0-9._-]+)'
    if ! [[ "$from_line" =~ $valid_pattern ]]; then
        _cai_error "Template must use ContainAI base image"
        _cai_error "Found: $from_line"
        _cai_error "Expected: FROM containai:<tag> or FROM ghcr.io/novotnyllc/containai/agents:<tag>"
        return 1
    fi

    # Build docker command with context
    local -a docker_cmd=(docker)
    [[ -n "$context" ]] && docker_cmd=(docker --context "$context")

    # Check cache (mtime-based)
    mtime_current=$(stat -c %Y "$dockerfile_path" 2>/dev/null || stat -f %m "$dockerfile_path")
    mtime_cached=$(_cai_get_template_mtime_cache "$template_name")

    if [[ "$force_rebuild" != "true" ]] && [[ "$mtime_current" == "$mtime_cached" ]]; then
        if "${docker_cmd[@]}" image inspect "$image_tag" >/dev/null 2>&1; then
            _cai_debug "Template $template_name is cached"
            printf '%s\n' "$image_tag"
            return 0
        fi
    fi

    # Build using selected context
    _cai_info "Building template: $template_name"
    local context_dir
    context_dir=$(dirname "$dockerfile_path")
    if ! "${docker_cmd[@]}" build -t "$image_tag" -f "$dockerfile_path" "$context_dir"; then
        _cai_error "Template build failed: $template_name"
        return 1
    fi

    _cai_set_template_mtime_cache "$template_name" "$mtime_current"
    printf '%s\n' "$image_tag"
}
```

**Mtime cache location:** `$_CAI_CONFIG_DIR/.template-cache`

**Agent selection:** Templates use a fixed base image from their FROM line. The FROM line is NOT rewritten based on `--agent` selection. Users wanting different agents should create separate template directories.

## Acceptance

- [ ] `--template NAME` parameter on shell and run commands
- [ ] Template Dockerfile FROM line validated with strict regex
- [ ] Only `containai:<tag>` or `ghcr.io/novotnyllc/containai/agents:<tag>` allowed
- [ ] Invalid base image rejected with clear error (test with `FROM ubuntu:latest`)
- [ ] Template built using Docker context from `_cai_select_context`
- [ ] Template tagged as containai-template-{name}:latest
- [ ] Mtime-based cache avoids unnecessary rebuilds
- [ ] `--rebuild-template` forces rebuild
- [ ] Build errors propagated with context
- [ ] Template interaction with `--image-tag`: `--template` takes precedence

## Done summary
Superseded by fn-33-lp4 or fn-36-rb7
## Evidence
- Commits:
- Tests:
- PRs:
