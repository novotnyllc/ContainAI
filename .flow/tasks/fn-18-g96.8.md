# fn-18-g96.8 Change container naming to repo-branch format

## Description

Replace the current hash-based container naming (`containai-<12-char-hash>`) with a human-readable `repo-branch` format. Implement a shared lookup helper that all commands must use.

**Current naming:**
```
containai-a1b2c3d4e5f6  # Hash of workspace path
```

**New naming:**
```
containai-myrepo-main       # First container for myrepo on main branch
containai-myrepo-main-2     # Second container if duplicate
containai-myrepo-feature-x  # Different branch
```

## Implementation

### 1. Modify `_containai_container_name()` in `src/lib/container.sh`:
```bash
_containai_container_name() {
    local workspace_path="$1"
    local repo_name branch_name base_name

    # Get repo name: git remote or directory name
    if git -C "$workspace_path" rev-parse --git-dir >/dev/null 2>&1; then
        repo_name=$(git -C "$workspace_path" remote get-url origin 2>/dev/null | sed 's|.*/||;s|\.git$||')
    fi
    repo_name="${repo_name:-$(basename "$workspace_path")}"

    # Get branch name
    branch_name=$(git -C "$workspace_path" branch --show-current 2>/dev/null)
    if [[ -z "$branch_name" ]]; then
        branch_name=$(git -C "$workspace_path" rev-parse --abbrev-ref HEAD 2>/dev/null)
    fi
    branch_name="${branch_name:-default}"

    # Sanitize for Docker: lowercase, replace invalid chars with dash
    repo_name="${repo_name,,}"
    repo_name="${repo_name//[^a-z0-9_.-]/-}"
    branch_name="${branch_name,,}"
    branch_name="${branch_name//[^a-z0-9_.-]/-}"

    # Build base name with truncation (64 char max, leave room for suffix)
    base_name="containai-${repo_name}-${branch_name}"
    base_name="${base_name:0:60}"  # Leave room for -NNN suffix

    printf '%s\n' "$base_name"
}
```

### 2. Add legacy naming function (MUST wrap existing _cai_hash_path):
```bash
# Legacy container name - MUST match existing containers
# Uses the SAME logic as current implementation to ensure compatibility
_containai_legacy_container_name() {
    local workspace_path="$1"
    local hash

    # Use existing _cai_hash_path which handles:
    # - Path normalization (trailing slashes, realpath)
    # - sha256sum/shasum/openssl fallback
    # DO NOT reimplement the hash algorithm
    hash=$(_cai_hash_path "$workspace_path" | cut -c1-12)
    printf 'containai-%s\n' "$hash"
}
```

**CRITICAL:** The legacy function MUST wrap `_cai_hash_path`, not reimplement hashing. This ensures existing containers are found.

### 3. Add shared lookup helper with duplicate detection:
```bash
_cai_find_workspace_container() {
    local workspace_path="$1"
    local context="${2:-}"
    local -a docker_cmd=(docker)
    [[ -n "$context" ]] && docker_cmd=(docker --context "$context")

    # 1. Label match (most reliable) - with duplicate detection
    local -a by_label
    mapfile -t by_label < <("${docker_cmd[@]}" ps -a \
        --filter "label=containai.workspace=$workspace_path" \
        --format '{{.Names}}')

    # Error on multiple matches - user must be explicit
    if [[ ${#by_label[@]} -gt 1 ]]; then
        _cai_error "Multiple containers found for workspace: $workspace_path"
        _cai_error "Containers: ${by_label[*]}"
        _cai_error "Use --container to specify which one"
        return 1
    fi

    if [[ ${#by_label[@]} -eq 1 ]]; then
        printf '%s\n' "${by_label[0]}"
        return 0
    fi

    # 2. New naming format
    local new_name
    new_name=$(_containai_container_name "$workspace_path")
    if "${docker_cmd[@]}" inspect "$new_name" >/dev/null 2>&1; then
        printf '%s\n' "$new_name"
        return 0
    fi

    # 3. Legacy hash format (using existing _cai_hash_path)
    local legacy_name
    legacy_name=$(_containai_legacy_container_name "$workspace_path")
    if "${docker_cmd[@]}" inspect "$legacy_name" >/dev/null 2>&1; then
        printf '%s\n' "$legacy_name"
        return 0
    fi

    return 1  # Not found
}
```

### 4. Add duplicate-aware name resolution:
```bash
_cai_resolve_container_name() {
    local workspace_path="$1"
    local context="${2:-}"
    local -a docker_cmd=(docker)
    [[ -n "$context" ]] && docker_cmd=(docker --context "$context")

    local base_name candidate suffix=1
    base_name=$(_containai_container_name "$workspace_path")
    candidate="$base_name"

    while "${docker_cmd[@]}" inspect "$candidate" >/dev/null 2>&1; do
        # Check if this container is for our workspace
        local existing_workspace
        existing_workspace=$("${docker_cmd[@]}" inspect --format '{{index .Config.Labels "containai.workspace"}}' "$candidate" 2>/dev/null)
        if [[ "$existing_workspace" == "$workspace_path" ]]; then
            # Same workspace - reuse this container
            printf '%s\n' "$candidate"
            return 0
        fi
        # Different workspace - try next suffix
        ((suffix++))
        candidate="${base_name}-${suffix}"
    done

    printf '%s\n' "$candidate"
}
```

### 5. Update all call sites to use shared helper:

**Commands that need updating to use `_cai_find_workspace_container()`:**
- `_containai_shell_cmd` - container discovery
- `_containai_run_cmd` - check existing before create
- `_containai_import_cmd` - find target container
- `_containai_export_cmd` - find source container
- `_containai_stop_cmd` - find container to stop

**Commands that need `_cai_resolve_container_name()` for creation:**
- `_containai_start_container` - get name for new container

## Acceptance

- [ ] Container names follow `containai-{repo}-{branch}` format
- [ ] Branch name extracted from git if available
- [ ] Repo name extracted from git remote URL or directory name
- [ ] Invalid characters replaced with `-`
- [ ] Names lowercased
- [ ] Duplicate handling with numeric suffix (-2, -3, etc.)
- [ ] Name truncated to fit 64 char limit
- [ ] `_cai_find_workspace_container()` helper implemented
- [ ] `_containai_legacy_container_name()` wraps existing `_cai_hash_path`
- [ ] Legacy naming does NOT reimplement hash algorithm
- [ ] Lookup order: label → new name → legacy hash
- [ ] Multiple containers for same workspace: error with helpful message
- [ ] All commands (shell, run, import, export, stop) use shared lookup helper
- [ ] Existing hash-named containers still discovered
- [ ] No automatic migration (document manual process)

## Done summary
Superseded by fn-33-lp4 or fn-36-rb7
## Evidence
- Commits:
- Tests:
- PRs:
