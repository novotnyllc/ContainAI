# fn-16-4c9.3 install.sh auto-calls cai setup with opt-out

## Description

After installing the ContainAI CLI, automatically run `cai setup` to configure the environment. This streamlines first-time setup while respecting user control.

**Important:** Flag parsing is performed ONCE at the top of `install.sh` (per fn-16-4c9.2). This task references those variables, not re-parses.

**What to implement:**

### 1. Add shared prompt helper to src/lib/core.sh

Create a helper that honors CAI_YES=1 and reads from /dev/tty when needed:
```bash
# Prompt user for confirmation with CAI_YES support
# Usage: _cai_prompt_confirm "message" [default_yes]
# Returns: 0 if confirmed, 1 if denied
# Honors CAI_YES=1 for non-interactive mode
_cai_prompt_confirm() {
    local message="$1"
    local default_yes="${2:-false}"
    local prompt_suffix confirm

    # Auto-confirm if CAI_YES=1
    if [[ "${CAI_YES:-}" == "1" ]]; then
        return 0
    fi

    if [[ "$default_yes" == "true" ]]; then
        prompt_suffix="[Y/n]"
    else
        prompt_suffix="[y/N]"
    fi

    # Try /dev/tty for piped stdin
    if [[ ! -t 0 ]] && [[ -e /dev/tty ]]; then
        printf '%s %s ' "$message" "$prompt_suffix"
        read -r confirm < /dev/tty
    elif [[ -t 0 ]]; then
        printf '%s %s ' "$message" "$prompt_suffix"
        read -r confirm
    else
        # No TTY available, can't prompt
        return 1
    fi

    if [[ "$default_yes" == "true" ]]; then
        [[ ! "$confirm" =~ ^[Nn]$ ]]
    else
        [[ "$confirm" =~ ^[Yy]$ ]]
    fi
}
```

### 2. Update all existing prompts in setup/update/doctor

Replace existing `read -r` prompts with `_cai_prompt_confirm`:
- `src/lib/setup.sh:202` (mirrored-mode prompt)
- `src/lib/update.sh:644` (dockerd bundle prompt)
- `src/lib/update.sh:903` (VM recreate prompt)
- Any other prompts found

### 3. Install.sh post-install logic

**Important:** Set `CAI_YES_VALUE=1` when EITHER:
- `--yes` flag was passed, OR
- User confirmed interactively

The post-install logic uses the following variables parsed in fn-16-4c9.2:
- YES_FLAG - set to "1" if --yes passed
- NO_SETUP - set to "true" if --no-setup passed

After creating cai wrapper, determine CAI_YES_VALUE:
- If --yes flag: CAI_YES_VALUE="1"
- If interactive and user confirms: CAI_YES_VALUE="1"
- If user declines or piped without --yes: show instructions, no auto-run

When running cai setup/update, pass CAI_YES="$CAI_YES_VALUE" so internal prompts auto-confirm.

**Files to modify:**
- `src/lib/core.sh`: Add `_cai_prompt_confirm()` helper
- `src/lib/setup.sh`: Replace prompts with helper
- `src/lib/update.sh`: Replace prompts with helper
- `install.sh`: Add post-install logic (uses flags from fn-16-4c9.2)

## Acceptance
- [ ] `_cai_prompt_confirm()` helper added to src/lib/core.sh
- [ ] Helper honors CAI_YES=1 (returns 0 immediately)
- [ ] Helper reads from /dev/tty when stdin is pipe
- [ ] All prompts in setup/update/doctor use the helper
- [ ] `install.sh` sets CAI_YES_VALUE=1 when --yes passed
- [ ] `install.sh` sets CAI_YES_VALUE=1 when user confirms interactively
- [ ] CAI_YES="$CAI_YES_VALUE" passed to cai setup/update
- [ ] Default is Y for interactive first-time install
- [ ] `--no-setup` skips setup completely
- [ ] Piped install without --yes shows instructions only
- [ ] Does NOT re-parse flags (uses variables from fn-16-4c9.2)

## Done summary

## Summary when finished
TBD

## Evidence
- Commits:
- Tests:
- PRs:
