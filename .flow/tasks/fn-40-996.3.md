# fn-40-996.3 Documentation

## Description
Document the ACP proxy including CLI integration, multi-session support, MCP server handling, and limitations.

## Acceptance
- [ ] docs/acp.md with comprehensive usage guide
- [ ] Editor setup guides (Zed, VS Code)
- [ ] MCP server explanation (what works, what doesn't, limitations)
- [ ] Troubleshooting section
- [ ] CLI help text for `--acp`

## Implementation Notes

### User Documentation

Create `docs/acp.md`:

```markdown
# ACP Integration

ContainAI supports the [Agent Client Protocol](https://agentclientprotocol.com) (ACP) for editor integration.

## Quick Start

Configure your editor to use `cai --acp <agent>`:

**Zed** (`~/.config/zed/settings.json`):
```json
{
  "agent_servers": {
    "claude-sandbox": {
      "type": "custom",
      "command": "cai",
      "args": ["--acp", "claude"]
    }
  }
}
```

**VS Code** (with ACP extension):
```json
{
  "acp.executable": "cai",
  "acp.args": ["--acp", "claude"]
}
```

## How It Works

```mermaid
flowchart LR
    Editor -->|ACP stdio| Proxy[cai --acp]
    Proxy -->|cai exec| Container
    Container --> Agent[claude --acp]
    Agent -->|MCP| MCPServers[MCP Servers]
```

1. Editor spawns `cai --acp claude`
2. Editor sends `initialize`, then `session/new` with workspace and MCP config
3. Proxy resolves workspace root (git root or `.containai/config.toml` parent)
4. Proxy spawns `cai exec` which handles container creation/SSH
5. Agent handles MCP servers (spawns stdio, connects to HTTP/SSE)
6. All communication proxied through

## Multiple Sessions

One proxy process can handle multiple editor sessions:
- Each `session/new` can target a different workspace
- Different workspaces use different containers
- Subdirectories map to their workspace root
- Messages routed by `sessionId`

## MCP Servers

MCP servers provide tools and context to the agent. The agent (not the proxy) manages MCP connections.

### What Works

| MCP Type | Works? | Notes |
|----------|--------|-------|
| HTTP/SSE (remote) | ✅ Yes | Agent connects directly from container |
| Stdio (in container) | ✅ Yes | Package must be installed in container |
| HTTP/SSE (localhost) | ⚠️ Limited | See "Host-Local Services" below |
| Stdio (host-only) | ❌ No | Can't spawn host processes from container |

### Installing MCP Packages in Container

For stdio MCP servers to work, install their packages in the container image:

```dockerfile
# In Dockerfile.agents
RUN npm install -g @modelcontextprotocol/server-filesystem \
                   @mcp/fetch \
                   @mcp/postgres
```

Or install at runtime:
```bash
cai shell
npm install -g @mcp/whatever
```

### Host-Local Services

To access MCP servers running on your host machine:

1. Create container with host networking flag:
   ```bash
   docker run --add-host=host.docker.internal:host-gateway ...
   ```

2. Configure MCP URL as `http://host.docker.internal:PORT/...`

Note: This requires manual container configuration. Future versions may support this automatically.

## Path Handling

Your local paths work transparently:
```
/home/user/project -> /home/agent/workspace (symlink in container)
```

MCP server args containing workspace paths are translated automatically. The translation is path-aware:
- `/home/user/project` → `/home/agent/workspace`
- `/home/user/project/src` → `/home/agent/workspace/src`
- `/other/path` → `/other/path` (unchanged)

## Supported Agents

| Agent | Command | Status |
|-------|---------|--------|
| Claude Code | `cai --acp claude` | ✅ Supported |
| Gemini CLI | `cai --acp gemini` | ✅ Supported |

## Troubleshooting

### Agent not starting
```bash
cai shell
which claude  # Verify agent installed
claude --help | grep -i acp  # Verify ACP support
```

### MCP server not found
```bash
cai shell
which npx  # Verify npm available
npx @mcp/fetch --version  # Verify MCP package works
```

### Can't reach host services
```bash
# From container, verify host.docker.internal works
cai shell
curl http://host.docker.internal:8080/
# If this fails, container needs --add-host flag
```

### Multiple sessions not routing
Check that each `session/new` returned a unique `sessionId`.

### Protocol errors
The proxy uses NDJSON (newline-delimited JSON) framing. If you see parsing errors, ensure:
- Each message is a single line
- Messages end with newline
- No embedded newlines in JSON
```

### CLI Help Text

Add to `--help` output:

```
  --acp <agent>    Start ACP proxy for editor integration
                   Agents: claude, gemini
                   Example: cai --acp claude
```

## Dependencies
- fn-40-996.2 (Integration Testing)

## Done summary
TBD

## Evidence
- Commits:
- Tests:
- PRs:
