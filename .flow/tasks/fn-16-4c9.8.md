# fn-16-4c9.8 Lima VM: apt update/upgrade on cai update

## Description

When `cai update` runs on macOS and the Lima template hash matches (no template changes), run apt update/upgrade inside the VM to keep OS and Docker packages current.

**What gets updated:**
- Ubuntu OS packages (from official repos)
- Docker packages (from get.docker.com repo added during VM setup)
- NOT Sysbox (installed from pinned .deb, requires template change)

**Implementation:**
This is largely implemented as part of fn-16-4c9.7. This task ensures the apt update/upgrade logic is robust.

**Important:** Use `$_CAI_LIMA_VM_NAME` constant (defaults to `containai-docker`), NOT hardcoded names.

1. In `src/lib/update.sh`, add `_cai_update_macos_packages()`:
   ```bash
   _cai_update_macos_packages() {
       local vm_name="$_CAI_LIMA_VM_NAME"

       _cai_info "Updating packages in Lima VM ($vm_name)..."

       # Ensure VM is running
       local status
       status=$(_cai_lima_vm_status "$vm_name")
       if [[ "$status" != "Running" ]]; then
           _cai_info "Starting VM..."
           if ! limactl start "$vm_name"; then
               _cai_error "Failed to start VM"
               return 1
           fi
       fi

       if ! limactl shell "$vm_name" -- sudo apt update; then
           _cai_error "apt update failed"
           return 1
       fi

       if ! limactl shell "$vm_name" -- sudo DEBIAN_FRONTEND=noninteractive apt upgrade -y; then
           _cai_error "apt upgrade failed"
           return 1
       fi

       _cai_ok "Packages updated"
   }
   ```

2. Handle edge cases:
   - VM not running → start it first
   - apt lock held → retry with backoff (or clear error message)
   - Network issues → appropriate error message

**Files to modify:**
- `src/lib/update.sh`: Add `_cai_update_macos_packages()`, use `$_CAI_LIMA_VM_NAME`

## Acceptance
- [ ] Uses `$_CAI_LIMA_VM_NAME` constant (NOT hardcoded "containai")
- [ ] `cai update` on macOS (with matching hash) runs apt update
- [ ] `cai update` on macOS (with matching hash) runs apt upgrade -y
- [ ] DEBIAN_FRONTEND=noninteractive prevents interactive prompts
- [ ] VM is started if not running before package update
- [ ] Error handling for apt failures
- [ ] Clear success/failure messaging

## Done summary
Task fn-16-4c9.8 was already implemented as part of fn-16-4c9.7. The `_cai_update_macos_packages()` function in `src/lib/update.sh` includes all required functionality: uses `$_CAI_LIMA_VM_NAME` constant, runs `apt-get update` and `apt-get upgrade -y` with `DEBIAN_FRONTEND=noninteractive` and dpkg force options, starts VM if not running, and has proper error handling and messaging.
## Evidence
- Commits: 46e54c8803eb242e0c78bc5b5829934e126bed9c
- Tests: shellcheck -x src/lib/update.sh
- PRs:
