# fn-16-4c9.9 Add cai doctor --reset-lima (macOS only)

## Description

Add a `--reset-lima` flag to `cai doctor` that provides a clean way to delete and recreate the Lima VM. This is a recovery/troubleshooting option when the VM gets into a bad state.

**Important:** Use the existing constants, not hardcoded names:
- VM name: `$_CAI_LIMA_VM_NAME` (defaults to `containai-docker`)
- Docker context: `$_CAI_CONTAINAI_DOCKER_CONTEXT` (defaults to `containai-docker`)
- Socket path: `$_CAI_LIMA_SOCKET_PATH`

**What it does:**
1. Confirms user intent (destructive operation) via `_cai_prompt_confirm()`
2. Stops the Lima VM if running
3. Deletes the Lima VM (`limactl delete $_CAI_LIMA_VM_NAME`)
4. Removes the Docker context (`docker context rm $_CAI_CONTAINAI_DOCKER_CONTEXT`)
5. Removes the stored template hash
6. Shows instructions to run `cai setup` to recreate

**What it does NOT do:**
- Does not affect Linux Docker contexts
- Does not remove installed packages (Homebrew, bash, etc.)
- Does not touch user workspace data

**Implementation:**

1. In `src/lib/doctor.sh`, add `--reset-lima` handling:
   **Important:** Use `_cai_prompt_confirm()` helper, NOT raw `read -r`:
   ```bash
   _cai_doctor_reset_lima() {
       if [[ "$(_cai_detect_platform)" != "macos" ]]; then
           _cai_error "--reset-lima is only available on macOS"
           return 1
       fi

       _cai_warn "This will delete the ContainAI Lima VM ($_CAI_LIMA_VM_NAME) and Docker context."
       _cai_warn "Workspace data on the host is preserved."

       if ! _cai_prompt_confirm "Continue?" false; then
           _cai_info "Reset cancelled"
           return 0
       fi

       # Stop VM if running
       if limactl list "$_CAI_LIMA_VM_NAME" 2>/dev/null | grep -q Running; then
           _cai_info "Stopping VM..."
           limactl stop "$_CAI_LIMA_VM_NAME"
       fi

       # Delete VM
       if _cai_lima_vm_exists "$_CAI_LIMA_VM_NAME"; then
           _cai_info "Deleting VM..."
           limactl delete "$_CAI_LIMA_VM_NAME" --force
       fi

       # Remove Docker context
       if docker context inspect "$_CAI_CONTAINAI_DOCKER_CONTEXT" >/dev/null 2>&1; then
           _cai_info "Removing Docker context..."
           docker context rm "$_CAI_CONTAINAI_DOCKER_CONTEXT" 2>/dev/null || true
       fi

       # Remove template hash
       rm -f ~/.config/containai/lima-template.hash

       _cai_ok "Lima VM reset complete"
       _cai_info "Run 'cai setup' to recreate the VM"
   }
   ```

2. In `src/containai.sh`, add flag to doctor command:
   - Only parse `--reset-lima` on macOS
   - On non-macOS, don't show in help, return error if used

**Help text visibility:**
- On macOS: `--reset-lima   Delete Lima VM and Docker context (requires confirmation)`
- On non-macOS: Flag not shown in help; if used, returns "only available on macOS"

**Files to modify:**
- `src/lib/doctor.sh`: Add `_cai_doctor_reset_lima()` using `_cai_prompt_confirm()`
- `src/containai.sh`: Add --reset-lima flag handling to doctor command

## Acceptance
- [ ] `cai doctor --reset-lima` works on macOS
- [ ] Uses `$_CAI_LIMA_VM_NAME` constant (not hardcoded)
- [ ] Uses `$_CAI_CONTAINAI_DOCKER_CONTEXT` constant (not hardcoded)
- [ ] Uses `_cai_prompt_confirm()` for confirmation (not raw read -r)
- [ ] CAI_YES=1 auto-confirms via shared helper
- [ ] Stops running VM before deletion
- [ ] Deletes Lima VM
- [ ] Removes Docker context
- [ ] Removes stored template hash
- [ ] Shows success message and next steps
- [ ] On non-macOS: --reset-lima not in help output
- [ ] On non-macOS: --reset-lima returns clear error message
- [ ] User workspace data is NOT affected

## Done summary
TBD

## Evidence
- Commits:
- Tests:
- PRs:
