# fn-8-k84.2 Make integration tests hermetic using temp HOME fixture

## Description
Update `agent-sandbox/test-sync-integration.sh` to use a temp HOME fixture with fake config directories, making tests deterministic and portable across platforms (Linux, WSL, macOS).

**Size:** M
**Files:** agent-sandbox/test-sync-integration.sh

## Approach

1. **Early guard** at script start:
   - If `docker` binary missing → skip with `exit 0` and message
   - If `docker info` fails (daemon down) → warn and **fail** (don't hide regressions)

2. **Create temp HOME fixture under real home** (e.g., `$REAL_HOME/.containai-test-home-XXXX`):
   - Must be under real home for Docker Desktop file-sharing on macOS
   - Save original `HOME` to `REAL_HOME` variable

3. **Preserve Docker config** when switching HOME:
   - Export `DOCKER_CONFIG="$REAL_HOME/.docker"` before changing `HOME`
   - This prevents Docker CLI from losing its context/endpoint configuration

4. **Override `HOME` only for `cai import` invocations**:
   - `HOME="$FIXTURE_HOME" bash -c "source ... && cai import"`
   - This ensures `_IMPORT_HOST_PATH_PREFIX` uses the fixture while Docker still works

5. **Create minimal subset of source files** needed for existing `test_full_sync` assertions:
   - `~/.claude.json` (root-level) → `/data/claude/`
   - `~/.claude/.credentials.json` (dot-prefixed filename)
   - `~/.claude/settings.json`
   - `~/.claude/plugins/` (directory) → `/data/claude/plugins/`
   - `~/.config/gh/hosts.yml` → `/data/config/gh/`
   - `~/.bash_aliases` → `/data/shell/`
   - `~/.codex/auth.json` → `/data/codex/`
   - `~/.gemini/oauth_creds.json` → `/data/gemini/`
   - `~/.copilot/config.json` → `/data/copilot/`
   - `~/.config/tmux/tmux.conf` → `/data/config/tmux/`
   - `~/.local/share/tmux/plugins/` (directory) → `/data/local/share/tmux/`
   - Note: vscode-server, opencode, etc. are omitted; import handles missing sources gracefully

6. **Run `cai import --data-volume <testvol>`** against the fixture

7. **Assert volume contents** match expected structure (from existing `test_full_sync`):
   - `/data/claude/` (claude.json, credentials.json, settings.json)
   - `/data/claude/plugins/`
   - `/data/config/gh/`
   - `/data/codex/`
   - `/data/gemini/`
   - `/data/copilot/`
   - `/data/shell/`
   - `/data/config/tmux/`
   - `/data/local/share/tmux/`

8. **Clean up**: Remove fixture directory and test volume at end

## Key context

- `agent-sandbox/test-sync-integration.sh` is the existing test file
- Tests currently rely on real host `$HOME` state which makes them non-hermetic
- `_IMPORT_SYNC_MAP` in `lib/import.sh:88-146` defines what gets synced
- `test_full_sync` has `dirs_to_check` array defining expected volume directories
- Docker Desktop on macOS only shares paths under `/Users` by default
- Docker CLI uses `$HOME/.docker` for context/endpoint config

## Acceptance
- [ ] Early guard: `docker` binary check → skip; `docker info` fail → warn+fail
- [ ] Temp HOME fixture created under `$REAL_HOME` (not `/tmp`)
- [ ] `DOCKER_CONFIG` preserved pointing to real home's `.docker`
- [ ] `HOME` override only for `cai import` invocations (not globally)
- [ ] Fixture includes all sources needed for `test_full_sync` assertions
- [ ] Tests are deterministic and pass on fresh machines
- [ ] No regressions on Linux/WSL (tests still pass)
- [ ] Tests work on macOS when Docker Desktop available
- [ ] Clean up removes fixture and test volumes

## Done summary
TBD

## Evidence
- Commits:
- Tests:
- PRs:
