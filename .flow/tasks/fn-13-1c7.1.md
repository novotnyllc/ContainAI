# fn-13-1c7.1 Security audit devcontainer.json schema

## Description
Create a comprehensive security classification of every property in the devcontainer.json schema, categorizing each as SAFE, FILTERED, BLOCKED, or WARN based on its risk to ContainAI's sandbox model.

**Size:** M
**Files:** Output to `.flow/research/fn-13-1c7/security-classification.md`

## Approach

1. Pin to actual JSON Schema source from https://github.com/devcontainers/spec/tree/main/schemas (record exact version/commit)
2. Use the human reference page (json_reference) only for semantics/examples
3. For each property, analyze:
   - Does it run code on the host? (BLOCKED)
   - Does it grant elevated privileges? (BLOCKED or FILTERED)
   - Does it mount sensitive paths? (FILTERED)
   - Is it purely informational? (SAFE)
4. Document justification for each classification
5. Add **Execution scope** column per property:
   - **Host-machine**: Runs on user's actual host (most dangerous)
   - **Sandbox-host**: Runs inside Sysbox container's "host" (already sandboxed)
   - **Devcontainer**: Runs inside the nested devcontainer (most isolated)
6. Add **Default action in cai** column per property

## Security Categories (use these definitions)

| Category | Definition | Enforcement | Default Action |
|----------|------------|-------------|----------------|
| **SAFE** | No security implications | None | Pass through unchanged |
| **FILTERED** | Needs sanitization | Transform before use | Apply filter, use safe subset |
| **BLOCKED** | Inherently dangerous | Hard error | Reject with error message |
| **WARN** | May be risky but allowed | Log warning | Allow but log, suggest review |

## Key Properties to Focus On

- `initializeCommand` (runs on HOST - highest risk, but different if "host" is Sysbox)
- `runArgs` (can include --privileged, volume mounts)
- `mounts` (can escape sandbox)
- `capAdd`, `securityOpt` (privilege escalation)
- Feature properties (`privileged`, `capAdd` in features)
- `build`/`dockerFile` (where does build run?)

## Key context

Threat model: Classification is primarily about *host boundary / privilege escalation / unexpected host-side execution*. Network exfil is expected risk per SECURITY.md; WARN only for surprising automatic code execution.

## Acceptance
- [x] Exact JSON Schema version/commit recorded
- [x] All devcontainer.json root properties classified
- [x] All lifecycle command properties analyzed with host vs container execution noted
- [x] Feature-related properties analyzed
- [x] **Execution scope** column included (host-machine vs sandbox-host vs devcontainer)
- [x] **Default action in cai** column included
- [x] Each classification has security justification
- [x] Document includes recommendation for handling each category

## Done summary

Created comprehensive security classification of all devcontainer.json schema properties. The document:

1. **Pinned to devcontainers/spec commit** `1b2baddb5f1071ca0e8bcb7eb56dbc9d3e4a674f` (2024-01-22)

2. **Classified all 62 properties** into four categories:
   - **BLOCKED** (2): `initializeCommand`, `privileged` - inherently dangerous
   - **FILTERED** (12): Properties needing sanitization (`capAdd`, `securityOpt`, `runArgs`, `mounts`, `features`, etc.)
   - **WARN** (10): Risky but allowed with logging (lifecycle commands, `image`, `build.args`, etc.)
   - **SAFE** (38): No security implications (metadata, paths, booleans, enums)

3. **Documented execution scope** for each property:
   - Host-machine (highest risk - `initializeCommand`)
   - Sandbox-host (Sysbox isolation - runtime options)
   - Devcontainer (double isolation - lifecycle commands)
   - Build-time (varies by where build runs)
   - N/A (purely declarative)

4. **Provided implementation recommendations** for three phases:
   - Strict Mode (MVP): Block/filter dangerous properties, maximize security
   - Balanced Mode: Allow more with filtering and logging
   - Permissive Mode: For trusted environments

5. **Key security findings**:
   - `initializeCommand` must be BLOCKED (runs on TRUE host)
   - `privileged` must be BLOCKED (defeats container isolation)
   - `capAdd`, `securityOpt`, `runArgs` need allowlist/blocklist filtering
   - Features represent supply chain risk - recommend allowlisting official features

## Evidence
- Artifacts: `.flow/research/fn-13-1c7/security-classification.md`
- Tests: N/A (research task)
- PRs: N/A
