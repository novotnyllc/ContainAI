{
  "created_at": "2026-01-16T02:21:53.402593Z",
  "epic": {
    "data": {
      "branch_name": "fn-2-kcs",
      "created_at": "2026-01-16T00:59:27.882793Z",
      "depends_on_epics": [],
      "id": "fn-2-kcs",
      "next_task": 4,
      "plan_review_status": "ship",
      "plan_reviewed_at": "2026-01-16T02:08:08.382943Z",
      "spec_path": ".flow/specs/fn-2-kcs.md",
      "status": "open",
      "title": "Agent Sandbox Refactor: Image Size & Aliases Cleanup",
      "updated_at": "2026-01-16T05:00:00.000000Z"
    },
    "spec": "# Agent Sandbox Refactor: Image Size & Aliases Cleanup\n\n## Problem\n\nThe agent-sandbox project has several issues requiring cleanup:\n\n1. **Naming inconsistency**: Variables use `_CSD_` prefix, functions use `_csd_`, comments reference old \"csd\" naming\n2. **Missing container labels**: `docker sandbox run` doesn't pass `--label` flag for container identification\n3. **Docker image could be smaller**: No layer optimization, caches left in image\n4. **Build script limitations**: No CLI options for DOTNET_CHANNEL or base image, no OCI labels\n5. **Stale documentation**: README.md, sync-all.sh, and other files have \"csd\" / \"dotnet-sandbox\" references\n\n## Approach\n\nSplit into **3 PRs** (merging Dockerfile changes to avoid conflicts):\n\n### PR 1: aliases.sh Cleanup (fn-2-kcs.1)\n\n**Renaming:**\n- Rename `_CSD_*` variables to `_ASB_*` (5 variables, lines 16-26)\n- Rename `_csd_*` functions to `_asb_*` (9 functions)\n- Remove dead code: `_CSD_MOUNT_ONLY_VOLUMES` array (lines 25-26)\n- Update comments referencing \"csd\" to \"asb\" (4 locations)\n- Fix branding: \"Dotnet sandbox\" \u2192 \"Agent Sandbox\" (line 608)\n\n**Label flag with capability detection:**\n- Check if `docker sandbox run --help 2>&1 | grep -q '\\-\\-label'`\n- Only add `--label \"$_ASB_LABEL\"` when supported\n- Gracefully proceed without it otherwise (keeping existing ambiguous ownership messaging)\n\n**Variable hygiene:**\n- Use `local` for all temporary variables in functions (e.g., `local args=()`, `local status`, etc.)\n\n**Isolation Detection (renamed from ECI check):**\n\nThe function `_asb_check_isolation` will query `docker info` and return:\n\nDetection logic (conservative - prefer return 2 over false positive/negative):\n```bash\nlocal runtime rootless\nlocal info_output\n\n# Query docker info with tab-separated fields for reliable parsing\ninfo_output=$(docker info --format '{{.DefaultRuntime}}\\t{{.Rootless}}' 2>/dev/null)\nif [[ $? -ne 0 ]] || [[ -z \"$info_output\" ]]; then\n  return 2  # Unable to query\nfi\n\n# Parse tab-separated values\nIFS=$'\\t' read -r runtime rootless <<< \"$info_output\"\n\n# Return 0 only for unambiguous isolation\nif [[ \"$runtime\" == \"sysbox-runc\" ]]; then return 0; fi\nif [[ \"$rootless\" == \"true\" ]]; then return 0; fi\n\n# Return 1 only for unambiguous non-isolation\nif [[ \"$runtime\" == \"runc\" ]] && [[ \"$rootless\" == \"false\" ]]; then return 1; fi\n\n# Everything else is ambiguous\nreturn 2\n```\n\nNote: `userns` in SecurityOptions is not reliably indicative; omitted from detection.\n\nOutput (ASCII-only):\n- `[OK] Isolation: sysbox-runc`\n- `[OK] Isolation: rootless mode`\n- `[WARN] No isolation detected (default runtime)`\n- `[WARN] Unable to determine isolation status`\n\n**`ASB_REQUIRE_ISOLATION=1` behavior:**\n- On return 0: proceed normally\n- On return 1: fail with \"ERROR: Container isolation required but not detected. Use --force to bypass (not recommended).\"\n- On return 2: fail with \"ERROR: Cannot verify isolation status. Use --force to bypass (not recommended).\"\n\n**`--force` interaction with `ASB_REQUIRE_ISOLATION`:**\nWhen both are set, print ASCII warning:\n```\n*** WARNING: Bypassing isolation requirement with --force\n*** Running without verified isolation may expose host system\n```\nThen proceed.\n\nPrecedence: `--force` overrides `ASB_REQUIRE_ISOLATION`. Existing `--force` behavior (skip sandbox checks) remains unchanged; this adds isolation bypass.\n\n### PR 2: Dockerfile & Build Pipeline (fn-2-kcs.2)\n\n**Prerequisites:**\n1. Fix line continuation issues (trailing spaces after backslashes on lines 30, 127, 133)\n2. Verify Dockerfile builds successfully before optimization\n\n**Baseline Capture:**\nBuild script captures single tag size with explicit handling for missing image:\n```bash\n# Capture baseline (latest tag only)\nBASELINE_SIZE=$(docker images agent-sandbox:latest --format '{{.Size}}' 2>/dev/null | head -1)\nif [[ -z \"$BASELINE_SIZE\" ]]; then\n  echo \"=== Baseline: (no existing image - size reduction target N/A for first build) ===\"\n  HAVE_BASELINE=0\nelse\n  echo \"=== Baseline: $BASELINE_SIZE ===\"\n  HAVE_BASELINE=1\nfi\n\n# ... build ...\n\n# Capture result (should always exist after build)\nRESULT_SIZE=$(docker images agent-sandbox:latest --format '{{.Size}}' | head -1)\nif [[ -z \"$RESULT_SIZE\" ]]; then\n  echo \"ERROR: Build did not produce agent-sandbox:latest\"\n  exit 1\nfi\necho \"=== Result: $RESULT_SIZE ===\"\n\nif [[ \"$HAVE_BASELINE\" == \"1\" ]]; then\n  echo \"=== Manual verification: compare baseline vs result for >=10% reduction ===\"\nelse\n  echo \"=== First build complete. Run again to measure size reduction. ===\"\nfi\n```\nNote: Size is human-readable (e.g., \"2.5GB\"); manual comparison required. First build has no reduction target.\n\n**Image Size Reduction:**\n- **Target**: Reduce image size by >=10% from baseline (verify manually; skip for first build)\n- Remove on-image caches/artifacts in same RUN layer:\n  - `rm -rf /var/lib/apt/lists/*` after apt-get (already present line 58)\n  - `rm -rf ~/.npm ~/.cache ~/.nvm/.cache` after npm/nvm operations\n  - `rm -rf /tmp/* /var/tmp/*` after tool installs\n  - Clear dotnet NuGet cache: `dotnet nuget locals all --clear`\n- Combine related RUN commands to minimize layer count where logical\n- BuildKit cache mounts as secondary improvement (for rebuild speed, not size)\n\n**Build Script Enhancements:**\n\n`--dotnet-channel` option:\n- Pass value to existing `DOTNET_CHANNEL` ARG in Dockerfile\n- Default: `10.0` (matching current Dockerfile default)\n\n`--base-image` option:\n- Add `ARG BASE_IMAGE=docker/sandbox-templates:claude-code` as first line after syntax comment\n- Change `FROM` line to `FROM ${BASE_IMAGE}`\n- build.sh passes `--build-arg BASE_IMAGE=<value>` when option provided\n- Default: `docker/sandbox-templates:claude-code` (current base)\n- Document: \"Changing base image is advanced; ensure sandbox compatibility\"\n\n**OCI Labels Implementation:**\nAdd to Dockerfile after FROM:\n```dockerfile\nARG BUILD_DATE\nARG VCS_REF\nARG VERSION=1.0.0\n\nLABEL org.opencontainers.image.created=\"${BUILD_DATE}\" \\\n      org.opencontainers.image.revision=\"${VCS_REF}\" \\\n      org.opencontainers.image.version=\"${VERSION}\" \\\n      org.opencontainers.image.source=\"https://github.com/clairernovotny/agent-sandbox\" \\\n      org.opencontainers.image.title=\"agent-sandbox\" \\\n      org.opencontainers.image.description=\"Sandboxed development environment for AI agents\"\n```\n\nbuild.sh passes:\n```bash\n--build-arg BUILD_DATE=\"$(date -u +\"%Y-%m-%dT%H:%M:%SZ\")\"\n--build-arg VCS_REF=\"$(git rev-parse --short HEAD 2>/dev/null || echo unknown)\"\n```\n\nFix stale comment: \"dotnet-sandbox\" \u2192 \"agent-sandbox\" (line 7)\n\n**Verification:**\n```bash\n./build.sh  # Outputs baseline and result sizes\ndocker history agent-sandbox:latest  # Confirm layer optimization\ndocker inspect agent-sandbox:latest --format '{{json .Config.Labels}}' | jq  # Verify OCI labels\n```\n\n### PR 3: Documentation Update (fn-2-kcs.3)\n\n**Scope: All user-facing strings and volume names.**\n\n**Updates:**\n- README.md: all \"csd\" \u2192 \"asb\" command references\n- README.md: all \"dotnet-sandbox\" \u2192 \"agent-sandbox\" (including volume names)\n- sync-all.sh: user-facing output strings referencing \"csd\"\n- `_ASB_VOLUMES` array: rename `dotnet-sandbox-*` to `agent-sandbox-*`\n- Search and review:\n  ```bash\n  # Find all csd references\n  rg \"\\bcsd\\b\" --type-add 'docs:*.md' --type-add 'scripts:*.sh'\n\n  # Find all dotnet-sandbox references (all should be renamed)\n  rg \"dotnet-sandbox\"\n  ```\n- Clarify that `_ASB_LABEL` identifies containers as \"managed by asb\" (not per-user ownership)\n- Manual review of each hit before changing\n\n## Research Findings\n\n### aliases.sh Analysis (660 lines)\n**Variables to rename:**\n| Line | Current | Target |\n|------|---------|--------|\n| 16 | `_CSD_IMAGE` | `_ASB_IMAGE` |\n| 17 | `_CSD_LABEL` | `_ASB_LABEL` |\n| 18 | `_CSD_SCRIPT_DIR` | `_ASB_SCRIPT_DIR` |\n| 21-23 | `_CSD_VOLUMES` | `_ASB_VOLUMES` |\n| 25-26 | `_CSD_MOUNT_ONLY_VOLUMES` | **REMOVE** |\n\n**Functions to rename:**\n| Line | Current | Target |\n|------|---------|--------|\n| 30 | `_csd_container_name` | `_asb_container_name` |\n| 94 | `_csd_check_eci` | `_asb_check_isolation` |\n| 128 | `_csd_check_sandbox` | `_asb_check_sandbox` |\n| 230 | `_csd_preflight_checks` | `_asb_preflight_checks` |\n| 251 | `_csd_get_container_label` | `_asb_get_container_label` |\n| 257 | `_csd_get_container_image` | `_asb_get_container_image` |\n| 265 | `_csd_is_our_container` | `_asb_is_our_container` |\n| 292 | `_csd_check_container_ownership` | `_asb_check_container_ownership` |\n| 333 | `_csd_ensure_volumes` | `_asb_ensure_volumes` |\n\n### Dockerfile Analysis (161 lines)\n- Base image: `docker/sandbox-templates:claude-code`\n- Already has `DOTNET_CHANNEL` ARG defaulting to `10.0` (line 77)\n- Already has `# syntax=docker/dockerfile:1` for BuildKit\n- Partial cleanup exists (line 58, 83, 99)\n- **Known issue**: Trailing spaces after backslash on lines 30, 127, 133\n- Missing: consolidated cleanup, OCI labels, BASE_IMAGE ARG\n\n### build.sh Analysis (33 lines)\n- No CLI options, just passes `$@` to docker build\n- Stale comment on line 7\n\n## Quick commands\n\n```bash\n# Pre-work: Check for external variable references\nrg \"_CSD_\" --type sh\n\n# Test aliases after changes\nsource agent-sandbox/aliases.sh && asb --help\n\n# Build with size tracking\ncd agent-sandbox && ./build.sh  # Shows baseline and result in output\n\n# Check image layers\ndocker history agent-sandbox:latest\n\n# Verify OCI labels\ndocker inspect agent-sandbox:latest --format '{{json .Config.Labels}}' | jq\n\n# Search for remaining references (manual review each hit)\nrg \"\\bcsd\\b\"\nrg \"dotnet-sandbox\" | grep -v -E \"(_ASB_VOLUMES|_CSD_VOLUMES|docker volume)\"\n```\n\n## Task Dependencies\n\n```\nfn-2-kcs.1 (PR1: aliases.sh)\n    \u2514\u2500\u2500 fn-2-kcs.3 (PR3: docs - depends on new command names)\n\nfn-2-kcs.2 (PR2: Dockerfile + build.sh - independent)\n```\n\n## Acceptance\n\n**PR 1:**\n- [ ] All `_CSD_*` references removed (no compatibility layer needed)\n- [ ] All `_CSD_*` variables renamed to `_ASB_*` in aliases.sh\n- [ ] All `_csd_*` functions renamed to `_asb_*` in aliases.sh\n- [ ] `_csd_check_eci` renamed to `_asb_check_isolation` with conservative detection\n- [ ] Dead code `_CSD_MOUNT_ONLY_VOLUMES` removed\n- [ ] Comments updated from \"csd\" to \"asb\"\n- [ ] \"Dotnet sandbox\" branding fixed to \"Agent Sandbox\"\n- [ ] `--label` flag added with capability detection via help output\n- [ ] All temporary variables in functions declared with `local`\n- [ ] Isolation detection uses tab-separated docker info output\n- [ ] Isolation detection returns 2 for ambiguous cases (not false positive)\n- [ ] Output uses ASCII-only markers ([OK], [WARN], [ERROR])\n- [ ] `ASB_REQUIRE_ISOLATION=1` + `--force` prints ASCII bypass warning\n\n**PR 2:**\n- [ ] Dockerfile line continuations fixed (lines 30, 127, 133)\n- [ ] Build script handles missing baseline with explicit message and skips reduction target\n- [ ] Build script outputs baseline and result sizes for :latest tag\n- [ ] Build script errors if result image missing after build\n- [ ] `ARG BASE_IMAGE=docker/sandbox-templates:claude-code` added before FROM\n- [ ] FROM uses `${BASE_IMAGE}`\n- [ ] Image size reduced by >=10% from baseline (manual verification; skip for first build)\n- [ ] `docker history` confirms layer optimization\n- [ ] `--dotnet-channel` option works (default: 10.0)\n- [ ] `--base-image` option works (default: docker/sandbox-templates:claude-code)\n- [ ] OCI ARGs (BUILD_DATE, VCS_REF, VERSION) declared in Dockerfile\n- [ ] OCI labels with correct source URL present\n- [ ] build.sh passes BUILD_DATE and VCS_REF at build time\n- [ ] `docker inspect` shows correct OCI labels\n\n**PR 3:**\n- [ ] README.md updated with \"asb\" command references\n- [ ] README.md updated with \"agent-sandbox\" project references\n- [ ] Volume names renamed from `dotnet-sandbox-*` to `agent-sandbox-*`\n- [ ] sync-all.sh output strings updated\n- [ ] Each `rg \"\\bcsd\\b\"` hit manually reviewed and resolved\n- [ ] Each `rg \"dotnet-sandbox\"` hit manually reviewed and resolved\n"
  },
  "epic_id": "fn-2-kcs",
  "schema_version": 1,
  "tasks": [
    {
      "data": {
        "assignee": null,
        "claim_note": "",
        "claimed_at": null,
        "created_at": "2026-01-16T01:00:26.111910Z",
        "depends_on": [],
        "epic": "fn-2-kcs",
        "id": "fn-2-kcs.1",
        "priority": null,
        "spec_path": ".flow/tasks/fn-2-kcs.1.md",
        "status": "todo",
        "title": "PR1: Aliases.sh cleanup and label fix",
        "updated_at": "2026-01-16T01:46:31.151094Z"
      },
      "id": "fn-2-kcs.1",
      "spec": "# fn-2-kcs.1: PR1 - aliases.sh cleanup and label fix\n\n## Description\n\nClean up aliases.sh with consistent naming, add container label flag, and improve isolation detection output.\n\n## File to Modify\n\n- `agent-sandbox/aliases.sh` (660 lines)\n\n## Changes Required\n\n### 1. Variable Renames (5 variables)\n\n| Line | Current | Target |\n|------|---------|--------|\n| 16 | `_CSD_IMAGE` | `_ASB_IMAGE` |\n| 17 | `_CSD_LABEL` | `_ASB_LABEL` |\n| 18 | `_CSD_SCRIPT_DIR` | `_ASB_SCRIPT_DIR` |\n| 21-23 | `_CSD_VOLUMES` | `_ASB_VOLUMES` |\n\nAll references throughout the file must also be updated.\n\n### 2. Remove Dead Code\n\n- Lines 25-26: Delete `_CSD_MOUNT_ONLY_VOLUMES=()` declaration (unused empty array)\n\n### 3. Function Renames (9 functions)\n\n| Line | Current | Target |\n|------|---------|--------|\n| 30 | `_csd_container_name` | `_asb_container_name` |\n| 94 | `_csd_check_eci` | `_asb_check_isolation` |\n| 128 | `_csd_check_sandbox` | `_asb_check_sandbox` |\n| 230 | `_csd_preflight_checks` | `_asb_preflight_checks` |\n| 251 | `_csd_get_container_label` | `_asb_get_container_label` |\n| 257 | `_csd_get_container_image` | `_asb_get_container_image` |\n| 265 | `_csd_is_our_container` | `_asb_is_our_container` |\n| 292 | `_csd_check_container_ownership` | `_asb_check_container_ownership` |\n| 333 | `_csd_ensure_volumes` | `_asb_ensure_volumes` |\n\nAll function calls throughout the file must also be updated.\n\n### 4. Comment Updates\n\n| Line | Current | Change to |\n|------|---------|-----------|\n| 24 | \"not created by csd\" | \"not created by asb\" |\n| 498 | \"created by csd\" | \"created by asb\" |\n| 517 | \"created by csd\" | \"created by asb\" |\n| 534 | \"csd-managed\" | \"asb-managed\" |\n\n### 5. Branding Fix\n\n- Line 608: Change `\"Dotnet sandbox containers:\"` to `\"Agent Sandbox containers:\"`\n\n### 6. Add --label Flag to docker sandbox run\n\nAdd capability detection and `--label` flag (lines 568-580):\n\n```bash\n# Check if docker sandbox supports --label\nif docker sandbox run --help 2>&1 | grep -q '\\-\\-label'; then\n    args=(\n        --name \"$container_name\"\n        --label \"$_ASB_LABEL\"\n        \"${vol_args[@]}\"\n        \"${detached_args[@]}\"\n        --template \"$_ASB_IMAGE\"\n        claude\n    )\nelse\n    args=(\n        --name \"$container_name\"\n        \"${vol_args[@]}\"\n        \"${detached_args[@]}\"\n        --template \"$_ASB_IMAGE\"\n        claude\n    )\nfi\n```\n\n### 7. Isolation Detection Rewrite\n\nReplace `_csd_check_eci` with `_asb_check_isolation` using conservative detection:\n\n```bash\n_asb_check_isolation() {\n    local runtime rootless info_output\n\n    info_output=$(docker info --format '{{.DefaultRuntime}}\\t{{.Rootless}}' 2>/dev/null)\n    if [[ $? -ne 0 ]] || [[ -z \"$info_output\" ]]; then\n        echo \"[WARN] Unable to determine isolation status\" >&2\n        return 2\n    fi\n\n    IFS=$'\\t' read -r runtime rootless <<< \"$info_output\"\n\n    if [[ \"$runtime\" == \"sysbox-runc\" ]]; then\n        echo \"[OK] Isolation: sysbox-runc\" >&2\n        return 0\n    fi\n    if [[ \"$rootless\" == \"true\" ]]; then\n        echo \"[OK] Isolation: rootless mode\" >&2\n        return 0\n    fi\n\n    if [[ \"$runtime\" == \"runc\" ]] && [[ \"$rootless\" == \"false\" ]]; then\n        echo \"[WARN] No isolation detected (default runtime)\" >&2\n        return 1\n    fi\n\n    echo \"[WARN] Unable to determine isolation status\" >&2\n    return 2\n}\n```\n\n### 8. ASB_REQUIRE_ISOLATION Environment Variable\n\nIn preflight checks, if `ASB_REQUIRE_ISOLATION=1`:\n- Return 0: proceed normally\n- Return 1: fail with \"ERROR: Container isolation required but not detected. Use --force to bypass.\"\n- Return 2: fail with \"ERROR: Cannot verify isolation status. Use --force to bypass.\"\n\nWhen both `ASB_REQUIRE_ISOLATION=1` and `--force` are set, print warning then proceed:\n```\n*** WARNING: Bypassing isolation requirement with --force\n*** Running without verified isolation may expose host system\n```\n\n### 9. Variable Hygiene\n\nUse `local` for all temporary variables in functions (e.g., `local args=()`, `local status`).\n\n## Testing\n\n```bash\n# Source and test basic functionality\nsource agent-sandbox/aliases.sh && asb --help\n\n# Verify all variables/functions renamed\ngrep -E '_CSD_|_csd_' agent-sandbox/aliases.sh  # Should return nothing\n\n# Test isolation output\n_asb_check_isolation\n\n# Test with require flag\nASB_REQUIRE_ISOLATION=1 _asb_check_isolation\n```\n\n## Acceptance\n\n- [ ] All `_CSD_*` references removed (no compatibility layer needed)\n- [ ] All `_CSD_*` variables renamed to `_ASB_*` (5 total)\n- [ ] All `_csd_*` functions renamed to `_asb_*` (9 total)\n- [ ] `_csd_check_eci` renamed to `_asb_check_isolation` with conservative detection\n- [ ] Dead code `_CSD_MOUNT_ONLY_VOLUMES` removed\n- [ ] All \"csd\" comments updated to \"asb\" (4 locations)\n- [ ] \"Dotnet sandbox containers:\" changed to \"Agent Sandbox containers:\"\n- [ ] `--label` flag added with capability detection via help output\n- [ ] All temporary variables in functions declared with `local`\n- [ ] Isolation detection uses tab-separated docker info output\n- [ ] Isolation detection returns 2 for ambiguous cases\n- [ ] Output uses ASCII-only markers ([OK], [WARN], [ERROR])\n- [ ] `ASB_REQUIRE_ISOLATION=1` + `--force` prints bypass warning\n- [ ] `grep -E '_CSD_|_csd_' agent-sandbox/aliases.sh` returns nothing\n- [ ] `source aliases.sh && asb --help` works correctly\n\n## Done summary\nTBD\n\n## Evidence\n- Commits:\n- Tests:\n- PRs:\n"
    },
    {
      "data": {
        "assignee": null,
        "claim_note": "",
        "claimed_at": null,
        "created_at": "2026-01-16T01:00:27.323687Z",
        "depends_on": [],
        "epic": "fn-2-kcs",
        "id": "fn-2-kcs.2",
        "priority": null,
        "spec_path": ".flow/tasks/fn-2-kcs.2.md",
        "status": "todo",
        "title": "PR2: Dockerfile & build.sh (image size + CLI options + OCI labels)",
        "updated_at": "2026-01-16T05:00:00.000000Z"
      },
      "id": "fn-2-kcs.2",
      "spec": "# fn-2-kcs.2: PR2 - Dockerfile & build.sh (image size + CLI options + OCI labels)\n\n## Description\n\nReduce Docker image size and enhance build pipeline with CLI options and OCI labels. This combines Dockerfile optimization with build.sh enhancements to avoid merge conflicts.\n\n## Files to Modify\n\n- `agent-sandbox/Dockerfile` (161 lines)\n- `agent-sandbox/build.sh` (33 lines)\n\n## Part A: Dockerfile Prerequisites\n\n### Fix Line Continuation Issues\nTrailing spaces after backslash on lines 30, 127, 133 - remove them.\n\n### Add BASE_IMAGE ARG\nAfter line 1 (`# syntax=docker/dockerfile:1`):\n```dockerfile\nARG BASE_IMAGE=docker/sandbox-templates:claude-code\nFROM ${BASE_IMAGE}\n```\n\n## Part B: Image Size Reduction\n\n**Target**: >=10% reduction from baseline (manual verification; skip for first build)\n\n### BuildKit Cache Mounts\n\n**APT packages** (lines 16-58):\n```dockerfile\nRUN --mount=type=cache,target=/var/cache/apt,sharing=locked \\\n    --mount=type=cache,target=/var/lib/apt,sharing=locked \\\n    curl -fsSL ... \\\n    && apt-get update \\\n    && apt-get install -y ...\n```\nNote: With cache mounts, no need to delete lists - they're not baked into layer.\n\n**.NET SDK** (lines 80-83):\n```dockerfile\nRUN --mount=type=cache,target=/home/agent/.dotnet/sdk-manifests \\\n    --mount=type=cache,target=/tmp/dotnet-install,uid=1000,gid=1000 \\\n    curl -fsSL https://dot.net/v1/dotnet-install.sh -o /tmp/dotnet-install.sh \\\n    && chmod +x /tmp/dotnet-install.sh \\\n    && /tmp/dotnet-install.sh --channel ${DOTNET_CHANNEL}\n```\n\n**.NET workloads** (lines 96-99):\n```dockerfile\nRUN --mount=type=cache,target=/home/agent/.nuget/packages,uid=1000,gid=1000 \\\n    --mount=type=cache,target=/home/agent/.dotnet/toolResolverCache,uid=1000,gid=1000 \\\n    dotnet workload install wasm-tools wasm-tools-net9 \\\n    && dotnet tool install -g PowerShell\n```\n\n**npm** (lines 116-125):\n```dockerfile\nRUN --mount=type=cache,target=/home/agent/.npm/_cacache,uid=1000,gid=1000 \\\n    curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.40.3/install.sh | bash \\\n    && source /home/agent/.nvm/nvm.sh \\\n    && nvm install --lts \\\n    && nvm alias default 'lts/*' \\\n    && npm install -g typescript eslint prettier\n```\n\n**pip/uv** (lines 127-128):\n```dockerfile\nRUN --mount=type=cache,target=/home/agent/.cache/pip,uid=1000,gid=1000 \\\n    --mount=type=cache,target=/home/agent/.cache/uv,uid=1000,gid=1000 \\\n    curl -fsSL https://bun.com/install | bash \\\n    && curl -LsSf https://astral.sh/uv/install.sh | bash\n```\n\n### Additional Cleanup\nAfter AI tools install (line 136), add cleanup:\n```dockerfile\n    && rm -rf /tmp/* /home/agent/.bun/install-cache\n```\n\n## Part C: OCI Labels\n\nAdd after FROM (before first RUN):\n```dockerfile\nARG BUILD_DATE=unknown\nARG VCS_REF=unknown\nLABEL org.opencontainers.image.title=\"Agent Sandbox\" \\\n      org.opencontainers.image.description=\"Docker sandbox for AI coding agents\" \\\n      org.opencontainers.image.source=\"https://github.com/clairernovotny/agent-sandbox\" \\\n      org.opencontainers.image.licenses=\"MIT\" \\\n      org.opencontainers.image.created=\"${BUILD_DATE}\" \\\n      org.opencontainers.image.revision=\"${VCS_REF}\"\n```\n\n## Part D: build.sh Enhancements\n\nReplace entire build.sh with:\n```bash\n#!/usr/bin/env bash\nset -euo pipefail\n\n# ==============================================================================\n# Build agent-sandbox Docker image\n# ==============================================================================\n# Usage: ./build.sh [options] [docker build options]\n#   --dotnet-channel CHANNEL  .NET SDK channel (default: 10.0)\n#   --base-image IMAGE        Base image (default: docker/sandbox-templates:claude-code)\n#   --help                    Show this help\n#\n# Examples:\n#   ./build.sh                          # Build with defaults\n#   ./build.sh --dotnet-channel lts     # Use latest LTS\n#   ./build.sh --no-cache               # Pass option to docker build\n# ==============================================================================\n\nSCRIPT_DIR=\"$(cd \"$(dirname \"${BASH_SOURCE[0]}\")\" && pwd)\"\nIMAGE_NAME=\"agent-sandbox\"\nDATE_TAG=\"$(date +%Y-%m-%d)\"\n\n# Defaults\nDOTNET_CHANNEL=\"10.0\"\nBASE_IMAGE=\"docker/sandbox-templates:claude-code\"\n\n# Parse options\nDOCKER_ARGS=()\nwhile [[ $# -gt 0 ]]; do\n    case \"$1\" in\n        --dotnet-channel)\n            DOTNET_CHANNEL=\"$2\"\n            shift 2\n            ;;\n        --base-image)\n            BASE_IMAGE=\"$2\"\n            shift 2\n            ;;\n        --help|-h)\n            head -20 \"$0\" | grep -E '^#' | sed 's/^# //' | sed 's/^#//'\n            exit 0\n            ;;\n        *)\n            DOCKER_ARGS+=(\"$1\")\n            shift\n            ;;\n    esac\ndone\n\n# Enable BuildKit\nexport DOCKER_BUILDKIT=1\n\n# Capture baseline\nBASELINE_SIZE=$(docker images agent-sandbox:latest --format '{{.Size}}' 2>/dev/null | head -1)\nif [[ -z \"$BASELINE_SIZE\" ]]; then\n    echo \"=== Baseline: (no existing image) ===\"\n    HAVE_BASELINE=0\nelse\n    echo \"=== Baseline: $BASELINE_SIZE ===\"\n    HAVE_BASELINE=1\nfi\n\n# Generate OCI label values\nBUILD_DATE=\"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"\nVCS_REF=\"$(git rev-parse --short HEAD 2>/dev/null || echo 'unknown')\"\n\necho \"Building $IMAGE_NAME...\"\necho \"  Tags: :latest, :$DATE_TAG\"\necho \"  .NET channel: $DOTNET_CHANNEL\"\necho \"  Base image: $BASE_IMAGE\"\necho \"\"\n\ndocker build \\\n    -t \"${IMAGE_NAME}:latest\" \\\n    -t \"${IMAGE_NAME}:${DATE_TAG}\" \\\n    --build-arg DOTNET_CHANNEL=\"$DOTNET_CHANNEL\" \\\n    --build-arg BASE_IMAGE=\"$BASE_IMAGE\" \\\n    --build-arg BUILD_DATE=\"$BUILD_DATE\" \\\n    --build-arg VCS_REF=\"$VCS_REF\" \\\n    \"${DOCKER_ARGS[@]}\" \\\n    \"$SCRIPT_DIR\"\n\n# Capture result\nRESULT_SIZE=$(docker images agent-sandbox:latest --format '{{.Size}}' | head -1)\nif [[ -z \"$RESULT_SIZE\" ]]; then\n    echo \"ERROR: Build did not produce agent-sandbox:latest\"\n    exit 1\nfi\n\necho \"\"\necho \"Build complete!\"\necho \"=== Result: $RESULT_SIZE ===\"\ndocker images \"${IMAGE_NAME}\" --format \"table {{.Repository}}\\t{{.Tag}}\\t{{.ID}}\\t{{.Size}}\"\n\nif [[ \"$HAVE_BASELINE\" == \"1\" ]]; then\n    echo \"\"\n    echo \"=== Compare baseline ($BASELINE_SIZE) vs result ($RESULT_SIZE) for >=10% reduction ===\"\nfi\n```\n\n## Testing\n\n```bash\n# Build with defaults\ncd agent-sandbox && ./build.sh\n\n# Build with options\n./build.sh --dotnet-channel lts\n./build.sh --help\n\n# Verify image size reduction\ndocker images agent-sandbox\n\n# Analyze layers\ndocker history agent-sandbox:latest\n\n# Verify OCI labels\ndocker inspect agent-sandbox:latest --format '{{json .Config.Labels}}' | jq\n\n# Verify tools work\ndocker run --rm agent-sandbox:latest dotnet --version\ndocker run --rm agent-sandbox:latest node --version\ndocker run --rm agent-sandbox:latest python3 --version\n```\n\n## Acceptance\n\n- [ ] Dockerfile line continuations fixed (lines 30, 127, 133)\n- [ ] `ARG BASE_IMAGE` added before FROM\n- [ ] FROM uses `${BASE_IMAGE}`\n- [ ] BuildKit cache mount added for apt (`/var/cache/apt`, `/var/lib/apt`)\n- [ ] BuildKit cache mount added for .NET (`sdk-manifests`, `nuget/packages`, `toolResolverCache`)\n- [ ] BuildKit cache mount added for npm (`/home/agent/.npm/_cacache`)\n- [ ] BuildKit cache mount added for pip/uv (`/home/agent/.cache/pip`, `/home/agent/.cache/uv`)\n- [ ] OCI labels added (title, description, source, licenses, created, revision)\n- [ ] build.sh has `--dotnet-channel` option (default: 10.0)\n- [ ] build.sh has `--base-image` option (default: docker/sandbox-templates:claude-code)\n- [ ] build.sh has `--help` option\n- [ ] build.sh sets `DOCKER_BUILDKIT=1`\n- [ ] build.sh captures baseline and result sizes\n- [ ] Stale \"dotnet-sandbox\" comment in build.sh removed\n- [ ] Image builds successfully\n- [ ] All dev tools functional (dotnet, node, python3, bun)\n- [ ] Image size reduced >=10% from baseline (or documented if first build)\n- [ ] `docker inspect` shows correct OCI labels\n\n## Done summary\nTBD\n\n## Evidence\n- Commits:\n- Tests:\n- PRs:\n"
    },
    {
      "data": {
        "assignee": null,
        "claim_note": "",
        "claimed_at": null,
        "created_at": "2026-01-16T01:47:28.259238Z",
        "depends_on": [
          "fn-2-kcs.1"
        ],
        "epic": "fn-2-kcs",
        "id": "fn-2-kcs.3",
        "priority": null,
        "spec_path": ".flow/tasks/fn-2-kcs.3.md",
        "status": "todo",
        "title": "PR3: README.md documentation update",
        "updated_at": "2026-01-16T05:00:00.000000Z"
      },
      "id": "fn-2-kcs.3",
      "spec": "# fn-2-kcs.3: PR3 - README.md documentation update\n\n## Description\n\nUpdate README.md to reflect the renamed `asb` command and remove all stale `csd` references.\n\n**Dependency**: This task should be done AFTER fn-2-kcs.1 (aliases.sh rename) is complete.\n\n## File to Modify\n\n- `agent-sandbox/README.md`\n\n## Changes Required\n\n### Stale References to Update\n\n| Pattern | Change to |\n|---------|-----------|\n| `csd` command references | `asb` |\n| `csd-stop-all` | `asb-stop-all` |\n| \"Claude Sandbox Dotnet\" | \"Agent Sandbox\" |\n| \"Dotnet sandbox\" | \"Agent Sandbox\" |\n| \"dotnet-sandbox\" (project name) | \"agent-sandbox\" |\n\n### Volume Names\n\nRename volume names from `dotnet-sandbox-*` to `agent-sandbox-*`:\n- Update `_ASB_VOLUMES` array values in aliases.sh\n- Update any `docker volume` commands in documentation\n- Update variable definitions containing volume names\n\n### Additional Updates\n\n- Clarify that `_ASB_LABEL` identifies containers as \"managed by asb\" (not per-user ownership)\n\n### Search Commands\n\n```bash\n# Find all csd references\nrg \"\\bcsd\\b\" agent-sandbox/README.md\n\n# Find dotnet-sandbox references (all should be renamed)\nrg \"dotnet-sandbox\" agent-sandbox/README.md\n```\n\n## Testing\n\n```bash\n# Verify no stale references remain (word boundary search)\ngrep -i \"\\\\bcsd\\\\b\" agent-sandbox/README.md  # Should return nothing\n\n# Verify no dotnet-sandbox references remain\ngrep \"dotnet-sandbox\" agent-sandbox/README.md  # Should return nothing\n```\n\n## Acceptance\n\n- [ ] All `csd` command references changed to `asb`\n- [ ] `csd-stop-all` changed to `asb-stop-all`\n- [ ] \"Claude Sandbox Dotnet\" changed to \"Agent Sandbox\"\n- [ ] \"Dotnet sandbox\" (title case) changed to \"Agent Sandbox\"\n- [ ] \"dotnet-sandbox\" project references changed to \"agent-sandbox\"\n- [ ] Volume names `dotnet-sandbox-*` renamed to `agent-sandbox-*`\n- [ ] Title updated to reference \"agent-sandbox\"\n- [ ] All command examples updated\n- [ ] `grep -i \"\\\\bcsd\\\\b\" agent-sandbox/README.md` returns no matches\n- [ ] Documentation accurately describes the renamed commands\n\n## Done summary\nTBD\n\n## Evidence\n- Commits:\n- Tests:\n- PRs:\n"
    }
  ]
}
