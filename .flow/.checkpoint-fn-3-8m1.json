{
  "created_at": "2026-01-18T06:25:39.891242Z",
  "epic": {
    "data": {
      "branch_name": "fn-3-8m1",
      "created_at": "2026-01-18T06:25:31.314467Z",
      "depends_on_epics": [],
      "id": "fn-3-8m1",
      "next_task": 1,
      "plan_review_status": "unknown",
      "plan_reviewed_at": null,
      "spec_path": ".flow/specs/fn-3-8m1.md",
      "status": "open",
      "title": "Sync-Agent-Plugins Rsync Refactor",
      "updated_at": "2026-01-18T06:25:34.754628Z"
    },
    "spec": "# Sync-Agent-Plugins Refactoring Specification\n\n## Overview\n\nRefactor `sync-agent-plugins.sh` to use a declarative rsync-based approach for syncing portable configuration files from host to Docker volume.\n\n**Important constraints:**\n- **Linux only** - macOS has different config locations; block with error on macOS (future work)\n- **Sync is optional** - entrypoint.sh MUST also ensure all target files/dirs exist since sync may not be run\n\n---\n\n## Architecture\n\n### Single Configuration Map\n\nAll sync items defined in one array. For each entry:\n1. Target is ALWAYS created first (empty file/dir)\n2. Then source is copied if it exists (overwrites empty target)\n\nThe `:j` flag initializes JSON files with `{}` when created empty.\n\n```bash\n# Format: \"source:target:flags\"\n# Flags: d=directory, f=file, j=initialize with {} if empty\n\nSYNC_MAP=(\n  # \u2500\u2500\u2500 Claude Code \u2500\u2500\u2500\n  # Note: target files are NOT dot-prefixed for visibility in volume\n  \"/source/.claude.json:/target/claude/claude.json:fj\"\n  \"/source/.claude/.credentials.json:/target/claude/credentials.json:f\"\n  \"/source/.claude/settings.json:/target/claude/settings.json:fj\"\n  \"/source/.claude/settings.local.json:/target/claude/settings.local.json:f\"\n  \"/source/.claude/plugins:/target/claude/plugins:d\"\n  \"/source/.claude/skills:/target/claude/skills:d\"\n\n  # \u2500\u2500\u2500 GitHub CLI \u2500\u2500\u2500\n  # Note: ~/.config/gh/ already covered by config symlink\n  \"/source/.config/gh:/target/config/gh:d\"\n\n  # \u2500\u2500\u2500 OpenCode \u2500\u2500\u2500\n  # Config: ~/.config/opencode/ already covered by config symlink\n  \"/source/.config/opencode:/target/config/opencode:d\"\n  \"/source/.local/share/opencode:/target/local/share/opencode:d\"\n\n  # \u2500\u2500\u2500 tmux \u2500\u2500\u2500\n  # Supports both legacy (~/.tmux.conf) and XDG (~/.config/tmux/)\n  \"/source/.tmux.conf:/target/tmux/.tmux.conf:f\"\n  \"/source/.tmux:/target/tmux/.tmux:d\"\n  \"/source/.config/tmux:/target/config/tmux:d\"\n\n  # \u2500\u2500\u2500 Shell \u2500\u2500\u2500\n  \"/source/.bash_aliases:/target/shell/.bash_aliases:f\"\n  \"/source/.bashrc.d:/target/shell/.bashrc.d:d\"\n\n  # \u2500\u2500\u2500 VS Code Server \u2500\u2500\u2500\n  \"/source/.vscode-server/extensions:/target/vscode-server/extensions:d\"\n  \"/source/.vscode-server/data/Machine:/target/vscode-server/data/Machine:d\"\n  \"/source/.vscode-server/data/User/mcp:/target/vscode-server/data/User/mcp:d\"\n  \"/source/.vscode-server/data/User/prompts:/target/vscode-server/data/User/prompts:d\"\n  \"/source/.vscode-server/data/Machine/settings.json:/target/vscode-server/data/Machine/settings.json:f\"\n  \"/source/.vscode-server/data/User/mcp.json:/target/vscode-server/data/User/mcp.json:f\"\n\n  # \u2500\u2500\u2500 VS Code Insiders \u2500\u2500\u2500\n  \"/source/.vscode-server-insiders/extensions:/target/vscode-server-insiders/extensions:d\"\n  \"/source/.vscode-server-insiders/data/Machine:/target/vscode-server-insiders/data/Machine:d\"\n  \"/source/.vscode-server-insiders/data/User/mcp:/target/vscode-server-insiders/data/User/mcp:d\"\n  \"/source/.vscode-server-insiders/data/User/prompts:/target/vscode-server-insiders/data/User/prompts:d\"\n  \"/source/.vscode-server-insiders/data/Machine/settings.json:/target/vscode-server-insiders/data/Machine/settings.json:f\"\n  \"/source/.vscode-server-insiders/data/User/mcp.json:/target/vscode-server-insiders/data/User/mcp.json:f\"\n\n  # \u2500\u2500\u2500 Copilot \u2500\u2500\u2500\n  \"/source/.copilot:/target/copilot:d\"\n  \"/source/.copilot/config.json:/target/copilot/config.json:f\"\n\n  # \u2500\u2500\u2500 Gemini \u2500\u2500\u2500\n  \"/source/.gemini:/target/gemini:d\"\n  \"/source/.gemini/settings.json:/target/gemini/settings.json:fj\"\n  \"/source/.gemini/google_accounts.json:/target/gemini/google_accounts.json:f\"\n  \"/source/.gemini/oauth_creds.json:/target/gemini/oauth_creds.json:f\"\n\n  # \u2500\u2500\u2500 Codex \u2500\u2500\u2500\n  \"/source/.codex:/target/codex:d\"\n  \"/source/.codex/skills:/target/codex/skills:d\"\n  \"/source/.codex/auth.json:/target/codex/auth.json:f\"\n  \"/source/.codex/config.toml:/target/codex/config.toml:f\"\n\n)\n```\n\n### Rsync-Based Sync Function\n\n```bash\nsync_configs() {\n  docker run --rm \\\n    --mount type=bind,src=\"$HOME\",dst=/source,readonly \\\n    --mount type=volume,src=\"$DATA_VOLUME\",dst=/target \\\n    eeacms/rsync sh -ec '\n      ensure() {\n        path=\"$1\"; flags=\"$2\"\n        case \"$flags\" in\n          *d*) mkdir -p \"$path\" ;;\n          *f*) mkdir -p \"$(dirname \"$path\")\"; touch \"$path\" ;;\n        esac\n        # Initialize JSON with {} if empty and flagged\n        case \"$flags\" in\n          *j*) [ -s \"$path\" ] || echo \"{}\" > \"$path\" ;;\n        esac\n      }\n\n      copy() {\n        src=\"$1\"; dst=\"$2\"; flags=\"$3\"\n        # Always ensure target exists first\n        ensure \"$dst\" \"$flags\"\n        # Then copy from source if it exists (overwrites empty target)\n        [ -e \"$src\" ] && rsync -a \"$src\" \"$(dirname \"$dst\")/\"\n      }\n\n      '\"$(for entry in \"${SYNC_MAP[@]}\"; do\n        src=\"${entry%%:*}\"\n        rest=\"${entry#*:}\"\n        dst=\"${rest%%:*}\"\n        flags=\"${rest#*:}\"\n        printf 'copy %q %q %q\\n' \"$src\" \"$dst\" \"$flags\"\n      done)\"'\n\n      chown -R 1000:1000 /target\n    '\n}\n```\n\n---\n\n## File Inventory\n\n### Claude Code\n| Host | Volume | Notes |\n|------|--------|-------|\n| `~/.claude.json` | `/mnt/agent-data/claude/claude.json` | JSON init, no dot prefix in volume |\n| `~/.claude/.credentials.json` | `/mnt/agent-data/claude/credentials.json` | no dot prefix in volume |\n| `~/.claude/settings.json` | `/mnt/agent-data/claude/settings.json` | JSON init |\n| `~/.claude/settings.local.json` | `/mnt/agent-data/claude/settings.local.json` | optional |\n| `~/.claude/plugins/` | `/mnt/agent-data/claude/plugins/` | cache/, marketplaces/ |\n| `~/.claude/skills/` | `/mnt/agent-data/claude/skills/` | |\n\n**Post-sync transforms (keep existing):**\n- `installed_plugins.json`: Path rewrite + scope change\n- `known_marketplaces.json`: Path rewrite\n\n### GitHub CLI\n| Host | Volume | Notes |\n|------|--------|-------|\n| `~/.config/gh/` | `/mnt/agent-data/config/gh/` | config.yml, hosts.yml |\n\n### OpenCode\n| Host | Volume | Notes |\n|------|--------|-------|\n| `~/.config/opencode/` | `/mnt/agent-data/config/opencode/` | opencode.json, agent/, command/, plugin/ |\n| `~/.local/share/opencode/` | `/mnt/agent-data/local/share/opencode/` | auth.json |\n\n### tmux\n| Host | Volume | Notes |\n|------|--------|-------|\n| `~/.tmux.conf` | `/mnt/agent-data/tmux/.tmux.conf` | legacy location |\n| `~/.tmux/` | `/mnt/agent-data/tmux/.tmux/` | TPM plugins |\n| `~/.config/tmux/` | `/mnt/agent-data/config/tmux/` | XDG location |\n\n### Shell\n| Host | Volume | Notes |\n|------|--------|-------|\n| `~/.bash_aliases` | `/mnt/agent-data/shell/.bash_aliases` | |\n| `~/.bashrc.d/` | `/mnt/agent-data/shell/.bashrc.d/` | |\n\n---\n\n## Dockerfile Changes\n\nAdd symlinks for new tools (after line 224):\n\n```dockerfile\n    # tmux (legacy location)\n    && mkdir -p /mnt/agent-data/tmux \\\n    && ln -s /mnt/agent-data/tmux/.tmux.conf ${HOME}/.tmux.conf \\\n    && ln -s /mnt/agent-data/tmux/.tmux ${HOME}/.tmux \\\n    \\\n    # Shell configs\n    && mkdir -p /mnt/agent-data/shell \\\n    && ln -s /mnt/agent-data/shell/.bash_aliases ${HOME}/.bash_aliases_imported \\\n    && ln -s /mnt/agent-data/shell/.bashrc.d ${HOME}/.bashrc.d \\\n    \\\n    # OpenCode data (XDG_DATA_HOME)\n    && mkdir -p /mnt/agent-data/local/share \\\n    && ln -s /mnt/agent-data/local/share ${HOME}/.local/share\n```\n\nNote: `~/.config/gh`, `~/.config/opencode`, `~/.config/tmux` are already covered by the existing `~/.config` \u2192 `/mnt/agent-data/config` symlink.\n\n---\n\n## Files to Modify\n\n| File | Changes |\n|------|---------|\n| [agent-sandbox/sync-agent-plugins.sh](agent-sandbox/sync-agent-plugins.sh) | Replace with SYNC_MAP + rsync pattern; add Linux-only guard |\n| [agent-sandbox/Dockerfile](agent-sandbox/Dockerfile) | Add symlinks for tmux, shell, ~/.local/share |\n| [agent-sandbox/entrypoint.sh](agent-sandbox/entrypoint.sh) | MUST ensure ALL target files/dirs exist (sync is optional) |\n\n---\n\n## Verification\n\n```bash\n# Dry run\nsync-agent-plugins.sh --dry-run\n\n# Inspect volume\ndocker run --rm -v sandbox-agent-data:/data alpine ls -laR /data\n\n# Test in container\ngh auth status\nopencode --version\ntmux  # should load config\n```\n"
  },
  "epic_id": "fn-3-8m1",
  "schema_version": 1,
  "tasks": []
}
