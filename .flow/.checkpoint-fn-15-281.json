{
  "created_at": "2026-01-24T23:39:14.157498Z",
  "epic": {
    "data": {
      "branch_name": "fn-15-281",
      "created_at": "2026-01-24T20:22:42.322518Z",
      "depends_on_epics": ["fn-20-6fe"],
      "id": "fn-15-281",
      "next_task": 1,
      "plan_review_status": "unknown",
      "plan_reviewed_at": null,
      "spec_path": ".flow/specs/fn-15-281.md",
      "status": "open",
      "title": "ContainAI-managed dockerd bundle + update checks",
      "updated_at": "2026-01-24T22:45:34.858042Z"
    },
    "spec": "# ContainAI-managed dockerd bundle + update checks\n\n## Overview\n\nShip a self-contained dockerd binary bundle at `/opt/containai/docker/<version>/` with symlinks from `/opt/containai/bin/` that ContainAI fully controls. The `containai-docker.service` systemd unit always uses the symlinked path\u2014never system Docker or Docker Desktop. Rate-limited pre-command checks warn users about available updates; `cai update` applies them atomically.\n\n**Why:** Prevents Docker Desktop integration drift, ensures consistent behavior across installations, enables atomic updates with easy rollback, and makes security updates explicit and visible.\n\n## Scope\n\n**In scope:**\n- Dockerd bundle download/install in `cai setup` (Linux/WSL2 only)\n- Versioned directory structure with symlinks for atomic updates\n- Bundle version tracking at `/opt/containai/VERSION`\n- Rate-limited update check before every `cai` command\n- `cai update` upgrades dockerd bundle when newer exists\n- Service restart after bundle update (with container stop warning)\n- Systemd unit always references symlinked path\n- Config: `update.check_interval` (hourly/daily/weekly/never)\n- Env override: `CAI_UPDATE_CHECK_INTERVAL`\n\n**Out of scope:**\n- macOS (uses Lima VM with its own Docker)\n- Fallback to `/usr/bin/dockerd`\n- Modifying `docker.service` or `/usr/bin/docker`\n- Auto-cron/systemd timers for updates\n\n## Architecture\n\n```\n/opt/containai/\n\u251c\u2500\u2500 docker/\n\u2502   \u251c\u2500\u2500 27.3.1/                    # Previous version (kept for rollback)\n\u2502   \u2502   \u251c\u2500\u2500 dockerd\n\u2502   \u2502   \u251c\u2500\u2500 docker\n\u2502   \u2502   \u251c\u2500\u2500 containerd\n\u2502   \u2502   \u2514\u2500\u2500 ...\n\u2502   \u2514\u2500\u2500 27.4.0/                    # Current version\n\u2502       \u251c\u2500\u2500 dockerd\n\u2502       \u251c\u2500\u2500 docker\n\u2502       \u251c\u2500\u2500 containerd\n\u2502       \u2514\u2500\u2500 ...\n\u251c\u2500\u2500 bin/                           # Stable symlinks (systemd uses these)\n\u2502   \u251c\u2500\u2500 dockerd -> ../docker/27.4.0/dockerd\n\u2502   \u251c\u2500\u2500 docker -> ../docker/27.4.0/docker\n\u2502   \u251c\u2500\u2500 containerd -> ../docker/27.4.0/containerd\n\u2502   \u2514\u2500\u2500 ...\n\u2514\u2500\u2500 VERSION                        # Contains \"27.4.0\"\n```\n\n```\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                      cai command                            \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510   \u2502\n\u2502  \u2502 _cai_update_check() - rate-limited, non-blocking     \u2502   \u2502\n\u2502  \u2502  \u2022 Read ~/.config/containai/config.toml              \u2502   \u2502\n\u2502  \u2502  \u2022 If interval elapsed:                              \u2502   \u2502\n\u2502  \u2502    - Check GitHub releases for ContainAI             \u2502   \u2502\n\u2502  \u2502    - Check Docker index for dockerd bundle           \u2502   \u2502\n\u2502  \u2502  \u2022 Warn (yellow) if updates available                \u2502   \u2502\n\u2502  \u2502  \u2022 For dockerd: warn that update will restart        \u2502   \u2502\n\u2502  \u2502    containers                                        \u2502   \u2502\n\u2502  \u2502  \u2022 Never block command execution                     \u2502   \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518   \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502           containai-docker.service (systemd)                \u2502\n\u2502  ExecStart=/opt/containai/bin/dockerd \\                     \u2502\n\u2502            --config-file=/etc/containai/docker/daemon.json  \u2502\n\u2502  Environment=PATH=/opt/containai/bin:...                    \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n```\n\n### Atomic Update Flow\n\n```mermaid\nsequenceDiagram\n    participant U as User\n    participant C as cai update\n    participant D as /opt/containai/docker/\n    participant S as containai-docker.service\n\n    U->>C: cai update\n    C->>C: Check for newer version\n    C->>U: \"Updating dockerd will stop running containers. Continue? [y/N]\"\n    U->>C: y\n    C->>D: Download + extract to docker/<new-version>/\n    C->>D: Update bin/* symlinks \u2192 docker/<new-version>/\n    C->>D: Write VERSION file\n    C->>S: systemctl restart containai-docker\n    C->>U: \"Updated dockerd 27.3.1 \u2192 27.4.0\"\n```\n\n## Approach\n\n### 1. Bundle constants (docker.sh)\nAdd path constants following existing pattern at `src/lib/docker.sh:306-317`:\n- `_CAI_CONTAINAI_DIR=\"/opt/containai\"`\n- `_CAI_DOCKERD_BUNDLE_DIR=\"$_CAI_CONTAINAI_DIR/docker\"`\n- `_CAI_DOCKERD_BIN_DIR=\"$_CAI_CONTAINAI_DIR/bin\"`\n- `_CAI_DOCKERD_BIN=\"$_CAI_DOCKERD_BIN_DIR/dockerd\"`\n- `_CAI_DOCKERD_VERSION_FILE=\"$_CAI_CONTAINAI_DIR/VERSION\"`\n\n### 2. Bundle installation (setup.sh)\nFollow download pattern at `src/lib/setup.sh:557-601`:\n- Resolve latest version by parsing Docker index HTML\n- Download `docker-<version>.tgz` with `curl -fsSL --connect-timeout 5 --max-time 120`\n- **Note:** Docker does NOT provide official checksums\u2014trust HTTPS only (documented gap)\n- Extract to `/opt/containai/docker/<version>/`\n- Create symlinks in `/opt/containai/bin/` pointing to versioned binaries\n- Write version to `/opt/containai/VERSION`\n\n### 3. Update check (update.sh)\n- Parse config with existing `_containai_parse_config()` at `src/lib/config.sh:225-561`\n- Store state in `~/.config/containai/config.toml`:\n  - `update.last_checked` (RFC3339)\n  - `update.last_result` (ok/network_error/parse_error)\n- Use file mtime comparison for rate limiting (see practice-scout findings)\n- Non-blocking: 5s connect timeout, advance timestamp on network error\n- **For dockerd updates:** warn that containers will be stopped/restarted\n\n### 4. Bundle update (update.sh)\n- Download new version to `/opt/containai/docker/<new-version>/`\n- Prompt user: \"Updating dockerd will stop running containers. Continue? [y/N]\"\n- Update symlinks atomically (ln -sfn)\n- Write new VERSION\n- Restart containai-docker.service\n- Keep previous version for rollback (cleanup old versions on next update)\n\n### 5. Systemd unit update\nModify `_cai_create_isolated_docker_service()` at `src/lib/setup.sh:970-1048` to use `$_CAI_DOCKERD_BIN` (symlinked path).\n\n## Risks & Mitigations\n\n| Risk | Mitigation |\n|------|------------|\n| No official Docker checksums | Trust HTTPS; document limitation; consider self-hosting checksums later |\n| Network failures block CLI | Non-blocking check with short timeout; advance timestamp on error |\n| Running containers during update | Warn user, require confirmation, restart service after symlink update |\n| Partial download corruption | Download to temp, verify size, atomic move to versioned dir |\n| Clock skew breaks rate limit | Use epoch seconds, not formatted timestamps |\n| macOS confusion | Skip bundle entirely on macOS; use Lima VM's Docker |\n| Symlink update race | Use `ln -sfn` for atomic symlink replacement |\n| Disk space from old versions | Keep only previous version; cleanup older on next update |\n\n## Quick commands\n\n```bash\n# Verify bundle installed\nls -la /opt/containai/bin/dockerd\nreadlink /opt/containai/bin/dockerd  # Shows versioned path\ncat /opt/containai/VERSION\n\n# Check systemd unit uses symlinked path\ngrep ExecStart /etc/systemd/system/containai-docker.service\n\n# Test update check\nCAI_UPDATE_CHECK_INTERVAL=hourly cai doctor\n\n# Force update (will restart containers)\ncai update --force\n```\n\n## Acceptance\n\n- [ ] `cai setup` installs dockerd bundle to `/opt/containai/docker/<version>/` on Linux/WSL2\n- [ ] Symlinks created in `/opt/containai/bin/` pointing to versioned binaries\n- [ ] `/opt/containai/VERSION` contains installed version string\n- [ ] `containai-docker.service` ExecStart uses `/opt/containai/bin/dockerd`\n- [ ] Pre-command update check runs (rate-limited by config)\n- [ ] Yellow warning displayed when updates available\n- [ ] **Dockerd update warning includes \"will stop running containers\"**\n- [ ] `cai update` prompts before updating dockerd (unless --force)\n- [ ] `cai update` restarts containai-docker.service after bundle update\n- [ ] Network failures don't block CLI commands\n- [ ] `CAI_UPDATE_CHECK_INTERVAL=never` disables checks\n- [ ] macOS skips bundle (uses Lima VM)\n- [ ] Previous version kept for potential rollback\n- [ ] docs/setup-guide.md updated with bundle section\n- [ ] docs/troubleshooting.md has \"Updates available\" entry\n\n## Test notes\n\n- Integration test: `test-bundle-install.sh` - fresh setup, verify paths and symlinks\n- Integration test: `test-update-check.sh` - mock responses, verify rate limiting\n- Integration test: `test-bundle-update.sh` - verify atomic symlink update and service restart\n- Manual: Run `cai doctor` twice within interval, confirm no duplicate check\n- Manual: Disconnect network, run `cai` command, confirm no block\n- Manual: Run `cai update` with containers running, verify warning\n\n## References\n\n- Existing docker constants: `src/lib/docker.sh:306-317`\n- Systemd unit creation: `src/lib/setup.sh:970-1048`\n- Config parsing: `src/lib/config.sh:225-561`\n- Arch detection: `src/lib/setup.sh:528-542`\n- Timeout wrapper: `src/lib/docker.sh:49-97`\n- Docker static index: https://download.docker.com/linux/static/stable/\n- GitHub releases API: https://api.github.com/repos/OWNER/REPO/releases/latest\n- moby/moby#47495: Docker doesn't provide official checksums\n- Atomic symlink: `ln -sfn` creates symlink atomically\n\n## Open questions\n\n1. **Checksum verification**: Since Docker doesn't provide checksums, should we maintain our own or accept HTTPS-only? (Current decision: trust HTTPS, document limitation)\n2. **Bundle vs ContainAI updates**: Should `cai update` report both separately or combined? (Spec: report both with separate lines)\n3. **Version retention**: Keep only previous version, or allow configurable retention? (Current decision: keep only previous)\n\n## Dependencies\n\n- **fn-14-nm0** (DONE): Provides isolated docker service infrastructure\n- **fn-12-css** (soft): Config management for update interval storage\n"
  },
  "epic_id": "fn-15-281",
  "schema_version": 2,
  "tasks": [
    {
      "data": {
        "assignee": null,
        "claim_note": "",
        "claimed_at": null,
        "created_at": "2026-01-24T20:23:36.372266Z",
        "depends_on": [],
        "epic": "fn-15-281",
        "id": "fn-15-281.1",
        "priority": null,
        "spec_path": ".flow/tasks/fn-15-281.1.md",
        "status": "todo",
        "title": "Add dockerd bundle constants to docker.sh",
        "updated_at": "2026-01-24T20:31:55.684855Z"
      },
      "id": "fn-15-281.1",
      "runtime": null,
      "spec": "# fn-15-281.1 Add dockerd bundle constants to docker.sh\n\n## Description\nAdd constants for the ContainAI-managed dockerd bundle paths to `src/lib/docker.sh`. Uses versioned directories with stable symlinks for atomic updates.\n\n**Size:** S\n**Files:** `src/lib/docker.sh`\n\n## Approach\n\nAdd constants near existing docker path constants at line 306-317:\n- `_CAI_CONTAINAI_DIR=\"/opt/containai\"`\n- `_CAI_DOCKERD_BUNDLE_DIR=\"$_CAI_CONTAINAI_DIR/docker\"` (contains versioned subdirs)\n- `_CAI_DOCKERD_BIN_DIR=\"$_CAI_CONTAINAI_DIR/bin\"` (stable symlinks)\n- `_CAI_DOCKERD_BIN=\"$_CAI_DOCKERD_BIN_DIR/dockerd\"`\n- `_CAI_DOCKERD_VERSION_FILE=\"$_CAI_CONTAINAI_DIR/VERSION\"`\n\nAdd helper functions:\n- `_cai_dockerd_bundle_installed()` - returns 0 if bundle exists (checks symlink target)\n- `_cai_dockerd_bundle_version()` - echoes version from VERSION file\n## Approach\n\nAdd constants near existing docker path constants at line 306-317:\n- `_CAI_DOCKERD_BUNDLE_DIR=\"/opt/containai/docker\"`\n- `_CAI_DOCKERD_BIN_DIR=\"$_CAI_DOCKERD_BUNDLE_DIR/docker\"`\n- `_CAI_DOCKERD_BIN=\"$_CAI_DOCKERD_BIN_DIR/dockerd\"`\n- `_CAI_DOCKERD_VERSION_FILE=\"$_CAI_DOCKERD_BUNDLE_DIR/VERSION\"`\n\nAdd two helper functions:\n- `_cai_dockerd_bundle_installed()` - returns 0 if bundle exists\n- `_cai_dockerd_bundle_version()` - echoes version from VERSION file\n## Acceptance\n- [ ] Constants added to docker.sh near line 317\n- [ ] Uses /opt/containai/ as base directory\n- [ ] Separates versioned bundles (docker/) from stable symlinks (bin/)\n- [ ] `_cai_dockerd_bundle_installed` function works\n- [ ] `_cai_dockerd_bundle_version` function works\n- [ ] shellcheck passes\n## Done summary\nTBD\n\n## Evidence\n- Commits:\n- Tests:\n- PRs:\n"
    },
    {
      "data": {
        "assignee": null,
        "claim_note": "",
        "claimed_at": null,
        "created_at": "2026-01-24T20:23:36.446607Z",
        "depends_on": [
          "fn-15-281.1"
        ],
        "epic": "fn-15-281",
        "id": "fn-15-281.2",
        "priority": null,
        "spec_path": ".flow/tasks/fn-15-281.2.md",
        "status": "todo",
        "title": "Add dockerd bundle installation to setup.sh",
        "updated_at": "2026-01-24T20:31:55.925309Z"
      },
      "id": "fn-15-281.2",
      "runtime": null,
      "spec": "# fn-15-281.2 Add dockerd bundle installation to setup.sh\n\n## Description\nAdd dockerd bundle installation to `cai setup` for Linux/WSL2 using versioned directories and symlinks for atomic updates.\n\n**Size:** M\n**Files:** `src/lib/setup.sh`\n\n## Approach\n\nAdd `_cai_install_dockerd_bundle()` function:\n1. Detect architecture using pattern at line 528-542 (map to Docker's arch names: x86_64, aarch64)\n2. Resolve latest version by parsing Docker index HTML at `https://download.docker.com/linux/static/stable/<arch>/`\n3. Download `docker-<version>.tgz` with `curl -fsSL --connect-timeout 5 --max-time 120`\n4. Extract to `/opt/containai/docker/<version>/`\n5. Create symlinks in `/opt/containai/bin/`:\n   - `dockerd -> ../docker/<version>/dockerd`\n   - `docker -> ../docker/<version>/docker`\n   - `containerd -> ../docker/<version>/containerd`\n   - (and other binaries in the bundle)\n6. Write version to `/opt/containai/VERSION`\n\nUse `ln -sfn` for atomic symlink creation/update.\n\nCall from Linux/WSL2 setup path. Skip on macOS (uses Lima VM).\n\nModify `_cai_create_isolated_docker_service()` to use `$_CAI_DOCKERD_BIN` (the symlinked path).\n\n## Key context\n\n- Docker does NOT provide checksum files\u2014trust HTTPS only\n- Follow download pattern at `src/lib/setup.sh:557-601`\n- Use `_cai_timeout` wrapper from `docker.sh:49-97` for portable timeout\n- `ln -sfn` replaces symlink atomically (no intermediate broken state)\n## Approach\n\nAdd `_cai_install_dockerd_bundle()` function:\n1. Detect architecture using pattern at line 528-542 (map to Docker's arch names: x86_64, aarch64)\n2. Resolve latest version by parsing Docker index HTML at `https://download.docker.com/linux/static/stable/<arch>/`\n3. Download `docker-<version>.tgz` with `curl -fsSL --connect-timeout 5 --max-time 120`\n4. Extract to temp dir, verify dockerd binary exists\n5. Move to `/opt/containai/docker/` with sudo (root-owned, 0755)\n6. Write version to `/opt/containai/docker/VERSION`\n\nCall from Linux/WSL2 setup path. Skip on macOS (uses Lima VM).\n\nModify `_cai_create_isolated_docker_service()` to use `$_CAI_DOCKERD_BIN` in ExecStart.\n\n## Key context\n\n- Docker does NOT provide checksum files\u2014trust HTTPS only\n- Follow download pattern at `src/lib/setup.sh:557-601`\n- Use `_cai_timeout` wrapper from `docker.sh:49-97` for portable timeout\n## Acceptance\n- [ ] `_cai_install_dockerd_bundle` function added\n- [ ] Downloads from Docker static index\n- [ ] Extracts to /opt/containai/docker/<version>/\n- [ ] Creates symlinks in /opt/containai/bin/\n- [ ] Symlinks use relative paths (../docker/<version>/...)\n- [ ] Writes VERSION file to /opt/containai/VERSION\n- [ ] containai-docker.service ExecStart uses /opt/containai/bin/dockerd\n- [ ] Skipped on macOS\n- [ ] shellcheck passes\n## Done summary\nTBD\n\n## Evidence\n- Commits:\n- Tests:\n- PRs:\n"
    },
    {
      "data": {
        "assignee": null,
        "claim_note": "",
        "claimed_at": null,
        "created_at": "2026-01-24T20:23:36.524071Z",
        "depends_on": [
          "fn-15-281.1"
        ],
        "epic": "fn-15-281",
        "id": "fn-15-281.3",
        "priority": null,
        "spec_path": ".flow/tasks/fn-15-281.3.md",
        "status": "todo",
        "title": "Add update check and bundle update functions to update.sh",
        "updated_at": "2026-01-24T20:31:56.153509Z"
      },
      "id": "fn-15-281.3",
      "runtime": null,
      "spec": "# fn-15-281.3 Add update check and bundle update functions to update.sh\n\n## Description\nAdd rate-limited update check and bundle update functions to `src/lib/update.sh`. Includes container stop warning and service restart.\n\n**Size:** M\n**Files:** `src/lib/update.sh`\n\n## Approach\n\n### _cai_update_check()\n1. Read config with `_containai_parse_config()` from `config.sh:225-561`\n2. Check `update.check_interval` (hourly/daily/weekly/never) - default daily\n3. Honor `CAI_UPDATE_CHECK_INTERVAL` env override\n4. Compare `update.last_checked` (RFC3339) against current time\n5. If interval not elapsed \u2192 return immediately (no network)\n6. If elapsed \u2192 check versions:\n   - ContainAI: GitHub releases API with 5s timeout\n   - Dockerd bundle: parse Docker index HTML\n7. If network fails \u2192 set `update.last_result=network_error`, advance `last_checked`, return (don't block)\n8. If updates available \u2192 print yellow warning using `_cai_warn` style\n9. **For dockerd updates:** include \"Updating will stop running containers\"\n10. Update `last_checked` and `last_result` in config\n\n### _cai_update_dockerd_bundle()\n1. Check latest version from Docker index\n2. Compare to installed version from VERSION file\n3. If newer:\n   - Prompt: \"Updating dockerd will stop running containers. Continue? [y/N]\" (skip with --force)\n   - Download to temp dir\n   - Extract to `/opt/containai/docker/<new-version>/`\n   - Update symlinks in `/opt/containai/bin/` using `ln -sfn`\n   - Write new VERSION\n   - `sudo systemctl restart containai-docker.service`\n   - Cleanup: remove versions older than previous (keep current + previous only)\n\n## Key context\n\n- Use epoch seconds for timestamp comparison (portable)\n- Use `date -Iseconds` for RFC3339 output (GNU date)\n- Warning format per spec: yellow, emphasize security for dockerd\n- `ln -sfn` for atomic symlink update\n## Approach\n\n### _cai_update_check()\n1. Read config with `_containai_parse_config()` from `config.sh:225-561`\n2. Check `update.check_interval` (hourly/daily/weekly/never) - default daily\n3. Honor `CAI_UPDATE_CHECK_INTERVAL` env override\n4. Compare `update.last_checked` (RFC3339) against current time\n5. If interval not elapsed \u2192 return immediately (no network)\n6. If elapsed \u2192 check versions:\n   - ContainAI: GitHub releases API with 5s timeout\n   - Dockerd bundle: parse Docker index HTML\n7. If network fails \u2192 set `update.last_result=network_error`, advance `last_checked`, return (don't block)\n8. If updates available \u2192 print yellow warning using `_cai_warn` style\n9. Update `last_checked` and `last_result` in config\n\n### _cai_update_dockerd_bundle()\n1. Check latest version from Docker index\n2. Compare to installed version from VERSION file\n3. If newer \u2192 download, extract, replace bundle\n4. Requires `--force` if containai-docker service is running\n\n## Key context\n\n- Use epoch seconds for timestamp comparison (portable)\n- Use `date -Iseconds` for RFC3339 output (GNU date)\n- Warning format per spec: yellow, emphasize security for dockerd\n## Acceptance\n- [ ] `_cai_update_check` function added\n- [ ] Reads check_interval from config.toml\n- [ ] Honors CAI_UPDATE_CHECK_INTERVAL env var\n- [ ] Rate-limits by comparing last_checked timestamp\n- [ ] Checks ContainAI version via GitHub API\n- [ ] Checks dockerd version via Docker index\n- [ ] Network failure doesn't block (advances timestamp)\n- [ ] Yellow warning displayed when updates available\n- [ ] **Dockerd warning includes \"will stop running containers\"**\n- [ ] `_cai_update_dockerd_bundle` function added\n- [ ] Prompts before updating (unless --force)\n- [ ] Downloads to versioned directory\n- [ ] Updates symlinks atomically with ln -sfn\n- [ ] Restarts containai-docker.service after update\n- [ ] Keeps only current + previous version\n- [ ] shellcheck passes\n## Done summary\nTBD\n\n## Evidence\n- Commits:\n- Tests:\n- PRs:\n"
    },
    {
      "data": {
        "assignee": null,
        "claim_note": "",
        "claimed_at": null,
        "created_at": "2026-01-24T20:23:36.600392Z",
        "depends_on": [
          "fn-15-281.3"
        ],
        "epic": "fn-15-281",
        "id": "fn-15-281.4",
        "priority": null,
        "spec_path": ".flow/tasks/fn-15-281.4.md",
        "status": "todo",
        "title": "Wire update check into containai.sh command dispatch",
        "updated_at": "2026-01-24T20:24:21.305740Z"
      },
      "id": "fn-15-281.4",
      "runtime": null,
      "spec": "# fn-15-281.4 Wire update check into containai.sh command dispatch\n\n## Description\nWire the update check into the main CLI entry point before command dispatch.\n\n**Size:** S\n**Files:** `src/containai.sh`\n\n## Approach\n\nAdd call to `_cai_update_check` early in the main function, before command dispatch.\n\nShould run:\n- Before every `cai` command\n- After library sourcing is complete\n- Before any actual work begins\n\nSkip if:\n- Running in CI environment (`CI=true`, `GITHUB_ACTIONS`, `JENKINS_URL`)\n- `CAI_UPDATE_CHECK_INTERVAL=never`\n## Acceptance\n- [ ] `_cai_update_check` called before command dispatch\n- [ ] Skipped in CI environments\n- [ ] Skipped when interval=never\n- [ ] Does not affect command execution timing significantly\n- [ ] shellcheck passes\n## Done summary\nTBD\n\n## Evidence\n- Commits:\n- Tests:\n- PRs:\n"
    },
    {
      "data": {
        "assignee": null,
        "claim_note": "",
        "claimed_at": null,
        "created_at": "2026-01-24T20:23:36.668022Z",
        "depends_on": [
          "fn-15-281.2",
          "fn-15-281.3",
          "fn-15-281.4"
        ],
        "epic": "fn-15-281",
        "id": "fn-15-281.5",
        "priority": null,
        "spec_path": ".flow/tasks/fn-15-281.5.md",
        "status": "todo",
        "title": "Update documentation for managed dockerd bundle",
        "updated_at": "2026-01-24T20:31:56.394219Z"
      },
      "id": "fn-15-281.5",
      "runtime": null,
      "spec": "# fn-15-281.5 Update documentation for managed dockerd bundle\n\n## Description\nUpdate documentation to cover the managed dockerd bundle feature with versioned directories.\n\n**Size:** S\n**Files:** `docs/setup-guide.md`, `docs/troubleshooting.md`\n\n## Approach\n\n### docs/setup-guide.md\nAdd section \"ContainAI-managed dockerd bundle\" covering:\n- Bundle is installed automatically during setup (Linux/WSL2)\n- Versioned structure: `/opt/containai/docker/<version>/`\n- Stable symlinks: `/opt/containai/bin/`\n- Updates via `cai update` (atomic via symlink swap)\n- No fallback to system Docker\n\n### docs/troubleshooting.md\nAdd entry for \"Updates available\" warning:\n- What the warning means\n- How to apply updates: `cai update`\n- **Note that dockerd updates will restart containers**\n- How to disable checks: `CAI_UPDATE_CHECK_INTERVAL=never`\n## Approach\n\n### docs/setup-guide.md\nAdd section \"ContainAI-managed dockerd bundle\" covering:\n- Bundle is installed automatically during setup (Linux/WSL2)\n- Location: /opt/containai/docker/\n- Updates via `cai update`\n- No fallback to system Docker\n\n### docs/troubleshooting.md\nAdd entry for \"Updates available\" warning:\n- What the warning means\n- How to apply updates: `cai update`\n- How to disable checks: `CAI_UPDATE_CHECK_INTERVAL=never`\n## Acceptance\n- [ ] setup-guide.md has \"ContainAI-managed dockerd bundle\" section\n- [ ] Documents versioned directory structure\n- [ ] Documents symlink-based atomic updates\n- [ ] troubleshooting.md has \"Updates available\" entry\n- [ ] Documents that dockerd updates restart containers\n- [ ] Documents how to run `cai update`\n- [ ] Documents how to disable update checks\n## Done summary\nTBD\n\n## Evidence\n- Commits:\n- Tests:\n- PRs:\n"
    }
  ]
}
