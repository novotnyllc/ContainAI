{
  "created_at": "2026-01-19T04:57:08.017928Z",
  "epic": {
    "data": {
      "branch_name": "fn-5-urz",
      "created_at": "2026-01-18T23:55:01.553051Z",
      "depends_on_epics": [],
      "id": "fn-5-urz",
      "next_task": 1,
      "plan_review_status": "ship",
      "plan_reviewed_at": "2026-01-19T00:04:20.135532Z",
      "spec_path": ".flow/specs/fn-5-urz.md",
      "status": "open",
      "title": "ContainAI Secure Sandboxed Agent Runtime",
      "updated_at": "2026-01-19T04:52:24.667456Z"
    },
    "spec": "# ContainAI Secure Sandboxed Agent Runtime\n\n## Overview\n\nImplement a secure CLI wrapper for running AI coding agents (Claude Code, Gemini CLI) in Docker Sandboxes with defense-in-depth isolation. The runtime enforces safe defaults (no host Docker socket, no host credentials) and provides Sysbox-based enhanced isolation for users who want maximum security.\n\n## Requirements Hierarchy\n\n| Requirement | Level | Behavior |\n|-------------|-------|----------|\n| Docker Sandbox | **Hard requirement** | `cai run` fails if Docker sandbox not available |\n| Sysbox | **Very strong suggestion** | Show prominent warning if not available; `--force` bypasses on WSL |\n\n## Scope\n\n### In Scope\n- `cai doctor` - capability detection and remediation guidance\n- `cai setup` - Sysbox installation for Linux, WSL2, and macOS\n- `cai run` - sandbox-first agent execution wrapper\n- `cai sandbox reset` / `clear-credentials` - sandbox management\n- Safe defaults with explicit unsafe opt-ins\n- ECI detection and validation\n- Sysbox + userns-remap (where supported)\n- TOML configuration (`.containai/config.toml`)\n- **WSL2 Sysbox with `--force` bypass and warnings**\n- **WSL2 networking mode detection (mirror vs NAT)**\n- **Dockerfile updates for testing with dockerd + Sysbox**\n\n### Out of Scope\n- Windows native (PowerShell) - WSL only\n- Docker-in-Docker as default (optional via `--enable-nested-docker`)\n- Enterprise Settings Management integration\n\n## Platform Support Matrix\n\n| Platform | Docker Sandbox | Sysbox | Notes |\n|----------|---------------|--------|-------|\n| Linux (native) | \u2713 | \u2713 | Full support via `cai setup` |\n| WSL2 | \u2713 | \u26a0\ufe0f | Sysbox works but seccomp issues on WSL 1.1.0+; use `--force` to bypass warning |\n| macOS | \u2713 | \u2713 | Via Lima VM, never interferes with Docker Desktop |\n| Windows (native) | \u2717 | \u2717 | Use WSL2 |\n\n## `cai setup` Command\n\n**Purpose:** Install and configure Sysbox for the current platform.\n\n### Usage\n```bash\ncai setup [--force] [--dry-run] [--verbose]\n```\n\n### Flags\n| Flag | Description |\n|------|-------------|\n| `--force` | Bypass Sysbox installation warnings on WSL2 |\n| `--dry-run` | Show what would be installed without making changes |\n| `--verbose` | Show detailed progress output |\n\n### Platform-Specific Behavior\n\n**Linux (native):**\n1. Detect distribution (Ubuntu, Debian, Fedora)\n2. Download and install Sysbox package\n3. Configure `/etc/docker/daemon.json` with `sysbox-runc` runtime\n4. Create `containai-secure` Docker context\n5. Verify installation\n\n**WSL2:**\n1. Detect WSL2 via `/proc/version` containing \"microsoft-standard\"\n2. Detect networking mode (mirror vs NAT) via test or `/proc/sys/net/ipv4/ip_forward` check\n3. Test seccomp compatibility (WSL 1.1.0+ has seccomp on PID 1 causing EBUSY)\n4. If seccomp test fails:\n   - Show **big warning** explaining Sysbox may not work\n   - Explain sandbox will still work (hard requirement met)\n   - Require `--force` to proceed with Sysbox installation\n5. If `--force` or seccomp passes: proceed with Sysbox installation\n6. Create `containai-secure` context pointing to Sysbox-enabled daemon\n\n**macOS:**\n1. Check if Lima is installed (install via Homebrew if not)\n2. Create Lima VM with Ubuntu and Sysbox\n3. Expose Docker socket from Lima VM\n4. Create `containai-secure` context pointing to Lima socket\n5. **CRITICAL: Never modify Docker Desktop configuration**\n\n### Docker Desktop Protection\n\n**NEVER interfere with Docker Desktop:**\n- Always create a separate `containai-secure` context\n- Never modify Docker Desktop's `daemon.json`\n- Never change the `default` or `desktop-linux` contexts\n- Docker Desktop must remain the default context\n- All Sysbox operations use explicit `--context containai-secure`\n\n## WSL2 Detection and Compatibility\n\n### Platform Detection\n```bash\ndetect_platform() {\n    if grep -qi \"microsoft-standard\" /proc/version 2>/dev/null; then\n        echo \"wsl2\"\n    elif [[ -n \"${WSL_DISTRO_NAME:-}\" ]]; then\n        echo \"wsl2\"\n    elif [[ \"$(uname -s)\" == \"Darwin\" ]]; then\n        echo \"macos\"\n    else\n        echo \"linux\"\n    fi\n}\n```\n\n### WSL2 Seccomp Compatibility Test\n```bash\ntest_wsl2_seccomp() {\n    # WSL 1.1.0+ has seccomp filter on PID 1, causing EBUSY\n    # when Sysbox tries to install its own seccomp-notify filter\n    # Test by checking if we can create a minimal seccomp filter\n    # Returns 0 if compatible, 1 if not\n}\n```\n\n### Warning Message (WSL2)\n```\n\u2554\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2557\n\u2551                         \u26a0\ufe0f  WARNING                              \u2551\n\u2560\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2563\n\u2551 Sysbox on WSL2 may not work due to seccomp filter conflicts.    \u2551\n\u2551                                                                  \u2551\n\u2551 Your WSL version (1.1.0+) has a seccomp filter on PID 1 that    \u2551\n\u2551 conflicts with Sysbox's seccomp-notify mechanism.               \u2551\n\u2551                                                                  \u2551\n\u2551 Docker Sandbox will still work (this is the hard requirement).  \u2551\n\u2551 Sysbox provides additional isolation but is optional.           \u2551\n\u2551                                                                  \u2551\n\u2551 To proceed anyway, run: cai setup --force                       \u2551\n\u2551 To downgrade WSL: wsl --update --web-download --version 1.0.3   \u2551\n\u255a\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u255d\n```\n\n## Approach\n\n### Phase 1: Core Infrastructure (Tasks 1-3)\n1. Spike: Validate `docker sandbox` + `--context` interaction (blocker for Secure Engine)\n2. Implement shell library structure (`containai.sh`, `lib/*.sh`)\n3. TOML config parser (`parse-toml.py`)\n\n### Phase 2: Doctor & Decision Engine (Tasks 4-6)\n4. Docker Desktop + Sandboxes availability detection\n5. ECI detection (uid_map + runtime check)\n6. Decision engine + formatted output with requirements hierarchy\n\n### Phase 3: Sandbox Launcher (Tasks 7-9)\n7. `cai run` with safe defaults\n8. Context auto-selection (ECI vs Secure Engine)\n9. Unsafe opt-ins with acknowledgements\n\n### Phase 4: Setup Command (Tasks 10-12)\n10. `cai setup` - Linux native Sysbox installation\n11. `cai setup` - WSL2 with seccomp detection and `--force` bypass\n12. `cai setup` - macOS Lima VM provisioning\n\n### Phase 5: Validation & Testing (Tasks 13-15)\n13. Secure Engine runtime validation + integration tests\n14. Dockerfile updates for testing with dockerd + Sysbox\n15. `cai sandbox reset` and `cai sandbox clear-credentials` commands\n\n## Testing Strategy\n\n### In-Container Testing\nSince we're running in a container with Sysbox and dockerd installed:\n- Build/test images directly inside the container\n- Use `containai-test` context for Sysbox-enabled dockerd\n- Never share context with host Docker Desktop\n\n### Dockerfile for Testing\n```dockerfile\n# Test container with dockerd + Sysbox\nFROM ubuntu:24.04\nRUN apt-get update && apt-get install -y docker.io\n# Install Sysbox\nRUN wget -O sysbox.deb https://downloads.nestybox.com/sysbox/releases/v0.6.7/sysbox-ce_0.6.7-0.linux_amd64.deb \\\n    && apt-get install -y ./sysbox.deb\n# Configure Sysbox as available runtime (NOT default)\nRUN echo '{\"runtimes\": {\"sysbox-runc\": {\"path\": \"/usr/bin/sysbox-runc\"}}}' > /etc/docker/daemon.json\n# Start dockerd with explicit socket\nCMD [\"dockerd\", \"-H\", \"unix:///var/run/docker-test.sock\"]\n```\n\n## Risks & Mitigations\n\n| Risk | Impact | Mitigation |\n|------|--------|------------|\n| WSL2 seccomp conflict | Sysbox fails on WSL 1.1.0+ | Detect and warn; sandbox still works; `--force` bypass |\n| `docker sandbox` ignores `--context` | Secure Engine architecture invalid | Task 1 spike validates; fall back to ECI-only |\n| Docker Desktop interference | Users lose Docker Desktop config | Never touch default context; explicit `containai-secure` context |\n| Lima + Sysbox on ARM64 | macOS Apple Silicon blocked | Document limitations if unsupported |\n\n## Quick Commands\n\n```bash\n# After implementation, verify with:\ncai doctor                              # Detect Docker Desktop 4.50+, sandbox, Sysbox\ncai setup                               # Install Sysbox for current platform\ncai setup --force                       # Force Sysbox install on WSL2 despite warnings\ncai run --agent claude --workspace .    # Run Claude in sandbox with safe defaults\ndocker --context containai-secure info  # Verify Sysbox context (should show sysbox-runc)\n```\n\n## Acceptance Criteria\n\n1. [ ] `cai doctor` detects Docker Desktop version, sandbox availability, and Sysbox status\n2. [ ] `cai doctor` shows Docker sandbox as \"required\" and Sysbox as \"strongly recommended\"\n3. [ ] `cai run` always uses `docker sandbox run` (never `docker run`)\n4. [ ] Default runs have `--credentials=none` and no `--mount-docker-socket`\n5. [ ] `cai setup` installs Sysbox on Linux, WSL2 (with warnings), and macOS (via Lima)\n6. [ ] WSL2 `cai setup` shows big warning about seccomp conflicts and requires `--force`\n7. [ ] `cai setup` creates `containai-secure` context without modifying Docker Desktop\n8. [ ] Docker Desktop remains the default context after `cai setup`\n9. [ ] `cai sandbox reset` removes sandbox for config changes to take effect\n10. [ ] All shell functions use `local` for loop variables\n11. [ ] Uses `command -v` instead of `which` for portability\n\n## References\n\n- Existing implementation: `agent-sandbox/aliases.sh`\n- Docker Sandboxes: https://docs.docker.com/ai/sandboxes/\n- Docker ECI: https://docs.docker.com/enterprise/security/hardened-desktop/enhanced-container-isolation/\n- Sysbox: https://github.com/nestybox/sysbox\n- Sysbox WSL2 issue #32 (CLOSED - completed June 2025)\n- Lima: https://github.com/lima-vm/lima\n- WSL seccomp issue: https://github.com/microsoft/WSL/issues/9548\n"
  },
  "epic_id": "fn-5-urz",
  "schema_version": 1,
  "tasks": [
    {
      "data": {
        "assignee": null,
        "claim_note": "",
        "claimed_at": null,
        "created_at": "2026-01-18T23:55:50.979172Z",
        "depends_on": [],
        "epic": "fn-5-urz",
        "id": "fn-5-urz.1",
        "priority": null,
        "spec_path": ".flow/tasks/fn-5-urz.1.md",
        "status": "todo",
        "title": "Spike: Validate docker sandbox + context interaction",
        "updated_at": "2026-01-18T23:56:53.166114Z"
      },
      "id": "fn-5-urz.1",
      "spec": "# fn-5-urz.1 Spike: Validate docker sandbox + context interaction\n\n## Description\n## Overview\n\nValidate whether `docker sandbox run` respects Docker context selection (`--context` flag or `DOCKER_CONTEXT` env var). This is a **blocking spike** - if sandboxes ignore context, the Secure Engine architecture is invalid.\n\n## What to Test\n\n1. Create a test Docker context pointing to an alternate endpoint (or mock)\n2. Run `docker --context <test-context> sandbox run claude` \n3. Observe which Docker daemon receives the request\n4. Test with `DOCKER_CONTEXT=<test-context> docker sandbox run claude`\n\n## Expected Outcomes\n\n- **Context works**: Proceed with Secure Engine tasks (fn-5-urz.10, fn-5-urz.11)\n- **Context ignored**: Document limitation, revise PRD to ECI-only path for isolation\n\n## Reuse\n\n- None (greenfield spike)\n\n## References\n\n- PRD open question #1: `.flow/specs/sysbox.md` line ~390\n- Docker contexts: https://docs.docker.com/engine/manage-resources/contexts/\n## Acceptance\n- [ ] Spike document created with test methodology\n- [ ] Tests executed on Docker Desktop 4.50+ with sandboxes enabled\n- [ ] Results documented: context respected (yes/no)\n- [ ] If no: PRD updated with ECI-only fallback recommendation\n- [ ] Epic fn-5-urz updated with findings\n## Done summary\nTBD\n\n## Evidence\n- Commits:\n- Tests:\n- PRs:\n"
    },
    {
      "data": {
        "assignee": null,
        "claim_note": "",
        "claimed_at": null,
        "created_at": "2026-01-18T23:55:54.055852Z",
        "depends_on": [
          "fn-5-urz.1"
        ],
        "epic": "fn-5-urz",
        "id": "fn-5-urz.10",
        "priority": null,
        "spec_path": ".flow/tasks/fn-5-urz.10.md",
        "status": "todo",
        "title": "WSL Secure Engine provisioning",
        "updated_at": "2026-01-19T04:53:11.673582Z"
      },
      "id": "fn-5-urz.10",
      "spec": "# fn-5-urz.10 WSL Secure Engine provisioning\n\n## Description\n## Overview\n\nImplement `cai setup` for WSL2 environments with seccomp compatibility detection and `--force` bypass for warnings.\n\n**KEY CHANGE FROM ORIGINAL**: Sysbox WSL2 issue #32 was CLOSED as completed (June 2025). WSL2 support exists but has caveats around seccomp filters on WSL 1.1.0+.\n\n## Command\n\n```bash\ncai setup [--force] [--dry-run] [--verbose]\n```\n\n## What It Does\n\n1. **Detect WSL2 environment**\n   ```bash\n   if grep -qi \"microsoft-standard\" /proc/version 2>/dev/null; then\n       platform=\"wsl2\"\n   fi\n   ```\n\n2. **Test seccomp compatibility** (WSL 1.1.0+ has seccomp on PID 1)\n   ```bash\n   _cai_test_wsl2_seccomp() {\n       # WSL 1.1.0+ attaches seccomp filter to PID 1\n       # This causes EBUSY when Sysbox tries to add seccomp-notify\n       # Test by attempting to create a minimal seccomp container\n       local result\n       result=$(docker run --rm --security-opt seccomp=unconfined alpine echo ok 2>&1)\n       # If this works but sysbox fails, seccomp conflict exists\n   }\n   ```\n\n3. **If seccomp test fails and no `--force`:**\n   - Show **big warning** (see below)\n   - Exit with code 1 (not 0)\n   - User must run with `--force` to proceed\n\n4. **If `--force` or seccomp passes:**\n   - Install Sysbox package\n   - Configure `/etc/docker/daemon.json` with `sysbox-runc` runtime\n   - Create `containai-secure` Docker context\n   - Verify installation\n\n## Big Warning Message\n\n```\n\u2554\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2557\n\u2551                         \u26a0\ufe0f  WARNING                              \u2551\n\u2560\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2563\n\u2551 Sysbox on WSL2 may not work due to seccomp filter conflicts.    \u2551\n\u2551                                                                  \u2551\n\u2551 Your WSL version (1.1.0+) has a seccomp filter on PID 1 that    \u2551\n\u2551 conflicts with Sysbox's seccomp-notify mechanism.               \u2551\n\u2551                                                                  \u2551\n\u2551 Docker Sandbox will still work (this is the hard requirement).  \u2551\n\u2551 Sysbox provides additional isolation but is optional.           \u2551\n\u2551                                                                  \u2551\n\u2551 Options:                                                         \u2551\n\u2551   1. Proceed anyway: cai setup --force                          \u2551\n\u2551   2. Downgrade WSL:  wsl --update --web-download --version 1.0.3\u2551\n\u2551   3. Skip Sysbox:    Use Docker Sandbox without Sysbox          \u2551\n\u255a\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u255d\n```\n\n## Docker Desktop Protection\n\n**CRITICAL: NEVER interfere with Docker Desktop**\n\n- Create `containai-secure` context pointing to separate socket\n- NEVER modify the `default` or `desktop-linux` contexts\n- NEVER touch Docker Desktop's daemon.json\n- All Sysbox operations use explicit `--context containai-secure`\n\n## WSL-Specific Configuration\n\n```json\n// /etc/docker/daemon.json (WSL distro, NOT Docker Desktop)\n{\n  \"runtimes\": {\n    \"sysbox-runc\": {\n      \"path\": \"/usr/bin/sysbox-runc\"\n    }\n  }\n}\n```\n\nNote: Do NOT set `default-runtime` to Sysbox - keep runc as default.\n\n## Context Creation\n\n```bash\ndocker context create containai-secure \\\n  --docker \"host=unix:///var/run/docker-containai.sock\"\n```\n\n## Depends On\n\n- Task 1 spike confirms `docker sandbox` respects context\n\n## References\n\n- Sysbox WSL2 issue #32 (CLOSED - completed June 2025)\n- WSL seccomp issue: https://github.com/microsoft/WSL/issues/9548\n- Docker userns-remap: https://docs.docker.com/engine/security/userns-remap/\n## Overview\n\nImplement `containai install secure-engine` for WSL environments.\n\n**CRITICAL BLOCKER**: Sysbox does NOT officially support WSL2. This task must determine a viable path:\n1. Use unofficial Sysbox on WSL2 (community workarounds exist)\n2. Use alternative isolation (gVisor, userns-remap only)\n3. Document as unsupported, recommend Docker Business + ECI\n\n## Command\n\n```bash\ncontainai install secure-engine\n```\n\n## What It Does (if viable)\n\n1. Detect WSL distro and version\n2. Install Docker Engine (separate from Docker Desktop integration)\n3. Install Sysbox runtime (if supported) OR alternative\n4. Configure daemon.json:\n   - `default-runtime: \"sysbox-runc\"` (or alternative)\n   - `userns-remap: \"default\"`\n   - Optional seccomp profile\n5. Create Docker context `containai-secure`\n6. Verify installation\n\n## WSL-Specific Configuration\n\n```json\n// /etc/docker/daemon.json in Secure Engine distro\n{\n  \"default-runtime\": \"sysbox-runc\",\n  \"userns-remap\": \"default\",\n  \"runtimes\": {\n    \"sysbox-runc\": {\n      \"path\": \"/usr/bin/sysbox-runc\"\n    }\n  }\n}\n```\n\n## Context Creation\n\n```bash\ndocker context create containai-secure \\\n  --docker \"host=unix:///path/to/secure/docker.sock\"\n```\n\n## Depends On\n\n- Task 1 spike confirms `docker sandbox` respects context\n- Research on Sysbox WSL2 viability (GitHub issue #32)\n\n## References\n\n- Sysbox WSL2 issue: https://github.com/nestybox/sysbox/issues/32\n- Docker userns-remap: https://docs.docker.com/engine/security/userns-remap/\n## Acceptance\n- [ ] Detects WSL2 environment correctly via `/proc/version`\n- [ ] Tests seccomp compatibility before Sysbox installation\n- [ ] Shows big warning if seccomp test fails\n- [ ] Requires `--force` flag to proceed when seccomp test fails\n- [ ] `--force` proceeds with Sysbox installation despite warning\n- [ ] Without `--force`, exits with message about Docker Sandbox still working\n- [ ] Installs Sysbox package correctly\n- [ ] Configures daemon.json with sysbox-runc runtime (NOT as default)\n- [ ] Creates `containai-secure` Docker context\n- [ ] Does NOT modify Docker Desktop or default context\n- [ ] Does NOT set sysbox-runc as default runtime\n- [ ] Provides clear output during installation\n- [ ] `--dry-run` shows what would be done without changes\n## Done summary\nTBD\n\n## Evidence\n- Commits:\n- Tests:\n- PRs:\n"
    },
    {
      "data": {
        "assignee": null,
        "claim_note": "",
        "claimed_at": null,
        "created_at": "2026-01-18T23:55:54.206128Z",
        "depends_on": [
          "fn-5-urz.1"
        ],
        "epic": "fn-5-urz",
        "id": "fn-5-urz.11",
        "priority": null,
        "spec_path": ".flow/tasks/fn-5-urz.11.md",
        "status": "todo",
        "title": "macOS Lima VM Secure Engine provisioning",
        "updated_at": "2026-01-19T04:53:40.523779Z"
      },
      "id": "fn-5-urz.11",
      "spec": "# fn-5-urz.11 macOS Lima VM Secure Engine provisioning\n\n## Description\n## Overview\n\nImplement `cai setup` for macOS using Lima VM with Sysbox.\n\n**CRITICAL: NEVER interfere with Docker Desktop** - Docker Desktop must remain the default and unchanged.\n\n## Command\n\n```bash\ncai setup [--force] [--dry-run] [--verbose]\n```\n\n## What It Does\n\n1. **Detect macOS environment**\n   ```bash\n   if [[ \"$(uname -s)\" == \"Darwin\" ]]; then\n       platform=\"macos\"\n   fi\n   ```\n\n2. **Check Lima installation**\n   ```bash\n   if ! command -v limactl >/dev/null 2>&1; then\n       echo \"[INFO] Lima not found. Installing via Homebrew...\"\n       brew install lima\n   fi\n   ```\n\n3. **Create Lima VM with Docker + Sysbox**\n   - Use Ubuntu 24.04 base image\n   - Install Docker Engine inside VM\n   - Install Sysbox inside VM\n   - Configure daemon.json with sysbox-runc runtime\n   - Expose Docker socket to macOS host\n\n4. **Create Docker context**\n   ```bash\n   docker context create containai-secure \\\n     --docker \"host=unix://$HOME/.lima/containai-secure/sock/docker.sock\"\n   ```\n\n5. **Docker Desktop Protection**\n   - NEVER modify Docker Desktop settings\n   - NEVER change the default context\n   - NEVER touch `~/.docker/daemon.json` on macOS\n   - All operations use explicit `containai-secure` context\n\n## Lima VM Template\n\n```yaml\n# ~/.lima/containai-secure/lima.yaml\nimages:\n  - location: \"https://cloud-images.ubuntu.com/releases/24.04/release/ubuntu-24.04-server-cloudimg-amd64.img\"\n    arch: \"x86_64\"\n  - location: \"https://cloud-images.ubuntu.com/releases/24.04/release/ubuntu-24.04-server-cloudimg-arm64.img\"\n    arch: \"aarch64\"\n\nmounts:\n  - location: \"~\"\n    writable: true\n  - location: \"/tmp/lima\"\n    writable: true\n\nprovision:\n  - mode: system\n    script: |\n      #!/bin/bash\n      set -eux\n      \n      # Install Docker\n      curl -fsSL https://get.docker.com | sh\n      usermod -aG docker \"${LIMA_CIDATA_USER}\"\n      \n      # Install Sysbox (x86_64 or arm64)\n      ARCH=$(dpkg --print-architecture)\n      wget -O /tmp/sysbox.deb \"https://downloads.nestybox.com/sysbox/releases/v0.6.7/sysbox-ce_0.6.7-0.linux_${ARCH}.deb\"\n      apt-get install -y /tmp/sysbox.deb\n      \n      # Configure Docker with Sysbox runtime (NOT as default)\n      cat > /etc/docker/daemon.json << 'EOF'\n      {\n        \"runtimes\": {\n          \"sysbox-runc\": {\n            \"path\": \"/usr/bin/sysbox-runc\"\n          }\n        }\n      }\n      EOF\n      \n      systemctl restart docker\n\nportForwards:\n  - guestSocket: \"/var/run/docker.sock\"\n    hostSocket: \"{{.Dir}}/sock/docker.sock\"\n```\n\n## ARM64 (Apple Silicon) Handling\n\nSysbox supports ARM64 natively. The Lima template uses architecture-specific images:\n- x86_64: Standard AMD64 image\n- aarch64: ARM64 image (Apple Silicon)\n\n## Context Creation\n\n```bash\ndocker context create containai-secure \\\n  --docker \"host=unix://$HOME/.lima/containai-secure/sock/docker.sock\"\n```\n\n## Verification\n\n```bash\n# Verify Lima VM is running\nlimactl list\n\n# Verify Sysbox is available via containai-secure context\ndocker --context containai-secure info | grep -i sysbox\n\n# Verify Docker Desktop is still default\ndocker context ls  # default or desktop-linux should be active\n```\n\n## References\n\n- Lima: https://github.com/lima-vm/lima\n- Lima Docker example: https://lima-vm.io/docs/examples/containers/docker/\n- Sysbox ARM64: https://github.com/nestybox/sysbox/releases\n## Overview\n\nImplement `containai install secure-engine` for macOS using Lima VM.\n\n## Approach\n\nDocker Sandboxes requires Docker Desktop for the `docker sandbox` CLI plugin. The Secure Engine provides additional isolation via a Lima VM running:\n- Docker Engine with Sysbox\n- User namespace remapping\n- Optional seccomp profile\n\n## What It Does\n\n1. Check Lima is installed (or install via Homebrew)\n2. Create Lima VM with Docker + Sysbox configuration\n3. Configure daemon.json in VM\n4. Expose Docker socket to macOS host\n5. Create Docker context `containai-secure`\n\n## Lima VM Template\n\n```yaml\n# containai-secure.yaml\nimages:\n  - location: \"https://cloud-images.ubuntu.com/releases/22.04/release/ubuntu-22.04-server-cloudimg-amd64.img\"\n    arch: \"x86_64\"\n\nmounts:\n  - location: \"~\"\n    writable: true\n\nprovision:\n  - mode: system\n    script: |\n      # Install Docker\n      curl -fsSL https://get.docker.com | sh\n      \n      # Install Sysbox (x86_64 only for now)\n      # ... sysbox installation\n      \n      # Configure daemon\n      cat > /etc/docker/daemon.json << 'EOF'\n      {\n        \"default-runtime\": \"sysbox-runc\",\n        \"userns-remap\": \"default\"\n      }\n      EOF\n      \n      systemctl restart docker\n```\n\n## ARM64 (Apple Silicon) Consideration\n\nSysbox is primarily x86_64. ARM64 support is limited. Options:\n1. Use Rosetta 2 emulation in Lima\n2. Fall back to userns-remap only (no Sysbox)\n3. Document as x86_64 only\n\n## Context Creation\n\n```bash\ndocker context create containai-secure \\\n  --docker \"host=unix://$HOME/.lima/containai-secure/sock/docker.sock\"\n```\n\n## References\n\n- Lima: https://github.com/lima-vm/lima\n- Lima Docker example: https://lima-vm.io/docs/examples/containers/docker/\n## Acceptance\n- [ ] Detects macOS environment correctly\n- [ ] Installs Lima via Homebrew if not present (or prompts)\n- [ ] Creates Lima VM named `containai-secure`\n- [ ] Lima VM has Docker + Sysbox installed\n- [ ] Sysbox is NOT set as default runtime in VM\n- [ ] Creates `containai-secure` Docker context\n- [ ] Socket path is correct for Lima (`~/.lima/containai-secure/sock/docker.sock`)\n- [ ] Works on both Intel and Apple Silicon Macs\n- [ ] Does NOT interfere with Docker Desktop\n- [ ] Does NOT modify default or desktop-linux context\n- [ ] Docker Desktop remains the active/default context after setup\n- [ ] VM can be started/stopped via `limactl start/stop containai-secure`\n- [ ] `--dry-run` shows what would be done without changes\n## Done summary\nTBD\n\n## Evidence\n- Commits:\n- Tests:\n- PRs:\n"
    },
    {
      "data": {
        "assignee": null,
        "claim_note": "",
        "claimed_at": null,
        "created_at": "2026-01-18T23:55:54.356908Z",
        "depends_on": [
          "fn-5-urz.10",
          "fn-5-urz.11"
        ],
        "epic": "fn-5-urz",
        "id": "fn-5-urz.12",
        "priority": null,
        "spec_path": ".flow/tasks/fn-5-urz.12.md",
        "status": "todo",
        "title": "Secure Engine runtime validation + integration tests",
        "updated_at": "2026-01-18T23:59:04.708359Z"
      },
      "id": "fn-5-urz.12",
      "spec": "# fn-5-urz.12 Secure Engine runtime validation + integration tests\n\n## Description\n## Overview\n\nImplement runtime validation for Secure Engine and comprehensive integration tests.\n\n## Validation Functions\n\n### _cai_secure_engine_validate()\n```bash\n# Verify Secure Engine is correctly configured\n# 1. Context exists\ndocker context inspect containai-secure\n\n# 2. Engine is reachable\ndocker --context containai-secure info\n\n# 3. Runtime is sysbox-runc (or configured alternative)\ndocker --context containai-secure info --format '{{.DefaultRuntime}}'\n\n# 4. User namespace is enabled\ndocker --context containai-secure run --rm alpine cat /proc/self/uid_map\n# Should show mapped UIDs, not \"0 0 4294967295\"\n\n# 5. Test container starts successfully\ndocker --context containai-secure run --rm hello-world\n```\n\n## Integration Tests\n\nCreate `test-secure-engine.sh`:\n\n```bash\n#!/usr/bin/env bash\nset -euo pipefail\n\nsection \"Test 1: Context exists\"\ndocker context inspect containai-secure || fail \"Context not found\"\npass \"Context exists\"\n\nsection \"Test 2: Engine reachable\"\ndocker --context containai-secure info || fail \"Engine not reachable\"\npass \"Engine reachable\"\n\nsection \"Test 3: Runtime is sysbox-runc\"\nruntime=$(docker --context containai-secure info --format '{{.DefaultRuntime}}')\n[[ \"$runtime\" == \"sysbox-runc\" ]] || fail \"Expected sysbox-runc, got $runtime\"\npass \"Runtime correct\"\n\nsection \"Test 4: User namespace enabled\"\nuid_map=$(docker --context containai-secure run --rm alpine cat /proc/self/uid_map)\n[[ \"$uid_map\" != *\"0 0 4294967295\"* ]] || fail \"User namespace not enabled\"\npass \"User namespace enabled\"\n\nsection \"Test 5: Sandbox runs on Secure Engine\"\n# This depends on Task 1 spike result\ndocker --context containai-secure sandbox run --help || warn \"Sandbox may not support context\"\n```\n\n## Platform-Specific Tests\n\n- WSL: Verify socket path, distro isolation\n- macOS: Verify Lima VM status, socket path\n\n## Reuse\n\n- `test-sync-integration.sh` - test pattern with `section()`, `pass()`, `fail()`\n## Acceptance\n- [ ] `_cai_secure_engine_validate()` checks all 5 validation points\n- [ ] Returns clear pass/fail status for each check\n- [ ] `test-secure-engine.sh` runs all integration tests\n- [ ] Tests work on WSL (if Secure Engine supported)\n- [ ] Tests work on macOS with Lima\n- [ ] Tests are idempotent (can run multiple times)\n- [ ] Failed tests provide actionable remediation\n## Done summary\nTBD\n\n## Evidence\n- Commits:\n- Tests:\n- PRs:\n"
    },
    {
      "data": {
        "assignee": null,
        "claim_note": "",
        "claimed_at": null,
        "created_at": "2026-01-18T23:55:54.506909Z",
        "depends_on": [
          "fn-5-urz.7"
        ],
        "epic": "fn-5-urz",
        "id": "fn-5-urz.13",
        "priority": null,
        "spec_path": ".flow/tasks/fn-5-urz.13.md",
        "status": "todo",
        "title": "containai sandbox reset command",
        "updated_at": "2026-01-18T23:59:05.374930Z"
      },
      "id": "fn-5-urz.13",
      "spec": "# fn-5-urz.13 containai sandbox reset command\n\n## Description\n## Overview\n\nImplement `containai sandbox reset` to remove the current workspace sandbox so configuration changes can take effect.\n\n## Background\n\nDocker Sandboxes are \"one per workspace\" and configuration changes (env vars, mounts, socket access, credentials mode) require removing and recreating the sandbox.\n\n## Command\n\n```bash\ncontainai sandbox reset [--workspace <path>]\n```\n\n## What It Does\n\n1. Identify sandbox for current/specified workspace\n2. Stop the sandbox if running\n3. Remove the sandbox (`docker sandbox rm`)\n4. Confirm removal\n\n## Implementation\n\n```bash\ncontainai_sandbox_reset() {\n    local workspace=\"${1:-.}\"\n    workspace=$(realpath \"$workspace\")\n    \n    # Find sandbox by workspace\n    local sandbox_id\n    sandbox_id=$(docker sandbox ls --format '{{.ID}} {{.Workspace}}' | \\\n        grep \" ${workspace}$\" | awk '{print $1}')\n    \n    if [[ -z \"$sandbox_id\" ]]; then\n        _cai_info \"No sandbox found for workspace: $workspace\"\n        return 0\n    fi\n    \n    _cai_info \"Removing sandbox $sandbox_id for workspace: $workspace\"\n    docker sandbox rm \"$sandbox_id\"\n    _cai_info \"[OK] Sandbox removed. New config will apply on next run.\"\n}\n```\n\n## Edge Cases\n\n- Sandbox is currently running: stop first, then remove\n- Multiple sandboxes for same workspace (shouldn't happen, but handle gracefully)\n- Workspace path doesn't match exactly (symlinks, relative paths)\n\n## References\n\n- Docker docs: \"config changes require removing/recreating the sandbox\"\n- https://docs.docker.com/ai/sandboxes/advanced-config/\n## Acceptance\n- [ ] Finds sandbox by workspace path\n- [ ] Handles running sandbox (stops first)\n- [ ] Handles no sandbox found (no error, info message)\n- [ ] Works with relative and absolute paths\n- [ ] Resolves symlinks for workspace matching\n- [ ] Confirms successful removal\n- [ ] Does not affect sandboxes for other workspaces\n## Done summary\nTBD\n\n## Evidence\n- Commits:\n- Tests:\n- PRs:\n"
    },
    {
      "data": {
        "assignee": null,
        "claim_note": "",
        "claimed_at": null,
        "created_at": "2026-01-18T23:55:54.657819Z",
        "depends_on": [
          "fn-5-urz.7"
        ],
        "epic": "fn-5-urz",
        "id": "fn-5-urz.14",
        "priority": null,
        "spec_path": ".flow/tasks/fn-5-urz.14.md",
        "status": "todo",
        "title": "containai sandbox clear-credentials command",
        "updated_at": "2026-01-18T23:59:07.770856Z"
      },
      "id": "fn-5-urz.14",
      "spec": "# fn-5-urz.14 containai sandbox clear-credentials command\n\n## Description\n## Overview\n\nImplement `containai sandbox clear-credentials` to remove sandbox credential volumes when needed for troubleshooting.\n\n## Background\n\nPer Docker troubleshooting docs, credential issues may require clearing the sandbox credential storage. This is separate from `sandbox reset` which removes the container but may leave volumes.\n\n## Command\n\n```bash\ncontainai sandbox clear-credentials [--workspace <path>] [--agent claude|gemini]\n```\n\n## What It Does\n\n1. Identify credential volume for the sandbox/agent\n2. Warn user about data loss\n3. Remove the credential volume\n4. Confirm removal\n\n## Implementation\n\n```bash\ncontainai_sandbox_clear_credentials() {\n    local workspace=\"${1:-.}\"\n    local agent=\"${2:-claude}\"\n    \n    workspace=$(realpath \"$workspace\")\n    \n    # Credential volume naming convention (agent-specific)\n    # This may need investigation - Docker docs don't specify exact names\n    local volume_name=\"sandbox-${agent}-credentials\"\n    \n    _cai_warn \"This will remove stored credentials for $agent in $workspace\"\n    _cai_warn \"You may need to re-authenticate after this operation\"\n    \n    # Check if volume exists\n    if ! docker volume inspect \"$volume_name\" >/dev/null 2>&1; then\n        _cai_info \"No credential volume found: $volume_name\"\n        return 0\n    fi\n    \n    # Remove volume\n    docker volume rm \"$volume_name\"\n    _cai_info \"[OK] Credential volume removed\"\n}\n```\n\n## Edge Cases\n\n- Volume in use by running sandbox: refuse with message\n- Volume doesn't exist: no error, info message\n- Multiple agents with different volumes\n\n## References\n\n- Docker troubleshooting: https://docs.docker.com/ai/sandboxes/troubleshooting/\n- May need to inspect actual volume names created by Docker Sandboxes\n## Acceptance\n- [ ] Identifies correct credential volume for agent\n- [ ] Warns user before removing\n- [ ] Handles volume not found gracefully\n- [ ] Refuses if volume in use (sandbox running)\n- [ ] Works for different agents (claude, gemini)\n- [ ] Confirms successful removal\n## Done summary\nTBD\n\n## Evidence\n- Commits:\n- Tests:\n- PRs:\n"
    },
    {
      "data": {
        "assignee": null,
        "claim_note": "",
        "claimed_at": null,
        "created_at": "2026-01-19T04:54:18.163792Z",
        "depends_on": [
          "fn-5-urz.1"
        ],
        "epic": "fn-5-urz",
        "id": "fn-5-urz.15",
        "priority": null,
        "spec_path": ".flow/tasks/fn-5-urz.15.md",
        "status": "todo",
        "title": "cai setup - Linux native Sysbox installation",
        "updated_at": "2026-01-19T04:55:25.974206Z"
      },
      "id": "fn-5-urz.15",
      "spec": "# fn-5-urz.15 cai setup - Linux native Sysbox installation\n\n## Description\n## Overview\n\nImplement `cai setup` for native Linux (non-WSL) environments. This is the simplest path since Sysbox has full support on native Linux.\n\n## Command\n\n```bash\ncai setup [--force] [--dry-run] [--verbose]\n```\n\n## What It Does\n\n1. **Detect native Linux environment**\n   ```bash\n   if [[ \"$(uname -s)\" == \"Linux\" ]] && ! grep -qi \"microsoft\" /proc/version 2>/dev/null; then\n       platform=\"linux\"\n   fi\n   ```\n\n2. **Detect distribution**\n   ```bash\n   if [[ -f /etc/os-release ]]; then\n       . /etc/os-release\n       distro=\"${ID:-unknown}\"\n   fi\n   ```\n\n3. **Install Sysbox package**\n   - Ubuntu/Debian: Download and install `.deb` package\n   - Fedora: Build from source or use alternative\n   - Other: Show instructions\n\n4. **Configure Docker daemon**\n   ```json\n   // /etc/docker/daemon.json\n   {\n     \"runtimes\": {\n       \"sysbox-runc\": {\n         \"path\": \"/usr/bin/sysbox-runc\"\n       }\n     }\n   }\n   ```\n   Note: Do NOT set as default runtime to preserve compatibility.\n\n5. **Create Docker context**\n   ```bash\n   # For systems where Docker Desktop is also installed\n   docker context create containai-secure \\\n     --docker \"host=unix:///var/run/docker.sock\"\n   ```\n\n6. **Verify installation**\n   ```bash\n   docker --context containai-secure run --rm --runtime=sysbox-runc alpine echo \"Sysbox works!\"\n   ```\n\n## Supported Distributions\n\n| Distribution | Package | Min Kernel | Notes |\n|--------------|---------|------------|-------|\n| Ubuntu 24.04 | .deb | 6.8+ | Full support |\n| Ubuntu 22.04 | .deb | 5.15+ | Full support |\n| Debian 12 | .deb | 6.1+ | Full support |\n| Fedora 38+ | Build | 6.0+ | Build from source |\n\n## Docker Desktop Coexistence\n\nOn systems where Docker Desktop is also installed:\n- Detect if Docker Desktop is running\n- Create separate `containai-secure` context\n- Never modify Docker Desktop configuration\n- Warn user about potential conflicts\n\n```bash\n# Check if Docker Desktop is running\nif pgrep -x \"docker-desktop\" >/dev/null || docker context ls | grep -q \"desktop-linux\"; then\n    echo \"[WARN] Docker Desktop detected. Creating separate context.\"\nfi\n```\n\n## References\n\n- Sysbox install: https://github.com/nestybox/sysbox/blob/master/docs/user-guide/install-package.md\n- Sysbox distro compat: https://github.com/nestybox/sysbox/blob/master/docs/distro-compat.md\n## Acceptance\n- [ ] Detects native Linux (not WSL) correctly\n- [ ] Detects distribution (Ubuntu, Debian, Fedora)\n- [ ] Downloads correct Sysbox package for distribution\n- [ ] Installs Sysbox package successfully\n- [ ] Configures daemon.json with sysbox-runc runtime\n- [ ] Does NOT set sysbox-runc as default runtime\n- [ ] Creates `containai-secure` Docker context\n- [ ] Verifies Sysbox works with test container\n- [ ] Detects Docker Desktop if present and warns\n- [ ] Does NOT modify Docker Desktop configuration\n- [ ] `--dry-run` shows what would be done without changes\n- [ ] Handles unsupported distributions gracefully with clear message\n## Done summary\nTBD\n\n## Evidence\n- Commits:\n- Tests:\n- PRs:\n"
    },
    {
      "data": {
        "assignee": null,
        "claim_note": "",
        "claimed_at": null,
        "created_at": "2026-01-19T04:54:24.751859Z",
        "depends_on": [
          "fn-5-urz.1"
        ],
        "epic": "fn-5-urz",
        "id": "fn-5-urz.16",
        "priority": null,
        "spec_path": ".flow/tasks/fn-5-urz.16.md",
        "status": "todo",
        "title": "Dockerfile updates for testing with dockerd + Sysbox",
        "updated_at": "2026-01-19T04:55:26.138360Z"
      },
      "id": "fn-5-urz.16",
      "spec": "# fn-5-urz.16 Dockerfile updates for testing with dockerd + Sysbox\n\n## Description\n## Overview\n\nUpdate the Dockerfile to support testing with dockerd + Sysbox installed. This enables building and testing ContainAI images directly inside a container that has Sysbox configured.\n\n**Key Requirement:** Configure dockerd for a different context. NEVER interfere with Docker Desktop.\n\n## Use Case\n\nWhen running CI or development in a container that itself has Sysbox:\n1. Container has dockerd + Sysbox installed\n2. Tests can build/run ContainAI images directly\n3. No need for external Docker daemon\n4. Isolated from host Docker Desktop\n\n## Dockerfile Changes\n\n```dockerfile\n# agent-sandbox/Dockerfile.test (new file for testing)\nFROM ubuntu:24.04\n\n# Install Docker daemon\nRUN apt-get update && apt-get install -y \\\n    ca-certificates \\\n    curl \\\n    gnupg \\\n    lsb-release \\\n    && curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg \\\n    && echo \"deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable\" > /etc/apt/sources.list.d/docker.list \\\n    && apt-get update \\\n    && apt-get install -y docker-ce docker-ce-cli containerd.io\n\n# Install Sysbox\nARG SYSBOX_VERSION=0.6.7\nRUN ARCH=$(dpkg --print-architecture) \\\n    && wget -O /tmp/sysbox.deb \"https://downloads.nestybox.com/sysbox/releases/v${SYSBOX_VERSION}/sysbox-ce_${SYSBOX_VERSION}-0.linux_${ARCH}.deb\" \\\n    && apt-get install -y /tmp/sysbox.deb \\\n    && rm /tmp/sysbox.deb\n\n# Configure Docker with Sysbox runtime (NOT as default)\n# Use a different socket to avoid conflicts\nRUN mkdir -p /etc/docker\nCOPY <<EOF /etc/docker/daemon.json\n{\n  \"hosts\": [\"unix:///var/run/docker-test.sock\"],\n  \"runtimes\": {\n    \"sysbox-runc\": {\n      \"path\": \"/usr/bin/sysbox-runc\"\n    }\n  }\n}\nEOF\n\n# Create context for test Docker daemon\nENV DOCKER_HOST=unix:///var/run/docker-test.sock\n\n# Startup script\nCOPY <<'EOF' /usr/local/bin/start-test-docker.sh\n#!/bin/bash\nset -e\n# Start Sysbox services\nsysbox-mgr &\nsysbox-fs &\n# Start Docker daemon on test socket\ndockerd -H unix:///var/run/docker-test.sock &\n# Wait for Docker to be ready\nwhile ! docker info >/dev/null 2>&1; do sleep 1; done\necho \"Docker + Sysbox ready on /var/run/docker-test.sock\"\nexec \"$@\"\nEOF\nRUN chmod +x /usr/local/bin/start-test-docker.sh\n\nENTRYPOINT [\"/usr/local/bin/start-test-docker.sh\"]\nCMD [\"bash\"]\n```\n\n## Context Isolation\n\nThe test Dockerfile uses a different socket (`/var/run/docker-test.sock`) to:\n1. Avoid conflicts with any host Docker socket mounted into the container\n2. Allow testing `--context containai-secure` scenarios\n3. Keep test Docker isolated from production Docker\n\n## Usage in CI/Testing\n\n```bash\n# Build test image\ndocker build -t containai-test -f Dockerfile.test .\n\n# Run tests inside the test container\n# The container has its own dockerd + Sysbox\ndocker run --privileged -v $(pwd):/workspace containai-test \\\n    bash -c \"cd /workspace && ./run-tests.sh\"\n\n# Or for interactive testing\ndocker run --privileged -it containai-test\n```\n\n## Integration with Existing Dockerfile\n\nThe main `agent-sandbox/Dockerfile` remains unchanged for production use. This is a separate `Dockerfile.test` for testing purposes only.\n\n## References\n\n- Sysbox DinD: https://github.com/nestybox/sysbox/blob/master/docs/user-guide/dind.md\n- Docker socket configuration: https://docs.docker.com/engine/reference/commandline/dockerd/\n## Acceptance\n- [ ] Creates `Dockerfile.test` (separate from production Dockerfile)\n- [ ] Installs Docker daemon inside container\n- [ ] Installs Sysbox inside container\n- [ ] Configures dockerd with different socket (`/var/run/docker-test.sock`)\n- [ ] Sysbox is available as runtime (NOT default)\n- [ ] Startup script starts Sysbox services and dockerd\n- [ ] Can build images inside the test container\n- [ ] Can run containers with Sysbox inside the test container\n- [ ] Does NOT interfere with any host Docker socket mounted in\n- [ ] Works with `--privileged` flag (required for nested Docker)\n- [ ] Documentation shows how to use in CI/testing\n## Done summary\nTBD\n\n## Evidence\n- Commits:\n- Tests:\n- PRs:\n"
    },
    {
      "data": {
        "assignee": null,
        "claim_note": "",
        "claimed_at": null,
        "created_at": "2026-01-18T23:55:51.135187Z",
        "depends_on": [],
        "epic": "fn-5-urz",
        "id": "fn-5-urz.2",
        "priority": null,
        "spec_path": ".flow/tasks/fn-5-urz.2.md",
        "status": "todo",
        "title": "Implement shell library structure (containai.sh, lib/*.sh)",
        "updated_at": "2026-01-18T23:56:53.835176Z"
      },
      "id": "fn-5-urz.2",
      "spec": "# fn-5-urz.2 Implement shell library structure (containai.sh, lib/*.sh)\n\n## Description\n## Overview\n\nCreate the modular shell library structure that all ContainAI commands will use. Replace the monolithic `aliases.sh` with a clean, sourced library pattern.\n\n## Files to Create\n\n```\nagent-sandbox/\n\u251c\u2500\u2500 containai.sh          # Main entry point (source this)\n\u2514\u2500\u2500 lib/\n    \u251c\u2500\u2500 core.sh           # Logging, error handling, color output\n    \u251c\u2500\u2500 platform.sh       # Platform detection (WSL, macOS, Linux)\n    \u251c\u2500\u2500 docker.sh         # Docker interaction helpers\n    \u2514\u2500\u2500 config.sh         # Config file loading (calls parse-toml.py)\n```\n\n## Implementation Details\n\n### containai.sh\n- Shebang: `#!/usr/bin/env bash`\n- Strict mode: `set -euo pipefail`\n- Source all lib/*.sh files\n- Export public functions: `containai`, `containai_doctor`, `containai_run`, etc.\n\n### lib/core.sh\n- Logging: `_cai_info()`, `_cai_warn()`, `_cai_error()`, `_cai_debug()`\n- Color output: `[OK]`, `[WARN]`, `[ERROR]` markers (per memory convention)\n- All loop variables must be `local` (per memory pitfall)\n\n### lib/platform.sh\n- `_cai_detect_platform()` - returns \"wsl\", \"macos\", \"linux\"\n- WSL detection: check `/proc/sys/fs/binfmt_misc/WSLInterop` or `WSL_DISTRO_NAME`\n- Use `command -v` not `which` (per memory convention)\n\n### lib/docker.sh\n- `_cai_docker_version()` - parse Docker Desktop version\n- `_cai_sandbox_available()` - check `docker sandbox version`\n- Reuse patterns from `aliases.sh:129-228` (`_asb_check_sandbox`)\n\n### lib/config.sh\n- `_cai_load_config()` - load TOML config via parse-toml.py\n- Config paths: `.containai/config.toml` (repo), `~/.config/containai/config.toml` (user)\n- Precedence: CLI flags > env vars > repo config > user config > defaults\n\n## Reuse\n\n- `aliases.sh:91-126` - `_asb_check_isolation()` patterns\n- `aliases.sh:129-228` - `_asb_check_sandbox()` patterns\n- `sync-agent-plugins.sh:107-124` - platform detection patterns\n\n## Naming Convention\n\n- Internal functions: `_cai_*` prefix\n- Public functions: `containai_*` prefix\n- Labels: `containai.sandbox=containai` (replaces `asb.sandbox=agent-sandbox`)\n## Acceptance\n- [ ] `containai.sh` sources all lib/*.sh without errors\n- [ ] `source agent-sandbox/containai.sh` works from any directory\n- [ ] All functions use `local` for loop variables\n- [ ] Uses `command -v` instead of `which`\n- [ ] Status messages use `[OK]`, `[WARN]`, `[ERROR]` format\n- [ ] Platform detection returns correct value for current environment\n- [ ] No global variable pollution when sourced\n## Done summary\nTBD\n\n## Evidence\n- Commits:\n- Tests:\n- PRs:\n"
    },
    {
      "data": {
        "assignee": null,
        "claim_note": "",
        "claimed_at": null,
        "created_at": "2026-01-18T23:55:51.286919Z",
        "depends_on": [],
        "epic": "fn-5-urz",
        "id": "fn-5-urz.3",
        "priority": null,
        "spec_path": ".flow/tasks/fn-5-urz.3.md",
        "status": "todo",
        "title": "TOML config parser (parse-toml.py)",
        "updated_at": "2026-01-18T23:56:54.485405Z"
      },
      "id": "fn-5-urz.3",
      "spec": "# fn-5-urz.3 TOML config parser (parse-toml.py)\n\n## Description\n## Overview\n\nCreate a minimal Python TOML parser that shell scripts can call to read configuration values.\n\n## File\n\n`agent-sandbox/parse-toml.py`\n\n## Interface\n\n```bash\n# Get a single value\npython3 parse-toml.py --file config.toml --key agent.data_volume\n# Output: sandbox-agent-data\n\n# Get all values as JSON\npython3 parse-toml.py --file config.toml --json\n# Output: {\"agent\": {\"data_volume\": \"...\"}, ...}\n\n# Check if key exists\npython3 parse-toml.py --file config.toml --exists agent.data_volume\n# Exit code: 0 if exists, 1 if not\n```\n\n## Config Schema\n\n```toml\n[agent]\ndata_volume = \"sandbox-agent-data\"\n\n[credentials]\nmode = \"sandbox\"  # sandbox | host | none\n\n[danger]\nallow_host_credentials = false\nallow_host_docker_socket = false\n\n[secure_engine]\nenabled = \"auto\"  # true | false | auto\ncontext_name = \"containai-secure\"\nseccomp_profile = \"\"  # optional path\n```\n\n## Implementation\n\n- Use Python 3.11+ `tomllib` (stdlib, no dependencies)\n- Fallback to `toml` package for Python < 3.11\n- Use `argparse` for CLI (per repo conventions)\n- Exit 0 on success, 1 on error (with message to stderr)\n\n## Reuse\n\n- `flowctl.py` argparse patterns (`.flow/bin/flowctl.py`)\n## Acceptance\n- [ ] Reads TOML files with nested keys\n- [ ] `--key` returns single value to stdout\n- [ ] `--json` returns full config as JSON\n- [ ] `--exists` returns exit code without output\n- [ ] Works with Python 3.8+ (tomllib fallback for < 3.11)\n- [ ] Handles missing file gracefully (error to stderr, exit 1)\n- [ ] Handles missing key gracefully (empty output, exit 0 for --key)\n## Done summary\nTBD\n\n## Evidence\n- Commits:\n- Tests:\n- PRs:\n"
    },
    {
      "data": {
        "assignee": null,
        "claim_note": "",
        "claimed_at": null,
        "created_at": "2026-01-18T23:55:51.437589Z",
        "depends_on": [
          "fn-5-urz.2"
        ],
        "epic": "fn-5-urz",
        "id": "fn-5-urz.4",
        "priority": null,
        "spec_path": ".flow/tasks/fn-5-urz.4.md",
        "status": "todo",
        "title": "Docker Desktop + Sandboxes availability detection",
        "updated_at": "2026-01-18T23:57:41.484780Z"
      },
      "id": "fn-5-urz.4",
      "spec": "# fn-5-urz.4 Docker Desktop + Sandboxes availability detection\n\n## Description\n## Overview\n\nImplement detection functions for Docker Desktop version and Sandboxes feature availability.\n\n## Functions to Implement\n\n### _cai_docker_desktop_version()\n```bash\n# Returns Docker Desktop version or empty if not Docker Desktop\ndocker version --format '{{.Server.Platform.Name}}'  # \"Docker Desktop X.Y.Z\"\n# Parse version number, return semver-compatible string\n```\n\n### _cai_sandbox_available()\n```bash\n# Check if docker sandbox plugin exists\ndocker sandbox version >/dev/null 2>&1\n# Returns: 0 if available, 1 if not\n```\n\n### _cai_sandbox_feature_enabled()\n```bash\n# Check if sandboxes feature is enabled (not just installed)\n# Handle \"beta features disabled by admin\" case\ndocker sandbox ls >/dev/null 2>&1\n# Parse error output for admin policy messaging\n```\n\n## Error Cases\n\n1. **Docker not running**: Clear message \"Docker Desktop is not running\"\n2. **Version < 4.50**: \"Docker Desktop 4.50+ required (found: X.Y.Z)\"\n3. **Sandbox plugin missing**: \"docker sandbox command not found - enable experimental features\"\n4. **Admin policy blocks**: \"Sandboxes disabled by administrator policy\"\n\n## Reuse\n\n- `aliases.sh:129-228` - `_asb_check_sandbox()` has similar logic\n- Extract and refactor, don't duplicate\n\n## References\n\n- Docker troubleshooting: https://docs.docker.com/ai/sandboxes/troubleshooting/\n- Settings Management: https://docs.docker.com/desktop/settings-and-maintenance/settings/\n## Acceptance\n- [ ] `_cai_docker_desktop_version` returns semver string (e.g., \"4.50.1\")\n- [ ] Returns empty/error for non-Docker-Desktop docker (e.g., colima)\n- [ ] `_cai_sandbox_available` returns 0/1 correctly\n- [ ] `_cai_sandbox_feature_enabled` detects admin policy blocks\n- [ ] Error messages are actionable with remediation steps\n- [ ] Works when Docker is not running (doesn't hang)\n## Done summary\nTBD\n\n## Evidence\n- Commits:\n- Tests:\n- PRs:\n"
    },
    {
      "data": {
        "assignee": null,
        "claim_note": "",
        "claimed_at": null,
        "created_at": "2026-01-18T23:55:51.588190Z",
        "depends_on": [
          "fn-5-urz.2"
        ],
        "epic": "fn-5-urz",
        "id": "fn-5-urz.5",
        "priority": null,
        "spec_path": ".flow/tasks/fn-5-urz.5.md",
        "status": "todo",
        "title": "ECI detection (uid_map + runtime check)",
        "updated_at": "2026-01-18T23:57:42.136789Z"
      },
      "id": "fn-5-urz.5",
      "spec": "# fn-5-urz.5 ECI detection (uid_map + runtime check)\n\n## Description\n## Overview\n\nImplement ECI (Enhanced Container Isolation) detection per Docker documentation methods.\n\n## Functions to Implement\n\n### _cai_eci_available()\n```bash\n# Check if Docker Business with ECI is available (not necessarily enabled)\n# This requires checking Docker subscription tier\n# May not be directly detectable - fall through to enabled check\n```\n\n### _cai_eci_enabled()\nTwo validation methods per Docker docs:\n\n**Method 1: uid_map check**\n```bash\ndocker run --rm alpine cat /proc/self/uid_map\n# ECI active: \"0 100000 65536\" (root mapped to unprivileged)\n# ECI inactive: \"0 0 4294967295\" (root is root)\n```\n\n**Method 2: runtime check**\n```bash\n# Start ephemeral container, inspect runtime\nCID=$(docker run -d --rm alpine sleep 10)\ndocker inspect --format '{{.HostConfig.Runtime}}' \"$CID\"\n# ECI active: \"sysbox-runc\"\n# ECI inactive: \"runc\"\ndocker stop \"$CID\"\n```\n\n### _cai_eci_status()\n```bash\n# Returns: \"enabled\", \"available_not_enabled\", \"not_available\"\n# Combines above checks into single status\n```\n\n## Edge Cases\n\n- ECI enabled but container uses userns manually (false positive)\n- ECI available but not enabled - provide enablement instructions\n- Docker Business but ECI not enabled by admin\n\n## Reuse\n\n- `aliases.sh:91-126` - `_asb_check_isolation()` has uid_map check\n- Refactor to use both methods for higher confidence\n\n## References\n\n- ECI docs: https://docs.docker.com/enterprise/security/hardened-desktop/enhanced-container-isolation/enable-eci/\n## Acceptance\n- [ ] uid_map check correctly parses isolation status\n- [ ] Runtime check verifies sysbox-runc vs runc\n- [ ] Both methods must agree for \"enabled\" status\n- [ ] Ephemeral containers are cleaned up (no leak)\n- [ ] Timeout handling if Docker hangs\n- [ ] Clear status messages: \"ECI enabled\", \"ECI available but not enabled\", \"ECI not available\"\n## Done summary\nTBD\n\n## Evidence\n- Commits:\n- Tests:\n- PRs:\n"
    },
    {
      "data": {
        "assignee": null,
        "claim_note": "",
        "claimed_at": null,
        "created_at": "2026-01-18T23:55:51.745828Z",
        "depends_on": [
          "fn-5-urz.4",
          "fn-5-urz.5"
        ],
        "epic": "fn-5-urz",
        "id": "fn-5-urz.6",
        "priority": null,
        "spec_path": ".flow/tasks/fn-5-urz.6.md",
        "status": "todo",
        "title": "Decision engine + formatted doctor output",
        "updated_at": "2026-01-19T04:54:10.589542Z"
      },
      "id": "fn-5-urz.6",
      "spec": "# fn-5-urz.6 Decision engine + formatted doctor output\n\n## Description\n## Overview\n\nImplement `cai doctor` command that runs all detection checks and outputs a formatted report with remediation guidance. Shows requirements hierarchy clearly.\n\n## Requirements Hierarchy\n\n| Requirement | Level | Behavior |\n|-------------|-------|----------|\n| Docker Sandbox | **Hard requirement** | `[ERROR]` if not available, blocks `cai run` |\n| Sysbox | **Very strong suggestion** | `[WARN]` if not available, recommends `cai setup` |\n\n## Command\n\n```bash\ncai doctor [--json]\n```\n\n## Output Format (text)\n\n```\nContainAI Doctor\n================\n\nDocker Desktop\n  Version: 4.51.0                                    [OK]\n  Sandboxes feature: enabled                         [OK]    \u2190 REQUIRED\n\nContainer Isolation\n  Sysbox available: yes                              [OK]    \u2190 STRONGLY RECOMMENDED\n  Runtime: sysbox-runc                               [OK]\n  Context 'containai-secure': configured             [OK]\n\nPlatform: WSL2\n  Seccomp compatibility: warning                     [WARN]\n  (WSL 1.1.0+ may have seccomp conflicts with Sysbox)\n\nSummary\n  Docker Sandbox: \u2713 Available (required)\n  Sysbox: \u2713 Available (strongly recommended)\n  Recommended: Use 'cai run' with full isolation\n```\n\n### Output Without Sysbox\n\n```\nContainAI Doctor\n================\n\nDocker Desktop\n  Version: 4.51.0                                    [OK]\n  Sandboxes feature: enabled                         [OK]    \u2190 REQUIRED\n\nContainer Isolation\n  Sysbox available: no                               [WARN]  \u2190 STRONGLY RECOMMENDED\n  (Run 'cai setup' to install Sysbox for enhanced isolation)\n\nSummary\n  Docker Sandbox: \u2713 Available (required)\n  Sysbox: \u2717 Not available (strongly recommended)\n  Recommended: Run 'cai setup' for best security\n```\n\n## Output Format (JSON)\n\n```json\n{\n  \"docker_desktop\": {\n    \"version\": \"4.51.0\",\n    \"sandboxes_available\": true,\n    \"sandboxes_enabled\": true,\n    \"requirement_level\": \"hard\"\n  },\n  \"sysbox\": {\n    \"available\": true,\n    \"runtime\": \"sysbox-runc\",\n    \"context_exists\": true,\n    \"context_name\": \"containai-secure\",\n    \"requirement_level\": \"strong_suggestion\"\n  },\n  \"platform\": {\n    \"type\": \"wsl2\",\n    \"seccomp_compatible\": false,\n    \"warning\": \"WSL 1.1.0+ may have seccomp conflicts\"\n  },\n  \"summary\": {\n    \"sandbox_ok\": true,\n    \"sysbox_ok\": true,\n    \"recommended_action\": \"ready\"\n  }\n}\n```\n\n## Decision Logic\n\n```\nif sandbox not available:\n    exit 1, show ERROR, block usage\nelif sysbox available:\n    exit 0, show all OK, ready to use\nelse:\n    exit 0, show WARN for sysbox, recommend 'cai setup'\n```\n\n## Remediation Messages\n\n| Condition | Level | Message |\n|-----------|-------|---------|\n| Docker not running | ERROR | \"Start Docker Desktop to continue\" |\n| Version < 4.50 | ERROR | \"Upgrade Docker Desktop to 4.50+ (Settings > Software Updates)\" |\n| Sandboxes disabled | ERROR | \"Enable experimental features in Docker Desktop Settings\" |\n| Sysbox not installed | WARN | \"Run 'cai setup' for enhanced isolation (strongly recommended)\" |\n| WSL seccomp warning | WARN | \"WSL 1.1.0+ may have Sysbox conflicts; use --force with cai setup\" |\n\n## Exit Codes\n\n| Code | Meaning |\n|------|---------|\n| 0 | Docker Sandbox available (minimum requirement met) |\n| 1 | Docker Sandbox NOT available (cannot proceed) |\n\nNote: Missing Sysbox is a warning (exit 0), not an error.\n## Overview\n\nImplement `containai doctor` command that runs all detection checks and outputs a formatted report with remediation guidance.\n\n## Command\n\n```bash\ncontainai doctor [--json]\n```\n\n## Output Format (text)\n\n```\nContainAI Doctor\n================\n\nDocker Desktop\n  Version: 4.51.0                                    [OK]\n  Sandboxes feature: enabled                         [OK]\n\nContainer Isolation\n  ECI (Enhanced Container Isolation): enabled        [OK]\n  Runtime: sysbox-runc                               [OK]\n\nSecure Engine\n  Context 'containai-secure': not configured         [WARN]\n  (Run 'containai install secure-engine' to set up)\n\nRecommended path: ECI\n```\n\n## Output Format (JSON)\n\n```json\n{\n  \"docker_desktop\": {\n    \"version\": \"4.51.0\",\n    \"sandboxes_available\": true,\n    \"sandboxes_enabled\": true\n  },\n  \"eci\": {\n    \"status\": \"enabled\",\n    \"runtime\": \"sysbox-runc\",\n    \"uid_mapped\": true\n  },\n  \"secure_engine\": {\n    \"context_exists\": false,\n    \"context_name\": \"containai-secure\"\n  },\n  \"recommended_path\": \"eci\"\n}\n```\n\n## Decision Logic\n\n1. If ECI enabled \u2192 recommend \"eci\"\n2. Else if Secure Engine context exists \u2192 recommend \"secure-engine\"\n3. Else \u2192 recommend \"setup-required\" with instructions\n\n## Remediation Messages\n\n| Condition | Message |\n|-----------|---------|\n| Docker not running | \"Start Docker Desktop to continue\" |\n| Version < 4.50 | \"Upgrade Docker Desktop to 4.50+ (Settings > Software Updates)\" |\n| Sandboxes disabled | \"Enable experimental features in Docker Desktop Settings\" |\n| ECI available not enabled | \"Enable ECI: Settings > General > Use Enhanced Container Isolation\" |\n| No isolation available | \"Run 'containai install secure-engine' for isolation without Docker Business\" |\n## Acceptance\n- [ ] `cai doctor` runs all checks and outputs formatted report\n- [ ] Shows Docker Sandbox as \"REQUIRED\" in output\n- [ ] Shows Sysbox as \"STRONGLY RECOMMENDED\" in output\n- [ ] `--json` flag outputs machine-parseable JSON with requirement levels\n- [ ] Each check shows `[OK]`, `[WARN]`, or `[ERROR]` status\n- [ ] Docker Sandbox failures are `[ERROR]` (hard requirement)\n- [ ] Sysbox absence is `[WARN]` (strong suggestion, not error)\n- [ ] Remediation messages are actionable\n- [ ] Exit code 0 if Docker Sandbox available (even without Sysbox)\n- [ ] Exit code 1 only if Docker Sandbox NOT available\n- [ ] Detects platform (Linux, WSL2, macOS) and shows relevant warnings\n- [ ] WSL2 shows seccomp compatibility status\n## Done summary\nTBD\n\n## Evidence\n- Commits:\n- Tests:\n- PRs:\n"
    },
    {
      "data": {
        "assignee": null,
        "claim_note": "",
        "claimed_at": null,
        "created_at": "2026-01-18T23:55:51.900027Z",
        "depends_on": [
          "fn-5-urz.2",
          "fn-5-urz.3"
        ],
        "epic": "fn-5-urz",
        "id": "fn-5-urz.7",
        "priority": null,
        "spec_path": ".flow/tasks/fn-5-urz.7.md",
        "status": "todo",
        "title": "containai run with safe defaults",
        "updated_at": "2026-01-18T23:57:43.451998Z"
      },
      "id": "fn-5-urz.7",
      "spec": "# fn-5-urz.7 containai run with safe defaults\n\n## Description\n## Overview\n\nImplement `containai run` as a wrapper around `docker sandbox run` with safe defaults.\n\n## Command\n\n```bash\ncontainai run [--agent claude|gemini] [--workspace <path>] [-- <agent args>]\n```\n\n## Safe Defaults (FR-4)\n\n- `--credentials=none` (never `host` by default)\n- No `--mount-docker-socket`\n- No additional volume mounts beyond workspace\n- Workspace is current directory if not specified\n\n## Implementation\n\n```bash\ncontainai_run() {\n    local agent=\"${1:-claude}\"\n    local workspace=\"${2:-.}\"\n    \n    # Validate workspace exists\n    if [[ ! -d \"$workspace\" ]]; then\n        _cai_error \"Workspace not found: $workspace\"\n        return 1\n    fi\n    \n    # Build command\n    local cmd=(docker sandbox run)\n    cmd+=(--credentials=none)\n    cmd+=(--workspace \"$workspace\")\n    cmd+=(\"$agent\")\n    \n    # Pass through remaining args after --\n    shift 2 || true\n    if [[ \"$1\" == \"--\" ]]; then\n        shift\n        cmd+=(\"$@\")\n    fi\n    \n    \"${cmd[@]}\"\n}\n```\n\n## Config Integration\n\nLoad from `.containai/config.toml` or `~/.config/containai/config.toml`:\n- `agent` default\n- `credentials.mode` (but never override to `host` without explicit flag)\n\n## Error Handling\n\n- Check `containai doctor` status before running\n- If no isolation path available, refuse to run with clear message\n- If sandbox already exists with different config, warn user to reset\n\n## Reuse\n\n- `aliases.sh:277-347` - `containai()` function has similar structure\n## Acceptance\n- [ ] Uses `docker sandbox run` (never `docker run`)\n- [ ] Default credentials mode is `none`\n- [ ] No Docker socket mounted by default\n- [ ] Workspace defaults to current directory\n- [ ] Respects config file for agent default\n- [ ] `-- <args>` passes through to agent\n- [ ] Validates workspace exists before running\n- [ ] Integrates with doctor check (warns if no isolation)\n## Done summary\nTBD\n\n## Evidence\n- Commits:\n- Tests:\n- PRs:\n"
    },
    {
      "data": {
        "assignee": null,
        "claim_note": "",
        "claimed_at": null,
        "created_at": "2026-01-18T23:55:53.752305Z",
        "depends_on": [
          "fn-5-urz.6",
          "fn-5-urz.7"
        ],
        "epic": "fn-5-urz",
        "id": "fn-5-urz.8",
        "priority": null,
        "spec_path": ".flow/tasks/fn-5-urz.8.md",
        "status": "todo",
        "title": "Context auto-selection (ECI vs Secure Engine)",
        "updated_at": "2026-01-18T23:58:28.621280Z"
      },
      "id": "fn-5-urz.8",
      "spec": "# fn-5-urz.8 Context auto-selection (ECI vs Secure Engine)\n\n## Description\n## Overview\n\nEnhance `containai run` to automatically select the appropriate Docker context based on isolation availability.\n\n## Logic\n\n```\nif ECI enabled:\n    use default context (Docker Desktop)\nelif Secure Engine context exists:\n    use containai-secure context\nelse:\n    warn user, suggest running doctor/install\n```\n\n## Implementation\n\n```bash\n_cai_select_context() {\n    local eci_status\n    eci_status=$(_cai_eci_status)\n    \n    if [[ \"$eci_status\" == \"enabled\" ]]; then\n        echo \"\"  # Empty = default context\n        return 0\n    fi\n    \n    # Check for Secure Engine context\n    if docker context inspect containai-secure >/dev/null 2>&1; then\n        echo \"containai-secure\"\n        return 0\n    fi\n    \n    # No isolation available\n    return 1\n}\n\ncontainai_run() {\n    local context\n    if ! context=$(_cai_select_context); then\n        _cai_error \"No isolation available. Run 'containai doctor' for setup instructions.\"\n        return 1\n    fi\n    \n    local cmd=(docker)\n    if [[ -n \"$context\" ]]; then\n        cmd+=(--context \"$context\")\n    fi\n    cmd+=(sandbox run ...)\n}\n```\n\n## Config Override\n\nAllow explicit context in config:\n```toml\n[secure_engine]\ncontext_name = \"containai-secure\"  # or custom name\n```\n\n## Depends On\n\n- Task 1 spike must confirm `docker sandbox` respects `--context`\n- If spike shows context is ignored, this task needs revision\n## Acceptance\n- [ ] Auto-selects ECI path when enabled (no context flag)\n- [ ] Auto-selects Secure Engine context when ECI not available\n- [ ] Warns with actionable message when no isolation available\n- [ ] Respects config override for context name\n- [ ] Debug output shows which context was selected\n- [ ] Works correctly when spike (fn-5-urz.1) confirms context support\n## Done summary\nTBD\n\n## Evidence\n- Commits:\n- Tests:\n- PRs:\n"
    },
    {
      "data": {
        "assignee": null,
        "claim_note": "",
        "claimed_at": null,
        "created_at": "2026-01-18T23:55:53.904001Z",
        "depends_on": [
          "fn-5-urz.7"
        ],
        "epic": "fn-5-urz",
        "id": "fn-5-urz.9",
        "priority": null,
        "spec_path": ".flow/tasks/fn-5-urz.9.md",
        "status": "todo",
        "title": "Unsafe opt-ins with acknowledgements",
        "updated_at": "2026-01-18T23:58:29.287207Z"
      },
      "id": "fn-5-urz.9",
      "spec": "# fn-5-urz.9 Unsafe opt-ins with acknowledgements\n\n## Description\n## Overview\n\nImplement explicit unsafe opt-in flags with acknowledgement requirements per FR-5.\n\n## Flags\n\n### --allow-host-credentials\n- Enables `docker sandbox run --credentials=host`\n- Requires additional `--i-understand-this-exposes-host-credentials` flag\n- Warns about exposure of `~/.ssh`, `~/.gitconfig`, etc.\n\n### --allow-host-docker-socket\n- Enables `docker sandbox run --mount-docker-socket`\n- Requires `--i-understand-this-grants-root-access` flag\n- Warns about root-level daemon access and sandbox escape risk\n\n## Implementation\n\n```bash\ncontainai_run() {\n    local allow_host_creds=false\n    local allow_host_socket=false\n    local ack_creds=false\n    local ack_socket=false\n    \n    # Parse flags\n    while [[ $# -gt 0 ]]; do\n        case \"$1\" in\n            --allow-host-credentials) allow_host_creds=true ;;\n            --i-understand-this-exposes-host-credentials) ack_creds=true ;;\n            --allow-host-docker-socket) allow_host_socket=true ;;\n            --i-understand-this-grants-root-access) ack_socket=true ;;\n            # ... other flags\n        esac\n        shift\n    done\n    \n    # Validate acknowledgements\n    if $allow_host_creds && ! $ack_creds; then\n        _cai_error \"--allow-host-credentials requires --i-understand-this-exposes-host-credentials\"\n        _cai_error \"This will share ~/.ssh, ~/.gitconfig with the sandbox\"\n        return 1\n    fi\n    \n    # Build command with unsafe options\n    if $allow_host_creds; then\n        cmd+=(--credentials=host)\n        _cai_warn \"Running with host credentials - ~/.ssh and ~/.gitconfig accessible\"\n    fi\n}\n```\n\n## Config Support\n\n```toml\n[danger]\nallow_host_credentials = false  # CLI override still requires ack flag\nallow_host_docker_socket = false\n```\n\nConfig can pre-allow but CLI still requires acknowledgement flag for audit trail.\n## Acceptance\n- [ ] `--allow-host-credentials` without ack flag fails with clear message\n- [ ] `--allow-host-docker-socket` without ack flag fails with clear message\n- [ ] Warning printed when unsafe option used (even with ack)\n- [ ] Both flags together work correctly\n- [ ] Config [danger] section doesn't bypass ack requirement\n- [ ] Help text documents the risks of each flag\n## Done summary\nTBD\n\n## Evidence\n- Commits:\n- Tests:\n- PRs:\n"
    }
  ]
}
