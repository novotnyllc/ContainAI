# Platform Setup & Bootstrap

## Overview

Consolidate and improve the ContainAI setup experience across platforms. Project reorganization (task 1) is already complete, followed by macOS bootstrap improvements, install flow enhancements, and Lima VM optimizations.

**Absorbs:** fn-12-css.13 (setup consolidation)

## Scope

**In scope:**
- ~~Project reorganization (containai-init.sh, Dockerfiles → subdir)~~ ✓ Done
- macOS bash auto-install via Homebrew (with consent, in install.sh)
- macOS Homebrew installation prompt (with consent)
- install.sh auto-calls cai setup (with opt-out via `--no-setup`)
- install.sh re-run calls cai update (gated by template hash safety)
- Fix cai setup description (document Lima on macOS in installer messaging)
- Setup consolidation (legacy script cleanup - no merge needed, already done)
- Lima VM: only recreate if template changes (hash-based comparison)
- Lima VM: apt update/upgrade for OS packages on cai update
- cai doctor --reset-lima (macOS only, with confirmation)
- Fix macOS mirrored volume path (symlink-aware path handling)

**Out of scope:**
- Dockerd bundle management (fn-15-281)
- Workspace state persistence (fn-12-css)
- Config sync improvements (separate epic)
- VS Code Docker context status bar (moved to separate epic)

## Architecture

### Project Structure (Already Implemented)
```
src/
├── containai.sh           # Main CLI entry point
├── lib/                   # Shell libraries
├── container/             # Container-specific content ✓
│   ├── containai-init.sh  # Container init script
│   ├── Dockerfile.base    # Base image
│   ├── Dockerfile.sdks    # SDK layer
│   ├── Dockerfile.agents  # Agent layer
│   └── Dockerfile.test    # Test image
└── build.sh               # Build script (updated paths)
```

### Lima VM Update Flow
```
cai update (macOS)
    │
    ├─ Compute hash of rendered Lima template
    │  (Portable: sha256sum → shasum → openssl fallback)
    │  (Stored at: ~/.config/containai/lima-template.hash)
    │
    ├─ Compare current hash vs stored hash
    │
    ├─ If same → apt update && apt upgrade -y in VM
    │  (Uses $_CAI_LIMA_VM_NAME, NOT hardcoded)
    │  (OS + Docker packages; Sysbox requires template change)
    │
    └─ If different → prompt to recreate VM (or auto if CAI_YES=1)
        └─ --lima-recreate bypasses hash check and forces recreate
```

### Non-Interactive Policy (for curl|bash installs)

**Shared prompt helper (`_cai_prompt_confirm`):**
```bash
# In src/lib/core.sh - used by ALL prompts in setup/update/doctor
_cai_prompt_confirm() {
    # 1. If CAI_YES=1: return 0 immediately (auto-confirm)
    # 2. If stdin is TTY: read from stdin
    # 3. If stdin is pipe but /dev/tty exists: read from /dev/tty
    # 4. Otherwise: return 1 (can't prompt)
}
```

**Consent propagation via `CAI_YES=1`:**
```bash
install.sh behavior:
├─ Interactive (TTY available):
│   ├─ Prompts for consent before running cai setup
│   ├─ Runs: CAI_YES=1 "$BASH4_PATH" cai setup
│   └─ --no-setup skips all post-install setup
│
├─ Non-interactive (no TTY, piped install):
│   ├─ --yes flag: runs CAI_YES=1 "$BASH4_PATH" cai setup
│   ├─ No --yes: shows post-install instructions only
│   └─ Never runs destructive operations without --yes
│
└─ Re-run behavior:
    ├─ First run: calls cai setup
    └─ Re-run: calls cai update (safe due to hash check)

cai wrapper (macOS):
├─ Re-execs with Homebrew bash if running under bash 3.x
└─ Ensures bash 4+ features work even if user's PATH has bash 3
```

**Important:**
- Bash bootstrap happens in install.sh BEFORE the cai wrapper is created
- Post-install cai commands use detected $BASH4_PATH explicitly
- cai wrapper re-execs with Homebrew bash for future invocations

### macOS Path Normalization

```bash
# In src/lib/platform.sh - used for all workspace path handling
_cai_normalize_path() {
    # macOS: pwd -L (preserve symlinks for Lima mounts)
    # Linux: pwd -P (resolve symlinks for consistency)
}
```

All `pwd -P` calls in workspace handling must use this helper to fix Lima mount failures with symlinked paths like `/var/folders/...`.

## Quick commands

```bash
# Lint
shellcheck -x src/*.sh src/lib/*.sh

# Build images
./src/build.sh

# Test setup on Linux
cai setup --dry-run
```

## Acceptance

- [x] containai-init.sh and Dockerfiles moved to src/container/
- [x] build.sh updated for new paths
- [ ] macOS: install.sh installs bash via Homebrew before creating wrapper
- [ ] macOS: prompts to install Homebrew if missing (with consent)
- [ ] macOS: post-install cai commands use detected $BASH4_PATH
- [ ] macOS: cai wrapper re-execs with Homebrew bash if under bash 3.x
- [ ] Shared `_cai_prompt_confirm()` helper in src/lib/core.sh
- [ ] All prompts in setup/update/doctor use the shared helper
- [ ] install.sh calls cai setup automatically (interactive) or with --yes
- [ ] install.sh --no-setup skips setup
- [ ] install.sh re-run calls cai update (safe due to hash gate)
- [ ] install.sh post-install messaging mentions Lima on macOS
- [ ] cai setup --help mentions Lima on macOS
- [ ] Lima VM only recreated when template hash changes
- [ ] Template hash uses portable SHA-256 (sha256sum/shasum/openssl)
- [ ] Template hash saved ONLY in _cai_lima_create_vm() after actual creation
- [ ] Template hash stored at ~/.config/containai/lima-template.hash
- [ ] Lima apt commands use $_CAI_LIMA_VM_NAME (not hardcoded)
- [ ] Lima VM gets apt update/upgrade on cai update (when hash matches)
- [ ] cai doctor --reset-lima uses $_CAI_LIMA_VM_NAME and $_CAI_CONTAINAI_DOCKER_CONTEXT
- [ ] cai doctor --reset-lima works (macOS only) with confirmation
- [ ] cai doctor --reset-lima not shown in help on non-macOS
- [ ] `_cai_normalize_path()` helper in src/lib/platform.sh
- [ ] All pwd -P sites in containai.sh and container.sh use the helper
- [ ] macOS workspace paths preserve symlinks for Lima mount compatibility
- [ ] CAI_YES=1 propagates consent through setup/update

## References

- Current setup: `src/lib/setup.sh`
- Install script: `install.sh` (root of repo)
- Lima template: generated by `_cai_lima_template()` in `src/lib/setup.sh`
- Update logic: `src/lib/update.sh`
- Core utilities: `src/lib/core.sh` (add shared prompt helper here)
- Platform detection: `src/lib/platform.sh` (add path normalization here)
- Portable hash pattern: `src/lib/container.sh:283` (sha256sum/shasum/openssl)
- Lima VM constants: `$_CAI_LIMA_VM_NAME`, `$_CAI_CONTAINAI_DOCKER_CONTEXT` in `src/lib/setup.sh:80`
- fn-12-css.13: Setup consolidation task (absorbed)

## Dependencies

- **fn-15-281**: Dockerd bundle (parallel work, no conflict)

## Task Dependency Graph

```
fn-16-4c9.1 (done) ──┬──> fn-16-4c9.2 (bash auto-install in install.sh)
                     ├──> fn-16-4c9.3 (prompt helper + install.sh auto-setup) ──> fn-16-4c9.4 (re-run update)
                     ├──> fn-16-4c9.5 (help text)
                     ├──> fn-16-4c9.6 (cleanup legacy refs) ──┬──> fn-16-4c9.7 (template hash)
                     │                                        └──> fn-16-4c9.9 (reset-lima)
                     └──> fn-16-4c9.10 (volume path fix)
                                                              fn-16-4c9.7 ──> fn-16-4c9.8 (apt upgrade)
```
