# Platform Setup & Bootstrap

## Overview

Consolidate and improve the ContainAI setup experience across platforms. Project reorganization comes first, followed by macOS bootstrap improvements, install flow enhancements, and Lima VM optimizations.

**Absorbs:** fn-12-css.13 (setup consolidation)

## Scope

**In scope:**
- Project reorganization (containai-init.sh, Dockerfiles → subdir)
- macOS bash auto-install via Homebrew (with consent)
- install.sh auto-calls cai setup (with opt-out)
- install.sh re-run calls cai update
- Fix cai setup description (document Lima on macOS)
- Setup consolidation (merge install-containai-docker.sh)
- Lima VM: only recreate if template changes
- Lima VM: apt update/upgrade for component updates
- cai doctor --reset-lima (macOS only)
- Fix macOS mirrored volume path

**Out of scope:**
- Dockerd bundle management (fn-15-281)
- Workspace state persistence (fn-12-css)
- Config sync improvements (separate epic)

## Architecture

### Project Structure (After Reorg)
```
src/
├── containai.sh           # Main CLI entry point
├── lib/                   # Shell libraries
├── container/             # Container-specific content (NEW)
│   ├── containai-init.sh  # Container init script
│   ├── Dockerfile.base    # Base image
│   ├── Dockerfile.sdks    # SDK layer
│   └── Dockerfile.agents  # Agent layer
└── build.sh               # Build script (updated paths)
```

### Lima VM Update Flow
```
cai update (macOS)
    │
    ├─ Compare current template hash vs installed
    │
    ├─ If same → apt update/upgrade in VM only
    │
    └─ If different → recreate VM (with warning)
```

## Quick commands

```bash
# Lint
shellcheck -x src/*.sh src/lib/*.sh

# Build images
./src/build.sh

# Test setup on Linux
cai setup --dry-run
```

## Acceptance

- [ ] containai-init.sh and Dockerfiles moved to src/container/
- [ ] build.sh updated for new paths
- [ ] macOS: auto-installs bash via Homebrew (with user consent)
- [ ] macOS: prompts to install Homebrew if missing (with consent)
- [ ] install.sh calls cai setup automatically
- [ ] install.sh --no-setup skips setup
- [ ] install.sh re-run calls cai update
- [ ] cai setup --help mentions Lima on macOS
- [ ] install-containai-docker.sh merged into lib/setup.sh
- [ ] Lima VM only recreated when template changes
- [ ] Lima VM gets apt update/upgrade on cai update
- [ ] cai doctor --reset-lima works (macOS only)
- [ ] cai doctor --reset-lima hidden on non-macOS
- [ ] macOS mirrored volume path is correct

## References

- Current setup: `src/lib/setup.sh`
- Install script: `scripts/install-containai-docker.sh`
- Lima template: `src/containai.yaml`
- fn-12-css.13: Setup consolidation task

## Dependencies

- **fn-15-281**: Dockerd bundle (parallel work, no conflict)
