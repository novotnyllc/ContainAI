# Add Mac support for import scripts

## Overview

Enable `cai import` to work on macOS. The import script syncs host configs (Claude plugins, gh credentials, tmux, shell, etc.) to a Docker volume for use inside the sandbox container.

**Current state**: Documentation says "Linux/WSL only - macOS is not yet supported" (`agent-sandbox/README.md:54`).

**Finding**: The import.sh code is already largely portable:
- Base64 encoding uses `base64 | tr -d '\n'` (portable)
- POSIX sh code runs inside Linux container (no host compatibility issue)
- The `_IMPORT_SYNC_MAP` uses `$HOME`-relative paths that work on macOS

**Remaining work**:
1. Update README documentation to indicate Mac support with prerequisites
2. Make integration tests hermetic (use temp HOME fixture) so they work on any platform
3. Run existing tests to verify no regressions

## Scope

**In scope**:
- Update documentation to indicate Mac support with prerequisites (Docker Desktop, jq, python3)
- Make existing `test-sync-integration.sh` hermetic by using a temp HOME fixture
- Document Docker Desktop file-sharing requirements for macOS
- Add security note about what gets synced to the volume

**Out of scope**:
- VS Code desktop settings sync (different paths per OS: `~/Library/Application Support/Code/` on macOS)
- Adding new import sources not already in `_IMPORT_SYNC_MAP`

## Approach

The `_IMPORT_SYNC_MAP` array in import.sh uses `$HOME`-relative paths that work on macOS:
- `~/.claude/` - Claude CLI (same on all platforms)
- `~/.config/gh/` - GitHub CLI (follows XDG on macOS)
- `~/.config/tmux/` - tmux (XDG)
- `~/.vscode-server/` - VS Code Remote Server (same on all platforms)
- etc.

**Testing strategy**: Make tests deterministic by:
1. Early guard: Check Docker availability at script start:
   - If `docker` binary missing → skip with `exit 0`
   - If `docker info` fails (daemon down) → warn and fail (don't hide regressions)
2. Create temp HOME fixture **under real home** (e.g., `$REAL_HOME/.containai-test-home-XXXX`) for Docker Desktop file-sharing compatibility
3. **Preserve Docker config** when switching HOME:
   - Export `DOCKER_CONFIG="$REAL_HOME/.docker"` before changing `HOME`
   - This prevents Docker CLI from losing its context/endpoint configuration
4. Override `HOME` only for `cai import` invocations:
   - `HOME="$FIXTURE_HOME" bash -c "source ... && cai import"`
   - This ensures `_IMPORT_HOST_PATH_PREFIX` uses the fixture while Docker still works
5. Create **minimal subset** of source files needed for existing test assertions in `test_full_sync`:
   - `~/.claude.json` (root-level) → `/data/claude/`
   - `~/.claude/.credentials.json` (dot-prefixed filename)
   - `~/.claude/settings.json`
   - `~/.claude/plugins/` (directory) → `/data/claude/plugins/`
   - `~/.config/gh/hosts.yml` → `/data/config/gh/`
   - `~/.bash_aliases` → `/data/shell/`
   - `~/.codex/auth.json` → `/data/codex/`
   - `~/.gemini/oauth_creds.json` → `/data/gemini/`
   - `~/.copilot/config.json` → `/data/copilot/`
   - `~/.config/tmux/tmux.conf` → `/data/config/tmux/`
   - `~/.local/share/tmux/plugins/` (directory) → `/data/local/share/tmux/`
   - Note: vscode-server, opencode, etc. are omitted; import handles missing sources gracefully and those aren't in test assertions
6. Run `cai import --data-volume <testvol>` against fixture
7. Assert volume contents match expected structure (e.g., `/data/claude/`, `/data/shell/`, `/data/config/gh/`)
8. Clean up: remove fixture and test volume at end

**Preconditions**: The volume must exist before running `cai import --dry-run`. Either run `cai` once first, or use `docker volume create <name>`.

## Quick commands

```bash
# Test import on macOS (manual)
source agent-sandbox/containai.sh
cai import --dry-run  # Note: volume must exist first

# Run the existing integration tests
./agent-sandbox/test-sync-integration.sh
```

## Acceptance

- [ ] `agent-sandbox/README.md` updated to indicate Mac support for `cai import` with prerequisites (Docker Desktop, jq, python3) and file-sharing note
- [ ] Integration tests made hermetic using temp HOME fixture (no reliance on real host files)
- [ ] `cai import --dry-run` works on macOS without errors (precondition: volume exists)
- [ ] No regressions on Linux/WSL (verified by running existing tests)
- [ ] Security note added listing credential paths synced (host → volume):
  - `~/.claude/.credentials.json` → `/data/claude/credentials.json`
  - `~/.codex/auth.json` → `/data/codex/auth.json`
  - `~/.gemini/oauth_creds.json` → `/data/gemini/oauth_creds.json`
  - `~/.config/gh/` → `/data/config/gh/`
  - Instructions for removing/resetting the volume

## References

- `agent-sandbox/lib/import.sh:88-146` - `_IMPORT_SYNC_MAP` array with source paths
- `agent-sandbox/lib/import.sh:292-293` - Portable base64 encoding
- `agent-sandbox/lib/platform.sh:42-85` - Platform detection helpers
- `agent-sandbox/README.md:54` - Current "Linux/WSL only" documentation
- `agent-sandbox/test-sync-integration.sh` - Existing integration test script
- [GitHub CLI uses ~/.config/gh/ on macOS](https://cli.github.com/manual/gh_config)
