# Sysbox Version Checking and Update Across All Commands

## Problem
Running `install.sh` or `cai update` shows a message about a sysbox update being available, but it doesn't actually update the installed sysbox to the bundled ContainAI version.

## Root Cause
1. `cai update` only updates the dockerd bundle, not sysbox
2. `cai doctor` only checks if sysbox is available, not if it's at the correct version
3. The sysbox version checking/update logic exists only in `_cai_install_sysbox_linux()` which is called by setup but not update

## Solution

### Task 1: Extract reusable sysbox version functions
Extract sysbox version checking logic from `_cai_install_sysbox_linux()` into reusable functions in setup.sh:

1. `_cai_sysbox_installed_version()` - Returns installed sysbox version (semver only)
2. `_cai_sysbox_installed_pkg_version()` - Returns full dpkg version (includes +containai suffix)
3. `_cai_sysbox_is_containai_build()` - Returns true if installed version is ContainAI build
4. `_cai_sysbox_bundled_tag()` - Returns the pinned `_CAI_SYSBOX_CONTAINAI_TAG`
5. `_cai_sysbox_needs_update()` - Compares installed vs bundled, returns true if update needed

### Task 2: Add sysbox version to `cai doctor`
Update doctor.sh `_cai_doctor()` to show sysbox version information:

```
Sysbox Isolation
  Sysbox available:                              [OK]
  Installed version: 0.6.7+containai.20260126    [OK]
  Bundled version: 0.6.7+containai.20260126      [OK] Up to date
  # OR if update available:
  Bundled version: 0.6.8+containai.20260127      [WARN] Update available
                                                 (Run 'cai update' to upgrade)
```

Also update `_cai_doctor_json()` to include:
```json
"sysbox": {
  "available": true,
  "installed_version": "0.6.7+containai.20260126",
  "bundled_version": "0.6.7+containai.20260126",
  "needs_update": false
}
```

### Task 3: Add sysbox update to `cai update`
Add `_cai_update_sysbox()` function to update.sh that:
1. Checks if sysbox is installed
2. Compares installed version with bundled version
3. If update needed, calls existing `_cai_install_sysbox_linux()` or `_cai_install_sysbox_wsl2()`
4. Shows progress and respects `--dry-run`, `--force`, and `CAI_YES=1`

Wire it into `_cai_update_linux_wsl2()` after dockerd bundle update.

## Affected Files
- `src/lib/setup.sh` - Extract reusable functions
- `src/lib/doctor.sh` - Add sysbox version display
- `src/lib/update.sh` - Add sysbox update function

## Acceptance Criteria
- [ ] `cai doctor` shows installed vs bundled sysbox version
- [ ] `cai doctor` indicates when update is available
- [ ] `cai update` checks and updates sysbox if needed
- [ ] Version comparison works correctly for ContainAI builds (with +containai suffix)
- [ ] Update flow respects `--dry-run`, `--force`, and `CAI_YES=1`
- [ ] macOS (Lima) path works correctly (sysbox is inside Lima VM)
