# Sync-Agent-Plugins Refactoring Specification

## Overview

Refactor `sync-agent-plugins.sh` to use a declarative rsync-based approach for syncing portable configuration files from host to Docker volume.

**Important constraints:**
- **Linux only** - macOS has different config locations; block with error on macOS (future work)
- **Sync is optional** - entrypoint.sh MUST also ensure all target files/dirs exist since sync may not be run

---

## Architecture

### Platform Guard (Issue #12)

The script MUST check platform before any operations:

```bash
check_platform() {
  case "$(uname -s)" in
    Linux)
      return 0  # Includes WSL
      ;;
    Darwin)
      echo "ERROR: macOS is not supported by sync-agent-plugins.sh yet" >&2
      return 1
      ;;
    *)
      echo "ERROR: Unsupported platform: $(uname -s)" >&2
      return 1
      ;;
  esac
}
```

### Single Configuration Map (Issues #5, #6)

All sync items defined in one array. **Each path appears only once** - sync either the directory OR specific files, not both.

**Flags:**
- `d` = directory
- `f` = file
- `j` = initialize JSON with `{}` if empty
- `m` = mirror mode (use `--delete` to remove files not in source)
- `s` = secret (enforce restrictive permissions: 600 for files, 700 for dirs)
- `x` = exclude .system/ subdirectory (for Codex skills)

```bash
# Format: "source:target:flags"

SYNC_MAP=(
  # ─── Claude Code ───
  # Note: target files are NOT dot-prefixed for visibility in volume
  "/source/.claude.json:/target/claude/claude.json:fjs"
  "/source/.claude/.credentials.json:/target/claude/credentials.json:fs"
  "/source/.claude/settings.json:/target/claude/settings.json:fj"
  "/source/.claude/settings.local.json:/target/claude/settings.local.json:f"
  "/source/.claude/plugins:/target/claude/plugins:d"
  "/source/.claude/skills:/target/claude/skills:d"

  # ─── GitHub CLI ───
  "/source/.config/gh:/target/config/gh:ds"

  # ─── OpenCode ───
  "/source/.config/opencode:/target/config/opencode:d"

  # ─── tmux ───
  "/source/.tmux.conf:/target/tmux/.tmux.conf:f"
  "/source/.tmux:/target/tmux/.tmux:d"
  "/source/.config/tmux:/target/config/tmux:d"

  # ─── Shell ───
  "/source/.bash_aliases:/target/shell/.bash_aliases:f"
  "/source/.bashrc.d:/target/shell/.bashrc.d:d"

  # ─── VS Code Server ───
  # Sync entire data subtrees (no overlapping entries)
  "/source/.vscode-server/extensions:/target/vscode-server/extensions:d"
  "/source/.vscode-server/data/Machine:/target/vscode-server/data/Machine:d"
  "/source/.vscode-server/data/User/mcp:/target/vscode-server/data/User/mcp:d"
  "/source/.vscode-server/data/User/prompts:/target/vscode-server/data/User/prompts:d"

  # ─── VS Code Insiders ───
  "/source/.vscode-server-insiders/extensions:/target/vscode-server-insiders/extensions:d"
  "/source/.vscode-server-insiders/data/Machine:/target/vscode-server-insiders/data/Machine:d"
  "/source/.vscode-server-insiders/data/User/mcp:/target/vscode-server-insiders/data/User/mcp:d"
  "/source/.vscode-server-insiders/data/User/prompts:/target/vscode-server-insiders/data/User/prompts:d"

  # ─── Copilot ───
  # Selective sync: config, mcp-config, skills (exclude logs/, command-history-state.json)
  "/source/.copilot/config.json:/target/copilot/config.json:f"
  "/source/.copilot/mcp-config.json:/target/copilot/mcp-config.json:f"
  "/source/.copilot/skills:/target/copilot/skills:d"

  # ─── Gemini ───
  # Selective sync: credentials + user instructions (exclude tmp/, antigravity/)
  "/source/.gemini/google_accounts.json:/target/gemini/google_accounts.json:fs"
  "/source/.gemini/oauth_creds.json:/target/gemini/oauth_creds.json:fs"
  "/source/.gemini/GEMINI.md:/target/gemini/GEMINI.md:f"

  # ─── Codex ───
  # Selective sync: config, auth, skills (exclude history.jsonl, log/, sessions/, shell_snapshots/, tmp/)
  "/source/.codex/config.toml:/target/codex/config.toml:f"
  "/source/.codex/auth.json:/target/codex/auth.json:fs"
  "/source/.codex/skills:/target/codex/skills:dx"  # x = exclude .system/ subdirectory

  # ─── OpenCode ───
  # Config is covered by ~/.config symlink; only need auth from data dir
  "/source/.local/share/opencode/auth.json:/target/local/share/opencode/auth.json:fs"
)
```

### Rsync-Based Sync Function (Issues #1, #2, #3, #10, #11)

**Key fixes:**
- Branch copy logic by flag type (files vs directories)
- Use heredoc to pass map data (avoids `printf %q` shell incompatibility)
- Proper dry-run mode that doesn't mutate
- Permission enforcement for secrets
- Targeted chown instead of recursive full-volume chown

```bash
sync_configs() {
  local dry_run="${1:-false}"

  # Generate map data as newline-separated entries
  local map_data=""
  for entry in "${SYNC_MAP[@]}"; do
    map_data+="$entry"$'\n'
  done

  local dry_run_flag=""
  if [[ "$dry_run" == "true" ]]; then
    dry_run_flag="DRY_RUN=1"
  fi

  docker run --rm \
    --mount type=bind,src="$HOME",dst=/source,readonly \
    --mount type=volume,src="$DATA_VOLUME",dst=/target \
    --env "$dry_run_flag" \
    eeacms/rsync sh -e <<'SYNC_SCRIPT'
# rsync is pre-installed in eeacms/rsync image

# Track touched paths for targeted chown
TOUCHED_PATHS=""

ensure() {
  local path="$1" flags="$2"

  # In dry-run mode, only print what would happen
  if [ "${DRY_RUN:-}" = "1" ]; then
    case "$flags" in
      *d*) echo "[DRY-RUN] Would create directory: $path" ;;
      *f*) echo "[DRY-RUN] Would create file: $path" ;;
    esac
    case "$flags" in
      *j*) echo "[DRY-RUN] Would initialize JSON if empty: $path" ;;
    esac
    return 0
  fi

  case "$flags" in
    *d*) mkdir -p "$path" ;;
    *f*) mkdir -p "$(dirname "$path")"; touch "$path" ;;
  esac

  # Initialize JSON with {} if empty and flagged
  case "$flags" in
    *j*) [ -s "$path" ] || echo "{}" > "$path" ;;
  esac

  TOUCHED_PATHS="$TOUCHED_PATHS $path"
}

copy() {
  local src="$1" dst="$2" flags="$3"
  local rsync_opts="-a --chown=1000:1000"

  # Add mirror flag if specified
  case "$flags" in
    *m*) rsync_opts="$rsync_opts --delete" ;;
  esac

  # In dry-run mode, use rsync --dry-run
  if [ "${DRY_RUN:-}" = "1" ]; then
    rsync_opts="$rsync_opts --dry-run --itemize-changes"
  fi

  # Always ensure target exists first (respects dry-run internally)
  ensure "$dst" "$flags"

  # Copy if source exists, branching by type
  if [ -e "$src" ]; then
    case "$flags" in
      *d*)
        # Directory: use trailing slashes for content sync (not rename)
        [ -d "$src" ] && rsync $rsync_opts "$src/" "$dst/"
        ;;
      *f*)
        # File: rsync directly to target path (handles renames)
        [ -f "$src" ] && rsync $rsync_opts "$src" "$dst"
        ;;
    esac
  fi

  # Enforce restrictive permissions for secrets (skip in dry-run)
  if [ "${DRY_RUN:-}" != "1" ]; then
    case "$flags" in
      *s*)
        case "$flags" in
          *d*) chmod 770 "$dst" 2>/dev/null || true ;;
          *f*) chmod 660 "$dst" 2>/dev/null || true ;;
        esac
        ;;
    esac
  fi
}

# Process map entries from stdin
while IFS=: read -r src dst flags; do
  [ -z "$src" ] && continue
  copy "$src" "$dst" "$flags"
done <<'MAP_DATA'
SYNC_SCRIPT

  # Inject map data into heredoc
  echo "$map_data" | docker run --rm -i \
    --mount type=bind,src="$HOME",dst=/source,readonly \
    --mount type=volume,src="$DATA_VOLUME",dst=/target \
    ${dry_run_flag:+--env "$dry_run_flag"} \
    eeacms/rsync sh -e -c "$(cat <<'INNER_SCRIPT'
# rsync is pre-installed in eeacms/rsync image

ensure() {
  local path="$1" flags="$2"
  if [ "${DRY_RUN:-}" = "1" ]; then
    case "$flags" in *d*) echo "[DRY-RUN] mkdir -p $path" ;; esac
    case "$flags" in *f*) echo "[DRY-RUN] touch $path" ;; esac
    case "$flags" in *j*) echo "[DRY-RUN] init JSON $path" ;; esac
    return 0
  fi
  case "$flags" in *d*) mkdir -p "$path" ;; esac
  case "$flags" in *f*) mkdir -p "$(dirname "$path")"; touch "$path" ;; esac
  case "$flags" in *j*) [ -s "$path" ] || echo "{}" > "$path" ;; esac
}

copy() {
  local src="$1" dst="$2" flags="$3"
  local opts="-a --chown=1000:1000"
  case "$flags" in *m*) opts="$opts --delete" ;; esac
  case "$flags" in *x*) opts="$opts --exclude=.system/" ;; esac
  [ "${DRY_RUN:-}" = "1" ] && opts="$opts --dry-run --itemize-changes"

  ensure "$dst" "$flags"

  if [ -e "$src" ]; then
    case "$flags" in
      *d*) [ -d "$src" ] && rsync $opts "$src/" "$dst/" ;;
      *f*) [ -f "$src" ] && rsync $opts "$src" "$dst" ;;
    esac
  fi

  # Secret permissions (skip in dry-run)
  if [ "${DRY_RUN:-}" != "1" ]; then
    case "$flags" in
      *s*) case "$flags" in *d*) chmod 700 "$dst" ;; *f*) chmod 600 "$dst" ;; esac ;;
    esac
  fi
}

while IFS=: read -r src dst flags; do
  [ -z "$src" ] && continue
  copy "$src" "$dst" "$flags"
done
INNER_SCRIPT
)"
}
```

---

## Post-Sync Transforms (Issue #4)

**ALL existing transforms MUST be retained:**

1. **`installed_plugins.json`**: Path rewrite + scope change
2. **`known_marketplaces.json`**: Path rewrite
3. **`merge_enabled_plugins`**: Merge host enabled plugins into volume settings
4. **`remove_orphan_markers`**: Clear `.orphaned_at` markers from plugins

```bash
# After sync_configs completes:
post_sync_transforms() {
  # These run on the HOST with jq (not in container)

  # 1. Rewrite installed_plugins.json paths
  rewrite_installed_plugins

  # 2. Rewrite known_marketplaces.json paths
  rewrite_known_marketplaces

  # 3. Merge enabled plugins from host to volume
  merge_enabled_plugins

  # 4. Remove orphan markers
  remove_orphan_markers
}
```

**Acceptance criteria:**
- Plugins load correctly in container
- No orphan markers visible
- Enabled plugins from host are effective in container

---

## File Inventory

### Claude Code
| Host | Volume | Notes |
|------|--------|-------|
| `~/.claude.json` | `/mnt/agent-data/claude/claude.json` | JSON init, secret |
| `~/.claude/.credentials.json` | `/mnt/agent-data/claude/credentials.json` | secret (600) |
| `~/.claude/settings.json` | `/mnt/agent-data/claude/settings.json` | JSON init |
| `~/.claude/settings.local.json` | `/mnt/agent-data/claude/settings.local.json` | optional |
| `~/.claude/plugins/` | `/mnt/agent-data/claude/plugins/` | cache/, marketplaces/ |
| `~/.claude/skills/` | `/mnt/agent-data/claude/skills/` | |

### GitHub CLI
| Host | Volume | Notes |
|------|--------|-------|
| `~/.config/gh/` | `/mnt/agent-data/config/gh/` | secret (700) - hosts.yml has tokens |

### OpenCode
| Host | Volume | Notes |
|------|--------|-------|
| `~/.config/opencode/` | `/mnt/agent-data/config/opencode/` | |
| `~/.local/share/opencode/` | `/mnt/agent-data/local/share/opencode/` | secret - auth.json |

### tmux
| Host | Volume | Notes |
|------|--------|-------|
| `~/.tmux.conf` | `/mnt/agent-data/tmux/.tmux.conf` | legacy location |
| `~/.tmux/` | `/mnt/agent-data/tmux/.tmux/` | TPM plugins |
| `~/.config/tmux/` | `/mnt/agent-data/config/tmux/` | XDG location |

### Shell
| Host | Volume | Notes |
|------|--------|-------|
| `~/.bash_aliases` | `/mnt/agent-data/shell/.bash_aliases` | |
| `~/.bashrc.d/` | `/mnt/agent-data/shell/.bashrc.d/` | |

### Copilot
| Host | Volume | Notes |
|------|--------|-------|
| `~/.copilot/config.json` | `/mnt/agent-data/copilot/config.json` | settings |
| `~/.copilot/mcp-config.json` | `/mnt/agent-data/copilot/mcp-config.json` | MCP servers |
| `~/.copilot/skills/` | `/mnt/agent-data/copilot/skills/` | custom skills |

### Gemini
| Host | Volume | Notes |
|------|--------|-------|
| `~/.gemini/google_accounts.json` | `/mnt/agent-data/gemini/google_accounts.json` | secret (600) |
| `~/.gemini/oauth_creds.json` | `/mnt/agent-data/gemini/oauth_creds.json` | secret (600) |
| `~/.gemini/GEMINI.md` | `/mnt/agent-data/gemini/GEMINI.md` | user instructions |

### Codex
| Host | Volume | Notes |
|------|--------|-------|
| `~/.codex/config.toml` | `/mnt/agent-data/codex/config.toml` | settings |
| `~/.codex/auth.json` | `/mnt/agent-data/codex/auth.json` | secret (600) |
| `~/.codex/skills/` | `/mnt/agent-data/codex/skills/` | exclude .system/ |

### OpenCode
| Host | Volume | Notes |
|------|--------|-------|
| `~/.config/opencode/` | `/mnt/agent-data/config/opencode/` | via ~/.config symlink |
| `~/.local/share/opencode/auth.json` | `/mnt/agent-data/local/share/opencode/auth.json` | secret (600) |

---

## Dockerfile Changes (Issues #8, #9)

Add symlinks for new tools with **idempotent logic** and **sourcing hooks**:

```dockerfile
    # tmux (legacy location)
    && mkdir -p /mnt/agent-data/tmux \
    && ln -sfn /mnt/agent-data/tmux/.tmux.conf ${HOME}/.tmux.conf \
    && ln -sfn /mnt/agent-data/tmux/.tmux ${HOME}/.tmux \
    \
    # Shell configs with sourcing integration
    && mkdir -p /mnt/agent-data/shell \
    && ln -sfn /mnt/agent-data/shell/.bash_aliases ${HOME}/.bash_aliases_imported \
    && ln -sfn /mnt/agent-data/shell/.bashrc.d ${HOME}/.bashrc.d \
    \
    # Add sourcing hooks to .bashrc (Issue #8 fix)
    && echo '# Source imported bash_aliases if exists' >> ${HOME}/.bashrc \
    && echo '[ -f ~/.bash_aliases_imported ] && . ~/.bash_aliases_imported' >> ${HOME}/.bashrc \
    && echo '# Source all scripts in .bashrc.d if directory exists' >> ${HOME}/.bashrc \
    && echo 'if [ -d ~/.bashrc.d ]; then for f in ~/.bashrc.d/*.sh; do [ -r "$f" ] && . "$f"; done; fi' >> ${HOME}/.bashrc \
    \
    # Copilot (add missing mcp-config.json and skills/)
    && ln -sfn /mnt/agent-data/copilot/mcp-config.json ${HOME}/.copilot/mcp-config.json \
    && ln -sfn /mnt/agent-data/copilot/skills ${HOME}/.copilot/skills \
    \
    # Gemini (add GEMINI.md user instructions file)
    && ln -sfn /mnt/agent-data/gemini/GEMINI.md ${HOME}/.gemini/GEMINI.md \
    \
    # OpenCode data (XDG_DATA_HOME for auth.json)
    && mkdir -p ${HOME}/.local/share/opencode \
    && ln -sfn /mnt/agent-data/local/share/opencode/auth.json ${HOME}/.local/share/opencode/auth.json
```

Note: `~/.config/gh`, `~/.config/opencode`, `~/.config/tmux` are already covered by the existing `~/.config` → `/mnt/agent-data/config` symlink.

---

## Entrypoint Changes (Issue #7)

**Single source of truth**: Entrypoint ensures are derived from SYNC_MAP targets.

The entrypoint MUST ensure all symlink targets exist before the shell starts:

```bash
# Generate from SYNC_MAP targets - must match Dockerfile symlinks exactly
ensure_volume_structure() {
  # Claude Code
  mkdir -p /mnt/agent-data/claude
  [ -f /mnt/agent-data/claude/claude.json ] || echo '{}' > /mnt/agent-data/claude/claude.json
  touch /mnt/agent-data/claude/credentials.json
  [ -f /mnt/agent-data/claude/settings.json ] || echo '{}' > /mnt/agent-data/claude/settings.json
  mkdir -p /mnt/agent-data/claude/plugins
  mkdir -p /mnt/agent-data/claude/skills

  # GitHub CLI
  mkdir -p /mnt/agent-data/config/gh
  chmod 700 /mnt/agent-data/config/gh

  # Copilot (selective files)
  mkdir -p /mnt/agent-data/copilot/skills
  touch /mnt/agent-data/copilot/config.json
  touch /mnt/agent-data/copilot/mcp-config.json

  # OpenCode (auth from data dir)
  mkdir -p /mnt/agent-data/local/share/opencode
  touch /mnt/agent-data/local/share/opencode/auth.json
  chmod 600 /mnt/agent-data/local/share/opencode/auth.json

  # tmux
  mkdir -p /mnt/agent-data/tmux
  touch /mnt/agent-data/tmux/.tmux.conf
  mkdir -p /mnt/agent-data/tmux/.tmux
  mkdir -p /mnt/agent-data/config/tmux

  # Shell
  mkdir -p /mnt/agent-data/shell
  touch /mnt/agent-data/shell/.bash_aliases
  mkdir -p /mnt/agent-data/shell/.bashrc.d

  # VS Code Server
  mkdir -p /mnt/agent-data/vscode-server/extensions
  mkdir -p /mnt/agent-data/vscode-server/data/Machine
  mkdir -p /mnt/agent-data/vscode-server/data/User/mcp
  mkdir -p /mnt/agent-data/vscode-server/data/User/prompts

  # VS Code Insiders
  mkdir -p /mnt/agent-data/vscode-server-insiders/extensions
  mkdir -p /mnt/agent-data/vscode-server-insiders/data/Machine
  mkdir -p /mnt/agent-data/vscode-server-insiders/data/User/mcp
  mkdir -p /mnt/agent-data/vscode-server-insiders/data/User/prompts

  # Gemini (selective files)
  mkdir -p /mnt/agent-data/gemini
  touch /mnt/agent-data/gemini/google_accounts.json
  touch /mnt/agent-data/gemini/oauth_creds.json
  touch /mnt/agent-data/gemini/GEMINI.md
  chmod 600 /mnt/agent-data/gemini/google_accounts.json
  chmod 600 /mnt/agent-data/gemini/oauth_creds.json

  # Codex (selective files)
  mkdir -p /mnt/agent-data/codex/skills
  touch /mnt/agent-data/codex/config.toml
  touch /mnt/agent-data/codex/auth.json
  chmod 600 /mnt/agent-data/codex/auth.json

  # Fix ownership
  chown -R 1000:1000 /mnt/agent-data
}
```

---

## Files to Modify

| File | Changes |
|------|---------|
| [agent-sandbox/sync-agent-plugins.sh](agent-sandbox/sync-agent-plugins.sh) | Replace with SYNC_MAP + rsync pattern; add platform guard; fix copy() for renames; proper dry-run; keep all transforms |
| [agent-sandbox/Dockerfile](agent-sandbox/Dockerfile) | Add symlinks with `ln -sfn` for idempotence; add .bashrc sourcing hooks |
| [agent-sandbox/entrypoint.sh](agent-sandbox/entrypoint.sh) | ensure_volume_structure() derived from SYNC_MAP; enforce secret permissions |

---

## Verification

```bash
# Platform check (should fail on macOS)
[[ "$(uname -s)" == "Darwin" ]] && sync-agent-plugins.sh  # expect error

# True dry run (no volume mutations)
sync-agent-plugins.sh --dry-run
docker run --rm -v sandbox-agent-data:/data eeacms/rsync ls -la /data  # should be unchanged

# Full sync
sync-agent-plugins.sh

# Verify permissions on secrets
docker run --rm -v sandbox-agent-data:/data eeacms/rsync stat -c '%a %n' \
  /data/claude/credentials.json \
  /data/config/gh \
  /data/gemini/oauth_creds.json \
  /data/gemini/google_accounts.json \
  /data/codex/auth.json \
  /data/local/share/opencode/auth.json
# Expect: 600 for files, 700 for dirs

# Inspect volume structure
docker run --rm -v sandbox-agent-data:/data eeacms/rsync ls -laR /data

# Test in container
gh auth status
opencode --version
tmux  # should load config
echo $PATH  # verify .bashrc.d sourced
```
