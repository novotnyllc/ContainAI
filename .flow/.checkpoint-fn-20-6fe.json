{
  "created_at": "2026-01-26T07:38:00.317541Z",
  "epic": {
    "data": {
      "branch_name": "fn-20-6fe",
      "created_at": "2026-01-26T05:13:04.170847Z",
      "depends_on_epics": [],
      "id": "fn-20-6fe",
      "next_task": 1,
      "plan_review_status": "unknown",
      "plan_reviewed_at": "2026-01-26T05:40:38.266853Z",
      "spec_path": ".flow/specs/fn-20-6fe.md",
      "status": "open",
      "title": "Fix Docker-in-Docker runc 1.3.3 incompatibility in sysbox containers",
      "updated_at": "2026-01-26T07:37:53.807735Z"
    },
    "spec": "# Investigate runc 1.3.3 / Sysbox Incompatibility and Produce PRDs\n\n## Problem\n\nDocker run fails inside sysbox containers with error:\n```\nOCI runtime create failed: runc create failed: unable to start container process: \nerror during container init: open sysctl net.ipv4.ip_unprivileged_port_start file: \nunsafe procfs detected: openat2 /proc/./sys/net/ipv4/ip_unprivileged_port_start: \ninvalid cross-device link\n```\n\n## Root Cause (Confirmed via Research)\n\nrunc 1.3.3 added security checks using `openat2()` with `RESOLVE_NO_XDEV` flag to detect \"fake procfs\". This conflicts with sysbox-fs which bind-mounts FUSE-backed files over `/proc/sys/*` paths.\n\n**Key insight**: The fix exists in sysbox master but is **host-side** (sysbox-fs, sysbox-runc). ContainAI can only control the **image-side** (containerd.io package version).\n\n## Scope\n\nThis epic is **investigation and PRD creation only** - NO implementation.\n\n**Deliverables:**\n1. Technical analysis document (`.flow/specs/fn-20-6fe-technical-analysis.md`)\n2. PRD-A: Temporary workaround specification (`.flow/specs/prd-runc-downgrade-workaround.md`)\n3. PRD-B: Proper fix options specification (`.flow/specs/prd-sysbox-dind-fix.md`)\n\n**Out of scope for this epic:**\n- Implementation changes (Dockerfiles, runtime packages, tests)\n- Only docs/spec files are produced\n\n**Allowed in Task 1 investigation:**\n- OS-level artifact inspection (apt package downloads, .deb extraction)\n- Upstream repo cloning for code archaeology\n- No ContainAI image builds or DinD tests\n\n## Ownership Boundary (Critical)\n\n**By Deployment Mode:**\n\n| Component | ContainAI-managed isolated daemon | Docker Desktop / external engine (support TBD) |\n|-----------|-----------------------------------|------------------------------------------------|\n| Host dockerd | `containai-docker` context managed by ContainAI (`src/lib/docker.sh`, `src/lib/setup.sh`) | Docker Inc default context |\n| sysbox-fs, sysbox-runc | Host operator installs, ContainAI setup configures | Docker Inc (bundled in DD) |\n| containerd.io, runc packages | ContainAI image (can pin) | ContainAI image (can pin) |\n| Dockerfile.base/test | ContainAI repo (can modify) | ContainAI repo (can modify) |\n| Inner Docker config | ContainAI image (can configure) | ContainAI image (can configure) |\n\n**Context selection model** (from code analysis - Task 1 to verify):\n- **Inside container**: Uses `default` context (`src/lib/doctor.sh:168-185`)\n- **On host**: Prefers config override \u2192 `containai-docker` \u2192 legacy (`src/lib/doctor.sh:160-224`)\n- **Native Linux**: May use default socket in some paths (`src/lib/doctor.sh:340-343`) - Task 1 to clarify\n\n**Key insight**: ContainAI's intended architecture uses `containai-docker` isolated daemon + context. Docker Desktop ECI/\"docker sandbox\" support status is **TBD** - Task 1 produces this decision based on code evidence.\n\n**ECI Support Status Decision Flow**:\n1. **Task 1** produces \"ECI Support Status (as-of repo commit)\" section with code evidence\n2. Decision question: Is Docker Desktop a **documented and exercised** engine for `cai`? (not just \"could work if user sets override\")\n3. **Tasks 2/3** consume this decision as input - if unsupported, treat ECI as \"external ecosystem context only\"\n4. Evidence to gather: `src/containai.sh:356-371` (sandbox removed), `src/lib/eci.sh` (missing), `src/lib/docker.sh:229-303` (`_cai_docker_desktop_version` - check if called), `src/lib/container.sh:1164-1186` (host flags rejected), `SECURITY.md`/`src/README.md` docs drift\n\n## Key Findings from Research\n\n### The Fix in Sysbox Master (Hypothesis - to be verified in Task 1)\n\nSysbox has implemented a fix using **seccomp syscall interception** (exact mechanism to be verified from code):\n\n1. Trap all `openat2()` syscalls from processes inside sysbox containers\n2. Check if the path is under a sysbox-fs mount (`/proc/sys/*`, etc.)\n3. If yes, strip problematic flags (exact flag set to be quoted from sysbox-fs/sysbox-runc code - do NOT assume specific flags without evidence)\n4. Open the file via nsenter and inject the fd using `SECCOMP_IOCTL_NOTIF_ADDFD`\n\n**This is a host-side fix** - operators must upgrade sysbox; ContainAI cannot ship this.\n\n### ContainAI-Controllable Workaround\n\nPin containerd.io to a version bundling runc < 1.3.3. This is image-side and can be shipped by ContainAI, but has security trade-offs (CVE rollback).\n\n## Quick Commands (for investigation)\n\n```bash\n# Clone repos at immutable refs\nWORKDIR=$(mktemp -d)\ngit clone --depth 1 --branch v1.3.3 https://github.com/opencontainers/runc.git \"$WORKDIR/runc\"\ngit clone https://github.com/nestybox/sysbox-fs.git \"$WORKDIR/sysbox-fs\"\ngit clone https://github.com/nestybox/sysbox-runc.git \"$WORKDIR/sysbox-runc\"\n\n# Find the runc check\ngrep -r \"RESOLVE_NO_XDEV\" \"$WORKDIR/runc/\"\n\n# Find the sysbox fix\ngrep -r \"openat2\" \"$WORKDIR/sysbox-fs/seccomp/\"\n```\n\n## Acceptance\n\n- [ ] Technical analysis document produced with immutable commit refs\n- [ ] **PRD-A produced**: Temporary runc downgrade workaround with formal risk acceptance\n- [ ] **PRD-B produced**: Proper fix options with ownership boundary clarity\n- [ ] No implementation performed in this epic\n\n## References\n\n- [sysbox#973](https://github.com/nestybox/sysbox/issues/973) - Docker 28.5.2 breaks DinD on Sysbox\n- [sysbox#972](https://github.com/nestybox/sysbox/issues/972) - Original bug report (closed)\n- [runc#4968](https://github.com/opencontainers/runc/issues/4968) - AppArmor/LXC related issues\n- [runc v1.3.3](https://github.com/opencontainers/runc/releases/tag/v1.3.3) - Release with security patches\n"
  },
  "epic_id": "fn-20-6fe",
  "schema_version": 2,
  "tasks": [
    {
      "data": {
        "assignee": null,
        "claim_note": "",
        "claimed_at": null,
        "created_at": "2026-01-26T05:13:39.868952Z",
        "depends_on": [],
        "epic": "fn-20-6fe",
        "id": "fn-20-6fe.1",
        "priority": null,
        "spec_path": ".flow/tasks/fn-20-6fe.1.md",
        "status": "todo",
        "title": "Investigate runc/sysbox fix mechanism",
        "updated_at": "2026-01-26T07:37:53.877057Z"
      },
      "id": "fn-20-6fe.1",
      "runtime": null,
      "spec": "# fn-20-6fe.1 Investigate runc/sysbox fix mechanism\n\n## Description\n\nClone sysbox (main repo), sysbox-fs, sysbox-runc, and runc repositories at specific commits. Analyze the fix mechanism and produce technical findings to inform both PRD-A and PRD-B.\n\n**Size:** M (scope includes code archaeology, package mapping, CVE research, and sysctl tracing)\n**Files:**\n- `.flow/specs/fn-20-6fe-technical-analysis.md` (new file - research artifact)\n\n## Approach\n\n1. Clone repositories and record immutable refs:\n   ```bash\n   WORKDIR=$(mktemp -d)\n   DATE=$(date -u +%Y-%m-%dT%H:%M:%SZ)\n\n   # Record ContainAI repo commit for file:line evidence anchoring\n   CONTAINAI_SHA=$(cd /home/agent/workspace && git rev-parse HEAD)\n   echo \"containai: $(pwd) @ $CONTAINAI_SHA retrieved $DATE\"\n\n   # runc at specific tag\n   git clone --depth 1 --branch v1.3.3 https://github.com/opencontainers/runc.git \"$WORKDIR/runc\"\n   RUNC_SHA=$(cd \"$WORKDIR/runc\" && git rev-parse HEAD)\n\n   # sysbox repos: clone with sparse-checkout, fetch tags for release mapping\n   # Note: If fix or version mapping is outside these paths, expand sparse-checkout or do full clone\n   git clone --filter=blob:none --sparse https://github.com/nestybox/sysbox.git \"$WORKDIR/sysbox\"\n   cd \"$WORKDIR/sysbox\" && git sparse-checkout set Makefile go.mod && git fetch --tags\n   SYSBOX_SHA=$(git rev-parse HEAD)\n\n   git clone --filter=blob:none --sparse https://github.com/nestybox/sysbox-fs.git \"$WORKDIR/sysbox-fs\"\n   cd \"$WORKDIR/sysbox-fs\" && git sparse-checkout set seccomp && git fetch --tags\n   SYSBOX_FS_SHA=$(git rev-parse HEAD)\n\n   git clone --filter=blob:none --sparse https://github.com/nestybox/sysbox-runc.git \"$WORKDIR/sysbox-runc\"\n   cd \"$WORKDIR/sysbox-runc\" && git sparse-checkout set libcontainer && git fetch --tags\n   SYSBOX_RUNC_SHA=$(git rev-parse HEAD)\n\n   # Record as canonical anchor: URL + SHA + retrieval date\n   echo \"runc: https://github.com/opencontainers/runc.git @ $RUNC_SHA (v1.3.3) retrieved $DATE\"\n   echo \"sysbox: https://github.com/nestybox/sysbox.git @ $SYSBOX_SHA retrieved $DATE\"\n   echo \"sysbox-fs: https://github.com/nestybox/sysbox-fs.git @ $SYSBOX_FS_SHA retrieved $DATE\"\n   echo \"sysbox-runc: https://github.com/nestybox/sysbox-runc.git @ $SYSBOX_RUNC_SHA retrieved $DATE\"\n   ```\n   - **Immutable ref definition**: URL + `git rev-parse HEAD` + retrieval date = canonical anchor\n   - **ContainAI repo anchoring**: Record repo commit SHA for all file:line evidence references\n   - **Sparse-checkout fallback**: If `rg openat2` or seccomp-notify plumbing isn't visible in sparse paths, expand checkout (or do full clone) and document which expansions were needed\n   - **Rescue snippet** (if tag checkout fails due to shallow/sparse): `git fetch origin tag <tag> --no-tags && git checkout <tag>` or switch to full clone\n\n2. Locate and document the runc security check:\n   - Find `RESOLVE_NO_XDEV` usage in filepath-securejoin vendored code\n   - Document the exact vendored file/function that emits \"unsafe procfs detected\" (record resolved path after cloning)\n   - Identify what triggers the error\n   - Record the resolved runc v1.3.3 commit SHA\n   - **Note**: Tag SHA is sufficient for documentation; we will NOT identify the specific introducing commit (would require full history fetch)\n\n3. Locate and document the sysbox fix:\n   - Find `openat2` trap configuration in sysbox-runc\n   - Analyze seccomp handler in sysbox-fs\n   - Record specific commit SHAs that contain the fix\n   - Document the seccomp interception mechanism (SECCOMP_IOCTL_NOTIF_ADDFD)\n   - **Flag stripping logic (to be verified in code)**: Quote the exact mask/logic from referenced sysbox-fs/sysbox-runc commits; do NOT pre-state the flag set (e.g., `RESOLVE_NO_XDEV | RESOLVE_NO_MAGICLINKS | ...`) as fact without code evidence\n   - **Cross-reference procedure for minimum release version**:\n     - Hierarchy of authority: release tag \u2192 sysbox repo manifest (submodules/Makefile/go.mod) \u2192 release artifacts metadata\n     - Identify how sysbox-fs/sysbox-runc versions are pinned per release\n     - If repos aren't cleanly version-pinned: document as \"cannot be derived; requires upstream confirmation\" with evidence gathered\n\n4. **Runtime path verification** (critical for PRD-A validity):\n   - **Distinguish THREE dockerd/runc loci** (avoid conflation):\n     1. **Outer runtime (host)**: sysbox-runc on host that runs the ContainAI sandbox container (host operator controls)\n     2. **Inner dockerd (in-image)**: `dockerd` inside the image uses runc from `docker-ce`/`containerd.io` packages in `src/container/Dockerfile.base` - **this is what PRD-A workaround affects**\n     3. **ContainAI-managed host dockerd**: `src/lib/docker.sh` defines `/opt/containai/...` bundle + `containai-docker.service` - **this is NOT the same as (2)**\n   - **Context selection nuances** (document each):\n     - **Inside container**: Uses `default` context (`src/lib/doctor.sh:168-185`) - agent inside sandbox talks to inner dockerd via `/var/run/docker.sock`\n     - **On host**: Prefers config override \u2192 `containai-docker` \u2192 legacy (`src/lib/doctor.sh:160-224`)\n     - **Native Linux socket**: `_cai_sysbox_available()` notes native Linux \"currently uses default socket\" (`src/lib/doctor.sh:340-343`) - verify actual socket/context used\n   - **Subsection: Which dockerd does the agent actually use by default?**\n     - Check `src/lib/container.sh` for context selection logic (`_containai_resolve_secure_engine_context` \u2192 `_cai_select_context`)\n     - Check `src/lib/doctor.sh` for `_cai_select_context` call chain (around line 202+)\n     - Check `src/lib/docker.sh` for `_cai_expected_docker_host` semantics (nested/container returns `unix:///var/run/docker.sock`)\n     - Document service units and env defaults\n     - **Native Linux socket verification**: Confirm what socket/context is actually used on native Linux today (evidence from code + config generation)\n     - **Scope PRD-A to the inner dockerd (2) failure mode only**\n   - **Image artifact inspection** (exhaustive, repo artifacts only):\n     - `src/container/Dockerfile.base:151-172`: Docker stack installation - does NOT copy daemon.json\n     - `src/container/Dockerfile.base:315-316`: Check ENTRYPOINT/CMD - uses systemd as PID1 (NOT entrypoint.sh)\n     - `src/container/Dockerfile.sdks`: Inherits from base - verify no daemon.json override, no entrypoint change\n     - `src/container/Dockerfile.agents`: Inherits from sdks - verify no daemon.json override, check for containai-init.service\n     - `src/container/Dockerfile.test:84-90`: Copies `src/configs/daemon-test.json` - verify this configures sysbox-runc\n     - `src/configs/daemon.json`: **Verify unused by image builds** - grep all Dockerfiles for references; document separately that host setup generates `/etc/containai/docker/daemon.json` independently (`src/lib/setup.sh:2344`)\n     - `src/configs/daemon-test.json`: Copied into Dockerfile.test only - check runtime configuration\n     - `src/container/entrypoint.sh`: **Gate first**: Is this file used by shipped images? If Dockerfile.base uses systemd, entrypoint.sh analysis may be irrelevant to base image inner dockerd\n     - `src/services/docker.service.d/containai.conf`: Systemd drop-in - check if it configures runtime\n     - **Confirm sysbox-runc binary existence** in base layer: grep Dockerfiles for sysbox package install\n   - **Output format: Inner dockerd runtime configuration evidence table**:\n     | File | Line | Evidence | Implication |\n     |------|------|----------|-------------|\n     | src/container/Dockerfile.base | 151-172 | Docker stack install, no sysbox | Inner uses default runc |\n     | src/container/Dockerfile.base | 315-316 | systemd entrypoint | entrypoint.sh not used |\n     | src/configs/daemon.json | N/A | grep shows 0 references in Dockerfiles | Unused |\n     | src/container/Dockerfile.test | 87 | copies daemon-test.json | Test image uses sysbox-runc |\n     - PRD-A references this table verbatim\n   - **Determine who provides `/usr/bin/runc` in the image** (artifact-based only):\n     - Method: Download .deb packages and inspect contents with `dpkg-deb -c`\n     - **Inspect ALL relevant .debs**: `containerd.io`, `docker-ce`, any standalone `runc` package\n     - Document whether `runc` comes from `containerd.io` bundle or a separate package\n     - Check `docker-ce` dependency constraints via control metadata\n     - **Do NOT use runtime container commands** - use .deb inspection only\n   - **Conclusion required per image** (evidence-backed statements):\n     - ContainAI base image (`Dockerfile.base`): Inner dockerd uses default runc from containerd.io; NO sysbox-ce installed; `src/configs/daemon.json` exists but is NOT copied\n     - ContainAI sdks/agents images: Inherit from base, no daemon.json override (verify)\n     - ContainAI test image (`Dockerfile.test`): Copies `daemon-test.json` which configures sysbox-runc + installs sysbox-ce 0.6.7\n   - **Note**: PRD-A only affects scenario (2) inner dockerd with default runc; if inner runtime is sysbox-runc (test image), pinning `containerd.io` won't help\n\n5. Clarify ownership boundaries by deployment mode + **ECI support status decision**:\n   - **ContainAI-managed isolated daemon mode (default)**: `containai-docker` context, sysbox runtime\n   - **Docker Desktop ECI Mode - SUPPORT STATUS DECISION REQUIRED**:\n     - **Decision question**: Is Docker Desktop a **documented and exercised** engine for `cai`? (not just \"could work if user sets override\")\n     - **Evidence to gather from codebase** (exhaustive list):\n       - Check `src/containai.sh` for sandbox command status\n       - Check if `src/lib/eci.sh` exists\n       - Check `src/lib/doctor.sh` for `_cai_select_context` - does it ever select default context on host?\n       - Check `src/lib/docker.sh` for Docker Desktop detection (`_cai_docker_desktop_version`) - is it called anywhere?\n       - Check `src/lib/container.sh:1237-1255` for config override mechanism\n       - Check `SECURITY.md` for ECI references and cross-reference with actual code\n       - Check `src/README.md` for ECI/sandbox documentation vs code reality\n       - Check `src/lib/container.sh` for `--allow-host-credentials` and `--allow-host-docker-socket` handling\n       - Check if `cai setup` defaults ever target Docker Desktop\n     - **Expected findings** (verify and document with file paths + line numbers):\n       - `src/containai.sh:356-371`: \"sandbox command removed, now uses Sysbox\"\n       - `src/lib/eci.sh`: File does not exist\n       - `src/lib/doctor.sh:168-185`: Inside container uses `default` context (inner dockerd)\n       - `src/lib/doctor.sh:160-224`: On host, prefers config override \u2192 `containai-docker` \u2192 legacy\n       - `src/lib/docker.sh:229-303`: `_cai_docker_desktop_version` defined but **verify if called** - if unused, this is strong evidence ECI is unimplemented\n       - `SECURITY.md:25,134`: References `src/lib/eci.sh` which doesn't exist\n       - `src/README.md:44-52,145-146`: Documents Docker sandbox/ECI but CLI removed sandbox command\n       - `src/lib/container.sh:1164-1186`: `--allow-host-credentials` and `--allow-host-docker-socket` are rejected as \"no longer supported\"\n     - **Output**: Produce \"ECI Support Status (as-of repo commit)\" section with:\n       - Commit SHA or date of analysis\n       - Code evidence (file:line references)\n       - Verdict: \"unsupported\" or \"supported\" based on evidence\n     - **Hard decision rule**: \"ECI supported\" ONLY IF:\n       1. `cai setup` or defaults actively target Docker Desktop, OR\n       2. Code paths actively use Docker Desktop/ECI features (not just \"could work if user sets config override\")\n       - If `_cai_docker_desktop_version` is defined but never called: strong evidence ECI is unimplemented\n       - Config override allowing arbitrary context \u2260 ECI being \"supported\" (user can override many things)\n     - **Decision for PRDs**: If ECI is unsupported, PRD-A/PRD-B treat it as \"external ecosystem context only\" (not a supported deployment target)\n   - **Image-side (ContainAI-controlled)**: containerd.io/runc packages in Dockerfile\n\n6. Investigate the sysctl OCI spec source (local-first, then version-anchored upstream):\n   - **Proof standard**: To claim a source, must cite exact file/function at an anchored upstream tag; anything else is hypothesis\n   - **Known challenge**: This repo contains no reference to `net.ipv4.ip_unprivileged_port_start`; pure static tracing may be inconclusive\n   - **Step 1: Search this repo first** for sysctl injection points:\n     - `src/lib/setup.sh` (host daemon config generation - NOT inner Docker config)\n     - `src/configs/daemon.json`, `src/configs/daemon-test.json`\n     - Check if Dockerfiles copy any daemon.json with sysctl config\n     - Check for `--sysctl` flags in container run commands (`src/lib/container.sh`)\n   - **Step 2: Record and anchor image package versions** (by Git commit where possible):\n     - Method: `apt-cache policy docker-ce containerd.io` in ubuntu:24.04 with Docker apt repo configured\n     - For version \u2192 commit anchoring: check package metadata/changelogs for Git commit IDs\n     - Map Docker Engine version to Moby release tag (note: packaging revisions may differ - mark as \"best-effort\")\n     - **Fallback**: If 1:1 mapping not possible, search sysctl name across candidate tags\n   - **Step 3: Upstream source trace at anchored versions**:\n     - moby/moby at specific tag: `daemon/oci_linux.go`, `oci/defaults.go`, `daemon/config/config.go`\n     - containerd at specific tag: `pkg/oci/spec.go`, `oci/spec_opts.go`\n     - sysbox: `libsysbox/syscont/spec.go`, sysbox documentation\n   - **Hard stop (early exit)**: If not provable from pinned upstream tags within investigation scope:\n     - Document as \"hypothesis: likely injected by [component] based on [partial evidence]\"\n     - Specify the smallest future runtime probe needed: e.g., \"run container, inspect OCI spec via `ctr` or `runc spec`\"\n     - PRDs must treat this as unverified and not make claims requiring this knowledge\n\n7. Document Docker stack \u2192 runc version mapping (artifact-based):\n   - **Scope**: This analysis is for **Ubuntu 24.04 (noble) only**; other codenames require separate verification\n   - **Prerequisite**: Configure Docker apt repo for Ubuntu 24.04 (noble) **exactly matching `Dockerfile.base:151-166`**:\n     ```bash\n     # Add Docker GPG key and repo (exact Dockerfile.base pattern)\n     install -m 0755 -d /etc/apt/keyrings\n     curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc\n     chmod a+r /etc/apt/keyrings/docker.asc\n     echo \"deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu noble stable\" > /etc/apt/sources.list.d/docker.list\n     apt-get update\n     ```\n   - **Clarification on artifact inspection**: No ContainAI/DinD reproduction; offline artifact inspection allowed (including throwaway Ubuntu env for apt/dpkg operations)\n   - **Inspect ALL installed .debs relevant to runc provenance** (not just containerd.io):\n     - `containerd.io`: Primary candidate for bundled runc\n     - `docker-ce`: Check dependency constraints and whether it ships runc\n     - Any standalone `runc` package if present\n   - **Determine from step 4**: Is `runc` bundled in `containerd.io` or a separate package?\n   - **If bundled in containerd.io**:\n     - Download .deb packages and inspect embedded runc binary version\n     - Version selection: first bundling runc >= 1.3.3 (broken), immediately previous (candidate-good), one older fallback\n     - **Also verify docker-ce dependency constraints** via control metadata to ensure pin is consistent\n   - **If separate runc package**:\n     - Document that both `containerd.io` AND `runc` must be pinned\n     - Map both packages to safe versions\n   - Steps:\n     - List available versions: `apt-cache policy containerd.io docker-ce`\n     - Download .debs: `apt download containerd.io=<version> docker-ce=<version>`\n     - Extract: `dpkg-deb -x <pkg>.deb ./extracted`\n     - Check runc version (prefer non-exec inspection to avoid cross-arch issues):\n       1. **Primary**: `dpkg-deb -f <pkg>.deb | grep Version` or package changelog\n       2. **Secondary**: `strings ./extracted/usr/bin/runc | grep -E '^[0-9]+\\.[0-9]+\\.[0-9]+'` or `go tool buildinfo` if available\n       3. **Optional/best-effort**: `./extracted/usr/bin/runc --version` (may fail cross-arch)\n     - **Check control metadata**: `dpkg-deb -I <pkg>.deb` to verify dependency constraints\n   - Record: package URL, SHA256 of .deb, extracted runc version string, dependency constraints\n   - **Multi-architecture requirement**: Map versions for both `amd64` AND `arm64` since container images are built multi-arch; or explicitly document single-arch limitation if not feasible\n   - **APT pruning contingency workflow** (if older versions unavailable via apt indices):\n     1. Stop at \"candidate pins unknown via apt\"\n     2. **Direct pool URL discovery** (concrete method):\n        - Download apt `Packages` index: `curl https://download.docker.com/linux/ubuntu/dists/noble/stable/binary-amd64/Packages`\n        - Grep for target package version to get `Filename:` field (e.g., `pool/stable/amd64/containerd.io_<version>_amd64.deb`)\n        - Construct full URL: `https://download.docker.com/linux/ubuntu/<Filename>`\n        - Repeat for arm64: `dists/noble/stable/binary-arm64/Packages`\n     3. If pool URLs found: download directly, verify SHA256, proceed with analysis\n     4. If pool URLs NOT found: document \"cannot locate via apt indices or pool; requires vendor assistance or alternative source\"\n     5. **Immutable anchor requirement**: For any pinned artifact, capture SHA256 + full download URL as the real anchor\n     6. PRD-A must specify: \"pin by SHA256-verified .deb from direct pool URL\" or require security/platform review before choosing any downgrade\n\n8. Extract CVE/security advisory data (narrowed scope):\n   - **Step 1: Record current baseline** (date + package versions from `apt-cache policy` with Docker repo configured)\n   - **Step 2: Define proposed pin versions** (from step 7)\n   - **Step 3: CVE set filtered by impact class**:\n     - **Primary filter**: Impact class (container-escape, privilege-escalation, arbitrary code execution) - include ALL advisories in these classes regardless of CVSS\n     - **Secondary filter**: High/Critical severity for other impact classes\n     - **Primary focus**: CVEs explicitly fixed by runc \u22651.3.3 (the driver for the downgrade decision)\n     - **Secondary**: Any *forced* engine/containerd downgrades required for dependency consistency\n   - **Note what's excluded**: Document any Medium-severity CVEs excluded and why (not in escape/priv-esc class)\n   - Record: CVE ID, severity (CVSS), impact class, affected versions, fix version, component, source (link)\n   - **Output format**: \"Baseline as of YYYY-MM-DD + exact resolved package versions\" vs proposed delta\n   - **Gate**: If data can't be obtained reliably, gate implementation on security review\n\n9. Build environment/reproduction matrix (observed/reported outcomes):\n   - **Scope**: Based on upstream issue reports and observed behavior, NOT runtime testing\n   - **Mandatory rows** (keyed by ContainAI repo artifacts):\n     - ContainAI base image (`src/container/Dockerfile.base`): inner runtime = default runc\n     - ContainAI test image (`src/container/Dockerfile.test` + sysbox-ce 0.6.7): inner runtime = sysbox-runc\n   - **Additional columns**: Deployment mode (Sysbox/ECI), Host sysbox version, Inner dockerd version, Inner runc version\n   - **Outcome column**: \"reported fail\", \"reported success\", \"unknown\"\n   - **Confidence + source**: issue link, build date, or \"inferred from code\"\n   - **Conflict resolution**: If sources conflict, document both with confidence levels\n   - Reference upstream issues: sysbox#973, sysbox#972, runc#4968\n\n10. Document docs drift (first-class section in technical analysis):\n    - **Impact on decision-making**: What the code actually does today vs what docs claim\n    - **Drift items to verify** (gather evidence for each):\n      - **Verify**: Does `SECURITY.md` reference `src/lib/eci.sh`? Does that file exist? Record actual line numbers and grep output.\n      - **Verify**: Does `src/README.md` claim sysbox or sysbox-runc is default? What does `Dockerfile.base` actually install? Record grep output.\n      - **Verify**: What does `src/containai.sh` sandbox command handler say? What do `SECURITY.md` and `src/README.md` say about ECI/sandbox?\n      - **Verify**: Does `src/lib/doctor.sh` contain ECI-specific detection code? (grep for \"eci\", \"ECI\", \"enhanced container\")\n    - **Output format**: For each drift item, record:\n      - File + line number\n      - Actual content (quoted)\n      - Expected vs actual behavior\n    - PRDs must cite code paths as source of truth, not docs\n    - This drift materially affects \"deployment mode\" taxonomy and ownership boundaries in both PRDs\n\n11. Produce technical analysis document at `.flow/specs/fn-20-6fe-technical-analysis.md`\n\n## Key context\n\n- This is research only - no ContainAI code/runtime changes; networked research (cloning, apt downloads, CVE lookups) is allowed; no integration tests\n- Pin analysis to immutable refs with recorded SHAs (after sparse-checkout fetch)\n- Technical analysis will be referenced by both PRD-A and PRD-B\n- Treat version predictions as hypotheses, not facts\n- **PRD-A validity depends on step 4**: If inner runtime is sysbox-runc (not image runc), PRD-A workaround may be ineffective for that scenario\n- **Decision rule**: If mapping can't conclusively identify a safe version, document a *candidate* pin with explicit \"requires validation\" gate\n\n## Acceptance\n\n- [ ] **ContainAI repo anchored**: Repo commit SHA recorded in technical analysis header for file:line evidence consistency\n- [ ] **Upstream repos cloned**: Immutable refs recorded (URL + `git rev-parse HEAD` + retrieval date); sparse-checkout expansions documented if needed\n- [ ] runc security check documented (resolved vendored file path, function, flags, error condition; tag SHA sufficient, no introducing commit needed)\n- [ ] sysbox fix mechanism documented (seccomp trap, fd injection); flag stripping logic quoted from code (not pre-stated)\n- [ ] Sysbox fix cross-referenced with release manifest using defined hierarchy (or documented as \"cannot be derived; requires upstream confirmation\" with evidence gathered)\n- [ ] **Runtime path verified**:\n  - THREE dockerd/runc loci distinguished (outer host, inner in-image, containai-managed)\n  - Per-image conclusions (base, sdks, agents, test) with evidence-backed statements citing file:line\n  - Explicit documentation that `src/configs/daemon.json` is NOT copied into Dockerfile.base\n  - `/usr/bin/runc` provider documented via .deb inspection (containerd.io + docker-ce + any standalone runc)\n- [ ] **ECI Support Status section produced** with commit SHA, code evidence (file:line refs), hard decision rule applied (detection + UX integration), and verdict (deprecated/unsupported or supported)\n- [ ] Ownership boundary clarified by deployment mode, PRD-A/PRD-B to consume ECI decision as input\n- [ ] Sysctl OCI spec source traced with proof standard (exact file/function at anchored tag), or hard-stop with hypothesis + smallest runtime probe specified\n- [ ] Docker stack \u2192 runc version mapping (Ubuntu 24.04/noble): Both amd64 AND arm64 mapped with SHA256 + pool URLs; or single-arch with explicit limitation documented\n- [ ] CVE/security advisory data extracted filtered by impact class (escape/priv-esc = all; others = High/Critical), or gated on security review if data unavailable\n- [ ] Environment/reproduction matrix with mandatory ContainAI image rows\n- [ ] Docs drift documented as first-class section with verified evidence (file paths, line numbers, grep output) including `src/README.md:279` claim\n- [ ] Technical analysis document created at `.flow/specs/fn-20-6fe-technical-analysis.md`\n\n## Done summary\nTBD\n\n## Evidence\n- Commits:\n- Tests:\n- PRs:\n"
    },
    {
      "data": {
        "assignee": null,
        "claim_note": "",
        "claimed_at": null,
        "created_at": "2026-01-26T05:13:39.948042Z",
        "depends_on": [
          "fn-20-6fe.1"
        ],
        "epic": "fn-20-6fe",
        "id": "fn-20-6fe.2",
        "priority": null,
        "spec_path": ".flow/tasks/fn-20-6fe.2.md",
        "status": "todo",
        "title": "Write PRD-A: Temporary runc downgrade workaround",
        "updated_at": "2026-01-26T07:37:53.947097Z"
      },
      "id": "fn-20-6fe.2",
      "runtime": null,
      "spec": "# fn-20-6fe.2 Write PRD-A: Temporary runc downgrade workaround\n\n## Description\n\nWrite PRD-A: A Product Requirements Document for the temporary containerd.io/runc downgrade workaround. This is a specification document only - no implementation.\n\n**Size:** S\n**Files:**\n- `.flow/specs/prd-runc-downgrade-workaround.md` (new file)\n\n## Approach\n\nWrite a comprehensive PRD covering:\n\n1. **Executive Summary**\n   - Problem statement\n   - Proposed temporary solution (image-side containerd.io pin)\n   - Time-boxed nature of workaround\n   - Explicit scope: ContainAI-controlled changes only\n   - **Applicability decision tree** (from Task 1 step 4):\n     ```\n     Is inner dockerd runtime = default runc (from containerd.io)?\n       YES \u2192 PRD-A applicable (pinning containerd.io changes runc version)\n       NO (inner runtime = sysbox-runc or other) \u2192 PRD-A NOT applicable for this scenario\n     ```\n   - **Per-image applicability** (verify via Task 1 with evidence-backed statements):\n     - `Dockerfile.base`: Expected applicable (cite `src/container/Dockerfile.base:151` - no sysbox-ce, default runc)\n     - `Dockerfile.sdks`: Inherits from base - same applicability\n     - `Dockerfile.agents`: Inherits from sdks - same applicability (verify no daemon.json override)\n     - `Dockerfile.test`: Expected NOT applicable (cite `src/container/Dockerfile.test:60`, `src/configs/daemon-test.json:1` - sysbox-runc)\n     - **Note drift**: `src/README.md:279` claims main image includes sysbox with sysbox-runc default - document as drift if code contradicts\n   - **Gating note**: If Task 1 reveals different runtime configuration than expected, revise applicability\n\n2. **Technical Background**\n   - Reference fn-20-6fe-technical-analysis.md for details\n   - How containerd.io version affects runc version (use mapping table from Task 1)\n   - Why this is a workaround, not a fix\n   - Ownership boundary: host-side vs image-side\n   - **Runtime path verification summary** (from Task 1 step 4)\n\n3. **Proposed Changes**\n   - Exact containerd.io version to pin (from Task 1 mapping table, or \"candidate TBD\" if unavailable)\n   - **Determine runc packaging** (from Task 1 step 4):\n     - If runc bundled in containerd.io: pin containerd.io controls runc\n     - If runc is separate package: must pin both containerd.io AND runc\n   - **Full pin set** (enumerate all packages from `src/container/Dockerfile.base`):\n     - docker-ce\n     - docker-ce-cli\n     - containerd.io\n     - docker-buildx-plugin\n     - docker-compose-plugin\n     - runc (if separate package - verify from Task 1)\n   - **APT dependency consistency proof**:\n     - Use `apt-get install --dry-run package=version ...` to verify pin set resolves\n     - Document for Ubuntu 24.04 (noble)\n   - Dockerfile changes: pin versions explicitly in `apt-get install` command\n   - Failure mode if APT repo prunes older versions (document archived pool/snapshot fallback)\n   - **Fallback plan** if candidate version is unvalidated: gate implementation behind runtime validation\n\n4. **Security Trade-offs** (Formal Risk Acceptance)\n   - **Baseline vs Proposed CVE delta** (from Task 1):\n     - runc CVEs between baseline and proposed\n     - containerd CVEs between baseline and proposed\n     - docker-ce CVEs between baseline and proposed\n     - Per-component security delta sources (release notes, GHSA, NVD)\n   - Trust boundaries affected:\n     - Host (protected by sysbox userns)\n     - Sysbox container (agent workspace, secrets, build artifacts)\n     - Inner containers\n   - **Compensating controls** (validated against actual codebase):\n     - Source of truth: `src/lib/container.sh`, `src/lib/doctor.sh`, `src/README.md`\n     - Always-on controls (verify against code):\n       - Sysbox user namespace isolation\n       - Isolation availability check before container start (`src/lib/doctor.sh`)\n       - Fail-closed on unknown errors (`src/lib/container.sh`)\n     - **Removed/unsupported security bypasses** (from Task 1 step 5 evidence):\n       - `--allow-host-credentials` and `--allow-host-docker-socket` are **rejected as \"no longer supported\"** per `src/lib/container.sh:1164-1186`\n       - Classify these as compensating controls: downgrade risk is partially offset by removal of host credential/socket mounting\n       - Note: `SECURITY.md:64` is misleading (says \"ECI-only features\") - document this as docs drift\n     - **Docs drift subsection** (from Task 1 step 10):\n       - List mismatches between `SECURITY.md`/`src/README.md` and actual code paths\n       - Include verified evidence from Task 1 (file paths, line numbers, grep output)\n       - Treat code as source of truth, document drift for future doc fixes\n   - **Risk acceptance signoff template** (include in PRD):\n     ```\n     ## Risk Acceptance Signoff\n\n     **Decision**: Accept/Reject temporary CVE rollback\n     **Reviewer roles required**: Security Lead, Platform Lead\n     **Criteria for acceptance**:\n       - [ ] Compensating controls documented and verified against code\n       - [ ] Exit criteria defined with specific version gates\n       - [ ] Monitoring/alerting for sysbox releases in place\n       - [ ] Pin set APT dependency consistency verified\n       - [ ] Runtime path verification confirms PRD-A validity\n     **Expiry**: This acceptance expires when exit criteria are met or after 90 days (whichever is first)\n     **Signatures**:\n       - Security Lead: __________ Date: __________\n       - Platform Lead: __________ Date: __________\n     ```\n\n5. **Implementation Scope** (for future implementation epic)\n   - Files to modify: `src/container/Dockerfile.base`\n   - Testing requirements\n   - Rollout procedure\n\n6. **Exit Criteria**\n   - When to remove the workaround (by deployment mode):\n     - **Linux Sysbox Mode**: Sysbox release containing fix (commit SHAs from Task 1)\n     - **Docker Desktop ECI Mode**: Docker Desktop release incorporating the fix\n   - Tracking mechanism (sysbox issue, specific version gates)\n   - Upgrade path\n\n## Key context\n\n- PRDs are specification documents, not implementation code\n- Security trade-offs require formal risk acceptance framework\n- Compatibility matrix must account for Ubuntu codename/arch (Ubuntu 24.04 / noble)\n- Use data from Task 1 technical analysis document\n- Pin set must be APT dependency-consistent\n- **Compensating controls must be validated against code, not just SECURITY.md**\n- **ECI support status**: Consume Task 1's \"ECI Support Status\" section as input - do NOT pre-assume deprecated/supported\n\n## Acceptance\n\n- [ ] PRD-A created at `.flow/specs/prd-runc-downgrade-workaround.md`\n- [ ] **Applicability decision tree documented** with per-image conclusions (base/sdks/agents = applicable; test = NOT applicable)\n- [ ] Executive summary clearly states temporary nature and scope\n- [ ] Technical background references technical analysis document including runtime path verification\n- [ ] Proposed changes include:\n  - Specific version (from Task 1) or \"candidate TBD with validation gate\" if unavailable\n  - Full pin set enumerated (5-6 packages depending on runc packaging)\n  - APT dependency consistency proof mechanism\n  - Fallback plan if version is unvalidated\n- [ ] Security trade-offs section includes:\n  - Baseline-vs-proposed CVE delta for all components, OR \"Security review required\" section with explicit unknowns + required next probes if data unavailable (mirrors Task 1 gating)\n  - Trust boundary analysis\n  - Compensating controls validated against code (not just SECURITY.md) with docs drift subsection using verified evidence\n  - Risk acceptance signoff template with roles, criteria, and expiry\n- [ ] Implementation scope defined for future implementation epic\n- [ ] Clear exit criteria with version gates by deployment mode (Sysbox vs ECI as external context)\n- [ ] No implementation performed - PRD only\n\n## Done summary\nTBD\n\n## Evidence\n- Commits:\n- Tests:\n- PRs:\n"
    },
    {
      "data": {
        "assignee": null,
        "claim_note": "",
        "claimed_at": null,
        "created_at": "2026-01-26T05:13:40.023596Z",
        "depends_on": [
          "fn-20-6fe.2"
        ],
        "epic": "fn-20-6fe",
        "id": "fn-20-6fe.3",
        "priority": null,
        "spec_path": ".flow/tasks/fn-20-6fe.3.md",
        "status": "todo",
        "title": "Write PRD-B: Sysbox host-side fix options",
        "updated_at": "2026-01-26T07:37:54.017913Z"
      },
      "id": "fn-20-6fe.3",
      "runtime": null,
      "spec": "# fn-20-6fe.3 Write PRD-B: Sysbox host-side fix options\n\n## Description\n\nWrite PRD-B: A Product Requirements Document for the proper fix options. This is a specification document only - no implementation.\n\n**Size:** S\n**Files:**\n- `.flow/specs/prd-sysbox-dind-fix.md` (new file)\n\n## Approach\n\nWrite a comprehensive PRD covering:\n\n1. **Executive Summary**\n   - Problem statement\n   - Available fix options with clear ownership boundaries by deployment mode\n   - Recommended approach\n\n2. **Technical Analysis**\n   - Reference fn-20-6fe-technical-analysis.md for details\n   - How sysbox-fs virtualizes /proc (bind mounts FUSE over procfs)\n   - How runc's security check works (openat2 + RESOLVE_NO_XDEV)\n   - Why the conflict occurs (cross-device detection)\n   - Specific commit SHAs from technical analysis\n\n3. **Ownership Boundary Clarification by Deployment Mode**\n   - **Linux Sysbox Mode**:\n     - Operator-controlled: sysbox-fs, sysbox-runc upgrade\n     - ContainAI-controlled: containerd.io pin, Dockerfile\n   - **Docker Desktop ECI Mode**:\n     - Docker Inc-controlled: Sysbox components bundled in Docker Desktop\n     - Operator cannot independently upgrade sysbox\n     - ContainAI-controlled: containerd.io pin, Dockerfile\n   - Which options ContainAI can ship vs which require operator/vendor action\n\n4. **Fix Options Evaluated**\n\n   **Option A: Wait for Sysbox Release** (varies by deployment mode)\n   - **Linux Sysbox Mode**: Operator upgrades sysbox when release is available\n     - Pros: No effort, officially supported\n     - Cons: Unknown timeline, dependency on upstream\n     - Version gate: Sysbox release containing fix commits (SHAs from Task 1)\n     - Action: Track sysbox releases, document minimum version\n   - **Docker Desktop ECI Mode**: Wait for Docker Desktop update\n     - Pros: No operator effort\n     - Cons: Depends on Docker Inc release cadence, no direct control\n     - Action: Track Docker Desktop releases\n   - Hypothesis status: Treat version numbers as hypotheses until confirmed\n\n   **Option B: Build Sysbox from Source** (Linux Sysbox Mode only)\n   - Pros: Immediate fix, proven code\n   - Cons: Maintenance burden, not released, supply-chain risk\n   - Required commits: [specific SHAs from technical analysis]\n   - Risk: Untested, potential regressions\n   - Not applicable to ECI Mode\n\n   **Option C: Contribute Fix Upstream** (community action)\n   - Pros: Benefits community\n   - Cons: Time to contribute and merge\n   - Scope: What testing/documentation would be required?\n\n   **Option D: Alternative Workarounds**\n   - AppArmor profile (different error variant - LXC/Proxmox only, not sysbox)\n   - Configure inner Docker to avoid requesting the sysctl (based on Task 1 sysctl source analysis)\n     - If sysbox injects the sysctl: document sysbox configuration option if available\n     - If moby/containerd defaults: document how to override\n   - Sysbox configuration options (if any exist)\n\n5. **Recommendation**\n   - Primary: [based on analysis, respecting ownership boundaries by deployment mode]\n   - Secondary: [fallback option]\n   - Use PRD-A workaround in the meantime\n   - Differentiate recommendations for Linux Sysbox vs Docker Desktop ECI users\n\n6. **Future Implementation Scope** (for implementation epic)\n   - What would be done for each option\n   - Testing requirements\n   - Documentation updates\n\n## Key context\n\n- This PRD is for long-term solutions\n- Based on analysis from Task 1 (technical analysis document)\n- Clearly separate ContainAI-controllable vs operator-controllable vs vendor-controllable options\n- Seccomp interception fix is host-side (operator must upgrade sysbox in Linux mode)\n- **ECI support status**: Consume Task 1's \"ECI Support Status\" section as input - do NOT pre-assume; if deprecated, discuss ECI as external ecosystem context only\n- Treat version predictions as hypotheses\n\n## Acceptance\n\n- [ ] PRD-B created at `.flow/specs/prd-sysbox-dind-fix.md`\n- [ ] Technical analysis references technical analysis document with commit SHAs\n- [ ] Ownership boundary clearly documented by deployment mode (Linux Sysbox vs Docker Desktop ECI)\n- [ ] All fix options evaluated with pros/cons and ownership assignment\n- [ ] Option A includes specific version gate (commits, not predicted version numbers) + ECI mode considerations\n- [ ] Option B includes specific commit SHAs and supply-chain risk (Linux mode only)\n- [ ] Option D evaluated based on sysctl OCI spec source analysis from Task 1\n- [ ] Clear recommendation with rationale respecting ownership boundaries by deployment mode\n- [ ] No implementation performed - PRD only\n\n## Done summary\nTBD\n\n## Evidence\n- Commits:\n- Tests:\n- PRs:\n"
    }
  ]
}
