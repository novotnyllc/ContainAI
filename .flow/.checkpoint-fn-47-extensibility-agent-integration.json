{
  "created_at": "2026-02-03T05:23:25.703351Z",
  "epic": {
    "data": {
      "branch_name": "fn-47-extensibility-agent-integration",
      "created_at": "2026-02-02T17:43:23.535413Z",
      "depends_on_epics": [
        "fn-46-cli-ux-audit-and-simplification"
      ],
      "id": "fn-47-extensibility-agent-integration",
      "next_task": 1,
      "plan_review_status": "unknown",
      "plan_reviewed_at": null,
      "spec_path": ".flow/specs/fn-47-extensibility-agent-integration.md",
      "status": "open",
      "title": "Extensibility & Agent Integration",
      "updated_at": "2026-02-02T18:19:50.397999Z"
    },
    "spec": "# Extensibility & Agent Integration\n\n## Overview\n\nEnable easy customization of ContainAI containers without requiring users to understand systemd, iptables, or Docker internals. Provide agent-friendly documentation as a skills plugin so AI agents can effectively use ContainAI.\n\n### Core Problems\n1. **ACP hardcoded to 2 agents** - Only claude/gemini work; users can't use other agents\n2. **Agents don't know how to use CAI** - No skills/documentation plugin for AI agents\n3. **Startup customization requires systemd knowledge** - Users must create `.service` files and symlinks\n4. **Network policies require iptables knowledge** - Users must manually run iptables commands\n\n### Goals\n1. ACP works with **any** agent binary (no hardcoded list), with helpful errors for missing agents\n2. Image selection decoupled from agent selection (separate concerns)\n3. Skills plugin teaches agents how to use the full CAI CLI\n4. Drop-in startup scripts in `.containai/` automatically run at container start\n5. Drop-in network policy files generate appropriate iptables rules (opt-in)\n\n## Scope\n\n### In Scope\n- Remove hardcoded agent validation in ACP proxy and shell wrapper\n- Create containai-skills plugin with comprehensive CAI documentation\n- Add startup hook directory support (`.containai/hooks/startup.d/`)\n- Add network policy file support (`.containai/network.conf`)\n- Default template auto-detects and includes these files\n- Documentation for extensibility patterns\n\n### Out of Scope\n- MCP server implementation (agents use CLI directly)\n- Python/TypeScript SDK (CLI is sufficient)\n- New ACP protocol features\n- Changes to ACP proxy architecture\n- Agent discovery (`cai agents` command) - YAGNI; users know what they installed\n\n## Architecture\n\n### Startup Hooks (Two-Level)\n\nHooks can be defined at two levels, merged at runtime:\n\n1. **Template-level** - Shared across all workspaces using that template\n2. **Workspace-level** - Specific to one project\n\n```\n# Template-level (shared)\n~/.config/containai/templates/\n\u2514\u2500\u2500 my-template/\n    \u251c\u2500\u2500 Dockerfile\n    \u2514\u2500\u2500 hooks/\n        \u2514\u2500\u2500 startup.d/\n            \u251c\u2500\u2500 10-common-tools.sh    # Runs for all projects\n            \u2514\u2500\u2500 20-services.sh\n\n# Workspace-level (project-specific)\nproject/\n\u2514\u2500\u2500 .containai/\n    \u2514\u2500\u2500 hooks/\n        \u2514\u2500\u2500 startup.d/\n            \u251c\u2500\u2500 30-project-deps.sh    # Runs only for this project\n            \u2514\u2500\u2500 40-custom-setup.sh\n```\n\n**Execution order:**\n1. Template hooks first (sorted): `~/.config/containai/templates/<name>/hooks/startup.d/*.sh`\n2. Workspace hooks second (sorted): `.containai/hooks/startup.d/*.sh`\n\n**Implementation approach:**\n- Runtime mounts (not build-time COPY) for fast iteration\n- Template hooks mounted to `/etc/containai/template-hooks/`\n- Workspace hooks accessed via existing workspace mount\n- `containai-init.sh` runs both in order\n- Scripts run as agent user with sudo available\n\n### Network Policy Files (Two-Level, Opt-In)\n\nSame two-level approach for network policies. **Important:** This is opt-in - the default (no config file) allows all egress except existing hard blocks.\n\n**Default Behavior (No Config File):**\n- Allow all egress\n- Except existing hard blocks: private ranges (RFC 1918), link-local (169.254.0.0/16), cloud metadata\n\n**Opt-In Restriction (With Config File):**\n\n```ini\n# Template: ~/.config/containai/templates/my-template/network.conf\n[egress]\npreset = package-managers  # All projects using this template get package managers\ndefault_deny = true        # REQUIRED to enable blocking\n\n# Workspace: .containai/network.conf\n[egress]\nallow = api.mycompany.com  # Project-specific additions\n```\n\n**Config Semantics:**\n| Setting | Meaning |\n|---------|---------|\n| No `network.conf` | Allow all (except hard blocks) - **default** |\n| `network.conf` without `default_deny` | Allow all, log allowed list (informational) |\n| `network.conf` with `default_deny = true` | Allow only listed, block rest |\n\n**Merge behavior:** Template config provides base, workspace config adds to it.\n\n**Implementation approach:**\n- New function in `network.sh` to parse network.conf\n- Resolve domain names to IPs at container start\n- Only generate blocking rules if `default_deny = true`\n- Hard blocks (private ranges, metadata) always apply regardless of config\n- Presets: `package-managers`, `git-hosts`, `ai-apis`\n\n### Runtime Mounts (Not Build-Time)\n\nFiles are mounted at runtime, not copied during build:\n\n| Source | Container Path |\n|--------|---------------|\n| `~/.config/containai/templates/<name>/hooks/` | `/etc/containai/template-hooks/` |\n| `~/.config/containai/templates/<name>/network.conf` | `/etc/containai/template-network.conf` |\n| `.containai/hooks/` | (via workspace mount) |\n| `.containai/network.conf` | (via workspace mount) |\n\n**Benefits:**\n- Change hooks, restart container - no rebuild\n- Same template image, different customizations per workspace\n- Clear separation: template provides base, workspace overrides\n\n### Skills Plugin Structure\n\n```\ncontainai-skills/\n\u251c\u2500\u2500 plugin.json\n\u251c\u2500\u2500 skills/\n\u2502   \u251c\u2500\u2500 containai-overview.md      # What ContainAI is, when to use it\n\u2502   \u251c\u2500\u2500 containai-quickstart.md    # Start a sandbox, run commands\n\u2502   \u251c\u2500\u2500 containai-lifecycle.md     # run, stop, status, gc\n\u2502   \u251c\u2500\u2500 containai-import-export.md # Config sync, data export\n\u2502   \u251c\u2500\u2500 containai-customization.md # Templates, hooks, network\n\u2502   \u2514\u2500\u2500 containai-troubleshooting.md # Common issues\n\u2514\u2500\u2500 README.md\n```\n\n## Quick commands\n\n```bash\n# Test ACP with arbitrary agent\ncai --acp myagent  # Should work (agent must exist in container)\n\n# Create startup hook\nmkdir -p .containai/hooks/startup.d\necho '#!/bin/bash\necho \"Hello from startup hook\"' > .containai/hooks/startup.d/10-hello.sh\nchmod +x .containai/hooks/startup.d/10-hello.sh\n\n# Create network policy\ncat > .containai/network.conf << 'EOF'\n[egress]\npreset = package-managers\nallow = github.com\ndefault_deny = true\nEOF\n\n# Rebuild container with new config\ncai stop && cai run\n```\n\n## Acceptance\n\n- [ ] `cai --acp <any-agent>` works without hardcoded validation\n- [ ] ACP proxy accepts any agent name, validates binary exists at runtime\n- [ ] Clear, helpful error when agent binary not found: \"Agent 'foo' not found in container\"\n- [ ] Image selection (`--image-tag`) decoupled from agent selection (`--acp`)\n- [ ] containai-skills plugin published with 5+ skills covering full CLI\n- [ ] Template-level hooks in `~/.config/containai/templates/<name>/hooks/startup.d/` run first\n- [ ] Workspace-level hooks in `.containai/hooks/startup.d/` run second\n- [ ] Startup hooks run in sorted order within each level, as agent user\n- [ ] Failed startup hook fails container start with clear error\n- [ ] No `network.conf` = allow all egress (except hard blocks) - unchanged default\n- [ ] `network.conf` with `default_deny = true` = enforce allowlist\n- [ ] `network.conf` without `default_deny` = informational only, no blocking\n- [ ] Template-level `network.conf` provides base network policy\n- [ ] Workspace-level `network.conf` extends template policy\n- [ ] Preset support for common domains (package-managers, git-hosts)\n- [ ] Runtime mounts used (no rebuild needed for hook/config changes)\n- [ ] No systemd or iptables knowledge required from users\n- [ ] Documentation updated for all extensibility features\n\n## References\n\n- `src/acp-proxy/Program.cs:31` - Hardcoded agent check to remove\n- `src/containai.sh:3628-3634` - Shell wrapper agent validation\n- `src/lib/container.sh:95-99` - `_CONTAINAI_AGENT_TAGS` array\n- `src/container/containai-init.sh` - Init script to extend\n- `src/lib/network.sh:551-714` - Existing iptables implementation\n- `src/templates/example-ml.Dockerfile:32-66` - Startup service example pattern\n- `docs/configuration.md:359-389` - Existing template documentation\n"
  },
  "epic_id": "fn-47-extensibility-agent-integration",
  "schema_version": 2,
  "tasks": [
    {
      "data": {
        "assignee": null,
        "claim_note": "",
        "claimed_at": null,
        "created_at": "2026-02-02T17:44:31.475688Z",
        "depends_on": [],
        "epic": "fn-47-extensibility-agent-integration",
        "id": "fn-47-extensibility-agent-integration.1",
        "priority": null,
        "spec_path": ".flow/tasks/fn-47-extensibility-agent-integration.1.md",
        "status": "todo",
        "title": "Generic ACP Support - Remove hardcoded agent validation",
        "updated_at": "2026-02-02T17:44:31.475703Z"
      },
      "id": "fn-47-extensibility-agent-integration.1",
      "runtime": null,
      "spec": "# fn-47-extensibility-agent-integration.1 Generic ACP Support - Remove hardcoded agent validation\n\n## Description\n\nRemove hardcoded agent validation from ACP proxy and shell wrapper. Currently only \"claude\" and \"gemini\" are allowed. Any agent name should be accepted. Add runtime validation with helpful errors and decouple image selection from agent selection.\n\n### Core Problem\n\nACP is point-to-point: editor connects to one agent. The protocol has no discovery - it assumes you know which agent you want. So validation should be:\n1. Accept any agent name\n2. Fail gracefully if binary doesn't exist in container\n3. Provide helpful error message\n\n### Changes Required\n\n1. **`src/acp-proxy/Program.cs:29-36`** - Remove hardcoded check:\n   ```csharp\n   // REMOVE THIS BLOCK:\n   if (agent != \"claude\" && agent != \"gemini\")\n   {\n       await Console.Error.WriteLineAsync($\"Unsupported agent: {agent}\");\n       return 1;\n   }\n   ```\n   Keep test mode bypass (`CAI_ACP_TEST_MODE`).\n\n2. **`src/containai.sh:3628-3634`** - Remove case statement validation:\n   ```bash\n   # REMOVE THIS:\n   case \"$agent\" in\n       claude|gemini) ;;\n       *) printf '%s\\n' \"Unsupported agent: $agent\" >&2; return 1 ;;\n   esac\n   ```\n\n3. **`src/acp-proxy/Program.cs` (SpawnAgentProcess)** - Add runtime validation:\n   - When `Process.Start()` fails, catch the exception\n   - Return helpful error: \"Agent 'foo' not found in container. Ensure the agent binary exists and supports --acp flag.\"\n\n4. **Decouple image/agent selection** - These are separate concerns:\n   - `--image-tag` / `CONTAINAI_IMAGE_TAG` \u2192 which Docker image to use\n   - `--acp <agent>` \u2192 which binary to run inside container\n   - `_CONTAINAI_AGENT_TAGS` in `container.sh:95-99` can remain for default image selection, but should not gate which agents can run\n\n5. **`docs/acp.md`** - Update documentation (handled by Task 6)\n\n### What NOT to do\n\n- **No agent discovery** (`cai agents` listing) - YAGNI. Users know what they installed. If they try a missing agent, the error tells them.\n- **No agent config file** - Agents are just binaries with `--acp` flag. No need for extra config.\n\n### Testing\n\n- `cai --acp nonexistent` \u2192 clear error: \"Agent 'nonexistent' not found in container\"\n- `cai --acp claude` \u2192 works as before\n- `cai --acp customagent` (with binary installed) \u2192 works\n\n## Acceptance\n\n- [ ] `cai --acp <any-name>` accepted without hardcoded validation\n- [ ] Clear, helpful error when agent binary not found in container\n- [ ] Image selection (`--image-tag`) independent of agent selection (`--acp`)\n- [ ] Existing claude/gemini functionality unchanged\n- [ ] Test added for generic agent support\n\n## Done summary\nTBD\n\n## Evidence\n- Commits:\n- Tests:\n- PRs:\n"
    },
    {
      "data": {
        "assignee": null,
        "claim_note": "",
        "claimed_at": null,
        "created_at": "2026-02-02T17:44:31.561644Z",
        "depends_on": [],
        "epic": "fn-47-extensibility-agent-integration",
        "id": "fn-47-extensibility-agent-integration.2",
        "priority": null,
        "spec_path": ".flow/tasks/fn-47-extensibility-agent-integration.2.md",
        "status": "todo",
        "title": "Startup Hooks - Implement .containai/hooks/startup.d/ support",
        "updated_at": "2026-02-02T17:44:31.561660Z"
      },
      "id": "fn-47-extensibility-agent-integration.2",
      "runtime": null,
      "spec": "# fn-47-extensibility-agent-integration.2 Startup Hooks - Implement hooks/startup.d/ support\n\n## Description\n\nAllow users to add executable scripts that run at container startup without needing to understand systemd. Hooks can be defined at two levels:\n\n1. **Template-level** - In `~/.config/containai/templates/<name>/hooks/startup.d/` - shared across all workspaces using that template\n2. **Workspace-level** - In `.containai/hooks/startup.d/` - specific to one project\n\nBoth are merged at runtime: template hooks run first, then workspace hooks.\n\n### Directory Structure\n\n```\n# Template-level (shared across workspaces)\n~/.config/containai/templates/\n\u2514\u2500\u2500 my-template/\n    \u251c\u2500\u2500 Dockerfile\n    \u2514\u2500\u2500 hooks/\n        \u2514\u2500\u2500 startup.d/\n            \u251c\u2500\u2500 10-install-common-tools.sh\n            \u2514\u2500\u2500 20-setup-services.sh\n\n# Workspace-level (project-specific)\nproject/\n\u2514\u2500\u2500 .containai/\n    \u2514\u2500\u2500 hooks/\n        \u2514\u2500\u2500 startup.d/\n            \u251c\u2500\u2500 30-project-deps.sh\n            \u2514\u2500\u2500 40-custom-setup.sh\n```\n\n### Hook Resolution Order\n\n1. Template hooks first (sorted): `~/.config/containai/templates/<template>/hooks/startup.d/*.sh`\n2. Workspace hooks second (sorted): `.containai/hooks/startup.d/*.sh`\n\nThis allows templates to set up common infrastructure, while workspaces add project-specific setup.\n\n### Implementation\n\n1. **Extend `src/container/containai-init.sh`** - Add hook execution after existing init logic:\n   ```bash\n   run_hooks() {\n       local hooks_dir=\"$1\"\n       [[ -d \"$hooks_dir\" ]] || return 0\n       for hook in \"$hooks_dir\"/*.sh; do\n           [[ -e \"$hook\" && -x \"$hook\" ]] || continue\n           log \"Running startup hook: $hook\"\n           if ! \"$hook\"; then\n               log \"ERROR: Startup hook failed: $hook\"\n               exit 1\n           fi\n       done\n   }\n\n   # Template hooks first, then workspace hooks\n   run_hooks \"/etc/containai/template-hooks/startup.d\"\n   run_hooks \"/home/agent/workspace/.containai/hooks/startup.d\"\n   ```\n\n2. **Mount paths (handled by Task 4):**\n   - Template hooks mounted to `/etc/containai/template-hooks/`\n   - Workspace hooks accessed directly at workspace path\n\n3. **Execution context:**\n   - Scripts run as agent user (not root)\n   - `sudo` available if needed\n   - Working directory: `/home/agent/workspace`\n   - stdout/stderr logged to container journal\n\n4. **Error handling:**\n   - Non-zero exit from any hook fails container start\n   - Clear error message identifying which hook failed\n   - Hooks should be idempotent (safe to re-run)\n\n### Example Use Cases\n\n**Template: ML development environment**\n```bash\n# ~/.config/containai/templates/ml/hooks/startup.d/10-gpu-setup.sh\n#!/bin/bash\n# Runs for all ML projects\nnvidia-smi || echo \"No GPU detected\"\npip install torch --quiet\n```\n\n**Workspace: Specific project**\n```bash\n# project/.containai/hooks/startup.d/30-deps.sh\n#!/bin/bash\n# Runs only for this project\npip install -r requirements.txt\n```\n\n### Testing\n\n- Create test with hooks at both template and workspace levels\n- Verify template hooks run before workspace hooks\n- Verify hooks run as agent user\n- Verify failed hook stops container start\n\n## Acceptance\n\n- [ ] Template hooks at `~/.config/containai/templates/<name>/hooks/startup.d/*.sh` supported\n- [ ] Workspace hooks at `.containai/hooks/startup.d/*.sh` supported\n- [ ] Template hooks run before workspace hooks\n- [ ] Scripts run in sorted (lexicographic) order within each level\n- [ ] Scripts run as agent user with sudo available\n- [ ] Non-executable files skipped with warning\n- [ ] Failed script (non-zero exit) fails container start\n- [ ] Clear error message shows which hook failed\n- [ ] Integration test added\n\n## Done summary\nTBD\n\n## Evidence\n- Commits:\n- Tests:\n- PRs:\n"
    },
    {
      "data": {
        "assignee": null,
        "claim_note": "",
        "claimed_at": null,
        "created_at": "2026-02-02T17:44:31.650177Z",
        "depends_on": [],
        "epic": "fn-47-extensibility-agent-integration",
        "id": "fn-47-extensibility-agent-integration.3",
        "priority": null,
        "spec_path": ".flow/tasks/fn-47-extensibility-agent-integration.3.md",
        "status": "todo",
        "title": "Network Policy Files - Implement .containai/network.conf parsing",
        "updated_at": "2026-02-02T17:44:31.650193Z"
      },
      "id": "fn-47-extensibility-agent-integration.3",
      "runtime": null,
      "spec": "# fn-47-extensibility-agent-integration.3 Network Policy Files - Implement .containai/network.conf parsing\n\n## Description\n\nAllow users to configure **opt-in** network egress restrictions via a simple config file. This is for users who want stricter policies than the default.\n\n### Default Behavior (No Config File)\n\n**Without `network.conf`:** Allow all egress, except existing hard blocks:\n- Private ranges blocked (RFC 1918: 10.0.0.0/8, 172.16.0.0/12, 192.168.0.0/16)\n- Link-local blocked (169.254.0.0/16)\n- Cloud metadata blocked (169.254.169.254, etc.)\n\nThis is the current behavior and remains unchanged.\n\n### Opt-In Restriction (With Config File)\n\nUsers who want stricter egress control create `network.conf`:\n\n```ini\n# .containai/network.conf\n# OPTIONAL - only create if you want to restrict egress\n\n[egress]\n# Use presets (expand to known domains)\npreset = package-managers\npreset = git-hosts\n\n# Allow specific domains/IPs\nallow = api.anthropic.com\nallow = 10.0.0.0/8\n\n# REQUIRED to enable blocking - without this, config has no effect\ndefault_deny = true\n```\n\n**Key point:** `default_deny = true` is required to enable blocking. Without it, the config is informational only (logged but not enforced).\n\n### Config Semantics\n\n| Setting | Meaning |\n|---------|---------|\n| No `network.conf` | Allow all (except hard blocks) - **default** |\n| `network.conf` without `default_deny` | Allow all, log allowed list (informational) |\n| `network.conf` with `default_deny = true` | Allow only listed, block rest |\n\n### Presets\n\nDefine in `src/lib/network.sh`:\n\n| Preset | Domains/CIDRs |\n|--------|---------------|\n| `package-managers` | registry.npmjs.org, pypi.org, files.pythonhosted.org, crates.io, rubygems.org |\n| `git-hosts` | github.com, gitlab.com, bitbucket.org |\n| `ai-apis` | api.anthropic.com, api.openai.com |\n\n### Implementation\n\n1. **New function in `src/lib/network.sh`:**\n   - `_cai_parse_network_conf()` - Parse INI-style config\n   - `_cai_resolve_domain_to_ips()` - DNS resolution (with timeout)\n   - `_cai_apply_network_policy()` - Generate iptables from config\n\n2. **Integration point:**\n   - Call from host side before container start (can use host DNS)\n   - Only applies rules if `default_deny = true`\n\n3. **Rule application:**\n   - Existing private-range blocks remain (always applied)\n   - If `default_deny = true`: add ACCEPT rules for allowed, then DROP default\n   - If no `default_deny`: log config, don't add rules\n\n4. **Error handling:**\n   - Invalid config syntax: warn and skip\n   - DNS resolution failure: warn and skip that domain\n   - Missing `default_deny`: log info, continue with allow-all\n\n### Gotchas\n\n- DNS resolution returns multiple IPs - add all\n- CDNs change IPs - document this limitation\n- IPv6 support: skip if not enabled\n- Hard blocks (private ranges, metadata) always apply regardless of config\n\n## Acceptance\n\n- [ ] No `network.conf` = allow all egress (except hard blocks) - unchanged default\n- [ ] `network.conf` without `default_deny` = informational only, no blocking\n- [ ] `network.conf` with `default_deny = true` = enforce allowlist\n- [ ] `preset` keyword expands to predefined domain lists\n- [ ] `allow` entries resolved to IPs and added to iptables\n- [ ] DNS resolution failures logged as warnings, don't fail start\n- [ ] Invalid config syntax logged as warning\n- [ ] Existing private-range blocking always applies\n- [ ] Integration test with network policy\n\n## Done summary\nTBD\n\n## Evidence\n- Commits:\n- Tests:\n- PRs:\n"
    },
    {
      "data": {
        "assignee": null,
        "claim_note": "",
        "claimed_at": null,
        "created_at": "2026-02-02T17:44:31.737113Z",
        "depends_on": [
          "fn-47-extensibility-agent-integration.2",
          "fn-47-extensibility-agent-integration.3"
        ],
        "epic": "fn-47-extensibility-agent-integration",
        "id": "fn-47-extensibility-agent-integration.4",
        "priority": null,
        "spec_path": ".flow/tasks/fn-47-extensibility-agent-integration.4.md",
        "status": "todo",
        "title": "Template Auto-Detection - Update default template to include config files",
        "updated_at": "2026-02-02T17:46:29.225274Z"
      },
      "id": "fn-47-extensibility-agent-integration.4",
      "runtime": null,
      "spec": "# fn-47-extensibility-agent-integration.4 Template Auto-Detection - Mount hooks and network config at runtime\n\n## Description\n\nUpdate container startup to automatically mount hook directories and network config from both template and workspace levels. Uses runtime mounts (Option B) for fast iteration - no rebuild needed for changes.\n\n### Mount Sources\n\n| Level | Source | Container Destination |\n|-------|--------|----------------------|\n| Template | `~/.config/containai/templates/<name>/hooks/` | `/etc/containai/template-hooks/` |\n| Template | `~/.config/containai/templates/<name>/network.conf` | `/etc/containai/template-network.conf` |\n| Workspace | `.containai/hooks/` | (accessed directly via workspace mount) |\n| Workspace | `.containai/network.conf` | (accessed directly via workspace mount) |\n\n### Why Runtime Mounts\n\n- **Fast iteration**: Change hooks/config, restart container - no rebuild\n- **Template reuse**: Same template image, different hooks per workspace\n- **Clear separation**: Template provides base, workspace overrides\n\n### Implementation\n\n1. **`src/lib/container.sh`** - Add mount logic in `_containai_run_container()`:\n   ```bash\n   # Get current template name from config\n   template_name=$(_cai_get_config \"template\" \"default\")\n   template_dir=\"$HOME/.config/containai/templates/$template_name\"\n\n   # Mount template hooks if present\n   if [[ -d \"$template_dir/hooks\" ]]; then\n       EXTRA_MOUNTS+=(\"-v\" \"$template_dir/hooks:/etc/containai/template-hooks:ro\")\n   fi\n\n   # Mount template network.conf if present\n   if [[ -f \"$template_dir/network.conf\" ]]; then\n       EXTRA_MOUNTS+=(\"-v\" \"$template_dir/network.conf:/etc/containai/template-network.conf:ro\")\n   fi\n\n   # Workspace files accessed directly - no extra mount needed\n   # (workspace already mounted at /home/agent/workspace)\n   ```\n\n2. **`src/container/containai-init.sh`** - Check both paths (from Task 2):\n   - Template hooks: `/etc/containai/template-hooks/startup.d/`\n   - Workspace hooks: `/home/agent/workspace/.containai/hooks/startup.d/`\n\n3. **`src/templates/default.Dockerfile`** - Create directory structure:\n   ```dockerfile\n   RUN mkdir -p /etc/containai/template-hooks/startup.d\n   ```\n\n### User Workflow\n\n**Template-level hooks (shared):**\n```bash\n# Create hooks in template directory\nmkdir -p ~/.config/containai/templates/my-template/hooks/startup.d\ncat > ~/.config/containai/templates/my-template/hooks/startup.d/10-common.sh << 'EOF'\n#!/bin/bash\necho \"Common setup for all projects using this template\"\nEOF\nchmod +x ~/.config/containai/templates/my-template/hooks/startup.d/10-common.sh\n```\n\n**Workspace-level hooks (project-specific):**\n```bash\n# Create hooks in project\nmkdir -p .containai/hooks/startup.d\ncat > .containai/hooks/startup.d/30-project.sh << 'EOF'\n#!/bin/bash\necho \"Project-specific setup\"\nnpm install\nEOF\nchmod +x .containai/hooks/startup.d/30-project.sh\n\n# Run - hooks from both levels execute\ncai run\n```\n\n## Acceptance\n\n- [ ] Template hooks directory mounted to `/etc/containai/template-hooks/` when present\n- [ ] Template network.conf mounted when present\n- [ ] Workspace hooks accessible via existing workspace mount\n- [ ] Mounts are read-only\n- [ ] Missing directories don't cause errors\n- [ ] Works with default and custom templates\n- [ ] Template name resolved from config (default: \"default\")\n- [ ] Documented in docs/configuration.md\n\n## Done summary\nTBD\n\n## Evidence\n- Commits:\n- Tests:\n- PRs:\n"
    },
    {
      "data": {
        "assignee": null,
        "claim_note": "",
        "claimed_at": null,
        "created_at": "2026-02-02T17:44:31.822329Z",
        "depends_on": [],
        "epic": "fn-47-extensibility-agent-integration",
        "id": "fn-47-extensibility-agent-integration.5",
        "priority": null,
        "spec_path": ".flow/tasks/fn-47-extensibility-agent-integration.5.md",
        "status": "todo",
        "title": "Skills Plugin - Create containai-skills plugin with CLI documentation",
        "updated_at": "2026-02-02T17:44:31.822345Z"
      },
      "id": "fn-47-extensibility-agent-integration.5",
      "runtime": null,
      "spec": "# fn-47-extensibility-agent-integration.5 Skills Plugin - Create containai-skills plugin with CLI documentation\n\n## Description\n\nCreate a Claude Code skills plugin that teaches AI agents how to use the ContainAI CLI effectively. Agents running inside ContainAI containers (or orchestrating them from outside) can use these skills to understand available commands.\n\n### Plugin Structure\n\n```\ncontainai-skills/\n\u251c\u2500\u2500 plugin.json\n\u251c\u2500\u2500 README.md\n\u2514\u2500\u2500 skills/\n    \u251c\u2500\u2500 containai-overview.md      # What is ContainAI, when to use it\n    \u251c\u2500\u2500 containai-quickstart.md    # Start a sandbox, run commands, stop\n    \u251c\u2500\u2500 containai-lifecycle.md     # run, shell, exec, stop, status, gc\n    \u251c\u2500\u2500 containai-sync.md          # import, export, sync operations\n    \u251c\u2500\u2500 containai-setup.md         # doctor, setup, validate\n    \u251c\u2500\u2500 containai-customization.md # templates, hooks, network config\n    \u2514\u2500\u2500 containai-troubleshooting.md # Common errors and solutions\n```\n\n### Skill Content Guidelines\n\nEach skill should include:\n1. **When to use** - Trigger phrases for the skill\n2. **Key commands** - Actual CLI commands with examples\n3. **Common patterns** - Typical workflows\n4. **Gotchas** - Things that trip people up\n\nExample content for `containai-quickstart.md`:\n```markdown\n# ContainAI Quickstart\n\nUse this skill when: starting a sandbox, running commands in isolation\n\n## Start a sandbox\n\\`\\`\\`bash\ncai run                    # Start/attach in current workspace\ncai run --detached         # Start in background\ncai run --workspace /path  # Specific workspace\n\\`\\`\\`\n\n## Run commands\n\\`\\`\\`bash\ncai exec -- npm test       # Run single command\ncai shell                  # Interactive shell\n\\`\\`\\`\n\n## Stop\n\\`\\`\\`bash\ncai stop                   # Stop current workspace container\ncai stop --all             # Stop all containers\n\\`\\`\\`\n```\n\n### Plugin Metadata\n\n`plugin.json`:\n```json\n{\n  \"name\": \"containai-skills\",\n  \"version\": \"1.0.0\",\n  \"description\": \"Skills for using ContainAI sandboxed containers\",\n  \"skills\": [\n    { \"name\": \"containai-overview\", \"path\": \"skills/containai-overview.md\" },\n    { \"name\": \"containai-quickstart\", \"path\": \"skills/containai-quickstart.md\" },\n    ...\n  ]\n}\n```\n\n### Distribution\n\n- Publish to Claude Code plugin registry (if available)\n- Or include in ContainAI repo under `plugins/containai-skills/`\n- Users install via: `claude plugins install containai-skills`\n\n## Acceptance\n\n- [ ] Plugin structure follows Claude Code plugin conventions\n- [ ] 5+ skills covering all major CLI commands\n- [ ] Each skill has clear trigger phrases\n- [ ] Commands include realistic examples\n- [ ] Troubleshooting skill covers common errors\n- [ ] Plugin installable and functional\n- [ ] README explains installation and usage\n\n## Done summary\nTBD\n\n## Evidence\n- Commits:\n- Tests:\n- PRs:\n"
    },
    {
      "data": {
        "assignee": null,
        "claim_note": "",
        "claimed_at": null,
        "created_at": "2026-02-02T17:44:31.909692Z",
        "depends_on": [
          "fn-47-extensibility-agent-integration.1",
          "fn-47-extensibility-agent-integration.2",
          "fn-47-extensibility-agent-integration.3",
          "fn-47-extensibility-agent-integration.4"
        ],
        "epic": "fn-47-extensibility-agent-integration",
        "id": "fn-47-extensibility-agent-integration.6",
        "priority": null,
        "spec_path": ".flow/tasks/fn-47-extensibility-agent-integration.6.md",
        "status": "todo",
        "title": "Documentation - Update docs for extensibility features",
        "updated_at": "2026-02-02T17:46:29.309054Z"
      },
      "id": "fn-47-extensibility-agent-integration.6",
      "runtime": null,
      "spec": "# fn-47-extensibility-agent-integration.6 Documentation - Update docs for extensibility features\n\n## Description\n\nUpdate documentation to cover all new extensibility features: generic ACP, startup hooks, and network policy files.\n\n### Docs to Update\n\n1. **`docs/acp.md`**\n   - Update \"Supported Agents\" to indicate any agent works\n   - Add section on using custom agents\n   - Update troubleshooting for generic agent errors\n\n2. **`docs/configuration.md`**\n   - Add \"Startup Hooks\" section explaining `.containai/hooks/startup.d/`\n   - Add \"Network Policies\" section explaining `.containai/network.conf`\n   - Include complete examples for each\n\n3. **`README.md`**\n   - Add bullet point about extensibility in features section\n   - Link to configuration.md for details\n\n4. **`docs/quickstart.md`** (if exists)\n   - Mention hooks/network as optional customization\n\n### Example Content for Hooks\n\n```markdown\n## Startup Hooks\n\nRun custom scripts at container startup without systemd knowledge.\n\n### Setup\n\\`\\`\\`bash\nmkdir -p .containai/hooks/startup.d\ncat > .containai/hooks/startup.d/10-setup.sh << 'EOF'\n#!/bin/bash\nnpm install\nredis-server --daemonize yes\nEOF\nchmod +x .containai/hooks/startup.d/10-setup.sh\n\\`\\`\\`\n\n### How It Works\n- Scripts run in sorted order (10-xxx before 20-xxx)\n- Run as agent user with sudo available\n- Non-zero exit fails container start\n- Must be executable (`chmod +x`)\n```\n\n### Example Content for Network\n\n```markdown\n## Network Policies\n\nControl egress without iptables knowledge.\n\n### Setup\n\\`\\`\\`ini\n# .containai/network.conf\n[egress]\npreset = package-managers\nallow = github.com, api.anthropic.com\ndefault_deny = true\n\\`\\`\\`\n\n### Presets\n- `package-managers`: npm, pypi, crates.io, rubygems\n- `git-hosts`: github, gitlab, bitbucket\n- `ai-apis`: anthropic, openai\n```\n\n## Acceptance\n\n- [ ] docs/acp.md updated for generic agent support\n- [ ] docs/configuration.md has Startup Hooks section\n- [ ] docs/configuration.md has Network Policies section\n- [ ] Each section has working examples\n- [ ] README.md mentions extensibility\n- [ ] All internal links valid\n- [ ] No duplicate content with skills plugin\n\n## Done summary\nTBD\n\n## Evidence\n- Commits:\n- Tests:\n- PRs:\n"
    }
  ]
}
