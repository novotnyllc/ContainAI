{
  "created_at": "2026-01-20T09:37:22.949293Z",
  "epic": {
    "data": {
      "branch_name": "fn-6-aaz",
      "created_at": "2026-01-20T04:51:11.238750Z",
      "depends_on_epics": [],
      "id": "fn-6-aaz",
      "next_task": 1,
      "plan_review_status": "unknown",
      "plan_reviewed_at": null,
      "spec_path": ".flow/specs/fn-6-aaz.md",
      "status": "open",
      "title": "Allowlist-based env var import",
      "updated_at": "2026-01-20T05:23:56.088131Z"
    },
    "spec": "# Allowlist-based Env Var Import\n\n## Overview\n\nExtend `cai import` to support allowlist-based environment variable import. Users specify which env vars to import via config, optionally reading from host environment (opt-in) and/or a source `.env` file. The result is a combined `.env` file written to the data volume.\n\n**Key principle**: No accidental env var leakage. Explicit allowlist required, host env reading is opt-in (default: disabled).\n\n## Scope\n\n**In scope:**\n- Config schema for env var allowlist (`[env]` section)\n- Reading from host environment (opt-in)\n- Reading from source `.env` file\n- Writing combined `.env` to data volume\n- Safe entrypoint loading of `.env` (no shell `source`)\n- Integration with `cai import`\n- Context-aware volume operations for ALL docker commands\n- Dedicated env config resolution (independent of volume/excludes)\n\n**Out of scope:**\n- Pattern matching in allowlist (`APP_*` - literals only)\n- `--env-file` flag for docker commands\n- Secrets management (just env vars)\n- Workspace-specific env config (`[workspace.*].env` ignored if present)\n\n## Config Schema\n\n```toml\n[env]\n# Allowlist of env var names to import\n# Names must match ^[A-Za-z_][A-Za-z0-9_]*$ (POSIX)\n# Invalid names logged as warning and skipped\n# Duplicates deduplicated preserving first occurrence\n# Missing or non-list: treated as [] with [WARN]\nimport = [\"ANTHROPIC_API_KEY\", \"CONTEXT7_API_KEY\", \"DEBUG\"]\n\n# Optional: Read values from host environment\n# Default: false (must opt-in explicitly)\nfrom_host = true\n\n# Optional: Read values from .env file\n# Path is workspace-relative; absolute paths rejected with error\n# File must exist and be readable (hard error if set but missing/unreadable)\nenv_file = \".env.sandbox\"\n```\n\n**Config behavior:**\n- Missing `[env]` section: skip env import silently (no log message)\n- `[env]` exists but `import` missing/invalid: treat as `[]` with `[WARN]`, skip import\n- Empty `import = []`: skip env import with `[INFO]`\n- Duplicate keys in allowlist: deduplicate preserving order\n- `[workspace.*].env`: IGNORED (workspace-specific env out of scope)\n- `env_file` absolute path: rejected with error\n- `env_file` outside workspace: rejected with error (resolved relative to workspace root)\n- `env_file` set but missing/unreadable: **hard error** (not silent)\n- `env_file` with empty `import = []`: `env_file` still validated (error if missing/unreadable), but no vars imported\n\n**Dedicated env config resolution:**\n- Env config is resolved INDEPENDENTLY of volume/excludes resolution\n- Even if `--data-volume` or `--no-excludes` is used, config is still parsed for `[env]`\n- New function `_containai_resolve_env_config()` reads config specifically for env settings\n\n**Python availability:**\n- If Python/config parsing unavailable: env import skipped with `[WARN]`\n- If `--config` explicitly provided but Python unavailable: fail fast (matches existing strict behavior)\n\n## Precedence (highest wins)\n\n1. Runtime `-e` flags (already in container environment - NOT overwritten)\n2. Host environment (if `from_host = true`)\n3. Source `.env` file (if `env_file` specified)\n\n**Empty string handling**: Empty string (`KEY=\"\"`) is a valid value with full precedence:\n- Host `KEY=\"\"` overrides file `KEY=value`\n- Runtime `-e KEY=` overrides both (entrypoint won't overwrite)\n- \"Present\" means \"set in environment\" - empty string counts as present\n\n**Entrypoint rule**: Only set `KEY` from `/mnt/agent-data/.env` if `KEY` is NOT already present in the container environment. Check with `[[ -z \"${!key+x}\" ]]` (unset vs empty).\n\n## Input .env Parser Rules\n\nExplicit parser for source `.env` file:\n- Accept `KEY=VALUE` lines (optionally prefixed with `export `)\n- Ignore full-line `#` comments and blank lines (including whitespace-only lines)\n- Split on FIRST `=` only - remainder is value (spaces preserved)\n- Validate KEY against `^[A-Za-z_][A-Za-z0-9_]*$`\n- Skip lines without `=` with `[WARN]` message\n- **Strip CRLF** (`\\r`) from line endings\n- No quote stripping (literal values only)\n\n**Multiline value handling:**\n- File parser reads line-by-line, so multiline values aren't naturally parsed\n- If a line has no `=` and doesn't look like a key, it's likely a continuation - skip with `[WARN] line N: no = found`\n- Host-derived values with embedded newline: `[WARN] source=host: key 'FOO' skipped (multiline value)`\n- Detection for host values: `[[ \"$value\" == *$'\\n'* ]]`\n- Both formats omit the actual value for log hygiene\n\n**Log hygiene (CRITICAL)**: Never print values or raw source lines in warnings/errors. Warn with `line_number` (for file) or `source=host` + `key` + reason only. This prevents accidental secret leakage to terminal logs.\n\n## Output\n\n- **Path**: `/mnt/agent-data/.env`\n- **Format**: `KEY=VALUE` per line, no quotes, literal values\n- **Permissions**: `0600` (owner read/write only), owned by `1000:1000`\n- **Encoding**: UTF-8\n\n**Volume permission handling:**\nDocker volume roots are typically `root:root 0755`. User 1000 cannot write directly.\n\n**Solution**: Write as root in helper container, then chown/chmod:\n```bash\nprintf '%s\\n' \"$env_content\" | docker --context \"$ctx\" run --rm -i \\\n  --network=none \\\n  -v \"$volume:/data\" \\\n  alpine sh -c '\n    # Verify mount point not symlink\n    [ ! -L /data ] || exit 1\n    [ -d /data ] || exit 1\n    # Create temp as root\n    tmp=$(mktemp -p /data)\n    [ ! -L \"$tmp\" ] || { rm -f \"$tmp\"; exit 1; }\n    cat > \"$tmp\"\n    # Set ownership and permissions\n    chown 1000:1000 \"$tmp\"\n    chmod 600 \"$tmp\"\n    # Verify target not symlink before rename\n    [ ! -L /data/.env ] || { rm -f \"$tmp\"; exit 1; }\n    mv \"$tmp\" /data/.env\n  '\n```\n\n## Context-Aware Operations (CRITICAL)\n\n**ALL docker commands in `cai import` must use the selected context.** This includes existing commands AND the new .env helper:\n- Volume inspect/create: `docker --context \"$ctx\" volume inspect/create`\n- Rsync container: `docker --context \"$ctx\" run`\n- Transform containers: `docker --context \"$ctx` run`\n- Orphan cleanup: `docker --context \"$ctx\" run`\n- **New .env helper**: `docker --context \"$ctx\" run`\n\n**3-Tier Context Selection Strategy:**\n1. **Sysbox available**: Use `containai-secure` context (ECI/Sysbox mode)\n2. **Docker Desktop detected** (`docker context ls | grep -q desktop-linux`): Use `desktop-linux` context\n3. **Fallback**: Use `default` context with `[WARN] Using default context - volume may be on different daemon`\n\n**Implementation approach:**\n1. Add context selection to `_containai_import_cmd` (mirroring `lib/container.sh`'s `_cai_select_context`)\n2. Create `docker_cmd` variable or pass `ctx` parameter to ALL docker invocations in `lib/import.sh`\n3. Apply to existing rsync/transform/orphan commands (not just new .env helper)\n\n**DOCKER_CONTEXT/DOCKER_HOST neutralization:**\n- When explicit `--context` flag is used, env vars should NOT override it\n- Before docker commands: `unset DOCKER_CONTEXT DOCKER_HOST` or use `env -u DOCKER_CONTEXT -u DOCKER_HOST docker --context ...`\n- This ensures `--context` flag is authoritative\n\n**Failure mode**: If context mismatch occurs, `.env` lands in wrong daemon's volume - completely broken. This is a correctness requirement, not just nice-to-have.\n\n## Entrypoint Loading Semantics\n\n**Load timing**: After ownership fix (chown) completes. The volume may be unreadable until ownership is fixed.\n\n**Error handling (with `set -euo pipefail` safety):**\n- Unreadable `.env`: `[WARN]` and continue (do not abort) - use `if [[ -r ... ]]` guard\n- Malformed lines: `[WARN]` per line (line number + key, no value), continue with valid lines\n- Missing `.env`: silent (expected for first run) - use `if [[ -f ... ]]` guard\n\n**\"Present\" definition**: A var is \"present\" if it's set in the environment, even if empty. `KEY=\"\"` counts as present - do not override.\n\n**Symlink protection**: Reject symlink before reading (mirror entrypoint's existing anti-symlink helpers).\n\n**Safe parsing (no eval/source) with CRLF handling and `set -e` safety:**\n```bash\n_load_env_file() {\n  local env_file=\"/mnt/agent-data/.env\"\n\n  # Guard against set -e - use if/else, not raw test\n  if [[ ! -f \"$env_file\" ]]; then\n    return 0  # Silent - expected for first run\n  fi\n  if [[ -L \"$env_file\" ]]; then\n    log \"WARN: .env is symlink - skipping\"\n    return 0\n  fi\n  if [[ ! -r \"$env_file\" ]]; then\n    log \"WARN: .env unreadable - skipping\"\n    return 0\n  fi\n\n  log \"INFO: Loading environment from .env\"\n  local line_num=0\n  while IFS= read -r line || [[ -n \"$line\" ]]; do\n    # set -e safe increment (NOT ((line_num++)) which fails on 0)\n    line_num=$((line_num + 1))\n    # Strip CRLF\n    line=\"${line%$'\\r'}\"\n    # Skip comments\n    if [[ \"$line\" =~ ^[[:space:]]*# ]]; then continue; fi\n    # Skip blank/whitespace-only lines (spaces and tabs)\n    if [[ -z \"${line//[[:space:]]/}\" ]]; then continue; fi\n    # Strip optional 'export ' prefix\n    if [[ \"$line\" =~ ^export[[:space:]]+ ]]; then\n      line=\"${line#export}\"\n      line=\"${line#\"${line%%[![:space:]]*}\"}\"  # trim leading whitespace\n    fi\n    # Require = before parsing\n    if [[ \"$line\" != *=* ]]; then\n      log \"WARN: line $line_num: no = found - skipping\"\n      continue\n    fi\n    # Extract key and value\n    local key=\"${line%%=*}\"\n    local value=\"${line#*=}\"\n    # Validate key\n    if [[ ! \"$key\" =~ ^[A-Za-z_][A-Za-z0-9_]*$ ]]; then\n      log \"WARN: line $line_num: invalid key format - skipping\"\n      continue\n    fi\n    # Only set if not present (empty string = present)\n    if [[ -z \"${!key+x}\" ]]; then\n      export \"$key=$value\" || { log \"WARN: line $line_num: export failed\"; continue; }\n    fi\n  done < \"$env_file\"\n}\n```\n\n## Dry-Run Behavior\n\nWhen `cai import --dry-run` is used:\n- Print what env vars would be imported/skipped (keys only, not values)\n- Do NOT write `/mnt/agent-data/.env`\n- Do NOT create/modify the volume\n- Consistent with existing dry-run behavior in `test-sync-integration.sh`\n\n## User Flow\n\n```bash\n# 1. User creates config\ncat > .containai/config.toml <<'CONFIG'\n[env]\nimport = [\"ANTHROPIC_API_KEY\", \"CONTEXT7_API_KEY\"]\nfrom_host = true\nCONFIG\n\n# 2. User runs import\ncai import\n\n# Output:\n# [INFO] Importing env vars to volume: containai-data\n# [OK] Imported 2 env vars: ANTHROPIC_API_KEY, CONTEXT7_API_KEY\n# [WARN] Skipped 0 vars (not found in host or file)\n\n# 3. Container starts, entrypoint loads .env safely\ncai run\n```\n\n## Quick Commands\n\n```bash\n# Smoke test: import with config\ncat > /tmp/test-config.toml <<'TOML'\n[env]\nimport = [\"TEST_VAR\"]\nfrom_host = true\nTOML\nTEST_VAR=hello cai import --config /tmp/test-config.toml\n\n# Verify .env was created in volume\ndocker run --rm -v containai-data:/data alpine cat /data/.env\n# Expected: TEST_VAR=hello\n```\n\n## Test Requirements\n\nExtend `agent-sandbox/test-sync-integration.sh` to cover:\n- Dry-run doesn't create `/data/.env`\n- Non-dry-run writes expected keys\n- Values never appear in logs (log hygiene)\n- Entrypoint doesn't override pre-set env vars (including empty string)\n- Permission handling (0600, owned by 1000:1000)\n- CRLF stripping works\n- `export KEY=VALUE` format accepted\n- Lines without `=` skipped with warning\n- Invalid key names skipped with warning\n\n**Context testing approach:**\n- Context selection is tested implicitly by verifying volume contents match expectations\n- Explicit multi-context tests require ECI/Sysbox infrastructure (skip on non-ECI CI)\n- Use `[[ -n \"$(docker context ls | grep containai-secure)\" ]]` to detect ECI availability\n- Non-ECI tests verify default/desktop-linux selection logic without requiring multiple daemons\n\n## Acceptance Criteria\n\n1. [ ] Config `[env].import` specifies allowlist of env var names\n2. [ ] Missing/invalid `[env].import` treated as `[]` with `[WARN]`\n3. [ ] Var names validated against `^[A-Za-z_][A-Za-z0-9_]*$`, invalid skipped with warning\n4. [ ] Config `[env].from_host` (default false) enables host env reading\n5. [ ] Config `[env].env_file` specifies source .env file path (workspace-relative only)\n6. [ ] `env_file` set but missing/unreadable: **hard error**\n7. [ ] Only allowlisted vars are imported (no accidental leakage)\n8. [ ] Missing vars logged as warning (key only, not value), not fatal\n9. [ ] Output `.env` written atomically with TOCTOU protection\n10. [ ] Output `.env` has mode 0600, owned by 1000:1000\n11. [ ] Host env multiline values skipped with `[WARN] source=host: key 'FOO' skipped (multiline value)`\n12. [ ] Entrypoint loads `.env` safely (no shell `source`)\n13. [ ] Entrypoint only sets vars NOT already in environment (empty string = present)\n14. [ ] Entrypoint strips CRLF, handles `export ` prefix, and is `set -e` safe\n15. [ ] `cai import` triggers env var import via dedicated env config resolution\n16. [ ] ALL docker commands use correct context (existing + new)\n17. [ ] Values streamed via stdin, written as root, then chown/chmod\n18. [ ] Dry-run prints what would be imported (keys only), no volume write\n19. [ ] Log hygiene: never print values or raw lines in warnings\n20. [ ] Missing Python: skip env import with warning (fail fast if --config explicit)\n\n## References\n\n- Existing import: `agent-sandbox/lib/import.sh`\n- Context logic: `agent-sandbox/lib/container.sh`\n- Config parsing: `agent-sandbox/lib/config.sh`, `agent-sandbox/parse-toml.py`\n- Entrypoint: `agent-sandbox/entrypoint.sh`\n- Volume mount: `/mnt/agent-data`\n- OWASP guidance: env vars visible via docker inspect (not for high-sensitivity secrets)\n"
  },
  "epic_id": "fn-6-aaz",
  "schema_version": 1,
  "tasks": [
    {
      "data": {
        "assignee": null,
        "claim_note": "",
        "claimed_at": null,
        "created_at": "2026-01-20T04:51:49.377697Z",
        "depends_on": [],
        "epic": "fn-6-aaz",
        "id": "fn-6-aaz.1",
        "priority": null,
        "spec_path": ".flow/tasks/fn-6-aaz.1.md",
        "status": "todo",
        "title": "Extend TOML parser for [env] section",
        "updated_at": "2026-01-20T04:52:07.383066Z"
      },
      "id": "fn-6-aaz.1",
      "spec": "# fn-6-aaz.1 Extend TOML parser for [env] section\n\n## Description\nExtend `parse-toml.py` to support the `[env]` section for env var import configuration.\n\n**Size:** S  \n**Files:** `agent-sandbox/parse-toml.py`\n\n## Approach\n\n- Follow existing pattern at `parse-toml.py:89-140` for section parsing\n- Add handler for `[env]` section with keys: `import` (list), `from_host` (bool), `env_file` (string)\n- Return env config as JSON alongside existing volume/excludes output\n\n## Key Context\n\n- Existing parser uses `tomllib` (Python 3.11+) or `tomli` fallback\n- Output format is JSON to stdout, consumed by bash\n- Error handling: invalid types should print clear error message\n## Acceptance\n- [ ] `[env].import` parsed as list of strings\n- [ ] `[env].from_host` parsed as boolean (default: false)\n- [ ] `[env].env_file` parsed as optional string\n- [ ] Invalid types produce clear error messages\n- [ ] Missing `[env]` section returns empty/null (not error)\n- [ ] JSON output includes env config\n## Done summary\nTBD\n\n## Evidence\n- Commits:\n- Tests:\n- PRs:\n"
    },
    {
      "data": {
        "assignee": null,
        "claim_note": "",
        "claimed_at": null,
        "created_at": "2026-01-20T04:51:49.528969Z",
        "depends_on": [
          "fn-6-aaz.1"
        ],
        "epic": "fn-6-aaz",
        "id": "fn-6-aaz.2",
        "priority": null,
        "spec_path": ".flow/tasks/fn-6-aaz.2.md",
        "status": "todo",
        "title": "Add env config resolution to lib/config.sh",
        "updated_at": "2026-01-20T05:24:07.754561Z"
      },
      "id": "fn-6-aaz.2",
      "spec": "# fn-6-aaz.2 Add env config resolution to lib/config.sh\n\n## Description\nAdd `_containai_resolve_env_config()` function to `lib/config.sh` for **dedicated** env import configuration resolution, independent of volume/excludes.\n\n**Size:** S  \n**Files:** `agent-sandbox/lib/config.sh`\n\n## Approach\n\n- Create `_containai_resolve_env_config()` as SEPARATE function (not tied to volume resolution)\n- Call `parse-toml.py` and extract `[env]` section\n- Return JSON with: `import` (array), `from_host` (bool), `env_file` (string or null)\n- Handle missing `[env]` gracefully (return defaults)\n- Handle missing/invalid `import` with `[WARN]` and treat as `[]`\n- This runs even if `--data-volume` or `--no-excludes` is used\n## Approach\n\n- Follow pattern at `lib/config.sh:441-512` (`_containai_resolve_volume`)\n- Call `parse-toml.py` and extract env section\n- Return JSON with: `import` (array), `from_host` (bool), `env_file` (string or null)\n- Handle missing config gracefully (return empty/defaults)\n## Acceptance\n- [ ] `_containai_resolve_env_config` function exists (separate from volume resolution)\n- [ ] Returns JSON with `import`, `from_host`, `env_file` keys\n- [ ] Missing `[env]` section: returns defaults `import=[]`, `from_host=false`, `env_file=null`\n- [ ] `[env]` exists but `import` missing/invalid: `[WARN]`, returns `import=[]`\n- [ ] Runs independently of `--data-volume` and `--no-excludes` flags\n- [ ] Calls `parse-toml.py` with correct arguments\n- [ ] Error handling follows existing patterns (if/else guards for set -e)\n- [ ] Python unavailable: returns defaults with `[WARN]`\n## Done summary\nTBD\n\n## Evidence\n- Commits:\n- Tests:\n- PRs:\n"
    },
    {
      "data": {
        "assignee": null,
        "claim_note": "",
        "claimed_at": null,
        "created_at": "2026-01-20T04:51:49.682088Z",
        "depends_on": [
          "fn-6-aaz.2"
        ],
        "epic": "fn-6-aaz",
        "id": "fn-6-aaz.3",
        "priority": null,
        "spec_path": ".flow/tasks/fn-6-aaz.3.md",
        "status": "todo",
        "title": "Implement env import core logic",
        "updated_at": "2026-01-20T05:24:27.793515Z"
      },
      "id": "fn-6-aaz.3",
      "spec": "# fn-6-aaz.3 Implement env import core logic\n\n## Description\nImplement core env var import logic with proper permission handling and multiline warning formats.\n\n**Size:** M  \n**Files:** `agent-sandbox/lib/env.sh` (new file)\n\n## Approach\n\n- Create new `lib/env.sh` with `_containai_import_env()` function\n- Validate var names, deduplicate allowlist\n- Parse source .env file with CRLF stripping\n- Read host env when enabled\n- **Permission handling**: Write as root in helper, then chown 1000:1000 + chmod 600\n- **Multiline warning format**:\n  - File: `[WARN] line N: key 'FOO' skipped (multiline value)`\n  - Host: `[WARN] source=host: key 'FOO' skipped (multiline value)`\n- Stream via stdin, TOCTOU-safe atomic write\n## Approach\n\n- Create new `lib/env.sh` with `_containai_import_env()` function\n- Validate var names against `^[A-Za-z_][A-Za-z0-9_]*$` - skip invalid with warning\n- Deduplicate allowlist preserving first occurrence\n- Parse source .env file with explicit rules (see epic spec)\n- Read host env using `printenv` filtered by validated allowlist\n- Merge sources (host takes precedence over file)\n- **Log hygiene**: Never print values or raw lines - warn with line_number + key + reason only\n- **Stream content via stdin** to avoid docker inspect exposure\n- **TOCTOU-safe atomic write**:\n  1. Verify mount point not symlink and is directory\n  2. Verify target .env not symlink (if exists)\n  3. Create temp via mktemp, verify not symlink\n  4. Write, chmod 600, mv to final\n\n## Key Context\n\n- Use `printf '%s\\n'` not `echo` (per conventions)\n- Use `[OK]`, `[WARN]`, `[ERROR]` markers\n- Pattern for stdin streaming: `printf '%s' \"$content\" | docker --context \"$ctx\" run --rm -i ...`\n- Helper container uses `--user 1000:1000` and `--network=none`\n## Approach\n\n- Create new `lib/env.sh` with `_containai_import_env()` function\n- Validate var names against `^[A-Za-z_][A-Za-z0-9_]*$` - skip invalid with warning\n- Parse source .env file using explicit rules:\n  - Accept `KEY=VALUE` lines (optionally `export ` prefix)\n  - Ignore `#` comment lines and blank lines\n  - Split on FIRST `=` only, preserve remainder as value\n  - Skip multiline values with warning\n  - Handle CRLF (strip `\\r`)\n- Read host env using `printenv` filtered by validated allowlist\n- Merge sources (host takes precedence over file)\n- **Stream content via stdin** (not `-e` args) to avoid docker inspect exposure\n- Write atomically: `.env.tmp.$$` + `chmod 600` + `mv`\n- Reject if target is symlink\n\n## Key Context\n\n- Use `printf '%s\\n'` not `echo` (per conventions)\n- Use `[OK]`, `[WARN]`, `[ERROR]` markers\n- Symlink validation: reject symlinks on both source .env file and target\n- Pattern for stdin streaming: `printf '%s' \"$content\" | docker run --rm -i ...`\n## Approach\n\n- Create new `lib/env.sh` with `_containai_import_env()` function\n- Parse source .env file using safe line-by-line reading (no eval/source)\n- Read from host env using `printenv` filtered by allowlist\n- Merge sources (host takes precedence over file)\n- Write atomically: temp file + `mv` rename\n- Set permissions `chmod 600`\n- Skip multiline values with warning\n\n## Key Context\n\n- Use `printf '%s\\n'` not `echo` (per conventions)\n- Use `[OK]`, `[WARN]`, `[ERROR]` markers\n- Docker env-file format: no quotes, literal values\n- Symlink validation: reject symlinks on source .env file\n## Acceptance\n- [ ] `_containai_import_env` function exists in `lib/env.sh`\n- [ ] Takes Docker context as parameter\n- [ ] Var names validated against `^[A-Za-z_][A-Za-z0-9_]*$`\n- [ ] Allowlist deduplicated preserving order\n- [ ] `env_file` path validated as workspace-relative (absolute rejected with error)\n- [ ] `env_file` missing/unreadable: **hard error** when set\n- [ ] CRLF stripping in file parser\n- [ ] Host env multiline check\n- [ ] **Multiline warning format**: file=`line N: key 'X'`, host=`source=host: key 'X'`\n- [ ] **Log hygiene**: Never prints values or raw lines\n- [ ] **Permission handling**: Write as root, chown 1000:1000, chmod 600\n- [ ] Streams content via stdin (no values in docker `-e` args)\n- [ ] TOCTOU-safe atomic write with symlink checks\n- [ ] Missing vars logged as `[WARN]` (key only), not fatal\n- [ ] Empty allowlist skips with `[INFO]`\n## Done summary\nTBD\n\n## Evidence\n- Commits:\n- Tests:\n- PRs:\n"
    },
    {
      "data": {
        "assignee": null,
        "claim_note": "",
        "claimed_at": null,
        "created_at": "2026-01-20T04:51:49.836522Z",
        "depends_on": [
          "fn-6-aaz.3"
        ],
        "epic": "fn-6-aaz",
        "id": "fn-6-aaz.4",
        "priority": null,
        "spec_path": ".flow/tasks/fn-6-aaz.4.md",
        "status": "todo",
        "title": "Integrate env import with cai import command",
        "updated_at": "2026-01-20T05:24:27.952214Z"
      },
      "id": "fn-6-aaz.4",
      "spec": "# fn-6-aaz.4 Integrate env import with cai import command\n\n## Description\nWire up env var import into `cai import` with full context plumbing for ALL docker commands.\n\n**Size:** M  \n**Files:** `agent-sandbox/lib/import.sh`, `agent-sandbox/containai.sh`\n\n## Approach\n\n- Source `lib/env.sh` in containai.sh\n- **Add context selection to _containai_import_cmd** (mirror lib/container.sh's _cai_select_context)\n- **Create docker_cmd or pass ctx** to ALL docker invocations in lib/import.sh\n- Apply context to: volume ops, rsync, transforms, orphan cleanup, AND .env helper\n- Neutralize DOCKER_CONTEXT/DOCKER_HOST when default context intended\n- Call dedicated `_containai_resolve_env_config()` (independent of volume/excludes)\n## Approach\n\n- Source `lib/env.sh` in containai.sh alongside other libs\n- **CRITICAL: Make context selection first-class for cai import**\n  - Reuse context-selection logic from `lib/container.sh`\n  - Explicitly neutralize `DOCKER_CONTEXT`/`DOCKER_HOST` when default context intended\n  - Pass context to ALL docker commands: volume ops, rsync, transforms, orphan cleanup, .env helper\n- Call env import after dotfile sync with context parameter\n- Dry-run: print keys only, no volume write\n## Approach\n\n- Source `lib/env.sh` in containai.sh alongside other libs\n- Call `_containai_resolve_env_config()` in import flow\n- Call `_containai_import_env()` after dotfile sync\n- **Use correct Docker context** for volume operations:\n  - Reuse context-selection logic from `lib/container.sh`\n  - Pass context to env import function\n  - Run `docker --context \"$ctx\"` for all volume ops\n- **Dry-run support**: Print what would be imported, no volume write\n## Approach\n\n- Source `lib/env.sh` in containai.sh alongside other libs\n- Call `_containai_resolve_env_config()` in import flow\n- Call `_containai_import_env()` after dotfile sync\n- Pass volume name and workspace to env import function\n- Use rsync container pattern (network=none) for writing to volume\n## Acceptance\n- [ ] `lib/env.sh` sourced in containai.sh\n- [ ] **Context selection added to _containai_import_cmd** (mirrors container.sh)\n- [ ] **docker_cmd or ctx parameter passed to ALL docker calls in import.sh**\n- [ ] Context applied to: volume inspect/create, rsync, transforms, orphan cleanup\n- [ ] Context applied to: new .env helper\n- [ ] DOCKER_CONTEXT/DOCKER_HOST neutralized for default context\n- [ ] Env config resolved via dedicated `_containai_resolve_env_config()`\n- [ ] Env config resolved even with `--data-volume` or `--no-excludes`\n- [ ] `.env` written to correct volume (same daemon as container will use)\n- [ ] Import summary includes env var count (keys only)\n- [ ] `--dry-run` prints keys only, no volume write/modification\n## Done summary\nTBD\n\n## Evidence\n- Commits:\n- Tests:\n- PRs:\n"
    },
    {
      "data": {
        "assignee": null,
        "claim_note": "",
        "claimed_at": null,
        "created_at": "2026-01-20T04:51:49.996344Z",
        "depends_on": [],
        "epic": "fn-6-aaz",
        "id": "fn-6-aaz.5",
        "priority": null,
        "spec_path": ".flow/tasks/fn-6-aaz.5.md",
        "status": "todo",
        "title": "Update entrypoint to source .env",
        "updated_at": "2026-01-20T05:24:40.569970Z"
      },
      "id": "fn-6-aaz.5",
      "spec": "# fn-6-aaz.5 Update entrypoint to source .env\n\n## Description\nUpdate container entrypoint to safely load `.env` file with CRLF handling and `set -e` safety.\n\n**Size:** S  \n**Files:** `agent-sandbox/entrypoint.sh`\n\n## Approach\n\n- **Load timing**: After ownership fix (chown) completes\n- Implement safe line parser with CRLF stripping (`${line%$'\\r'}`)\n- **set -e safety**: Use explicit `if [[ -f/-r/-L ]]` guards (not raw reads)\n- Error handling: unreadable/malformed warns and continues\n- Malformed line warnings include line number + key (no value)\n- Mirror existing anti-symlink helpers\n## Approach\n\n- **Load timing**: After ownership fix (chown) completes - volume may be unreadable until then\n- Implement safe line parser (no `source`, no `eval`)\n- Read `/mnt/agent-data/.env` line by line\n- For each `KEY=VALUE` line:\n  - Validate KEY format\n  - **Only export if KEY not already in environment** (`-z \"${!key+x}\"` check)\n  - \"Present\" means set even if empty - `KEY=\"\"` counts as present\n  - Use safe assignment without eval\n- **Error handling**:\n  - Unreadable .env: `[WARN]` and continue (do not abort)\n  - Malformed lines: `[WARN]` per line, continue with valid lines\n  - Missing .env: silent (expected for first run)\n- Reject symlinks (mirror existing anti-symlink helpers)\n## Approach\n\n- Implement safe line parser (no `source`, no `eval`)\n- Read `/mnt/agent-data/.env` line by line\n- For each `KEY=VALUE` line:\n  - Validate KEY format\n  - **Only export if KEY not already in environment** (preserves `-e` flag precedence)\n  - Use `export \"$line\"` for safe assignment\n- Ignore `#` comments and blank lines\n- Reject symlinks (security)\n- Follow pattern at `entrypoint.sh:122-208` for file validation\n## Approach\n\n- Add sourcing near start of entrypoint, after volume structure setup\n- Use `set -a` to auto-export, then `source`, then `set +a`\n- Only source if file exists and is regular file (not symlink)\n- Follow pattern at `entrypoint.sh:122-208` for file validation\n## Acceptance\n- [ ] Entrypoint loads `/mnt/agent-data/.env` if present\n- [ ] **Load timing**: After ownership fix (chown) completes\n- [ ] **CRLF stripping**: `${line%$'\\r'}` applied\n- [ ] **set -e safety**: Uses `if [[ -f ]]`, `if [[ -r ]]`, `if [[ -L ]]` guards\n- [ ] **NO shell `source`** - uses safe line-by-line parser\n- [ ] Only exports KEY if NOT already in environment\n- [ ] \"Present\" = set even if empty (`KEY=\"\"` not overwritten)\n- [ ] Validates KEY format before export\n- [ ] Unreadable .env: warns and continues (no abort)\n- [ ] Malformed lines: warns with line number + key (no value)\n- [ ] Missing .env: silent (expected)\n- [ ] Rejects symlinks (mirrors existing helpers)\n- [ ] Log message: `[INFO] Loading environment from .env`\n## Done summary\nTBD\n\n## Evidence\n- Commits:\n- Tests:\n- PRs:\n"
    },
    {
      "data": {
        "assignee": null,
        "claim_note": "",
        "claimed_at": null,
        "created_at": "2026-01-20T04:51:50.160794Z",
        "depends_on": [
          "fn-6-aaz.4",
          "fn-6-aaz.5"
        ],
        "epic": "fn-6-aaz",
        "id": "fn-6-aaz.6",
        "priority": null,
        "spec_path": ".flow/tasks/fn-6-aaz.6.md",
        "status": "todo",
        "title": "Add integration tests for env import",
        "updated_at": "2026-01-20T05:16:11.137498Z"
      },
      "id": "fn-6-aaz.6",
      "spec": "# fn-6-aaz.6 Add integration tests for env import\n\n## Description\nAdd integration tests for env var import feature covering all acceptance criteria including context handling and edge cases.\n\n**Size:** M  \n**Files:** `agent-sandbox/test-sync-integration.sh` (extend existing)\n\n## Approach\n\n- Follow test patterns at `test-sync-integration.sh:170-300`\n- Create test volume with unique name: `containai-test-env-${TEST_RUN_ID}`\n- Test all 18 acceptance criteria from epic spec\n- Use `env -u` to clear external vars for hermetic tests\n- Cleanup test volumes after tests\n- Test context-aware behavior if multiple contexts available\n## Approach\n\n- Follow test patterns at `test-sync-integration.sh:170-300`\n- Create test volume with unique name: `containai-test-env-${TEST_RUN_ID}`\n- Test all acceptance criteria from epic spec\n- Use `env -u` to clear external vars for hermetic tests\n- Cleanup test volumes after tests\n## Approach\n\n- Follow test patterns at `test-sync-integration.sh:170-300`\n- Create test volume with unique name: `containai-test-env-${TEST_RUN_ID}`\n- Test cases: basic import, from_host flag, env_file source, missing vars, multiline skip\n- Use `env -u` to clear external vars for hermetic tests\n- Cleanup test volumes after tests\n## Acceptance\n- [ ] Test: basic allowlist import from host env\n- [ ] Test: `from_host=false` prevents host env reading\n- [ ] Test: source .env file parsed correctly\n- [ ] Test: merge precedence (host > file)\n- [ ] Test: missing vars produce warning (key only), not error\n- [ ] Test: multiline values skipped with warning (line number + key)\n- [ ] Test: empty allowlist skips with INFO\n- [ ] Test: .env file has correct permissions (0600)\n- [ ] Test: invalid var names skipped with warning\n- [ ] Test: duplicate allowlist keys deduplicated\n- [ ] Test: `export KEY=VALUE` format accepted\n- [ ] Test: values with spaces preserved\n- [ ] Test: CRLF line endings handled\n- [ ] Test: entrypoint only sets vars not in environment\n- [ ] Test: runtime `-e` flags take precedence (empty string = present)\n- [ ] Test: dry-run prints keys only, no volume write\n- [ ] Test: symlink source .env rejected\n- [ ] Test: TOCTOU protection (symlink checks on mount/target/temp)\n- [ ] Test: log hygiene - values never printed in warnings\n- [ ] Test: env_file absolute path rejected\n- [ ] Test: env_file outside workspace rejected\n- [ ] Test: entrypoint loads after ownership fix\n- [ ] Test: unreadable .env warns, continues\n- [ ] Tests use hermetic env (env -u)\n- [ ] Test volumes cleaned up\n## Done summary\nTBD\n\n## Evidence\n- Commits:\n- Tests:\n- PRs:\n"
    }
  ]
}
