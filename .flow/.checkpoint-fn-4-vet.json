{
  "created_at": "2026-01-18T22:20:15.512239Z",
  "epic": {
    "data": {
      "branch_name": "fn-4-vet",
      "created_at": "2026-01-18T20:15:15.808072Z",
      "depends_on_epics": [],
      "id": "fn-4-vet",
      "next_task": 1,
      "plan_review_status": "ship",
      "plan_reviewed_at": "2026-01-18T21:26:42.037147Z",
      "spec_path": ".flow/specs/fn-4-vet.md",
      "status": "open",
      "title": "Configurable Volume Names & ContainAI Rename",
      "updated_at": "2026-01-18T22:17:45.538951Z"
    },
    "spec": "# Configurable Volumes & ContainAI CLI\n\n## Overview\n\nReplace the hardcoded `sandbox-agent-data` volume with a configurable system. Rename from \"agent-sandbox\" to \"ContainAI\" with a new unified CLI (`containai`/`cai`). Integrate sync functionality as subcommands.\n\n### Key Design Decisions\n- **No backwards compat**: `asb*` aliases removed entirely\n- **Python 3.11+ only**: Use `tomllib`, no fallback\n- **Absolute paths only**: Workspace paths in config must be absolute\n- **Subcommand CLI**: `cai shell`, `cai import`, `cai export`\n- **Cumulative excludes**: Default + per-volume exclude patterns\n\n## Scope\n\n### In Scope\n- TOML config file with workspace-based volume selection\n- `cai` / `containai` unified CLI with subcommands\n- `cai import` - Import configs from host (replaces sync-agent-plugins.sh)\n- `cai export` - Export volume to .tgz archive\n- Exclude patterns: default + per-volume (cumulative)\n- Config locations: `.containai/config.toml`, `~/.config/containai/config.toml`\n\n### Out of Scope\n- Backwards compatibility (`asb*` aliases removed)\n- Old Python support (3.11+ required for tomllib)\n- Relative paths in workspace config (absolute only)\n- Export encryption (future scope)\n- Volume migration commands\n\n## TOML Schema\n\n```toml\n# .containai/config.toml\n\n[agent]\ndata_volume = \"sandbox-agent-data\"  # Default volume name\n\n# Default exclude patterns for ALL volumes during import\n# Patterns are rsync-compatible (relative to sync root)\ndefault_excludes = [\n  \".vscode-server/data/User/settings.json\",\n  \".vscode-server/data/User/keybindings.json\",\n  \".vscode-server-insiders/data/User/settings.json\",\n  \".vscode-server-insiders/data/User/keybindings.json\",\n]\n\n# Workspace-specific config - keys are ABSOLUTE paths only\n[workspace.\"/home/user/projects/frontend\"]\ndata_volume = \"frontend-data\"\n# Additional excludes (cumulative with default_excludes)\nexcludes = [\n  \"node_modules/\",\n]\n\n[workspace.\"/home/user/projects/backend\"]\ndata_volume = \"backend-data\"\nexcludes = []  # Only default_excludes apply\n```\n\n### Workspace Path Matching\n- **Absolute paths only** - No relative paths, no `./` prefix\n- **Path-segment boundary**: `/a/b` matches `/a/b` and `/a/b/c` but NOT `/a/bc`\n- **Longest match wins**: `/a/b/c` preferred over `/a/b` when both match\n\n## CLI Design\n\n### Main Entry Points\n```bash\ncontainai [subcommand] [options]\ncai [subcommand] [options]  # Short alias\n```\n\n### Subcommands\n\n| Command | Description |\n|---------|-------------|\n| `cai` (no args) | Start/attach to sandbox container (default) |\n| `cai shell` | Open interactive shell in running sandbox |\n| `cai import` | Sync configs from host to volume |\n| `cai export` | Export volume to .tgz archive |\n| `cai stop` | Stop all ContainAI containers |\n\n### Common Flags (all subcommands)\n| Flag | Description |\n|------|-------------|\n| `--data-volume <name>` | Override volume name (highest priority) |\n| `--config <path>` | Explicit config file path |\n| `--workspace <path>` | Host workspace path (also for config lookup) |\n\n### Import-specific Flags\n| Flag | Description |\n|------|-------------|\n| `--dry-run` | Show what would be synced without making changes |\n| `--no-excludes` | Ignore all exclude patterns |\n\n### Export-specific Flags\n| Flag | Description |\n|------|-------------|\n| `-o, --output <path>` | Output .tgz path (default: `./containai-export-<timestamp>.tgz`) |\n| `--no-excludes` | Include all files (ignore excludes) |\n\n## Value Precedence\n\n| Priority | Source |\n|----------|--------|\n| 1 | `--data-volume <name>` |\n| 2 | `CONTAINAI_DATA_VOLUME` env |\n| 3 | Config `[workspace.<path>].data_volume` |\n| 4 | Config `[agent].data_volume` |\n| 5 | Default: `sandbox-agent-data` |\n\n## Exclude Pattern Behavior\n\n**During import (`cai import`):**\n1. Load `default_excludes` from config (or empty if not set)\n2. Find matching workspace section by path\n3. Merge workspace `excludes` (if any) with `default_excludes`\n4. Pass combined patterns to rsync as `--exclude` flags\n\n**During export (`cai export`):**\n- Same logic: `default_excludes` + matched workspace `excludes`\n- Files matching patterns are omitted from .tgz\n\n**Pattern syntax:**\n- Standard rsync patterns (relative to volume mount point)\n- Examples: `*.log`, `node_modules/`, `.vscode-server/data/User/settings.json`\n\n## Implementation\n\n### File Structure\n```\nagent-sandbox/\n\u251c\u2500\u2500 containai.sh          # Main CLI entry point\n\u251c\u2500\u2500 lib/\n\u2502   \u251c\u2500\u2500 config.sh         # Config loading & parsing\n\u2502   \u251c\u2500\u2500 volume.sh         # Volume resolution\n\u2502   \u251c\u2500\u2500 container.sh      # Container operations\n\u2502   \u251c\u2500\u2500 import.sh         # Import subcommand\n\u2502   \u2514\u2500\u2500 export.sh         # Export subcommand\n\u251c\u2500\u2500 parse-toml.py         # TOML parser (Python 3.11+)\n\u2514\u2500\u2500 aliases.sh            # DELETED (replaced by containai.sh)\n```\n\n### Python TOML Parser\n\n```python\n#!/usr/bin/env python3\n\"\"\"Parse TOML config for ContainAI. Requires Python 3.11+ (tomllib).\"\"\"\nimport sys\nimport tomllib\nimport json\nfrom pathlib import Path\n\ndef find_matching_workspace(config: dict, workspace: str) -> dict | None:\n    \"\"\"Find workspace section with longest matching path.\"\"\"\n    workspace = Path(workspace).resolve()\n    workspaces = config.get(\"workspace\", {})\n    \n    best_match = None\n    best_length = 0\n    \n    for path_str, section in workspaces.items():\n        config_path = Path(path_str)\n        if not config_path.is_absolute():\n            continue  # Skip non-absolute paths\n        \n        # Check path-segment boundary match\n        try:\n            workspace.relative_to(config_path)\n            if len(str(config_path)) > best_length:\n                best_match = section\n                best_length = len(str(config_path))\n        except ValueError:\n            continue\n    \n    return best_match\n\ndef main():\n    if len(sys.argv) < 3:\n        print(\"Usage: parse-toml.py <config_file> <workspace_path>\", file=sys.stderr)\n        sys.exit(1)\n    \n    config_file = Path(sys.argv[1])\n    workspace = sys.argv[2]\n    \n    with open(config_file, \"rb\") as f:\n        config = tomllib.load(f)\n    \n    # Find matching workspace\n    ws_config = find_matching_workspace(config, workspace)\n    agent_config = config.get(\"agent\", {})\n    \n    # Resolve values with precedence\n    result = {\n        \"data_volume\": (\n            ws_config.get(\"data_volume\") if ws_config \n            else agent_config.get(\"data_volume\", \"sandbox-agent-data\")\n        ),\n        \"excludes\": list(set(\n            config.get(\"default_excludes\", []) + \n            (ws_config.get(\"excludes\", []) if ws_config else [])\n        ))\n    }\n    \n    print(json.dumps(result))\n\nif __name__ == \"__main__\":\n    main()\n```\n\n## Quick Commands\n\n```bash\n# Source the new CLI\nsource agent-sandbox/containai.sh\n\n# Test default behavior\ncai -- echo \"hello from container\"\n\n# Test config-based volume\nmkdir -p .containai\ncat > .containai/config.toml << 'EOF'\n[agent]\ndata_volume = \"test-volume\"\ndefault_excludes = [\".vscode-server/data/User/settings.json\"]\nEOF\ncai -- echo \"using test-volume\"\n\n# Test import with dry-run\ncai import --dry-run\n\n# Test export\ncai export -o /tmp/backup.tgz\n\n# Test stop\ncai stop\n```\n\n## Acceptance Criteria\n\n1. **`asb*` aliases removed**: Old aliases no longer exist\n2. **`cai` works**: Starts/attaches to container with correct volume\n3. **Config discovery**: Finds `.containai/config.toml` walking up from workspace\n4. **Workspace matching**: Absolute paths with segment boundary, longest wins\n5. **`cai import` works**: Syncs configs respecting excludes\n6. **`cai export` works**: Creates .tgz with excludes applied\n7. **`cai stop` works**: Stops all ContainAI containers\n8. **Excludes are cumulative**: `default_excludes` + workspace `excludes`\n9. **Python 3.11+ required**: Fails gracefully if Python < 3.11\n\n## References\n\n- Current sync logic: `agent-sandbox/sync-agent-plugins.sh`\n- Current container logic: `agent-sandbox/aliases.sh`\n- TOML spec: https://toml.io/en/v1.0.0\n"
  },
  "epic_id": "fn-4-vet",
  "schema_version": 1,
  "tasks": [
    {
      "data": {
        "assignee": null,
        "claim_note": "",
        "claimed_at": null,
        "created_at": "2026-01-18T20:16:02.042611Z",
        "depends_on": [],
        "epic": "fn-4-vet",
        "id": "fn-4-vet.1",
        "priority": null,
        "spec_path": ".flow/tasks/fn-4-vet.1.md",
        "status": "todo",
        "title": "Add TOML config parser helper script",
        "updated_at": "2026-01-18T21:26:22.541724Z"
      },
      "id": "fn-4-vet.1",
      "spec": "# fn-4-vet.1 Add TOML config parser helper script\n\n## Description\n## Overview\nCreate a Python helper script that parses TOML config files and resolves the volume name based on workspace path matching using **path-segment boundary matching** (longest match wins).\n\n## Implementation\n\n### File Location\n`agent-sandbox/parse-toml.py`\n\n### Python Version Handling\nThe script must handle Python version detection internally:\n```python\n#!/usr/bin/env python3\nimport sys\n\ntry:\n    import tomllib  # Python 3.11+\nexcept ImportError:\n    try:\n        import tomli as tomllib  # Fallback for Python < 3.11\n    except ImportError:\n        print(\"Error: Python 3.11+ or tomli package required\", file=sys.stderr)\n        sys.exit(1)\n```\n\n### Workspace Matching Algorithm (Path-Segment Boundary)\n\nA section path P matches workspace W if:\n- W equals P exactly, OR\n- W starts with P AND the character after P in W is `/`\n\nExample:\n- `/a/b` matches `/a/b` \u2713 (exact)\n- `/a/b` matches `/a/b/c` \u2713 (prefix with / boundary)\n- `/a/b` does NOT match `/a/bc` \u2717 (no segment boundary)\n\n### Script Modes\n\n**Mode 1: Simple key lookup**\n```bash\npython3 parse-toml.py <config-file> <key-path>\n```\n\n**Mode 2: Workspace path matching**\n```bash\npython3 parse-toml.py <config-file> --workspace <path> --config-dir <dir>\n```\n\n### Examples\n\n```bash\n# Longest segment-boundary match\n# [workspace.\"/a/b\"] and [workspace.\"/a/b/c\"] both exist\npython3 parse-toml.py config.toml --workspace /a/b/c/d --config-dir /\n# Returns value from [workspace.\"/a/b/c\"] (longer match)\n\n# Segment boundary prevents false match\npython3 parse-toml.py config.toml --workspace /a/bc --config-dir /\n# Does NOT match [workspace.\"/a/b\"], falls back to [agent]\n```\n\n## Key Files\n- Create: `agent-sandbox/parse-toml.py`\n## Overview\nCreate a Python helper script that parses TOML config files and resolves the volume name based on workspace path matching using **longest prefix match** (no glob patterns in v1).\n\n## Implementation\n\n### File Location\n`agent-sandbox/parse-toml.py`\n\n### Script Modes\n\n**Mode 1: Simple key lookup**\n```bash\npython3 parse-toml.py <config-file> <key-path>\n# Example: python3 parse-toml.py config.toml agent.data_volume\n```\n\n**Mode 2: Workspace path matching**\n```bash\npython3 parse-toml.py <config-file> --workspace <path> --config-dir <dir>\n# Example: python3 parse-toml.py config.toml --workspace /home/user/myproject --config-dir /home/user\n```\n\n### Workspace Matching Algorithm (v1 - Prefix Match)\n\n1. Get all `[workspace.<path>]` sections from config\n2. For each section:\n   - If path starts with `./` or `../`: resolve relative to `--config-dir`\n   - Otherwise treat as absolute path\n   - Normalize (remove trailing slashes)\n3. Compare workspace path against all normalized section paths\n4. **Longest matching prefix wins** (simple string prefix, not glob)\n5. Return `data_volume` from matched section\n6. Fall back to `[agent].data_volume` if no match\n7. Return empty string if no fallback exists\n\n### Examples\n\n```bash\n# Config file:\n# [agent]\n# data_volume = \"default\"\n# [workspace.\"/home/user/project\"]\n# data_volume = \"project-vol\"\n# [workspace.\"/home/user/project/subdir\"]\n# data_volume = \"subdir-vol\"\n\n# Exact match\npython3 parse-toml.py config.toml --workspace /home/user/project --config-dir /home/user\n# Returns: project-vol\n\n# Longest prefix match\npython3 parse-toml.py config.toml --workspace /home/user/project/subdir --config-dir /home/user\n# Returns: subdir-vol (longer match wins over /home/user/project)\n\n# No match, fallback to [agent]\npython3 parse-toml.py config.toml --workspace /other/path --config-dir /home/user\n# Returns: default\n```\n\n### Error Handling\n- File not found: stderr message, exit 1\n- Invalid TOML syntax: stderr with file path and error, exit 1\n- Missing key/no match: empty stdout, exit 0\n\n## Key Files\n- Create: `agent-sandbox/parse-toml.py`\n## Overview\nCreate a Python helper script that parses TOML config files and resolves the volume name based on workspace path matching. This enables bash scripts to read TOML configuration with workspace-specific overrides.\n\n## Implementation\n\n### File Location\n`agent-sandbox/parse-toml.py`\n\n### Script Modes\n\n**Mode 1: Simple key lookup**\n```bash\npython3 parse-toml.py <config-file> <key-path>\n# Example: python3 parse-toml.py config.toml agent.data_volume\n# Output: my-project-data\n```\n\n**Mode 2: Workspace path matching**\n```bash\npython3 parse-toml.py <config-file> --workspace <path> --config-dir <dir>\n# Example: python3 parse-toml.py config.toml --workspace /home/user/myproject --config-dir /home/user\n# Output: project-specific-volume (or fallback to agent.data_volume)\n```\n\n### Workspace Matching Logic\n\n1. Get all `[workspace.<path>]` sections from config\n2. For each section:\n   - If path starts with `./` or `../`, resolve relative to `--config-dir`\n   - Otherwise treat as absolute path\n   - Support glob patterns (e.g., `*/tests`)\n3. Match against provided `--workspace` path\n4. **Longest match wins** when multiple patterns match\n5. Return `data_volume` from matched section\n6. Fall back to `[agent].data_volume` if no match\n7. Return empty string if no fallback exists\n\n### Interface Examples\n\n```bash\n# Simple key lookup\npython3 parse-toml.py .containai/config.toml agent.data_volume\n# Output: default-vol\n\n# Workspace matching - exact match\npython3 parse-toml.py config.toml --workspace /home/user/project --config-dir /home/user\n# Matches [workspace.\"/home/user/project\"] if exists\n\n# Workspace matching - relative path\npython3 parse-toml.py config.toml --workspace /repo/subdir --config-dir /repo\n# Matches [workspace.\"./subdir\"] resolved to /repo/subdir\n\n# Workspace matching - glob\npython3 parse-toml.py config.toml --workspace /home/user/project/tests --config-dir /home/user\n# Matches [workspace.\"*/tests\"] \n\n# No match - falls back to [agent]\npython3 parse-toml.py config.toml --workspace /other/path --config-dir /home/user\n# Returns [agent].data_volume value\n```\n\n### Error Handling\n- File not found: stderr message, exit 1\n- Invalid TOML syntax: stderr with file path and error, exit 1\n- Missing key/no match: empty stdout, exit 0 (allows fallback to default)\n\n## Key Files\n- Create: `agent-sandbox/parse-toml.py`\n## Overview\nCreate a minimal Python helper script that parses TOML config files and outputs the value of a specific key. This enables bash scripts to read TOML configuration. **Python is optional** - the bash wrapper must handle missing Python gracefully.\n\n## Implementation\n\n### File Location\n`agent-sandbox/parse-toml.py`\n\n### Script Requirements\n1. Accept config file path and key path as arguments\n2. Output the value to stdout (no newline if single value)\n3. Exit 0 on success, non-zero on error\n4. Support nested keys with dot notation: `agent.data_volume`, `profile.testing.data_volume`\n5. Use `tomllib` (Python 3.11+) with fallback to `tomli`\n\n### Interface\n```bash\n# Usage: parse-toml.py <config-file> <key-path>\npython3 agent-sandbox/parse-toml.py .containai/config.toml agent.data_volume\n# Output: my-project-data\n\n# Missing key returns empty string, exit 0\npython3 agent-sandbox/parse-toml.py .containai/config.toml missing.key\n# Output: (empty)\n\n# Invalid file returns error, exit 1\npython3 agent-sandbox/parse-toml.py nonexistent.toml agent.data_volume\n# stderr: Error: File not found: nonexistent.toml\n```\n\n### Error Handling\n- File not found: stderr message, exit 1\n- Invalid TOML syntax: stderr with file path and error, exit 1\n- Missing key: empty stdout, exit 0 (allows fallback to default)\n- Bash wrapper handles missing Python separately (not this script's concern)\n\n## Key Files\n- Create: `agent-sandbox/parse-toml.py`\n- Reference: `agent-sandbox/entrypoint.sh` for error message patterns\n## Overview\nCreate a minimal Python helper script that parses TOML config files and outputs the value of a specific key. This enables bash scripts to read TOML configuration without complex parsing logic.\n\n## Implementation\n\n### File Location\n`agent-sandbox/parse-toml.py`\n\n### Script Requirements\n1. Accept config file path and key path as arguments\n2. Output the value to stdout (no newline if single value)\n3. Exit 0 on success, non-zero on error\n4. Support nested keys with dot notation: `agent.volume`\n5. Use `tomllib` (Python 3.11+) with fallback to `tomli`\n\n### Interface\n```bash\n# Usage: parse-toml.py <config-file> <key-path>\npython3 agent-sandbox/parse-toml.py .containai/config.toml agent.volume\n# Output: my-project-data\n\n# Missing key returns empty string, exit 0\npython3 agent-sandbox/parse-toml.py .containai/config.toml missing.key\n# Output: (empty)\n\n# Invalid file returns error, exit 1\npython3 agent-sandbox/parse-toml.py nonexistent.toml agent.volume\n# stderr: Error: File not found: nonexistent.toml\n```\n\n### Error Handling\n- File not found: stderr message, exit 1\n- Invalid TOML syntax: stderr with file path and error, exit 1\n- Missing key: empty stdout, exit 0 (allows fallback to default)\n- Missing Python: bash wrapper should detect and error gracefully\n\n## Key Files\n- Create: `agent-sandbox/parse-toml.py`\n- Reference: `agent-sandbox/entrypoint.sh` for error message patterns\n## Acceptance\n- [ ] Script handles Python version: tries tomllib, falls back to tomli\n- [ ] Errors with clear message if neither tomllib nor tomli available\n- [ ] Simple key lookup works\n- [ ] Workspace matching with absolute paths works\n- [ ] Workspace matching with relative paths works\n- [ ] **Path-segment boundary matching**: /a/b matches /a/b/c but NOT /a/bc\n- [ ] **Longest match wins** among valid matches\n- [ ] Falls back to `[agent].data_volume` when no match\n- [ ] Returns empty for no match (exit 0)\n- [ ] Errors on invalid file/TOML (exit 1)\n- [ ] Has shebang `#!/usr/bin/env python3`\n## Done summary\nTBD\n\n## Evidence\n- Commits:\n- Tests:\n- PRs:\n"
    },
    {
      "data": {
        "assignee": null,
        "claim_note": "",
        "claimed_at": null,
        "created_at": "2026-01-18T22:18:04.807146Z",
        "depends_on": [
          "fn-4-vet.8"
        ],
        "epic": "fn-4-vet",
        "id": "fn-4-vet.10",
        "priority": null,
        "spec_path": ".flow/tasks/fn-4-vet.10.md",
        "status": "todo",
        "title": "Create lib/import.sh - cai import subcommand",
        "updated_at": "2026-01-18T22:19:22.841409Z"
      },
      "id": "fn-4-vet.10",
      "spec": "# fn-4-vet.10 Create lib/import.sh - cai import subcommand\n\n## Description\nCreate `agent-sandbox/lib/import.sh` - the `cai import` subcommand.\n\n## Implementation\n\nRefactor `sync-agent-plugins.sh` logic into a sourceable library:\n\n### `_containai_import(volume, excludes_array, dry_run)`\n\n1. Validate prerequisites (docker, jq)\n2. Ensure volume exists (unless dry-run)\n3. Build exclude flags from `excludes_array`\n4. Run rsync via eeacms/rsync container with SYNC_MAP\n5. Output \"Using data volume: $volume\" for verification\n\n## SYNC_MAP\n\nKeep existing SYNC_MAP from sync-agent-plugins.sh:39-98 but make it configurable:\n- Load from config if present\n- Fall back to hardcoded defaults\n\n## Exclude Integration\n\n```bash\n# Merge default_excludes + workspace excludes from config\n# Pass each as --exclude to rsync in container script\nfor pattern in \"${excludes[@]}\"; do\n    rsync_opts+=(--exclude \"$pattern\")\ndone\n```\n\n## Key Points\n- Must work standalone: `source lib/config.sh && source lib/import.sh`\n- Respects `--dry-run` flag\n- Respects `--no-excludes` to disable all exclusions\n- Prints resolved volume name for verification\n## Acceptance\n- [ ] File exists at `agent-sandbox/lib/import.sh`\n- [ ] `_containai_import` function works correctly\n- [ ] Exclude patterns passed to rsync\n- [ ] `--dry-run` shows what would sync without changes\n- [ ] `--no-excludes` ignores all exclude patterns\n- [ ] Outputs \"Using data volume: <name>\" \n- [ ] Can be sourced with lib/config.sh\n## Done summary\nTBD\n\n## Evidence\n- Commits:\n- Tests:\n- PRs:\n"
    },
    {
      "data": {
        "assignee": null,
        "claim_note": "",
        "claimed_at": null,
        "created_at": "2026-01-18T22:18:04.962623Z",
        "depends_on": [
          "fn-4-vet.8"
        ],
        "epic": "fn-4-vet",
        "id": "fn-4-vet.11",
        "priority": null,
        "spec_path": ".flow/tasks/fn-4-vet.11.md",
        "status": "todo",
        "title": "Create lib/export.sh - cai export subcommand",
        "updated_at": "2026-01-18T22:19:31.539321Z"
      },
      "id": "fn-4-vet.11",
      "spec": "# fn-4-vet.11 Create lib/export.sh - cai export subcommand\n\n## Description\nCreate `agent-sandbox/lib/export.sh` - the `cai export` subcommand.\n\n## Implementation\n\n### `_containai_export(volume, output_path, excludes_array, no_excludes)`\n\n1. Validate volume exists\n2. Determine output path (default: `./containai-export-$(date +%Y%m%d-%H%M%S).tgz`)\n3. Build tar exclude flags from `excludes_array` (unless `no_excludes`)\n4. Run tar via docker container mounting the volume\n5. Output archive path\n\n## Docker Approach\n\n```bash\ndocker run --rm \\\n  -v \"${volume}:/data:ro\" \\\n  -v \"$(dirname \"$output_path\"):/out\" \\\n  alpine:latest \\\n  tar -czf \"/out/$(basename \"$output_path\")\" \\\n  ${exclude_flags[@]} \\\n  -C /data .\n```\n\n## Exclude Flags\n\n```bash\n# Convert excludes to tar --exclude patterns\nfor pattern in \"${excludes[@]}\"; do\n    tar_opts+=(--exclude \"$pattern\")\ndone\n```\n\n## Key Points\n- Volume mounted read-only for safety\n- Output to current dir by default, or specified `-o` path\n- Respects cumulative excludes from config\n- `--no-excludes` includes everything\n## Acceptance\n- [ ] File exists at `agent-sandbox/lib/export.sh`\n- [ ] `_containai_export` creates valid .tgz archive\n- [ ] Exclude patterns applied to tar\n- [ ] `-o/--output` specifies output path\n- [ ] `--no-excludes` includes all files\n- [ ] Volume mounted read-only\n- [ ] Outputs archive path on success\n## Done summary\nTBD\n\n## Evidence\n- Commits:\n- Tests:\n- PRs:\n"
    },
    {
      "data": {
        "assignee": null,
        "claim_note": "",
        "claimed_at": null,
        "created_at": "2026-01-18T22:18:05.114181Z",
        "depends_on": [
          "fn-4-vet.9",
          "fn-4-vet.10",
          "fn-4-vet.11"
        ],
        "epic": "fn-4-vet",
        "id": "fn-4-vet.12",
        "priority": null,
        "spec_path": ".flow/tasks/fn-4-vet.12.md",
        "status": "todo",
        "title": "Create containai.sh - main CLI entry point",
        "updated_at": "2026-01-18T22:19:44.563070Z"
      },
      "id": "fn-4-vet.12",
      "spec": "# fn-4-vet.12 Create containai.sh - main CLI entry point\n\n## Description\nCreate `agent-sandbox/containai.sh` - the main CLI entry point.\n\n## Structure\n\n```bash\n#!/usr/bin/env bash\n# ContainAI CLI\n\n_CAI_SCRIPT_DIR=\"$(cd \"$(dirname \"${BASH_SOURCE[0]}\")\" && pwd)\"\nsource \"$_CAI_SCRIPT_DIR/lib/config.sh\"\nsource \"$_CAI_SCRIPT_DIR/lib/container.sh\"\nsource \"$_CAI_SCRIPT_DIR/lib/import.sh\"\nsource \"$_CAI_SCRIPT_DIR/lib/export.sh\"\n\ncontainai() {\n    local subcommand=\"${1:-}\"\n    shift 2>/dev/null || true\n    \n    case \"$subcommand\" in\n        shell)   _containai_shell \"$@\" ;;\n        import)  _containai_import_cmd \"$@\" ;;\n        export)  _containai_export_cmd \"$@\" ;;\n        stop)    _containai_stop_all \"$@\" ;;\n        help|-h|--help) _containai_help ;;\n        *)       _containai_run \"$subcommand\" \"$@\" ;;  # Default: start container\n    esac\n}\n\n# Short alias\ncai() { containai \"$@\"; }\n```\n\n## Subcommand Handlers\n\n### `_containai_run(args...)`\nParse common flags (`--data-volume`, `--config`, `--workspace`), resolve volume,\nstart/attach to container. Core logic from aliases.sh `asb()`.\n\n### `_containai_shell(args...)`\nOpen shell in running container. Logic from `asb-shell()`.\n\n### `_containai_import_cmd(args...)`\nParse `--dry-run`, `--no-excludes`. Call `_containai_import()` from lib/import.sh.\n\n### `_containai_export_cmd(args...)`\nParse `-o/--output`, `--no-excludes`. Call `_containai_export()` from lib/export.sh.\n\n### `_containai_help()`\nPrint usage help.\n\n## Common Flag Parsing\n\n```bash\n_containai_parse_common_flags() {\n    while [[ $# -gt 0 ]]; do\n        case \"$1\" in\n            --data-volume) _CAI_CLI_VOLUME=\"$2\"; shift 2 ;;\n            --config)      _CAI_CLI_CONFIG=\"$2\"; shift 2 ;;\n            --workspace)   _CAI_CLI_WORKSPACE=\"$2\"; shift 2 ;;\n            --)            shift; break ;;\n            *)             break ;;\n        esac\n    done\n    # Return remaining args\n    printf '%s\\n' \"$@\"\n}\n```\n## Acceptance\n- [ ] File exists at `agent-sandbox/containai.sh`\n- [ ] `containai` function routes to subcommands\n- [ ] `cai` alias works\n- [ ] `cai` (no args) starts/attaches container\n- [ ] `cai shell` opens shell in running container\n- [ ] `cai import` syncs configs with exclude support\n- [ ] `cai export` creates .tgz archive\n- [ ] `cai stop` stops all containers\n- [ ] Common flags parsed correctly across subcommands\n## Done summary\nTBD\n\n## Evidence\n- Commits:\n- Tests:\n- PRs:\n"
    },
    {
      "data": {
        "assignee": null,
        "claim_note": "",
        "claimed_at": null,
        "created_at": "2026-01-18T22:18:05.265708Z",
        "depends_on": [
          "fn-4-vet.12"
        ],
        "epic": "fn-4-vet",
        "id": "fn-4-vet.13",
        "priority": null,
        "spec_path": ".flow/tasks/fn-4-vet.13.md",
        "status": "todo",
        "title": "Delete aliases.sh and update tests",
        "updated_at": "2026-01-18T22:19:56.215545Z"
      },
      "id": "fn-4-vet.13",
      "spec": "# fn-4-vet.13 Delete aliases.sh and update tests\n\n## Description\nDelete `aliases.sh` and update integration tests.\n\n## Files to Delete\n- `agent-sandbox/aliases.sh` - replaced by containai.sh + lib/\n- `agent-sandbox/sync-agent-plugins.sh` - replaced by `cai import`\n\n## Test Updates\n\nUpdate `agent-sandbox/test-sync-integration.sh`:\n1. Source `containai.sh` instead of `aliases.sh`\n2. Use `cai import --dry-run` instead of `sync-agent-plugins.sh --dry-run`\n3. Use test-specific volume via `--data-volume test-volume`\n4. Update any `asb*` references to `cai*`\n\n## Documentation Updates\n\nUpdate any README or docs that reference:\n- `asb` \u2192 `cai` / `containai`\n- `sync-agent-plugins.sh` \u2192 `cai import`\n- Old config paths\n\n## Verification\n\nAfter deletion, ensure:\n```bash\nsource agent-sandbox/containai.sh\ncai --help\ncai import --dry-run\n```\n## Acceptance\n- [ ] `agent-sandbox/aliases.sh` deleted\n- [ ] `agent-sandbox/sync-agent-plugins.sh` deleted\n- [ ] `test-sync-integration.sh` updated to use new CLI\n- [ ] All tests pass with new CLI\n- [ ] No remaining references to `asb*` in codebase\n- [ ] `cai --help` works\n- [ ] `cai import --dry-run` works\n## Done summary\nTBD\n\n## Evidence\n- Commits:\n- Tests:\n- PRs:\n"
    },
    {
      "data": {
        "assignee": null,
        "claim_note": "",
        "claimed_at": null,
        "created_at": "2026-01-18T20:16:03.444012Z",
        "depends_on": [
          "fn-4-vet.1"
        ],
        "epic": "fn-4-vet",
        "id": "fn-4-vet.2",
        "priority": null,
        "spec_path": ".flow/tasks/fn-4-vet.2.md",
        "status": "todo",
        "title": "Add config loading function to aliases.sh",
        "updated_at": "2026-01-18T21:20:44.598112Z"
      },
      "id": "fn-4-vet.2",
      "spec": "# fn-4-vet.2 Add config loading function to aliases.sh\n\n## Description\n## Overview\nAdd config loading functions to `aliases.sh` that discover and load configuration from TOML files. Volume selection is **implicit based on workspace path** - no --profile flag needed.\n\n## Implementation\n\n### Config Discovery Order (only used when no higher-priority volume)\n1. Project config: `.containai/config.toml` (walk up from resolution root to git root or `/`)\n2. User config: `$XDG_CONFIG_HOME/containai/config.toml` (default: `~/.config/containai/`)\n\n**Resolution root:** `--workspace <path>` if provided, otherwise `$PWD`.\n\n### Value Precedence\n1. `--data-volume <name>` CLI flag \u2192 **skips config parsing entirely**\n2. `CONTAINAI_DATA_VOLUME` env var \u2192 **skips config parsing entirely**\n3. Config file `[workspace.<path>]` section matching current workspace\n4. Config file `[agent]` section (default)\n5. Hardcoded default: `sandbox-agent-data`\n\n### Key Design: Workspace Path-Based Selection\n\n```bash\n_containai_resolve_volume() {\n    local cli_volume=\"${1:-}\"\n    local workspace=\"${2:-$PWD}\"\n    local explicit_config=\"${3:-}\"\n    \n    # 1. CLI flag always wins - SKIP all config parsing\n    if [[ -n \"$cli_volume\" ]]; then\n        echo \"$cli_volume\"\n        return 0\n    fi\n    \n    # 2. Environment variable always wins - SKIP all config parsing\n    if [[ -n \"${CONTAINAI_DATA_VOLUME:-}\" ]]; then\n        echo \"$CONTAINAI_DATA_VOLUME\"\n        return 0\n    fi\n    \n    # 3. Resolve workspace to absolute path\n    workspace=$(cd \"$workspace\" 2>/dev/null && pwd) || workspace=\"$PWD\"\n    \n    # 4. Find config file\n    local config_file=\"\"\n    local config_dir=\"\"\n    if [[ -n \"$explicit_config\" ]]; then\n        if [[ ! -f \"$explicit_config\" ]]; then\n            echo \"[ERROR] Config file not found: $explicit_config\" >&2\n            return 1\n        fi\n        config_file=\"$explicit_config\"\n        config_dir=$(dirname \"$config_file\")\n    else\n        config_file=$(_containai_find_config \"$workspace\")\n        [[ -n \"$config_file\" ]] && config_dir=$(dirname \"$config_file\")\n    fi\n    \n    # 5. Parse config with workspace matching\n    if [[ -n \"$config_file\" ]]; then\n        local volume\n        volume=$(_containai_parse_config_for_workspace \"$config_file\" \"$workspace\" \"$config_dir\")\n        if [[ -n \"$volume\" ]]; then\n            echo \"$volume\"\n            return 0\n        fi\n    fi\n    \n    # 6. Default\n    echo \"sandbox-agent-data\"\n}\n\n_containai_parse_config_for_workspace() {\n    local config_file=\"$1\"\n    local workspace=\"$2\"\n    local config_dir=\"$3\"\n    \n    if ! command -v python3 >/dev/null 2>&1; then\n        echo \"[WARN] Python not found, cannot parse config. Using default.\" >&2\n        return 0\n    fi\n    \n    local script_dir\n    script_dir=\"$(cd \"$(dirname \"${BASH_SOURCE[0]}\")\" && pwd)\"\n    python3 \"$script_dir/parse-toml.py\" \"$config_file\" --workspace \"$workspace\" --config-dir \"$config_dir\" 2>/dev/null\n}\n```\n\n### Helper Functions\n- `_containai_find_config()` - walks up from workspace path, checks XDG\n- `_containai_parse_config_for_workspace()` - calls Python with workspace matching\n- `_containai_validate_volume_name()` - validates Docker volume name\n- `_containai_resolve_volume()` - main resolver\n\n## Key Files\n- Modify: `agent-sandbox/aliases.sh` (add new functions)\n- Reference: `agent-sandbox/parse-toml.py` (from task fn-4-vet.1)\n## Overview\nAdd config loading functions to `aliases.sh` that discover and load configuration from TOML files, environment variables, and CLI flags. **Volume is resolved per-invocation**. When `--data-volume` or `CONTAINAI_DATA_VOLUME` is set, config parsing is skipped entirely.\n\n## Implementation\n\n### Config Discovery Order (only used when no higher-priority volume)\n1. Project config: `.containai/config.toml` (walk up from resolution root to git root or `/`)\n2. User config: `$XDG_CONFIG_HOME/containai/config.toml` (default: `~/.config/containai/`)\n\n**Resolution root:** `--workspace <path>` if provided, otherwise `$PWD`.\n\n### Value Precedence (highest to lowest)\n1. `--data-volume <name>` CLI flag \u2192 **skips config parsing entirely**\n2. `CONTAINAI_DATA_VOLUME` env var \u2192 **skips config parsing entirely**\n3. Config file value (profile key if `--profile`, else `agent.data_volume`)\n4. Default: `sandbox-agent-data`\n\n### Key Design: Skip Config When Volume Already Set\n\n```bash\n_containai_resolve_volume() {\n    local cli_volume=\"${1:-}\"\n    local profile=\"${2:-}\"\n    local workspace=\"${3:-$PWD}\"\n    local explicit_config=\"${4:-}\"\n    \n    # 1. CLI flag always wins - SKIP all config parsing\n    if [[ -n \"$cli_volume\" ]]; then\n        if [[ -n \"$profile\" ]]; then\n            echo \"[WARN] --profile ignored because --data-volume was specified\" >&2\n        fi\n        echo \"$cli_volume\"\n        return 0\n    fi\n    \n    # 2. Environment variable always wins - SKIP all config parsing\n    if [[ -n \"${CONTAINAI_DATA_VOLUME:-}\" ]]; then\n        if [[ -n \"$profile\" ]]; then\n            echo \"[WARN] --profile ignored because CONTAINAI_DATA_VOLUME is set\" >&2\n        fi\n        echo \"$CONTAINAI_DATA_VOLUME\"\n        return 0\n    fi\n    \n    # 3. Config file resolution (only reached if no higher-priority volume)\n    local config_file=\"\"\n    if [[ -n \"$explicit_config\" ]]; then\n        config_file=\"$explicit_config\"\n        if [[ ! -f \"$config_file\" ]]; then\n            echo \"[ERROR] Config file not found: $config_file\" >&2\n            return 1\n        fi\n    else\n        config_file=$(_containai_find_config \"$workspace\")\n    fi\n    \n    if [[ -n \"$config_file\" ]]; then\n        local volume\n        volume=$(_containai_parse_config \"$config_file\" \"$profile\")\n        if [[ -n \"$volume\" ]]; then\n            echo \"$volume\"\n            return 0\n        fi\n    fi\n    \n    # 4. Default\n    echo \"sandbox-agent-data\"\n}\n```\n\n### Python Optional - No Error When Volume Already Set\n\n```bash\n_containai_parse_config() {\n    local config_file=\"$1\"\n    local profile=\"${2:-}\"\n    local key=\"agent.data_volume\"\n    \n    [[ -n \"$profile\" ]] && key=\"profile.${profile}.data_volume\"\n    \n    if ! command -v python3 >/dev/null 2>&1; then\n        if [[ -n \"$profile\" ]]; then\n            echo \"[ERROR] --profile requires Python to parse config. Install Python 3.11+ or use CONTAINAI_DATA_VOLUME.\" >&2\n            return 1\n        fi\n        echo \"[WARN] Python not found, cannot parse config. Using default.\" >&2\n        return 0\n    fi\n    \n    local script_dir\n    script_dir=\"$(cd \"$(dirname \"${BASH_SOURCE[0]}\")\" && pwd)\"\n    local result\n    result=$(python3 \"$script_dir/parse-toml.py\" \"$config_file\" \"$key\" 2>/dev/null)\n    \n    # Profile fallback\n    if [[ -z \"$result\" ]] && [[ -n \"$profile\" ]]; then\n        echo \"[WARN] Profile '$profile' not found, using [agent] defaults\" >&2\n        result=$(python3 \"$script_dir/parse-toml.py\" \"$config_file\" \"agent.data_volume\" 2>/dev/null)\n    fi\n    \n    echo \"$result\"\n}\n```\n\n### Helper Functions\n- `_containai_find_config()` - walks up from resolution root, checks XDG\n- `_containai_parse_config()` - parses TOML, handles profile fallback\n- `_containai_validate_volume_name()` - validates Docker volume name\n- `_containai_resolve_volume()` - main resolver with skip-on-volume logic\n\n## Key Files\n- Modify: `agent-sandbox/aliases.sh` (add new functions)\n- Reference: `agent-sandbox/parse-toml.py` (from task fn-4-vet.1)\n## Overview\nAdd config loading functions to `aliases.sh` that discover and load configuration from TOML files, environment variables, and CLI flags. **Volume is resolved per-invocation** based on resolution root (--workspace path if provided, else $PWD).\n\n## Implementation\n\n### Config Discovery Order\n1. Project config: `.containai/config.toml` (walk up from resolution root to git root or `/`)\n2. User config: `$XDG_CONFIG_HOME/containai/config.toml` (default: `~/.config/containai/`)\n\n**Resolution root:** `--workspace <path>` if provided (resolved to absolute), otherwise current `$PWD`.\n\n### Value Precedence (highest to lowest)\n1. `--data-volume <name>` CLI flag (always wins)\n2. `CONTAINAI_DATA_VOLUME` env var (always wins over config)\n3. Config file value (profile key if `--profile`, else `agent.data_volume`)\n4. Default: `sandbox-agent-data`\n\n### Key Design: Per-Invocation Resolution with Workspace Support\n\n```bash\n# Called by cai/containai on each invocation\n# Arguments: $1=--data-volume, $2=--profile, $3=--workspace (resolved to absolute)\n_containai_resolve_volume() {\n    local cli_volume=\"${1:-}\"\n    local profile=\"${2:-}\"\n    local workspace=\"${3:-$PWD}\"\n    \n    # 1. CLI flag always wins\n    if [[ -n \"$cli_volume\" ]]; then\n        echo \"$cli_volume\"\n        return 0\n    fi\n    \n    # 2. Environment variable always wins over config\n    if [[ -n \"${CONTAINAI_DATA_VOLUME:-}\" ]]; then\n        echo \"$CONTAINAI_DATA_VOLUME\"\n        return 0\n    fi\n    \n    # 3. Config file discovery (from workspace root)\n    local config_file\n    config_file=$(_containai_find_config \"$workspace\")\n    if [[ -n \"$config_file\" ]]; then\n        local volume\n        volume=$(_containai_parse_config \"$config_file\" \"$profile\")\n        if [[ -n \"$volume\" ]]; then\n            echo \"$volume\"\n            return 0\n        fi\n    fi\n    \n    # 4. Default\n    echo \"sandbox-agent-data\"\n}\n```\n\n### Python Optional with Profile Failure\n\n```bash\n_containai_parse_config() {\n    local config_file=\"$1\"\n    local profile=\"${2:-}\"\n    local key=\"agent.data_volume\"\n    \n    [[ -n \"$profile\" ]] && key=\"profile.${profile}.data_volume\"\n    \n    # Check if Python available\n    if ! command -v python3 >/dev/null 2>&1; then\n        if [[ -n \"$profile\" ]]; then\n            # FAIL if --profile requested but can't parse\n            echo \"[ERROR] --profile requires Python to parse config. Install Python 3.11+ or use CONTAINAI_DATA_VOLUME env var.\" >&2\n            return 1\n        fi\n        # Warn but continue without profile\n        echo \"[WARN] Python not found, cannot parse config file. Using env/CLI/default.\" >&2\n        return 0\n    fi\n    \n    local script_dir\n    script_dir=\"$(cd \"$(dirname \"${BASH_SOURCE[0]}\")\" && pwd)\"\n    python3 \"$script_dir/parse-toml.py\" \"$config_file\" \"$key\" 2>/dev/null\n}\n```\n\n### Helper Functions Needed\n- `_containai_find_config()` - walks up from resolution root, checks XDG\n- `_containai_parse_config()` - wrapper around parse-toml.py, handles Python missing\n- `_containai_validate_volume_name()` - validates Docker volume name pattern\n- `_containai_resolve_volume()` - main resolver called per invocation\n\n### Volume Name Validation\n- Pattern: `^[a-zA-Z0-9][a-zA-Z0-9_.-]*$`\n- Min length: 1 character\n- Max length: 255 characters\n\n## Key Files\n- Modify: `agent-sandbox/aliases.sh` (add new functions)\n- Reference: `agent-sandbox/parse-toml.py` (from task fn-4-vet.1)\n## Overview\nAdd config loading functions to `aliases.sh` that discover and load configuration from TOML files, environment variables, and CLI flags. **Volume is resolved per-invocation** (not cached) to support changing directories between projects.\n\n## Implementation\n\n### Config Discovery Order (highest to lowest priority)\n1. CLI flag: `--data-volume <name>` or `--config <path>` (explicit path disables discovery)\n2. Environment: `CONTAINAI_DATA_VOLUME` or `CONTAINAI_CONFIG` (explicit path disables discovery)\n3. Project config: `.containai/config.toml` (walk up from cwd to git root or `/`)\n4. User config: `$XDG_CONFIG_HOME/containai/config.toml` (default: `~/.config/containai/`)\n5. Default: `sandbox-agent-data`\n\n### Key Design: Per-Invocation Resolution\n**Critical:** Do NOT cache volume name globally. Each command invocation resolves from current `$PWD`:\n\n```bash\n# Called by cai/containai on each invocation\n# Arguments: $1 = CLI --data-volume value (if provided), $2 = --profile value (if provided)\n_containai_resolve_volume() {\n    local cli_volume=\"${1:-}\"\n    local profile=\"${2:-}\"\n    local data_volume=\"\"\n    \n    # 1. CLI flag takes precedence\n    if [[ -n \"$cli_volume\" ]]; then\n        echo \"$cli_volume\"\n        return 0\n    fi\n    \n    # 2. Environment variable\n    if [[ -n \"${CONTAINAI_DATA_VOLUME:-}\" ]]; then\n        echo \"$CONTAINAI_DATA_VOLUME\"\n        return 0\n    fi\n    \n    # 3. Config file discovery\n    local config_file\n    config_file=$(_containai_find_config)\n    if [[ -n \"$config_file\" ]]; then\n        data_volume=$(_containai_parse_toml \"$config_file\" \"$profile\")\n        if [[ -n \"$data_volume\" ]]; then\n            echo \"$data_volume\"\n            return 0\n        fi\n    fi\n    \n    # 4. Default\n    echo \"sandbox-agent-data\"\n}\n```\n\n### Python Optional with Graceful Fallback\n```bash\n_containai_parse_toml() {\n    local config_file=\"$1\"\n    local profile=\"${2:-}\"\n    local key=\"agent.data_volume\"\n    \n    # Use profile-specific key if profile specified\n    [[ -n \"$profile\" ]] && key=\"profile.${profile}.data_volume\"\n    \n    # Check if Python available\n    if ! command -v python3 >/dev/null 2>&1; then\n        echo \"[WARN] Python not found, cannot parse config file. Using env/CLI only.\" >&2\n        return 1\n    fi\n    \n    # Try parsing\n    local script_dir\n    script_dir=\"$(cd \"$(dirname \"${BASH_SOURCE[0]}\")\" && pwd)\"\n    python3 \"$script_dir/parse-toml.py\" \"$config_file\" \"$key\" 2>/dev/null\n}\n```\n\n### Helper Functions Needed\n- `_containai_find_config()` - walks up directory tree from $PWD, checks XDG\n- `_containai_parse_toml()` - wrapper around parse-toml.py with Python check\n- `_containai_validate_volume_name()` - validates Docker volume name pattern\n- `_containai_resolve_volume()` - main resolver called per invocation\n\n### Volume Name Validation\n- Pattern: `^[a-zA-Z0-9][a-zA-Z0-9_.-]*$`\n- Min length: 2 characters\n- Max length: 255 characters\n\n## Key Files\n- Modify: `agent-sandbox/aliases.sh` (add new functions)\n- Reference: `agent-sandbox/parse-toml.py` (from task fn-4-vet.1)\n## Overview\nAdd a `_containai_load_config()` function to `aliases.sh` that discovers and loads configuration from TOML files, environment variables, and CLI flags. Sets the `_CONTAINAI_VOLUME` variable used by all other functions.\n\n## Implementation\n\n### Config Discovery Order (highest to lowest priority)\n1. `CONTAINAI_VOLUME` environment variable\n2. `.containai/config.toml` in current directory (walk up to git root or `/`)\n3. `.devcontainer/containai.toml` in project root\n4. `$XDG_CONFIG_HOME/containai/config.toml` (default: `~/.config/containai/`)\n5. Default: `sandbox-agent-data`\n\n### Function Design\n```bash\n# Called automatically when aliases.sh is sourced\n# Sets _CONTAINAI_VOLUME global variable\n\n_containai_load_config() {\n    local config_file volume\n    \n    # 1. Check environment variable first\n    if [[ -n \"${CONTAINAI_VOLUME:-}\" ]]; then\n        _CONTAINAI_VOLUME=\"$CONTAINAI_VOLUME\"\n        return 0\n    fi\n    \n    # 2. Find config file\n    config_file=$(_containai_find_config)\n    \n    # 3. Parse if found\n    if [[ -n \"$config_file\" ]]; then\n        volume=$(_containai_parse_toml \"$config_file\" \"agent.volume\")\n        if [[ -n \"$volume\" ]]; then\n            _CONTAINAI_VOLUME=\"$volume\"\n            return 0\n        fi\n    fi\n    \n    # 4. Default\n    _CONTAINAI_VOLUME=\"sandbox-agent-data\"\n}\n```\n\n### Helper Functions Needed\n- `_containai_find_config()` - walks up directory tree, checks XDG\n- `_containai_parse_toml()` - wrapper around parse-toml.py with Python check\n- `_containai_validate_volume_name()` - validates Docker volume name pattern\n\n### Volume Name Validation\nPattern: `^[a-zA-Z0-9][a-zA-Z0-9_.-]*$`\nMax length: 255 characters\n\n## Key Files\n- Modify: `agent-sandbox/aliases.sh:17-24` (constants block)\n- Reference: `agent-sandbox/parse-toml.py` (from task fn-4-vet.1)\n## Acceptance\n- [ ] `--data-volume` skips config parsing entirely (no Python needed)\n- [ ] `CONTAINAI_DATA_VOLUME` skips config parsing entirely\n- [ ] Workspace path is resolved to absolute before matching\n- [ ] `[workspace.<path>]` sections matched against workspace\n- [ ] Relative paths in config resolved from config file directory\n- [ ] Longest match wins when multiple workspace sections match\n- [ ] Falls back to `[agent].data_volume` when no workspace match\n- [ ] Falls back to `sandbox-agent-data` when no config\n- [ ] Missing Python warns and uses default\n- [ ] All variables declared `local` to prevent shell pollution\n- [ ] `cai --workspace /path` uses /path for both workspace AND config matching\n## Done summary\nTBD\n\n## Evidence\n- Commits:\n- Tests:\n- PRs:\n"
    },
    {
      "data": {
        "assignee": null,
        "claim_note": "",
        "claimed_at": null,
        "created_at": "2026-01-18T20:16:04.663657Z",
        "depends_on": [
          "fn-4-vet.1"
        ],
        "epic": "fn-4-vet",
        "id": "fn-4-vet.3",
        "priority": null,
        "spec_path": ".flow/tasks/fn-4-vet.3.md",
        "status": "todo",
        "title": "Parameterize volume name in sync-agent-plugins.sh",
        "updated_at": "2026-01-18T21:26:23.093099Z"
      },
      "id": "fn-4-vet.3",
      "spec": "# fn-4-vet.3 Parameterize volume name in sync-agent-plugins.sh\n\n## Description\n## Overview\nUpdate `sync-agent-plugins.sh` to accept configurable volume names with same precedence as cai. **Must print resolved volume name** for verification.\n\n## Implementation\n\n### Precedence\n1. `--volume <name>` CLI flag \u2192 skips config parsing\n2. `CONTAINAI_DATA_VOLUME` env var \u2192 skips config parsing\n3. Config file (from `$PWD` discovery)\n4. Default: `sandbox-agent-data`\n\n### Required Output\nThe script MUST print the resolved volume name:\n```bash\ninfo \"Using data volume: $DATA_VOLUME\"\n```\nThis enables verification in quick commands and tests.\n\n### Current Code (line 20)\n```bash\nreadonly DATA_VOLUME=\"sandbox-agent-data\"\n```\n\n### New Behavior\n```bash\nDATA_VOLUME=\"\"\nEXPLICIT_CONFIG=\"\"\n\nwhile [[ $# -gt 0 ]]; do\n    case \"$1\" in\n        --volume) DATA_VOLUME=\"$2\"; shift 2 ;;\n        --volume=*) DATA_VOLUME=\"${1#*=}\"; shift ;;\n        --config) EXPLICIT_CONFIG=\"$2\"; shift 2 ;;\n        --config=*) EXPLICIT_CONFIG=\"${1#*=}\"; shift ;;\n        *) # existing flags...\n    esac\ndone\n\n# Skip config if CLI volume set\nif [[ -z \"$DATA_VOLUME\" ]]; then\n    if [[ -n \"${CONTAINAI_DATA_VOLUME:-}\" ]]; then\n        DATA_VOLUME=\"$CONTAINAI_DATA_VOLUME\"\n    else\n        DATA_VOLUME=$(_sync_resolve_config_volume \"$EXPLICIT_CONFIG\")\n    fi\nfi\n\nDATA_VOLUME=\"${DATA_VOLUME:-sandbox-agent-data}\"\nreadonly DATA_VOLUME\n\n# Print resolved volume (required for verification)\ninfo \"Using data volume: $DATA_VOLUME\"\n```\n\n## Key Files\n- Modify: `agent-sandbox/sync-agent-plugins.sh`\n## Overview\nUpdate `sync-agent-plugins.sh` to accept configurable volume names with the same precedence as cai/containai. Resolution root is always `$PWD` (no --workspace support).\n\n## Implementation\n\n### Precedence (same as cai)\n1. `--volume <name>` CLI flag \u2192 **skips config parsing entirely**\n2. `CONTAINAI_DATA_VOLUME` env var \u2192 **skips config parsing entirely**\n3. Config file value (from `$PWD` discovery)\n4. Default: `sandbox-agent-data`\n\n### Current Code (line 20)\n```bash\nreadonly DATA_VOLUME=\"sandbox-agent-data\"\n```\n\n### New Behavior\n```bash\nDATA_VOLUME=\"\"\nEXPLICIT_CONFIG=\"\"\n\n# Parse CLI flags\nwhile [[ $# -gt 0 ]]; do\n    case \"$1\" in\n        --volume)\n            DATA_VOLUME=\"$2\"\n            shift 2\n            ;;\n        --volume=*)\n            DATA_VOLUME=\"${1#*=}\"\n            shift\n            ;;\n        --config)\n            EXPLICIT_CONFIG=\"$2\"\n            shift 2\n            ;;\n        --config=*)\n            EXPLICIT_CONFIG=\"${1#*=}\"\n            shift\n            ;;\n        *)\n            # ... existing flag handling ...\n            ;;\n    esac\ndone\n\n# If CLI volume set, skip all config resolution\nif [[ -z \"$DATA_VOLUME\" ]]; then\n    # Check env var\n    if [[ -n \"${CONTAINAI_DATA_VOLUME:-}\" ]]; then\n        DATA_VOLUME=\"$CONTAINAI_DATA_VOLUME\"\n    else\n        # Try config discovery from $PWD\n        DATA_VOLUME=$(_sync_resolve_config_volume \"$EXPLICIT_CONFIG\")\n    fi\nfi\n\nDATA_VOLUME=\"${DATA_VOLUME:-sandbox-agent-data}\"\n\n# Validate\nif ! _sync_validate_volume_name \"$DATA_VOLUME\"; then\n    echo \"[ERROR] Invalid volume name: $DATA_VOLUME\" >&2\n    exit 1\nfi\n\nreadonly DATA_VOLUME\n```\n\n### Config Resolution\n```bash\n_sync_resolve_config_volume() {\n    local explicit_config=\"${1:-}\"\n    local config_file=\"\"\n    \n    if [[ -n \"$explicit_config\" ]]; then\n        if [[ ! -f \"$explicit_config\" ]]; then\n            echo \"[ERROR] Config file not found: $explicit_config\" >&2\n            return 1\n        fi\n        config_file=\"$explicit_config\"\n    else\n        config_file=$(_sync_find_config)  # Walks up from $PWD\n    fi\n    \n    [[ -z \"$config_file\" ]] && return 0\n    \n    if command -v python3 >/dev/null 2>&1; then\n        local script_dir\n        script_dir=\"$(cd \"$(dirname \"${BASH_SOURCE[0]}\")\" && pwd)\"\n        python3 \"$script_dir/parse-toml.py\" \"$config_file\" \"agent.data_volume\" 2>/dev/null\n    else\n        echo \"[WARN] Python not found, cannot parse config. Using default.\" >&2\n    fi\n}\n```\n\n### Help Text\n```\nUsage: sync-agent-plugins.sh [OPTIONS]\n\nOptions:\n  --volume <name>    Docker volume name for agent data (default: sandbox-agent-data)\n  --config <path>    Explicit config file path (disables discovery)\n  --dry-run          Show what would be synced without executing\n  --help             Show this help message\n\nEnvironment:\n  CONTAINAI_DATA_VOLUME    Volume name (overridden by --volume)\n  CONTAINAI_CONFIG         Config file path (overridden by --config)\n\nNote: Config discovery uses current directory ($PWD) as root.\n```\n\n## Key Files\n- Modify: `agent-sandbox/sync-agent-plugins.sh:20` (DATA_VOLUME)\n- Modify: `agent-sandbox/sync-agent-plugins.sh` (argument parsing)\n- Modify: `agent-sandbox/sync-agent-plugins.sh` (help text)\n- Reference: `agent-sandbox/parse-toml.py` (from task fn-4-vet.1)\n## Overview\nUpdate `sync-agent-plugins.sh` to accept configurable volume names with the same precedence as cai/containai: `--volume` > `CONTAINAI_DATA_VOLUME` > config file > default.\n\n## Implementation\n\n### Current Code (line 20)\n```bash\nreadonly DATA_VOLUME=\"sandbox-agent-data\"\n```\n\n### New Behavior\n```bash\n# Parse command line first\nDATA_VOLUME=\"\"\nEXPLICIT_CONFIG=\"\"\n\nwhile [[ $# -gt 0 ]]; do\n    case \"$1\" in\n        --volume)\n            DATA_VOLUME=\"$2\"\n            shift 2\n            ;;\n        --volume=*)\n            DATA_VOLUME=\"${1#*=}\"\n            shift\n            ;;\n        --config)\n            EXPLICIT_CONFIG=\"$2\"\n            shift 2\n            ;;\n        --config=*)\n            EXPLICIT_CONFIG=\"${1#*=}\"\n            shift\n            ;;\n        # ... existing flags ...\n    esac\ndone\n\n# If no CLI volume, check environment\nif [[ -z \"$DATA_VOLUME\" ]] && [[ -n \"${CONTAINAI_DATA_VOLUME:-}\" ]]; then\n    DATA_VOLUME=\"$CONTAINAI_DATA_VOLUME\"\nfi\n\n# If still no volume, try config discovery\nif [[ -z \"$DATA_VOLUME\" ]]; then\n    DATA_VOLUME=$(_sync_resolve_config_volume \"$EXPLICIT_CONFIG\")\nfi\n\n# Final fallback\nDATA_VOLUME=\"${DATA_VOLUME:-sandbox-agent-data}\"\n\n# Validate\nif ! _sync_validate_volume_name \"$DATA_VOLUME\"; then\n    echo \"[ERROR] Invalid volume name: $DATA_VOLUME\" >&2\n    exit 1\nfi\n\nreadonly DATA_VOLUME\n```\n\n### Config Resolution (simplified for standalone script)\n```bash\n_sync_resolve_config_volume() {\n    local explicit_config=\"${1:-}\"\n    local config_file=\"\"\n    \n    # Explicit path?\n    if [[ -n \"$explicit_config\" ]]; then\n        if [[ ! -f \"$explicit_config\" ]]; then\n            echo \"[ERROR] Config file not found: $explicit_config\" >&2\n            return 1\n        fi\n        config_file=\"$explicit_config\"\n    else\n        # Walk up from $PWD\n        config_file=$(_sync_find_config)\n    fi\n    \n    if [[ -z \"$config_file\" ]]; then\n        return 0  # No config, use default\n    fi\n    \n    # Parse with Python if available\n    if command -v python3 >/dev/null 2>&1; then\n        local script_dir\n        script_dir=\"$(cd \"$(dirname \"${BASH_SOURCE[0]}\")\" && pwd)\"\n        python3 \"$script_dir/parse-toml.py\" \"$config_file\" \"agent.data_volume\" 2>/dev/null\n    else\n        echo \"[WARN] Python not found, cannot parse config. Using default volume.\" >&2\n    fi\n}\n```\n\n### Help Text Update\n```\nUsage: sync-agent-plugins.sh [OPTIONS]\n\nOptions:\n  --volume <name>    Docker volume name for agent data (default: sandbox-agent-data)\n  --config <path>    Explicit config file path (disables discovery)\n  --dry-run          Show what would be synced without executing\n  --help             Show this help message\n\nEnvironment:\n  CONTAINAI_DATA_VOLUME    Volume name (overridden by --volume)\n  CONTAINAI_CONFIG         Config file path (overridden by --config)\n```\n\n## Key Files\n- Modify: `agent-sandbox/sync-agent-plugins.sh:20` (DATA_VOLUME)\n- Modify: `agent-sandbox/sync-agent-plugins.sh` (argument parsing)\n- Modify: `agent-sandbox/sync-agent-plugins.sh` (help text)\n- Reference: `agent-sandbox/parse-toml.py` (from task fn-4-vet.1)\n## Overview\nUpdate `sync-agent-plugins.sh` to accept a `--volume` parameter for the agent data volume name. This script has no existing `--volume` flag, so there's no conflict.\n\n## Implementation\n\n### Current Code (line 20)\n```bash\nreadonly DATA_VOLUME=\"sandbox-agent-data\"\n```\n\n### New Behavior\n```bash\n# Initialize from environment if set\nDATA_VOLUME=\"${CONTAINAI_DATA_VOLUME:-}\"\n\n# Parse command line for --volume flag\nwhile [[ $# -gt 0 ]]; do\n    case \"$1\" in\n        --volume)\n            DATA_VOLUME=\"$2\"\n            shift 2\n            ;;\n        --volume=*)\n            DATA_VOLUME=\"${1#*=}\"\n            shift\n            ;;\n        # ... existing flags ...\n    esac\ndone\n\n# If still empty, try config discovery (optional, can use parse-toml.py)\nif [[ -z \"$DATA_VOLUME\" ]]; then\n    DATA_VOLUME=$(_sync_discover_volume)\nfi\n\n# Final fallback to default\nDATA_VOLUME=\"${DATA_VOLUME:-sandbox-agent-data}\"\n\n# Validate\nif ! _sync_validate_volume_name \"$DATA_VOLUME\"; then\n    echo \"[ERROR] Invalid volume name: $DATA_VOLUME\" >&2\n    exit 1\nfi\n\nreadonly DATA_VOLUME\n```\n\n### Config Discovery (simplified for standalone script)\nSince sync-agent-plugins.sh runs standalone, implement minimal config discovery:\n1. Check explicit `CONTAINAI_CONFIG` env var\n2. Walk up from `$PWD` looking for `.containai/config.toml`\n3. Check `~/.config/containai/config.toml`\n4. Parse with parse-toml.py if available\n\n### Help Text Update\n```\nUsage: sync-agent-plugins.sh [OPTIONS]\n\nOptions:\n  --volume <name>    Docker volume name for agent data (default: sandbox-agent-data)\n  --dry-run          Show what would be synced without executing\n  --help             Show this help message\n```\n\n## Key Files\n- Modify: `agent-sandbox/sync-agent-plugins.sh:20` (DATA_VOLUME assignment)\n- Modify: `agent-sandbox/sync-agent-plugins.sh` (argument parsing, near top)\n- Modify: `agent-sandbox/sync-agent-plugins.sh` (help text)\n- Reference: `agent-sandbox/parse-toml.py` (from task fn-4-vet.1)\n## Overview\nUpdate `sync-agent-plugins.sh` to accept a volume name parameter instead of using the hardcoded `sandbox-agent-data`. Support CLI flag, environment variable, and config file discovery.\n\n## Implementation\n\n### Current Code (line 20)\n```bash\nreadonly DATA_VOLUME=\"sandbox-agent-data\"\n```\n\n### New Behavior\n```bash\n# Parse --volume flag or use CONTAINAI_VOLUME env var or discover from config\nDATA_VOLUME=\"${CONTAINAI_VOLUME:-}\"\n\n# Parse command line for --volume flag\nwhile [[ $# -gt 0 ]]; do\n    case \"$1\" in\n        --volume)\n            DATA_VOLUME=\"$2\"\n            shift 2\n            ;;\n        --volume=*)\n            DATA_VOLUME=\"${1#*=}\"\n            shift\n            ;;\n        # ... existing flags ...\n    esac\ndone\n\n# If still empty, try config discovery\nif [[ -z \"$DATA_VOLUME\" ]]; then\n    DATA_VOLUME=$(_sync_discover_volume)\nfi\n\n# Final fallback to default\nDATA_VOLUME=\"${DATA_VOLUME:-sandbox-agent-data}\"\nreadonly DATA_VOLUME\n```\n\n### Config Discovery\nSince sync-agent-plugins.sh runs on the host (not in container), it needs its own config discovery logic. Can either:\n1. Source the helper functions from aliases.sh\n2. Duplicate minimal discovery logic\n3. Call parse-toml.py directly\n\nRecommend option 3 for simplicity - direct call to parse-toml.py with same search order.\n\n### Update Help Text\nAdd `--volume <name>` to usage output.\n\n## Key Files\n- Modify: `agent-sandbox/sync-agent-plugins.sh:20` (DATA_VOLUME constant)\n- Modify: `agent-sandbox/sync-agent-plugins.sh` (argument parsing section)\n- Reference: `agent-sandbox/parse-toml.py` (from task fn-4-vet.1)\n## Acceptance\n- [ ] `--volume <name>` skips config parsing\n- [ ] `CONTAINAI_DATA_VOLUME` env var works\n- [ ] Config file discovery from $PWD\n- [ ] Precedence: --volume > env > config > default\n- [ ] **Prints \"Using data volume: <name>\"** in output\n- [ ] Default `sandbox-agent-data` used when no config\n- [ ] Explicit --config with missing file fails\n- [ ] `--dry-run --volume test-vol` output includes \"Using data volume: test-vol\"\n- [ ] `CONTAINAI_DATA_VOLUME=x ./sync-agent-plugins.sh --dry-run` includes \"Using data volume: x\"\n## Done summary\nTBD\n\n## Evidence\n- Commits:\n- Tests:\n- PRs:\n"
    },
    {
      "data": {
        "assignee": null,
        "claim_note": "",
        "claimed_at": null,
        "created_at": "2026-01-18T20:16:06.334406Z",
        "depends_on": [
          "fn-4-vet.2"
        ],
        "epic": "fn-4-vet",
        "id": "fn-4-vet.4",
        "priority": null,
        "spec_path": ".flow/tasks/fn-4-vet.4.md",
        "status": "todo",
        "title": "Update asb* functions to use configurable volume",
        "updated_at": "2026-01-18T21:21:17.631668Z"
      },
      "id": "fn-4-vet.4",
      "spec": "# fn-4-vet.4 Update asb* functions to use configurable volume\n\n## Description\n## Overview\nUpdate all `asb*` / `cai*` functions in `aliases.sh` to use per-invocation volume resolution via `_containai_resolve_volume()`. Add `--data-volume` and `--config` flag parsing.\n\n## Implementation\n\n### New CLI Flags\n- `--data-volume <name>` - explicit volume override (skips all config)\n- `--config <path>` - explicit config file path\n\n**Note:** No `--profile` flag. Workspace selection is implicit based on the resolved workspace path.\n\n### Current Code (lines 22-24)\n```bash\nreadonly _ASB_VOLUMES=(\n    \"sandbox-agent-data:/mnt/agent-data\"\n)\n```\n\n### New Approach\n\n```bash\n_containai_main() {\n    local data_volume_flag=\"\"\n    local config_flag=\"\"\n    local workspace_flag=\"\"\n    local args=()\n    \n    while [[ $# -gt 0 ]]; do\n        case \"$1\" in\n            --data-volume)\n                data_volume_flag=\"$2\"\n                shift 2\n                ;;\n            --data-volume=*)\n                data_volume_flag=\"${1#*=}\"\n                shift\n                ;;\n            --config)\n                config_flag=\"$2\"\n                shift 2\n                ;;\n            --config=*)\n                config_flag=\"${1#*=}\"\n                shift\n                ;;\n            --workspace)\n                workspace_flag=\"$2\"\n                shift 2\n                ;;\n            --workspace=*)\n                workspace_flag=\"${1#*=}\"\n                shift\n                ;;\n            *)\n                args+=(\"$1\")\n                shift\n                ;;\n        esac\n    done\n    \n    # Resolve workspace (for both mounting AND config matching)\n    local workspace=\"${workspace_flag:-$PWD}\"\n    \n    # Resolve volume for this invocation\n    local volume\n    volume=$(_containai_resolve_volume \"$data_volume_flag\" \"$workspace\" \"$config_flag\")\n    \n    # Validate\n    if ! _containai_validate_volume_name \"$volume\"; then\n        echo \"[ERROR] Invalid volume name: $volume\" >&2\n        return 1\n    fi\n    \n    # Ensure volume exists\n    _asb_ensure_volume \"$volume\"\n    \n    # Build volume mount args\n    local volume_args=\"-v ${volume}:/mnt/agent-data\"\n    \n    # Continue with container creation...\n}\n```\n\n### Functions to Update\n1. `_asb_ensure_volumes()` \u2192 `_asb_ensure_volume()` (singular, takes volume name)\n2. Main `asb()` \u2192 calls `_containai_main()` with deprecation warning\n3. Volume mount building uses resolved `$volume`\n\n## Key Files\n- Modify: `agent-sandbox/aliases.sh:22-24` (remove _ASB_VOLUMES)\n- Modify: `agent-sandbox/aliases.sh:349-368` (_asb_ensure_volumes \u2192 singular)\n- Modify: `agent-sandbox/aliases.sh:404+` (main function with flag parsing)\n## Overview\nUpdate all `asb*` / `cai*` functions in `aliases.sh` to use per-invocation volume resolution via `_containai_resolve_volume()`. Add `--data-volume` and `--profile` flag parsing.\n\n## Implementation\n\n### New CLI Flags (avoid conflicts)\n- `--data-volume <name>` - specify agent data volume (distinct from existing `--volume/-v` for bind mounts)\n- `--profile <name>` - select TOML profile section (distinct from existing `--workspace` for host path)\n\n### Current Code (lines 22-24)\n```bash\nreadonly _ASB_VOLUMES=(\n    \"sandbox-agent-data:/mnt/agent-data\"\n)\n```\n\n### New Approach\nRemove hardcoded array; resolve volume per-invocation:\n\n```bash\n# In asb/cai main function, parse new flags first\n_containai_main() {\n    local data_volume_flag=\"\"\n    local profile_flag=\"\"\n    local args=()\n    \n    while [[ $# -gt 0 ]]; do\n        case \"$1\" in\n            --data-volume)\n                data_volume_flag=\"$2\"\n                shift 2\n                ;;\n            --data-volume=*)\n                data_volume_flag=\"${1#*=}\"\n                shift\n                ;;\n            --profile)\n                profile_flag=\"$2\"\n                shift 2\n                ;;\n            --profile=*)\n                profile_flag=\"${1#*=}\"\n                shift\n                ;;\n            *)\n                args+=(\"$1\")\n                shift\n                ;;\n        esac\n    done\n    \n    # Resolve volume for this invocation\n    local volume\n    volume=$(_containai_resolve_volume \"$data_volume_flag\" \"$profile_flag\")\n    \n    # Validate\n    if ! _containai_validate_volume_name \"$volume\"; then\n        echo \"[ERROR] Invalid volume name: $volume\" >&2\n        return 1\n    fi\n    \n    # Ensure volume exists\n    _asb_ensure_volume \"$volume\"\n    \n    # Build volume mount args\n    local volume_args=\"-v ${volume}:/mnt/agent-data\"\n    \n    # Continue with container creation using $volume_args and \"${args[@]}\"\n    ...\n}\n```\n\n### Functions to Update\n1. `_asb_ensure_volumes()` \u2192 `_asb_ensure_volume()` (singular, takes volume name as arg)\n2. Main `asb()` function \u2192 extract to `_containai_main()` with flag parsing\n3. Volume mount building \u2192 use resolved `$volume` instead of hardcoded array\n\n### Mount Point\nThe mount point `/mnt/agent-data` stays constant - only the volume name changes.\n\n## Key Files\n- Modify: `agent-sandbox/aliases.sh:22-24` (remove _ASB_VOLUMES array)\n- Modify: `agent-sandbox/aliases.sh:349-368` (_asb_ensure_volumes \u2192 singular)\n- Modify: `agent-sandbox/aliases.sh:404+` (asb function \u2192 _containai_main with flag parsing)\n- Modify: `agent-sandbox/aliases.sh:727-731` (volume mount args)\n## Overview\nUpdate all `asb*` functions in `aliases.sh` to use the `$_CONTAINAI_VOLUME` variable instead of the hardcoded volume name in `_ASB_VOLUMES` array.\n\n## Implementation\n\n### Current Code (lines 22-24)\n```bash\nreadonly _ASB_VOLUMES=(\n    \"sandbox-agent-data:/mnt/agent-data\"\n)\n```\n\n### New Approach\nReplace hardcoded array with dynamic construction using `$_CONTAINAI_VOLUME`:\n\n```bash\n# Remove readonly array, compute dynamically\n_asb_get_volumes() {\n    echo \"${_CONTAINAI_VOLUME}:/mnt/agent-data\"\n}\n```\n\n### Functions to Update\n1. `_asb_ensure_volumes()` (line 349-368) - Create volume using `$_CONTAINAI_VOLUME`\n2. `_asb_build_volume_args()` or inline volume mount building (line 727-731)\n3. Any other references to `_ASB_VOLUMES`\n\n### Volume Mount Point\nThe mount point `/mnt/agent-data` stays constant - only the volume name changes.\n\n### Reload Behavior\nWhen user changes `CONTAINAI_VOLUME` and re-sources aliases.sh, the new value should take effect. Consider adding `_containai_reload()` function for explicit reload.\n\n## Key Files\n- Modify: `agent-sandbox/aliases.sh:22-24` (_ASB_VOLUMES array)\n- Modify: `agent-sandbox/aliases.sh:349-368` (_asb_ensure_volumes)\n- Modify: `agent-sandbox/aliases.sh:727-731` (volume mount args)\n## Acceptance\n- [ ] `--data-volume <name>` flag is parsed and used\n- [ ] `--data-volume=<name>` alternate syntax works\n- [ ] `--config <path>` flag is parsed for explicit config\n- [ ] No --profile flag (workspace selection is implicit)\n- [ ] Volume resolved per-invocation via `_containai_resolve_volume()`\n- [ ] `_ASB_VOLUMES` array removed, replaced with dynamic resolution\n- [ ] `_asb_ensure_volume()` creates volume by name\n- [ ] `cai --data-volume custom` uses custom volume\n- [ ] Changing directory uses correct workspace for config matching\n- [ ] Existing `--volume/-v` and `--workspace` flags unchanged\n- [ ] Mount point remains `/mnt/agent-data`\n## Done summary\nTBD\n\n## Evidence\n- Commits:\n- Tests:\n- PRs:\n"
    },
    {
      "data": {
        "assignee": null,
        "claim_note": "",
        "claimed_at": null,
        "created_at": "2026-01-18T20:16:11.252380Z",
        "depends_on": [
          "fn-4-vet.4"
        ],
        "epic": "fn-4-vet",
        "id": "fn-4-vet.5",
        "priority": null,
        "spec_path": ".flow/tasks/fn-4-vet.5.md",
        "status": "todo",
        "title": "Add containai and cai CLI aliases",
        "updated_at": "2026-01-18T21:21:18.199459Z"
      },
      "id": "fn-4-vet.5",
      "spec": "# fn-4-vet.5 Add containai and cai CLI aliases\n\n## Description\n## Overview\nAdd `containai` and `cai` as primary CLI aliases for all commands, keeping `asb*` functions as deprecated but working aliases with one-time warning.\n\n## Implementation\n\n### New Primary Aliases\n```bash\n# Primary commands - no deprecation warning\ncontainai() { _containai_main \"$@\"; }\ncai() { _containai_main \"$@\"; }\n\ncontainai-stop-all() { asb-stop-all \"$@\"; }\ncai-stop-all() { asb-stop-all \"$@\"; }\n\ncontainai-shell() { asb-shell \"$@\"; }\ncai-shell() { asb-shell \"$@\"; }\n\ncontainaid() { asbd \"$@\"; }\ncaid() { asbd \"$@\"; }\n```\n\n### Deprecation Policy\nOne-time warning per shell session, suppressible:\n\n```bash\n_containai_deprecation_warned=\"\"\n\n_containai_deprecation_warn_asb() {\n    [[ \"${CONTAINAI_NO_DEPRECATION_WARNING:-}\" == \"1\" ]] && return 0\n    [[ -n \"$_containai_deprecation_warned\" ]] && return 0\n    \n    echo \"[WARN] 'asb' commands are deprecated. Use 'containai' or 'cai' instead.\" >&2\n    echo \"       Suppress: export CONTAINAI_NO_DEPRECATION_WARNING=1\" >&2\n    _containai_deprecation_warned=1\n}\n\nasb() {\n    _containai_deprecation_warn_asb\n    _containai_main \"$@\"\n}\n```\n\n### Help Text\n```\nUsage: containai [OPTIONS] [-- AGENT_ARGS...]\n       cai [OPTIONS] [-- AGENT_ARGS...]\n\nOptions:\n  --data-volume <name>   Use specified Docker volume for agent data\n  --config <path>        Use explicit config file (disables discovery)\n  --volume, -v <mount>   Add additional bind mount\n  --workspace <path>     Use specified host workspace\n\nVolume is automatically selected based on workspace path from config.\nUse --data-volume to override.\n```\n\n## Key Files\n- Modify: `agent-sandbox/aliases.sh` (add aliases, deprecation)\n## Overview\nAdd `containai` and `cai` as primary CLI aliases for all commands, keeping `asb*` functions as deprecated but working aliases with one-time warning.\n\n## Implementation\n\n### New Primary Aliases (all mapping to asb equivalents)\n```bash\n# Primary commands\ncontainai() { _containai_deprecation_warn_asb; _containai_main \"$@\"; }\ncai() { _containai_main \"$@\"; }\n\n# Stop all\ncontainai-stop-all() { asb-stop-all \"$@\"; }\ncai-stop-all() { asb-stop-all \"$@\"; }\n\n# Shell access\ncontainai-shell() { asb-shell \"$@\"; }\ncai-shell() { asb-shell \"$@\"; }\n\n# Detached mode\ncontainaid() { asbd \"$@\"; }\ncaid() { asbd \"$@\"; }\n```\n\n### Deprecation Policy\nOne-time warning per shell session, suppressible:\n\n```bash\n_containai_deprecation_warned=\"\"\n\n_containai_deprecation_warn_asb() {\n    [[ \"${CONTAINAI_NO_DEPRECATION_WARNING:-}\" == \"1\" ]] && return 0\n    [[ -n \"$_containai_deprecation_warned\" ]] && return 0\n    \n    echo \"[WARN] 'asb' commands are deprecated. Use 'containai' or 'cai' instead.\" >&2\n    echo \"       Suppress this warning: export CONTAINAI_NO_DEPRECATION_WARNING=1\" >&2\n    _containai_deprecation_warned=1\n}\n\n# Deprecated commands show warning\nasb() {\n    _containai_deprecation_warn_asb\n    _containai_main \"$@\"\n}\n```\n\n### Help Text Updates\n```\nUsage: containai [OPTIONS] [-- AGENT_ARGS...]\n       cai [OPTIONS] [-- AGENT_ARGS...]\n       asb [OPTIONS] [-- AGENT_ARGS...]  (deprecated)\n\nOptions:\n  --data-volume <name>   Use specified Docker volume for agent data\n  --profile <name>       Use named profile from config file\n  --config <path>        Use explicit config file (disables discovery)\n  --volume, -v <mount>   Add additional bind mount (unchanged)\n  --workspace <path>     Use specified host workspace (unchanged)\n  \nRelated Commands:\n  cai-stop-all           Stop all sandbox containers\n  cai-shell              Open shell in running sandbox\n  caid                   Run in detached mode\n```\n\n## Key Files\n- Modify: `agent-sandbox/aliases.sh` (add new aliases near end)\n- Modify: `agent-sandbox/aliases.sh:404` (asb function \u2192 add deprecation)\n- Modify: Help/usage text for new flags\n## Overview\nAdd `containai` and `cai` as primary CLI aliases, keeping `asb*` functions as deprecated but working aliases with one-time warning.\n\n## Implementation\n\n### New Primary Aliases\n```bash\n# Primary aliases - these are the recommended commands\ncontainai() { _containai_main \"$@\"; }\ncai() { _containai_main \"$@\"; }\n\ncontainai-stop-all() { asb-stop-all \"$@\"; }\ncai-stop-all() { asb-stop-all \"$@\"; }\n\ncontainai-shell() { asb-shell \"$@\"; }\ncai-shell() { asb-shell \"$@\"; }\n\ncontainaid() { asbd \"$@\"; }\ncaid() { asbd \"$@\"; }\n```\n\n### Deprecation Policy\nOne-time warning per shell session, suppressible:\n\n```bash\n_containai_deprecation_warned=\"\"\n\n_containai_deprecation_check() {\n    if [[ \"${CONTAINAI_NO_DEPRECATION_WARNING:-}\" == \"1\" ]]; then\n        return 0\n    fi\n    if [[ -z \"$_containai_deprecation_warned\" ]]; then\n        echo \"[WARN] 'asb' commands are deprecated. Use 'containai' or 'cai' instead.\" >&2\n        echo \"       Suppress this warning: export CONTAINAI_NO_DEPRECATION_WARNING=1\" >&2\n        _containai_deprecation_warned=1\n    fi\n}\n\nasb() {\n    _containai_deprecation_check\n    _containai_main \"$@\"\n}\n```\n\n### Help Text Updates\nUpdate usage text to show both old and new command names:\n```\nUsage: containai [OPTIONS] COMMAND [ARGS...]\n       cai [OPTIONS] COMMAND [ARGS...]\n       asb [OPTIONS] COMMAND [ARGS...]  (deprecated)\n\nOptions:\n  --data-volume <name>   Use specified Docker volume for agent data\n  --profile <name>       Use named profile from config file\n  --volume, -v <mount>   Add additional bind mount (unchanged)\n  --workspace <path>     Use specified host workspace (unchanged)\n  ...\n```\n\n### v1 Alias Strategy\nFor v1, `containai`/`cai` are shell function aliases only. If a future `containai` binary is added to PATH, functions will shadow it. Acceptable for v1.\n\n## Key Files\n- Modify: `agent-sandbox/aliases.sh` (add new aliases at end)\n- Modify: `agent-sandbox/aliases.sh` (asb function \u2192 add deprecation check)\n- Modify: Help/usage text throughout\n## Overview\nAdd `containai` and `cai` as primary CLI aliases, keeping `asb*` functions as deprecated but working aliases.\n\n## Implementation\n\n### New Primary Aliases\n```bash\n# Primary aliases - these are the recommended commands\ncontainai() { asb \"$@\"; }\ncai() { asb \"$@\"; }\n\ncontainai-stop-all() { asb-stop-all \"$@\"; }\ncai-stop-all() { asb-stop-all \"$@\"; }\n\ncontainai-shell() { asb-shell \"$@\"; }\ncai-shell() { asb-shell \"$@\"; }\n\ncontainaid() { asbd \"$@\"; }\ncaid() { asbd \"$@\"; }\n```\n\n### Deprecation Notice\nAdd a one-time deprecation notice when `asb` is used directly:\n\n```bash\n_asb_deprecation_warned=false\n\nasb() {\n    if [[ \"$_asb_deprecation_warned\" != \"true\" ]]; then\n        echo \"[WARN] 'asb' is deprecated, use 'containai' or 'cai' instead\" >&2\n        _asb_deprecation_warned=true\n    fi\n    _containai_main \"$@\"\n}\n```\n\n### Internal Rename\nOptionally rename internal `_asb_*` functions to `_containai_*` for consistency. Keep `_asb_*` as aliases if changed.\n\n## Key Files\n- Modify: `agent-sandbox/aliases.sh` (add new aliases at end)\n- Modify: `agent-sandbox/aliases.sh:404` (asb function - add deprecation)\n## Acceptance\n- [ ] `containai` works identically to core functionality\n- [ ] `cai` works identically to core functionality\n- [ ] `containai-stop-all` and `cai-stop-all` work\n- [ ] `containai-shell` and `cai-shell` work\n- [ ] `containaid` and `caid` work\n- [ ] `asb` shows one-time deprecation warning to stderr\n- [ ] Warning only shown once per shell session\n- [ ] `CONTAINAI_NO_DEPRECATION_WARNING=1` suppresses warning\n- [ ] `cai` does NOT show deprecation warning\n- [ ] Help text shows volume selection is automatic by workspace\n## Done summary\nTBD\n\n## Evidence\n- Commits:\n- Tests:\n- PRs:\n"
    },
    {
      "data": {
        "assignee": null,
        "claim_note": "",
        "claimed_at": null,
        "created_at": "2026-01-18T20:16:12.769310Z",
        "depends_on": [
          "fn-4-vet.3",
          "fn-4-vet.4"
        ],
        "epic": "fn-4-vet",
        "id": "fn-4-vet.6",
        "priority": null,
        "spec_path": ".flow/tasks/fn-4-vet.6.md",
        "status": "todo",
        "title": "Update integration tests for configurable volumes",
        "updated_at": "2026-01-18T21:20:45.178168Z"
      },
      "id": "fn-4-vet.6",
      "spec": "# fn-4-vet.6 Update integration tests for configurable volumes\n\n## Description\n## Overview\nUpdate `test-sync-integration.sh` to use **isolated test volumes by default** and add tests for workspace path-based volume selection.\n\n## Implementation\n\n### Isolated Test Volumes\n```bash\nTEST_RUN_ID=\"test-$(date +%s)-$$\"\nTEST_DATA_VOLUME=\"containai-test-${TEST_RUN_ID}\"\n\ncleanup_test_volumes() {\n    docker volume rm \"$TEST_DATA_VOLUME\" 2>/dev/null || true\n    docker volume ls --filter \"name=containai-test-\" -q | xargs -r docker volume rm 2>/dev/null || true\n}\ntrap cleanup_test_volumes EXIT\n```\n\n### New Test Cases\n\n```bash\ntest_custom_volume_flag() {\n    step \"Testing --volume flag for sync-agent\"\n    local test_vol=\"test-flag-vol-$$\"\n    ./sync-agent-plugins.sh --volume \"$test_vol\" --dry-run 2>&1 | grep -q \"$test_vol\"\n    pass \"sync-agent respects --volume flag\"\n}\n\ntest_env_var_volume() {\n    step \"Testing CONTAINAI_DATA_VOLUME environment variable\"\n    local test_vol=\"test-env-vol-$$\"\n    CONTAINAI_DATA_VOLUME=\"$test_vol\" ./sync-agent-plugins.sh --dry-run 2>&1 | grep -q \"$test_vol\"\n    pass \"sync-agent respects CONTAINAI_DATA_VOLUME\"\n}\n\ntest_workspace_path_matching() {\n    step \"Testing workspace path-based config matching\"\n    local test_dir=\"/tmp/test-workspace-match-$$\"\n    local test_vol=\"test-ws-vol-$$\"\n    \n    mkdir -p \"$test_dir/subproject/.containai\"\n    cat > \"$test_dir/subproject/.containai/config.toml\" << EOF\n[agent]\ndata_volume = \"default-vol\"\n\n[workspace.\"./\"]\ndata_volume = \"$test_vol\"\nEOF\n    \n    (cd \"$test_dir/subproject\" && source \"$ORIG_DIR/aliases.sh\" && \\\n     [[ \"$(_containai_resolve_volume \"\" \"$test_dir/subproject\")\" == \"$test_vol\" ]])\n    pass \"Workspace path matching works\"\n    rm -rf \"$test_dir\"\n}\n\ntest_workspace_fallback_to_agent() {\n    step \"Testing fallback to [agent] when no workspace match\"\n    local test_dir=\"/tmp/test-fallback-$$\"\n    local default_vol=\"fallback-vol-$$\"\n    \n    mkdir -p \"$test_dir/.containai\"\n    cat > \"$test_dir/.containai/config.toml\" << EOF\n[agent]\ndata_volume = \"$default_vol\"\n\n[workspace.\"/some/other/path\"]\ndata_volume = \"other-vol\"\nEOF\n    \n    (cd \"$test_dir\" && source \"$ORIG_DIR/aliases.sh\" && \\\n     [[ \"$(_containai_resolve_volume \"\" \"$test_dir\")\" == \"$default_vol\" ]])\n    pass \"Falls back to [agent] when no workspace match\"\n    rm -rf \"$test_dir\"\n}\n\ntest_longest_match_wins() {\n    step \"Testing longest workspace path match wins\"\n    local test_dir=\"/tmp/test-longest-$$\"\n    \n    mkdir -p \"$test_dir/project/subdir/.containai\"\n    cat > \"$test_dir/project/subdir/.containai/config.toml\" << EOF\n[agent]\ndata_volume = \"default\"\n\n[workspace.\"/tmp/test-longest-$$/project\"]\ndata_volume = \"project-vol\"\n\n[workspace.\"/tmp/test-longest-$$/project/subdir\"]\ndata_volume = \"subdir-vol\"\nEOF\n    \n    (cd \"$test_dir/project/subdir\" && source \"$ORIG_DIR/aliases.sh\" && \\\n     [[ \"$(_containai_resolve_volume \"\" \"$test_dir/project/subdir\")\" == \"subdir-vol\" ]])\n    pass \"Longest workspace path match wins\"\n    rm -rf \"$test_dir\"\n}\n\ntest_data_volume_overrides_config() {\n    step \"Testing --data-volume overrides workspace config\"\n    local test_dir=\"/tmp/test-override-$$\"\n    \n    mkdir -p \"$test_dir/.containai\"\n    echo '[workspace.\"./\"]\ndata_volume = \"config-vol\"' > \"$test_dir/.containai/config.toml\"\n    \n    (cd \"$test_dir\" && source \"$ORIG_DIR/aliases.sh\" && \\\n     [[ \"$(_containai_resolve_volume \"cli-vol\")\" == \"cli-vol\" ]])\n    pass \"--data-volume overrides workspace config\"\n    rm -rf \"$test_dir\"\n}\n```\n\n## Key Files\n- Modify: `agent-sandbox/test-sync-integration.sh` (isolated volumes, new tests)\n## Overview\nUpdate `test-sync-integration.sh` to use **isolated test volumes by default** to prevent clobbering user data. Add tests for configurable volume functionality including --workspace config discovery.\n\n## Implementation\n\n### Critical Change: Isolated Test Volumes\nTests MUST NOT use `sandbox-agent-data` by default:\n\n```bash\nTEST_RUN_ID=\"test-$(date +%s)-$$\"\nTEST_DATA_VOLUME=\"containai-test-${TEST_RUN_ID}\"\n\ncleanup_test_volumes() {\n    docker volume rm \"$TEST_DATA_VOLUME\" 2>/dev/null || true\n    docker volume ls --filter \"name=containai-test-\" -q | xargs -r docker volume rm 2>/dev/null || true\n}\ntrap cleanup_test_volumes EXIT\n```\n\n### New Test Cases\n\n```bash\ntest_custom_volume_flag() {\n    step \"Testing --volume flag for sync-agent\"\n    local test_vol=\"test-flag-vol-$$\"\n    ./sync-agent-plugins.sh --volume \"$test_vol\" --dry-run 2>&1 | grep -q \"$test_vol\"\n    pass \"sync-agent respects --volume flag\"\n}\n\ntest_env_var_volume() {\n    step \"Testing CONTAINAI_DATA_VOLUME environment variable\"\n    local test_vol=\"test-env-vol-$$\"\n    CONTAINAI_DATA_VOLUME=\"$test_vol\" ./sync-agent-plugins.sh --dry-run 2>&1 | grep -q \"$test_vol\"\n    pass \"sync-agent respects CONTAINAI_DATA_VOLUME\"\n}\n\ntest_config_file_volume() {\n    step \"Testing config file discovery\"\n    local test_dir=\"/tmp/test-containai-config-$$\"\n    local test_vol=\"test-config-vol-$$\"\n    mkdir -p \"$test_dir/.containai\"\n    echo \"[agent]\ndata_volume = \\\"$test_vol\\\"\" > \"$test_dir/.containai/config.toml\"\n    \n    (cd \"$test_dir\" && source \"$ORIG_DIR/aliases.sh\" && \\\n     [[ \"$(_containai_resolve_volume)\" == \"$test_vol\" ]])\n    pass \"Config file discovery works\"\n    rm -rf \"$test_dir\"\n}\n\ntest_workspace_config_discovery() {\n    step \"Testing --workspace affects config discovery\"\n    local test_dir=\"/tmp/test-workspace-$$\"\n    local test_vol=\"test-workspace-vol-$$\"\n    mkdir -p \"$test_dir/.containai\"\n    echo \"[agent]\ndata_volume = \\\"$test_vol\\\"\" > \"$test_dir/.containai/config.toml\"\n    \n    # Run from different directory but with --workspace pointing to test_dir\n    source \"$ORIG_DIR/aliases.sh\"\n    local resolved\n    resolved=$(_containai_resolve_volume \"\" \"\" \"$test_dir\")\n    [[ \"$resolved\" == \"$test_vol\" ]]\n    pass \"--workspace config discovery works\"\n    rm -rf \"$test_dir\"\n}\n\ntest_profile_selection() {\n    step \"Testing --profile flag\"\n    local test_dir=\"/tmp/test-profile-$$\"\n    mkdir -p \"$test_dir/.containai\"\n    echo \"[agent]\ndata_volume = \\\"default-vol\\\"\n[profile.testing]\ndata_volume = \\\"test-profile-vol\\\"\" > \"$test_dir/.containai/config.toml\"\n    \n    (cd \"$test_dir\" && source \"$ORIG_DIR/aliases.sh\" && \\\n     [[ \"$(_containai_resolve_volume \"\" \"testing\")\" == \"test-profile-vol\" ]])\n    pass \"Profile selection works\"\n    rm -rf \"$test_dir\"\n}\n\ntest_data_volume_overrides_config() {\n    step \"Testing --data-volume overrides config file\"\n    local test_dir=\"/tmp/test-override-$$\"\n    mkdir -p \"$test_dir/.containai\"\n    echo \"[agent]\ndata_volume = \\\"config-vol\\\"\" > \"$test_dir/.containai/config.toml\"\n    \n    (cd \"$test_dir\" && source \"$ORIG_DIR/aliases.sh\" && \\\n     [[ \"$(_containai_resolve_volume \"cli-vol\")\" == \"cli-vol\" ]])\n    pass \"--data-volume overrides config\"\n    rm -rf \"$test_dir\"\n}\n```\n\n## Key Files\n- Modify: `agent-sandbox/test-sync-integration.sh:20` (unique volume name)\n- Modify: `agent-sandbox/test-sync-integration.sh` (add cleanup trap)\n- Modify: `agent-sandbox/test-sync-integration.sh` (add new test functions)\n## Overview\nUpdate `test-sync-integration.sh` to use **isolated test volumes by default** to prevent clobbering user data. Add tests for configurable volume functionality.\n\n## Implementation\n\n### Critical Change: Isolated Test Volumes\nTests MUST NOT use `sandbox-agent-data` by default. Use unique temporary volume names:\n\n```bash\n# At top of test file\nTEST_RUN_ID=\"test-$(date +%s)-$$\"\nTEST_DATA_VOLUME=\"containai-test-${TEST_RUN_ID}\"\n\n# Cleanup function\ncleanup_test_volumes() {\n    docker volume rm \"$TEST_DATA_VOLUME\" 2>/dev/null || true\n    # Also clean any volumes created by individual tests\n    docker volume ls --filter \"name=containai-test-\" -q | xargs -r docker volume rm 2>/dev/null || true\n}\ntrap cleanup_test_volumes EXIT\n```\n\n### Current Code (line 20)\n```bash\nDATA_VOLUME=\"sandbox-agent-data\"\n```\n\n### New Approach\n1. Default to unique test volume name\n2. Accept `--volume` flag to override (for testing specific volume scenarios)\n3. Add `--use-default-volume` flag to explicitly opt-in to testing with `sandbox-agent-data`\n4. Cleanup test volumes on exit\n\n### New Test Cases\n```bash\ntest_custom_volume_flag() {\n    step \"Testing --volume flag for sync-agent\"\n    local test_vol=\"test-flag-vol-$$\"\n    ./sync-agent-plugins.sh --volume \"$test_vol\" --dry-run 2>&1 | grep -q \"$test_vol\"\n    pass \"sync-agent respects --volume flag\"\n    docker volume rm \"$test_vol\" 2>/dev/null || true\n}\n\ntest_env_var_volume() {\n    step \"Testing CONTAINAI_DATA_VOLUME environment variable\"\n    local test_vol=\"test-env-vol-$$\"\n    CONTAINAI_DATA_VOLUME=\"$test_vol\" ./sync-agent-plugins.sh --dry-run 2>&1 | grep -q \"$test_vol\"\n    pass \"sync-agent respects CONTAINAI_DATA_VOLUME\"\n}\n\ntest_config_file_volume() {\n    step \"Testing config file discovery\"\n    local test_dir=\"/tmp/test-containai-$$\"\n    local test_vol=\"test-config-vol-$$\"\n    mkdir -p \"$test_dir/.containai\"\n    echo \"[agent]\ndata_volume = \\\"$test_vol\\\"\" > \"$test_dir/.containai/config.toml\"\n    \n    (cd \"$test_dir\" && source \"$ORIG_DIR/aliases.sh\" && \\\n     [[ \"$(_containai_resolve_volume)\" == \"$test_vol\" ]])\n    pass \"Config file discovery works\"\n    \n    rm -rf \"$test_dir\"\n}\n\ntest_profile_selection() {\n    step \"Testing --profile flag\"\n    local test_dir=\"/tmp/test-profile-$$\"\n    mkdir -p \"$test_dir/.containai\"\n    echo \"[agent]\ndata_volume = \\\"default-vol\\\"\n[profile.testing]\ndata_volume = \\\"test-profile-vol\\\"\" > \"$test_dir/.containai/config.toml\"\n    \n    (cd \"$test_dir\" && source \"$ORIG_DIR/aliases.sh\" && \\\n     [[ \"$(_containai_resolve_volume \"\" \"testing\")\" == \"test-profile-vol\" ]])\n    pass \"Profile selection works\"\n    \n    rm -rf \"$test_dir\"\n}\n\ntest_python_optional() {\n    step \"Testing graceful fallback without Python\"\n    # This test verifies warning is shown but doesn't fail\n    # Actual test depends on environment\n    pass \"Python optional handling (manual verification needed)\"\n}\n```\n\n## Key Files\n- Modify: `agent-sandbox/test-sync-integration.sh:20` (change DATA_VOLUME to unique)\n- Modify: `agent-sandbox/test-sync-integration.sh` (add cleanup trap)\n- Modify: `agent-sandbox/test-sync-integration.sh` (add new test functions)\n## Overview\nUpdate `test-sync-integration.sh` to test both default and custom volume configurations. Ensure tests can run with isolated volumes to avoid interference.\n\n## Implementation\n\n### Current Code (line 20)\n```bash\nDATA_VOLUME=\"sandbox-agent-data\"\n```\n\n### New Approach\n1. Accept `--volume` flag for test runs\n2. Default to a test-specific volume name to avoid production interference\n3. Add tests for config loading behavior\n\n### New Test Cases\n```bash\ntest_custom_volume_flag() {\n    # Test that --volume flag is respected\n    ./sync-agent-plugins.sh --volume test-custom-vol --dry-run\n    # Verify output mentions test-custom-vol\n}\n\ntest_env_var_volume() {\n    # Test that CONTAINAI_VOLUME env var works\n    CONTAINAI_VOLUME=test-env-vol ./sync-agent-plugins.sh --dry-run\n    # Verify output mentions test-env-vol\n}\n\ntest_config_file_volume() {\n    # Test config file discovery\n    mkdir -p /tmp/test-containai/.containai\n    echo '[agent]\nvolume = \"test-config-vol\"' > /tmp/test-containai/.containai/config.toml\n    cd /tmp/test-containai\n    source \"$ORIG_DIR/aliases.sh\"\n    # Verify $_CONTAINAI_VOLUME equals test-config-vol\n}\n```\n\n### Test Volume Cleanup\nAdd cleanup function to remove test volumes after test run.\n\n## Key Files\n- Modify: `agent-sandbox/test-sync-integration.sh:20` (DATA_VOLUME)\n- Modify: `agent-sandbox/test-sync-integration.sh` (add new test functions)\n## Acceptance\n- [ ] Tests use unique isolated volume names by default\n- [ ] `cleanup_test_volumes()` removes test volumes on exit\n- [ ] `test_custom_volume_flag()` passes\n- [ ] `test_env_var_volume()` passes\n- [ ] `test_workspace_path_matching()` passes\n- [ ] `test_workspace_fallback_to_agent()` passes\n- [ ] `test_longest_match_wins()` passes\n- [ ] `test_data_volume_overrides_config()` passes\n- [ ] No test volumes left behind after run\n- [ ] `./test-sync-integration.sh` completes successfully\n## Done summary\nTBD\n\n## Evidence\n- Commits:\n- Tests:\n- PRs:\n"
    },
    {
      "data": {
        "assignee": null,
        "claim_note": "",
        "claimed_at": null,
        "created_at": "2026-01-18T22:18:04.342353Z",
        "depends_on": [],
        "epic": "fn-4-vet",
        "id": "fn-4-vet.7",
        "priority": null,
        "spec_path": ".flow/tasks/fn-4-vet.7.md",
        "status": "todo",
        "title": "Create Python TOML parser (parse-toml.py)",
        "updated_at": "2026-01-18T22:18:47.053954Z"
      },
      "id": "fn-4-vet.7",
      "spec": "# fn-4-vet.7 Create Python TOML parser (parse-toml.py)\n\n## Description\nCreate `agent-sandbox/parse-toml.py` - a Python 3.11+ TOML config parser.\n\n## Implementation\n\n```python\n#!/usr/bin/env python3\n\"\"\"Parse ContainAI TOML config. Requires Python 3.11+ (tomllib).\"\"\"\nimport sys\nimport tomllib\nimport json\nfrom pathlib import Path\n\ndef find_workspace(config: dict, workspace: str) -> dict | None:\n    \"\"\"Find workspace with longest matching path (segment boundary).\"\"\"\n    workspace = Path(workspace).resolve()\n    workspaces = config.get(\"workspace\", {})\n    \n    best_match, best_len = None, 0\n    for path_str, section in workspaces.items():\n        cfg_path = Path(path_str)\n        if not cfg_path.is_absolute():\n            continue\n        try:\n            workspace.relative_to(cfg_path)\n            if len(str(cfg_path)) > best_len:\n                best_match, best_len = section, len(str(cfg_path))\n        except ValueError:\n            pass\n    return best_match\n\ndef main():\n    if len(sys.argv) < 3:\n        print(\"Usage: parse-toml.py <config> <workspace>\", file=sys.stderr)\n        sys.exit(1)\n    \n    with open(sys.argv[1], \"rb\") as f:\n        config = tomllib.load(f)\n    \n    ws = find_workspace(config, sys.argv[2])\n    agent = config.get(\"agent\", {})\n    default_excludes = config.get(\"default_excludes\", [])\n    \n    print(json.dumps({\n        \"data_volume\": ws.get(\"data_volume\") if ws else agent.get(\"data_volume\", \"sandbox-agent-data\"),\n        \"excludes\": list(set(default_excludes + (ws.get(\"excludes\", []) if ws else [])))\n    }))\n\nif __name__ == \"__main__\":\n    main()\n```\n\n## Key Points\n- Exit 1 with stderr message if Python < 3.11 (tomllib import fails)\n- Output JSON: `{\"data_volume\": \"...\", \"excludes\": [...]}`\n- Absolute paths only in workspace sections (skip relative)\n- Longest path-segment match wins\n## Acceptance\n- [ ] Script exists at `agent-sandbox/parse-toml.py`\n- [ ] Requires Python 3.11+ (fails with clear error on older versions)\n- [ ] Outputs valid JSON with `data_volume` and `excludes` keys\n- [ ] Workspace matching uses path-segment boundaries\n- [ ] Longest match wins when multiple workspaces match\n- [ ] Excludes are cumulative (default_excludes + workspace excludes)\n## Done summary\nTBD\n\n## Evidence\n- Commits:\n- Tests:\n- PRs:\n"
    },
    {
      "data": {
        "assignee": null,
        "claim_note": "",
        "claimed_at": null,
        "created_at": "2026-01-18T22:18:04.494054Z",
        "depends_on": [
          "fn-4-vet.7"
        ],
        "epic": "fn-4-vet",
        "id": "fn-4-vet.8",
        "priority": null,
        "spec_path": ".flow/tasks/fn-4-vet.8.md",
        "status": "todo",
        "title": "Create lib/config.sh - config loading & volume resolution",
        "updated_at": "2026-01-18T22:18:58.733465Z"
      },
      "id": "fn-4-vet.8",
      "spec": "# fn-4-vet.8 Create lib/config.sh - config loading & volume resolution\n\n## Description\nCreate `agent-sandbox/lib/config.sh` - config loading and volume resolution for bash.\n\n## Functions\n\n### `_containai_find_config(workspace)`\nWalk up from workspace to git root (or /) looking for `.containai/config.toml`.\nThen check `~/.config/containai/config.toml`. Return first found path or empty.\n\n### `_containai_parse_config(config_file, workspace)`\nCall `parse-toml.py` and capture JSON output. Parse with jq or bash.\nReturn associative array or set global vars: `_CAI_VOLUME`, `_CAI_EXCLUDES`.\n\n### `_containai_resolve_volume(cli_volume, workspace, explicit_config)`\nImplements precedence:\n1. `cli_volume` if set \u2192 return immediately (skip config)\n2. `CONTAINAI_DATA_VOLUME` env \u2192 return immediately (skip config)\n3. Find and parse config \u2192 return `data_volume`\n4. Default: `sandbox-agent-data`\n\n### `_containai_resolve_excludes(workspace, explicit_config)`\nParse config, return excludes array (cumulative default + workspace).\n\n## Key Points\n- Check `command -v python3` before calling parser\n- If Python unavailable but config exists, warn and use default\n- If `--config` specified but file missing, error exit\n## Acceptance\n- [ ] File exists at `agent-sandbox/lib/config.sh`\n- [ ] `_containai_find_config` walks up from workspace correctly\n- [ ] `_containai_parse_config` calls parse-toml.py and parses JSON\n- [ ] `_containai_resolve_volume` implements correct precedence\n- [ ] `_containai_resolve_excludes` returns cumulative excludes\n- [ ] Graceful fallback when Python unavailable\n- [ ] Error exit when explicit `--config` file missing\n## Done summary\nTBD\n\n## Evidence\n- Commits:\n- Tests:\n- PRs:\n"
    },
    {
      "data": {
        "assignee": null,
        "claim_note": "",
        "claimed_at": null,
        "created_at": "2026-01-18T22:18:04.657634Z",
        "depends_on": [],
        "epic": "fn-4-vet",
        "id": "fn-4-vet.9",
        "priority": null,
        "spec_path": ".flow/tasks/fn-4-vet.9.md",
        "status": "todo",
        "title": "Create lib/container.sh - container operations",
        "updated_at": "2026-01-18T22:19:09.907904Z"
      },
      "id": "fn-4-vet.9",
      "spec": "# fn-4-vet.9 Create lib/container.sh - container operations\n\n## Description\nCreate `agent-sandbox/lib/container.sh` - container operations extracted from aliases.sh.\n\n## Functions to Extract\n\n### `_containai_container_name()`\nGenerate sanitized container name from git repo/branch or directory.\n(Copy from `_asb_container_name()` in aliases.sh:28-87)\n\n### `_containai_check_isolation()`\nContainer isolation detection.\n(Copy from `_asb_check_isolation()` in aliases.sh:91-127)\n\n### `_containai_check_sandbox()`\nCheck if inside sandbox container.\n(Copy from `_asb_check_sandbox()` in aliases.sh:130-229)\n\n### `_containai_preflight_checks()`\nRun preflight checks before container operations.\n(Copy from `_asb_preflight_checks()` in aliases.sh:232-276)\n\n### `_containai_ensure_volumes(volume_name)`\nEnsure data volume exists. Takes volume name as parameter.\n(Modify from `_asb_ensure_volumes()` in aliases.sh:349-369)\n\n### `_containai_start_container(options...)`\nStart or attach to container. Core logic from `asb()`.\n\n### `_containai_stop_all()`\nStop all ContainAI containers.\n(From `asb-stop-all()` in aliases.sh:827-894)\n\n## Key Changes\n- Rename all `_asb_` prefixes to `_containai_`\n- `_containai_ensure_volumes` takes volume name parameter\n- Update labels to use `containai.sandbox` instead of `asb.sandbox`\n## Acceptance\n- [ ] File exists at `agent-sandbox/lib/container.sh`\n- [ ] All functions renamed from `_asb_*` to `_containai_*`\n- [ ] `_containai_ensure_volumes` accepts volume name parameter\n- [ ] Labels changed to `containai.sandbox=containai`\n- [ ] `_containai_stop_all` works correctly\n- [ ] Functions are self-contained (can be sourced independently with config.sh)\n## Done summary\nTBD\n\n## Evidence\n- Commits:\n- Tests:\n- PRs:\n"
    }
  ]
}
