#!/usr/bin/env bash
# Launch a coding agent in an isolated container with its own git workspace
# The container runs persistently for VS Code Remote connection

set -e

# Default values
SOURCE="."
BRANCH=""
AGENT="all"
NAME=""
DOTNET_PREVIEW=""
NETWORK_PROXY="allow-all"

# Proxy configuration defaults (computed later once container name is known)
PROXY_IMAGE="coding-agents-proxy:local"
PROXY_CONTAINER_NAME=""
PROXY_NETWORK_NAME=""
PROXY_URL=""
USE_SQUID=false

# Parse arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        -b|--branch)
            BRANCH="$2"
            shift 2
            ;;
        --agent)
            AGENT="$2"
            shift 2
            ;;
        --name)
            NAME="$2"
            shift 2
            ;;
        --dotnet-preview)
            DOTNET_PREVIEW="$2"
            shift 2
            ;;
        --network-proxy)
            NETWORK_PROXY="$2"
            shift 2
            ;;
        -h|--help)
            echo "Usage: launch-agent [SOURCE] [OPTIONS]"
            echo ""
            echo "SOURCE can be:"
            echo "  â€¢ Local path to a git repository (default: current directory)"
            echo "  â€¢ Git URL (https://...)"
            echo ""
            echo "Options:"
            echo "  -b, --branch BRANCH         Branch name (creates <agent>/<branch>)"
            echo "  --agent AGENT               Agent type: copilot, codex, claude, all (default: all)"
            echo "  --name NAME                 Custom container name"
            echo "  --dotnet-preview CHANNEL    Install .NET preview SDK (e.g., 9.0)"
            echo "  --network-proxy MODE        Network proxy: allow-all, restricted, squid (default: allow-all)"
            echo "  -h, --help                  Show this help"
            echo ""
            echo "Examples:"
            echo "  launch-agent                           # Current directory"
            echo "  launch-agent . -b feature-auth         # Current dir, custom branch"
            echo "  launch-agent https://github.com/user/repo --agent copilot"
            echo "  launch-agent /path/to/repo --name my-workspace"
            exit 0
            ;;
        *)
            SOURCE="$1"
            shift
            ;;
    esac
done

# Validate network proxy option
case "$NETWORK_PROXY" in
    allow-all|none|restricted|squid)
        ;;
    *)
        echo "âŒ Error: Invalid --network-proxy value '$NETWORK_PROXY'"
        exit 1
        ;;
esac

# Treat 'none' as alias for allow-all to preserve backwards compatibility
if [ "$NETWORK_PROXY" = "none" ]; then
    NETWORK_PROXY="allow-all"
fi

# Determine if source is a URL or local path
if [[ "$SOURCE" =~ ^https?:// ]]; then
    IS_URL=true
    SOURCE_TYPE="url"
    REPO_NAME=$(basename "$SOURCE" .git)
    GIT_URL="$SOURCE"
else
    IS_URL=false
    SOURCE_TYPE="local"
    SOURCE=$(realpath "$SOURCE")
    
    # Check if it's a git repository
    if [ ! -d "$SOURCE/.git" ]; then
        echo "âŒ Error: $SOURCE is not a git repository"
        exit 1
    fi
    
    REPO_NAME=$(basename "$SOURCE")
    
    # Get git remote URL if it exists
    cd "$SOURCE"
    ORIGIN_URL=$(git remote get-url origin 2>/dev/null || echo "")
    cd - > /dev/null
    
    # Convert to WSL path if needed (for Windows compatibility)
    if [[ "$SOURCE" =~ ^/mnt/[a-z]/ ]]; then
        WSL_PATH="$SOURCE"
    elif [[ "$SOURCE" =~ ^[A-Z]: ]]; then
        DRIVE=$(echo "$SOURCE" | cut -d: -f1 | tr '[:upper:]' '[:lower:]')
        REST=$(echo "$SOURCE" | cut -d: -f2 | tr '\\' '/')
        WSL_PATH="/mnt/${DRIVE}${REST}"
    else
        WSL_PATH="$SOURCE"
    fi
fi

# Restricted network cannot clone remote repositories
if [ "$NETWORK_PROXY" = "restricted" ] && [ "$SOURCE_TYPE" = "url" ]; then
    echo "âŒ Restricted network mode cannot clone from a URL. Provide a local path or use --network-proxy allow-all."
    exit 1
fi

# Determine container and workspace names
if [ -n "$NAME" ]; then
    CONTAINER_NAME="${AGENT}-${NAME}"
    WORKSPACE_NAME="$NAME"
else
    CONTAINER_NAME="${AGENT}-${REPO_NAME}"
    WORKSPACE_NAME="$REPO_NAME"
fi

PROXY_CONTAINER_NAME="${CONTAINER_NAME}-proxy"
PROXY_NETWORK_NAME="${CONTAINER_NAME}-net"

# Determine branch name
if [ -z "$BRANCH" ]; then
    if [ "$SOURCE_TYPE" = "local" ]; then
        cd "$SOURCE"
        CURRENT_BRANCH=$(git branch --show-current 2>/dev/null || echo "")
        cd - > /dev/null
        BRANCH="${CURRENT_BRANCH:-main}"
    else
        BRANCH="main"
    fi
fi

AGENT_BRANCH="${AGENT}/${BRANCH}"

# Select image based on agent parameter
case "$AGENT" in
    copilot)
        IMAGE_NAME="coding-agents-copilot:local"
        ;;
    codex)
        IMAGE_NAME="coding-agents-codex:local"
        ;;
    claude)
        IMAGE_NAME="coding-agents-claude:local"
        ;;
    *)
        IMAGE_NAME="coding-agents:local"
        ;;
esac

# Get timezone
TZ_VALUE="${TZ:-$(cat /etc/timezone 2>/dev/null || echo UTC)}"

# Determine docker network settings based on selection
NETWORK_MODE="bridge"
NETWORK_POLICY_ENV="allow-all"
case "$NETWORK_PROXY" in
    restricted)
        NETWORK_MODE="none"
        NETWORK_POLICY_ENV="restricted"
        ;;
    squid)
        NETWORK_MODE="$PROXY_NETWORK_NAME"
        NETWORK_POLICY_ENV="squid"
        USE_SQUID=true
        ;;
    *)
        NETWORK_POLICY_ENV="allow-all"
        ;;
esac

echo "ðŸš€ Launching Coding Agent..."
echo "ðŸŽ¯ Agent: $AGENT"
echo "ðŸ“ Source: $SOURCE ($SOURCE_TYPE)"
echo "ðŸŒ¿ Branch: $AGENT_BRANCH"
echo "ðŸ·ï¸  Container: $CONTAINER_NAME"
echo "ðŸ³ Image: $IMAGE_NAME"
case "$NETWORK_POLICY_ENV" in
    restricted)
        NETWORK_SUMMARY="no outbound network"
        ;;
    squid)
        NETWORK_SUMMARY="proxied via Squid sidecar"
        ;;
    *)
        NETWORK_SUMMARY="standard Docker bridge"
        ;;
esac

echo "ðŸŒ Network policy: $NETWORK_POLICY_ENV (docker --network $NETWORK_MODE â†’ $NETWORK_SUMMARY)"
echo ""

# Check if container already exists
if docker ps -a --filter "name=^${CONTAINER_NAME}$" --format "{{.Names}}" | grep -q "^${CONTAINER_NAME}$"; then
    echo "ðŸ“¦ Container '$CONTAINER_NAME' already exists"
    STATE=$(docker inspect -f '{{.State.Status}}' "$CONTAINER_NAME")
    EXISTING_POLICY=$(docker inspect -f '{{ index .Config.Labels "coding-agents.network-policy" }}' "$CONTAINER_NAME" 2>/dev/null || echo "allow-all")

    if [ "$EXISTING_POLICY" = "squid" ]; then
        EXISTING_PROXY_NAME=$(docker inspect -f '{{ index .Config.Labels "coding-agents.proxy-container" }}' "$CONTAINER_NAME" 2>/dev/null || echo "${CONTAINER_NAME}-proxy")
        EXISTING_NETWORK_NAME=$(docker inspect -f '{{ index .Config.Labels "coding-agents.proxy-network" }}' "$CONTAINER_NAME" 2>/dev/null || echo "${CONTAINER_NAME}-net")
        PROXY_IMAGE_FOR_EXISTING=$(docker inspect -f '{{ index .Config.Labels "coding-agents.proxy-image" }}' "$EXISTING_PROXY_NAME" 2>/dev/null || echo "$PROXY_IMAGE")

        if ! docker ps -a --filter "name=^${EXISTING_PROXY_NAME}$" --format "{{.Names}}" | grep -q "^${EXISTING_PROXY_NAME}$"; then
            echo "âš ï¸  Proxy container missing; recreating..."
            docker network inspect "$EXISTING_NETWORK_NAME" >/dev/null 2>&1 || docker network create "$EXISTING_NETWORK_NAME"
            docker run -d \
                --name "$EXISTING_PROXY_NAME" \
                --hostname "$EXISTING_PROXY_NAME" \
                --network "$EXISTING_NETWORK_NAME" \
                --restart unless-stopped \
                --label "coding-agents.proxy-of=$CONTAINER_NAME" \
                --label "coding-agents.proxy-image=$PROXY_IMAGE_FOR_EXISTING" \
                "$PROXY_IMAGE_FOR_EXISTING" >/dev/null
        else
            PROXY_STATE=$(docker inspect -f '{{.State.Status}}' "$EXISTING_PROXY_NAME")
            if [ "$PROXY_STATE" != "running" ]; then
                echo "â–¶ï¸  Starting proxy container..."
                docker start "$EXISTING_PROXY_NAME" >/dev/null
            fi
        fi

        PROXY_URL="http://${EXISTING_PROXY_NAME}:3128"
        USE_SQUID=true
        PROXY_CONTAINER_NAME="$EXISTING_PROXY_NAME"
        PROXY_NETWORK_NAME="$EXISTING_NETWORK_NAME"
    fi
    
    if [ "$STATE" = "running" ]; then
        echo "âœ… Container is running"
        echo ""
        echo "To connect with VS Code:"
        echo "  1. Install 'Dev Containers' extension"
        echo "  2. Click the remote button (bottom-left)"
        echo "  3. Select 'Attach to Running Container'"
        echo "  4. Choose '$CONTAINER_NAME'"
        echo ""
        echo "Or connect via shell:"
        echo "  docker exec -it $CONTAINER_NAME bash"
        exit 0
    else
        echo "â–¶ï¸  Starting existing container..."
        docker start -ai "$CONTAINER_NAME"
        exit $?
    fi
fi

# Build docker arguments
DOCKER_ARGS=(
    "run" "-d"
    "--name" "$CONTAINER_NAME"
    "--hostname" "$CONTAINER_NAME"
    "-e" "TZ=$TZ_VALUE"
    "-e" "SOURCE_TYPE=$SOURCE_TYPE"
    "-e" "REPO_NAME=$WORKSPACE_NAME"
    "-e" "AGENT_BRANCH=$AGENT_BRANCH"
    "-e" "NETWORK_POLICY=$NETWORK_POLICY_ENV"
    "--label" "coding-agents.network-policy=$NETWORK_POLICY_ENV"
    "-v" "${HOME}/.gitconfig:/home/agentuser/.gitconfig:ro"
    "-v" "${HOME}/.config/gh:/home/agentuser/.config/gh:ro"
    "-v" "${HOME}/.config/github-copilot:/home/agentuser/.config/github-copilot:ro"
)

# Add source-specific environment variables
if [ "$SOURCE_TYPE" = "url" ]; then
    DOCKER_ARGS+=("-e" "GIT_URL=$GIT_URL")
else
    DOCKER_ARGS+=("-e" "LOCAL_REPO_PATH=$WSL_PATH")
    # Mount the local repo as a temporary source (read-only)
    DOCKER_ARGS+=("-v" "${WSL_PATH}:/tmp/source-repo:ro")
fi

if [ -n "$ORIGIN_URL" ]; then
    DOCKER_ARGS+=("-e" "ORIGIN_URL=$ORIGIN_URL")
fi

# Add .NET preview channel if specified
if [ -n "$DOTNET_PREVIEW" ]; then
    DOCKER_ARGS+=("-e" "DOTNET_PREVIEW_CHANNEL=$DOTNET_PREVIEW")
fi

if $USE_SQUID && [ -n "$PROXY_URL" ]; then
    DOCKER_ARGS+=("-e" "HTTP_PROXY=$PROXY_URL")
    DOCKER_ARGS+=("-e" "HTTPS_PROXY=$PROXY_URL")
    DOCKER_ARGS+=("-e" "http_proxy=$PROXY_URL")
    DOCKER_ARGS+=("-e" "https_proxy=$PROXY_URL")
    DOCKER_ARGS+=("-e" "NO_PROXY=localhost,127.0.0.1,.internal,::1")
    DOCKER_ARGS+=("-e" "no_proxy=localhost,127.0.0.1,.internal,::1")
    DOCKER_ARGS+=("--label" "coding-agents.proxy-container=$PROXY_CONTAINER_NAME")
    DOCKER_ARGS+=("--label" "coding-agents.proxy-network=$PROXY_NETWORK_NAME")
    DOCKER_ARGS+=("--label" "coding-agents.proxy-image=$PROXY_IMAGE")
fi

# Add optional agent configs
if [ -d "${HOME}/.config/codex" ]; then
    DOCKER_ARGS+=("-v" "${HOME}/.config/codex:/home/agentuser/.config/codex:ro")
fi
if [ -d "${HOME}/.config/claude" ]; then
    DOCKER_ARGS+=("-v" "${HOME}/.config/claude:/home/agentuser/.config/claude:ro")
fi

# Add MCP secrets if they exist
if [ -f "${HOME}/.config/coding-agents/mcp-secrets.env" ]; then
    DOCKER_ARGS+=("-v" "${HOME}/.config/coding-agents/mcp-secrets.env:/home/agentuser/.mcp-secrets.env:ro")
fi

DOCKER_ARGS+=(
    "-w" "/workspace"
    "--network" "$NETWORK_MODE"
    "--security-opt" "no-new-privileges:true"
    "--cpus=4"
    "--memory=8g"
    "$IMAGE_NAME"
    "sleep" "infinity"
)

# Create and start the container
echo "ðŸ“¦ Creating container..."
CONTAINER_ID=$(docker "${DOCKER_ARGS[@]}")

if [ $? -ne 0 ]; then
    echo "âŒ Failed to create container"
    if $USE_SQUID; then
        docker rm -f "$PROXY_CONTAINER_NAME" >/dev/null 2>&1 || true
        docker network rm "$PROXY_NETWORK_NAME" >/dev/null 2>&1 || true
    fi
    exit 1
fi

echo "ðŸ“¥ Setting up repository..."

SETUP_SCRIPT='#!/bin/bash
set -e

TARGET_DIR="/workspace"
mkdir -p "$TARGET_DIR"

# Clean target directory to ensure a fresh workspace
if [ -d "$TARGET_DIR" ] && [ "$(find "$TARGET_DIR" -mindepth 1 -maxdepth 1 | wc -l)" -gt 0 ]; then
    find "$TARGET_DIR" -mindepth 1 -maxdepth 1 -exec rm -rf {} +
fi

if [ "$SOURCE_TYPE" = "url" ]; then
    echo "ðŸŒ Cloning repository from $GIT_URL..."
    git clone "$GIT_URL" "$TARGET_DIR"
    echo "âœ… Repository cloned"
else
    echo "ðŸ“‹ Copying repository from host..."
    cp -a /tmp/source-repo/. "$TARGET_DIR/"
    echo "âœ… Repository copied"
fi

cd "$TARGET_DIR"

# Setup dual remotes
if [ -n "$ORIGIN_URL" ]; then
    echo "ðŸ”— Setting up remotes..."
    
    # Ensure origin is set correctly
    if git remote get-url origin 2>/dev/null; then
        git remote set-url origin "$ORIGIN_URL"
    else
        git remote add origin "$ORIGIN_URL"
    fi
    
    # Add local remote pointing to the host repository
    if [ "$SOURCE_TYPE" = "local" ]; then
        git remote add local "$LOCAL_REPO_PATH" 2>/dev/null || git remote set-url local "$LOCAL_REPO_PATH"
        echo "  â€¢ origin: $ORIGIN_URL"
        echo "  â€¢ local: $LOCAL_REPO_PATH (default push)"
        
        # Set local as default push remote
        git config remote.pushDefault local
    else
        echo "  â€¢ origin: $ORIGIN_URL"
    fi
else
    echo "â„¹ï¸  No origin remote configured"
fi

# Create and checkout agent branch
echo "ðŸŒ¿ Creating branch: $AGENT_BRANCH"
git checkout -b "$AGENT_BRANCH" 2>/dev/null || git checkout "$AGENT_BRANCH"

echo "âœ… Repository setup complete"
echo ""
echo "Branch: $(git branch --show-current)"
echo "Remotes:"
git remote -v | head -4

# Configure git to use HTTPS with gh credential helper
git config --global credential.helper ""
git config --global credential.helper '\''!gh auth git-credential'\''

# Setup MCP if config exists
if [ -f "/workspace/config.toml" ]; then
    echo ""
    echo "âš™ï¸  Setting up MCP configurations..."
    /usr/local/bin/setup-mcp-configs.sh
fi

# Load MCP secrets if available
if [ -f "/home/agentuser/.mcp-secrets.env" ]; then
    echo "ðŸ” MCP secrets available"
fi

# Install .NET preview SDK if requested
if [ -n "$DOTNET_PREVIEW_CHANNEL" ]; then
    echo ""
    echo "ðŸ“¦ Installing .NET SDK $DOTNET_PREVIEW_CHANNEL preview..."
    /usr/local/bin/install-dotnet-preview.sh "$DOTNET_PREVIEW_CHANNEL" || echo "âš ï¸  Preview installation failed (may not exist yet)"
fi

echo ""
echo "âœ¨ Workspace ready at /workspace"
'

echo "$SETUP_SCRIPT" | docker exec -i "$CONTAINER_NAME" bash

if [ $? -ne 0 ]; then
    echo "âŒ Failed to setup repository"
    echo "Cleaning up container..."
    docker rm -f "$CONTAINER_NAME" > /dev/null
    if $USE_SQUID; then
        docker rm -f "$PROXY_CONTAINER_NAME" >/dev/null 2>&1 || true
        docker network rm "$PROXY_NETWORK_NAME" >/dev/null 2>&1 || true
    exit 1
fi

echo ""
echo "âœ… Agent is running!"
echo ""
echo "To connect with VS Code:"
echo "  1. Install 'Dev Containers' extension"
echo "  2. Click the remote button (bottom-left)"
echo "  3. Select 'Attach to Running Container'"
echo "  4. Choose '$CONTAINER_NAME'"
echo ""
echo "Or connect via shell:"
echo "  docker exec -it $CONTAINER_NAME bash"
echo ""
echo "To stop:"
echo "  docker stop $CONTAINER_NAME"
if $USE_SQUID; then
    echo "  docker stop $PROXY_CONTAINER_NAME  # Squid proxy"
fi
echo ""
echo "To remove:"
echo "  docker rm -f $CONTAINER_NAME"
if $USE_SQUID; then
    echo "  docker rm -f $PROXY_CONTAINER_NAME  # Squid proxy"
    echo "  docker network rm $PROXY_NETWORK_NAME  # Proxy network"
fi
